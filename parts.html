<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Menaxhimi i Pjesëve</title>
<style>
:root{
  --bg:#f6f7f9; --card:#ffffff; --border:#e6eaf0; --text:#0f172a; --muted:#6b7280;
  --accent:#0ea5a4; --btn:#0b7285; --danger:#e03131;
  --shadow:0 6px 18px rgba(16,24,40,.06);
  font-family: Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text)}
.wrap{max-width:1024px;margin:18px auto;padding:18px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
h1{font-size:18px;margin:0}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:14px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input[type="text"], input[type="password"], input[type="email"], input[type="date"]{
  width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff
}
.row{display:flex;gap:10px;align-items:center}
.grow{flex:1}
.btn{background:var(--btn);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.ghost{background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer}
.danger{background:var(--danger)}
.muted{color:var(--muted);font-size:13px}
.search-wrap{position:relative}
.suggestions{position:absolute;left:0;right:0;top:56px;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);max-height:280px;overflow:auto;display:none;z-index:5}
.suggestion{padding:10px;border-bottom:1px solid #f1f3f5;display:flex;align-items:center;justify-content:space-between;cursor:pointer}
.small{font-size:12px;color:var(--muted)}
#selectedArea .big{font-size:16px}
.qty-control{display:flex;align-items:center;gap:8px}
.big-arrow{width:48px;height:48px;border-radius:10px;border:1px solid var(--border);background:#fff;display:flex;align-items:center;justify-content:center;font-size:22px;user-select:none;cursor:pointer}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #f1f3f5;font-size:13px;text-align:left}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:#fff}
@media (max-width:640px){
  .row.wrap1{flex-direction:column;align-items:stretch}
  .big-arrow{width:44px;height:44px}
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Menaxhimi i Pjesëve</h1>
    <div class="muted">Supabase • Hyrje & Regjistrime</div>
  </header>

  <!-- AUTH -->
  <div class="card" id="authView">
    <label>Hyr me email dhe fjalëkalim</label>
    <div class="row wrap1">
      <input id="email" type="email" placeholder="Email" class="grow">
      <input id="password" type="password" placeholder="Fjalëkalimi" class="grow">
      <button class="btn" id="btnLogin">Hyr</button>
    </div>
    <div class="row" style="margin-top:8px;justify-content:space-between">
      <div class="muted">Nëse nuk je i kyçur, asgjë nuk shfaqet.</div>
      <div class="muted">Vetëm <span class="badge">Andi (admin)</span> sheh raportet.</div>
    </div>
  </div>

  <!-- APP -->
  <div class="card" id="appView" style="display:none">
    <div class="row" style="justify-content:space-between;gap:12px">
      <div class="row" style="gap:8px">
        <div class="badge" id="whoBadge">—</div>
        <button class="ghost" id="btnLogout">Dil</button>
      </div>
      <div class="row" id="adminActions" style="gap:8px;display:none">
        <button class="ghost" id="btnReports">Raportet</button>
        <button class="ghost" id="btnHelp">CSV Yükleme Bilgisi</button>
      </div>
    </div>

    <!-- KERKO PJESË -->
    <div style="margin-top:12px">
      <label>Kërko pjesë (shkruaj kodin ose emrin në turqisht)</label>
      <div class="search-wrap">
        <input id="search" type="text" autocomplete="off"
               placeholder="p.sh. A B.50.0030.36 ose 'sürücü'">
        <div id="suggestions" class="suggestions"></div>
      </div>
      <div class="small" style="margin-top:6px">Lista nuk shfaqet. Vetëm kërkimi jep sugjerime (maks. 20).</div>
    </div>

    <!-- SEÇİLEN -->
    <div id="selectedArea" style="display:none;margin-top:12px">
      <div class="card" style="padding:12px">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="small">Kodi: <b id="selCode"></b></div>
            <div class="small">Emri (EN): <b id="selNameEn"></b></div>
            <!-- TR saklı; gösterme -->
          </div>
          <div class="small"><span id="nowLbl"></span></div>
        </div>

        <div style="margin-top:10px">
          <label class="big">Konfirmo: A po e kuptove kështu?</label>
          <div class="row" style="justify-content:space-between">
            <div class="small">Sasia:</div>
            <div class="qty-control">
              <div class="big-arrow" id="decBtn">−</div>
              <input id="qty" type="text" value="1" style="width:80px;text-align:center;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:18px">
              <div class="big-arrow" id="incBtn">+</div>
            </div>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:10px;gap:8px">
            <button class="ghost" id="cancelSel">Anulo</button>
            <button class="btn" id="saveSel">Ruaj</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RAPOR (yalnız admin) -->
    <div id="reportsPanel" class="card" style="display:none;margin-top:12px">
      <label>Raport (vetëm admin – Andi)</label>
      <div class="row">
        <input id="fromDate" type="date">
        <input id="toDate" type="date">
        <input id="whoFilter" type="text" placeholder="Kush? (opsionale: Andi/arber/dart)" style="max-width:220px">
        <button class="btn" id="runReport">Shfaq</button>
        <button class="ghost" id="dlCSV" style="display:none">Shkarko CSV</button>
      </div>
      <div id="repOut" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<!-- Yardım modalı -->
<div id="helpModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); align-items:center; justify-content:center; z-index:50">
  <div class="card" style="max-width:560px; width:92%">
    <h3 style="margin:0 0 6px 0">CSV Yükleme Bilgisi</h3>
    <div class="small">
      Supabase &gt; Table Editor &gt; <b>parts</b> &gt; Import<br>
      Dosya biçimi: <b>CSV (UTF-8)</b><br>
      Sütun başlıkları: <code>code,name_en,name_tr</code><br>
      Örnek satır: <code>A B.50.0030.36,Driver, Sürücü</code><br>
      Yükledikten sonra sayfa otomatik liste dökmez; sadece aradığında öneri çıkar.
    </div>
    <div class="row" style="justify-content:flex-end; margin-top:10px">
      <button class="btn" id="closeHelp">Kapat</button>
    </div>
  </div>
</div>

<script type="module">
/*** Supabase config ***/
const SUPABASE_URL = "https://oqrukzyimkwacdniavya.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xcnVrenlpbWt3YWNkbmlhdnlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODg3MTgsImV4cCI6MjA3NDk2NDcxOH0.Z0gxZL72qWFcI-wJinQT_NEUBDaUk4qP0mP1acqXJbI";
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/*** UI refs ***/
const authView = document.getElementById('authView');
const appView  = document.getElementById('appView');
const emailEl  = document.getElementById('email');
const passEl   = document.getElementById('password');
const btnLogin = document.getElementById('btnLogin');
const btnLogout= document.getElementById('btnLogout');
const whoBadge = document.getElementById('whoBadge');
const adminActions = document.getElementById('adminActions');
const btnHelp = document.getElementById('btnHelp');
const helpModal = document.getElementById('helpModal');
const closeHelp = document.getElementById('closeHelp');

const search   = document.getElementById('search');
const sugg     = document.getElementById('suggestions');
const selectedArea = document.getElementById('selectedArea');
const selCode  = document.getElementById('selCode');
const selNameEn= document.getElementById('selNameEn');
const nowLbl   = document.getElementById('nowLbl');
const decBtn   = document.getElementById('decBtn');
const incBtn   = document.getElementById('incBtn');
const qtyEl    = document.getElementById('qty');
const cancelSel= document.getElementById('cancelSel');
const saveSel  = document.getElementById('saveSel');

const btnReports = document.getElementById('btnReports');
const reportsPanel = document.getElementById('reportsPanel');
const fromDate = document.getElementById('fromDate');
const toDate   = document.getElementById('toDate');
const whoFilter= document.getElementById('whoFilter');
const runReport= document.getElementById('runReport');
const repOut   = document.getElementById('repOut');
const dlCSV    = document.getElementById('dlCSV');

let CURRENT_USER = null;   // {email, role, display_name}
let SELECTED = null;       // {id, code, name_en}

/*** Helpers ***/
const fmtNow = ()=> new Date().toLocaleString();
const esc = s => String(s??'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));

/*** Auth state restore ***/
const { data: { session } } = await supabase.auth.getSession();
if(session){ await onLogin(session); }

btnLogin.onclick = async ()=>{
  const email = emailEl.value.trim();
  const pass  = passEl.value.trim();
  if(!email || !pass){ alert("Ju lutem shkruani email-in dhe fjalëkalimin."); return; }
  btnLogin.disabled = true;
  const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
  btnLogin.disabled = false;
  if(error){ alert("Hyrja dështoi: " + (error.message||error)); return; }
  await onLogin(data.session);
};

btnLogout.onclick = async ()=>{
  await supabase.auth.signOut();
  CURRENT_USER = null;
  appView.style.display='none';
  authView.style.display='';
  emailEl.value = '';
  passEl.value = '';
};

async function onLogin(session){
  // me view yalnız JWT-email ile tek kayıt döndürür
  const { data: me, error } = await supabase.from('me').select('email, display_name, role').single();
  if(error){ alert("Profili nuk u lexua: " + (error.message||error)); return; }
  CURRENT_USER = me;
  whoBadge.textContent = (me.display_name||me.email||'—') + (me.role==='admin'?' • admin':'');
  authView.style.display='none';
  appView.style.display='';
  adminActions.style.display = (me.role==='admin') ? '' : 'none';
  nowLbl.textContent = fmtNow();
  // Tarihler (rapor)
  const t = new Date(); const y = new Date(); y.setMonth(y.getMonth()-1);
  toDate.value   = t.toISOString().slice(0,10);
  fromDate.value = y.toISOString().slice(0,10);
}

/*** Yardım ***/
btnHelp.onclick = ()=> helpModal.style.display='flex';
closeHelp.onclick = ()=> helpModal.style.display='none';
helpModal.addEventListener('click', (e)=>{ if(e.target===helpModal) helpModal.style.display='none'; });

/*** Search on type: server-side LIKE, only suggestions ***/
let typingTimer;
search.addEventListener('input', ()=>{
  clearTimeout(typingTimer);
  const q = search.value.trim();
  if(!q){ sugg.style.display='none'; sugg.innerHTML=''; return; }
  typingTimer = setTimeout(()=> doSearch(q), 180);
});

async function doSearch(q){
  // server sorgusu: code ILIKE veya name_tr ILIKE, limit 20
  const pat = `%${q}%`;
  const { data, error } = await supabase
    .from('parts')
    .select('id,code,name_en')   // TR’yi çekmiyoruz, gizli kalsın
    .or(`code.ilike.${pat},name_tr.ilike.${pat}`)
    .limit(20);
  if(error){ console.error(error); return; }
  renderSuggestions(data||[]);
}

function renderSuggestions(rows){
  sugg.innerHTML='';
  if(!rows.length){ sugg.style.display='none'; return; }
  rows.forEach(r=>{
    const div = document.createElement('div');
    div.className='suggestion';
    div.innerHTML = `<div>
        <div style="font-weight:600">${esc(r.code||'')}</div>
        <div class="small">${esc(r.name_en||'—')}</div>
      </div>
      <div class="small">Zgjidh</div>`;
    div.onclick = ()=> selectPart(r);
    sugg.appendChild(div);
  });
  sugg.style.display='block';
}

/*** Select part ***/
function selectPart(p){
  SELECTED = p;
  selCode.textContent = p.code||'';
  selNameEn.textContent = p.name_en||'';
  qtyEl.value = '1';
  selectedArea.style.display='';
  sugg.style.display='none';
  nowLbl.textContent = fmtNow();
}

/*** Qty controls ***/
incBtn.onclick = ()=> { qtyEl.value = String((+qtyEl.value||0)+1); };
decBtn.onclick = ()=> { let v=(+qtyEl.value||0)-1; if(v<0)v=0; qtyEl.value=String(v); };
qtyEl.addEventListener('input', ()=> qtyEl.value = qtyEl.value.replace(/[^\d]/g,'') || '0');
cancelSel.onclick = ()=> { selectedArea.style.display='none'; SELECTED=null; };

/*** Save log ***/
saveSel.onclick = async ()=>{
  if(!CURRENT_USER){ alert("Së pari hyni."); return; }
  if(!SELECTED){ alert("Zgjidh një pjesë."); return; }
  const qty = +qtyEl.value||0;
  if(!confirm("A po e konfirmoni regjistrimin?")) return;
  const payload = {
    user_label: (CURRENT_USER.display_name || (CURRENT_USER.email||'').split('@')[0] || 'user'),
    part_id: SELECTED.id,
    part_code: SELECTED.code,
    qty: qty,
    created_at: new Date().toISOString()
  };
  const { error } = await supabase.from('parts_logs').insert([payload]);
  if(error){ alert("Gabim gjatë ruajtjes: " + (error.message||error)); return; }
  alert("Regjistrimi u ruajt.");
  selectedArea.style.display='none'; SELECTED=null;
};

/*** Reports (admin only) ***/
btnReports.onclick = ()=>{
  if(!CURRENT_USER || CURRENT_USER.role!=='admin'){ alert("Vetëm admin."); return; }
  reportsPanel.style.display = reportsPanel.style.display==='none' ? '' : 'none';
};

runReport.onclick = async ()=>{
  if(!CURRENT_USER || CURRENT_USER.role!=='admin'){ alert("Vetëm admin."); return; }
  const f = fromDate.value, t = toDate.value;
  if(!f || !t){ alert("Zgjidhni datat."); return; }
  repOut.innerHTML = "Duke marrë të dhënat...";
  const fromISO = new Date(f+'T00:00:00').toISOString();
  const toISO   = new Date(t+'T23:59:59').toISOString();
  // admin RPC
  const { data, error } = await supabase.rpc('get_logs_between_admin', { _from: fromISO, _to: toISO, who: (whoFilter.value||null) });
  if(error){ repOut.innerHTML = "Gabim: " + (error.message||error); return; }
  renderReport(data||[]);
};

function renderReport(rows){
  if(!rows.length){ repOut.innerHTML = '<div class="small">Asnjë e dhënë për periudhën.</div>'; dlCSV.style.display='none'; return; }
  let html = `<table><thead><tr><th>Data</th><th>Përdoruesi</th><th>Kod Pjesë</th><th>Sasia</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    html += `<tr><td>${esc(new Date(r.created_at).toLocaleString())}</td><td>${esc(r.user_label)}</td><td>${esc(r.part_code||'')}</td><td>${r.qty}</td></tr>`;
  });
  html += `</tbody></table>`;
  repOut.innerHTML = html;
  dlCSV.style.display='';
  dlCSV.onclick = ()=> downloadCSV(rows);
}

function downloadCSV(rows){
  const header = ['created_at','user_label','part_code','qty'];
  const csv = [header.join(',')].concat(
    rows.map(r=> [r.created_at, r.user_label, r.part_code||'', r.qty]
      .map(v=> `"${String(v??'').replace(/"/g,'""')}"`).join(','))
  ).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`raport_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/*** Close suggestions on outside click ***/
document.addEventListener('click', (e)=>{
  if(!search.contains(e.target) && !sugg.contains(e.target)){ sugg.style.display='none'; }
});

/*** Enter picks first suggestion ***/
search.addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const first = sugg.querySelector('.suggestion');
    if(first){ first.click(); }
  }
});
</script>
</body>
</html>
