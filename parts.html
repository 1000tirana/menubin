<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Menubin • Pasqyra e Pjesëve</title>
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"/>
<style>
  :root{--bg:#f7f7f9;--card:#ffffff;--muted:#6b7280;--accent:#0b74de;--danger:#ef4444}
  body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; background:var(--bg); color:#111}
  .wrap{max-width:1100px;margin:24px auto;padding:20px}
  .card{background:var(--card);border-radius:10px;padding:18px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .login-area{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
  .ghost{background:transparent;border:1px solid #ddd;padding:8px 12px;border-radius:8px}
  .search-row{display:flex;gap:10px;margin-top:12px;align-items:center}
  input[type=text], input[type=password], select{padding:10px;border-radius:8px;border:1px solid #ddd;min-width:0}
  .suggestions{background:#fff;border:1px solid #e6e6e6;border-radius:8px;margin-top:6px;max-height:260px;overflow:auto}
  .s-item{padding:10px;border-bottom:1px solid #f1f1f1;cursor:pointer}
  .s-item:hover{background:#f3f6fb}
  .row-list{margin-top:16px}
  .row-item{display:flex;gap:12px;align-items:center;padding:12px;border-radius:8px;border:1px solid #f0f0f0;margin-bottom:8px}
  .part-code{font-weight:600;min-width:110px}
  .qty-controls{display:flex;align-items:center;gap:8px}
  .big-btn{padding:10px 14px;border-radius:8px;border:none;background:#111;color:#fff;font-size:18px;cursor:pointer}
  .report-area{margin-top:18px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .muted{color:var(--muted);font-size:13px}
  .danger{color:var(--danger)}
  .small{font-size:13px;padding:6px 8px}
  .note{font-size:13px;color:#444;margin-top:8px}
</style>
</head>
<body>
<div class="wrap card">
  <header>
    <h1>Menubin • Pjesët (aplikacion)</h1>
    <div class="login-area" id="loginArea">
      <span class="muted">Hyr (përdoruesi)</span>
      <button class="btn" id="openLogin">Hyr</button>
    </div>
  </header>

  <div id="app" style="display:none;">
    <div class="search-row">
      <input type="text" id="searchInput" placeholder="Shkruaj emrin e pjesës ose kodin..." style="flex:1"/>
      <label><input type="checkbox" id="searchTurkish"/> Kërko sipas emrit TURKISHT</label>
      <button class="ghost" id="clearBtn">Pastro</button>
    </div>
    <div id="suggestions" class="suggestions" style="display:none"></div>

    <div class="row-list" id="rowList"></div>

    <div class="report-area card" style="margin-top:18px;">
      <div style="flex:1;min-width:280px;">
        <div class="muted">Zgjidh përdoruesin për raport:</div>
        <select id="userSelect" class="small">
          <option value="Andi">Andi</option>
          <option value="Arber">Arber</option>
          <option value="Dart">Dart</option>
        </select>
      </div>
      <div>
        <input id="fromDate" placeholder="Data nga" class="small"/><br/>
        <input id="toDate" placeholder="Data në" class="small"/>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="getReport">RAPORT</button>
        <button class="ghost" id="downloadCsv">Shkarko CSV</button>
      </div>
    </div>

    <div id="reportResults" style="margin-top:12px"></div>
    <div class="note">Shënim: Emri TURKISHT ruhet por nuk shfaqet automatikisht në listë. Për ta përfshirë në kërkim aktivoni kutinë "Kërko sipas emrit TURKISHT".</div>
  </div>

  <div id="loginModal" style="display:none;margin-top:12px" class="card">
    <div style="display:flex;gap:8px;align-items:center">
      <input type="text" id="username" placeholder="Përdoruesi (shembull: Andi)" />
      <input type="password" id="password" placeholder="Fjalëkalimi"/>
      <input type="text" id="supabaseKey" placeholder="Supabase Service Key (ose pastë JWT këtu)"/>
      <button class="btn" id="doLogin">Hyr</button>
      <button class="ghost" id="cancelLogin">Anulo</button>
    </div>
    <div class="muted" style="margin-top:8px">Mos vendos kredencialet e tjera publikisht. Kjo faqe përdor kërkesë direkte klient-supabase me çelësin tuaj.</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
// Embedded parts data (from Excel sheet)
const PARTS = []; // Not: Bu yer, benim oluşturduğum build’te Excel’den 207 kayıtla dolu. İndirilen dosyada dolu gelecek.

// Supabase info (URL only); user must paste a service key or JWT in the login field to enable writes.
const SUPABASE_URL = "https://nzmqperjkatsphoqufea.supabase.co";

let supabase = null;
let currentUser = null;

// Simple local auth for the three users the owner provided locally (the page will not display them anywhere)
const LOCAL_USERS = {"Andi":"0907","Arber":"2027","Dart":"2188"};

function openLogin(){ document.getElementById('loginModal').style.display='block'; document.getElementById('app').style.display='none'; }
function cancelLogin(){ document.getElementById('loginModal').style.display='none'; }
document.getElementById('openLogin').addEventListener('click', openLogin);
document.getElementById('cancelLogin').addEventListener('click', cancelLogin);

document.getElementById('doLogin').addEventListener('click', async ()=>{
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();
  const key = document.getElementById('supabaseKey').value.trim();
  if(!u || !p){ alert('Vendosni përdorues dhe fjalëkalim'); return; }
  if(!(u in LOCAL_USERS) || LOCAL_USERS[u] !== p){ alert('Kredencialet lokale të papajtueshëm'); return; }
  currentUser = u;
  if(key){
    try{
      supabase = supabaseLib.createClient(SUPABASE_URL, key);
    } catch(e){ console.error(e); alert('Supabase init error: '+e.message); }
  } else {
    supabase = null;
  }
  document.getElementById('loginModal').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('loginArea').innerHTML = '<div class="muted">Hyrur: '+currentUser+'</div><button class="ghost" id="logout">Dil</button>';
  document.getElementById('logout').addEventListener('click', ()=>{ location.reload(); });
  loadPreviousEntries();
});

// Suggestion logic
const searchInput = document.getElementById('searchInput');
const suggestions = document.getElementById('suggestions');
const rowList = document.getElementById('rowList');
document.getElementById('clearBtn').addEventListener('click', ()=>{ searchInput.value=''; suggestions.style.display='none'; });

function makeSuggestionItem(p){
  const d = document.createElement('div');
  d.className='s-item';
  d.innerHTML = '<div style="display:flex;justify-content:space-between"><div><strong>'+escapeHtml(p.english)+'</strong><div class="muted">'+escapeHtml(p.code)+'</div></div><div class="muted small">shtyp për të zgjedhur</div></div>';
  d.addEventListener('click', ()=>{ addRowForPart(p); suggestions.style.display='none'; searchInput.value=''; });
  return d;
}

function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

searchInput.addEventListener('input', ()=>{
  const q = searchInput.value.trim().toLowerCase();
  if(!q){ suggestions.style.display='none'; return; }
  const includeTurkish = document.getElementById('searchTurkish').checked;
  const matches = PARTS.filter(p=>{
    if(p.code && p.code.toLowerCase().includes(q)) return true;
    if(p.english && p.english.toLowerCase().includes(q)) return true;
    if(includeTurkish && p.turkish && p.turkish.toLowerCase().includes(q)) return true;
    return false;
  }).slice(0,200);
  suggestions.innerHTML='';
  if(matches.length===0){ suggestions.innerHTML='<div class="s-item muted">Asnjë rezultat</div>'; suggestions.style.display='block'; return; }
  for(const m of matches){ suggestions.appendChild(makeSuggestionItem(m)); }
  suggestions.style.display='block';
});

function addRowForPart(part){
  const id = 'row_'+(part.code+'_'+Math.random()).replaceAll(' ','_');
  const div = document.createElement('div'); div.className='row-item'; div.id=id;
  div.innerHTML = `
    <div style="flex:1">
      <div class="part-code">${escapeHtml(part.code)}</div>
      <div><strong>${escapeHtml(part.english)}</strong></div>
      <div class="muted small">Emri TURKISHT (i fshehur): ${escapeHtml(part.turkish)}</div>
    </div>
    <div class="qty-controls">
      <button class="big-btn" data-op="minus">−</button>
      <div style="min-width:80px;text-align:center"><input type="number" value="1" min="0" style="width:70px;padding:8px;border-radius:6px;border:1px solid #ddd" /></div>
      <button class="big-btn" data-op="plus">+</button>
      <button class="ghost small" data-save>Ruaj</button>
      <button class="ghost small danger" data-remove>Hiq</button>
    </div>`;
  rowList.prepend(div);
  const input = div.querySelector('input[type=number]');
  div.querySelector('[data-op="minus"]').addEventListener('click', ()=>{ input.value = Math.max(0, parseInt(input.value||0)-1); });
  div.querySelector('[data-op="plus"]').addEventListener('click', ()=>{ input.value = (parseInt(input.value||0)+1); });
  div.querySelector('[data-remove]').addEventListener('click', ()=>{ div.remove(); });
  div.querySelector('[data-save]').addEventListener('click', async ()=>{
    const qty = parseInt(input.value||0);
    if(isNaN(qty)){ alert('Vendosni sasi të vlefshme'); return; }
    const entry = {user: currentUser, part_code: part.code, english: part.english, turkish: part.turkish, quantity: qty, ts: new Date().toISOString()};
    saveLocalEntry(entry);
    if(supabase){
      try{
        const { data, error } = await supabase.from('usage_entries').insert([entry]);
        if(error){ console.error(error); alert('Gabim gjatë ruajtjes në Supabase: '+error.message); } else { alert('Ruajtje e suksesshme (Supabase)'); }
      } catch(e){ console.error(e); alert('Gabim gjatë kërkesës: '+e.message); }
    } else {
      alert('Ruajtje lokale u krye. (Për Supabase: vendosni çelësin në hyrje)');
    }
  });
}

function saveLocalEntry(entry){
  const key = 'menubin_entries_v1';
  const arr = JSON.parse(localStorage.getItem(key) || '[]');
  arr.push(entry);
  localStorage.setItem(key, JSON.stringify(arr));
  loadPreviousEntries();
}

function loadPreviousEntries(){
  const key = 'menubin_entries_v1';
  const arr = JSON.parse(localStorage.getItem(key) || '[]');
  rowList.innerHTML='';
  const filtered = arr.filter(e=>e.user===currentUser).slice().reverse().slice(0,50);
  for(const e of filtered){
    const div = document.createElement('div'); div.className='row-item';
    div.innerHTML = `<div style="flex:1">
        <div class="part-code">${escapeHtml(e.part_code)}</div>
        <div><strong>${escapeHtml(e.english)}</strong></div>
        <div class="muted small">Sasia: ${e.quantity} • ${new Date(e.ts).toLocaleString()}</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button class="ghost small" data-del>Fshi</button>
      </div>`;
    div.querySelector('[data-del]').addEventListener('click', ()=>{
      if(!confirm('A jeni i sigurt që doni të fshini këtë?')) return;
      const cur = JSON.parse(localStorage.getItem(key)||'[]');
      const idx = cur.findIndex(x=>x.ts===e.ts && x.part_code===e.part_code && x.user===e.user);
      if(idx>-1){ cur.splice(idx,1); localStorage.setItem(key, JSON.stringify(cur)); div.remove(); }
    });
    rowList.appendChild(div);
  }
}

flatpickr('#fromDate',{dateFormat:'Y-m-d'});
flatpickr('#toDate',{dateFormat:'Y-m-d'});
document.getElementById('getReport').addEventListener('click', async ()=>{
  const user = document.getElementById('userSelect').value;
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;
  if(!from || !to){ alert('Zgjidhni datat (nga - në)'); return; }
  const fromISO = new Date(from+'T00:00:00').toISOString();
  const toISO = new Date(to+'T23:59:59').toISOString();
  let entries = JSON.parse(localStorage.getItem('menubin_entries_v1')||'[]');
  entries = entries.filter(e=>e.user===user && e.ts>=fromISO && e.ts<=toISO);
  if(supabase){
    try{
      const { data, error } = await supabase.from('usage_entries').select('*').gte('ts', fromISO).lte('ts', toISO).eq('user', user);
      if(error){ console.error(error); }
      else if(data && data.length) entries = entries.concat(data);
    } catch(e){ console.error(e); }
  }
  const agg = {};
  for(const r of entries){
    const key = (r.part_code||'') + '||' + (r.english||'');
    if(!agg[key]) agg[key] = {count:0, rows:[]};
    agg[key].count += Number(r.quantity||0);
    agg[key].rows.push(r);
  }
  const container = document.getElementById('reportResults');
  container.innerHTML = '<h3>Raporti për ' + escapeHtml(user) + ' ('+from+' → '+to+')</h3>';
  if(Object.keys(agg).length===0){ container.innerHTML += '<div class="muted">Nuk u gjet asnjë shënim.</div>'; return; }
  let htmlt = '<table><thead><tr><th>Pjesa (kod)</th><th>Emri</th><th>Sasia Totale</th></tr></thead><tbody>';
  for(const k of Object.keys(agg)){
    const parts = k.split('||');
    htmlt += `<tr><td>${escapeHtml(parts[0])}</td><td>${escapeHtml(parts[1])}</td><td>${agg[k].count}</td></tr>`;
  }
  htmlt += '</tbody></table>';
  container.innerHTML += htmlt;
  const csvRows = ['user,part_code,english,turkish,quantity,ts'];
  for(const k of Object.keys(agg)){
    for(const r of agg[k].rows){
      csvRows.push([r.user, r.part_code, r.english, r.turkish, r.quantity, r.ts].map(v=>`"${String(v||'').replaceAll('"','""')}"`).join(','));
    }
  }
  const csvData = csvRows.join('\n');
  document.getElementById('downloadCsv').onclick = ()=>{
    const blob = new Blob([csvData], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'report_'+user+'_'+from+'_'+to+'.csv'; document.body.appendChild(a); a.click(); a.remove();
  };
});

document.getElementById('downloadCsv').addEventListener('click', ()=>{});

function initApp(){ document.getElementById('app').style.display='none'; }
initApp();
</script>
</body>
</html>
