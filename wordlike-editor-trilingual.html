<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple Word Page ‚Äî Online Editor (Fixed Full)</title>
<style>
  :root{
    --bg:#f4f6f8;
    --panel:#ffffff;
    --ink:#111;
    --muted:#6b7280;
    --accent:#2563eb;
    --page-w: 210mm; /* A4 screen width */
    --page-h: 297mm;
    --page-margin: 20mm;
    --ph: "Start typing here...";
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    color:var(--ink);
    background:linear-gradient(180deg,#e9eef5, #f8fafc);
  }
  header{
    position:sticky; top:0; z-index:10;
    backdrop-filter: blur(6px);
    background:rgba(255,255,255,0.85);
    border-bottom:1px solid #e5e7eb;
  }
  .toolbar{
    display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    max-width:1200px; margin:0 auto; padding:10px 12px;
    overflow-x:auto; overscroll-behavior-inline:contain;
  }
  .toolbar .group{
    display:flex; gap:6px; align-items:center; flex-wrap:wrap;
    padding:6px; background:#fff; border:1px solid #e5e7eb; border-radius:10px;
    box-shadow: 0 1px 0 rgba(0,0,0,.02);
  }
  .btn{
    appearance:none; border:1px solid #e5e7eb; background:#fff; color:#111;
    padding:8px 10px; border-radius:8px; cursor:pointer; font-size:13px; white-space:nowrap;
  }
  .btn:hover{border-color:#cbd5e1}
  .btn[aria-pressed="true"]{background:#eef2ff; border-color:#c7d2fe}
  select, input[type="color"], input[type="number"]{
    border:1px solid #e5e7eb; background:#fff; padding:8px 10px; border-radius:8px; font-size:13px; cursor:pointer;
  }
  input[type="number"]{ width:86px; }
  .sep{width:1px; height:28px; background:#e5e7eb; margin:0 6px}
  main{padding:24px 12px 60px; min-height:calc(100% - 56px)}
  .stage{
    display:flex; justify-content:center; align-items:flex-start; gap:24px; flex-wrap:wrap;
    max-width:1200px; margin:0 auto;
  }
  .page-wrap{ width:var(--page-w); max-width:100%; }
  .page{
    background:var(--panel);
    width:var(--page-w); min-height:var(--page-h);
    padding: var(--page-margin);
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 10px 24px rgba(0,0,0,.05), 0 1px 0 rgba(255,255,255,.7) inset;
    overflow: visible;
  }
  #editor[contenteditable="true"]{outline:none}
  #editor:empty:before{
    content: var(--ph, "Start typing here...");
    color:#9ca3af;
  }
  #editor img{max-width:100%; height:auto}
  blockquote{border-left:4px solid #e5e7eb; margin:8px 0 8px 0; padding:6px 10px; color:#475569; background:#f8fafc}
  .sidebar{
    flex:1 1 260px; max-width:320px;
    background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:14px;
    box-shadow: 0 6px 18px rgba(0,0,0,.04);
  }
  .sidebar h3{margin:4px 0 10px; font-size:14px; color:#374151}
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:8px 0}
  .row label{font-size:12px; color:#6b7280}
  .muted{color:var(--muted); font-size:12px}
  .tag{font-size:11px; padding:4px 8px; border-radius:999px; background:#f1f5f9; color:#334155}
  .flex{display:flex; gap:8px; align-items:center}
  .hidden{display:none !important}

  /* Lang switch */
  .spacer{flex:1 1 auto}
  .lang-switch.group{margin-left:auto}
  .flag.btn{display:flex; align-items:center; gap:6px; font-weight:600}
  .flag .emoji{font-size:16px; line-height:1}

  /* Mobile-friendly page preview */
  @media (max-width: 900px){
    .page{ width:100%; min-height:auto; padding:16px; border-radius:8px; }
    .page-wrap{ width:100%; }
    main{ padding:12px 8px 40px; }
    .toolbar{ gap:6px; padding:8px; }
    .toolbar .group{ gap:4px; padding:4px; }
    .btn, select, input[type="color"], input[type="number"]{ padding:7px 8px; font-size:12px; }
  }

  /* Print */
  @media print {
    header, .sidebar, .hint, .no-print { display:none !important; }
    body{ background:white; }
    .page{ box-shadow:none; border:none; border-radius:0; }
    /* dynamic @page rules injected via #print-style */
  }

  ::selection{ background:#c7d2fe; }
</style>
<style id="print-style"></style>
</head>
<body>
  <header class="no-print">
    <div class="toolbar">
      <div class="group">
        <button class="btn" id="btn-new" title="New" data-i18n="btn_new">New</button>
        <label class="btn" for="file-open" title="Open">
          <span data-i18n="btn_open">Open</span>
          <input id="file-open" type="file" accept=".txt,.html,.htm,.md,.rtf,image/*" class="hidden" />
        </label>
        <button class="btn" id="btn-save" title="Download (HTML)" data-i18n="btn_download">Download</button>
        <button class="btn" id="btn-print" title="Print" data-i18n="btn_print">Print</button>
      </div>

      <div class="group">
        <select id="paraStyle" title="Paragraph style">
          <option value="p" data-i18n="style_normal">Normal</option>
          <option value="h1" data-i18n="style_h1">Title (H1)</option>
          <option value="h2" data-i18n="style_h2">Heading 2</option>
          <option value="h3" data-i18n="style_h3">Heading 3</option>
          <option value="blockquote" data-i18n="style_quote">Quote</option>
        </select>

        <div class="sep"></div>

        <label class="flex tag" data-i18n="label_size">Size
          <select id="fontsize">
            <option value="">‚Äî</option>
            <option value="12px">12</option>
            <option value="14px">14</option>
            <option value="16px">16</option>
            <option value="18px">18</option>
            <option value="20px">20</option>
            <option value="22px">22</option>
            <option value="24px">24</option>
            <option value="28px">28</option>
            <option value="32px">32</option>
          </select>
        </label>
        <input type="number" id="fontsizeNumber" min="8" max="200" step="1" placeholder="px" title="Manual size (px)" />
        <button class="btn" id="btn-size-dec" title="Decrease size" data-i18n="btn_size_dec">A‚àí</button>
        <button class="btn" id="btn-size-inc" title="Increase size" data-i18n="btn_size_inc">A+</button>

        <div class="sep"></div>

        <button class="btn" data-cmd="bold" title="Bold"><b>B</b></button>
        <button class="btn" data-cmd="italic" title="Italic"><i>I</i></button>
        <button class="btn" data-cmd="underline" title="Underline"><u>U</u></button>
        <button class="btn" data-cmd="strikeThrough" title="Strikethrough"><s>S</s></button>

        <div class="sep"></div>
        <label class="flex tag" data-i18n="label_color">Color <input type="color" id="foreColor" value="#111111" /></label>
        <label class="flex tag" data-i18n="label_highlight">Highlight <input type="color" id="hiliteColor" value="#fffd54" /></label>
      </div>

      <div class="group">
        <button class="btn" data-cmd="justifyLeft" title="Left" data-i18n="align_left">Left</button>
        <button class="btn" data-cmd="justifyCenter" title="Center" data-i18n="align_center">Center</button>
        <button class="btn" data-cmd="justifyRight" title="Right" data-i18n="align_right">Right</button>
        <button class="btn" data-cmd="justifyFull" title="Justify" data-i18n="align_justify">Justify</button>
        <div class="sep"></div>
        <button class="btn" data-cmd="insertUnorderedList" title="Bullets" data-i18n="list_bullet">‚Ä¢ List</button>
        <button class="btn" data-cmd="insertOrderedList" title="Numbered" data-i18n="list_numbered">1. List</button>
        <button class="btn" data-cmd="outdent" title="Outdent" data-i18n="outdent">‚á§</button>
        <button class="btn" data-cmd="indent" title="Indent" data-i18n="indent">‚á•</button>
      </div>

      <div class="group">
        <label class="btn" for="img-open" title="Insert Image"><span data-i18n="btn_image">Image</span>
          <input id="img-open" type="file" accept="image/*" class="hidden" />
        </label>
        <button class="btn" id="btn-clear" title="Clear Formatting" data-i18n="btn_clear">Clear</button>
        <button class="btn" id="btn-full" title="Fullscreen" data-i18n="btn_full">Fullscreen</button>
        <label class="flex tag"><input type="checkbox" id="paste-clean" /> <span data-i18n="paste_plain">Paste as plain text</span></label>
      </div>

      <div class="spacer"></div>

      <div class="group lang-switch" role="group" aria-label="Language">
        <button class="btn flag" id="lang-en" data-lang="en" aria-pressed="true" title="English">
          <span class="emoji">üá¨üáß</span> EN
        </button>
        <button class="btn flag" id="lang-sq" data-lang="sq" aria-pressed="false" title="Shqip">
          <span class="emoji">üá¶üá±</span> SQ
        </button>
        <button class="btn flag" id="lang-tr" data-lang="tr" aria-pressed="false" title="T√ºrk√ße">
          <span class="emoji">üáπüá∑</span> TR
        </button>
      </div>

      <div class="muted">Autosaves ¬∑ <span id="status" class="tag">Ready</span></div>
    </div>
  </header>

  <main>
    <div class="stage">
      <div class="page-wrap">
        <div id="page" class="page">
          <div id="editor" contenteditable="true" spellcheck="true">
            <h1 style="margin-top:0" data-i18n-doc="untitled">Untitled Document</h1>
            <p data-i18n-doc="intro">This editor provides a simple ‚ÄúWord-like‚Äù experience. Use Print to get an A4 output.</p>
          </div>
        </div>
        <p class="hint muted no-print" id="hint" data-i18n="hint">Tip: use <kbd>Ctrl/Cmd + P</kbd> to print, and <kbd>Ctrl/Cmd + B/I/U</kbd> for formatting.</p>
      </div>

      <aside class="sidebar no-print">
        <h3 data-i18n="page_settings">Page Settings</h3>
        <div class="row">
          <label data-i18n="label_pagesize">Size</label>
          <select id="pagesize">
            <option value="A4" selected>A4 (210√ó297mm)</option>
            <option value="Letter">Letter (8.5√ó11")</option>
            <option value="A5">A5 (148√ó210mm)</option>
          </select>
        </div>
        <div class="row">
          <label data-i18n="label_orientation">Orientation</label>
          <select id="orientation">
            <option value="portrait" selected data-i18n="opt_portrait">Portrait</option>
            <option value="landscape" data-i18n="opt_landscape">Landscape</option>
          </select>
        </div>
        <div class="row">
          <label data-i18n="label_margins">Margins</label>
          <select id="margins">
            <option value="15mm" data-i18n="opt_narrow">Narrow (15mm)</option>
            <option value="20mm" selected data-i18n="opt_normal">Normal (20mm)</option>
            <option value="25mm" data-i18n="opt_wide">Wide (25mm)</option>
          </select>
        </div>
        <div class="row">
          <label data-i18n="label_linespacing">Line Spacing</label>
          <select id="linespacing">
            <option value="1">1.0</option>
            <option value="1.15" selected>1.15</option>
            <option value="1.5">1.5</option>
            <option value="2">2.0</option>
          </select>
        </div>
        <div class="row">
          <button class="btn" id="btn-reset" data-i18n="btn_reset">Reset Page</button>
        </div>
        <hr/>
        <h3 data-i18n="file_heading">File</h3>
        <p class="muted" data-i18n="file_support">Supports .txt/.html import. You can also drag & drop images.</p>
      </aside>
    </div>
  </main>

<script>
(function(){
  const editor = document.getElementById('editor');
  const status = document.getElementById('status');

  /* ---- i18n dictionary (EN/SQ/TR) ---- */
  const I18N = {
    en: {
      untitled: "Untitled Document",
      intro: "This editor provides a simple ‚ÄúWord-like‚Äù experience. Use Print to get an A4 output.",
      hint: "Tip: use <kbd>Ctrl/Cmd + P</kbd> to print, and <kbd>Ctrl/Cmd + B/I/U</kbd> for formatting.",
      btn_new: "New",
      btn_open: "Open",
      btn_download: "Download",
      btn_print: "Print",
      style_normal: "Normal",
      style_h1: "Title (H1)",
      style_h2: "Heading 2",
      style_h3: "Heading 3",
      style_quote: "Quote",
      label_size: "Size",
      btn_size_dec: "A‚àí",
      btn_size_inc: "A+",
      label_color: "Color",
      label_highlight: "Highlight",
      align_left: "Left",
      align_center: "Center",
      align_right: "Right",
      align_justify: "Justify",
      list_bullet: "‚Ä¢ List",
      list_numbered: "1. List",
      outdent: "‚á§",
      indent: "‚á•",
      btn_image: "Image",
      btn_clear: "Clear",
      btn_full: "Fullscreen",
      paste_plain: "Paste as plain text",
      page_settings: "Page Settings",
      label_pagesize: "Size",
      label_orientation: "Orientation",
      label_margins: "Margins",
      label_linespacing: "Line Spacing",
      btn_reset: "Reset Page",
      file_heading: "File",
      file_support: "Supports .txt/.html import. You can also drag & drop images.",
      opt_portrait: "Portrait",
      opt_landscape: "Landscape",
      opt_narrow: "Narrow (15mm)",
      opt_normal: "Normal (20mm)",
      opt_wide: "Wide (25mm)"
    },
    sq: {
      untitled: "Dokument pa titull",
      intro: "Ky redaktor ofron nj√´ p√´rvoj√´ t√´ thjesht√´ si Word. P√´rdorni Print p√´r dalje A4.",
      hint: "K√´shill√´: p√´rdorni <kbd>Ctrl/Cmd + P</kbd> p√´r t√´ printuar dhe <kbd>Ctrl/Cmd + B/I/U</kbd> p√´r formatim.",
      btn_new: "I ri",
      btn_open: "Hap",
      btn_download: "Shkarko",
      btn_print: "Printo",
      style_normal: "Normale",
      style_h1: "Titull (H1)",
      style_h2: "Titull 2",
      style_h3: "Titull 3",
      style_quote: "Citim",
      label_size: "Madh√´sia",
      btn_size_dec: "A‚àí",
      btn_size_inc: "A+",
      label_color: "Ngjyra",
      label_highlight: "Theksim",
      align_left: "Majtas",
      align_center: "Qend√´r",
      align_right: "Djathtas",
      align_justify: "Justifiko",
      list_bullet: "‚Ä¢ List√´",
      list_numbered: "1. List√´",
      outdent: "‚á§",
      indent: "‚á•",
      btn_image: "Imazh",
      btn_clear: "Pastro",
      btn_full: "Ekran i plot√´",
      paste_plain: "Ngjit si tekst i thjesht√´",
      page_settings: "Cil√´simet e faqes",
      label_pagesize: "Madh√´sia",
      label_orientation: "Orientimi",
      label_margins: "An√´t",
      label_linespacing: "Hap√´sira nd√´r rreshta",
      btn_reset: "Rivendos faqen",
      file_heading: "Skedar",
      file_support: "Mb√´shtet import .txt/.html. Mund t√´ t√´rhiqni & l√´shoni imazhe.",
      opt_portrait: "Portret",
      opt_landscape: "Peizazh",
      opt_narrow: "I ngusht√´ (15mm)",
      opt_normal: "Normal (20mm)",
      opt_wide: "I gjer√´ (25mm)"
    },
    tr: {
      untitled: "Ba≈ülƒ±ksƒ±z Belge",
      intro: "Bu d√ºzenleyici basit bir Word benzeri deneyim sunar. A4 √ßƒ±ktƒ±sƒ± i√ßin Yazdƒ±r'ƒ± kullanƒ±n.",
      hint: "ƒ∞pucu: Yazdƒ±r i√ßin <kbd>Ctrl/Cmd + P</kbd>, bi√ßimlendirme i√ßin <kbd>Ctrl/Cmd + B/I/U</kbd> kullanƒ±n.",
      btn_new: "Yeni",
      btn_open: "A√ß",
      btn_download: "ƒ∞ndir",
      btn_print: "Yazdƒ±r",
      style_normal: "Normal",
      style_h1: "Ba≈ülƒ±k (H1)",
      style_h2: "Alt Ba≈ülƒ±k",
      style_h3: "Ba≈ülƒ±k 3",
      style_quote: "Alƒ±ntƒ±",
      label_size: "Boyut",
      btn_size_dec: "A‚àí",
      btn_size_inc: "A+",
      label_color: "Renk",
      label_highlight: "Vurgula",
      align_left: "Sola",
      align_center: "Ortala",
      align_right: "Saƒüa",
      align_justify: "ƒ∞ki yana yasla",
      list_bullet: "‚Ä¢ Liste",
      list_numbered: "1. Liste",
      outdent: "‚á§",
      indent: "‚á•",
      btn_image: "G√∂rsel",
      btn_clear: "Temizle",
      btn_full: "Tam ekran",
      paste_plain: "D√ºz metin olarak yapƒ±≈ütƒ±r",
      page_settings: "Sayfa Ayarlarƒ±",
      label_pagesize: "Boyut",
      label_orientation: "Y√∂n",
      label_margins: "Kenar Bo≈üluklarƒ±",
      label_linespacing: "Satƒ±r Aralƒ±ƒüƒ±",
      btn_reset: "Sayfayƒ± Sƒ±fƒ±rla",
      file_heading: "Dosya",
      file_support: ".txt/.html i√ße aktarƒ±mƒ± desteklenir. G√∂rselleri s√ºr√ºkleyip bƒ±rakabilirsiniz.",
      opt_portrait: "Dikey",
      opt_landscape: "Yatay",
      opt_narrow: "Dar (15mm)",
      opt_normal: "Normal (20mm)",
      opt_wide: "Geni≈ü (25mm)"
    }
  };

  /* ---- Language (persist + apply i18n) ---- */
  const LANG_KEY = 'wordlike-lang';
  let currentLang = localStorage.getItem(LANG_KEY) || 'en';
  function setLang(lang){
    currentLang = (lang==='sq' || lang==='tr' || lang==='en') ? lang : 'en';
    localStorage.setItem(LANG_KEY, currentLang);
    document.getElementById('lang-en').setAttribute('aria-pressed', String(currentLang==='en'));
    document.getElementById('lang-sq').setAttribute('aria-pressed', String(currentLang==='sq'));
    document.getElementById('lang-tr').setAttribute('aria-pressed', String(currentLang==='tr'));
    applyI18n();
  }
  function applyI18n(){
    const dict = I18N[currentLang] || I18N.en;
    // UI labels
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      if(dict[key]) el.innerHTML = dict[key];
    });
    // Document texts
    document.querySelectorAll('[data-i18n-doc]').forEach(el=>{
      const key = el.getAttribute('data-i18n-doc');
      if(dict[key]) el.textContent = dict[key];
    });
    // Placeholder string
    document.documentElement.style.setProperty('--ph', JSON.stringify(currentLang==='tr' ? "Buraya yazƒ±n..." : currentLang==='sq' ? "Shkruani k√´tu..." : "Start typing here..."));
  }
  setLang(currentLang);
  document.getElementById('lang-en').addEventListener('click', ()=> setLang('en'));
  document.getElementById('lang-sq').addEventListener('click', ()=> setLang('sq'));
  document.getElementById('lang-tr').addEventListener('click', ()=> setLang('tr'));

  /* ---- execCommand helpers for simple actions ---- */
  function cmd(name, value=null){
    document.execCommand('styleWithCSS', false, true);
    document.execCommand(name, false, value);
    editor.focus();
    autosave();
  }
  document.querySelectorAll('[data-cmd]').forEach(btn=>{
    btn.addEventListener('click', ()=> cmd(btn.dataset.cmd));
  });

  /* ---- Paragraph style via formatBlock ---- */
  const paraStyle = document.getElementById('paraStyle');
  paraStyle.addEventListener('change', e=>{
    const val = e.target.value;
    if(val==='blockquote'){
      // Wrap selection in blockquote
      wrapSelectionInBlock('blockquote');
    }else{
      document.execCommand('formatBlock', false, val);
    }
    autosave();
  });

  function wrapSelectionInBlock(tag){
    const sel = window.getSelection();
    if(!sel || sel.rangeCount===0) return;
    const range = sel.getRangeAt(0);
    const content = range.extractContents();
    const el = document.createElement(tag);
    el.appendChild(content);
    range.insertNode(el);
    // place caret at end
    range.setStartAfter(el);
    range.setEndAfter(el);
    sel.removeAllRanges();
    sel.addRange(range);
  }

  /* ---- Robust font size control (clean, supports 8‚Äì200px + manual input) ---- */
  const sizeSelect = document.getElementById('fontsize');
  const sizeNumber = document.getElementById('fontsizeNumber');
  const stepBtns = { dec: document.getElementById('btn-size-dec'), inc: document.getElementById('btn-size-inc') };
  const MIN_PX = 8, MAX_PX = 200;

  sizeSelect.addEventListener('change', e=>{
    const size = e.target.value;
    if(!size) return;
    applyFontSize(size);
    sizeNumber.value = parseInt(size,10);
  });

  stepBtns.inc.addEventListener('click', ()=> stepFontSize(+2));
  stepBtns.dec.addEventListener('click', ()=> stepFontSize(-2));

  sizeNumber.addEventListener('change', ()=>{
    let v = parseInt(sizeNumber.value,10);
    if(isNaN(v)) return;
    v = Math.max(MIN_PX, Math.min(MAX_PX, v));
    sizeNumber.value = v;
    applyFontSize(v + 'px');
    sizeSelect.value = ''; // manual overrides dropdown
  });
  sizeNumber.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      let v = parseInt(sizeNumber.value,10);
      if(isNaN(v)) return;
      v = Math.max(MIN_PX, Math.min(MAX_PX, v));
      sizeNumber.value = v;
      applyFontSize(v + 'px');
      sizeSelect.value = '';
    }
  });

  function stepFontSize(delta){
    const sel = getSelectionRange(); if(!sel) return;
    // Detect current size from first block node; fallback 14
    const blocks = getSelectedBlocks(sel);
    const cur = getComputedStyle(blocks[0] || editor).fontSize || '14px';
    const num = parseInt(cur,10);
    const nextPx = Math.max(MIN_PX, Math.min(MAX_PX, num + delta));
    const next = nextPx + 'px';
    applyFontSize(next);
    // Update inputs
    sizeSelect.value = '';
    sizeNumber.value = nextPx;
  }

  function applyFontSize(sizePx){
    const sel = getSelectionRange(); if(!sel) return;
    const frag = sel.cloneContents();
    sanitizeFontSize(frag);
    const span = document.createElement('span');
    span.style.fontSize = sizePx;
    span.appendChild(frag);
    // Replace selection
    sel.deleteContents();
    sel.insertNode(span);
    // Move caret after selection
    sel.setStartAfter(span);
    sel.setEndAfter(span);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(sel);
    autosave();
  }

  function sanitizeFontSize(root){
    const tree = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, null);
    const toUnwrap = [];
    while(tree.nextNode()){
      const el = tree.currentNode;
      if(el.nodeName === 'FONT'){
        toUnwrap.push(el);
      }
      if(el.style && el.style.fontSize){
        el.style.fontSize = null;
        if(!el.getAttribute('style')) el.removeAttribute('style');
      }
    }
    toUnwrap.forEach(node=>{
      const parent = node.parentNode;
      while(node.firstChild) parent.insertBefore(node.firstChild, node);
      parent.removeChild(node);
    });
  }

  function getSelectionRange(){
    const sel = window.getSelection();
    if(!sel || sel.rangeCount===0) return null;
    return sel.getRangeAt(0);
  }

  function getSelectedBlocks(range){
    const blocks = new Set();
    const walker = document.createTreeWalker(editor, NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT, {
      acceptNode(node){
        if(node===editor) return NodeFilter.FILTER_SKIP;
        const r = document.createRange();
        try{ r.selectNode(node); } catch(e){ r.selectNodeContents(node); }
        const intersects = range.compareBoundaryPoints(Range.END_TO_START, r) < 0 &&
                           range.compareBoundaryPoints(Range.START_TO_END, r) > 0;
        if(!intersects) return NodeFilter.FILTER_SKIP;
        return NodeFilter.FILTER_ACCEPT;
      }
    });
    while(walker.nextNode()){
      const n = walker.currentNode.nodeType===1 ? walker.currentNode : walker.currentNode.parentElement;
      const blk = findBlockAncestor(n);
      if(blk) blocks.add(blk);
    }
    return Array.from(blocks);
  }

  function findBlockAncestor(el){
    while(el && el!==editor){
      const disp = getComputedStyle(el).display;
      if(disp==='block' || disp==='list-item' || /^h[1-6]$/i.test(el.tagName) || el.tagName==='P' || el.tagName==='LI' || el.tagName==='BLOCKQUOTE'){
        return el;
      }
      el = el.parentElement;
    }
    return null;
  }

  /* ---- Colors & misc ---- */
  document.getElementById('foreColor').addEventListener('change', e=> cmd('foreColor', e.target.value));
  document.getElementById('hiliteColor').addEventListener('change', e=>{
    if(!document.queryCommandSupported('hiliteColor')){ cmd('backColor', e.target.value); }
    else{ cmd('hiliteColor', e.target.value); }
  });

  document.getElementById('btn-clear').addEventListener('click', ()=>{
    cmd('removeFormat');
    normalizeInline(editor);
  });

  document.getElementById('btn-full').addEventListener('click', ()=>{
    if(!document.fullscreenElement){
      document.documentElement.requestFullscreen().catch(()=>{});
    }else{
      document.exitFullscreen();
    }
  });

  document.getElementById('btn-new').addEventListener('click', ()=>{
    if(editor.textContent.trim().length && !confirm('Create a new blank page? Current content may be lost.')) return;
    editor.innerHTML = '<h1 style="margin-top:0" data-i18n-doc="untitled">Untitled Document</h1><p data-i18n-doc="intro">This editor provides a simple ‚ÄúWord-like‚Äù experience. Use Print to get an A4 output.</p>';
    autosave(true);
    applyI18n();
  });

  document.getElementById('btn-save').addEventListener('click', ()=>{
    const content = `<!doctype html>
<html lang="${currentLang}"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Document</title>
<style>@page{size:auto;margin:20mm}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial;font-size:14px;line-height:1.5;color:#111;margin:0;padding:20mm;background:#fff;} .doc{max-width:800px;margin:0 auto;} img{max-width:100%;height:auto} blockquote{border-left:4px solid #ddd; padding:6px 10px; color:#555; background:#fafafa}</style></head>
<body><div class="doc">${editor.innerHTML}</div></body></html>`;
    const blob = new Blob([content], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = (document.title || 'Document') + '.html';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  document.getElementById('btn-print').addEventListener('click', ()=> window.print());

  // Open (txt/html/img)
  document.getElementById('file-open').addEventListener('change', async e=>{
    const file = e.target.files[0]; if(!file) return;
    if(file.type && file.type.startsWith('image/')){
      insertImageFile(file);
      e.target.value='';
      return;
    }
    const text = await file.text();
    if(file.name.match(/\.(html?|htm)$/i)){
      editor.innerHTML = text;
    }else if(file.name.match(/\.rtf$/i)){
      editor.innerHTML = '<pre style="white-space:pre-wrap; font-family:ui-monospace, monospace">'+escapeHtml(text)+'</pre>';
    }else{
      editor.innerHTML = textToHtml(text);
    }
    autosave(true);
    e.target.value='';
  });

  document.getElementById('img-open').addEventListener('change', async e=>{
    const file = e.target.files[0]; if(!file) return;
    insertImageFile(file);
    e.target.value='';
  });

  function insertImageFile(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      const img = document.createElement('img');
      img.src = reader.result;
      img.alt = file.name;
      img.style.maxWidth = '100%';
      insertNodeAtCaret(img);
      autosave();
    };
    reader.readAsDataURL(file);
  }

  /* ---- Editor behaviors ---- */
  editor.addEventListener('input', autosave);
  editor.addEventListener('keydown', e=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){
      e.preventDefault();
      document.getElementById('btn-save').click();
    }
    if((e.ctrlKey||e.metaKey) && e.key === 'Enter'){
      e.preventDefault();
      const hr = document.createElement('hr');
      hr.style.pageBreakAfter='always';
      hr.style.border='0'; hr.style.height='1px'; hr.style.background='#e5e7eb';
      insertNodeAtCaret(hr);
      insertNodeAtCaret(document.createElement('p'));
      autosave();
    }
  });

  // Paste as plain text option (prevents messy HTML from web/Word)
  document.getElementById('paste-clean').addEventListener('change', e=>{
    const clean = e.target.checked;
    if(clean){
      editor.addEventListener('paste', handlePlainPaste);
    }else{
      editor.removeEventListener('paste', handlePlainPaste);
    }
  });
  function handlePlainPaste(ev){
    ev.preventDefault();
    const text = (ev.clipboardData || window.clipboardData).getData('text');
    document.execCommand('insertText', false, text);
  }

  editor.addEventListener('dragover', e=>{ e.preventDefault(); });
  editor.addEventListener('drop', e=>{
    e.preventDefault();
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    if(file && file.type.startsWith('image/')) insertImageFile(file);
  });

  /* ---- Page settings ---- */
  const root = document.documentElement;
  const printStyleTag = document.getElementById('print-style');
  const pagesize = document.getElementById('pagesize');
  const orientation = document.getElementById('orientation');
  const margins = document.getElementById('margins');
  const linespacing = document.getElementById('linespacing');

  function updatePrintStyle(size, orient, margin){
    const sizeMap = {
      A4: '210mm 297mm',
      Letter: '8.5in 11in',
      A5: '148mm 210mm'
    };
    let w_h = sizeMap[size] || sizeMap['A4'];
    // swap when landscape
    if(orient==='landscape'){
      const parts = w_h.split(' ');
      w_h = parts[1] + ' ' + parts[0];
    }
    printStyleTag.textContent = `@media print { @page{ size: ${w_h}; margin: ${margin}; } }`;
  }

  function applyPage(){
    const size = pagesize.value;
    const orient = orientation.value;
    const margin = margins.value;
    const lh = linespacing.value;

    let w = '210mm', h = '297mm';
    if(size==='Letter'){ w = '216mm'; h = '279mm'; }
    if(size==='A5'){ w = '148mm'; h = '210mm'; }
    if(orient==='landscape'){ const tmp=w; w=h; h=tmp; }
    root.style.setProperty('--page-w', w);
    root.style.setProperty('--page-h', h);
    root.style.setProperty('--page-margin', margin);
    editor.style.lineHeight = lh;

    updatePrintStyle(size, orient, margin);
  }
  [pagesize, orientation, margins, linespacing].forEach(el=> el.addEventListener('change', applyPage));
  applyPage();

  document.getElementById('btn-reset').addEventListener('click', ()=>{
    pagesize.value='A4'; orientation.value='portrait'; margins.value='20mm'; linespacing.value='1.15';
    applyPage();
  });

  /* ---- Local autosave ---- */
  const KEY = 'wordlike-doc-v1';
  let saveTimer;
  function autosave(immediate){
    clearTimeout(saveTimer);
    const save = ()=>{
      try{
        const data = {
          html: editor.innerHTML,
          meta: { time: Date.now(), size: editor.innerText.length }
        };
        localStorage.setItem(KEY, JSON.stringify(data));
        setStatus('Saved');
      }catch(e){ setStatus('Save failed'); }
    };
    if(immediate) save(); else saveTimer = setTimeout(save, 500);
  }

  (function restoreIfAny(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return;
      const data = JSON.parse(raw);
      if(confirm('Restore the last autosaved content?')){
        editor.innerHTML = data.html || editor.innerHTML;
      }
    }catch(e){}
  })();

  function setStatus(msg){
    status.textContent = msg;
    status.style.transition='none';
    status.style.background='#e0f2fe';
    setTimeout(()=>{
      status.style.transition='background 800ms ease';
      status.style.background='';
    }, 50);
  }

  /* ---- Utilities ---- */
  function textToHtml(text){
    const esc = escapeHtml(text);
    return esc.split(/\n{2,}/).map(p=> '<p>'+p.replace(/\n/g,'<br>')+'</p>').join('');
  }
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }
  function insertNodeAtCaret(node){
    const sel = window.getSelection();
    if(!sel || sel.rangeCount===0){ editor.appendChild(node); return; }
    const range = sel.getRangeAt(0);
    range.deleteContents();
    range.insertNode(node);
    range.setStartAfter(node);
    range.setEndAfter(node);
    sel.removeAllRanges();
    sel.addRange(range);
  }
  function normalizeInline(rootEl){
    const walker = document.createTreeWalker(rootEl, NodeFilter.SHOW_ELEMENT, null);
    while(walker.nextNode()){
      const el = walker.currentNode;
      if(el.nodeName==='SPAN' && !el.getAttribute('style')){
        el.replaceWith(...el.childNodes);
      }
    }
  }

  // Keep document title in sync with first H1
  const titleObserver = new MutationObserver(()=>{
    const h1 = editor.querySelector('h1');
    if(h1){
      document.title = (h1.textContent || 'Document').trim() || 'Document';
    }
  });
  titleObserver.observe(editor, {childList:true, subtree:true, characterData:true});

})();</script>
</body>
</html>
