<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple Word Page ‚Äî Online Editor</title>
<style>
  :root{
    --bg:#f4f6f8;
    --panel:#ffffff;
    --ink:#111;
    --muted:#6b7280;
    --accent:#2563eb;
    --page-w: 210mm; /* A4 screen width (for on-screen preview) */
    --page-h: 297mm;
    --page-margin: 20mm;
    --ph: "Start typing here...";
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    color:var(--ink);
    background:linear-gradient(180deg,#e9eef5, #f8fafc);
  }
  header{
    position:sticky; top:0; z-index:10;
    backdrop-filter: blur(6px);
    background:rgba(255,255,255,0.85);
    border-bottom:1px solid #e5e7eb;
  }
  .toolbar{
    display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    max-width:1200px; margin:0 auto; padding:10px 12px;
    overflow-x:auto; overscroll-behavior-inline:contain;
  }
  .toolbar .group{
    display:flex; gap:6px; align-items:center; flex-wrap:wrap;
    padding:6px; background:#fff; border:1px solid #e5e7eb; border-radius:10px;
    box-shadow: 0 1px 0 rgba(0,0,0,.02);
  }
  .btn{
    appearance:none; border:1px solid #e5e7eb; background:#fff; color:#111;
    padding:8px 10px; border-radius:8px; cursor:pointer; font-size:13px; white-space:nowrap;
  }
  .btn:hover{border-color:#cbd5e1}
  .btn[aria-pressed="true"]{background:#eef2ff; border-color:#c7d2fe}
  select, input[type="color"]{
    border:1px solid #e5e7eb; background:#fff; padding:8px 10px; border-radius:8px; font-size:13px; cursor:pointer;
  }
  .sep{width:1px; height:28px; background:#e5e7eb; margin:0 6px}
  main{padding:24px 12px 60px; min-height:calc(100% - 56px)}
  .stage{
    display:flex; justify-content:center; align-items:flex-start; gap:24px; flex-wrap:wrap;
    max-width:1200px; margin:0 auto;
  }
  .page-wrap{ width:var(--page-w); max-width:100%; }
  .page{
    background:var(--panel);
    width:var(--page-w); min-height:var(--page-h);
    padding: var(--page-margin);
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 10px 24px rgba(0,0,0,.05), 0 1px 0 rgba(255,255,255,.7) inset;
    overflow: visible;
  }
  #editor[contenteditable="true"]{outline:none}
  #editor:empty:before{
    content: var(--ph, "Start typing here...");
    color:#9ca3af;
  }
  .sidebar{
    flex:1 1 260px; max-width:320px;
    background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:14px;
    box-shadow: 0 6px 18px rgba(0,0,0,.04);
  }
  .sidebar h3{margin:4px 0 10px; font-size:14px; color:#374151}
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:8px 0}
  .row label{font-size:12px; color:#6b7280}
  .muted{color:var(--muted); font-size:12px}
  .tag{font-size:11px; padding:4px 8px; border-radius:999px; background:#f1f5f9; color:#334155}
  .flex{display:flex; gap:8px; align-items:center}
  .hidden{display:none !important}

  /* Lang switch */
  .spacer{flex:1 1 auto}
  .lang-switch.group{margin-left:auto}
  .flag.btn{display:flex; align-items:center; gap:6px; font-weight:600}
  .flag .emoji{font-size:16px; line-height:1}

  /* Mobile-friendly page preview */
  @media (max-width: 900px){
    .page{ width:100%; min-height:auto; padding:16px; border-radius:8px; }
    .page-wrap{ width:100%; }
    main{ padding:12px 8px 40px; }
    .toolbar{ gap:6px; padding:8px; }
    .toolbar .group{ gap:4px; padding:4px; }
    .btn, select, input[type="color"]{ padding:7px 8px; font-size:12px; }
  }

  /* Print */
  @media print {
    header, .sidebar, .hint, .no-print { display:none !important; }
    body{ background:white; }
    .page{ box-shadow:none; border:none; border-radius:0; }
    @page{
      size: A4 portrait;
      margin: 20mm;
    }
  }

  ::selection{ background:#c7d2fe; }
</style>
</head>
<body>
  <header class="no-print">
    <div class="toolbar">
      <div class="group">
        <button class="btn" id="btn-new" data-i18n="new" title="New">New</button>
        <label class="btn" for="file-open" title="Open">
          <span data-i18n="open">Open</span>
          <input id="file-open" type="file" accept=".txt,.html,.htm,.md,.rtf,image/*" class="hidden" />
        </label>
        <button class="btn" id="btn-save" data-i18n="download" title="Download (HTML)">Download</button>
        <button class="btn" id="btn-print" data-i18n="print" title="Print">Print</button>
      </div>

      <div class="group">
        <select id="fontname" title="Font">
          <option value="inherit" data-i18n="font">Font</option>
          <option>Arial</option>
          <option>Times New Roman</option>
          <option>Georgia</option>
          <option>Calibri</option>
          <option>Verdana</option>
          <option>Tahoma</option>
          <option>Courier New</option>
        </select>
        <select id="fontsize" title="Size">
          <option value="" data-i18n="size">Size</option>
          <option value="12px">12</option>
          <option value="14px">14</option>
          <option value="16px">16</option>
          <option value="18px">18</option>
          <option value="20px">20</option>
          <option value="24px">24</option>
          <option value="28px">28</option>
          <option value="32px">32</option>
        </select>
        <div class="sep"></div>
        <button class="btn" data-cmd="undo" data-i18n="undo" title="Undo">Undo</button>
        <button class="btn" data-cmd="redo" data-i18n="redo" title="Redo</button>
        <div class="sep"></div>
        <button class="btn" data-cmd="bold" title="Bold"><b>B</b></button>
        <button class="btn" data-cmd="italic" title="Italic"><i>I</i></button>
        <button class="btn" data-cmd="underline" title="Underline"><u>U</u></button>
        <button class="btn" data-cmd="strikeThrough" title="Strikethrough"><s>S</s></button>
        <div class="sep"></div>
        <label class="flex tag"><span data-i18n="color">Color</span> <input type="color" id="foreColor" value="#111111" /></label>
        <label class="flex tag"><span data-i18n="highlight">Highlight</span> <input type="color" id="hiliteColor" value="#fffd54" /></label>
      </div>

      <div class="group">
        <button class="btn" data-cmd="justifyLeft" data-i18n="alignLeft" title="Align Left">Left</button>
        <button class="btn" data-cmd="justifyCenter" data-i18n="alignCenter" title="Center">Center</button>
        <button class="btn" data-cmd="justifyRight" data-i18n="alignRight" title="Align Right">Right</button>
        <button class="btn" data-cmd="justifyFull" data-i18n="justify" title="Justify">Justify</button>
        <div class="sep"></div>
        <button class="btn" data-cmd="insertUnorderedList" data-i18n="ulist" title="Bulleted List">‚Ä¢ List</button>
        <button class="btn" data-cmd="insertOrderedList" data-i18n="olist" title="Numbered List">1. List</button>
        <button class="btn" data-cmd="outdent" data-i18n="outdent" title="Outdent">‚á§</button>
        <button class="btn" data-cmd="indent" data-i18n="indent" title="Indent">‚á•</button>
      </div>

      <div class="group">
        <label class="btn" for="img-open" title="Insert Image"><span data-i18n="image">Image</span>
          <input id="img-open" type="file" accept="image/*" class="hidden" />
        </label>
        <button class="btn" id="btn-clear" data-i18n="clear" title="Clear Formatting">Clear</button>
        <button class="btn" id="btn-full" data-i18n="fullscreen" title="Fullscreen">Fullscreen</button>
      </div>

      <div class="spacer"></div>

      <div class="group lang-switch" role="group" aria-label="Language">
        <button class="btn flag" id="lang-en" data-lang="en" aria-pressed="true" title="English">
          <span class="emoji">üá¨üáß</span> EN
        </button>
        <button class="btn flag" id="lang-sq" data-lang="sq" aria-pressed="false" title="Shqip">
          <span class="emoji">üá¶üá±</span> SQ
        </button>
        <button class="btn flag" id="lang-tr" data-lang="tr" aria-pressed="false" title="T√ºrk√ße">
          <span class="emoji">üáπüá∑</span> TR
        </button>
      </div>

      <div class="muted"><span id="autosave-label" data-i18n="autosave">Autosaves</span> ¬∑ <span id="status" class="tag" data-i18n="ready">Ready</span></div>
    </div>
  </header>

  <main>
    <div class="stage">
      <div class="page-wrap">
        <div id="page" class="page">
          <div id="editor" contenteditable="true" spellcheck="true">
            <h1 style="margin-top:0" data-i18n-doc="untitled">Untitled Document</h1>
            <p data-i18n-doc="intro">This editor provides a simple ‚ÄúWord-like‚Äù experience. Use Print to get an A4 output.</p>
          </div>
        </div>
        <p class="hint muted no-print" id="hint" data-i18n="hint">Tip: use <kbd>Ctrl/Cmd + P</kbd> to print, and <kbd>Ctrl/Cmd + B/I/U</kbd> for formatting.</p>
      </div>

      <aside class="sidebar no-print">
        <h3 data-i18n="pageSettings">Page Settings</h3>
        <div class="row">
          <label data-i18n="sizeLabel">Size</label>
          <select id="pagesize">
            <option value="A4" selected data-i18n-opt="a4">A4 (210√ó297mm)</option>
            <option value="Letter" data-i18n-opt="letter">Letter (8.5√ó11")</option>
            <option value="A5" data-i18n-opt="a5">A5 (148√ó210mm)</option>
          </select>
        </div>
        <div class="row">
          <label data-i18n="orientationLabel">Orientation</label>
          <select id="orientation">
            <option value="portrait" selected data-i18n-opt="portrait">Portrait</option>
            <option value="landscape" data-i18n-opt="landscape">Landscape</option>
          </select>
        </div>
        <div class="row">
          <label data-i18n="marginsLabel">Margins</label>
          <select id="margins">
            <option value="15mm" data-i18n-opt="narrow">Narrow (15mm)</option>
            <option value="20mm" selected data-i18n-opt="normal">Normal (20mm)</option>
            <option value="25mm" data-i18n-opt="wide">Wide (25mm)</option>
          </select>
        </div>
        <div class="row">
          <label data-i18n="lineSpacingLabel">Line Spacing</label>
          <select id="linespacing">
            <option value="1">1.0</option>
            <option value="1.15" selected>1.15</option>
            <option value="1.5">1.5</option>
            <option value="2">2.0</option>
          </select>
        </div>
        <div class="row">
          <button class="btn" id="btn-reset" data-i18n="resetPage">Reset Page</button>
        </div>
        <hr/>
        <h3 data-i18n="file">File</h3>
        <p class="muted" id="file-note" data-i18n="fileNote">Supports .txt/.html import. You can also drag & drop images.</p>
      </aside>
    </div>
  </main>

<script>
(function(){
  const editor = document.getElementById('editor');
  const status = document.getElementById('status');

  /* ---- i18n ---- */
  const I18N = {
    en: {
      __title: "Simple Word Page ‚Äî Online Editor",
      autosave: "Autosaves",
      ready: "Ready",
      new: "New",
      open: "Open",
      download: "Download",
      print: "Print",
      font: "Font",
      size: "Size",
      undo: "Undo",
      redo: "Redo",
      color: "Color",
      highlight: "Highlight",
      alignLeft: "Left",
      alignCenter: "Center",
      alignRight: "Right",
      justify: "Justify",
      ulist: "‚Ä¢ List",
      olist: "1. List",
      outdent: "Outdent",
      indent: "Indent",
      image: "Image",
      clear: "Clear",
      fullscreen: "Fullscreen",
      hint: "Tip: use Ctrl/Cmd + P to print, and Ctrl/Cmd + B/I/U for formatting.",
      pageSettings: "Page Settings",
      sizeLabel: "Size",
      orientationLabel: "Orientation",
      marginsLabel: "Margins",
      lineSpacingLabel: "Line Spacing",
      resetPage: "Reset Page",
      file: "File",
      fileNote: "Supports .txt/.html import. You can also drag & drop images.",
      // options
      a4: "A4 (210√ó297mm)",
      letter: "Letter (8.5√ó11\")",
      a5: "A5 (148√ó210mm)",
      portrait: "Portrait",
      landscape: "Landscape",
      narrow: "Narrow (15mm)",
      normal: "Normal (20mm)",
      wide: "Wide (25mm)",
      // dialogs & status
      confirmNew: "Create a new blank page? Current content may be lost.",
      confirmRestore: "Restore the last autosaved content?",
      saved: "Saved",
      notSaved: "Save failed",
      // doc
      doc_untitled: "Untitled Document",
      doc_intro: "This editor provides a simple ‚ÄúWord-like‚Äù experience. Use Print to get an A4 output.",
      // placeholder
      placeholder: "Start typing here...",
      document: "Document"
    },
    sq: {
      __title: "Faqe Word e Thjesht√´ ‚Äî Redaktues Online",
      autosave: "Ruhet automatikisht",
      ready: "Gati",
      new: "E re",
      open: "Hape",
      download: "Shkarko",
      print: "Shtyp",
      font: "Shkronja",
      size: "Madh√´sia",
      undo: "Kthe prapa",
      redo: "Rikthe",
      color: "Ngjyr√´",
      highlight: "Theksim",
      alignLeft: "Majtas",
      alignCenter: "Qend√´r",
      alignRight: "Djathtas",
      justify: "Dy an√´",
      ulist: "‚Ä¢ List√´",
      olist: "1. List√´",
      outdent: "Zvog√´lo zhvendosjen",
      indent: "Rrit zhvendosjen",
      image: "Imazh",
      clear: "Pastro",
      fullscreen: "Ekran i plot√´",
      hint: "K√´shill√´: p√´rdor Ctrl/Cmd + P p√´r shtypje dhe Ctrl/Cmd + B/I/U p√´r formatim.",
      pageSettings: "Parametrat e faqes",
      sizeLabel: "Madh√´sia",
      orientationLabel: "Orientimi",
      marginsLabel: "M√´njanat",
      lineSpacingLabel: "Hap√´sira nd√´rmjet rreshtave",
      resetPage: "Rivendos faqen",
      file: "Skedar√´t",
      fileNote: "Mb√´shtet importin .txt/.html. Mund t√´rhiqni dhe l√´shoni imazhe.",
      // options
      a4: "A4 (210√ó297mm)",
      letter: "Letter (8.5√ó11\")",
      a5: "A5 (148√ó210mm)",
      portrait: "Portret",
      landscape: "Peizazh",
      narrow: "E ngusht√´ (15mm)",
      normal: "Normale (20mm)",
      wide: "E gjer√´ (25mm)",
      // dialogs & status
      confirmNew: "T√´ krijohet nj√´ faqe e re bosh? P√´rmbajtja aktuale mund t√´ humbas√´.",
      confirmRestore: "T√´ rikthehet p√´rmbajtja e fundit e ruajtur automatikisht?",
      saved: "U ruajt",
      notSaved: "Ruajtja d√´shtoi",
      // doc
      doc_untitled: "Dokument pa titull",
      doc_intro: "Ky redaktues ofron nj√´ p√´rvoj√´ t√´ thjesht√´ si ‚ÄúWord‚Äù. P√´rdorni Shtyp p√´r dalje A4.",
      // placeholder
      placeholder: "Filloni t√´ shkruani k√´tu...",
      document: "Dokument"
    },
    tr: {
      __title: "Basit Word Sayfasƒ± ‚Äî √áevrimi√ßi Edit√∂r",
      autosave: "Otomatik kaydetme",
      ready: "Hazƒ±r",
      new: "Yeni",
      open: "A√ß",
      download: "ƒ∞ndir",
      print: "Yazdƒ±r",
      font: "Yazƒ± tipi",
      size: "Boyut",
      undo: "Geri al",
      redo: "ƒ∞leri al",
      color: "Renk",
      highlight: "Vurgu",
      alignLeft: "Sol",
      alignCenter: "Orta",
      alignRight: "Saƒü",
      justify: "ƒ∞ki yana",
      ulist: "‚Ä¢ Liste",
      olist: "1. Liste",
      outdent: "Girintiyi azalt",
      indent: "Girintiyi artƒ±r",
      image: "Resim",
      clear: "Temizle",
      fullscreen: "Tam ekran",
      hint: "ƒ∞pucu: Yazdƒ±rmak i√ßin Ctrl/Cmd + P, bi√ßimlendirme i√ßin Ctrl/Cmd + B/I/U.",
      pageSettings: "Sayfa Ayarlarƒ±",
      sizeLabel: "Boyut",
      orientationLabel: "Y√∂n",
      marginsLabel: "Kenar Bo≈üluklarƒ±",
      lineSpacingLabel: "Satƒ±r Aralƒ±ƒüƒ±",
      resetPage: "Sayfayƒ± Sƒ±fƒ±rla",
      file: "Dosya",
      fileNote: ".txt/.html i√ße aktarƒ±mƒ± desteklenir. G√∂rselleri s√ºr√ºkleyip bƒ±rakabilirsiniz.",
      // options
      a4: "A4 (210√ó297mm)",
      letter: "Letter (8.5√ó11\")",
      a5: "A5 (148√ó210mm)",
      portrait: "Dikey",
      landscape: "Yatay",
      narrow: "Dar (15mm)",
      normal: "Normal (20mm)",
      wide: "Geni≈ü (25mm)",
      // dialogs & status
      confirmNew: "Yeni bo≈ü sayfa olu≈üturulsun mu? Mevcut i√ßerik kaybolabilir.",
      confirmRestore: "Son otomatik kaydedilen i√ßerik y√ºklensin mi?",
      saved: "Kaydedildi",
      notSaved: "Kaydedilemedi",
      // doc
      doc_untitled: "Ba≈ülƒ±ksƒ±z Belge",
      doc_intro: "Bu edit√∂r, basit bir ‚ÄúWord benzeri‚Äù deneyim sunar. A4 √ßƒ±ktƒ± i√ßin Yazdƒ±r'ƒ± kullanƒ±n.",
      // placeholder
      placeholder: "Buraya yazmaya ba≈ülayƒ±n...",
      document: "Belge"
    }
  };

  const LANG_KEY = 'wordlike-lang';
  let currentLang = localStorage.getItem(LANG_KEY) || 'en';

  function t(key){
    const dict = I18N[currentLang] || I18N.en;
    return dict[key] || I18N.en[key] || key;
  }

  function applyLang(){
    document.documentElement.lang = currentLang;
    document.title = t('__title');
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      el.textContent = t(el.getAttribute('data-i18n'));
    });
    document.querySelectorAll('[data-i18n-opt]').forEach(opt=>{
      opt.textContent = t(opt.getAttribute('data-i18n-opt'));
    });
    // Doc template (only the default placeholders)
    const h1 = editor.querySelector('h1[data-i18n-doc="untitled"]');
    const intro = editor.querySelector('p[data-i18n-doc="intro"]');
    if(h1) h1.textContent = t('doc_untitled');
    if(intro) intro.textContent = t('doc_intro');
    // Placeholder
    document.documentElement.style.setProperty('--ph', `"${t('placeholder').replace(/"/g,'\\"')}"`);
    // Status & labels
    status.textContent = t('ready');
    document.getElementById('autosave-label').textContent = t('autosave');
    document.getElementById('btn-save').title = t('download') + ' (HTML)';
    document.getElementById('btn-new').title = t('new');
    document.getElementById('btn-print').title = t('print');
    document.getElementById('lang-en').setAttribute('aria-pressed', String(currentLang==='en'));
    document.getElementById('lang-sq').setAttribute('aria-pressed', String(currentLang==='sq'));
    document.getElementById('lang-tr').setAttribute('aria-pressed', String(currentLang==='tr'));
  }

  function setLang(lang){
    currentLang = (lang==='sq' || lang==='tr') ? lang : 'en';
    localStorage.setItem(LANG_KEY, currentLang);
    applyLang();
  }

  setLang(currentLang); // init

  document.getElementById('lang-en').addEventListener('click', ()=> setLang('en'));
  document.getElementById('lang-sq').addEventListener('click', ()=> setLang('sq'));
  document.getElementById('lang-tr').addEventListener('click', ()=> setLang('tr'));

  /* ---- Toolbar: execCommand helpers ---- */
  function cmd(name, value=null){
    document.execCommand('styleWithCSS', false, true);
    document.execCommand(name, false, value);
    editor.focus();
    autosave();
  }

  document.querySelectorAll('[data-cmd]').forEach(btn=>{
    btn.addEventListener('click', ()=> cmd(btn.dataset.cmd));
  });

  document.getElementById('fontname').addEventListener('change', e=>{
    const val = e.target.value;
    if(val && val !== 'inherit') cmd('fontName', val);
  });
  document.getElementById('fontsize').addEventListener('change', e=>{
    const size = e.target.value;
    if(!size) return;
    wrapSelectionWithSpan('font-size:'+size);
  });

  document.getElementById('foreColor').addEventListener('change', e=> cmd('foreColor', e.target.value));
  document.getElementById('hiliteColor').addEventListener('change', e=>{
    if(!document.queryCommandSupported('hiliteColor')){ cmd('backColor', e.target.value); }
    else{ cmd('hiliteColor', e.target.value); }
  });

  document.getElementById('btn-clear').addEventListener('click', ()=>{
    cmd('removeFormat');
    normalizeInline(editor);
  });

  document.getElementById('btn-full').addEventListener('click', ()=>{
    if(!document.fullscreenElement){
      document.documentElement.requestFullscreen().catch(()=>{});
    }else{
      document.exitFullscreen();
    }
  });

  document.getElementById('btn-new').addEventListener('click', ()=>{
    if(editor.textContent.trim().length && !confirm(t('confirmNew'))) return;
    editor.innerHTML = '<h1 style="margin-top:0" data-i18n-doc="untitled">'+t('doc_untitled')+'</h1><p data-i18n-doc="intro">'+t('doc_intro')+'</p>';
    autosave(true);
  });

  document.getElementById('btn-save').addEventListener('click', ()=>{
    const content = `<!doctype html>
<html lang="${currentLang}"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${t('document')}</title>
<style>@page{size:auto;margin:20mm}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial;font-size:14px;line-height:1.5;color:#111;margin:0;padding:20mm;background:#fff;} .doc{max-width:800px;margin:0 auto;} img{max-width:100%;height:auto}</style></head>
<body><div class="doc">${editor.innerHTML}</div></body></html>`;
    const blob = new Blob([content], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = (document.title || t('document')) + '.html';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  document.getElementById('btn-print').addEventListener('click', ()=> window.print());

  // Open (txt/html/img)
  document.getElementById('file-open').addEventListener('change', async e=>{
    const file = e.target.files[0]; if(!file) return;
    if(file.type && file.type.startsWith('image/')){
      insertImageFile(file);
      e.target.value='';
      return;
    }
    const text = await file.text();
    if(file.name.match(/\.(html?|htm)$/i)){
      editor.innerHTML = text;
    }else if(file.name.match(/\.rtf$/i)){
      editor.innerHTML = '<pre style="white-space:pre-wrap; font-family:ui-monospace, monospace">'+escapeHtml(text)+'</pre>';
    }else{
      editor.innerHTML = textToHtml(text);
    }
    autosave(true);
    e.target.value='';
  });

  document.getElementById('img-open').addEventListener('change', async e=>{
    const file = e.target.files[0]; if(!file) return;
    insertImageFile(file);
    e.target.value='';
  });

  function insertImageFile(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      const img = document.createElement('img');
      img.src = reader.result;
      img.alt = file.name;
      img.style.maxWidth = '100%';
      insertNodeAtCaret(img);
      autosave();
    };
    reader.readAsDataURL(file);
  }

  /* ---- Editor behaviors ---- */
  editor.addEventListener('input', autosave);
  editor.addEventListener('keydown', e=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){
      e.preventDefault();
      document.getElementById('btn-save').click();
    }
    if((e.ctrlKey||e.metaKey) && e.key === 'Enter'){
      e.preventDefault();
      const hr = document.createElement('hr');
      hr.style.pageBreakAfter='always';
      hr.style.border='0'; hr.style.height='1px'; hr.style.background='#e5e7eb';
      insertNodeAtCaret(hr);
      insertNodeAtCaret(document.createElement('p'));
      autosave();
    }
  });

  editor.addEventListener('dragover', e=>{ e.preventDefault(); });
  editor.addEventListener('drop', e=>{
    e.preventDefault();
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    if(file && file.type.startsWith('image/')) insertImageFile(file);
  });

  /* ---- Page settings ---- */
  const root = document.documentElement;
  const pagesize = document.getElementById('pagesize');
  const orientation = document.getElementById('orientation');
  const margins = document.getElementById('margins');
  const linespacing = document.getElementById('linespacing');

  function applyPage(){
    const size = pagesize.value;
    const orient = orientation.value;
    const margin = margins.value;
    const lh = linespacing.value;

    let w = '210mm', h = '297mm';
    if(size==='Letter'){ w = '216mm'; h = '279mm'; }
    if(size==='A5'){ w = '148mm'; h = '210mm'; }
    if(orient==='landscape'){ const tmp=w; w=h; h=tmp; }
    root.style.setProperty('--page-w', w);
    root.style.setProperty('--page-h', h);
    root.style.setProperty('--page-margin', margin);
    editor.style.lineHeight = lh;
  }
  [pagesize, orientation, margins, linespacing].forEach(el=> el.addEventListener('change', applyPage));
  applyPage();

  document.getElementById('btn-reset').addEventListener('click', ()=>{
    pagesize.value='A4'; orientation.value='portrait'; margins.value='20mm'; linespacing.value='1.15';
    applyPage();
  });

  /* ---- Local autosave ---- */
  const KEY = 'wordlike-doc-v1';
  let saveTimer;
  function autosave(immediate){
    clearTimeout(saveTimer);
    const save = ()=>{
      try{
        const data = {
          html: editor.innerHTML,
          meta: { time: Date.now(), size: editor.innerText.length }
        };
        localStorage.setItem(KEY, JSON.stringify(data));
        setStatus(t('saved'));
      }catch(e){ setStatus(t('notSaved')); }
    };
    if(immediate) save(); else saveTimer = setTimeout(save, 500);
  }

  (function restoreIfAny(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return;
      const data = JSON.parse(raw);
      if(confirm(t('confirmRestore'))){
        editor.innerHTML = data.html || editor.innerHTML;
      }
    }catch(e){}
  })();

  function setStatus(msg){
    status.textContent = msg;
    status.style.transition='none';
    status.style.background='#e0f2fe';
    setTimeout(()=>{
      status.style.transition='background 800ms ease';
      status.style.background='';
    }, 50);
  }

  /* ---- Utilities ---- */
  function textToHtml(text){
    const esc = escapeHtml(text);
    return esc.split(/\n{2,}/).map(p=> '<p>'+p.replace(/\n/g,'<br>')+'</p>').join('');
  }
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }
  function insertNodeAtCaret(node){
    const sel = window.getSelection();
    if(!sel || sel.rangeCount===0){ editor.appendChild(node); return; }
    const range = sel.getRangeAt(0);
    range.deleteContents();
    range.insertNode(node);
    range.setStartAfter(node);
    range.setEndAfter(node);
    sel.removeAllRanges();
    sel.addRange(range);
  }
  function wrapSelectionWithSpan(styleText){
    const sel = window.getSelection();
    if(!sel || sel.rangeCount===0) return;
    const range = sel.getRangeAt(0);
    const span = document.createElement('span');
    span.setAttribute('style', styleText);
    if(range.collapsed){
      span.innerHTML = '&#8203;';
      range.insertNode(span);
      range.setStart(span, 1);
      range.setEnd(span, 1);
      sel.removeAllRanges();
      sel.addRange(range);
    }else{
      try{
        range.surroundContents(span);
      }catch(e){
        const docFrag = range.cloneContents();
        span.appendChild(docFrag);
        range.deleteContents();
        range.insertNode(span);
      }
    }
  }
  function normalizeInline(rootEl){
    const walker = document.createTreeWalker(rootEl, NodeFilter.SHOW_ELEMENT, null);
    while(walker.nextNode()){
      const el = walker.currentNode;
      if(el.nodeName==='SPAN' && !el.getAttribute('style')){
        el.replaceWith(...el.childNodes);
      }
    }
  }

  // Keep the document title in sync with first H1 (user can change it)
  const titleObserver = new MutationObserver(()=>{
    const h1 = editor.querySelector('h1');
    if(h1){
      document.title = (h1.textContent || t('document')).trim() || t('document');
    }
  });
  titleObserver.observe(editor, {childList:true, subtree:true, characterData:true});

})();</script>
</body>
</html>
