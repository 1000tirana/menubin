<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>STL GÃ¶rÃ¼ntÃ¼leyici â€” Basit</title>
  <style>
    :root{
      --bg: #0b0e13;
      --fg: #e8eefc;
      --muted:#92a1b3;
      --panel: rgba(20,24,30,0.8);
      --accent:#4da3ff;
      --btn:#151a22;
      --btn2:#10141b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    #app{position:fixed;inset:0;display:flex;flex-direction:column}
    #toolbar{
      position:fixed;left:0;right:0;bottom:0;
      display:flex;gap:.5rem;align-items:center;justify-content:center;
      padding: .6rem env(safe-area-inset-right) calc(.6rem + env(safe-area-inset-bottom)) env(safe-area-inset-left);
      background: var(--panel);
      backdrop-filter: blur(8px);
      border-top: 1px solid rgba(255,255,255,.06);
      z-index:10;
    }
    .btn{
      -webkit-tap-highlight-color: transparent;
      appearance:none;border:1px solid rgba(255,255,255,.1);
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      color:var(--fg);
      padding:.7rem .9rem;border-radius:.75rem;font-size:14px;font-weight:600;
      display:flex;align-items:center;gap:.4rem;
      box-shadow: 0 1px 0 rgba(255,255,255,.05) inset, 0 4px 14px rgba(0,0,0,.28);
      cursor:pointer; touch-action: manipulation;
    }
    .btn:active{transform:translateY(1px)}
    #file{display:none}
    #canvas{position:absolute;inset:0}
    #msg{
      position:fixed;left:50%;top:12px;transform:translateX(-50%);
      background:var(--panel);border:1px solid rgba(255,255,255,.08);
      padding:.35rem .7rem;border-radius:.6rem;color:var(--muted);font-size:13px;z-index:9;
      backdrop-filter: blur(8px);
    }
    #overlay{
      position:absolute;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.35);z-index:8;
    }
    .spinner{
      width:34px;height:34px;border-radius:50%;
      border:3px solid rgba(255,255,255,.2);border-top-color:var(--accent);
      animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    #drop{
      position:absolute;inset:0;border:2px dashed rgba(255,255,255,.12);
      border-radius:16px;margin:14px;display:none;align-items:center;justify-content:center;
      color:var(--muted);z-index:7; pointer-events:none;
    }
    #hint{
      position:fixed;right:10px;top:10px;color:var(--muted);font-size:12px;opacity:.8;z-index:6;
      background: var(--panel);padding:.35rem .55rem;border-radius:.5rem;border:1px solid rgba(255,255,255,.06);
    }
    .chip{font-weight:700;color:var(--fg)}
    @media (min-width:900px){
      #toolbar{justify-content:center}
    }
  </style>
</head>
<body>
<div id="app">
  <div id="msg">Dosya seÃ§in veya ekrana <span class="chip">sÃ¼rÃ¼kleyip bÄ±rakÄ±n</span>. Parmakla dÃ¶ndÃ¼r, kÄ±stÄ±rarak yakÄ±nlaÅŸtÄ±r.</div>
  <div id="hint">Ä°pucu: URL'ye <span class="chip">?stl=dosya.stl</span> ekleyerek de yÃ¼kleyebilirsiniz.</div>
  <div id="overlay"><div class="spinner" aria-label="YÃ¼kleniyor"></div></div>
  <div id="drop">BÄ±rakÄ±nâ€¦</div>
  <canvas id="canvas"></canvas>
  <div id="toolbar">
    <label class="btn" for="file">ðŸ“‚ STL AÃ§</label>
    <button id="reset" class="btn">ðŸ”„ SÄ±fÄ±rla</button>
    <button id="wire" class="btn">ðŸ§µ Tel Kafes</button>
    <button id="bg" class="btn">ðŸŒ— Arka Plan</button>
    <button id="grid" class="btn"># Izgara</button>
  </div>
  <input id="file" type="file" accept=".stl,application/sla,model/stl" />
</div>

<!-- Three.js ve eklentiler (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.161.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.161.0/examples/js/loaders/STLLoader.js"></script>

<script>
(function(){
  const canvas = document.getElementById('canvas');
  const overlay = document.getElementById('overlay');
  const drop = document.getElementById('drop');
  const msg = document.getElementById('msg');

  // Scene
  const scene = new THREE.Scene();
  let dark = true;
  scene.background = new THREE.Color(0x0b0e13);

  // Camera
  const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 20000);
  camera.position.set(0, 0, 180);

  // Renderer
  const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:false});
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));

  // Controls
  const controls = new THREE.OrbitControls(camera, canvas);
  controls.enableDamping = true;
  controls.dampingFactor = .08;
  controls.rotateSpeed = .9;
  controls.enablePan = true;

  // Lights
  const amb = new THREE.AmbientLight(0xffffff, .55);
  const dir1 = new THREE.DirectionalLight(0xffffff, .75); dir1.position.set( 1, 2,  1);
  const dir2 = new THREE.DirectionalLight(0xffffff, .45); dir2.position.set(-2, 1, -1);
  scene.add(amb, dir1, dir2);

  // Grid
  let grid = new THREE.GridHelper(400, 20, 0x334455, 0x223344);
  grid.visible = false;
  scene.add(grid);

  // Model holder
  const holder = new THREE.Group();
  scene.add(holder);
  let mesh = null;

  // Material
  const matSolid = new THREE.MeshPhysicalMaterial({
    color: 0xdadfe8,
    metalness: .1,
    roughness: .5,
    clearcoat: .2,
    clearcoatRoughness: .7
  });
  const matWire = new THREE.MeshBasicMaterial({color: 0x88aaff, wireframe:true});
  let wireOn = false;

  function showLoading(v){ overlay.style.display = v ? 'flex' : 'none'; }
  function setMsg(t){ msg.textContent = t; msg.style.opacity = 1; clearTimeout(setMsg._t); setMsg._t = setTimeout(()=> msg.style.opacity = .0, 4000); }

  function onResize(){
    const w = window.innerWidth;
    const h = window.innerHeight;
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
    renderer.setSize(w, h, false);
  }
  window.addEventListener('resize', onResize, {passive:true});
  onResize();

  function frameObject(obj){
    // Fit camera to object bounds
    const bbox = new THREE.Box3().setFromObject(obj);
    const size = bbox.getSize(new THREE.Vector3());
    const center = bbox.getCenter(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.y, size.z);
    const dist = maxDim / (2 * Math.tan(THREE.MathUtils.degToRad(camera.fov) / 2));
    const newPos = center.clone().add(new THREE.Vector3(0, 0, dist * 1.3));
    camera.position.copy(newPos);
    controls.target.copy(center);
    controls.update();
  }

  function centerPivot(obj){
    const box = new THREE.Box3().setFromObject(obj);
    const center = box.getCenter(new THREE.Vector3());
    obj.position.sub(center);
  }

  // Loader
  const loader = new THREE.STLLoader();

  async function loadFromUrl(url){
    showLoading(true);
    try{
      loader.load(url, geo => {
        addGeometry(geo);
        setMsg("YÃ¼klendi: " + (url.split('/').pop() || url));
      }, xhr=>{}, err=>{
        console.error(err);
        setMsg("YÃ¼klenemedi. CORS engeli olabilir.");
      });
    } finally { showLoading(false); }
  }

  function addGeometry(geo){
    if (mesh) { holder.remove(mesh); mesh.geometry.dispose(); mesh = null; }
    // Convert to non-indexed for better shading
    const g = THREE.BufferGeometryUtils ? geo : geo; // keep simple
    mesh = new THREE.Mesh(geo, wireOn ? matWire : matSolid);
    mesh.castShadow = mesh.receiveShadow = true;
    holder.add(mesh);
    centerPivot(holder);
    frameObject(holder);
  }

  // File input
  document.getElementById('file').addEventListener('change', (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    showLoading(true);
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const arrayBuffer = reader.result;
        const geometry = loader.parse(arrayBuffer);
        addGeometry(geometry);
        setMsg("YÃ¼klendi: " + file.name);
      }catch(err){
        console.error(err);
        setMsg("Dosya okunamadÄ±.");
      }finally{ showLoading(false); }
    };
    reader.readAsArrayBuffer(file);
  });

  // Drag & Drop
  window.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.style.display='flex'; });
  window.addEventListener('dragleave', (e)=>{ drop.style.display='none'; });
  window.addEventListener('drop', (e)=>{
    e.preventDefault(); drop.style.display='none';
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    if (file) {
      const reader = new FileReader();
      showLoading(true);
      reader.onload = ()=>{
        try{
          const geometry = loader.parse(reader.result);
          addGeometry(geometry);
          setMsg("YÃ¼klendi: " + file.name);
        }catch(err){ console.error(err); setMsg("Dosya okunamadÄ±."); }
        finally{ showLoading(false); }
      };
      reader.readAsArrayBuffer(file);
    }
  });

  // Buttons
  document.getElementById('reset').addEventListener('click', ()=>{
    if (mesh){
      centerPivot(holder);
      frameObject(holder);
      controls.reset();
    }
  });
  document.getElementById('wire').addEventListener('click', ()=>{
    wireOn = !wireOn;
    if (mesh){ mesh.material = wireOn ? matWire : matSolid; }
  });
  document.getElementById('bg').addEventListener('click', ()=>{
    dark = !dark;
    scene.background = new THREE.Color(dark ? 0x0b0e13 : 0xf2f5fb);
    grid.material.color = new THREE.Color(dark ? 0x334455 : 0x9db1c9);
    grid.material.linewidth = 1;
  });
  document.getElementById('grid').addEventListener('click', ()=>{
    grid.visible = !grid.visible;
  });

  // URL param ?stl=
  const params = new URLSearchParams(location.search);
  const stlUrl = params.get('stl');
  if (stlUrl) loadFromUrl(stlUrl);

  // Animate
  function tick(){
    controls.update();
    renderer.render(scene, camera);
    requestAnimationFrame(tick);
  }
  tick();

  // iOS touch optimizations
  canvas.style.touchAction = 'none';
})();
</script>
<!-- BufferGeometryUtils (optional) for future extensions) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.161.0/examples/js/utils/BufferGeometryUtils.js"></script>
</body>
</html>
