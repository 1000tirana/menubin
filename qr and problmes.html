<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Lista QR Â· 4 Shifrat e Fundit</title>
<style>
  :root{--bg:#0f1115;--card:#171a21;--muted:#a9b1c3;--text:#e7ebf5;--accent:#29c06f;--danger:#ff5d5d;--warn:#ffc53d;--blue:#3da3ff}
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,0));padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
  .flags{display:flex;gap:8px}.flags button{background:none;border:none;font-size:20px;cursor:pointer}
  .app-title{font-size:16px;font-weight:700}.pill{padding:4px 10px;border-radius:999px;background:#1f2430;color:#a9b1c3;font-size:12px}
  .last-scan{position:sticky;top:46px;z-index:25;display:flex;align-items:center;gap:8px;background:#122019;color:#bff4d1;border:1px solid #1b3a2b;border-left:4px solid var(--accent);margin:6px 12px;border-radius:10px;padding:8px 12px;font-size:14px}
  .last-scan.duplicate{background:#2b1515;color:#f8c6c6;border-color:var(--danger)}
  .container{padding:10px 16px 140px 16px;max-width:980px;margin:0 auto}
  .camera-card{background:var(--card);border-radius:14px;padding:12px}
  .video-wrap{position:relative;border-radius:12px;overflow:hidden;background:#0a0c10;aspect-ratio:3/4}
  video{width:100%;height:100%;object-fit:cover;display:block}
  canvas#capture{display:none}
  .scan-frame{position:absolute;inset:10%;border:2px solid rgba(255,255,255,.55);border-radius:12px;pointer-events:none;transition:box-shadow .12s,border-color .12s}
  .glow-green{box-shadow:0 0 0 9999px rgba(0,128,0,.18) inset,0 0 22px rgba(0,255,144,.75) inset;border-color:rgba(0,255,144,.95)}
  .glow-red{box-shadow:0 0 0 9999px rgba(255,0,0,.18) inset,0 0 22px rgba(255,80,80,.9) inset;border-color:rgba(255,90,90,.95)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button,.btn{appearance:none;border:none;border-radius:12px;background:#222734;color:var(--text);padding:10px 14px;font-size:14px;font-weight:600;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .btn-primary{background:var(--accent);color:#07130e}
  .btn-danger{background:var(--danger);color:#260000}
  .btn-warn{background:var(--warn);color:#221a00}
  .btn-info{background:var(--blue);color:#001427}
  .cards{display:grid;gap:16px;margin-top:16px}
  @media(min-width:860px){.cards{grid-template-columns:1fr 1fr}}
  .list-card{background:var(--card);border-radius:14px;padding:8px 0}
  .list-header{display:flex;gap:10px;justify-content:space-between;align-items:center;padding:8px 14px;border-bottom:1px solid #242a39}
  .list-header .actions{display:flex;gap:8px;flex-wrap:wrap}
  .list{list-style:none;padding:0;margin:0}
  .item{display:flex;gap:10px;align-items:flex-start;padding:12px 14px;border-bottom:1px dashed #23293a}
  .item:last-child{border-bottom:none}
  .index{width:28px;height:28px;border-radius:999px;background:#242a39;display:flex;align-items:center;justify-content:center;font-weight:700;color:#c0c7d9;flex:0 0 auto}
  .value{flex:1;font-size:18px;font-weight:700;letter-spacing:.5px}
  .time{color:#a9b1c3;font-size:12px;margin-top:4px}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .chip{background:#23293a;color:#d5def1;border:1px solid #2f3850;border-radius:999px;padding:4px 8px;font-size:12px}
  .note{color:#ffdca8;font-size:12px;margin-top:4px}
  .del-btn,.edit-btn{background:#23293a;color:#ff9b9b;border-radius:10px;padding:4px 8px}
  .edit-btn{color:#bde1ff}
  .toolbar{position:fixed;left:0;right:0;bottom:0;z-index:20;backdrop-filter:blur(10px);background:rgba(10,12,16,.8);border-top:1px solid #242a39;padding:10px 16px;display:flex;gap:10px}
  .toolbar .btn{flex:1;justify-content:center}
  .toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#161d2a;color:#e7f1ff;padding:8px 12px;border-radius:10px;border:1px solid #27324a;display:none;z-index:60}
  .manual{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .manual input{flex:1;min-width:160px;background:#1b2030;border:1px solid #2a3246;color:var(--text);padding:10px 12px;border-radius:10px;font-size:14px}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:70}
  .modal .box{background:#121722;border:1px solid #293249;border-radius:14px;padding:14px;max-width:640px;width:92%}
  .modal h3{margin:0 0 8px 0}
  .opt-grid{display:grid;grid-template-columns:1fr;gap:8px;max-height:40vh;overflow:auto}
  @media(min-width:520px){.opt-grid{grid-template-columns:1fr 1fr}}
  .opt-row{display:flex;gap:8px;align-items:flex-start;background:#1a2030;border:1px solid #2a3246;border-radius:10px;padding:8px}
  .opt-row input{margin-top:4px}
  .box .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .box textarea,.box input[type="text"]{width:100%;background:#1b2030;border:1px solid #2a3246;color:var(--text);padding:10px;border-radius:10px;font-size:14px}
  .filter{display:flex;gap:8px;align-items:center}
  select{background:#1b2030;border:1px solid #2a3246;color:var(--text);padding:8px 10px;border-radius:10px}
</style>
</head>
<body>
<header>
  <div><span class="app-title" id="t-title">Lista QR</span> <span id="camStatus" class="pill">Kamera: Mbyllur</span></div>
  <div class="flags">
    <button onclick="setLang('sq')" title="Shqip">ðŸ‡¦ðŸ‡±</button>
    <button onclick="setLang('en')" title="English">ðŸ‡¬ðŸ‡§</button>
    <button onclick="setLang('tr')" title="TÃ¼rkÃ§e">ðŸ‡¹ðŸ‡·</button>
  </div>
</header>

<div id="lastBanner" class="last-scan" style="display:none;">
  <strong id="t-last">I fundit:</strong> <span id="lastValue">â€”</span>
</div>

<div class="container">
  <div class="camera-card">
    <div class="video-wrap">
      <video id="video" playsinline muted></video>
      <div id="scanFrame" class="scan-frame"></div>
    </div>
    <div class="controls">
      <button id="startBtn" class="btn-primary">Start</button>
      <button id="stopBtn" class="btn">Stop</button>
      <button id="torchBtn" class="btn">FlaÅŸ</button>
      <button id="resetBtn" class="btn-danger">Pastro</button>
      <button id="openIssuePicker" class="btn-info" title="Zgjidh probleme pÃ«r artikullin e fundit">+ Probleme</button>
    </div>
    <div class="manual">
      <input id="manualInput" type="text" maxlength="64" placeholder="Shkruaj kodin...">
      <button id="manualAddBtn" class="btn-warn">Shto</button>
    </div>
  </div>

  <div class="cards">
    <div class="list-card">
      <div class="list-header">
        <div><strong id="t-list">Lista</strong> Â· <span id="count">0</span></div>
        <div class="actions">
          <button id="copyBtn" class="btn">Kopjo</button>
          <button id="waBtn" class="btn">WhatsApp</button>
        </div>
      </div>
      <ul id="list" class="list"></ul>
    </div>

    <div class="list-card">
      <div class="list-header">
        <div><strong id="t-issues">Sorunlar</strong> Â· <span id="issuesCount">0</span></div>
        <div class="actions">
          <div class="filter">
            <label for="issueFilter" id="t-filter" style="color:#a9b1c3;font-size:12px;">Filtri:</label>
            <select id="issueFilter"><option value="_all_">TÃ« gjitha</option></select>
          </div>
          <button id="issuesCopyBtn" class="btn">Kopjo</button>
          <button id="issuesWaBtn" class="btn">WhatsApp</button>
          <button id="issuesClearBtn" class="btn-danger">Pastro</button>
        </div>
      </div>
      <ul id="issuesList" class="list"></ul>
    </div>
  </div>
</div>

<div class="toolbar">
  <button id="copyBtn2" class="btn">Kopjo</button>
  <button id="waBtn2" class="btn">WhatsApp</button>
</div>

<canvas id="capture"></canvas>
<div id="toast" class="toast"></div>

<!-- Modals -->
<div id="askModal" class="modal">
  <div class="box">
    <h3 id="t-askTitle">Ky skuter ka problem?</h3>
    <p id="t-askDesc" style="color:#a9b1c3;margin-top:0">E saposkanuara: <strong id="askCode">â€”</strong></p>
    <div class="row">
      <button id="askYes" class="btn-primary">Po</button>
      <button id="askNo" class="btn">Jo</button>
    </div>
  </div>
</div>

<div id="pickerModal" class="modal">
  <div class="box">
    <h3 id="t-pickerTitle">Zgjidh problemet</h3>
    <p id="t-pickerDesc" style="color:#a9b1c3;margin-top:0">PÃ«r kodin: <strong id="pickerCode">â€”</strong></p>
    <div class="opt-grid" id="optionsGrid"></div>
    <div class="row">
      <input id="customIssue" type="text" placeholder="Not / problem manuel (opsionale)">
    </div>
    <div class="row">
      <button id="pickerSave" class="btn-primary">Ruaj</button>
      <button id="pickerCancel" class="btn">Anulo</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
/* ==== DOM ==== */
const $=sel=>document.querySelector(sel);
const video=$('#video'),canvas=$('#capture'),ctx=canvas.getContext('2d',{willReadFrequently:true});
const startBtn=$('#startBtn'),stopBtn=$('#stopBtn'),torchBtn=$('#torchBtn'),resetBtn=$('#resetBtn');
const manualInput=$('#manualInput'),manualAddBtn=$('#manualAddBtn');
const listEl=$('#list'),countEl=$('#count'),lastBanner=$('#lastBanner'),lastValue=$('#lastValue'),scanFrame=$('#scanFrame');
const copyBtn=$('#copyBtn'),waBtn=$('#waBtn'),copyBtn2=$('#copyBtn2'),waBtn2=$('#waBtn2'),camStatus=$('#camStatus'),toastEl=$('#toast');
const issuesListEl=$('#issuesList'),issuesCountEl=$('#issuesCount'),issueFilterEl=$('#issueFilter');
const issuesCopyBtn=$('#issuesCopyBtn'),issuesWaBtn=$('#issuesWaBtn'),issuesClearBtn=$('#issuesClearBtn');
const askModal=$('#askModal'),askCodeEl=$('#askCode'),askYes=$('#askYes'),askNo=$('#askNo');
const pickerModal=$('#pickerModal'),pickerCodeEl=$('#pickerCode'),optionsGrid=$('#optionsGrid'),customIssue=$('#customIssue'),pickerSave=$('#pickerSave'),pickerCancel=$('#pickerCancel');
const openIssuePickerBtn=$('#openIssuePicker');

let stream=null,track=null,scanning=false,lastScanAt=0,items=[],torchOn=false;
let seen=new Set();
let curLang="sq";
let pendingCode=null;

/* ==== i18n ==== */
const langs={
 sq:{title:"Lista QR",camOn:"Kamera: Hap",camOff:"Kamera: Mbyllur",list:"Lista",last:"I fundit:",copied:"Kopjuar!",start:"Start",stop:"Stop",clear:"Pastro",copy:"Kopjo",flash:"DritÃ«",placeholder:"Shkruaj kodin...",add:"Shto",confirmDel:"A jeni i sigurt pÃ«r fshirjen?", confirmClear:"TÃ« pastrohet lista?", issues:"Sorunlar", askTitle:"Ky skuter ka problem?", askDesc:"E saposkanuara:", yes:"Po", no:"Jo", pickerTitle:"Zgjidh problemet", pickerDesc:"PÃ«r kodin:", save:"Ruaj", cancel:"Anulo", filter:"Filtri:", toastNoTorch:"Nuk mbÃ«shtetet drita", toastTorchErr:"Gabim dritÃ«", issuesClearConfirm:"TÃ« pastrohet lista e problemeve?"},
 en:{title:"QR List",camOn:"Camera: On",camOff:"Camera: Off",list:"List",last:"Last:",copied:"Copied!",start:"Start",stop:"Stop",clear:"Clear",copy:"Copy",flash:"Flash",placeholder:"Type a code...",add:"Add",confirmDel:"Are you sure to delete?", confirmClear:"Clear the whole list?", issues:"Issues", askTitle:"Does this scooter have a problem?", askDesc:"Scanned:", yes:"Yes", no:"No", pickerTitle:"Select issues", pickerDesc:"For code:", save:"Save", cancel:"Cancel", filter:"Filter:", toastNoTorch:"Torch not supported", toastTorchErr:"Torch error", issuesClearConfirm:"Clear all issues?"},
 tr:{title:"QR Liste",camOn:"Kamera: AÃ§Ä±k",camOff:"Kamera: KapalÄ±",list:"Liste",last:"Son:",copied:"KopyalandÄ±!",start:"BaÅŸlat",stop:"Durdur",clear:"Temizle",copy:"Kopyala",flash:"FlaÅŸ",placeholder:"Kod yaz...",add:"Ekle",confirmDel:"Silmek istediÄŸine emin misin?", confirmClear:"Liste tamamen temizlensin mi?", issues:"Sorunlar", askTitle:"Bu scooterâ€™da sorun var mÄ±?", askDesc:"Okunan:", yes:"Evet", no:"HayÄ±r", pickerTitle:"SorunlarÄ± seÃ§", pickerDesc:"Kod:", save:"Kaydet", cancel:"Ä°ptal", filter:"Filtre:", toastNoTorch:"FlaÅŸ desteklenmiyor", toastTorchErr:"FlaÅŸ hatasÄ±", issuesClearConfirm:"Sorunlar listesi temizlensin mi?"}
};
function setLang(l){
  curLang=l;
  $('#t-title').textContent=langs[l].title;
  $('#t-list').textContent=langs[l].list;
  $('#t-last').textContent=langs[l].last;
  $('#t-issues').textContent=langs[l].issues;
  $('#t-filter').textContent=langs[l].filter;
  camStatus.textContent=scanning?langs[l].camOn:langs[l].camOff;
  startBtn.textContent=langs[l].start; stopBtn.textContent=langs[l].stop;
  resetBtn.textContent=langs[l].clear; copyBtn.textContent=langs[l].copy; torchBtn.textContent=langs[l].flash;
  manualInput.placeholder=langs[l].placeholder; manualAddBtn.textContent=langs[l].add;
  waBtn.textContent="WhatsApp"; issuesCopyBtn.textContent=langs[l].copy; issuesWaBtn.textContent="WhatsApp"; issuesClearBtn.textContent=langs[l].clear;
  copyBtn2.textContent=langs[l].copy; waBtn2.textContent="WhatsApp";
  $('#t-askTitle').textContent=langs[l].askTitle;
  $('#t-pickerTitle').textContent=langs[l].pickerTitle;
}
window.setLang=setLang;

/* ==== Problems ==== */
const PROBLEMS=[
  "Iot yok","Iot ve kilit yok","Kilit yok","Tekerlek deÄŸiÅŸecek",
  "Fren yok","Fren kampana deÄŸiÅŸecek","Ã–n Dikme sallanÄ±yor (tundet timoni)",
  "Etiketler yok","Ã‡amurluk deÄŸiÅŸecek Ã¶n","Ã‡amurluk deÄŸiÅŸecek arka"
];
function buildFilterOptions(){
  issueFilterEl.innerHTML=<option value="__all__">TÃ« gjitha</option>;
  PROBLEMS.forEach(p=>{
    const opt=document.createElement('option');opt.value=p;opt.textContent=p;issueFilterEl.appendChild(opt);
  });
}

/* ==== Helpers ==== */
function last4(s){const only=String(s).replace(/[^0-9A-Za-z]/g,'');return only.slice(-4).toUpperCase();}
function beep(freq=880){try{const ac=new (window.AudioContext||window.webkitAudioContext)();const o=ac.createOscillator();const g=ac.createGain();o.type='triangle';o.frequency.value=freq;o.connect(g);g.connect(ac.destination);g.gain.setValueAtTime(0.001,ac.currentTime);g.gain.exponentialRampToValueAtTime(0.2,ac.currentTime+0.02);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+0.15);o.start();o.stop(ac.currentTime+0.16);setTimeout(()=>ac.close(),250);}catch{}}
function showBanner(val,isDup){lastValue.textContent=val||'â€”';lastBanner.style.display='flex';lastBanner.classList.toggle('duplicate',!!isDup);}
function flashOverlay(isDup){scanFrame.classList.remove('glow-green','glow-red');scanFrame.offsetWidth;scanFrame.classList.add(isDup?'glow-red':'glow-green');clearTimeout(scanFrame._t);scanFrame._t=setTimeout(()=>scanFrame.classList.remove('glow-green','glow-red'),350);}
function showToast(m){toastEl.textContent=m;toastEl.style.display='block';setTimeout(()=>toastEl.style.display='none',1400);}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

/* ==== Data ==== */
let issues=[]; // {value, problems[], note, time}
function save(){
  localStorage.setItem("qrItems_v3", JSON.stringify(items.map(o=>({value:o.value,time:o.time||new Date()}))));
  localStorage.setItem("qrIssues_v1", JSON.stringify(issues.map(o=>({value:o.value,problems:o.problems,note:o.note||"",time:o.time||new Date()}))));
}
function load(){
  try{
    const a=JSON.parse(localStorage.getItem("qrItems_v3")||"[]");items=a.map(o=>({value:o.value,time:new Date(o.time)}));items.forEach(x=>seen.add(x.value));
    const b=JSON.parse(localStorage.getItem("qrIssues_v1")||"[]");issues=b.map(o=>({value:o.value,problems:[...(o.problems||[])],note:o.note||"",time:new Date(o.time)}));
  }catch{}
  renderList();renderIssues();
}

/* ==== Normal list ==== */
function renderList(){
  listEl.innerHTML='';
  items.forEach((it,idx)=>{
    const li=document.createElement('li');li.className='item';
    li.innerHTML=`
      <div class="index">${idx+1}</div>
      <div style="flex:1">
        <div class="value">${it.value}</div>
        <div class="time">${new Date(it.time).toLocaleTimeString()}</div>
      </div>
      <button class="edit-btn" title="Probleme ekle">+</button>
      <button class="del-btn">Ã—</button>`;
    li.querySelector('.edit-btn').onclick=()=>openPickerModal(it.value);
    li.querySelector('.del-btn').onclick=()=>{
      if(confirm(langs[curLang].confirmDel)){
        const val=items[idx].value;items.splice(idx,1);
        if(!items.some(x=>x.value===val)) seen.delete(val);
        renderList();save();
      }
    };
    listEl.appendChild(li);
  });
  countEl.textContent=items.length;
}
function pushItem(value){
  const isDup=seen.has(value);
  if(!isDup){seen.add(value);items.push({value,time:new Date()});renderList();save();beep(880);}else{beep(440);}
  showBanner(value,isDup);flashOverlay(isDup);
  openAskModal(value);
}
function addFromScan(raw){const v=last4(raw);if(v) pushItem(v);}
function addFromManual(){const raw=manualInput.value.trim();const v=last4(raw);if(!v){showToast('â€”');return;}pushItem(v);manualInput.value='';}

/* ==== Issues ==== */
function upsertIssue(value,selected,note){
  const i=issues.findIndex(x=>x.value===value);
  if(i>-1){
    const cur=new Set(issues[i].problems||[]);
    (selected||[]).forEach(p=>cur.add(p));
    issues[i].problems=[...cur];
    if(note && note.trim()) issues[i].note=issues[i].note? (issues[i].note+" | "+note.trim()):note.trim();
    issues[i].time=new Date();
  }else{
    issues.push({value,problems:[...(selected||[])],note:(note||"").trim(),time:new Date()});
  }
  renderIssues();save();
}
function renderIssues(){
  const filter=issueFilterEl.value||"_all_";
  let arr=[...issues]; if(filter!=="_all_") arr=arr.filter(x=> (x.problems||[]).includes(filter));
  issuesListEl.innerHTML='';
  arr.forEach((it,idxView)=>{
    const idx=issues.findIndex(x=>x.value===it.value);
    const li=document.createElement('li');li.className='item';
    const chips=(it.problems||[]).map(p=><span class="chip">${p}</span>).join('');
    li.innerHTML=`
      <div class="index">${idxView+1}</div>
      <div style="flex:1">
        <div class="value">${it.value}</div>
        <div class="chips">${chips||'<span class="chip">â€”</span>'}</div>
        ${it.note?<div class="note">Not: ${escapeHtml(it.note)}</div>:''}
        <div class="time">${new Date(it.time).toLocaleTimeString()}</div>
      </div>
      <button class="edit-btn" title="DÃ¼zenle/Ekle">âœŽ</button>
      <button class="del-btn">Ã—</button>`;
    li.querySelector('.edit-btn').onclick=()=>openPickerModal(it.value);
    li.querySelector('.del-btn').onclick=()=>{
      if(confirm(langs[curLang].confirmDel)){issues.splice(idx,1);renderIssues();save();}
    };
    issuesListEl.appendChild(li);
  });
  issuesCountEl.textContent=issues.length;
}

/* ==== Camera ==== */
async function startCam(){
  try{
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      alert("Camera API not available in this browser.");return;
    }
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}}
    });
    video.srcObject=stream; await video.play();
    scanning=true; camStatus.textContent=langs[curLang].camOn;
    track=stream.getVideoTracks()[0]||null; torchOn=false;
    const caps=track && track.getCapabilities? track.getCapabilities():{};
    torchBtn.disabled=!(caps && 'torch' in caps);
    scanLoop();
  }catch(e){
    alert("Kamera aÃ§Ä±lamadÄ±: "+(e.message||e.name)+ "\n\nâ€¢ HTTPS altÄ±nda Ã§alÄ±ÅŸtÄ±rÄ±n\nâ€¢ TarayÄ±cÄ±dan kamera izni verin");
  }
}
function stopCam(){
  scanning=false;
  if(stream){stream.getTracks().forEach(t=>t.stop());}
  video.srcObject=null; track=null; torchOn=false; torchBtn.disabled=true;
  camStatus.textContent=langs[curLang].camOff;
}
async function toggleTorch(){
  if(!track || !track.applyConstraints){showToast(langs[curLang].toastNoTorch);return;}
  const caps=track.getCapabilities? track.getCapabilities():{};
  if(!caps.torch){showToast(langs[curLang].toastNoTorch);return;}
  try{
    torchOn=!torchOn; await track.applyConstraints({advanced:[{torch:torchOn}]});
    showToast(torchOn ? (curLang==='tr'?'FlaÅŸ: AÃ§Ä±k':curLang==='en'?'Flash: On':'Drita: On')
                      : (curLang==='tr'?'FlaÅŸ: KapalÄ±':curLang==='en'?'Flash: Off':'Drita: Off'));
  }catch(e){torchOn=false;showToast(langs[curLang].toastTorchErr);}
}
async function scanLoop(){
  if(!scanning) return;
  const now=performance.now();
  if(now-lastScanAt<140){return requestAnimationFrame(scanLoop);}
  lastScanAt=now;
  if(video.readyState>=2){
    if(typeof jsQR!=='function'){showToast('jsQR yÃ¼klenemedi');return;}
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const img=ctx.getImageData(0,0,canvas.width,canvas.height);
    const qr=jsQR(img.data,canvas.width,canvas.height,{inversionAttempts:'dontInvert'});
    if(qr && qr.data){addFromScan(qr.data.trim());}
  }
  requestAnimationFrame(scanLoop);
}

/* ==== Copy/Share ==== */
function buildNormalText(){return items.map((x,i)=>${i+1}. ${x.value}).join("\n");}
function buildIssuesText(){return issues.map((x,i)=>${i+1}. ${x.value} â€” ${(x.problems||[]).join(", ")}${x.note? | Not: ${x.note}:''}).join("\n");}
function copyText(t){if(!t){showToast('â€”');return;}navigator.clipboard.writeText(t).then(()=>showToast(langs[curLang].copied));}
function shareWhatsApp(t){if(!t){showToast('â€”');return;}window.open("https://wa.me/?text="+encodeURIComponent(t),'_blank');}

/* ==== Modals ==== */
function openAskModal(code){pendingCode=code;askCodeEl.textContent=code;askModal.style.display='flex';}
function closeAskModal(){askModal.style.display='none';}
function openPickerModal(code){
  pendingCode=code;pickerCodeEl.textContent=code;optionsGrid.innerHTML='';
  PROBLEMS.forEach((label,i)=>{
    const row=document.createElement('label');row.className='opt-row';
    const id='opt_'+i;row.innerHTML=<input id="${id}" type="checkbox"> <div>${label}</div>;optionsGrid.appendChild(row);
  });
  customIssue.value='';pickerModal.style.display='flex';
}
function closePickerModal(){pickerModal.style.display='none';}

/* ==== Events ==== */
startBtn.onclick=startCam; stopBtn.onclick=stopCam; torchBtn.onclick=toggleTorch;
resetBtn.onclick=()=>{ if(confirm(langs[curLang].confirmClear)){items=[];seen.clear();renderList();save();} };
manualAddBtn.onclick=addFromManual;
manualInput.addEventListener('keyup',e=>{if(e.key==='Enter') addFromManual();});
openIssuePickerBtn.onclick=()=>{if(!lastValue.textContent || lastValue.textContent==='â€”'){showToast('â€”');return;}openPickerModal(lastValue.textContent);};

copyBtn.onclick=()=>copyText(buildNormalText()); waBtn.onclick=()=>shareWhatsApp(buildNormalText());
copyBtn2.onclick=()=>copyText(buildNormalText()); waBtn2.onclick=()=>shareWhatsApp(buildNormalText());

issuesCopyBtn.onclick=()=>copyText(buildIssuesText());
issuesWaBtn.onclick=()=>shareWhatsApp(buildIssuesText());
issuesClearBtn.onclick=()=>{ if(confirm(langs[curLang].issuesClearConfirm)){issues=[];renderIssues();save();} };
issueFilterEl.onchange=renderIssues;

askYes.onclick=()=>{closeAskModal();openPickerModal(pendingCode);};
askNo.onclick=()=>{closeAskModal();};

pickerSave.onclick=()=>{
  const sel=[]; optionsGrid.querySelectorAll('input[type="checkbox"]').forEach((cb,i)=>{if(cb.checked) sel.push(PROBLEMS[i]);});
  upsertIssue(pendingCode,sel,customIssue.value.trim()); closePickerModal(); beep(920);
};
pickerCancel.onclick=()=>closePickerModal();

/* ==== Init ==== */
buildFilterOptions();
load();
setLang('sq');
camStatus.textContent=langs[curLang].camOff;
});
</script>
</body>
</html>