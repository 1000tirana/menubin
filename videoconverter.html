<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Video Bul & MP4’e Çevir</title>
<style>
 body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:20px;background:#0b0d10;color:#e6e6e6}
 h1{font-size:20px;margin:0 0 12px}
 .card{background:#13171c;border:1px solid #22272e;border-radius:12px;padding:14px;margin:10px 0}
 label{display:block;font-size:13px;margin:6px 0}
 input,button{width:100%;box-sizing:border-box;border-radius:10px;border:1px solid #2b3240;background:#0f1318;color:#fff;padding:10px}
 button{cursor:pointer;font-weight:600}
 .row{display:grid;grid-template-columns:1fr;gap:10px}
 @media(min-width:720px){.row{grid-template-columns:2fr 1fr 1fr}}
 .flex{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
 .muted{color:#a7aeb9;font-size:13px}
 .warn{color:#ff8b8b}
 .list{display:grid;gap:10px}
 video{max-width:100%;border-radius:8px;border:1px solid #2b3240;background:#000}
 .pill{display:inline-block;background:#1b212a;border:1px solid #2b3240;border-radius:999px;padding:4px 10px;font-size:12px;margin-right:6px}
 .log{white-space:pre-wrap;background:#0f1318;border:1px dashed #2b3240;border-radius:10px;padding:10px;font-size:12px;max-height:180px;overflow:auto}
</style>
</head>
<body>
  <h1>Video Bul & MP4’e Çevir</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Sayfa URL’si</label>
        <input id="pageUrl" placeholder="https://ornek-site.com/video-icerik">
      </div>
      <div>
        <label>Proxy URL (Cloudflare Worker)</label>
        <input id="proxyUrl" placeholder="https://senin-proxy.workers.dev/?u=">
      </div>
      <div style="display:flex;gap:6px;align-items:end">
        <button id="scanBtn">Tara</button>
        <button id="testBtn">Hızlı Test</button>
      </div>
    </div>
    <p class="muted" id="status">İpucu: Çoğu site CORS nedeniyle doğrudan taranamaz. Proxy girersen çalışır.</p>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px;font-size:16px">Bulunan Videolar</h2>
    <div id="results" class="list"></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px;font-size:16px">Günlük / Log</h2>
    <div id="log" class="log"></div>
  </div>

<script type="module">
  import { createFFmpeg, fetchFile } from 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js';
  const ffmpeg = createFFmpeg({ corePath: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js', log:true });
  let ffmpegReady=false;

  const el = (id)=>document.getElementById(id);
  const pageUrl = el('pageUrl');
  const proxyUrl = el('proxyUrl');
  const results = el('results');
  const status = el('status');
  const logEl = el('log');

  const log = (m)=>{ logEl.textContent += m + "\n"; logEl.scrollTop = logEl.scrollHeight; };
  const setStatus = (m, isWarn=false)=>{ status.textContent = m; status.className = isWarn ? 'muted warn' : 'muted'; };

  const PROXY_HELP = 'CORS hatası: Hedef sitenin HTML\'i tarayıcıdan okunamıyor. Proxy URL kutusuna Cloudflare Worker adresini girip tekrar deneyin.';

  const withProxy = (raw, p) => {
    if(!p) return raw; // direkt
    // Çoğu Worker şu iki formattan birini destekler:
    // 1) https://proxy.workers.dev/?u=<URL>
    // 2) https://proxy.workers.dev/<URL>
    try {
      const u = new URL(p);
      if(p.includes('?u=')) { // tür 1
        const uu = new URL(p);
        uu.searchParams.set('u', raw);
        return uu.href;
      }
      // tür 2
      return p.replace(/\/+$/,'') + '/' + encodeURIComponent(raw);
    } catch { return raw; }
  };

  const guessType = (u)=>{
    if(/\.mp4(\?|#|$)/i.test(u)) return 'mp4';
    if(/\.webm(\?|#|$)/i.test(u)) return 'webm';
    if(/\.mov(\?|#|$)/i.test(u)) return 'mov';
    if(/\.ogv(\?|#|$)/i.test(u)) return 'ogv';
    if(/\.m3u8(\?|#|$)/i.test(u)) return 'm3u8';
    return 'unknown';
  };

  const extract = (html, base)=>{
    const dom = new DOMParser().parseFromString(html, 'text/html');
    const out = new Map();

    const norm = (s)=>{ try{ return new URL(s, base).href }catch{ return s } };

    dom.querySelectorAll('video[src]').forEach(v=>{
      const u = norm(v.getAttribute('src')); out.set(u, {url:u, why:'<video src>'});
    });
    dom.querySelectorAll('video source[src]').forEach(v=>{
      const u = norm(v.getAttribute('src')); out.set(u, {url:u, why:'<source>'});
    });

    dom.querySelectorAll('meta[property="og:video"], meta[property="og:video:url"]').forEach(m=>{
      const u = norm(m.content||''); if(u) out.set(u, {url:u, why:'og:video'});
    });

    dom.querySelectorAll('a[href]').forEach(a=>{
      const u = norm(a.getAttribute('href')||'');
      if(/\.(mp4|webm|mov|ogv)(\?|#|$)/i.test(u)) out.set(u, {url:u, why:'<a href>'});
      if(/\.m3u8(\?|#|$)/i.test(u)) out.set(u, {url:u, why:'HLS .m3u8 (desteklenmez)'});
    });

    return [...out.values()];
  };

  const makeCard = (it)=>{
    const wrap = document.createElement('div'); wrap.className = 'card';
    const t = guessType(it.url);
    wrap.innerHTML = `<div><span class="pill">${t.toUpperCase()}</span><span class="pill">${it.why}</span></div>
                      <p class="muted" style="word-break:break-all">${it.url}</p>`;
    if(t!=='m3u8' && t!=='unknown'){
      const v = document.createElement('video'); v.controls = true; v.src = it.url; v.playsInline = true; wrap.appendChild(v);
    } else {
      const w = document.createElement('div'); w.className='muted'; w.textContent = (t==='m3u8') ? 'HLS (.m3u8) desteklenmez.' : 'Biçim tespit edilemedi.'; wrap.appendChild(w);
    }
    const row = document.createElement('div'); row.className='flex';
    const b1 = document.createElement('button'); b1.textContent='İndir (orijinal)'; b1.onclick=()=>download(it.url); row.appendChild(b1);
    if(t!=='mp4' && t!=='m3u8'){
      const b2 = document.createElement('button'); b2.textContent='MP4’e Çevir ve İndir'; b2.onclick=()=>convert(it.url); row.appendChild(b2);
    }
    wrap.appendChild(row);
    return wrap;
  };

  const download = async (u)=>{
    try{
      log('İndiriliyor: '+u);
      const r = await fetch(u);
      if(!r.ok) throw new Error('HTTP '+r.status);
      const blob = await r.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'video.' + (guessType(u)==='unknown'?'bin':guessType(u));
      a.click();
      URL.revokeObjectURL(a.href);
      log('İndirildi.');
    }catch(e){
      log('İndirme hatası: '+e.message);
      setStatus(PROXY_HELP,true);
      alert('CORS olabilir. Proxy kullanın.');
    }
  };

  const ensureFF = async ()=>{
    if(!ffmpegReady){ setStatus('FFmpeg yükleniyor…'); await ffmpeg.load(); ffmpegReady = true; setStatus(''); }
  };

  const convert = async (u)=>{
    try{
      await ensureFF();
      log('Dönüştürme için indiriliyor: '+u);
      const r = await fetch(u);
      if(!r.ok) throw new Error('HTTP '+r.status);
      const blob = await r.blob();
      const inName = 'in.'+(guessType(u) || 'bin');
      const outName = 'out.mp4';
      ffmpeg.FS('writeFile', inName, new Uint8Array(await blob.arrayBuffer()));
      log('FFmpeg çalışıyor…');
      await ffmpeg.run('-i', inName, '-c:v', 'libx264', '-preset', 'fast', '-movflags', 'faststart', '-c:a', 'aac', '-b:a', '128k', outName);
      const data = ffmpeg.FS('readFile', outName);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([data.buffer], {type:'video/mp4'}));
      a.download = 'converted.mp4'; a.click();
      URL.revokeObjectURL(a.href);
      log('Dönüştürme tamam.');
    }catch(e){
      log('Dönüştürme hatası: '+e.message);
      setStatus(PROXY_HELP,true);
      alert('Dönüştürme için de CORS gerekebilir. Proxy kullanın.');
    }
  };

  const scan = async ()=>{
    results.innerHTML = ''; logEl.textContent='';
    const url = pageUrl.value.trim(); const p = proxyUrl.value.trim();
    if(!url){ setStatus('Önce bir sayfa URL’si gir.', true); return; }
    setStatus('Sayfa indiriliyor…'); log('GET '+url+(p?` (proxy: ${p})`:'')); 
    try{
      const target = withProxy(url, p||null);
      const res = await fetch(target, {mode:'cors'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const html = await res.text();
      setStatus('Sayfa çözümleniyor…');
      const items = extract(html, url);
      if(items.length===0){ setStatus('Video bulunamadı. Bazı sitelerde kaynaklar JS ile yüklenir veya korumalı olabilir.', true); return; }
      setStatus(${items.length} video bulundu.);
      items.forEach(it=>results.appendChild(makeCard(it)));
    }catch(e){
      log('Hata: '+e.message);
      setStatus(PROXY_HELP, true);
    }
  };

  document.getElementById('scanBtn').addEventListener('click', scan);
  document.getElementById('testBtn').addEventListener('click', ()=>{
    // CORS-uyumlu örnek (GitHub Pages üstünden servis edilir)
    pageUrl.value = 'https://mdn.github.io/dom-examples/media/video-with-subtitles.html';
    scan();
  });
</script>
</body>
</html>
