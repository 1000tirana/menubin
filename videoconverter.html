<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Video Bul & MP4’e Çevir</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px;line-height:1.4;background:#0b0d10;color:#e6e6e6}
    h1{font-size:20px;margin:0 0 16px}
    .card{background:#13171c;border:1px solid #22272e;border-radius:12px;padding:16px;margin:12px 0}
    label{display:block;font-size:13px;margin:6px 0}
    input,button,textarea{width:100%;box-sizing:border-box;border-radius:10px;border:1px solid #2b3240;background:#0f1318;color:#fff;padding:10px}
    input::placeholder{color:#8a8f98}
    button{cursor:pointer;font-weight:600}
    button.primary{background:#2a6df1;border-color:#2a6df1}
    button:disabled{opacity:.6;cursor:default}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){.row{grid-template-columns:2fr 1fr}}
    .list{display:grid;gap:12px}
    .pill{display:inline-block;background:#1b212a;border:1px solid #2b3240;border-radius:999px;padding:4px 10px;font-size:12px;margin-right:6px}
    .muted{color:#a7aeb9;font-size:13px}
    .flex{display:flex;gap:8px;flex-wrap:wrap}
    video{max-width:100%;border-radius:8px;border:1px solid #2b3240;background:#000}
    .log{white-space:pre-wrap;background:#0f1318;border:1px dashed #2b3240;border-radius:10px;padding:10px;font-size:12px;max-height:180px;overflow:auto}
  </style>
</head>
<body>
  <h1>Video Bul & MP4’e Çevir</h1>
  <div class="card">
    <div class="row">
      <div>
        <label>Sayfa URL’si</label>
        <input id="pageUrl" placeholder="https://ornek-site.com/makale-123" />
      </div>
      <div>
        <label>Proxy URL (opsiyonel)</label>
        <input id="proxyUrl" placeholder="https://senin-proxy.domain/ (Cloudflare Worker)" />
      </div>
    </div>
    <div class="flex" style="margin-top:10px">
      <button class="primary" id="scanBtn">Sayfayı Tara</button>
      <button id="clearBtn">Temizle</button>
    </div>
    <p class="muted" style="margin-top:8px">
      İpucu: CORS izinli olmayan siteler için <b>Proxy URL</b> kullan. Aşağıda Cloudflare Worker kodu mevcut.
    </p>
    <div id="status" class="muted"></div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;font-size:16px">Bulunan Videolar</h2>
    <div id="results" class="list"></div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;font-size:16px">Günlük / Log</h2>
    <div id="log" class="log"></div>
  </div>

  <!-- ffmpeg.wasm -->
  <script type="module">
    import { createFFmpeg, fetchFile } from 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js';

    const logEl = document.getElementById('log');
    const resultsEl = document.getElementById('results');
    const statusEl = document.getElementById('status');
    const scanBtn = document.getElementById('scanBtn');
    const clearBtn = document.getElementById('clearBtn');
    const pageUrlEl = document.getElementById('pageUrl');
    const proxyUrlEl = document.getElementById('proxyUrl');

    const ffmpeg = createFFmpeg({
      log: true,
      corePath: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js'
    });
    let ffmpegLoaded = false;

    function log(msg){ logEl.textContent += (msg + '\\n'); logEl.scrollTop = logEl.scrollHeight; }
    function setStatus(msg){ statusEl.textContent = msg || ''; }

    function withProxy(url, proxyBase){
      if(!proxyBase) return url; // doğrudan
      const u = new URL(proxyBase);
      // Worker kodu örneği bu formatı destekler: https://proxy.example/?u=<ENCODED_URL>
      const proxied = new URL(u.href);
      proxied.searchParams.set('u', url);
      return proxied.href;
    }

    function normalizeUrl(src, base){
      try { return new URL(src, base).href; } catch(e){ return src; }
    }

    async function fetchText(url){
      const r = await fetch(url, { credentials:'omit', mode:'cors' });
      if(!r.ok) throw new Error('HTTP ' + r.status);
      return await r.text();
    }

    function extractCandidates(html, base){
      const dom = new DOMParser().parseFromString(html, 'text/html');
      const out = new Map();

      // <video src>, <video><source>, <source type="video/*">
      dom.querySelectorAll('video[src]').forEach(v=>{
        const u = normalizeUrl(v.getAttribute('src'), base);
        out.set(u, { url:u, why:'<video src>' });
      });
      dom.querySelectorAll('video source[src]').forEach(v=>{
        const u = normalizeUrl(v.getAttribute('src'), base);
        out.set(u, { url:u, why:'<source>' });
      });
      dom.querySelectorAll('source[src][type]').forEach(s=>{
        const t = (s.getAttribute('type')||'').toLowerCase();
        if(t.startsWith('video/')){
          const u = normalizeUrl(s.getAttribute('src'), base);
          out.set(u, { url:u, why:<source type="${t}"> });
        }
      });

      // OpenGraph
      dom.querySelectorAll('meta[property="og:video"], meta[property="og:video:url"]').forEach(m=>{
        const u = normalizeUrl(m.getAttribute('content')||'', base);
        if(u) out.set(u, { url:u, why:'og:video' });
      });

      // link rel=video_src
      dom.querySelectorAll('link[rel="video_src"][href]').forEach(l=>{
        const u = normalizeUrl(l.getAttribute('href')||'', base);
        if(u) out.set(u, { url:u, why:'link[rel=video_src]' });
      });

      // Basit heuristik: a[href] ile yaygın uzantılar
      dom.querySelectorAll('a[href]').forEach(a=>{
        const href = a.getAttribute('href')||'';
        const u = normalizeUrl(href, base);
        if(/\.(mp4|webm|mov|ogv)(\?|#|$)/i.test(u)){
          out.set(u, { url:u, why:'<a href> (dosya uzantısı)' });
        }
        if(/\.m3u8(\?|#|$)/i.test(u)){
          out.set(u, { url:u, why:'HLS .m3u8 (desteklenmez)' });
        }
        if(/youtube\.com|youtu\.be|vimeo\.com/i.test(u)){
          out.set(u, { url:u, why:'Embed (kısıtlı platform)' });
        }
      });

      return Array.from(out.values());
    }

    function guessType(u){
      if(/\.mp4(\?|#|$)/i.test(u)) return 'mp4';
      if(/\.webm(\?|#|$)/i.test(u)) return 'webm';
      if(/\.mov(\?|#|$)/i.test(u)) return 'mov';
      if(/\.ogv(\?|#|$)/i.test(u)) return 'ogv';
      if(/\.m3u8(\?|#|$)/i.test(u)) return 'm3u8';
      return 'unknown';
    }

    function makeItemUI(item){
      const card = document.createElement('div');
      card.className = 'card';

      const type = guessType(item.url);
      const header = document.createElement('div');
      header.innerHTML = <span class="pill">${type.toUpperCase()}</span><span class="pill">${item.why}</span>;
      card.appendChild(header);

      const p = document.createElement('p');
      p.className = 'muted';
      p.textContent = item.url;
      card.appendChild(p);

      // Önizleme (MP4/WEBM/MOV/OGV ve CORS izinliyse)
      if(type !== 'm3u8' && type !== 'unknown'){
        const vid = document.createElement('video');
        vid.controls = true;
        vid.src = item.url; // CORS izinli değilse çalışmayabilir
        vid.playsInline = true;
        vid.style.maxHeight = '260px';
        card.appendChild(vid);
      } else {
        const warn = document.createElement('div');
        warn.className = 'muted';
        warn.textContent = (type==='m3u8')
          ? 'HLS (.m3u8) tarayıcı içi dönüştürme desteklenmiyor.'
          : 'Biçim tespit edilemedi. Yine de indirmeyi deneyebilirsin.';
        card.appendChild(warn);
      }

      // Butonlar
      const row = document.createElement('div');
      row.className = 'flex';
      const dlBtn = document.createElement('button');
      dlBtn.textContent = 'İndir (orijinal)';
      dlBtn.onclick = ()=>downloadOriginal(item.url);
      row.appendChild(dlBtn);

      if(type !== 'mp4' && type !== 'm3u8'){
        const cvBtn = document.createElement('button');
        cvBtn.className = 'primary';
        cvBtn.textContent = 'MP4’e Çevir ve İndir';
        cvBtn.onclick = ()=>convertToMp4(item.url);
        row.appendChild(cvBtn);
      } else if(type === 'mp4') {
        const info = document.createElement('span');
        info.className = 'muted';
        info.textContent = 'Bu video zaten MP4.';
        row.appendChild(info);
      }
      card.appendChild(row);

      // Kısıtlı platform uyarısı
      if(/youtube\.com|youtu\.be|vimeo\.com/i.test(item.url)){
        const warn = document.createElement('p');
        warn.className = 'muted';
        warn.textContent = 'Bu tür platformlar kullanım şartları nedeniyle desteklenmez.';
        card.appendChild(warn);
      }

      return card;
    }

    async function downloadOriginal(url){
      try{
        log('İndiriliyor: ' + url);
        const r = await fetch(url);
        if(!r.ok) throw new Error('HTTP ' + r.status);
        const blob = await r.blob();
        const a = document.createElement('a');
        const ext = (blob.type && blob.type.includes('mp4')) ? 'mp4' :
                    (blob.type && blob.type.includes('webm')) ? 'webm' :
                    (blob.type && blob.type.includes('ogg')) ? 'ogv' :
                    (blob.type && blob.type.includes('quicktime')) ? 'mov' : 'bin';
        const filename = 'video.' + ext;
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
        log('İndirildi: ' + filename);
      }catch(e){
        log('İndirme hatası: ' + e.message);
        alert('İndirme başarısız olabilir (CORS). Gerekirse Proxy kullan.');
      }
    }

    async function ensureFFmpeg(){
      if(ffmpegLoaded) return;
      setStatus('FFmpeg yükleniyor (ilk kullanımda biraz sürebilir)…');
      log('FFmpeg core indiriliyor…');
      await ffmpeg.load();
      ffmpegLoaded = true;
      setStatus('');
      log('FFmpeg hazır.');
    }

    async function convertToMp4(url){
      try{
        await ensureFFmpeg();
        log('Video alınıyor: ' + url);
        const r = await fetch(url);
        if(!r.ok) throw new Error('HTTP ' + r.status);
        const blob = await r.blob();
        const inName = 'input.' + (guessType(url) || 'bin');
        const outName = 'output.mp4';

        log('FFmpeg’e yazılıyor…');
        ffmpeg.FS('writeFile', inName, new Uint8Array(await blob.arrayBuffer()));

        // Basit ve uyumlu bir profil: h264 + aac
        log('Dönüştürme başladı…');
        await ffmpeg.run('-i', inName, '-c:v', 'libx264', '-preset', 'fast', '-movflags', 'faststart', '-c:a', 'aac', '-b:a', '128k', outName);

        log('Çıktı okunuyor…');
        const data = ffmpeg.FS('readFile', outName);
        const outBlob = new Blob([data.buffer], { type:'video/mp4' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(outBlob);
        a.download = 'converted.mp4';
        a.click();
        URL.revokeObjectURL(a.href);
        log('Dönüşüm tamam: converted.mp4');
      }catch(e){
        log('Dönüştürme hatası: ' + e.message);
        alert('Dönüştürme başarısız olabilir. CORS veya biçim desteklenmiyor olabilir.');
      }
    }

    async function scan(){
      resultsEl.innerHTML = '';
      const pageUrl = pageUrlEl.value.trim();
      const proxyBase = proxyUrlEl.value.trim();

      if(!pageUrl){ alert('Sayfa URL’si gir.'); return; }
      setStatus('Sayfa indiriliyor…');
      log('Sayfa indiriliyor: ' + pageUrl);

      try{
        const target = withProxy(pageUrl, proxyBase||null);
        const html = await fetchText(target);
        setStatus('Sayfa çözümleniyor…');
        const items = extractCandidates(html, pageUrl);

        if(items.length === 0){
          setStatus('Video bulunamadı.');
          log('Aday video bağlantısı bulunamadı.');
          return;
        }
        setStatus(${items.length} aday bulundu.);
        items.forEach(it=>{
          resultsEl.appendChild(makeItemUI(it));
        });
      }catch(e){
        setStatus('Hata: ' + e.message);
        log('Taramada hata: ' + e.message + ' (CORS olabilir — Proxy kullan)');
      }
    }

    scanBtn.addEventListener('click', scan);
    clearBtn.addEventListener('click', ()=>{
      resultsEl.innerHTML = '';
      logEl.textContent = '';
      statusEl.textContent = '';
    });
  </script>
</body>
</html>
