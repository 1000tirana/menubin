<!DOCTYPE html>
<html lang="sq">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bark Kafe - Menaxhimi i Stokut</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }
        header {
            background-color: #5D4037; /* Kafe/Bar Rrënjë */
            color: white;
            padding: 15px 20px;
            text-align: center;
        }
        nav button {
            background-color: #795548;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        nav button:hover {
            background-color: #4E342E;
        }
        main {
            padding: 20px;
            max-width: 800px;
            margin: 20px auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h2, h3 {
            color: #795548;
            border-bottom: 2px solid #efebe9;
            padding-bottom: 5px;
        }
        input[type="email"], input[type="password"], input[type="text"], input[type="number"], input[type="date"] {
            width: 95%;
            padding: 10px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px; /* E rëndësishme për të parandaluar zmadhimin në celular */
        }
        button {
            background-color: #8D6E63;
            color: white;
            padding: 10px 15px;
            margin-top: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #6D4C41;
        }
        .alert {
            background-color: #ffe0b2;
            color: #e65100;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none;
        }
        /* Stilet e listës së produkteve në Numërim */
        .lista-produktit-autocomplete div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .lista-produktit-autocomplete div:hover {
            background-color: #efebe9;
        }
    </style>
</head>
<body>
    <header>
        <h1>BARK KAFA - Menaxhimi i Stokut</h1>
        <nav id="navbar" style="display:none;">
            <button onclick="shfaqFaqen('numërimi')">Numërimi i Stokut</button>
            <button onclick="shfaqFaqen('historiku')">Historiku</button>
            <button onclick="shfaqFaqen('produktet')">Produktet</button>
            <button onclick="shfaqFaqen('cilësimet')">Cilësimet</button>
            <button onclick="dilNgaLlogaria()">Dil</button>
        </nav>
    </header>

    <main id="app-container">
        <div id="mesazhi-alert" class="alert"></div>

        <section id="hyrja-regjistrimi">
            <h2>Hyrje / Regjistrim</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="fjalëkalimi" placeholder="Fjalëkalimi">
            <button onclick="hyrja()">Hyr (Giriş Yap)</button>
            <button onclick="regjistrimi()">Regjistrohu (Kayıt Ol)</button>
            <button onclick="resetFjalekaliminEmail()">Harrova Fjalëkalimin</button>
        </section>

        <section id="numërimi" style="display:none;">
            <h2>Numërimi Ditor i Stokut</h2>
            <input type="text" id="kërko-produkt" placeholder="Kërko Produktin...">
            <div id="lista-produktit-autocomplete" class="lista-produktit-autocomplete">
                </div>
            
            <div id="numërimi-i-produktit" style="border: 1px solid #ccc; padding: 15px; margin-top: 15px; border-radius: 5px; display:none;">
                <h3 id="emri-produktit-për-numërim"></h3>
                <input type="hidden" id="produkt-id-per-numërim">
                <input type="number" id="sasia-e-numëruar" placeholder="Sasia e numëruar (p.sh. 15)" min="0">
                <textarea id="shenime-numërimi" placeholder="Shënime (opsionale)"></textarea>
                <button onclick="ruajNumërimin()">Ruaj Numërimin (OK)</button>
            </div>
        </section>

        <section id="historiku" style="display:none;">
            <h2>Historiku i Numërimeve</h2>
            <label for="data-fillimi">Nga Data:</label>
            <input type="date" id="data-fillimi">
            <label for="data-mbarimit">Deri në Datën:</label>
            <input type="date" id="data-mbarimit">
            <button onclick="ngarkoHistorikun()">Shfaq Historikun</button>
            <button onclick="shkarkoTëDhënat()">Shkarko Të Dhënat (CSV)</button>
            
            <div id="lista-historikut">
                </div>
        </section>

        <section id="produktet" style="display:none;">
            <h2>Menaxhimi i Produkteve</h2>
            <input type="hidden" id="produkt-id-per-ndryshim">
            <input type="text" id="emri-i-ri-produktit" placeholder="Emri i Produktit">
            <input type="number" id="sasia-min-alarmit" placeholder="Sasia Min. e Alarmit (p.sh. 10)">
            <label style="display: block; margin: 10px 0;">
                <input type="checkbox" id="eshte-i-ftohte" checked> Është Produkt i Ftohtë (Sash)
            </label>
            <button onclick="shtoOseNdryshoProdukt()">Shto / Ruaj Produktin</button>
            
            <h3>Lista Aktuale</h3>
            <div id="lista-e-produkteve-menaxhimi">
                </div>
        </section>
        
        <section id="cilësimet" style="display:none;">
            <h2>Cilësimet</h2>
            
            <h3>Ndrysho Emailin</h3>
            <input type="email" id="email-i-ri" placeholder="Emaili i Ri">
            <input type="password" id="fjalëkalimi-aktual-email" placeholder="Fjalëkalimi Aktual">
            <button onclick="ndryshoEmailin()">Ndrysho Emailin</button>

            <h3>Rivendos Fjalëkalimin</h3>
            <input type="password" id="fjalëkalimi-i-ri" placeholder="Fjalëkalimi i Ri">
            <input type="password" id="fjalëkalimi-i-ri-konfirmo" placeholder="Konfirmo Fjalëkalimin">
            <button onclick="rivendosFjalëkaliminNëCilësime()">Rivendos Fjalëkalimin</button>
        </section>
    </main>
    
    <script>
        // ======================================================================
        // I. KONFIGURIMI I SUPABASE (Supabase Ayarları)
        // ======================================================================
        const SUPABASE_URL = 'https://oryjcnwvfeuugjogexdo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yeWpjbnd2ZmV1dWdqb2dleGRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODUzODUsImV4cCI6MjA3NjU2MTM4NX0.hicdNybxqXpK840ksn7sZvhI8V1NSG46PZvxrgjvLms';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let perdoruesi = null; // Përdoruesi aktual

        // ======================================================================
        // II. FUNKSIONET KRYESORE TË NAVIGIMIT DHE SHFAQJES
        // ======================================================================

        /** Shfaq mesazhe alarmi */
        function shfaqAlert(mesazhi, tipi = 'error') {
            const alertDiv = document.getElementById('mesazhi-alert');
            alertDiv.innerText = mesazhi;
            alertDiv.style.backgroundColor = tipi === 'error' ? '#ffcdd2' : '#c8e6c9';
            alertDiv.style.color = tipi === 'error' ? '#b71c1c' : '#2e7d32';
            alertDiv.style.display = 'block';
            setTimeout(() => { alertDiv.style.display = 'none'; }, 5000);
        }

        /** Fsheh të gjitha seksionet dhe shfaq atë të kërkuarin */
        function shfaqFaqen(faqjaID) {
            document.querySelectorAll('section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(faqjaID).style.display = 'block';

            // Funksione specifike për ngarkimin e të dhënave pas ndërrimit të faqes
            if (faqjaID === 'produktet') ngarkoProduktetMenaxhim();
            if (faqjaID === 'historiku') ngarkoHistorikunMujorParazgjedhur();
        }

        /** Kontrollon nëse përdoruesi është i kyçur */
        async function kontrolloStatusinELlogarisë() {
            const { data: { user } } = await supabase.auth.getUser();
            perdoruesi = user;

            if (perdoruesi) {
                document.getElementById('navbar').style.display = 'block';
                shfaqFaqen('numërimi');
            } else {
                document.getElementById('navbar').style.display = 'none';
                shfaqFaqen('hyrja-regjistrimi');
            }
        }
        
        // ======================================================================
        // III. AUTHENTICATION (Kimlik Doğrulama)
        // ======================================================================

        /** Hyrja në llogari (Giriş Yap) */
        async function hyrja() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('fjalëkalimi').value;
            
            const { error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                shfaqAlert(Gabim në Hyrje: ${error.message});
            } else {
                shfaqAlert("Hyrje me sukses!", 'sukses');
                kontrolloStatusinELlogarisë();
            }
        }

        /** Regjistrimi i ri (Kayıt Ol) */
        async function regjistrimi() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('fjalëkalimi').value;
            
            const { error } = await supabase.auth.signUp({ 
                email, 
                password,
                options: {
                    emailRedirectTo: window.location.origin, 
                }
            });

            if (error) {
                shfaqAlert(Gabim në Regjistrim: ${error.message});
            } else {
                shfaqAlert("Regjistrimi u krye. Kontrolloni emailin tuaj për konfirmim!", 'sukses');
            }
        }

        /** Dil nga llogaria (Çıkış Yap) */
        async function dilNgaLlogaria() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                shfaqAlert(Gabim në dalje: ${error.message});
            } else {
                shfaqAlert("Dolët me sukses!", 'sukses');
                kontrolloStatusinELlogarisë();
            }
        }

        /** Rivendos Fjalëkalimin (Harrova Fjalëkalimin - E-mail) */
        async function resetFjalekaliminEmail() {
            const email = document.getElementById('email').value;
            if (!email) {
                shfaqAlert("Ju lutemi vendosni emailin tuaj në fushën e Hyrjes.");
                return;
            }
            
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin + '/reset-password.html', // Duhet të keni një faqe të veçantë
            });

            if (error) {
                shfaqAlert(Gabim: ${error.message});
            } else {
                shfaqAlert("Linku i rivendosjes u dërgua në emailin tuaj.", 'sukses');
            }
        }

        // ======================================================================
        // IV. FUNKSIONET E STOKUT (Stok İşlemleri)
        // ======================================================================
        
        let produktiIDAktual = null; // ID-ja e produktit të zgjedhur

        // Autokompletimi i Kërkimit
        document.getElementById('kërko-produkt').addEventListener('input', debounce(kërkoProduktin, 300));

        async function kërkoProduktin(e) {
            const term = e.target.value.toLowerCase().trim();
            const listaDiv = document.getElementById('lista-produktit-autocomplete');
            listaDiv.innerHTML = '';
            document.getElementById('numërimi-i-produktit').style.display = 'none';

            if (term.length < 2) return;

            const { data, error } = await supabase
                .from('produktet')
                .select('id, emri_produktit')
                .ilike('emri_produktit', %${term}%)
                .eq('user_id', perdoruesi.id) // Vetëm produktet e përdoruesit
                .limit(10);

            if (error) return shfaqAlert(Gabim kërkimi: ${error.message});

            data.forEach(p => {
                const div = document.createElement('div');
                div.innerText = p.emri_produktit;
                div.onclick = () => zgjidhProduktin(p.id, p.emri_produktit);
                listaDiv.appendChild(div);
            });
        }

        /** Zgjedh një produkt për numërim */
        function zgjidhProduktin(id, emri) {
            produktiIDAktual = id;
            document.getElementById('emri-produktit-për-numërim').innerText = Numërimi i: ${emri};
            document.getElementById('produkt-id-per-numërim').value = id;
            document.getElementById('kërko-produkt').value = emri;
            document.getElementById('lista-produktit-autocomplete').innerHTML = ''; // Fsheh listën
            document.getElementById('numërimi-i-produktit').style.display = 'block';
            document.getElementById('sasia-e-numëruar').focus();
        }

        /** Ruaj Numërimin (INSERT/UPSERT) */
        async function ruajNumërimin() {
            const produkt_id = document.getElementById('produkt-id-per-numërim').value;
            const sasia = parseInt(document.getElementById('sasia-e-numëruar').value);
            const shënime = document.getElementById('shenime-numërimi').value;

            if (!produkt_id || isNaN(sasia) || sasia < 0) {
                return shfaqAlert("Ju lutemi zgjidhni një produkt dhe vendosni një sasi të vlefshme.");
            }

            const regjistrimi = {
                produkt_id: produkt_id,
                sasia_e_numëruar: sasia,
                shënime: shënime,
                user_id: perdoruesi.id,
                // Supabase do të përdorë 'current_date' për 'data_e_numërimit' (nga SQL RLS)
            };

            // Përdorim 'upsert' që nëse ka një numërim për këtë produkt sot, ta ndryshojë.
            const { error } = await supabase
                .from('regjistrimet_e_numërimit')
                .upsert(regjistrimi, { onConflict: 'produkt_id, data_e_numërimit, user_id' });

            if (error) {
                shfaqAlert(Gabim gjatë ruajtjes: ${error.message});
            } else {
                shfaqAlert("Numërimi u ruajt me sukses! Ju mund ta ndryshoni sot sërish.", 'sukses');
                // Pastrimi i fushave pas ruajtjes
                document.getElementById('kërko-produkt').value = '';
                document.getElementById('sasia-e-numëruar').value = '';
                document.getElementById('shenime-numërimi').value = '';
                document.getElementById('numërimi-i-produktit').style.display = 'none';
            }
        }
        
        // ======================================================================
        // V. FUNKSIONET E HISTORIKUT (Historik İşlemleri)
        // ======================================================================

        /** Ngarkon të dhënat e historikut brenda një periudhe */
        async function ngarkoHistorikun() {
            const dataFillimi = document.getElementById('data-fillimi').value;
            const dataMbarimit = document.getElementById('data-mbarimit').value;
            const listaDiv = document.getElementById('lista-historikut');
            listaDiv.innerHTML = 'Duke ngarkuar...';

            if (!dataFillimi || !dataMbarimit) {
                shfaqAlert("Ju lutemi zgjidhni datat.");
                listaDiv.innerHTML = '';
                return;
            }

            const { data, error } = await supabase
                .from('regjistrimet_e_numërimit')
                .select(`
                    sasia_e_numëruar, 
                    data_e_numërimit, 
                    shënime, 
                    produktet (emri_produktit)
                `)
                .eq('user_id', perdoruesi.id)
                .gte('data_e_numërimit', dataFillimi)
                .lte('data_e_numërimit', dataMbarimit)
                .order('data_e_numërimit', { ascending: false });

            if (error) {
                listaDiv.innerHTML = '';
                return shfaqAlert(Gabim historiku: ${error.message});
            }

            // Shfaqja në listë
            if (data.length === 0) {
                listaDiv.innerHTML = '<p>Nuk u gjet asnjë regjistrim për periudhën e zgjedhur.</p>';
                return;
            }

            let html = '<ul>';
            data.forEach(r => {
                const emri = r.produktet ? r.produktet.emri_produktit : 'Produkt i Fshirë';
                const sh = r.shënime ? ` (${r.shënime})` : '';
                html += <li>[${r.data_e_numërimit}] <b>${emri}</b>: ${r.sasia_e_numëruar} njësi ${sh}</li>;
            });
            html += '</ul>';
            listaDiv.innerHTML = html;
        }
        
        /** Ngarkon historikun e muajit aktual si parazgjedhje */
        function ngarkoHistorikunMujorParazgjedhur() {
            const sot = new Date();
            const fillimiIMuajit = new Date(sot.getFullYear(), sot.getMonth(), 1).toISOString().split('T')[0];
            const sotString = sot.toISOString().split('T')[0];
            
            document.getElementById('data-fillimi').value = fillimiIMuajit;
            document.getElementById('data-mbarimit').value = sotString;

            ngarkoHistorikun();
        }


        /** Shkarko Të Dhënat (CSV) */
        async function shkarkoTëDhënat() {
            const dataFillimi = document.getElementById('data-fillimi').value;
            const dataMbarimit = document.getElementById('data-mbarimit').value;
            
            const { data, error } = await supabase
                .from('regjistrimet_e_numërimit')
                .select(`
                    sasia_e_numëruar, 
                    data_e_numërimit, 
                    shënime, 
                    produktet (emri_produktit, eshte_i_ftohte)
                `)
                .eq('user_id', perdoruesi.id)
                .gte('data_e_numërimit', dataFillimi)
                .lte('data_e_numërimit', dataMbarimit)
                .order('data_e_numërimit', { ascending: false });

            if (error) return shfaqAlert(Gabim shkarkimi: ${error.message});
            
            if (data.length === 0) return shfaqAlert("Nuk ka të dhëna për t'u shkarkuar.", 'error');

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Headeri
            csvContent += "Emri_Produktit,Data,Sasia,Lloji_Produktit,Shenime\n";
            
            // Të dhënat
            data.forEach(r => {
                const emri = r.produktet ? r.produktet.emri_produktit : 'Nuk gjendet';
                const lloji = r.produktet && r.produktet.eshte_i_ftohte ? 'I Ftohtë' : 'Normal';
                const sh = r.shënime ? r.shënime.replace(/,/g, '') : ''; // Heq presjet
                csvContent += ${emri},${r.data_e_numërimit},${r.sasia_e_numëruar},${lloji},${sh}\n;
            });

            // Krijimi i linkut të shkarkimit
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", Historiku_Stokut_${dataFillimi}_deri_${dataMbarimit}.csv);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ======================================================================
        // VI. FUNKSIONET E MENAXHIMIT TË PRODUKTEVE (Ürün Yönetimi)
        // ======================================================================

        /** Ngarkon listën e produkteve për menaxhim */
        async function ngarkoProduktetMenaxhim() {
            const listaDiv = document.getElementById('lista-e-produkteve-menaxhimi');
            listaDiv.innerHTML = 'Duke ngarkuar...';

            const { data, error } = await supabase
                .from('produktet')
                .select('*')
                .eq('user_id', perdoruesi.id)
                .order('emri_produktit', { ascending: true });

            if (error) {
                listaDiv.innerHTML = Gabim: ${error.message};
                return;
            }

            if (data.length === 0) {
                listaDiv.innerHTML = '<p>Nuk ka produkte të regjistruara.</p>';
                return;
            }

            let html = '<table style="width:100%; border-collapse: collapse;">';
            html += '<tr><th>Emri</th><th>Min. Alarm</th><th>Lloji</th><th>Veprimet</th></tr>';
            
            data.forEach(p => {
                const lloji = p.eshte_i_ftohte ? 'I Ftohtë' : 'Normal';
                html += `
                    <tr>
                        <td>${p.emri_produktit}</td>
                        <td>${p.sasia_min_alarmit}</td>
                        <td>${lloji}</td>
                        <td>
                            <button style="width:auto;" onclick="ndryshoProduktin(${p.id}, '${p.emri_produktit}', ${p.sasia_min_alarmit}, ${p.eshte_i_ftohte})">Ndrysho</button>
                            <button style="width:auto; background-color: #d32f2f;" onclick="fshiProduktin(${p.id})">Fshi</button>
                        </td>
                    </tr>
                `;
            });
            html += '</table>';
            listaDiv.innerHTML = html;
        }

        /** Përgatit formularin për ndryshim */
        function ndryshoProduktin(id, emri, sasiaMin, eshteIFtohte) {
            document.getElementById('produkt-id-per-ndryshim').value = id;
            document.getElementById('emri-i-ri-produktit').value = emri;
            document.getElementById('sasia-min-alarmit').value = sasiaMin;
            document.getElementById('eshte-i-ftohte').checked = eshteIFtohte;
            window.scrollTo(0, 0); // Kthehet në krye të formularit
        }

        /** Shton ose Ndryshon Produktin */
        async function shtoOseNdryshoProdukt() {
            const id = document.getElementById('produkt-id-per-ndryshim').value;
            const emri = document.getElementById('emri-i-ri-produktit').value.trim();
            const sasiaMin = parseInt(document.getElementById('sasia-min-alarmit').value || 0);
            const eshteIFtohte = document.getElementById('eshte-i-ftohte').checked;

            if (!emri) return shfaqAlert("Emri i produktit nuk mund të jetë bosh.");

            const produktiData = {
                emri_produktit: emri,
                sasia_min_alarmit: sasiaMin,
                eshte_i_ftohte: eshteIFtohte,
                user_id: perdoruesi.id
            };

            let error;

            if (id) {
                // Ndryshim (Update)
                const response = await supabase
                    .from('produktet')
                    .update(produktiData)
                    .eq('id', id)
                    .eq('user_id', perdoruesi.id);
                error = response.error;
            } else {
                // Shtim (Insert)
                const response = await supabase
                    .from('produktet')
                    .insert(produktiData);
                error = response.error;
            }

            if (error) {
                if (error.code === '23505') {
                    shfaqAlert("Gabim: Një produkt me këtë emër tashmë ekziston.");
                } else {
                    shfaqAlert(Gabim ruajtje: ${error.message});
                }
            } else {
                shfaqAlert(Produkti u ruajt me sukses!, 'sukses');
                // Pastrimi dhe rifreskimi
                document.getElementById('produkt-id-per-ndryshim').value = '';
                document.getElementById('emri-i-ri-produktit').value = '';
                document.getElementById('sasia-min-alarmit').value = '10';
                ngarkoProduktetMenaxhim();
            }
        }

        /** Fshirja e Produktit */
        async function fshiProduktin(id) {
            if (!confirm("A jeni i sigurt që dëshironi të fshini këtë produkt? Të gjitha numërimet e tij do të fshihen gjithashtu.")) {
                return;
            }

            const { error } = await supabase
                .from('produktet')
                .delete()
                .eq('id', id)
                .eq('user_id', perdoruesi.id);

            if (error) {
                shfaqAlert(Gabim fshirje: ${error.message});
            } else {
                shfaqAlert("Produkti u fshi me sukses.", 'sukses');
                ngarkoProduktetMenaxhim();
            }
        }

        // ======================================================================
        // VII. FUNKSIONET E CILËSIVE (Ayarlar İşlemleri)
        // ======================================================================

        /** Ndrysho Emailin */
        async function ndryshoEmailin() {
            const emailRi = document.getElementById('email-i-ri').value;
            const passwordAktual = document.getElementById('fjalëkalimi-aktual-email').value;

            // Supabase kërkon që të bëhet re-autentifikimi para se të ndryshohet emaili.
            // Për thjeshtësi, e bëjmë ndryshimin direkt duke përdorur sessionin.

            if (!emailRi) return shfaqAlert("Ju lutemi vendosni emailin e ri.");

            // Shënim: Supabase automatikisht dërgon një email konfirmimi në emailin e ri.
            const { error } = await supabase.auth.updateUser({ 
                email: emailRi 
            });

            if (error) {
                shfaqAlert(Gabim në ndryshim: ${error.message});
            } else {
                shfaqAlert("Email u ndryshua. Ju lutemi konfirmoni adresën e re në kutinë tuaj hyrëse.", 'sukses');
                document.getElementById('email-i-ri').value = '';
                document.getElementById('fjalëkalimi-aktual-email').value = '';
            }
        }

        /** Rivendos Fjalëkalimin (Brenda Cilësimeve) */
        async function rivendosFjalëkaliminNëCilësime() {
            const passwordRi = document.getElementById('fjalëkalimi-i-ri').value;
            const passwordRiKonfirmo = document.getElementById('fjalëkalimi-i-ri-konfirmo').value;

            if (passwordRi.length < 6) return shfaqAlert("Fjalëkalimi duhet të jetë të paktën 6 karaktere.");
            if (passwordRi !== passwordRiKonfirmo) return shfaqAlert("Fjalëkalimi i ri dhe konfirmimi nuk përputhen.");

            const { error } = await supabase.auth.updateUser({ 
                password: passwordRi 
            });

            if (error) {
                shfaqAlert(Gabim në rivendosje: ${error.message});
            } else {
                shfaqAlert("Fjalëkalimi u rivendos me sukses. Ju duhet të kyçeni sërish.", 'sukses');
                dilNgaLlogaria();
            }
        }

        // ======================================================================
        // VIII. UTILITY (Ndihmëse)
        // ======================================================================

        /** Funksion debouncing për kërkim (throttle) */
        function debounce(func, timeout = 300) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }
        
        // ======================================================================
        // IX. INICIALIZIMI (Nisja)
        // ======================================================================

        // Kontrollo statusin e llogarisë kur ngarkohet faqja
        kontrolloStatusinELlogarisë();
        
    </script>
</body>
</html>
