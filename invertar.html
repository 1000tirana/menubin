<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Bark Kafe - Envanter Sayım Uygulaması</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* 2. CSS Stilleri (Minimalist ve Mobil Uyumlu) */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #5C6BC0; /* Mor tonu */
            text-align: center;
        }
        input[type="text"], input[type="number"], input[type="email"], input[type="password"], input[type="date"], button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px; /* Mobil zoom'u önlemek için kritik */
        }
        button {
            background-color: #7986CB; /* Daha açık mor */
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #5C6BC0;
        }
        #suggerimenti-produktit {
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #suggerimenti-produktit li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        #suggerimenti-produktit li:hover {
            background-color: #e0e0e0;
        }
        .section {
            display: none; /* JavaScript ile kontrol edilecek */
        }
    </style>
</head>
<body>

<div class="container">
    
    <div id="auth-section" class="section">
        <h1>Bark Kafe - Envanter</h1>
        <h2>Giriş / Kayıt</h2>
        
        <div id="auth-form">
            <input type="email" id="auth-email" placeholder="E-posta Adresi">
            <input type="password" id="auth-password" placeholder="Şifre">
            <button id="btn-login">Giriş Yap</button>
            <button id="btn-signup">Kaydol</button>
            <button id="btn-forgot-password">Şifremi Unuttum</button>
        </div>
    </div>

    <div id="main-section" class="section">
        <h2>Envanter Sayımı</h2>
        
        <input type="text" id="product-search" placeholder="Ürün Ara (Kola, Bira...)">
        
        <ul id="product-suggestions"></ul>
        
        <div id="count-entry-area" style="display:none;">
            <h3 id="active-product-name">Seçilen Ürün:</h3>
            <input type="number" id="count-amount" placeholder="Sayım Miktarı (Adet/Şişe)">
            <button id="btn-register-count">Sayımı Kaydet (OK)</button>
        </div>
        
        <hr>
        
        <h3>Navigasyon</h3>
        <button id="btn-go-to-products">Ürünleri Yönet/Ekle</button>
        <button id="btn-go-to-history">Geçmiş Kayıtlar ve İndir</button>
        <button id="btn-go-to-settings">Ayarlar</button>
        <button id="btn-logout">Çıkış Yap</button>
    </div>

    <div id="products-section" class="section">
        <h2>Ürünleri Yönet</h2>
        
        <h3>Yeni Ürün Ekle</h3>
        <input type="text" id="new-product-name" placeholder="Ürün Adı (p.ş. Kırmızı Şarap)">
        <input type="text" id="new-product-unit" placeholder="Birimi (p.ş. Şişe/Kutu/Fıçı)">
        <button id="btn-add-product">Ürünü Ekle</button>

        <h3>Mevcut Ürünler</h3>
        <ul id="product-list">
            </ul>
        
        <button id="btn-back-from-products">Ana Sayfaya Dön</button>
    </div>

    <div id="history-section" class="section">
        <h2>Geçmiş Envanter Kayıtları</h2>
        
        <h3>Tarih Aralığı Seçimi</h3>
        <label for="date-from">Başlangıç:</label>
        <input type="date" id="date-from">
        <label for="date-to">Bitiş:</label>
        <input type="date" id="date-to">
        <button id="btn-show-history">Kayıtları Göster</button>
        
        <hr>
        
        <button id="btn-download-month">Bu Ayın Kayıtlarını İndir (CSV)</button>
        <button id="btn-download-selected">Seçilen Tarihleri İndir (CSV)</button>

        <h3>Kayıt Listesi</h3>
        <div id="count-history-list">
            </div>

        <button id="btn-back-from-history">Ana Sayfaya Dön</button>
    </div>

    <div id="settings-section" class="section">
        <h2>Ayarlar</h2>
        
        <h3>E-posta Adresini Değiştir</h3>
        <input type="email" id="new-email" placeholder="Yeni E-posta Adresi">
        <button id="btn-update-email">E-postayı Güncelle</button>
        
        <hr>
        
        <h3>Şifreyi Sıfırla (Site İçi)</h3>
        <p>Girdiğiniz e-posta adresine bir sıfırlama linki gönderilecektir. Bu linke tıkladıktan sonra uygulamaya geri dönerek yeni şifrenizi belirleyebilirsiniz.</p>
        <button id="btn-send-reset-email">Şifre Sıfırlama E-postası Gönder</button>

        <button id="btn-back-from-settings">Ana Sayfaya Dön</button>
    </div>

</div>

<script>
    // Supabase Kimlik Bilgilerinizi Buraya Ekleyin
    const SUPABASE_URL = 'SENIN_SUPABASE_URL_IN'; // Supabase panelinizden alın
    const SUPABASE_ANON_KEY = 'SENIN_SUPABASE_ANON_KEYIN'; // Supabase panelinizden alın

    // Supabase İstemcisini Başlat
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==========================================
    // Yardımcı Fonksiyonlar (Görünürlüğü Kontrol Etme)
    // ==========================================

    const showSection = (id) => {
        document.querySelectorAll('.section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(id).style.display = 'block';
    }

    // ==========================================
    // 1. OTURUM YÖNETİMİ VE YÖNLENDİRME
    // ==========================================

    /**
     * Oturum durumunu kontrol eder ve kullanıcıyı ilgili sayfaya yönlendirir.
     */
    async function checkAuthStatus() {
        const { data: { session } } = await supabase.auth.getSession();
        
        if (session) {
            // Kullanıcı giriş yapmış, ana sayfayı göster
            showSection('main-section');
            // Gerekirse URL'deki hash'i kontrol et (p.ş. şifre sıfırlama sonrası)
            checkPasswordRecovery();
        } else {
            // Kullanıcı giriş yapmamış, giriş/kayıt sayfasını göster
            showSection('auth-section');
        }
    }

    /**
     * URL'deki şifre sıfırlama durumunu kontrol eder ve yeni şifre ister.
     */
    async function checkPasswordRecovery() {
        // Supabase'in şifre sıfırlama linki, kullanıcıyı uygulamaya geri yönlendirir ve oturumu açar.
        // Bu noktada, kullanıcıdan yeni şifreyi alıp güncellemeliyiz.

        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const type = urlParams.get('type');
        
        if (type === 'recovery') {
            const newPassword = prompt("Yeni Şifrenizi Girin:");
            if (newPassword) {
                const { error } = await supabase.auth.updateUser({ password: newPassword });
                if (error) {
                    alert("Şifre güncellenirken hata oluştu: " + error.message);
                } else {
                    alert("Şifreniz başarıyla güncellendi! Lütfen yeni şifrenizle giriş yapın.");
                    await supabase.auth.signOut(); // Güvenlik için oturumu kapat
                    window.location.hash = ''; // URL'yi temizle
                    showSection('auth-section');
                }
            } else {
                 alert("Şifre sıfırlama iptal edildi.");
            }
        }
    }


    // Giriş/Kayıt Olay Dinleyicileri
    document.getElementById('btn-login').onclick = async () => {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
            alert("Giriş Başarısız: " + error.message);
        } else {
            showSection('main-section');
        }
    };

    document.getElementById('btn-signup').onclick = async () => {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const { error } = await supabase.auth.signUp({ email, password });
        if (error) {
            alert("Kayıt Başarısız: " + error.message);
        } else {
            alert("Kayıt Başarılı! Lütfen e-postanızı kontrol ederek hesabınızı onaylayın.");
        }
    };

    document.getElementById('btn-logout').onclick = async () => {
        await supabase.auth.signOut();
        showSection('auth-section');
    };

    // Uygulama başlangıcında oturum durumunu kontrol et
    checkAuthStatus();

    // ==========================================
    // 2. ENVANTER SAYIM VE ÜRÜN ARAMA FONKSİYONU
    // ==========================================
    
    let activeProduct = null;

    document.getElementById('product-search').oninput = async (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const suggestionsList = document.getElementById('product-suggestions');
        suggestionsList.innerHTML = ''; // Listeyi temizle
        document.getElementById('count-entry-area').style.display = 'none';

        if (searchTerm.length < 2) return;

        // Supabase Ürün Arama (İlk harfini yazınca önermesi istendi)
        const { data, error } = await supabase
            .from('product') // Kendi tablonuzun adını girin (p.ş. 'produktet')
            .select('id, name')
            .ilike('name', `${searchTerm}%`) // İlk harf ile başlayanları getir
            .limit(10);

        if (error) {
            console.error(error);
            return;
        }

        data.forEach(product => {
            const li = document.createElement('li');
            li.textContent = product.name;
            li.onclick = () => selectProduct(product);
            suggestionsList.appendChild(li);
        });
    };

    function selectProduct(product) {
        activeProduct = product;
        document.getElementById('product-search').value = product.name;
        document.getElementById('product-suggestions').innerHTML = ''; // Öneri listesini temizle
        document.getElementById('active-product-name').textContent = `Seçilen Ürün: ${product.name}`;
        document.getElementById('count-entry-area').style.display = 'block';
        document.getElementById('count-amount').focus(); // Miktar alanına odaklan
    }

    document.getElementById('btn-register-count').onclick = async () => {
        if (!activeProduct) {
            alert("Lütfen önce bir ürün seçin.");
            return;
        }

        const countAmount = parseInt(document.getElementById('count-amount').value);
        if (isNaN(countAmount) || countAmount < 0) {
            alert("Geçerli bir miktar girin.");
            return;
        }

        const { data: { user } } = await supabase.auth.getUser();

        // Supabase Envanter Kaydı
        const { error } = await supabase
            .from('inventory') // Kendi tablonuzun adını girin (p.ş. 'inventari')
            .insert({
                product_id: activeProduct.id,
                amount: countAmount,
                user_id: user.id // Kaydı yapan kullanıcıyı tut
                // data_regjistrimit (Supabase'de varsayılan olarak NOW() ayarlanabilir)
            });

        if (error) {
            alert("Sayım kaydedilirken hata oluştu: " + error.message);
        } else {
            alert(`${activeProduct.name} için ${countAmount} adet sayım başarıyla kaydedildi!`);
            // Formu sıfırla
            document.getElementById('product-search').value = '';
            document.getElementById('count-amount').value = '';
            document.getElementById('count-entry-area').style.display = 'none';
            activeProduct = null;
        }
    };
    
    // ==========================================
    // 3. NAVİGASYON VE ROTA YÖNETİMİ
    // ==========================================

    document.getElementById('btn-go-to-products').onclick = () => {
        showSection('products-section');
        // Ürün listesini yükle
        loadProductList(); 
    };

    document.getElementById('btn-go-to-history').onclick = () => {
        showSection('history-section');
        // İndirme işlemleri için başlangıç/bitiş tarihlerini ayarla (örneğin bu ay)
        setupDateRange(); 
    };
    
    document.getElementById('btn-go-to-settings').onclick = () => {
        showSection('settings-section');
    };

    document.getElementById('btn-back-from-products').onclick = () => showSection('main-section');
    document.getElementById('btn-back-from-history').onclick = () => showSection('main-section');
    document.getElementById('btn-back-from-settings').onclick = () => showSection('main-section');

    // ==========================================
    // 4. ÜRÜN YÖNETİMİ FONKSİYONLARI
    // ==========================================

    async function loadProductList() {
        const productList = document.getElementById('product-list');
        productList.innerHTML = '<li>Yükleniyor...</li>';

        const { data, error } = await supabase
            .from('product') // 'produktet'
            .select('id, name, unit');

        if (error) {
            productList.innerHTML = `<li>Hata: ${error.message}</li>`;
            return;
        }

        productList.innerHTML = '';
        data.forEach(product => {
            const li = document.createElement('li');
            li.innerHTML = `
                ${product.name} (${product.unit})
                <button onclick="editProduct('${product.id}', '${product.name}', '${product.unit}')" style="width: auto; float: right; margin-left: 10px;">Düzenle</button>
            `;
            productList.appendChild(li);
        });
    }

    document.getElementById('btn-add-product').onclick = async () => {
        const name = document.getElementById('new-product-name').value.trim();
        const unit = document.getElementById('new-product-unit').value.trim();

        if (!name || !unit) {
            alert("Lütfen ürün adı ve birimini girin.");
            return;
        }

        const { error } = await supabase
            .from('product') // 'produktet'
            .insert([{ name, unit }]);

        if (error) {
            alert("Ürün eklenirken hata: " + error.message);
        } else {
            alert("Ürün başarıyla eklendi!");
            document.getElementById('new-product-name').value = '';
            document.getElementById('new-product-unit').value = '';
            loadProductList();
        }
    };
    
    // Düzenleme fonksiyonu (Basitleştirilmiş Prompt kullanımı)
    window.editProduct = async (id, oldName, oldUnit) => {
        const newName = prompt(`Yeni ürün adını girin (Eski: ${oldName}):`, oldName);
        if (newName === null || newName.trim() === "") return;

        const newUnit = prompt(`Yeni birimi girin (Eski: ${oldUnit}):`, oldUnit);
        if (newUnit === null || newUnit.trim() === "") return;

        const { error } = await supabase
            .from('product') // 'produktet'
            .update({ name: newName, unit: newUnit })
            .eq('id', id);

        if (error) {
            alert("Ürün güncellenirken hata: " + error.message);
        } else {
            alert("Ürün başarıyla güncellendi!");
            loadProductList();
        }
    };
    
    // ==========================================
    // 5. AYARLAR FONKSİYONLARI
    // ==========================================

    document.getElementById('btn-send-reset-email').onclick = async () => {
        const email = document.getElementById('auth-email').value; // Giriş ekranındaki e-postayı kullanmak ideal
        if (!email) {
            alert("Lütfen şifre sıfırlama için e-posta adresinizi girin.");
            return;
        }

        const { error } = await supabase.auth.resetPasswordForEmail(email, {
             // Kullanıcı şifre sıfırlama linkine tıkladığında yönlendirileceği URL
             redirectTo: window.location.origin + window.location.pathname 
        });

        if (error) {
            alert("Şifre sıfırlama e-postası gönderilirken hata: " + error.message);
        } else {
            alert("Şifre sıfırlama e-postası başarıyla gönderildi. Lütfen e-postanızı kontrol edin.");
        }
    };
    
    document.getElementById('btn-update-email').onclick = async () => {
        const newEmail = document.getElementById('new-email').value;
        if (!newEmail || !newEmail.includes('@')) {
            alert("Lütfen geçerli bir e-posta adresi girin.");
            return;
        }

        const { error } = await supabase.auth.updateUser({ email: newEmail });

        if (error) {
            alert("E-posta güncellenirken hata: " + error.message);
        } else {
            alert("E-posta güncelleme talebi gönderildi. Lütfen yeni e-posta adresinize gelen linki onaylayın.");
            document.getElementById('new-email').value = '';
        }
    };

    // ==========================================
    // 6. GEÇMİŞ VE İNDİRME FONKSİYONLARI
    // ==========================================
    
    function setupDateRange() {
        // Otomatik olarak bu ayın ilk gününü ve bugünü ayarla
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        const today = now.toISOString().split('T')[0];
        
        document.getElementById('date-from').value = firstDay;
        document.getElementById('date-to').value = today;
        
        // Başlangıçta bu ayın kayıtlarını göster
        document.getElementById('btn-show-history').click();
    }

    document.getElementById('btn-show-history').onclick = async () => {
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;
        
        await loadHistory(dateFrom, dateTo);
    };

    async function loadHistory(from, to) {
        const historyList = document.getElementById('count-history-list');
        historyList.innerHTML = 'Yükleniyor...';

        // Tarih filtresiyle Supabase sorgusu
        const { data, error } = await supabase
            .from('inventory') // 'inventari'
            .select(`
                amount,
                data_regjistrimit,
                product:product_id (name)
            `)
            .gte('data_regjistrimit', from)
            .lte('data_regjistrimit', to + 'T23:59:59.999Z') // Bitiş gününün sonunu dahil et
            .order('data_regjistrimit', { ascending: false });

        if (error) {
            historyList.innerHTML = `Hata: ${error.message}`;
            return;
        }

        historyList.innerHTML = '';
        if (data.length === 0) {
            historyList.innerHTML = '<p>Seçilen tarihler arasında kayıt bulunamadı.</p>';
            return;
        }

        // Kayıtları liste formatında göster
        data.forEach(item => {
            const p = document.createElement('p');
            const date = new Date(item.data_regjistrimit).toLocaleString('tr-TR');
            p.textContent = `${date}: ${item.product.name} - ${item.amount} Adet`;
            historyList.appendChild(p);
        });
        
        return data; // İndirme fonksiyonları için veriyi geri döndür
    }

    // İndirme Fonksiyonları (CSV Oluşturma)
    
    // Yardımcı fonksiyon: Veriyi CSV formatına dönüştürür
    function convertToCSV(data) {
        if (data.length === 0) return '';
        
        // Başlıkları (Header) oluştur
        const headers = ["Ürün Adı", "Miktar", "Kayıt Tarihi"];
        const csv = [headers.join(',')];

        // Veri satırlarını oluştur
        data.forEach(item => {
            const productName = item.product.name.replace(/,/g, ''); // Virgülleri temizle
            const date = new Date(item.data_regjistrimit).toLocaleString('tr-TR');
            csv.push([productName, item.amount, date].join(','));
        });

        return csv.join('\n');
    }

    // Yardımcı fonksiyon: CSV dosyasını indirir
    function downloadCSV(csv, filename) {
        const blob = new Blob(["\ufeff", csv], { type: 'text/csv;charset=utf-8;' }); // BOM ekle (Türkçe karakterler için)
        const link = document.createElement("a");
        if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            alert("Tarayıcınız indirme işlemini desteklemiyor.");
        }
    }

    document.getElementById('btn-download-month').onclick = async () => {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        const today = now.toISOString().split('T')[0];
        
        const data = await loadHistory(firstDay, today);
        if (data && data.length > 0) {
            const csvContent = convertToCSV(data);
            downloadCSV(csvContent, `Bark_Kafe_Envanter_Bu_Ay_${today}.csv`);
        } else {
            alert("İndirilecek veri bulunamadı.");
        }
    };
    
    document.getElementById('btn-download-selected').onclick = async () => {
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;
        
        const data = await loadHistory(dateFrom, dateTo);
        if (data && data.length > 0) {
            const csvContent = convertToCSV(data);
            downloadCSV(csvContent, `Bark_Kafe_Envanter_${dateFrom}_${dateTo}.csv`);
        } else {
            alert("İndirilecek veri bulunamadı.");
        }
    };

</script>

</body>
</html>
