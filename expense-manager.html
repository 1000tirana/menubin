<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ANDI · Shpenzimet e Shtëpisë</title>
<meta name="theme-color" content="#0f8a6f">
<style>
  :root{
    --bg:#0e1014; --card:#151923; --muted:#9aa3b2; --text:#e9eef7;
    --accent:#19c28e; --accent-2:#3ddc97; --danger:#ff6464; --warn:#ffc83d;
    --chip:#1d2230; --stroke:#242a38; --shadow:0 10px 30px rgba(0,0,0,.35);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#0b0d11 0%, #101420 100%);
    font-family: ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans",sans-serif;
    color:var(--text);
  }
  .wrap{max-width:920px;margin-inline:auto;padding:clamp(14px,2.5vw,24px)}
  header.app{
    position:sticky;top:0;z-index:5;border-bottom:1px solid var(--stroke);
    background:linear-gradient(180deg,#0f8a6f 0%, #0a6a56 100%);
    border-radius:0 0 18px 18px;box-shadow:var(--shadow);padding:18px 16px 14px;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:38px;height:38px;border-radius:12px;background:radial-gradient(120% 120% at 20% 10%,#fff 0%,#bdf6e7 35%,#0f8a6f 36%,#095a49 100%);box-shadow:inset 0 0 0 2px rgba(255,255,255,.12),0 8px 18px rgba(0,0,0,.2)}
  .title{display:flex;flex-direction:column;line-height:1.1}
  .title b{font-size:18px;letter-spacing:.2px}
  .title small{opacity:.9;color:#e9fff7}
  .bar{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
  .pill{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);padding:8px 12px;border-radius:999px;font-size:13px}

  .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-top:18px}
  .card h3{margin:0 0 12px;font-size:16px;letter-spacing:.2px}

  .row{display:grid;gap:10px}
  @media(min-width:640px){.row{grid-template-columns:1.2fr 1fr}}
  .grid2{display:grid;gap:10px}
  @media(min-width:640px){.grid2{grid-template-columns:1fr 1fr}}
  .grid3{display:grid;gap:10px}
  @media(min-width:800px){.grid3{grid-template-columns:1.1fr 1fr 1fr}}

  label{font-size:13px;color:var(--muted)}
  input,select,textarea,button{
    width:100%;border-radius:12px;border:1px solid var(--stroke);background:#101521;color:var(--text);
    padding:12px 14px;font-size:16px;outline:none;transition:.2s border,.2s transform,.2s box-shadow;
  }
  input::placeholder,textarea::placeholder{color:#5b6473}
  select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,#5f6b7e 50%),linear-gradient(135deg,#5f6b7e 50%,transparent 50%);
    background-position:calc(100% - 18px) calc(1em + 2px),calc(100% - 13px) calc(1em + 2px);background-size:6px 6px,6px 6px;background-repeat:no-repeat}
  textarea{min-height:80px;resize:vertical}

  .btn{border:1px solid #1d6b56;background:linear-gradient(180deg,var(--accent) 0%,var(--accent-2) 100%);color:#032a20;font-weight:700;letter-spacing:.2px;cursor:pointer;box-shadow:0 8px 20px rgba(25,194,142,.35)}
  .btn:hover{transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn-ghost{background:transparent;border:1px dashed var(--stroke);color:var(--text)}
  .btn-danger{background:linear-gradient(180deg,#ff9a9a 0%,var(--danger) 100%);color:#3a0d0d;border:1px solid #802b2b}

  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
  .toolbar .grow{flex:1}

  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:#0f1320;cursor:pointer;font-size:13px}
  .tab.active{background:linear-gradient(180deg,var(--accent) 0%,var(--accent-2) 100%);color:#032a20;border-color:#1d6b56}

  .list{display:grid;gap:10px;margin-top:10px}
  .item{display:grid;grid-template-columns:1fr auto;gap:12px;padding:12px;border:1px solid var(--stroke);border-radius:12px;background:#101521}
  .top{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{background:var(--chip);padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;color:#cfe8df}
  .amt{font-weight:800}
  .time{color:#7f8aa0;font-size:12px}
  .actions{display:flex;gap:8px}
  .act{border:1px solid var(--stroke);background:#0f1320;border-radius:10px;padding:8px 10px;font-size:13px;cursor:pointer}
  .act:hover{transform:translateY(-1px)}

  .totals{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  .total-box{background:#0f1320;border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;font-size:14px}

  dialog{border:none;border-radius:16px;background:#121826;color:var(--text);box-shadow:var(--shadow);width:min(92vw,520px);padding:0}
  dialog::backdrop{background:rgba(0,0,0,.5)}
  .modal-head{padding:16px 18px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;gap:10px}
  .modal-body{padding:18px}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:0 18px 18px}

  .fab{
    position:fixed;right:16px;bottom:18px;z-index:10;width:58px;height:58px;border-radius:50%;
    display:grid;place-items:center;background:linear-gradient(180deg,var(--accent) 0%,var(--accent-2) 100%);
    border:1px solid #1d6b56;color:#032a20;font-weight:900;font-size:28px;box-shadow:0 14px 24px rgba(25,194,142,.35);cursor:pointer;
  }
  .toast{
    position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
    background:#0f1320;border:1px solid var(--stroke);color:var(--text);
    padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);display:flex;gap:10px;align-items:center
  }
  .toast button{white-space:nowrap}
  .help{color:#cfe8df;font-size:13px}
  .muted{color:var(--muted)}
  .hide{display:none!important}
  canvas{background:#0f1320;border:1px solid var(--stroke);border-radius:12px;padding:10px}
</style>
</head>
<body>
  <header class="app">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">
        <b>ANDI · Shpenzimet e Shtëpisë</b>
        <small>Monedha: Lekë (ALL)</small>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- SHTIM I SHPEJTË -->
    <section class="card">
      <h3>Shtim i Shpejtë</h3>
      <form id="entry" autocomplete="off">
        <div class="row">
          <div>
            <label for="amount">Shuma (Lekë)</label>
            <input id="amount" inputmode="decimal" placeholder="p.sh. 1200" required>
          </div>
          <div>
            <label for="category">Kategoria</label>
            <select id="category" required>
              <option value="" disabled selected>Zgjidh kategorinë</option>
              <option>Qira</option>
              <option>Fatura e ujit</option>
              <option>Fatura e energjisë</option>
              <option>Internet</option>
              <option>Blerje ushqimore</option>
              <option>Detergjent rrobash</option>
              <option>Rroba</option>
              <option>Jashtë në restorant</option>
              <option>Shpenzime makine</option>
              <option value="__custom">Shënim i lirë</option>
            </select>
          </div>
        </div>
        <div id="noteRow" class="hide">
          <label for="note">Shënim (opsionale)</label>
          <textarea id="note" placeholder="p.sh. ‘Market te Bajrami’, ‘Restorant…’"></textarea>
        </div>
        <div class="grid2">
          <button type="submit" class="btn">Shto regjistrim</button>
          <button type="button" id="clearBtn" class="btn-ghost">Pastro të gjitha</button>
        </div>
        <div class="help">Pas çdo shtimi do të pyes: “Ta shkarkoj CSV?”</div>
      </form>
    </section>

    <!-- PËRMBLEDHJE + MJETE -->
    <section class="card">
      <h3>Përmbledhje</h3>
      <div class="toolbar">
        <div class="grow">
          <label for="monthPick">Muaji</label>
          <input type="month" id="monthPick">
        </div>
        <div class="grow">
          <label for="search">Kërko</label>
          <input id="search" placeholder="Filtro sipas kategorie/shënimi…">
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="exportBtn" class="btn">Shkarko CSV</button>
        </div>
        <div>
          <label class="btn-ghost" style="display:inline-grid;place-items:center;cursor:pointer;margin-top:20px">
            Ngarko CSV
            <input id="importInput" type="file" accept=".csv,text/csv" style="display:none">
          </label>
        </div>
      </div>

      <div id="monthSummary" class="help" style="margin-top:10px"></div>

      <div class="tabs" id="chartTabs">
        <button class="tab active" data-range="week">Javor</button>
        <button class="tab" data-range="month">Mujor</button>
        <button class="tab" data-range="year">Vjetor</button>
      </div>
      <div style="margin-top:10px">
        <canvas id="mainChart" height="220"></canvas>
      </div>

      <div class="totals" id="totals"></div>
    </section>

    <!-- LISTA -->
    <section class="card">
      <h3>Regjistrat</h3>
      <div id="empty" class="muted">Ende nuk ka të dhëna.</div>
      <div class="list" id="list"></div>
    </section>
  </div>

  <!-- FAB -->
  <button class="fab" title="Regjistrim i ri" aria-label="Regjistrim i ri" id="fab">＋</button>

  <!-- Pyetje: CSV? -->
  <dialog id="askExport">
    <div class="modal-head"><strong>T’a shkarkoj CSV?</strong></div>
    <div class="modal-body">
      Regjistrimi u ruajt. Tani mund të shkarkoj CSV-në.
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" id="noExport">Jo</button>
      <button class="btn" id="yesExport">Po, shkarko</button>
    </div>
  </dialog>

  <!-- Modal: Përditëso -->
  <dialog id="editModal">
    <div class="modal-head"><strong>Përditëso regjistrimin</strong></div>
    <form id="editForm">
      <div class="modal-body">
        <input type="hidden" id="editId">
        <div class="grid3">
          <div>
            <label for="editAmount">Shuma (ALL)</label>
            <input id="editAmount" inputmode="decimal" required>
          </div>
          <div>
            <label for="editCategory">Kategoria</label>
            <select id="editCategory" required>
              <option>Qira</option>
              <option>Fatura e ujit</option>
              <option>Fatura e energjisë</option>
              <option>Internet</option>
              <option>Blerje ushqimore</option>
              <option>Detergjent rrobash</option>
              <option>Rroba</option>
              <option>Jashtë në restorant</option>
              <option>Shpenzime makine</option>
              <option>Shënim</option>
            </select>
          </div>
          <div>
            <label for="editDate">Data & Ora</label>
            <input id="editDate" type="datetime-local" required>
          </div>
        </div>
        <div style="margin-top:10px">
          <label for="editNote">Shënim</label>
          <textarea id="editNote" placeholder="Opsionale"></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-ghost" id="cancelEdit">Anulo</button>
        <button class="btn" type="submit">Ruaj</button>
      </div>
    </form>
  </dialog>

  <!-- Toast (Rikthe) -->
  <div id="toast" class="toast hide">
    <span>U fshi.</span>
    <button id="undoBtn" class="btn-ghost">Rikthe</button>
  </div>

<!-- Chart.js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function(){
  const LS_KEY = 'andi_expenses_v3';
  const OLD_KEYS = ['andi_expenses_v2','andi_expenses_v1'];
  const $ = s => document.querySelector(s);
  const list = $('#list'), totals = $('#totals'), empty = $('#empty');
  const amount = $('#amount'), category = $('#category'), note = $('#note'), noteRow = $('#noteRow');
  const monthPick = $('#monthPick'), search = $('#search');
  const askExport = $('#askExport'), yesExport = $('#yesExport'), noExport = $('#noExport');
  const editModal = $('#editModal'), editForm = $('#editForm');
  const editId = $('#editId'), editAmount = $('#editAmount'), editCategory = $('#editCategory'), editDate = $('#editDate'), editNote = $('#editNote');
  const toast = $('#toast'), undoBtn = $('#undoBtn');
  const monthSummary = $('#monthSummary');

  const fmt = new Intl.NumberFormat('sq-AL',{style:'currency',currency:'ALL',maximumFractionDigits:2});

  // Gjendja
  let data = load();
  let lastDeleted = null;
  // Muaji i tanishëm
  const now = new Date(); monthPick.value = now.toISOString().slice(0,7);

  // Grafikë
  let chartRange = 'week';
  const ctx = document.getElementById('mainChart').getContext('2d');
  let chart = new Chart(ctx, {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'Shpenzime (ALL)', data: [] }] },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
      scales: { x: { grid: { display:false } }, y: { beginAtZero:true } }
    }
  });

  // Tabs e grafikës
  document.getElementById('chartTabs').addEventListener('click', (e)=>{
    const t = e.target.closest('.tab'); if(!t) return;
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    chartRange = t.dataset.range;
    paintChart();
  });

  // Render i parë
  paintAll();

  // UI
  $('#fab').addEventListener('click', ()=>{ window.scrollTo({top:0,behavior:'smooth'}); amount.focus(); });

  category.addEventListener('change', ()=>{
    noteRow.classList.toggle('hide', category.value !== '__custom');
    if (category.value === '__custom') note.focus();
  });

  $('#entry').addEventListener('submit', (e)=>{
    e.preventDefault();
    const raw = (amount.value||'').replace(',','.');
    const val = Number(raw);
    if(!val || val<=0){ shake(amount); return; }
    let cat = category.value; if(!cat){ shake(category); return; }
    let n = '';
    if(cat==='__custom'){ n=(note.value||'').trim(); if(!n){ shake(note); return; } cat='Shënim'; }
    else { n=(note.value||'').trim(); }

    const entry = { id: rid(), ts: new Date().toISOString(), amount: Number(val.toFixed(2)), currency:'ALL', category: cat, note: n };
    data.push(entry); save();

    amount.value=''; category.value=''; note.value=''; noteRow.classList.add('hide');
    paintAll(); askExport.showModal();
  });

  yesExport.addEventListener('click', ()=>{ askExport.close(); exportCSV(); });
  noExport.addEventListener('click', ()=> askExport.close());

  $('#clearBtn').addEventListener('click', ()=>{
    if(!confirm('T’i fshij të gjitha regjistrimet?')) return;
    data=[]; save(); paintAll();
  });

  $('#exportBtn').addEventListener('click', exportCSV);

  $('#importInput').addEventListener('change', async e=>{
    const f = e.target.files?.[0]; if(!f) return;
    const text = await f.text();
    const rows = parseCSV(text);
    let added=0; const ids=new Set(data.map(d=>d.id));
    for(const r of rows){
      const amt = Number(r.amount);
      if(!r.id || ids.has(r.id) || !r.ts || !amt || !r.currency) continue;
      data.push({ id:r.id, ts:r.ts, amount:amt, currency:r.currency, category:r.category||'Tjetër', note:r.note||'' });
      ids.add(r.id); added++;
    }
    save(); paintAll(); alert(Importi i CSV përfundoi: u shtuan ${added} rreshta.); e.target.value='';
  });

  monthPick.addEventListener('change', paintAll);
  search.addEventListener('input', paintListAndTotals);

  // Veprimet në listë (edit / delete)
  list.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-act]');
    if(!btn) return;
    const id = btn.dataset.id;
    const act = btn.dataset.act;
    const item = data.find(x=>x.id===id);
    if(!item) return;

    if(act==='edit'){ openEdit(item); }
    else if(act==='del'){
      if(!confirm('Ta fshij këtë regjistrim?')) return;
      lastDeleted = {...item};
      data = data.filter(x=>x.id!==id);
      save(); paintAll(); showToast();
    }
  });

  // Modal: Edit
  $('#cancelEdit').addEventListener('click', ()=> editModal.close());
  editForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const id = editId.value;
    const idx = data.findIndex(x=>x.id===id);
    if(idx<0){ editModal.close(); return; }

    const val = Number((editAmount.value||'').replace(',','.'));
    if(!val || val<=0){ shake(editAmount); return; }

    const dt = new Date(editDate.value);
    if(isNaN(dt.getTime())){ shake(editDate); return; }

    data[idx] = {
      ...data[idx],
      amount: Number(val.toFixed(2)),
      category: editCategory.value,
      note: (editNote.value||'').trim(),
      ts: new Date(dt.getTime() - dt.getTimezoneOffset()*60000).toISOString()
    };
    save(); paintAll(); editModal.close();
    askExport.showModal();
  });

  // Toast (undo)
  undoBtn.addEventListener('click', ()=>{
    if(lastDeleted){
      data.push(lastDeleted);
      save(); paintAll();
      hideToast();
      lastDeleted=null;
    }
  });

  // --- RENDER helpers ---
  function paintAll(){
    paintListAndTotals();
    paintMonthSummary();
    paintChart();
  }

  function paintListAndTotals(){
    const month = monthPick.value;
    const [y,m] = month.split('-').map(Number);
    const q = (search.value||'').toLowerCase().trim();

    const filtered = data.filter(d=>{
      const dt = new Date(d.ts);
      const inMonth = dt.getFullYear()===y && (dt.getMonth()+1)===m;
      const inSearch = !q || (String(d.category).toLowerCase().includes(q) || String(d.note).toLowerCase().includes(q));
      return inMonth && inSearch;
    }).sort((a,b)=> new Date(b.ts) - new Date(a.ts));

    empty.classList.toggle('hide', filtered.length>0);
    list.innerHTML=''; totals.innerHTML='';

    const byCat={}; let sum=0;
    for(const d of filtered){
      sum += d.amount; byCat[d.category]=(byCat[d.category]||0)+d.amount;
      const dt = new Date(d.ts);
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `
        <div>
          <div class="top">
            <span class="chip">${esc(d.category)}</span>
            ${d.note?<span class="chip">${esc(d.note)}</span>:''}
          </div>
          <div class="time">${dt.toLocaleString('sq-AL')}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <div class="amt">${fmt.format(d.amount)}</div>
          <div class="actions">
            <button class="act" data-act="edit" data-id="${d.id}">Përditëso</button>
            <button class="act" data-act="del" data-id="${d.id}">Fshi</button>
          </div>
        </div>`;
      list.appendChild(el);
    }

    const totalBox = document.createElement('div');
    totalBox.className='total-box';
    totalBox.innerHTML=<b>Totali i muajit:</b> ${fmt.format(sum)};
    totals.appendChild(totalBox);

    for(const [cat,val] of Object.entries(byCat).sort((a,b)=>b[1]-a[1])){
      const chip = document.createElement('div'); chip.className='total-box';
      chip.textContent = ${cat}: ${fmt.format(val)}; totals.appendChild(chip);
    }
  }

  // Përmbledhje specifike e muajit (market/qira)
  function paintMonthSummary(){
    const month = monthPick.value; const [y,m] = month.split('-').map(Number);
    let market = 0, qira = 0;
    for(const d of data){
      const dt = new Date(d.ts);
      if(dt.getFullYear()===y && (dt.getMonth()+1)===m){
        if(d.category==='Blerje ushqimore') market += d.amount;
        if(d.category==='Qira') qira += d.amount;
      }
    }
    monthSummary.textContent = Këtë muaj: “Blerje ushqimore” ${fmt.format(market)} · “Qira” ${fmt.format(qira)}.;
  }

  // Grafikë (javor/mujor/vjetor)
  function paintChart(){
    const range = chartRange;
    const {labels, values} = buildSeries(range);
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    chart.update();
  }

  function buildSeries(range){
    const now = new Date();
    const labels = [];
    const buckets = [];

    if(range==='week'){
      // e hënë … e diel (7 ditë, java aktuale sipas lokalit)
      const start = startOfWeek(now);
      for(let i=0;i<7;i++){
        const d = new Date(start); d.setDate(start.getDate()+i);
        labels.push(d.toLocaleDateString('sq-AL',{weekday:'short'}));
        buckets.push({from: startOfDay(d), to: endOfDay(d), sum:0});
      }
    } else if(range==='month'){
      // ditët e muajit aktual
      const start = new Date(now.getFullYear(), now.getMonth(), 1);
      const end = new Date(now.getFullYear(), now.getMonth()+1, 0);
      const days = end.getDate();
      for(let i=1;i<=days;i++){
        const d = new Date(now.getFullYear(), now.getMonth(), i);
        labels.push(String(i));
        buckets.push({from: startOfDay(d), to: endOfDay(d), sum:0});
      }
    } else {
      // muajt e vitit aktual
      for(let i=0;i<12;i++){
        const d = new Date(now.getFullYear(), i, 1);
        labels.push(d.toLocaleDateString('sq-AL',{month:'short'}));
        const from = new Date(now.getFullYear(), i, 1);
        const to = new Date(now.getFullYear(), i+1, 0, 23,59,59,999);
        buckets.push({from, to, sum:0});
      }
    }

    // mbush me të dhënat
    for(const rec of data){
      const t = new Date(rec.ts);
      for(const b of buckets){
        if(t>=b.from && t<=b.to){ b.sum += rec.amount; break; }
      }
    }

    return { labels, values: buckets.map(b=>Number(b.sum.toFixed(2))) };
  }

  // Edit modal
  function openEdit(item){
    editId.value = item.id;
    editAmount.value = String(item.amount);
    editCategory.value = item.category;
    editNote.value = item.note || '';
    const d = new Date(item.ts);
    const local = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,16);
    editDate.value = local;
    editModal.showModal();
  }

  // Toast
  let toastTimer=null;
  function showToast(){ toast.classList.remove('hide'); clearTimeout(toastTimer); toastTimer=setTimeout(hideToast,6000); }
  function hideToast(){ toast.classList.add('hide'); clearTimeout(toastTimer); }

  // Persistencë
  function load(){
    try{
      const cur = localStorage.getItem(LS_KEY);
      if(cur) return JSON.parse(cur) || [];
      for(const k of OLD_KEYS){
        const old = localStorage.getItem(k);
        if(old){ localStorage.setItem(LS_KEY, old); return JSON.parse(old)||[]; }
      }
      return [];
    }catch{ return []; }
  }
  function save(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(data)); }catch{} }

  // CSV
  function exportCSV(){
    const header = ['id','ts','amount','currency','category','note'];
    const rows = [header.join(',')];
    for(const d of data){ rows.push([d.id,d.ts,d.amount,d.currency,d.category||'',d.note||''].map(csvEsc).join(',')); }
    const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.download = ANDI_Shpnezime_${new Date().toISOString().slice(0,10)}.csv;
    a.href = URL.createObjectURL(blob); document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0);
  }

  function parseCSV(text){
    const lines=text.replace(/\r/g,'').split('\n').filter(Boolean); if(!lines.length) return [];
    const header=splitCSV(lines[0]); const idx=n=>header.indexOf(n); const out=[];
    for(let i=1;i<lines.length;i++){ const c=splitCSV(lines[i]);
      out.push({ id:c[idx('id')], ts:c[idx('ts')], amount:c[idx('amount')], currency:c[idx('currency')], category:c[idx('category')], note:c[idx('note')] });
    } return out;
  }
  function splitCSV(line){
    const res=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='\"'){ if(q && line[i+1]==='\"'){cur+='\"'; i++;} else q=!q; }
      else if(ch===',' && !q){ res.push(cur); cur=''; }
      else cur+=ch;
    }
    res.push(cur); return res;
  }
  function csvEsc(v){ const s=String(v??''); return /[",\n]/.test(s)?"${s.replace(/"/g,'""')}":s; }

  // Utils kohe
  function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0); }
  function endOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999); }
  function startOfWeek(d){
    // Java fillon të hënën (ISO)
    const day = (d.getDay()+6)%7; // 0=hënë
    const r = new Date(d); r.setDate(d.getDate()-day); r.setHours(0,0,0,0); return r;
  }

  // Utils të tjera
  function rid(){ if(window.crypto?.getRandomValues){ const a=new Uint8Array(16); crypto.getRandomValues(a); return Array.from(a).map(x=>x.toString(16).padStart(2,'0')).join(''); } return 'id-'+Math.random().toString(36).slice(2); }
  function esc(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function shake(el){ el.style.transition='transform .08s'; el.style.transform='translateX(3px)'; setTimeout(()=>el.style.transform='translateX(-3px)',80); setTimeout(()=>el.style.transform='',160); el.focus(); }
})();
</script>
</body>
</html>
