<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ANDI ¬∑ Shpenzimet</title>
<meta name="theme-color" content="#ffffff">
<style>
  :root{
    /* iOS a√ßƒ±k tema */
    --bg:#f7f8fb; --card:#ffffff; --text:#0e1726; --muted:#6b778c; --stroke:#e6ebf3;
    --accent:#18c28e; --accent2:#38d89d; --danger:#e34b4b; --link:#1a73e8;
    --radius:16px; --shadow:0 10px 24px rgba(13,38,76,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Inter,system-ui,sans-serif}
  .wrap{max-width:920px;margin:auto;padding:16px 14px 112px}
  h1{font-size:20px;margin:8px 0 14px}
  /* Kart */
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-top:14px}
  .card h3{margin:0 0 10px;font-size:16px}
  label{font-size:13px;color:var(--muted)}
  input,select,textarea,button{
    width:100%;background:#fff;border:1px solid var(--stroke);color:var(--text);
    padding:12px 12px;border-radius:12px;font-size:15px;outline:none;
  }
  input::placeholder,textarea::placeholder{color:#9aa7bd}
  textarea{min-height:72px;resize:vertical}
  .grid2{display:grid;gap:10px}
  @media(min-width:640px){.grid2{grid-template-columns:1fr 1fr}}
  .btn{background:var(--accent);border:1px solid #0e9e76;color:#fff;font-weight:700;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn-ghost{background:#fff;border:1px dashed var(--stroke);color:var(--text);cursor:pointer}
  .btn-danger{background:var(--danger);border:1px solid #b13131;color:#fff}
  .muted{color:var(--muted)}
  .hide{display:none!important}

  /* iOS sekme (Shpenzime √ºst√º) */
  .seg{
    display:flex;gap:8px;overflow:auto;padding:6px;border:1px solid var(--stroke);
    border-radius:999px;background:#f3f6fb
  }
  .seg button{
    flex:0 0 auto;border:none;background:#fff;border:1px solid var(--stroke);color:#3a4a62;
    padding:8px 14px;border-radius:999px;cursor:pointer;font-weight:600
  }
  .seg button.active{background:#111; color:#fff; border-color:#111}

  /* Chip/pill */
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{background:#f3f6fb;border:1px solid var(--stroke);border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer;display:inline-flex;gap:6px;align-items:center}
  .chip:hover{border-color:#c9d4e7}

  /* Liste (iOS) */
  .list{display:grid;gap:10px}
  .item{display:grid;grid-template-columns:auto 1fr auto;gap:12px;padding:12px;border:1px solid var(--stroke);border-radius:14px;background:var(--card);box-shadow:var(--shadow)}
  .dateBadge{display:flex;flex-direction:column;align-items:center;justify-content:center;width:52px;border-right:1px dashed var(--stroke);padding-right:8px}
  .day{font-weight:800;font-size:20px}
  .dow{font-size:11px;color:var(--muted)}
  .cat{font-weight:700}
  .note{font-size:12px;color:var(--muted)}
  .time{font-size:12px;color:#8a94a8;margin-top:2px}
  .amt{font-weight:800;color:var(--danger)}
  .actions{display:flex;gap:8px; margin-top:6px}
  .totals{display:flex;gap:8px;flex-wrap:wrap}
  .total-box{background:#f3f6fb;border:1px solid var(--stroke);border-radius:10px;padding:8px 10px;font-size:13px}

  /* Alt men√º */
  .nav{position:fixed;left:0;right:0;bottom:0;background:#fffcc;backdrop-filter:saturate(150%) blur(10px);
       border-top:1px solid var(--stroke);display:grid;grid-template-columns:repeat(3,1fr);z-index:10;background:#ffffffee}
  .nav a{padding:10px 6px;display:flex;flex-direction:column;align-items:center;gap:4px;color:#6a768c;text-decoration:none;font-size:12px}
  .nav a .ico{font-size:18px}
  .nav a.active{color:#e24444}
  .screen{display:none} .screen.active{display:block}

  /* Dialog */
  dialog{border:none;border-radius:16px;background:#fff;color:var(--text);box-shadow:0 20px 60px rgba(0,0,0,.25);width:min(92vw,560px);padding:0}
  dialog::backdrop{background:rgba(0,0,0,.45)}
  .modal-head{padding:12px 14px;border-bottom:1px solid var(--stroke);font-weight:700}
  .modal-body{padding:14px}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:0 14px 14px}

  /* Calendar grid (hafif) */
  .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px}
  .cal .cell{background:#fff;border:1px solid var(--stroke);border-radius:12px;padding:8px;text-align:right;min-height:72px;position:relative}
  .cal .cell .d{position:absolute;left:8px;top:6px;font-weight:700;color:#5a657a}
  .cal .cell .s{font-size:12px;color:#e24444}
  canvas{max-width:100%}
</style>
</head>
<body>
  <div class="wrap">
    <h1 id="appTitle">ANDI ¬∑ Shpenzimet</h1>

    <!-- === KRYEFAQJA === -->
    <section class="screen active" id="screen-home">
      <div class="card">
        <h3>Shtim shum√´ i shpejt√´</h3>
        <form id="quickForm" autocomplete="off">
          <label for="quickAmount" class="muted">Shuma (Lek√´)</label>
          <input id="quickAmount" type="number" inputmode="decimal" step="0.01" placeholder="p.sh. 1200" autocomplete="off">
          <div class="grid2" style="margin-top:8px">
            <button id="quickGo" class="btn" type="submit" disabled>Vazhdo</button>
            <span class="muted" style="display:grid;align-items:center">Pastaj: zgjidh kategorin√´ ose shkruaj sh√´nim</span>
          </div>
        </form>
        <div id="suggestBox" class="chips hide"></div>
      </div>

      <div class="card">
        <h3>P√´rmbledhje e muajit</h3>
        <div id="monthLine" class="muted">‚Äì</div>
        <div class="totals" id="homeTotals" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- === SHPENZIME === -->
    <section class="screen" id="screen-expenses">
      <div class="card">
        <h3>Transaksione</h3>
        <div class="seg" id="expTabs" style="margin-bottom:8px">
          <button data-view="daily"   class="active">Ditore</button>
          <button data-view="calendar">Kalendar</button>
          <button data-view="weekly">Javore</button>
          <button data-view="monthly">Mujore</button>
          <button data-view="summary">P√´rmbledhje</button>
        </div>
        <div class="grid2" style="margin-bottom:8px">
          <input id="monthPick" type="month">
          <input id="search" placeholder="Filtro sipas kategorie/sh√´nimi‚Ä¶">
        </div>

        <!-- DAILY/LIST -->
        <div id="view-daily">
          <div id="empty" class="muted">Ende nuk ka t√´ dh√´na.</div>
          <div class="list" id="list"></div>
          <div class="totals" id="totals"></div>
        </div>

        <!-- CALENDAR -->
        <div id="view-calendar" class="hide">
          <div id="calBox" class="cal"></div>
        </div>

        <!-- WEEKLY -->
        <div id="view-weekly" class="hide">
          <div class="list" id="weekList"></div>
        </div>

        <!-- MONTHLY (totals by category) -->
        <div id="view-monthly" class="hide">
          <div class="totals" id="mTotals"></div>
        </div>

        <!-- SUMMARY (donut) -->
        <div id="view-summary" class="hide">
          <canvas id="sumPie" width="600" height="360"></canvas>
          <div class="totals" id="sumLegend" style="margin-top:8px"></div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <button class="btn" id="exportBtn">Shkarko CSV</button>
          <label class="btn-ghost" style="display:grid;place-items:center;cursor:pointer">Ngarko CSV
            <input id="importInput" type="file" accept=".csv,text/csv" style="display:none">
          </label>
        </div>
        <button class="btn-ghost" id="clearAll" style="margin-top:8px">Pastro t√´ gjitha</button>
      </div>
    </section>

    <!-- === RREGULLIME === -->
    <section class="screen" id="screen-settings">
      <div class="card">
        <h3>Rregullime</h3>
        <div class="grid2">
          <div>
            <label for="setTitle">Titulli</label>
            <input id="setTitle" placeholder="ANDI ¬∑ Shpenzimet">
          </div>
          <div>
            <label for="accent">Ngjyra kryesore</label>
            <input id="accent" type="color" value="#18c28e">
          </div>
        </div>
        <div style="margin-top:8px">
          <label for="categoriesBox">Kategori (nj√´ p√´r rresht)</label>
          <textarea id="categoriesBox">Qira
Fatura e ujit
Fatura e energjis√´
Internet
Blerje ushqimore
Detergjent rrobash
Rroba
Jasht√´ n√´ restorant
Shpenzime makine
Sh√´nim i lir√´</textarea>
        </div>
        <div class="grid2" style="margin-top:8px">
          <button class="btn" id="apply">Zbato</button>
          <button class="btn-ghost" id="downloadHTML">Shkarko HTML</button>
        </div>
      </div>
    </section>
  </div>

  <!-- NAV -->
  <nav class="nav" id="nav">
    <a href="#home" data-target="screen-home" class="active"><span class="ico">üè†</span>Kryefaqja</a>
    <a href="#exp" data-target="screen-expenses"><span class="ico">üìã</span>Shpenzime</a>
    <a href="#set" data-target="screen-settings"><span class="ico">‚öôÔ∏è</span>Rregullime</a>
  </nav>

  <!-- Kategori se√ßici -->
  <dialog id="pickDlg">
    <div class="modal-head">Zgjidh kategorin√´</div>
    <div class="modal-body">
      <div id="cats" class="chips"></div>
      <div style="margin-top:10px">
        <label for="pickNote" class="muted">Sh√´nim (opsionale)</label>
        <textarea id="pickNote" placeholder="p.sh. ‚ÄòMarket‚Äô, ‚ÄòRestorant te ‚Ä¶‚Äô"></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" id="pickCancel">Anulo</button>
      <button class="btn" id="pickSave">Ruaj</button>
    </div>
  </dialog>

  <!-- Editim -->
  <dialog id="editDlg">
    <div class="modal-head">P√´rdit√´so</div>
    <form id="editForm">
      <div class="modal-body">
        <input type="hidden" id="editId">
        <div class="grid2">
          <div>
            <label>Shuma (ALL)</label>
            <input id="editAmount" inputmode="decimal" required>
          </div>
          <div>
            <label>Kategoria</label>
            <select id="editCategory" required></select>
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Data & Ora</label>
          <input id="editDate" type="datetime-local" required>
        </div>
        <div style="margin-top:8px">
          <label>Sh√´nim</label>
          <textarea id="editNote"></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-ghost" type="button" id="editCancel">Anulo</button>
        <button class="btn" type="submit">Ruaj</button>
      </div>
    </form>
  </dialog>

  <!-- CSV sorusu -->
  <dialog id="askExport">
    <div class="modal-head">Ta shkarkoj CSV?</div>
    <div class="modal-body">Regjistrimi u ruajt. Tani mund t√´ shkarkosh CSV.</div>
    <div class="modal-actions">
      <button class="btn-ghost" id="noExport">Jo</button>
      <button class="btn" id="yesExport">Po, shkarko</button>
    </div>
  </dialog>

<script>
(function(){
  const LS_DATA='andi_ioslook_data_v1';
  const LS_CFG='andi_ioslook_cfg_v1';
  const LS_LAST='andi_ioslook_last_cat';
  const $=s=>document.querySelector(s);

  // --- State ---
  let data = loadJSON(LS_DATA, []);
  let cfg  = loadJSON(LS_CFG, {
    title:'ANDI ¬∑ Shpenzimet',
    accent:'#18c28e',
    categories:['Qira','Fatura e ujit','Fatura e energjis√´','Internet','Blerje ushqimore','Detergjent rrobash','Rroba','Jasht√´ n√´ restorant','Shpenzime makine','Sh√´nim i lir√´']
  });
  let lastUsedCat = loadJSON(LS_LAST, null);
  let expView='daily'; // daily | calendar | weekly | monthly | summary

  // Elements
  const appTitle=$('#appTitle'); const nav=$('#nav');
  const quickForm=$('#quickForm'), quickAmount=$('#quickAmount'), quickGo=$('#quickGo');
  const pickDlg=$('#pickDlg'), catsBox=$('#cats'), pickNote=$('#pickNote');
  const askExport=$('#askExport'), yesExport=$('#yesExport'), noExport=$('#noExport');
  const suggestBox=$('#suggestBox');
  const monthPick=$('#monthPick'), search=$('#search');
  const list=$('#list'), totals=$('#totals'), empty=$('#empty');
  const weekList=$('#weekList'), mTotals=$('#mTotals'), calBox=$('#calBox');
  const sumPie=$('#sumPie'), sumLegend=$('#sumLegend');
  const editDlg=$('#editDlg'), editId=$('#editId'), editAmount=$('#editAmount'), editCategory=$('#editCategory'), editDate=$('#editDate'), editNote=$('#editNote');

  const expTabs=$('#expTabs');
  expTabs.addEventListener('click',(e)=>{
    const b=e.target.closest('button'); if(!b) return;
    expView=b.dataset.view; expTabs.querySelectorAll('button').forEach(x=>x.classList.remove('active')); b.classList.add('active');
    ['daily','calendar','weekly','monthly','summary'].forEach(v=>$('#view-'+v).classList.toggle('hide', v!==expView));
    paintView();
  });

  // init UI
  appTitle.textContent=cfg.title; document.documentElement.style.setProperty('--accent', cfg.accent);
  const today=new Date(); monthPick.value=today.toISOString().slice(0,7);

  // NAV
  nav.addEventListener('click', (e)=>{
    const a=e.target.closest('a'); if(!a) return; e.preventDefault();
    document.querySelectorAll('.nav a').forEach(x=>x.classList.remove('active')); a.classList.add('active');
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById(a.dataset.target).classList.add('active');
    if(a.dataset.target==='screen-home') paintHome();
    if(a.dataset.target==='screen-expenses') paintView();
  });

  // QUICK ADD
  function parseAmount(v){ return Number(String(v||'').replace(',','.')); }
  function isValidAmount(v){ const n=parseAmount(v); return Number.isFinite(n) && n>0; }
  quickForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const val=parseAmount(quickAmount.value); if(!isValidAmount(val)){ shake(quickAmount); return; }
    openPicker(val);
  });
  quickAmount.addEventListener('input', ()=>{ quickGo.disabled=!isValidAmount(quickAmount.value); });

  function openPicker(val){
    catsBox.innerHTML='';
    cfg.categories.forEach(c=>{
      const chip=document.createElement('button'); chip.type='button'; chip.className='chip';
      chip.innerHTML=<span>${iconFor(c)}</span><span>${c}</span>;
      chip.onclick=()=>{ catsBox.querySelectorAll('.chip').forEach(x=>x.classList.remove('sel')); chip.classList.add('sel'); };
      catsBox.appendChild(chip);
    });
    pickNote.value=''; pickDlg.dataset.amount=String(val); pickDlg.showModal();
  }
  $('#pickCancel').onclick=()=>pickDlg.close();
  $('#pickSave').onclick=()=>{
    const val=parseAmount(pickDlg.dataset.amount||'0'); if(!isValidAmount(val)) return;
    const sel=catsBox.querySelector('.chip.sel'); let cat= sel?sel.textContent.trim():''; let note=(pickNote.value||'').trim();
    if(!cat && !note){ alert('Zgjidh kategori ose shkruaj sh√´nim'); return; }
    if(/sh√´nim/i.test(cat)) cat='Sh√´nim';
    addRecord(val, cat||'Sh√´nim', note);
    pickDlg.close();
  };

  function addRecord(amount, category, note){
    const rec={id:rid(), ts:new Date().toISOString(), amount:Number(amount.toFixed(2)), currency:'ALL', category, note:note||''};
    data.push(rec); saveJSON(LS_DATA,data);
    lastUsedCat=category; saveJSON(LS_LAST,lastUsedCat);
    quickAmount.value=''; quickGo.disabled=true;
    paintHome(); paintView();
    askExport.showModal();
  }

  yesExport.addEventListener('click', ()=>{ askExport.close(); exportCSV(); });
  noExport.addEventListener('click', ()=> askExport.close());

  // LISTENERS
  monthPick.addEventListener('change', paintView);
  search.addEventListener('input', paintView);

  // EDIT
  list.addEventListener('click', onRowAction);
  weekList.addEventListener('click', onRowAction);
  function onRowAction(e){
    const btn=e.target.closest('[data-act]'); if(!btn) return;
    const id=btn.dataset.id, act=btn.dataset.act;
    const it=data.find(x=>x.id===id); if(!it) return;
    if(act==='del'){ if(!confirm('Ta fshij k√´t√´ rresht?')) return;
      data=data.filter(x=>x.id!==id); saveJSON(LS_DATA,data); paintHome(); paintView();
    } else if(act==='edit'){ openEdit(it); }
  }

  $('#editCancel').addEventListener('click', ()=> editDlg.close());
  $('#editForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const idx=data.findIndex(x=>x.id===editId.value); if(idx<0){ editDlg.close(); return; }
    const val=parseAmount(editAmount.value); if(!isValidAmount(val)){ shake(editAmount); return; }
    const dt=new Date(editDate.value); if(isNaN(dt.getTime())){ shake(editDate); return; }
    data[idx]={...data[idx], amount:Number(val.toFixed(2)), category:editCategory.value, note:(editNote.value||'').trim(),
      ts:new Date(dt.getTime()-dt.getTimezoneOffset()*60000).toISOString()};
    saveJSON(LS_DATA,data); paintHome(); paintView(); editDlg.close(); alert('U p√´rdit√´sua!');
  });

  function openEdit(item){
    editId.value=item.id; editAmount.value=String(item.amount); editNote.value=item.note||'';
    editCategory.innerHTML=''; cfg.categories.forEach(c=>editCategory.appendChild(new Option(/sh√´nim/i.test(c)?'Sh√´nim':c,/sh√´nim/i.test(c)?'Sh√´nim':c)));
    editCategory.value=/sh√´nim/i.test(item.category)?'Sh√´nim':item.category;
    const dt=new Date(item.ts); editDate.value=new Date(dt.getTime()-dt.getTimezoneOffset()*60000).toISOString().slice(0,16);
    editDlg.showModal();
  }

  // HOME
  function paintHome(){
    const [y,m]=(monthPick.value||new Date().toISOString().slice(0,7)).split('-').map(Number);
    const fmt=money(); let market=0, rent=0;
    for(const d of data){ const t=new Date(d.ts);
      if(t.getFullYear()===y && (t.getMonth()+1)===m){ if(/blerje\s+ushq/i.test(d.category)) market+=d.amount; if(/qira/i.test(d.category)) rent+=d.amount; }
    }
    $('#monthLine').textContent=K√´t√´ muaj: ‚ÄúBlerje ushqimore‚Äù ${fmt(market)} ¬∑ ‚ÄúQira‚Äù ${fmt(rent)}.;
    const byCat=groupByMonth(y,m);
    const top=[...Object.entries(byCat)].sort((a,b)=>b[1]-a[1]).slice(0,3);
    const homeTotals=$('#homeTotals'); homeTotals.innerHTML='';
    Object.entries(byCat).length===0
      ? homeTotals.innerHTML='<span class="muted">S‚Äôka t√´ dh√´na p√´r muajin.</span>'
      : top.forEach(([k,v])=>{ const d=document.createElement('div'); d.className='total-box'; d.textContent=${k}: ${fmt(v)}; homeTotals.appendChild(d); });
    paintSuggestions();
  }
  function paintSuggestions(){
    const stats=countByCategoryThisMonth();
    const popular=[...Object.entries(stats)].sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k])=>k);
    const candidates=[lastUsedCat, ...popular].filter(Boolean);
    suggestBox.innerHTML='';
    if(candidates.length===0){ suggestBox.classList.add('hide'); return; }
    candidates.forEach(c=>{
      const b=document.createElement('button'); b.className='chip'; b.type='button'; b.innerHTML=<span>${iconFor(c)}</span><span>${c}</span>;
      b.onclick=()=>{ const v=parseAmount(quickAmount.value); if(isValidAmount(v)) addRecord(v,c,''); else quickAmount.focus(); };
      suggestBox.appendChild(b);
    });
    const free=document.createElement('button'); free.className='chip'; free.type='button'; free.innerHTML=<span>üìù</span><span>Sh√´nim i lir√´</span>;
    free.onclick=()=>{ const v=parseAmount(quickAmount.value); if(isValidAmount(v)) openPicker(v); else quickAmount.focus(); };
    suggestBox.appendChild(free);
    suggestBox.classList.remove('hide');
  }

  // VIEWS
  function paintView(){
    if(expView==='daily') paintList();
    else if(expView==='weekly') paintWeekly();
    else if(expView==='monthly') paintMonthly();
    else if(expView==='calendar') paintCalendar();
    else if(expView==='summary') paintSummary();
  }

  function paintList(){
    const [y,m]=monthPick.value.split('-').map(Number);
    const q=(search.value||'').toLowerCase().trim();
    const rows=data.filter(d=>{
      const t=new Date(d.ts);
      const inMonth=t.getFullYear()===y && (t.getMonth()+1)===m;
      const inSearch=!q || (String(d.category).toLowerCase().includes(q) || String(d.note).toLowerCase().includes(q));
      return inMonth && inSearch;
    }).sort((a,b)=> new Date(b.ts)-new Date(a.ts));

    empty.classList.toggle('hide', rows.length>0);
    list.innerHTML=''; totals.innerHTML='';
    const fmt=money(); const byCat={}; let sum=0;
    for(const d of rows){
      sum+=d.amount; byCat[d.category]=(byCat[d.category]||0)+d.amount;
      const t=new Date(d.ts); const day=t.getDate(); const dow=t.toLocaleDateString('sq-AL',{weekday:'short'});
      const el=document.createElement('div'); el.className='item';
      el.innerHTML=`
        <div class="dateBadge"><div class="day">${String(day).padStart(2,'0')}</div><div class="dow">${dow}</div></div>
        <div>
          <div class="cat">${iconFor(d.category)} ${esc(d.category)}</div>
          ${d.note?<div class="note">${esc(d.note)}</div>:''}
          <div class="time">${t.toLocaleTimeString('sq-AL',{hour:'2-digit',minute:'2-digit'})}</div>
          <div class="actions">
            <button class="btn-ghost" data-act="edit" data-id="${d.id}">Ndrysho</button>
            <button class="btn-danger" data-act="del" data-id="${d.id}">Fshi</button>
          </div>
        </div>
        <div class="amt">${fmt(d.amount)}</div>`;
      list.appendChild(el);
    }
    const total=document.createElement('div'); total.className='total-box'; total.innerHTML=<b>Totali i muajit:</b> ${fmt(sum)}; totals.appendChild(total);
    Object.entries(byCat).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{ const b=document.createElement('div'); b.className='total-box'; b.textContent=${k}: ${fmt(v)}; totals.appendChild(b); });
  }

  function paintWeekly(){
    const [y,m]=monthPick.value.split('-').map(Number);
    const rows=data.filter(d=>{const t=new Date(d.ts); return t.getFullYear()===y && (t.getMonth()+1)===m;});
    const map={}; rows.forEach(r=>{ const w=weekOf(r.ts); map[w]=(map[w]||0)+r.amount; });
    weekList.innerHTML='';
    const fmt=money();
    Object.entries(map).sort((a,b)=>a[0]-b[0]).forEach(([w,total])=>{
      const el=document.createElement('div'); el.className='item';
      el.innerHTML=`<div class="dateBadge"><div class="day">W${w}</div><div class="dow">jav√´</div></div>
        <div><div class="cat">Totali i jav√´s</div></div>
        <div class="amt">${fmt(total)}</div>`;
      weekList.appendChild(el);
    });
    if(!Object.keys(map).length) weekList.innerHTML='<div class="muted">S‚Äôka t√´ dh√´na p√´r k√´t√´ muaj.</div>';
  }

  function paintMonthly(){
    const [y,m]=monthPick.value.split('-').map(Number);
    const byCat=groupByMonth(y,m); const fmt=money();
    mTotals.innerHTML='';
    if(!Object.keys(byCat).length){ mTotals.innerHTML='<span class="muted">S‚Äôka t√´ dh√´na.</span>'; return; }
    Object.entries(byCat).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{
      const el=document.createElement('div'); el.className='total-box'; el.textContent=${k}: ${fmt(v)}; mTotals.appendChild(el);
    });
  }

  function paintCalendar(){
    const [y,m]=monthPick.value.split('-').map(Number);
    const first=new Date(y,m-1,1), last=new Date(y,m,0), days=last.getDate();
    const sums=perDay(y,m);
    calBox.innerHTML='';
    // header row not needed; keep minimal
    for(let d=1; d<=days; d++){
      const el=document.createElement('div'); el.className='cell';
      el.innerHTML=<div class="d">${d}</div><div class="s">${sums[d]?money()(sums[d]):''}</div>;
      calBox.appendChild(el);
    }
  }

  function paintSummary(){
    const [y,m]=monthPick.value.split('-').map(Number);
    const byCat=groupByMonth(y,m); const total=Object.values(byCat).reduce((a,b)=>a+b,0);
    // donut
    const ctx=sumPie.getContext('2d'); const W=sumPie.width, H=sumPie.height; ctx.clearRect(0,0,W,H);
    const colors=['#ff6b6b','#f8c343','#6ecb63','#3da5d9','#9b59b6','#fd9644','#20bf6b','#3867d6','#d1a3ff','#ff8f87'];
    let start=-Math.PI/2, i=0;
    Object.entries(byCat).forEach(([k,v])=>{
      const ang=(v/total)*Math.PI*2; ctx.beginPath(); ctx.moveTo(W/2,H/2); ctx.arc(W/2,H/2,140,start,start+ang); ctx.closePath(); ctx.fillStyle=colors[i%colors.length]; ctx.fill(); start+=ang; i++;
    });
    // hole
    ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(W/2,H/2,85,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over';
    // legend
    sumLegend.innerHTML='';
    i=0; const fmt=money();
    Object.entries(byCat).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{
      const box=document.createElement('div'); box.className='total-box';
      box.style.borderColor=colors[i%colors.length]; box.style.background='#fff';
      box.innerHTML=<b style="color:${colors[i%colors.length]}">‚óè</b> ${k}: ${fmt(v)} (${((v/total)*100).toFixed(1)}%);
      sumLegend.appendChild(box); i++;
    });
    if(total===0){ ctx.clearRect(0,0,W,H); sumLegend.innerHTML='<span class="muted">S‚Äôka t√´ dh√´na.</span>'; }
  }

  // helpers
  function groupByMonth(y,m){ const out={}; for(const d of data){ const t=new Date(d.ts); if(t.getFullYear()===y && (t.getMonth()+1)===m) out[d.category]=(out[d.category]||0)+d.amount; } return out; }
  function perDay(y,m){ const out={}; for(const d of data){ const t=new Date(d.ts); if(t.getFullYear()===y && (t.getMonth()+1)===m){ const dd=t.getDate(); out[dd]=(out[dd]||0)+d.amount; }} return out; }
  function countByCategoryThisMonth(){ const [y,m]=(monthPick.value||new Date().toISOString().slice(0,7)).split('-').map(Number); return groupByMonth(y,m); }
  function weekOf(ts){ const d=new Date(ts); const first=new Date(d.getFullYear(), d.getMonth(), 1); const day=(d.getDate()+first.getDay()-1); return Math.floor(day/7)+1; }
  function iconFor(cat){ const s=(cat||'').toLowerCase(); if(s.includes('qira'))return'üè†'; if(s.includes('ujit'))return'üö∞'; if(s.includes('energ'))return'‚ö°'; if(s.includes('internet'))return'üåê'; if(s.includes('blerje')||s.includes('ushq'))return'üõí'; if(s.includes('detergjent'))return'üß∫'; if(s.includes('rroba'))return'üëï'; if(s.includes('restorant'))return'üçΩÔ∏è'; if(s.includes('makin'))return'üöó'; if(s.includes('sh√´nim'))return'üìù'; return 'üí∏'; }
  function money(){ const nf=new Intl.NumberFormat('sq-AL',{style:'currency',currency:'ALL',maximumFractionDigits:2}); return v=>nf.format(v); }
  function rid(){ if(window.crypto?.getRandomValues){const a=new Uint8Array(16); crypto.getRandomValues(a); return Array.from(a).map(x=>x.toString(16).padStart(2,'0')).join(''); } return 'id-'+Math.random().toString(36).slice(2); }
  function loadJSON(k,fb){ try{const r=localStorage.getItem(k); return r?JSON.parse(r):fb}catch{ return fb } }
  function saveJSON(k,v){ try{localStorage.setItem(k,JSON.stringify(v));}catch{} }
  function esc(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function csvEsc(v){ const s=String(v??''); return /[",\n]/.test(s)?"${s.replace(/"/g,'""')}":s; }
  function splitCSV(line){ const res=[]; let cur=''; let q=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='\"'){ if(q && line[i+1]==='\"'){cur+='\"'; i++;} else q=!q; } else if(ch===',' && !q){ res.push(cur); cur=''; } else cur+=ch; } res.push(cur); return res; }
  function parseCSV(text){ const lines=text.replace(/\r/g,'').split('\n').filter(Boolean); if(!lines.length) return []; const header=splitCSV(lines[0]); const idx=n=>header.indexOf(n); const out=[]; for(let i=1;i<lines.length;i++){ const c=splitCSV(lines[i]); out.push({ id:c[idx('id')], ts:c[idx('ts')], amount:c[idx('amount')], currency:c[idx('currency')], category:c[idx('category')], note:c[idx('note')] }); } return out; }
  function exportCSV(){ const rows=[['id','ts','amount','currency','category','note'].join(',')]; for(const d of data){ rows.push([d.id,d.ts,d.amount,d.currency,d.category||'',d.note||''].map(csvEsc).join(',')); } const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'}); dl(blob,ANDI_Shpnezime_${new Date().toISOString().slice(0,10)}.csv); }
  function dl(blob, name){ const a=document.createElement('a'); a.download=name; a.href=URL.createObjectURL(blob); document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); }
  function shake(el){ el.style.transition='transform .08s'; el.style.transform='translateX(3px)'; setTimeout(()=>el.style.transform='translateX(-3px)',80); setTimeout(()=>el.style.transform='',160); el.focus(); }
})();
</script>
</body>
</html>
