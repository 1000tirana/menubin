<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ANDI ¬∑ Shpenzimet e Sht√´pis√´</title>
<meta name="theme-color" content="#19c28e">
<style>
  :root{
    --bg:#0f1219; --card:#171b25; --text:#e9eef7; --muted:#98a3b7; --stroke:#242a36;
    --accent:#19c28e; --accent2:#3ddc97; --danger:#ff6b6b;
    --radius:12px; --shadow:0 6px 18px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0c0f15 0%,var(--bg) 100%);color:var(--text);
       font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans",sans-serif;}
  .wrap{max-width:900px;margin:auto;padding:16px 14px 90px}
  h1{font-size:20px;margin:6px 0 14px}

  .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-top:14px}
  .card h3{margin:0 0 10px;font-size:16px}
  label{font-size:13px;color:var(--muted)}
  input,select,textarea,button{
    width:100%;background:#0f1422;border:1px solid var(--stroke);color:var(--text);
    padding:10px 12px;border-radius:10px;font-size:15px;outline:none;
  }
  input::placeholder,textarea::placeholder{color:#6e7a90}
  textarea{min-height:72px;resize:vertical}
  .grid2{display:grid;gap:10px}
  @media(min-width:620px){.grid2{grid-template-columns:1fr 1fr}}
  .btn{background:linear-gradient(180deg,var(--accent) 0%,var(--accent2) 100%);border:1px solid #1a6e58;color:#062a20;font-weight:700;cursor:pointer}
  .btn-ghost{background:transparent;border:1px dashed var(--stroke);color:var(--text);cursor:pointer}
  .btn-danger{background:linear-gradient(180deg,#ffb3b3 0%,var(--danger) 100%);border:1px solid #7b2c2c;color:#2a0b0b}
  .muted{color:var(--muted)} .hide{display:none!important}

  .list{display:grid;gap:10px}
  .item{display:grid;grid-template-columns:1fr auto;gap:10px;padding:10px;border:1px solid var(--stroke);border-radius:10px;background:#0f1422}
  .top{display:flex;gap:6px;flex-wrap:wrap}
  .chip{background:#151c2b;border:1px solid var(--stroke);border-radius:999px;padding:6px 10px;font-size:12px}
  .amt{font-weight:800}
  .time{font-size:12px;color:#8895ad}
  .actions{display:flex;gap:8px}
  .totals{display:flex;gap:8px;flex-wrap:wrap}
  .total-box{background:#0f1422;border:1px solid var(--stroke);border-radius:10px;padding:8px 10px;font-size:13px}

  /* Bottom Nav (3 buton) */
  .nav{
    position:fixed;left:0;right:0;bottom:0;background:#0f1422cc;backdrop-filter:blur(6px);
    border-top:1px solid var(--stroke);display:grid;grid-template-columns:repeat(3,1fr);z-index:10
  }
  .nav a{padding:10px 6px;display:flex;flex-direction:column;align-items:center;gap:4px;
    color:#c1cadb;text-decoration:none;font-size:12px}
  .nav a .ico{font-size:18px}
  .nav a.active{color:#0a2f24;background:linear-gradient(180deg,var(--accent) 0%,var(--accent2) 100%)}

  .screen{display:none} .screen.active{display:block}

  dialog{border:none;border-radius:12px;background:#121826;color:var(--text);box-shadow:var(--shadow);
    width:min(92vw,560px);padding:0}
  dialog::backdrop{background:rgba(0,0,0,.45)}
  .modal-head{padding:12px 14px;border-bottom:1px solid var(--stroke);font-weight:700}
  .modal-body{padding:14px}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:0 14px 14px}

  .cats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  @media(min-width:640px){.cats{grid-template-columns:repeat(3,1fr)}}
  .cat-btn{border:1px solid var(--stroke);background:#0f1422;border-radius:10px;padding:10px;cursor:pointer;text-align:center}
  .cat-btn:hover{border-color:#2f7e69}
  .note-area{margin-top:8px}
</style>
</head>
<body>
  <div class="wrap">
    <h1 id="title">ANDI ¬∑ Shpenzimet e Sht√´pis√´</h1>

    <!-- === KRYEFAQJA (Hƒ±zlƒ± giri≈ü + √∂zet) === -->
    <section class="screen active" id="screen-home">
      <div class="card">
        <h3>Shtim shum√´ i shpejt√´</h3>
        <form id="quickForm" autocomplete="off">
          <label for="quickAmount" class="muted">Shkruaj shum√´n</label>
          <input id="quickAmount" type="number" inputmode="decimal" step="0.01" placeholder="p.sh. 1200" autocomplete="off">
          <div class="grid2" style="margin-top:8px">
            <button id="quickGo" class="btn" type="submit" disabled>Vazhdo</button>
            <span class="muted" style="display:grid;align-items:center">M√´ pas: zgjedh kategori ose sh√´nim</span>
          </div>
        </form>
      </div>

      <div class="card">
        <h3>P√´rmbledhje e muajit</h3>
        <div id="monthLine" class="muted">‚Äì</div>
        <div class="totals" id="totalsHome" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- === SHPENZIME (liste/filtra/CSV) === -->
    <section class="screen" id="screen-expenses">
      <div class="card">
        <h3>Regjistrat</h3>
        <div class="grid2" style="margin-bottom:8px">
          <input id="monthPick" type="month">
          <input id="search" placeholder="Filtro sipas kategorie/sh√´nimi‚Ä¶">
        </div>
        <div id="empty" class="muted">Ende nuk ka t√´ dh√´na.</div>
        <div class="list" id="list"></div>
        <div class="totals" id="totals"></div>

        <div class="grid2" style="margin-top:10px">
          <button class="btn" id="exportBtn">Shkarko CSV</button>
          <label class="btn-ghost" style="display:grid;place-items:center;cursor:pointer">Ngarko CSV
            <input id="importInput" type="file" accept=".csv,text/csv" style="display:none">
          </label>
        </div>
        <button class="btn-ghost" id="clearAll" style="margin-top:8px">Pastro t√´ gjitha</button>
      </div>
    </section>

    <!-- === RREGULLIME === -->
    <section class="screen" id="screen-settings">
      <div class="card">
        <h3>Rregullime</h3>
        <div class="grid2">
          <div>
            <label for="setTitle">Titulli</label>
            <input id="setTitle" placeholder="ANDI ¬∑ Shpenzimet e Sht√´pis√´">
          </div>
          <div>
            <label for="accent">Ngjyra kryesore</label>
            <input id="accent" type="color" value="#19c28e">
          </div>
        </div>
        <div style="margin-top:8px">
          <label for="categoriesBox">Kategori (nj√´ p√´r rresht)</label>
          <textarea id="categoriesBox">Qira
Fatura e ujit
Fatura e energjis√´
Internet
Blerje ushqimore
Detergjent rrobash
Rroba
Jasht√´ n√´ restorant
Shpenzime makine
Sh√´nim i lir√´</textarea>
        </div>
        <div class="grid2" style="margin-top:8px">
          <button class="btn" id="apply">Zbato</button>
          <button class="btn-ghost" id="downloadHTML">Shkarko HTML</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Bottom Nav (3 sekme) -->
  <nav class="nav" id="nav">
    <a href="#home" data-target="screen-home" class="active"><span class="ico">üè†</span>Kryefaqja</a>
    <a href="#exp" data-target="screen-expenses"><span class="ico">üí∏</span>Shpenzime</a>
    <a href="#set" data-target="screen-settings"><span class="ico">‚öôÔ∏è</span>Rregullime</a>
  </nav>

  <!-- === Picker Dialog (kategori/≈ü√´nim) === -->
  <dialog id="pickerDlg">
    <div class="modal-head">Zgjidh kategorin√´</div>
    <div class="modal-body">
      <div class="cats" id="catsBox"></div>
      <div class="note-area">
        <label for="quickNote" class="muted">Sh√´nim (opsionale)</label>
        <textarea id="quickNote" placeholder="p.sh. ‚ÄòMarket‚Äô, ‚ÄòRestorant ‚Ä¶‚Äô"></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" id="pickerCancel">Anulo</button>
      <button class="btn" id="pickerSave">Ruaj</button>
    </div>
  </dialog>

  <!-- === Edit Dialog === -->
  <dialog id="editDlg">
    <div class="modal-head">P√´rdit√´so</div>
    <form id="editForm">
      <div class="modal-body">
        <input type="hidden" id="editId">
        <div class="grid2">
          <div>
            <label>Shuma (ALL)</label>
            <input id="editAmount" inputmode="decimal" required>
          </div>
          <div>
            <label>Kategoria</label>
            <select id="editCategory" required></select>
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Data & Ora</label>
          <input id="editDate" type="datetime-local" required>
        </div>
        <div style="margin-top:8px">
          <label>Sh√´nim</label>
          <textarea id="editNote"></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-ghost" type="button" id="editCancel">Anulo</button>
        <button class="btn" type="submit">Ruaj</button>
      </div>
    </form>
  </dialog>

<script>
(function(){
  const LS_DATA='andi_quick_data_v4';
  const LS_CFG='andi_quick_cfg_v1';
  const $=s=>document.querySelector(s);

  // --- STATE ---
  let data = loadJSON(LS_DATA, []);
  let cfg  = loadJSON(LS_CFG, {
    title:'ANDI ¬∑ Shpenzimet e Sht√´pis√´',
    accent:'#19c28e',
    categories:['Qira','Fatura e ujit','Fatura e energjis√´','Internet','Blerje ushqimore','Detergjent rrobash','Rroba','Jasht√´ n√´ restorant','Shpenzime makine','Sh√´nim i lir√´']
  });
  let lastDeleted=null;

  // --- THEME / TITULL ---
  const title=$('#title'); title.textContent=cfg.title;
  document.documentElement.style.setProperty('--accent', cfg.accent);

  // --- NAV (3 sekme) ---
  document.getElementById('nav').addEventListener('click', (e)=>{
    const a=e.target.closest('a'); if(!a) return;
    e.preventDefault();
    document.querySelectorAll('.nav a').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById(a.dataset.target).classList.add('active');
    if(a.dataset.target==='screen-home') paintHome();
    if(a.dataset.target==='screen-expenses') paintList();
  });

  // --- HIZLI Gƒ∞Rƒ∞≈û ---
  const quickForm=$('#quickForm'), quickAmount=$('#quickAmount'), quickGo=$('#quickGo');
  const pickerDlg=$('#pickerDlg'), catsBox=$('#catsBox'), quickNote=$('#quickNote');

  function parseAmount(v){ return Number(String(v||'').replace(',','.')); }
  function isValidAmount(v){ const n=parseAmount(v); return Number.isFinite(n) && n>0; }

  quickForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const val=parseAmount(quickAmount.value);
    if(!isValidAmount(val)){ shake(quickAmount); return; }
    openPicker(val);
  });
  quickAmount.addEventListener('blur', ()=>{ const v=parseAmount(quickAmount.value); if(isValidAmount(v)) openPicker(v); });
  quickAmount.addEventListener('input', ()=>{ quickGo.disabled=!isValidAmount(quickAmount.value); });

  function renderCats(){
    catsBox.innerHTML='';
    cfg.categories.forEach(c=>{
      const b=document.createElement('button');
      b.type='button'; b.className='cat-btn'; b.textContent=c;
      b.onclick=()=>{ catsBox.querySelectorAll('.cat-btn').forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); };
      catsBox.appendChild(b);
    });
  }
  function openPicker(val){ renderCats(); quickNote.value=''; pickerDlg.dataset.amount=String(val); pickerDlg.showModal(); }
  $('#pickerCancel').onclick=()=>pickerDlg.close();
  $('#pickerSave').onclick=()=>{
    const val=parseAmount(pickerDlg.dataset.amount||'0'); if(!isValidAmount(val)) return;
    const sel=catsBox.querySelector('.sel'); let cat=sel?sel.textContent:''; let note=(quickNote.value||'').trim();
    if(!cat && !note){ alert('Zgjidh kategori ose shkruaj sh√´nim'); return; }
    if(/sh√´nim/i.test(cat)) cat='Sh√´nim';
    const rec={id:rid(),ts:new Date().toISOString(),amount:Number(val.toFixed(2)),currency:'ALL',category:cat||'Sh√´nim',note};
    data.push(rec); saveJSON(LS_DATA,data);
    quickAmount.value=''; quickGo.disabled=true; pickerDlg.close();
    paintHome(); paintList();
    alert('U ruajt!');
  };

  // --- SHPENZIME (liste) ---
  const monthPick=$('#monthPick'), search=$('#search'), list=$('#list'), empty=$('#empty'), totals=$('#totals');
  const editDlg=$('#editDlg'), editId=$('#editId'), editAmount=$('#editAmount'), editCategory=$('#editCategory'), editDate=$('#editDate'), editNote=$('#editNote');

  const now=new Date(); monthPick.value=now.toISOString().slice(0,7);

  monthPick.addEventListener('change', paintList);
  search.addEventListener('input', paintList);

  list.addEventListener('click', (e)=>{
    const btn=e.target.closest('[data-act]'); if(!btn) return;
    const id=btn.dataset.id, act=btn.dataset.act;
    const it=data.find(x=>x.id===id); if(!it) return;
    if(act==='del'){ if(!confirm('Ta fshij k√´t√´ rresht?')) return;
      lastDeleted={...it}; data=data.filter(x=>x.id!==id); saveJSON(LS_DATA,data); paintHome(); paintList();
    } else if(act==='edit'){ openEdit(it); }
  });

  $('#editCancel').addEventListener('click', ()=> editDlg.close());
  $('#editForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const idx=data.findIndex(x=>x.id===editId.value); if(idx<0){ editDlg.close(); return; }
    const val=parseAmount(editAmount.value); if(!isValidAmount(val)){ shake(editAmount); return; }
    const dt=new Date(editDate.value); if(isNaN(dt.getTime())){ shake(editDate); return; }
    data[idx]={...data[idx], amount:Number(val.toFixed(2)), category:editCategory.value, note:(editNote.value||'').trim(), ts:new Date(dt.getTime()-dt.getTimezoneOffset()*60000).toISOString()};
    saveJSON(LS_DATA,data); paintHome(); paintList(); editDlg.close(); alert('U p√´rdit√´sua!');
  });

  function openEdit(item){
    editId.value=item.id;
    editAmount.value=String(item.amount);
    editCategory.innerHTML='';
    cfg.categories.forEach(c=>{ const lab=/sh√´nim/i.test(c)?'Sh√´nim':c; editCategory.appendChild(new Option(lab,lab)); });
    editCategory.value=/sh√´nim/i.test(item.category)?'Sh√´nim':item.category;
    editNote.value=item.note||'';
    const d=new Date(item.ts);
    editDate.value=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
    editDlg.showModal();
  }

  // --- HOME √ñZET ---
  function paintHome(){
    const [y,m]=(monthPick.value||new Date().toISOString().slice(0,7)).split('-').map(Number);
    let market=0, rent=0;
    for(const d of data){
      const dt=new Date(d.ts);
      if(dt.getFullYear()===y && (dt.getMonth()+1)===m){
        if(/blerje\s+ushq/i.test(d.category)) market+=d.amount;
        if(/qira/i.test(d.category)) rent+=d.amount;
      }
    }
    const fmt=money();
    $('#monthLine').textContent=K√´t√´ muaj: ‚ÄúBlerje ushqimore‚Äù ${fmt(market)} ¬∑ ‚ÄúQira‚Äù ${fmt(rent)}.;
    const byCat=groupByMonth(y,m);
    const top=[...Object.entries(byCat)].sort((a,b)=>b[1]-a[1]).slice(0,3);
    const box=$('#totalsHome'); box.innerHTML='';
    top.forEach(([k,v])=>{ const el=document.createElement('div'); el.className='total-box'; el.textContent=${k}: ${fmt(v)}; box.appendChild(el); });
  }

  function paintList(){
    const [y,m]=monthPick.value.split('-').map(Number);
    const q=(search.value||'').toLowerCase().trim();
    const rows=data.filter(d=>{
      const dt=new Date(d.ts);
      const inMonth=dt.getFullYear()===y && (dt.getMonth()+1)===m;
      const inSearch=!q || (String(d.category).toLowerCase().includes(q) || String(d.note).toLowerCase().includes(q));
      return inMonth && inSearch;
    }).sort((a,b)=> new Date(b.ts)-new Date(a.ts));

    empty.classList.toggle('hide', rows.length>0);
    list.innerHTML=''; totals.innerHTML='';
    const fmt=money(); const byCat={}; let sum=0;
    for(const d of rows){
      sum+=d.amount; byCat[d.category]=(byCat[d.category]||0)+d.amount;
      const el=document.createElement('div'); el.className='item';
      el.innerHTML=`
        <div>
          <div class="top">
            <span class="chip">${esc(d.category)}</span>
            ${d.note?<span class="chip">${esc(d.note)}</span>:''}
          </div>
          <div class="time">${new Date(d.ts).toLocaleString('sq-AL')}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
          <div class="amt">${fmt(d.amount)}</div>
          <div class="actions">
            <button class="btn-ghost" data-act="edit" data-id="${d.id}">Ndrysho</button>
            <button class="btn-danger" data-act="del" data-id="${d.id}">Fshi</button>
          </div>
        </div>`;
      list.appendChild(el);
    }
    const total=document.createElement('div'); total.className='total-box'; total.innerHTML=<b>Totali i muajit:</b> ${fmt(sum)}; totals.appendChild(total);
    Object.entries(byCat).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{ const b=document.createElement('div'); b.className='total-box'; b.textContent=${k}: ${fmt(v)}; totals.appendChild(b); });
  }

  // --- SETTINGS ---
  $('#setTitle').value=cfg.title; $('#accent').value=toHex(cfg.accent,'#19c28e'); $('#categoriesBox').value=cfg.categories.join('\n');
  $('#apply').addEventListener('click', ()=>{
    cfg.title = ($('#setTitle').value||cfg.title).trim();
    cfg.accent = $('#accent').value || cfg.accent;
    cfg.categories = ($('#categoriesBox').value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(!cfg.categories.some(c=>/sh√´nim/i.test(c))) cfg.categories.push('Sh√´nim i lir√´');
    saveJSON(LS_CFG,cfg);
    document.documentElement.style.setProperty('--accent', cfg.accent);
    title.textContent = cfg.title;
    alert('Rregullimet u ruajt√´n.');
  });
  $('#downloadHTML').addEventListener('click', ()=>{
    const html='<!doctype html>\n'+document.documentElement.outerHTML;
    const blob=new Blob([html],{type:'text/html;charset=utf-8;'}); dl(blob,'andi-shpenzime-quick-lite.html');
  });

  // --- CSV ---
  $('#exportBtn').addEventListener('click', exportCSV);
  $('#importInput').addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const text=await f.text(); const rows=parseCSV(text); let added=0;
    const ids=new Set(data.map(d=>d.id));
    for(const r of rows){
      const amt=Number(r.amount);
      if(!r.id||ids.has(r.id)||!r.ts||!amt||!r.currency) continue;
      data.push({ id:r.id, ts:r.ts, amount:amt, currency:r.currency, category:r.category||'Tjet√´r', note:r.note||'' });
      ids.add(r.id); added++;
    }
    saveJSON(LS_DATA,data); paintHome(); paintList(); alert(U shtuan ${added} rreshta.); e.target.value='';
  });
  $('#clearAll').addEventListener('click', ()=>{ if(!confirm('T‚Äôi fshij t√´ gjitha?')) return; data=[]; saveJSON(LS_DATA,data); paintHome(); paintList(); });

  // ƒ∞lk boyamalar
  const now=new Date(); monthPick.value=now.toISOString().slice(0,7);
  paintHome(); paintList();

  // --- UTILS ---
  function money(){ const nf=new Intl.NumberFormat('sq-AL',{style:'currency',currency:'ALL',maximumFractionDigits:2}); return v=>nf.format(v); }
  function rid(){ if(window.crypto?.getRandomValues){const a=new Uint8Array(16); crypto.getRandomValues(a); return Array.from(a).map(x=>x.toString(16).padStart(2,'0')).join(''); } return 'id-'+Math.random().toString(36).slice(2); }
  function loadJSON(k,fb){ try{const r=localStorage.getItem(k); return r?JSON.parse(r):fb}catch{ return fb } }
  function saveJSON(k,v){ try{localStorage.setItem(k,JSON.stringify(v));}catch{} }
  function esc(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function csvEsc(v){ const s=String(v??''); return /[",\n]/.test(s)?"${s.replace(/"/g,'""')}":s; }
  function splitCSV(line){ const res=[]; let cur=''; let q=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='\"'){ if(q && line[i+1]==='\"'){cur+='\"'; i++;} else q=!q; } else if(ch===',' && !q){ res.push(cur); cur=''; } else cur+=ch; } res.push(cur); return res; }
  function parseCSV(text){ const lines=text.replace(/\r/g,'').split('\n').filter(Boolean); if(!lines.length) return []; const header=splitCSV(lines[0]); const idx=n=>header.indexOf(n); const out=[]; for(let i=1;i<lines.length;i++){ const c=splitCSV(lines[i]); out.push({ id:c[idx('id')], ts:c[idx('ts')], amount:c[idx('amount')], currency:c[idx('currency')], category:c[idx('category')], note:c[idx('note')] }); } return out; }
  function exportCSV(){ const rows=[['id','ts','amount','currency','category','note'].join(',')]; for(const d of data){ rows.push([d.id,d.ts,d.amount,d.currency,d.category||'',d.note||''].map(csvEsc).join(',')); } const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'}); dl(blob,ANDI_Shpnezime_${new Date().toISOString().slice(0,10)}.csv); }
  function dl(blob, name){ const a=document.createElement('a'); a.download=name; a.href=URL.createObjectURL(blob); document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); }
  function toHex(v,f){ if(!v) return f; if(/^#([0-9a-f]{6}|[0-9a-f]{3})$/i.test(v)) return v; const m=/rgba?\((\d+),\s*(\d+),\s*(\d+)/.exec(v); if(m){const [r,g,b]=[+m[1],+m[2],+m[3]]; return '#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');} return f; }
})();
</script>
</body>
</html>
