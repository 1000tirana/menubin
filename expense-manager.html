<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Andi Ev Harcamaları</title>
<style>
:root{--line:#ececf1;--primary:#ff5a5f;--blue:#1e88e5;--red:#e53935}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
.app{max-width:560px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column}
.header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px 0}
.h1{font-weight:700}
.tabs{display:flex;gap:8px;padding:8px 0 12px;overflow:auto}
.tab{padding:9px 13px;border:1px solid var(--line);border-radius:12px;background:#f6f7f9;font-weight:700}
.tab.active{background:#111;color:#fff;border-color:#111}
.kpis{display:flex;gap:8px;padding:0 0 10px}
.kpi{flex:1;border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center;font-weight:700}
.blue{color:var(--blue)}.red{color:var(--red)}
.content{flex:1;padding:10px 12px 90px}
.card{border:1px solid var(--line);border-radius:14px;background:#fff}
.row{display:grid;grid-template-columns:54px 1fr auto;gap:10px;align-items:center;padding:12px;border-top:1px solid var(--line)}
.row:first-child{border-top:none}
.dot{width:40px;height:40px;border-radius:10px;background:#f2f3f5;display:flex;align-items:center;justify-content:center;font-weight:800}
.amount{font-weight:800}
.amount.income{color:var(--blue)}.amount.expense{color:var(--red)}
.navbar{position:fixed;left:0;right:0;bottom:0;border-top:1px solid var(--line);background:#fff}
.nav{max-width:560px;margin:0 auto;display:flex;justify-content:space-around;padding:8px}
.navbtn{background:none;border:none;font-weight:700}
.fab{position:fixed;right:18px;bottom:78px;width:56px;height:56px;border-radius:16px;background:var(--primary);color:#fff;border:none;font-size:28px;z-index:999;cursor:pointer}
.sheet{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:flex-end;z-index:50}
.sheet.show{display:flex}
.panel{background:#fff;border-radius:18px 18px 0 0;max-width:560px;margin:0 auto;width:100%;padding:14px}
.input,select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px}
.btn{padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-weight:700;cursor:pointer}
.btn.primary{background:#111;color:#fff;border-color:#111}
.small{font-size:12px;color:#666}
.hidden{display:none}
</style>
</head>
<body>
<div class="app">

  <div class="header">
    <div class="h1">Transaction <span class="small">ALL (L)</span></div>
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="daily">Daily</button>
      <button class="tab" data-tab="summary">Summary</button>
      <button class="tab" data-tab="settings">Settings</button>
    </div>
    <div class="kpis">
      <div class="kpi">Gelir<br><span id="kpiIncome" class="blue">L 0</span></div>
      <div class="kpi">Gider<br><span id="kpiExpense" class="red">L 0</span></div>
      <div class="kpi">Toplam<br><span id="kpiTotal">L 0</span></div>
    </div>
  </div>

  <div class="content">
    <!-- DAILY -->
    <div id="view-daily">
      <div class="card" id="dailyList"></div>
    </div>

    <!-- SUMMARY -->
    <div id="view-summary" class="hidden">
      <div class="card" style="padding:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" id="exportBtn">CSV Dışa Aktar</button>
        <label class="btn">CSV Yükle <input id="importInput" type="file" accept=".csv" class="hidden"></label>
        <button class="btn" id="wipeBtn">Tüm Veriyi Sil</button>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="view-settings" class="hidden">
      <div class="card" style="padding:12px; display:grid; gap:10px">
        <div class="small">Veriler tarayıcında (localStorage) saklanır. CSV ile yedekleyip geri yükleyebilirsin.</div>
      </div>
    </div>
  </div>

  <div class="navbar">
    <div class="nav">
      <button class="navbtn" data-tab="daily">Kayıtlar</button>
      <button class="navbtn" data-tab="summary">Özet</button>
      <button class="navbtn" data-tab="settings">Ayarlar</button>
    </div>
  </div>

  <button class="fab" id="addBtn" aria-label="+">+</button>

  <!-- Add Sheet -->
  <div class="sheet" id="sheet">
    <div class="panel">
      <h3>Yeni Kayıt</h3>
      <div style="display:grid;gap:10px">
        <div style="display:flex;gap:10px">
          <select id="type">
            <option value="expense">Gider</option>
            <option value="income">Gelir</option>
          </select>
          <input id="date" type="date" class="input">
        </div>
        <input id="amount" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="Tutar (L) – tam sayı">
        <select id="category" class="input">
          <option>Kira</option><option>Su faturası</option><option>Elektrik faturası</option>
          <option>İnternet</option><option>Ev için yemek alışveriş</option>
          <option>Çamaşır ilacı</option><option>Kıyafet</option><option>Dışarıda yemek</option><option>Diğer</option>
        </select>
        <input id="account" class="input" value="Nakit" placeholder="Hesap (Nakit/Kart/Birikim)">
        <input id="note" class="input" placeholder="Not (isteğe bağlı)">
        <div style="display:flex;gap:10px">
          <button class="btn" id="closeSheet">Kapat</button>
          <button class="btn primary" id="save">Kaydet</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
(function(){
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const fmt=n=>"L "+(n||0).toString().replace(/\B(?=(\\d{3})+(?!\\d))/g," ");
  const today=()=>new Date().toISOString().slice(0,10);
  const uid=()=>Math.random().toString(36).slice(2,10);
  const LS='andi-expense-v3';
  let items=[];

  function load(){ try{ const raw=localStorage.getItem(LS); if(raw) items=JSON.parse(raw)||[]; }catch(e){} }
  function save(){ localStorage.setItem(LS, JSON.stringify(items)); }

  function switchTab(t){
    ['daily','summary','settings'].forEach(v=>{
      document.getElementById('view-'+v).classList.toggle('hidden', v!==t);
      $$('#tabs .tab').forEach(b=> b.classList.toggle('active', b.dataset.tab===t));
    });
  }

  function render(){
    // KPIs
    let inc=0,exp=0; items.forEach(i=> i.type==='income'? inc+=i.amount : exp+=i.amount);
    $('#kpiIncome').textContent=fmt(inc);
    $('#kpiExpense').textContent=fmt(exp);
    $('#kpiTotal').textContent=fmt(inc-exp);
    // list
    const box=$('#dailyList'); box.innerHTML='';
    if(items.length===0){ box.innerHTML='<div class="row"><div>Henüz kayıt yok</div></div>'; return; }
    const sorted=[...items].sort((a,b)=> new Date(b.date)-new Date(a.date));
    sorted.forEach(i=>{
      box.insertAdjacentHTML('beforeend', `
        <div class="row">
          <div class="dot">${new Date(i.date).getDate()}</div>
          <div>
            <div style="font-weight:700">${i.category}</div>
            <div class="small">${i.account} • ${new Date(i.date).toLocaleDateString('tr-TR',{weekday:'short'})}${i.note?' • '+i.note:''}</div>
          </div>
          <div class="amount ${i.type==='income'?'income':'expense'}">${(i.type==='income'?'+':'-')+fmt(i.amount)}</div>
        </div>`);
    });
  }

  function exportCSV(){
    const rows=[['id','date','type','amount','category','account','note']];
    items.forEach(i=> rows.push([i.id,i.date,i.type,i.amount,i.category,i.account,(i.note||'').replace(/\\n/g,' ')]));
    const csv=rows.map(r=>r.map(v=>'"'+String(v==null?'':v).replace(/"/g,'""')+'"').join(',')).join('\\n');
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
    a.download='andi-ev-harcamalari.csv'; a.click();
  }

  function importCSVText(txt){
    const lines=txt.split(/\\r?\\n/).filter(Boolean);
    if(!lines.length) return;
    const head=lines.shift();
    const cols=head.split(',').map(s=>s.replace(/^"|"$/g,'')); const idx={}; cols.forEach((c,i)=>idx[c]=i);
    lines.forEach(line=>{
      const parts=[]; let cur='',q=false;
      for(const ch of line){ if(ch=='"'){ q=!q; continue; } if(ch==',' && !q){ parts.push(cur); cur=''; } else { cur+=ch; } }
      parts.push(cur);
      const g=k=>(parts[idx[k]]||'').replace(/^"|"$/g,'');
      items.push({
        id: g('id')||uid(),
        date: g('date')||today(),
        type: (g('type')==='income'?'income':'expense'),
        amount: parseInt((g('amount')||'').replace(/\\D/g,''),10)||0,
        category: g('category')||'Diğer',
        account: g('account')||'Nakit',
        note: g('note')||''
      });
    });
    save(); render();
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // boot
    load(); render(); switchTab('daily');

    // tabs & navbar
    $('#tabs').addEventListener('click', e=>{ if(e.target.classList.contains('tab')) switchTab(e.target.dataset.tab); });
    $$('.navbtn').forEach(b=> b.addEventListener('click', ()=> switchTab(b.dataset.tab)));

    // add sheet
    $('#addBtn').addEventListener('click', ()=>{
      $('#date').value=today(); $('#type').value='expense'; $('#amount').value='';
      $('#category').value='Ev için yemek alışveriş'; $('#account').value='Nakit'; $('#note').value='';
      // data-data temizle (Safari uyumlu)
      $('#photoPreview')?.removeAttribute && $('#photoPreview').removeAttribute('data-data');
      $('#sheet').classList.add('show');
    });
    $('#closeSheet').addEventListener('click', ()=> $('#sheet').classList.remove('show'));
    $('#save').addEventListener('click', ()=>{
      const amount=parseInt(($('#amount').value||'').replace(/\\D/g,''),10)||0;
      if(!amount){ alert('Tutar gir (tam sayı).'); return; }
      items.push({
        id: uid(),
        date: $('#date').value||today(),
        type: $('#type').value,
        amount,
        category: $('#category').value,
        account: $('#account').value||'Nakit',
        note: ($('#note').value||'').trim()
      });
      save(); render(); $('#sheet').classList.remove('show');
      if(confirm('CSV indirilsin mi?')) exportCSV();
    });

    // csv
    $('#exportBtn').addEventListener('click', exportCSV);
    $('#importInput').addEventListener('change', e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=ev=>{ importCSVText(ev.target.result); alert('İçe aktarıldı.'); };
      r.readAsText(f,'utf-8'); e.target.value='';
    });
    $('#wipeBtn').addEventListener('click', ()=>{
      if(!confirm('Tüm veriler silinsin mi?')) return;
      items=[]; save(); render();
    });
  });
})();
</script>
</body>
</html>
