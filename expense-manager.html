<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Andi ‚Äì Shpenzimet e Sht√´pis√´</title>
<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --ink:#1b1d23; --muted:#8a90a0;
  --line:#e9ecf2; --accent:#ff5a5f; --blue:#1e88e5; --red:#e53935;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.app{max-width:560px;margin:0 auto;min-height:100%;display:flex;flex-direction:column}

/* Header */
.header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#fff,rgba(255,255,255,.95));border-bottom:1px solid var(--line);padding:12px 16px}
.h1{font-weight:800;font-size:18px;display:flex;justify-content:space-between;align-items:center}
.kpis{display:flex;gap:8px;margin-top:10px}
.kpi{flex:1;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center;font-weight:700}
.kpi .v{display:block;margin-top:2px}
.blue{color:var(--blue)} .red{color:var(--red)}
.monthRow{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:8px}
.mbtn{border:none;background:#f1f3f6;padding:8px 10px;border-radius:10px;font-weight:700}
.monthLabel{font-weight:800}

/* Content cards */
.content{flex:1;padding:12px 12px 96px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.05)}

/* Daily list */
.list .row{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;padding:12px;border-top:1px solid var(--line)}
.list .row:first-child{border-top:none}
.dot{width:42px;height:42px;border-radius:12px;background:#f0f2f6;display:flex;align-items:center;justify-content:center;font-weight:800}
.title2{font-weight:700}
.note{font-size:12px;color:var(--muted);margin-top:2px}
.amount{font-weight:800}
.amount.income{color:var(--blue)} .amount.expense{color:var(--red)}
.cat{display:inline-flex;align-items:center;gap:6px}
.badge{width:12px;height:12px;border-radius:3px;display:inline-block}

/* Calendar */
.calWrap{padding:10px}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cell{background:#fff;border:1px solid var(--line);border-radius:12px;min-height:78px;padding:8px;display:flex;flex-direction:column;gap:6px}
.cell .d{font-size:12px;color:#555;font-weight:700}
.cell .s{font-size:12px}
.today{box-shadow:0 0 0 1.5px #111 inset;border-color:#111}

/* Pie + legend */
.center{display:flex;align-items:center;justify-content:center}
.legend{display:flex;flex-direction:column;gap:8px;padding:10px 12px 14px}
.leg{display:flex;align-items:center;justify-content:space-between;gap:10px}
.left{display:flex;align-items:center;gap:8px}

/* Bottom nav + FAB */
.navbar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);z-index:8}
.nav{max-width:560px;margin:0 auto;display:flex;justify-content:space-around;padding:8px}
.navbtn{background:none;border:none;font-weight:800;color:#555;padding:10px}
.navbtn.active{color:#111}
.fab{position:fixed;right:18px;bottom:86px;width:56px;height:56px;border-radius:16px;background:var(--accent);color:#fff;border:none;font-size:28px;z-index:999;cursor:pointer;box-shadow:0 12px 24px rgba(255,90,95,.35)}

/* Sheet */
.sheet{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:flex-end;z-index:20}
.sheet.show{display:flex}
.panel{background:#fff;border-radius:18px 18px 0 0;max-width:560px;margin:0 auto;width:100%;padding:14px}
.gridForm{display:grid;gap:10px}
.row2{display:flex;gap:10px}
input,select,textarea,button{font-size:16px !important}
.input,select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
.btn{padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-weight:700;cursor:pointer}
.btn.primary{background:#111;color:#fff;border-color:#111}
.small{font-size:12px;color:var(--muted)}
.hidden{display:none}
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div class="h1">Transaksione -<span class="small">ALL (L)</span></div>

    <!-- Month controls (used for Calendar & pie range) -->
    <div class="monthRow">
      <button class="mbtn" id="prevM">‚Äπ</button>
      <div class="monthLabel" id="mLabel"></div>
      <button class="mbtn" id="nextM">‚Ä∫</button>
    </div>

    <div class="kpis">
      <div class="kpi">T√´ ardhura <span id="kpiIncome" class="v blue">L 0</span></div>
      <div class="kpi">Shpenzime <span id="kpiExpense" class="v red">L 0</span></div>
      <div class="kpi">Totali <span id="kpiTotal" class="v">L 0</span></div>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <!-- DITORE -->
    <div id="view-daily">
      <div class="card list" id="dailyList"></div>
    </div>

    <!-- KALENDAR -->
    <div id="view-calendar" class="hidden">
      <div class="card calWrap">
        <div class="grid" id="calGrid"></div>
      </div>
    </div>

    <!-- P√ãRMBLEDHJE (GRAFIK TORTE) -->
    <div id="view-summary" class="hidden">
      <div class="card" style="padding:10px">
        <div class="center"><canvas id="pie" width="320" height="220"></canvas></div>
        <div class="legend" id="legend"></div>
      </div>

      <div class="card" style="padding:12px;display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <button class="btn" id="exportBtn">Eksporto CSV</button>
        <label class="btn">Ngarko CSV <input id="importInput" type="file" accept=".csv" class="hidden"></label>
        <button class="btn" id="wipeBtn">Fshi t√´ dh√´nat</button>
        <div class="small" style="width:100%">T√´ dh√´nat ruhen n√´ shfletues (localStorage). Mund t‚Äôi ruash/ngarkosh si CSV.</div>
      </div>
    </div>

    <!-- CIL√ãSIMET -->
    <div id="view-settings" class="hidden">
      <div class="card" style="padding:12px">
        <div class="small">Shuma futet si num√´r i plot√´. Monedha: <b>ALL (L)</b>.</div>
      </div>
    </div>
  </div>

  <!-- SINGLE BOTTOM MENU -->
  <div class="navbar">
    <div class="nav">
      <button class="navbtn active" data-tab="daily">Regjistrimet</button>
      <button class="navbtn" data-tab="calendar">Kalendari</button>
      <button class="navbtn" data-tab="summary">P√´rmbledhje</button>
      <button class="navbtn" data-tab="settings">Cil√´simet</button>
    </div>
  </div>

  <!-- FAB -->
  <button class="fab" id="addBtn" aria-label="Shto">+</button>

  <!-- SHEET -->
  <div class="sheet" id="sheet">
    <div class="panel">
      <h3>Regjistrim i ri</h3>
      <div class="gridForm">
        <div class="row2">
          <select id="type">
            <option value="expense">Shpenzim</option>
            <option value="income">T√´ ardhura</option>
          </select>
          <input id="date" type="date" class="input">
        </div>
        <input id="amount" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="Shuma (L) ‚Äì num√´r i plot√´">
        <select id="category" class="input">
          <option>Qira</option>
          <option>Fatura e ujit</option>
          <option>Fatura e energjis√´</option>
          <option>Interneti</option>
          <option>Blerje ushqimore p√´r sht√´pi</option>
          <option>Detergjent rrobash</option>
          <option>Rroba</option>
          <option>Vakt jasht√´</option>
          <option>Tjet√´r</option>
        </select>
        <input id="account" class="input" value="Cash" placeholder="Llogaria (Cash/Kart√´/Kursim)">
        <input id="note" class="input" placeholder="Sh√´nim (opsionale)">
        <div class="row2">
          <button class="btn" id="closeSheet">Mbyll</button>
          <button class="btn primary" id="save">Ruaj</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
(function(){
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const fmt=n=>"L "+(n||0).toString().replace(/\B(?=(\\d{3})+(?!\\d))/g," ");
  const sot=()=>new Date().toISOString().slice(0,10);
  const uid=()=>Math.random().toString(36).slice(2,10);
  const LS='andi-shpenzimet-v3'; let items=[];
  // kategori -> ngjyr√´ + ikon√´
  const CAT = {
    'Qira':         {c:'#7e57c2', i:'üè†'},
    'Fatura e ujit':{c:'#29b6f6', i:'üöø'},
    'Fatura e energjis√´':{c:'#ffb300', i:'üí°'},
    'Interneti':    {c:'#42a5f5', i:'üåê'},
    'Blerje ushqimore p√´r sht√´pi':{c:'#66bb6a', i:'üõí'},
    'Detergjent rrobash':{c:'#8d6e63', i:'üß¥'},
    'Rroba':        {c:'#ec407a', i:'üëï'},
    'Vakt jasht√´':  {c:'#ef5350', i:'üçΩÔ∏è'},
    'Tjet√´r':       {c:'#90a4ae', i:'üì¶'}
  };

  /* storage */
  function ngarko(){ try{const raw=localStorage.getItem(LS); if(raw) items=JSON.parse(raw)||[];}catch(e){} }
  function ruaj(){ localStorage.setItem(LS, JSON.stringify(items)); }

  /* month helpers */
  let viewMonth = new Date(); // controls calendar/summary range
  function setMonthLabel(){
    const l=viewMonth.toLocaleDateString('sq-AL',{month:'long',year:'numeric'});
    $('#mLabel').textContent = l.charAt(0).toUpperCase()+l.slice(1);
  }
  function rangeMonth(){
    const y=viewMonth.getFullYear(), m=viewMonth.getMonth();
    return [new Date(y,m,1), new Date(y,m+1,0,23,59,59,999)];
  }
  function inRange(d,s,e){ return d>=s && d<=e; }
  function filteredMonth(){ const [s,e]=rangeMonth(); return items.filter(i=> inRange(new Date(i.date), s,e)); }

  /* KPIs & list */
  function renderKPIs(){
    const list=filteredMonth(); let inc=0,exp=0;
    list.forEach(i=> i.type==='income'? inc+=i.amount : exp+=i.amount);
    $('#kpiIncome').textContent=fmt(inc);
    $('#kpiExpense').textContent=fmt(exp);
    $('#kpiTotal').textContent=fmt(inc-exp);
  }
  function renderDaily(){
    const box=$('#dailyList'); box.innerHTML='';
    const list=filteredMonth().sort((a,b)=> new Date(b.date)-new Date(a.date));
    if(!list.length){ box.innerHTML='<div class="center" style="padding:16px;color:#888">Ende s‚Äôka regjistrime</div>'; return; }
    list.forEach(i=>{
      const d=new Date(i.date); const wd=d.toLocaleDateString('sq-AL',{weekday:'short'});
      const meta = CAT[i.category] || CAT['Tjet√´r'];
      box.insertAdjacentHTML('beforeend', `
        <div class="row">
          <div class="dot">${d.getDate()}</div>
          <div>
            <div class="title2">
              <span class="cat"><span class="badge" style="background:${meta.c}"></span>${meta.i} ${i.category}</span>
            </div>
            <div class="note">${i.account} ‚Ä¢ ${wd}${i.note?' ‚Ä¢ '+i.note:''}</div>
          </div>
          <div class="amount ${i.type==='income'?'income':'expense'}">${(i.type==='income'?'+':'-')+fmt(i.amount)}</div>
        </div>`);
    });
  }

  /* Calendar view */
  function renderCalendar(){
    const grid=$('#calGrid'); grid.innerHTML='';
    const y=viewMonth.getFullYear(), m=viewMonth.getMonth();
    const first=new Date(y,m,1); const total=new Date(y,m+1,0).getDate();
    const startW = (first.getDay()+6)%7; // Mon=0
    // sums by day
    const sums={}; filteredMonth().forEach(i=>{
      const d=new Date(i.date).getDate();
      if(!sums[d]) sums[d]={inc:0,exp:0};
      if(i.type==='income') sums[d].inc+=i.amount; else sums[d].exp+=i.amount;
    });
    for(let i=0;i<startW;i++) grid.insertAdjacentHTML('beforeend','<div></div>');
    for(let d=1; d<=total; d++){
      const s=sums[d]||{inc:0,exp:0};
      const isToday=(new Date().toDateString()===new Date(y,m,d).toDateString());
      grid.insertAdjacentHTML('beforeend', `
        <div class="cell ${isToday?'today':''}">
          <div class="d">${d}</div>
          <div class="s blue">${s.inc?('Ôºã'+fmt(s.inc)) : ''}</div>
          <div class="s red">${s.exp?('Ôºç'+fmt(s.exp)) : ''}</div>
        </div>`);
    }
  }

  /* Pie chart (expenses by category) */
  function renderPie(){
    const ctx=$('#pie').getContext('2d'); const W=ctx.canvas.width,H=ctx.canvas.height; ctx.clearRect(0,0,W,H);
    const data={}; filteredMonth().forEach(i=>{ if(i.type!=='expense') return; data[i.category]=(data[i.category]||0)+i.amount; });
    const labels=Object.keys(data); const vals=labels.map(k=>data[k]); const sum=vals.reduce((a,b)=>a+b,0);
    let a0=-Math.PI/2; labels.forEach((lab,idx)=>{
      const val=data[lab]; const frac=sum? val/sum:0; const a1=a0+frac*Math.PI*2;
      const color=(CAT[lab]?.c)||CAT['Tjet√´r'].c;
      ctx.beginPath(); ctx.moveTo(W/2,H/2); ctx.arc(W/2,H/2, Math.min(W,H)/2-14, a0,a1); ctx.closePath();
      ctx.fillStyle=color; ctx.fill(); a0=a1;
    });
    const leg=$('#legend'); leg.innerHTML='';
    if(!labels.length){ leg.innerHTML='<div class="center" style="color:#888;padding:8px">Nuk ka shpenzime k√´t√´ muaj</div>'; return; }
    labels.forEach(lab=>{
      const color=(CAT[lab]?.c)||CAT['Tjet√´r'].c; const icon=(CAT[lab]?.i)||CAT['Tjet√´r'].i;
      const v=data[lab]; const pct=((v*100)/sum).toFixed(1);
      leg.insertAdjacentHTML('beforeend', <div class="leg"><div class="left"><span class="badge" style="background:${color}"></span><b>${icon} ${lab}</b></div><div>${pct}% ‚Äì ${fmt(v)}</div></div>);
    });
  }

  function renderAll(){
    setMonthLabel(); renderKPIs(); renderDaily(); renderCalendar(); renderPie();
  }

  /* CSV */
  function eksportCSV(){
    const rows=[['id','date','type','amount','category','account','note']];
    items.forEach(i=> rows.push([i.id,i.date,i.type,i.amount,i.category,i.account,i.note||'']));
    const csv=rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\\n');
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
    a.download='andi-shpenzimet.csv'; a.click();
  }
  function importCSV(txt){
    const lines=txt.split(/\\r?\\n/).filter(Boolean); if(!lines.length) return;
    const head=lines.shift().split(',').map(s=>s.replace(/^"|"$/g,'')); const idx={}; head.forEach((c,i)=>idx[c]=i);
    lines.forEach(line=>{
      const arr=[]; let cur='',q=false;
      for(const ch of line){ if(ch=='"'){q=!q;continue;} if(ch==','&&!q){arr.push(cur);cur='';} else cur+=ch; } arr.push(cur);
      const g=k=>(arr[idx[k]]||'').replace(/^"|"$/g,'');
      items.push({ id:g('id')||uid(), date:g('date')||sot(), type:g('type')==='income'?'income':'expense',
        amount:parseInt((g('amount')||'').replace(/\\D/g,''))||0, category:g('category')||'Tjet√´r',
        account:g('account')||'Cash', note:g('note')||'' });
    });
    ruaj(); renderAll();
  }

  /* Navigation (single bottom menu) */
  function kalo(tab){
    ['daily','calendar','summary','settings'].forEach(v=>{
      $('#view-'+v).classList.toggle('hidden', v!==tab);
      $$('.navbtn').forEach(b=> b.classList.toggle('active', b.dataset.tab===tab));
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // boot
    ngarko(); renderAll(); kalo('daily');

    // bottom nav
    $$('.navbtn').forEach(b=> b.addEventListener('click', ()=> kalo(b.dataset.tab)));

    // month controls
    $('#prevM').onclick=()=>{ viewMonth.setMonth(viewMonth.getMonth()-1); renderAll(); };
    $('#nextM').onclick=()=>{ viewMonth.setMonth(viewMonth.getMonth()+1); renderAll(); };

    // add record
    $('#addBtn').addEventListener('click', ()=>{
      $('#date').value=sot(); $('#type').value='expense'; $('#amount').value='';
      $('#category').value='Blerje ushqimore p√´r sht√´pi'; $('#account').value='Cash'; $('#note').value='';
      $('#sheet').classList.add('show');
    });
    $('#closeSheet').onclick=()=> $('#sheet').classList.remove('show');
    $('#save').onclick=()=> {
      const amt=parseInt(($('#amount').value||'').replace(/\\D/g,''))||0;
      if(!amt){ alert('Shkruaj shum√´n (num√´r i plot√´).'); return; }
      const it={ id:uid(), date:$('#date').value||sot(), type:$('#type').value, amount:amt,
                 category:$('#category').value, account:$('#account').value||'Cash', note:($('#note').value||'').trim() };
      items.push(it); ruaj(); renderAll(); $('#sheet').classList.remove('show');
      if(confirm('Ta shkarkoj CSV?')) eksportCSV();
    };

    // CSV
    $('#exportBtn').onclick=eksportCSV;
    $('#importInput').onchange=e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=ev=>{ importCSV(ev.target.result); alert('U ngarkua.'); };
      r.readAsText(f,'utf-8'); e.target.value='';
    };
    $('#wipeBtn').onclick=()=>{ if(!confirm('T√´ gjitha t√´ dh√´nat t√´ fshihen?')) return; items=[]; ruaj(); renderAll(); };
  });
})();
</script>
</body>
</html>
