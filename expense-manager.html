<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Andi Ev Harcamaları</title>
<style>
  :root{
    --bg:#0f1220; --card:#151a2e; --muted:#8b93b0; --text:#eaf0ff;
    --accent:#6ee7b7; --accent2:#60a5fa; --danger:#ff6b6b; --chip:#1e2542;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1200px 800px at 120% -10%, #1b2140 0%, rgba(27,33,64,0) 60%),
      radial-gradient(900px 700px at -10% 120%, #1a2a3f 0%, rgba(0,0,0,0) 55%),
      var(--bg);
    color:var(--text); font:500 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    overflow-x:hidden;
  }
  .appbar{
    position:sticky; top:0; z-index:50; backdrop-filter:saturate(180%) blur(12px);
    background:linear-gradient(180deg, rgba(21,26,46,.9), rgba(21,26,46,.6));
    border-bottom:1px solid rgba(255,255,255,.06);
    padding:12px 16px; display:flex; align-items:center; gap:12px;
  }
  .logo{
    width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,#60a5fa, #6ee7b7);
    display:grid;place-items:center; box-shadow:var(--shadow); font-weight:900; color:#0a1024;
  }
  .title{font-size:18px;font-weight:800}
  .subtitle{color:var(--muted); font-size:12px; margin-top:-2px}

  .container{padding:18px; max-width:960px; margin:0 auto}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid rgba(255,255,255,.06);
    border-radius:var(--radius); box-shadow:var(--shadow);
  }

  /* INPUT BAR */
  .input-bar{display:grid; grid-template-columns:1fr auto; gap:10px; padding:16px}
  .amount{
    width:100%; background:#0f1428; border:1px solid rgba(255,255,255,.08);
    color:var(--text); border-radius:14px; padding:14px 16px; font-size:18px;
    outline:none; transition:.2s border;
  }
  .amount:focus{border-color:rgba(96,165,250,.6)}
  .btn{
    background:linear-gradient(135deg, var(--accent2), var(--accent));
    color:#0b1020; border:none; border-radius:14px; padding:14px 18px; font-size:16px;
    font-weight:800; cursor:pointer; box-shadow:var(--shadow); transition:transform .06s;
  }
  .btn:active{transform:translateY(1px)}
  .btn-secondary{
    background:#1a2140; color:var(--text); border:1px solid rgba(255,255,255,.08);
  }
  .toolbar{display:flex; gap:10px; padding:12px 16px; flex-wrap:wrap}

  /* CHIPS */
  .chips{display:flex; gap:8px; flex-wrap:wrap; padding:12px 16px; border-top:1px dashed rgba(255,255,255,.08)}
  .chip{
    padding:10px 12px; border-radius:999px; background:var(--chip); color:var(--text);
    border:1px solid rgba(255,255,255,.05); cursor:pointer; font-size:14px; user-select:none;
  }
  .chip:hover{outline:2px solid rgba(96,165,250,.3)}
  .chip:active{transform:translateY(1px)}

  /* STATS */
  .stats{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:10px; padding:16px}
  @media (max-width:900px){ .stats{grid-template-columns:repeat(2,1fr)} }
  .stat{padding:14px;border-radius:14px;background:#0f1428;border:1px solid rgba(255,255,255,.08)}
  .stat .k{font-size:12px;color:var(--muted)}
  .stat .v{font-size:18px;font-weight:800;margin-top:4px}

  /* LIST */
  .list{padding:4px 8px 12px}
  .row{
    display:grid; grid-template-columns:100px 1fr auto; gap:12px; align-items:center;
    padding:12px; border-bottom:1px solid rgba(255,255,255,.06);
  }
  .row:last-child{border-bottom:none}
  .date{color:var(--muted); font-size:12px}
  .cat{font-weight:700}
  .amt{font-weight:900}
  .note{color:var(--muted); font-size:13px}
  .row .del{
    background:transparent; border:1px solid rgba(255,255,255,.1); color:#ffb0b0; padding:8px 10px;
    border-radius:10px; cursor:pointer;
  }

  /* MODAL (kategori + not) */
  .modal-back{
    position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; place-items:end; z-index:60;
  }
  .modal{width:100%; background:var(--card); border-top-left-radius:20px; border-top-right-radius:20px;
    box-shadow:var(--shadow); padding:16px; border:1px solid rgba(255,255,255,.08);
    max-height:85svh; overflow:auto;
  }
  .modal h3{margin:4px 4px 10px}
  .notein{
    width:100%; background:#0f1428; border:1px solid rgba(255,255,255,.08);
    color:var(--text); border-radius:12px; padding:12px 12px; font-size:15px; outline:none;
  }

  .footer{
    display:flex; gap:10px; padding:12px 16px; justify-content:space-between; align-items:center;
    border-top:1px solid rgba(255,255,255,.06);
  }
  .muted{color:var(--muted); font-size:13px}
  a.link{color:var(--accent2); text-decoration:none}

  .empty{padding:24px; text-align:center; color:var(--muted)}
</style>
</head>
<body>
  <header class="appbar">
    <div class="logo">A</div>
    <div>
      <div class="title">Andi Ev Harcamaları</div>
      <div class="subtitle">LEK (ALL) ile kayıt — hızlı kategori seçimi + CSV içe/dışa aktar</div>
    </div>
  </header>

  <main class="container">
    <!-- INPUT & TOOLS -->
    <section class="card" id="inputCard">
      <div class="input-bar">
        <input id="amount" class="amount" inputmode="decimal" placeholder="Tutarı gir (ALL)…" />
        <button class="btn" id="nextBtn">Devam</button>
      </div>

      <div class="chips" id="chips" aria-disabled="true" title="Önce tutar girin">
        <!-- hızlı kategoriler -->
      </div>

      <div class="toolbar">
        <button class="btn-secondary" id="exportBtn">CSV İndir</button>
        <label class="btn-secondary" style="padding:14px 18px; border-radius:14px; cursor:pointer">
          CSV Yükle
          <input type="file" id="importInput" accept=".csv,text/csv" hidden />
        </label>
        <button class="btn-secondary" id="clearBtn" title="Tüm kayıtları sil">Temizle</button>
      </div>
    </section>

    <!-- STATS -->
    <section class="card" style="margin-top:14px">
      <div class="stats" id="stats"></div>
    </section>

    <!-- LIST -->
    <section class="card" style="margin-top:14px">
      <div class="list" id="list"></div>
    </section>

    <div class="footer">
      <div class="muted">Veriler cihazında saklanır (localStorage). CSV ile yedekleyebilirsin.</div>
      <a class="link" href="#" id="todayBtn">Bugün’e git</a>
    </div>
  </main>

  <!-- MODAL: kategori & not -->
  <div class="modal-back" id="modalBack" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="modal">
      <h3 id="mTitle">Kategori seç veya not yaz</h3>
      <div class="chips" id="modalChips"></div>
      <div style="padding:12px 16px">
        <input id="noteInput" class="notein" placeholder="İstersen buraya not yaz (ör. market adı)…">
      </div>
      <div style="padding:0 16px 12px" class="muted">Tutar: <span id="modalAmount">0</span></div>
      <div class="toolbar" style="padding:12px 16px 16px">
        <button class="btn" id="saveBtn">Kaydı Oluştur</button>
        <button class="btn-secondary" id="cancelBtn">Vazgeç</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const CATS = [
    "Kira", "Su faturası", "Elektrik faturası", "İnternet faturası",
    "Ev için alışveriş", "Çamaşır ilacı", "Kıyafet", "Dışarıda yemek"
  ];
  const LSKEY = "andi_expenses_v1";

  /** state */
  let data = load();
  let pending = { amount: 0, category: "", note: "" };

  /** elements */
  const amountEl = document.getElementById('amount');
  const nextBtn = document.getElementById('nextBtn');
  const chipsEl = document.getElementById('chips');
  const modalBack = document.getElementById('modalBack');
  const modalChips = document.getElementById('modalChips');
  const noteInput = document.getElementById('noteInput');
  const modalAmount = document.getElementById('modalAmount');
  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const listEl = document.getElementById('list');
  const statsEl = document.getElementById('stats');
  const exportBtn = document.getElementById('exportBtn');
  const importInput = document.getElementById('importInput');
  const clearBtn = document.getElementById('clearBtn');
  const todayBtn = document.getElementById('todayBtn');

  /** utils */
  const fmt = new Intl.NumberFormat('sq-AL', { style:'currency', currency:'ALL', maximumFractionDigits:2 });
  const fmtDate = ts => {
    const d=new Date(ts);
    return d.toLocaleDateString('tr-TR', { day:'2-digit', month:'2-digit', year:'numeric' }) + 
           " " + d.toLocaleTimeString('tr-TR', { hour:'2-digit', minute:'2-digit' });
  };
  function save(){ localStorage.setItem(LSKEY, JSON.stringify(data)); }
  function load(){
    try{
      const raw = localStorage.getItem(LSKEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }
  function uid(){ return Math.random().toString(36).slice(2,10) + Date.now().toString(36); }

  /** UI build */
  function buildChips(target, onPick){
    target.innerHTML = "";
    CATS.forEach(c=>{
      const b=document.createElement('button');
      b.className='chip'; b.textContent=c;
      b.addEventListener('click', ()=> onPick(c));
      target.appendChild(b);
    });
    // manuel (not ile)
    const manual=document.createElement('button');
    manual.className='chip'; manual.textContent='(Manuel / sadece not)';
    manual.title="Sadece not yazarak kaydet";
    manual.addEventListener('click', ()=> onPick(""));
    target.appendChild(manual);
  }

  function renderStats(){
    const now=new Date();
    const startOfDay=new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    const startOfWeek=(d=>{ const t=new Date(d); const wd=(t.getDay()+6)%7; t.setDate(t.getDate()-wd); t.setHours(0,0,0,0); return t.getTime(); })(now);
    const startOfMonth=new Date(now.getFullYear(), now.getMonth(), 1).getTime();

    const sum = (from=0)=> data.filter(x=>x.ts>=from).reduce((a,b)=>a+b.amount,0);

    statsEl.innerHTML = [
      ['Bugün', sum(startOfDay)],
      ['Bu Hafta', sum(startOfWeek)],
      ['Bu Ay', sum(startOfMonth)],
      ['Toplam', sum(0)],
    ].map(([k,v])=>(
      `<div class="stat">
        <div class="k">${k}</div>
        <div class="v">${fmt.format(v || 0)}</div>
      </div>`
    )).join('');
  }

  function renderList(){
    if(!data.length){
      listEl.innerHTML = <div class="empty">Henüz kayıt yok. Tutarı girerek başla.</div>;
      renderStats();
      return;
    }
    // newest first
    const rows = data.slice().sort((a,b)=>b.ts-a.ts).map(x=>{
      const note = x.note ? <div class="note">${escapeHtml(x.note)}</div> : '';
      return `<div class="row" data-id="${x.id}">
        <div>
          <div class="date">${fmtDate(x.ts)}</div>
          <div class="cat">${escapeHtml(x.category || '(Manuel)')}</div>
        </div>
        <div>${note}</div>
        <div style="display:flex; align-items:center; gap:8px">
          <div class="amt">${fmt.format(x.amount)}</div>
          <button class="del" title="Sil">Sil</button>
        </div>
      </div>`;
    }).join('');
    listEl.innerHTML = rows;

    // bind deletes
    listEl.querySelectorAll('.row .del').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const id = e.target.closest('.row').dataset.id;
        data = data.filter(r=>r.id!==id);
        save(); renderList(); renderStats();
      });
    });

    renderStats();
  }

  function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function openModal(){
    modalAmount.textContent = fmt.format(pending.amount || 0);
    noteInput.value = pending.note || "";
    modalBack.style.display='grid';
    setTimeout(()=> noteInput.focus(), 80);
  }
  function closeModal(){
    modalBack.style.display='none';
    pending.category = ""; // reset choice; note remains for convenience
  }

  function addRecord(){
    const rec = {
      id: uid(),
      ts: Date.now(),
      amount: pending.amount,
      category: pending.category || '(Manuel)',
      note: (noteInput.value||"").trim()
    };
    data.push(rec); save(); renderList();

    // sor: CSV indirilsin mi?
    setTimeout(()=>{
      if(confirm("CSV indirilsin mi?")){
        exportCSV(true);
      }
    }, 50);
  }

  function exportCSV(download=true){
    const header = ["id","timestamp","date","amount_ALL","category","note"];
    const lines = data.map(x=>{
      const cols = [
        x.id,
        x.ts,
        new Date(x.ts).toISOString(),
        String(x.amount).replace('.',','), // Avrupa ondalık tercihi
        x.category || "",
        (x.note||"").replace(/"/g,'""')
      ];
      // csv safe
      return cols.map(c=>{
        if(/[",;\n]/.test(c)) return "${c}";
        return c;
      }).join(",");
    });
    const csv = [header.join(","), ...lines].join("\n");
    if(download){
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const d = new Date();
      const name = andi_ev_harcamalari_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.csv;
      a.href = url; a.download = name; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }
    return csv;
  }

  function parseCSV(text){
    // Basit ama “çift tırnak içi virgül” kurallı ayrıştırıcı
    const rows=[]; let i=0, field="", row=[], inQ=false;
    while(i<text.length){
      const ch=text[i++];
      if(inQ){
        if(ch=='"'){
          if(text[i]=='"'){ field+='"'; i++; } else { inQ=false; }
        } else { field+=ch; }
      } else {
        if(ch=='"'){ inQ=true; }
        else if(ch==','){ row.push(field); field=""; }
        else if(ch=='\n' || ch=='\r'){
          if(ch=='\r' && text[i]=='\n') i++;
          row.push(field); field=""; if(row.some(c=>c!=='')) rows.push(row); row=[];
        } else { field+=ch; }
      }
    }
    if(field.length || row.length) { row.push(field); rows.push(row); }

    // header’ı atla (uyuyorsa)
    if(rows.length && rows[0][0]==='id') rows.shift();
    return rows.map(r=>{
      const [id, ts, , amount, category, note] = r;
      const num = Number(String(amount).replace(',','.'));
      return {
        id: id || uid(),
        ts: ts ? Number(ts) : Date.now(),
        amount: isFinite(num) ? num : 0,
        category: category || '(Manuel)',
        note: note || ''
      };
    }).filter(x=>x.amount>0 && Number.isFinite(x.ts));
  }

  function importCSVFile(file){
    const fr=new FileReader();
    fr.onload = () => {
      try{
        const rows = parseCSV(String(fr.result));
        // merge (aynı id varsa atla)
        const existing = new Set(data.map(x=>x.id));
        let added=0;
        rows.forEach(r=>{
          if(!existing.has(r.id)){ data.push(r); added++; }
        });
        if(added===0 && rows.length){
          alert("CSV yüklendi fakat tüm kayıtlar zaten mevcut görünüyordu.");
        } else {
          alert(${added} kayıt eklendi.);
        }
        save(); renderList();
      }catch(e){
        alert("CSV okunamadı. Dosyayı kontrol edin.");
      }
    };
    fr.readAsText(file, 'utf-8');
  }

  /** events */
  buildChips(chipsEl, (cat)=>{
    if(!amountEl.value){ amountEl.focus(); return; }
    pending.amount = Number(amountEl.value.replace(',','.')) || 0;
    pending.category = cat;
    pending.note = "";
    openModal();
  });
  buildChips(modalChips, (cat)=>{
    pending.category = cat; // "" ise manuel
  });

  amountEl.addEventListener('input', ()=>{
    const has = !!amountEl.value;
    chipsEl.style.opacity = has ? 1 : .5;
    chipsEl.style.pointerEvents = has ? 'auto' : 'none';
  });

  nextBtn.addEventListener('click', ()=>{
    const val = Number(amountEl.value.replace(',','.')) || 0;
    if(val<=0){ amountEl.focus(); amountEl.select?.(); return; }
    pending.amount = val;
    openModal();
  });

  // Mobilde Enter/done çalışsın
  amountEl.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); nextBtn.click(); }
  });

  saveBtn.addEventListener('click', ()=>{
    if(!pending.amount || pending.amount<=0) return;
    addRecord();
    closeModal();
    amountEl.value = ""; amountEl.focus();
  });
  cancelBtn.addEventListener('click', closeModal);
  modalBack.addEventListener('click', (e)=>{ if(e.target===modalBack) closeModal(); });

  exportBtn.addEventListener('click', ()=> exportCSV(true));
  importInput.addEventListener('change', (e)=>{
    const f=e.target.files?.[0]; if(f) importCSVFile(f);
    e.target.value=""; // tekrar seçim için sıfırla
  });

  clearBtn.addEventListener('click', ()=>{
    if(confirm("Tüm kayıtlar silinsin mi?")){ data=[]; save(); renderList(); renderStats(); }
  });

  todayBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    // en güncel kayda kaydır
    const first = document.querySelector('.row');
    if(first) first.scrollIntoView({behavior:'smooth', block:'start'});
  });

  /** init */
  renderList();
  amountEl.focus();

})();
</script>
</body>
</html>
