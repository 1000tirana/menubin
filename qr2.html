<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Skano Kodet</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  :root{
    --bg:#0f1115; --card:#171a21; --text:#e7e9ee; --muted:#a9b0bd;
    --ok:#1ecb4f; --err:#ff4d4f; --brand:#3b82f6; --edge:#232836;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:10;background:rgba(15,17,21,.9);backdrop-filter:blur(10px);
    border-bottom:1px solid var(--edge);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  header h1{margin:0;font-size:16px;letter-spacing:.2px}
  .lang{display:flex;gap:6px}
  .lang button{padding:6px 10px;border:1px solid var(--edge);background:#1c2331;color:var(--text);border-radius:8px;cursor:pointer;font-weight:700}
  .lang button.active{border-color:var(--brand);box-shadow:0 0 0 2px #1e40af33}
  main{max-width:960px;margin:0 auto;padding:12px}
  /* Camera card */
  #camCard{position:relative;background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:12px}
  #reader{width:100%;aspect-ratio:3/4;max-height:70vh;border-radius:10px;overflow:hidden}
  @media (orientation:landscape){#reader{aspect-ratio:16/9;max-height:62vh}}
  #overlay{position:absolute;inset:12px;border:6px solid transparent;border-radius:12px;pointer-events:none;transition:border-color .18s, box-shadow .18s}
  .bar{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap;align-items:center;justify-content:center}
  .pill{background:#1c2331;border:1px solid var(--edge);color:var(--muted);padding:6px 10px;border-radius:999px}
  .counter{font-weight:700;color:var(--text)}
  .controls{display:flex;gap:8px;justify-content:center;margin-top:8px;flex-wrap:wrap}
  select,button{border-radius:10px;border:1px solid var(--edge);background:#243046;color:#e7e9ee;padding:10px 14px;cursor:pointer}
  .primary{background:var(--brand);border:0;color:#fff}
  .ghost{background:#1c2331}
  .accent{background:#facc15;color:#1a1a00;border:0}
  /* List */
  ul#list{list-style:none;padding:0;margin:14px auto;background:var(--card);border:1px solid var(--edge);border-radius:12px;max-width:700px}
  #list li{padding:10px 12px;border-top:1px solid #222831;display:flex;align-items:center;justify-content:space-between;gap:10px}
  #list li:first-child{border-top:0}
  .idx{opacity:.65;margin-right:8px}
  .del{background:transparent;border:1px solid #3a2323;color:#ffb4b4;border-radius:8px;padding:6px 10px;cursor:pointer}
  /* Bottom actions */
  .fab{position:sticky;bottom:0;z-index:9;background:rgba(15,17,21,.9);backdrop-filter:blur(10px);padding:10px;border-top:1px solid var(--edge)}
  .fab .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .btn{flex:1;min-width:150px;padding:12px 14px;border-radius:10px;font-weight:700;cursor:pointer;border:0}
  .wa{background:#25D366;color:#072b10}
  .danger{background:#e74c3c}
  /* Snack */
  #snack{position:fixed;left:50%;transform:translateX(-50%);top:-80px;z-index:9999;background:#1c2331;border:1px solid var(--edge);
    color:var(--text);padding:10px 16px;border-radius:10px;transition:top .35s;font-weight:800}
  #snack.ok{border-color:#1d4d2a;color:#d6ffe1} #snack.err{border-color:#5b2323;color:#ffd6d6}
  /* Notify (compat with your earlier pattern) */
  #notify{position:fixed;top:-60px;left:50%;transform:translateX(-50%);background:#1ecb4f;color:#0c2a10;padding:10px 16px;border-radius:10px;
    font-weight:800;transition:top .35s;z-index:9999;border:1px solid #144d28}
  #notify.error{background:#ffd6d6;color:#3a0b0b;border-color:#5b2323}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:8px}
</style>
</head>
<body>
<header>
  <h1 id="title">Skano Kodet</h1>
  <div class="lang">
    <button data-lang="sq" class="active">SQ</button>
    <button data-lang="tr">TR</button>
    <button data-lang="en">EN</button>
  </div>
</header>

<main>
  <section id="camCard">
    <div id="reader" aria-label="Camera preview"></div>
    <div id="overlay"></div>
    <div class="bar">
      <span class="pill" id="hint">Hap kamerën dhe afro kodin.</span>
      <span class="pill counter"><span id="count">0</span></span>
    </div>
    <div class="controls">
      <select id="camSelect" title="Camera" style="min-width:180px"></select>
      <button id="startBtn" class="primary" data-i18n="start">🎥 Hap kamerën</button>
      <button id="flipBtn" class="ghost">↺ Flip</button>
      <button id="stopBtn" class="ghost">■ Stop</button>
      <button id="torchBtn" class="accent">🔦 Ndiz Fenerin</button>
    </div>
  </section>

  <ul id="list" aria-live="polite"></ul>

  <div class="row" style="max-width:700px;margin:10px auto">
    <input id="manualInput" placeholder="Shkruaj kodin manualisht (p.sh. L8KQ)" style="flex:1;padding:10px;border-radius:10px;border:1px solid #2a3140;background:#0f141f;color:#e7e9ee">
    <button id="addBtn" class="primary">➕ <span data-i18n="add">Shto</span></button>
  </div>
</main>

<div class="fab">
  <div class="row">
    <button id="copyBtn" class="btn" style="background:var(--brand);color:#fff">⇪ <span data-i18n="share">Ndaj / Kopyo</span></button>
    <button id="waBtn" class="btn wa">WhatsApp</button>
    <button id="clearBtn" class="btn danger"><span data-i18n="clear">Pastro listën</span></button>
  </div>
</div>

<div id="snack"></div>
<div id="notify"></div>

<script>
/* ======================= I18N ======================= */
const I18N = {
  sq:{title:"Skano Kodet", hint:"Hap kamerën dhe afro kodin.", start:"🎥 Hap kamerën",
      share:"Ndaj / Kopyo", clear:"Pastro listën", add:"Shto",
      already:"Tashmë i lexuar: ", added:"U shtua: ", copied:"Lista u kopjua.", cleared:"Lista u pastrua.", none:"Ende s’ka kod."},
  tr:{title:"Barkod Tara", hint:"Kamerayı aç ve barkodu yaklaştır.", start:"🎥 Kamerayı Aç",
      share:"Paylaş / Kopyala", clear:"Listeyi Temizle", add:"Ekle",
      already:"Zaten okundu: ", added:"Eklendi: ", copied:"Liste kopyalandı.", cleared:"Liste temizlendi.", none:"Henüz kod yok."},
  en:{title:"Scan Codes", hint:"Open camera and show the code.", start:"🎥 Start Camera",
      share:"Share / Copy", clear:"Clear List", add:"Add",
      already:"Already scanned: ", added:"Added: ", copied:"List copied.", cleared:"List cleared.", none:"No codes yet."}
};
let lang = localStorage.getItem("qr_lang") || "sq";
function applyLang(L){
  lang=L; localStorage.setItem("qr_lang",L);
  title.textContent = I18N[L].title;
  hint.textContent = I18N[L].hint;
  document.querySelector('[data-i18n="start"]').textContent = I18N[L].start;
  document.querySelector('[data-i18n="share"]').textContent = I18N[L].share;
  document.querySelector('[data-i18n="clear"]').textContent = I18N[L].clear;
  document.querySelector('[data-i18n="add"]').textContent = I18N[L].add;
  document.querySelectorAll(".lang button").forEach(b=>b.classList.toggle("active", b.dataset.lang===L));
}
document.querySelectorAll(".lang button").forEach(b=>b.addEventListener("click",()=>applyLang(b.dataset.lang)));
applyLang(lang);

/* ======================= STATE ======================= */
const LS_LIST="qr_scanned_codes_v1", LS_CAM="qr_last_cam";
let scanned = JSON.parse(localStorage.getItem(LS_LIST) || "[]");
let html5=null, cameras=[], currentCamId=null, torchOn=false, lastTxt="", lastTs=0;

/* ======================= AUDIO ======================= */
let audioCtx;
function ensureAudio(){
  if(!audioCtx){ const AC = window.AudioContext||window.webkitAudioContext; if(AC) audioCtx=new AC(); }
  if(audioCtx && audioCtx.state==="suspended") audioCtx.resume();
}
function beep(freq=880, ms=120){
  if(!audioCtx) return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type="sine"; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination);
  g.gain.setValueAtTime(0.12, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + ms/1000);
  o.start(); o.stop(audioCtx.currentTime + ms/1000);
}
function okSound(){ beep(880,120); }
function errSound(){ beep(280,160); setTimeout(()=>beep(180,160),160); }

/* ======================= HELPERS ======================= */
function extractCode(text){
  try{
    const u=new URL(text);
    const last=u.pathname.split("/").filter(Boolean).pop()||"";
    if(last.length>=4) return last.slice(-4).toUpperCase();
  }catch(_){}
  return (text.replace(/[^A-Za-z0-9]/g,"")).slice(-4).toUpperCase();
}
function save(){ localStorage.setItem(LS_LIST, JSON.stringify(scanned)); render(); }
function render(){
  const ul = document.getElementById("list");
  ul.innerHTML="";
  if(scanned.length===0){
    const li=document.createElement("li"); li.className="muted"; li.textContent=I18N[lang].none; ul.appendChild(li);
  }else{
    scanned.forEach((c,i)=>{
      const li=document.createElement("li");
      const left=document.createElement("span"); left.innerHTML=<span class="idx">${i+1}.</span> <strong>${c}</strong>;
      const del=document.createElement("button"); del.className="del"; del.textContent="❌";
      del.onclick=()=>{ if(confirm("Sigur / Emin misin / Sure?")){ scanned.splice(i,1); save(); snack(I18N[lang].added.replace(/.*/,"")+c+" ✖", false); } };
      li.appendChild(left); li.appendChild(del); ul.appendChild(li);
    });
  }
  document.getElementById("count").textContent = scanned.length;
}
function snack(msg, ok=true){
  const s=document.getElementById("snack");
  s.textContent=msg; s.className= ok ? "ok":"err";
  s.style.top="14px"; setTimeout(()=>s.style.top="-80px", 1700);
}
function flashGreen(){ overlay.style.borderColor="var(--ok)"; overlay.style.boxShadow="0 0 0 9999px #1ecb4f22"; setTimeout(()=>{overlay.style.borderColor="transparent"; overlay.style.boxShadow="none";},420); }
function flashRed(){ overlay.style.borderColor="var(--err)"; overlay.style.boxShadow="0 0 0 9999px #ff4d4f22"; setTimeout(()=>{overlay.style.borderColor="transparent"; overlay.style.boxShadow="none";},520); }
function qrBox(){ const w=Math.min(520, Math.floor(window.innerWidth*0.92)); const h=Math.floor(window.innerHeight*0.70); return Math.min(w,h); }

/* ======================= CAMERA ======================= */
async function enumerateCameras(){
  try{
    cameras = await Html5Qrcode.getCameras();
    camSelect.innerHTML = cameras.map(c=><option value="${c.id}">${c.label||"Camera"}</option>).join("");
    const last = localStorage.getItem(LS_CAM);
    const back = cameras.find(c=>/back|rear|environment/i.test(c.label||""));
    if(last && cameras.find(c=>c.id===last)){ camSelect.value=last; currentCamId=last; }
    else if(back){ camSelect.value=back.id; currentCamId=back.id; }
    else if(cameras[0]){ camSelect.value=cameras[0].id; currentCamId=cameras[0].id; }
  }catch(e){ snack("No camera found / Kamera yok", false); }
}
async function start(camId){
  ensureAudio();
  try{ if(html5){ await html5.stop(); } }catch(_){}
  html5 = new Html5Qrcode("reader");
  const config={ fps:12, qrbox:{ width: qrBox(), height: qrBox() } };
  const device = camId ? { deviceId:{ exact: camId } } : { facingMode:"environment" };
  await html5.start(device, config, onScan, (e)=>{ /* frame error ignore */ });
  currentCamId = camId || currentCamId;
  if(currentCamId) localStorage.setItem(LS_CAM, currentCamId);
  torchOn=false; torchBtn.textContent = "🔦 "+(lang==="sq"?"Ndiz Fenerin":lang==="tr"?"Feneri Aç":"Toggle Torch");
}
async function stop(){ if(html5){ try{ await html5.stop(); }catch(_){ } } }

/* ======================= SCAN CALLBACK ======================= */
function onScan(decodedText){
  // debounce
  const now=Date.now(); if(now-lastTs<450 && decodedText===lastTxt) return; lastTs=now; lastTxt=decodedText;

  const code = extractCode(decodedText);
  if(!code) return;

  if(scanned.includes(code)){
    errSound(); flashRed(); snack(I18N[lang].already + code, false);
    return;
  }
  scanned.push(code); save(); okSound(); flashGreen(); snack(I18N[lang].added + code, true);
}

/* ======================= BUTTONS ======================= */
startBtn.addEventListener("click", async ()=>{
  try{
    // permission poke (iOS Safari requires a user gesture)
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
    stream.getTracks().forEach(t=>t.stop());
  }catch(e){
    snack("Kamera izni gerekli / Leje e kamerës", false);
  }
  await enumerateCameras();
  await start(camSelect.value || null);
});
stopBtn.addEventListener("click", stop);
flipBtn.addEventListener("click", async ()=>{
  if(!cameras.length) await enumerateCameras();
  if(!cameras.length) return;
  const idx = Math.max(0, cameras.findIndex(c=>c.id===camSelect.value));
  const next = cameras[(idx+1)%cameras.length];
  camSelect.value = next.id;
  await start(next.id);
});
camSelect.addEventListener("change", ()=> start(camSelect.value));

torchBtn.addEventListener("click", async ()=>{
  try{
    const video = document.querySelector("#reader video");
    const track = video && video.srcObject && video.srcObject.getVideoTracks ? video.srcObject.getVideoTracks()[0] : null;
    if(!track){ snack("Hap kamerën / Kamerayı aç", false); return; }
    const caps = track.getCapabilities ? track.getCapabilities() : null;
    if(!caps || (!caps.torch && !caps.fillLightMode)){ snack("Fener desteklenmiyor", false); return; }
    await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
    torchOn = !torchOn;
    torchBtn.textContent = torchOn ? (lang==="sq"?"🔦 Fik Fenerin":lang==="tr"?"🔦 Feneri Kapat":"🔦 Torch Off")
                                   : (lang==="sq"?"🔦 Ndiz Fenerin":lang==="tr"?"🔦 Feneri Aç":"🔦 Torch On");
  }catch(e){ snack("Torch error", false); }
});

copyBtn.addEventListener("click", async ()=>{
  const text = scanned.map((c,i)=>${i+1}. ${c}).join("\n");
  if(navigator.share){ try{ await navigator.share({ text }); return; }catch(_){} }
  await navigator.clipboard.writeText(text);
  snack(I18N[lang].copied, true);
});
waBtn.addEventListener("click", ()=> {
  const text = encodeURIComponent(scanned.map((c,i)=>${i+1}. ${c}).join("\n"));
  open("https://wa.me/?text="+text, "_blank");
});
clearBtn.addEventListener("click", ()=>{
  if(!confirm(lang==="sq"?"Je i sigurt?":"Emin misin? / Sure?")) return;
  scanned=[]; save(); snack(I18N[lang].cleared, true);
});
addBtn.addEventListener("click", ()=>{
  let v = (manualInput.value||"").trim().toUpperCase();
  if(!v) return;
  if(v.length>4) v=v.slice(-4);
  if(scanned.includes(v)){ snack(I18N[lang].already + v, false); return; }
  scanned.push(v); save(); manualInput.value=""; snack(I18N[lang].added + v, true);
});

/* ======================= INIT ======================= */
render();
applyLang(lang);
// Tip: HTTPS & iframe uyarısı
if(location.protocol!=="https:"){ snack("Use HTTPS / Përdor HTTPS", false); }
if(window.top!==window.self){ snack("Open outside iframe", false); }
// Resize ile kutu boyutu ayarı
addEventListener("resize", ()=>{ if(html5){ start(currentCamId||null); }});
</script>
</body>
</html>
