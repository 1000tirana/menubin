<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Skano Kodet</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  :root{
    --bg:#0f1115; --card:#151a22; --edge:#232b3b; --txt:#e8ecf2; --muted:#9aa3b2;
    --brand:#3b82f6; --ok:#1ecb4f; --err:#ff4d4f;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:10;background:rgba(15,17,21,.9);backdrop-filter:blur(10px);
    border-bottom:1px solid var(--edge);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  header h1{margin:0;font-size:16px;letter-spacing:.2px}
  .lang{display:flex;gap:6px}
  .lang button{padding:6px 10px;border:1px solid var(--edge);background:#1a2030;color:var(--txt);
    border-radius:8px;cursor:pointer;font-weight:600}
  .lang button.active{border-color:var(--brand);box-shadow:0 0 0 2px #1e40af33}
  main{max-width:960px;margin:0 auto;padding:12px}
  #card{position:relative;background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:12px}
  #reader{width:100%;aspect-ratio:3/4;max-height:70vh}
  @media (orientation:landscape){#reader{aspect-ratio:16/9;max-height:62vh}}
  #overlay{position:absolute;inset:12px;border:6px solid transparent;border-radius:12px;pointer-events:none;transition:border-color .18s, box-shadow .18s}
  .bar{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:10px 0}
  .pill{background:#1a2030;border:1px solid var(--edge);color:var(--muted);padding:6px 10px;border-radius:999px}
  .counter{font-weight:700;color:var(--txt)}
  .controls{display:flex;gap:8px;justify-content:center;margin-top:8px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--edge);background:#222a3b;color:var(--txt);cursor:pointer}
  .btn.primary{background:var(--brand);border:0;color:#fff}
  .btn.ghost{background:#1a2030}
  ul#list{list-style:none;padding:0;margin:14px 0;background:var(--card);border:1px solid var(--edge);border-radius:12px}
  #list li{padding:10px 12px;border-top:1px solid #1f2737} #list li:first-child{border-top:0}
  #list .idx{opacity:.6;margin-right:8px}
  .actions{position:sticky;bottom:0;background:rgba(15,17,21,.9);backdrop-filter:blur(10px);
    padding:10px;border-top:1px solid var(--edge)}
  .row{display:flex;gap:10px}
  .row .btn{flex:1}
  .btn.wa{background:#25D366;color:#072b10;border:0}
  .btn.danger{background:transparent;color:#ffb4b4}
  #snack{position:fixed;left:50%;transform:translateX(-50%);top:-80px;z-index:9999;background:#1a2030;
    border:1px solid var(--edge);padding:10px 16px;border-radius:10px;transition:top .35s;font-weight:700}
  #snack.ok{border-color:#1e5b2a;color:#d9ffe6} #snack.err{border-color:#5b2323;color:#ffd6d6}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1 id="title">Skano Kodet</h1>
  <div class="lang">
    <button data-lang="sq" class="active">SQ</button>
    <button data-lang="tr">TR</button>
    <button data-lang="en">EN</button>
  </div>
</header>

<main>
  <section id="card">
    <div id="reader"></div>
    <div id="overlay"></div>
    <div class="bar">
      <span class="pill" id="hint">Hap kamerÃ«n dhe afro kodin.</span>
      <span class="pill counter" id="count">0</span>
    </div>
    <div class="controls">
      <button id="startBtn" class="btn primary" data-i18n="start">ðŸŽ¥ Hap kamerÃ«n</button>
      <button id="flipBtn" class="btn ghost">â†º Flip</button>
      <button id="stopBtn" class="btn ghost">â–  Stop</button>
    </div>
  </section>

  <ul id="list" aria-live="polite"></ul>
</main>

<div class="actions">
  <div class="row">
    <button id="copyBtn" class="btn primary">â‡ª <span data-i18n="share">Ndaj / Kopyo</span></button>
    <button id="waBtn" class="btn wa">WhatsApp</button>
    <button id="clearBtn" class="btn danger"><span data-i18n="clear">Pastro listÃ«n</span></button>
  </div>
</div>

<div id="snack" role="status" aria-live="assertive">OK</div>

<script>
/* ===== Dil (sadece metinler; mantÄ±ÄŸa dokunmuyoruz) ===== */
const I18N = {
  sq:{title:"Skano Kodet",hint:"Hap kamerÃ«n dhe afro kodin.",share:"Ndaj / Kopyo",clear:"Pastro listÃ«n",none:"Ende sâ€™ka kod.",start:"ðŸŽ¥ Hap kamerÃ«n",added:"U shtua: ",already:"TashmÃ« i lexuar: "},
  tr:{title:"Barkod Tara",hint:"KamerayÄ± aÃ§ ve barkodu yaklaÅŸtÄ±r.",share:"PaylaÅŸ / Kopyala",clear:"Listeyi Temizle",none:"HenÃ¼z kod yok.",start:"ðŸŽ¥ KamerayÄ± AÃ§",added:"Eklendi: ",already:"Zaten okundu: "},
  en:{title:"Scan Codes",hint:"Open camera and show the code.",share:"Share / Copy",clear:"Clear List",none:"No codes yet.",start:"ðŸŽ¥ Start Camera",added:"Added: ",already:"Already scanned: "}
};
let lang = localStorage.getItem("qr_lang") || "sq";
function applyLang(L){
  lang=L; localStorage.setItem("qr_lang",L);
  document.getElementById("title").textContent=I18N[L].title;
  document.getElementById("hint").textContent=I18N[L].hint;
  document.querySelector('[data-i18n="share"]').textContent=I18N[L].share;
  document.querySelector('[data-i18n="clear"]').textContent=I18N[L].clear;
  document.querySelector('[data-i18n="start"]').textContent=I18N[L].start;
  document.querySelectorAll(".lang button").forEach(b=>b.classList.toggle("active", b.dataset.lang===L));
}
document.querySelectorAll(".lang button").forEach(b=>b.addEventListener("click",()=>applyLang(b.dataset.lang)));
applyLang(lang);

/* ===== Basit & saÄŸlam state (ilk koddaki gibi) ===== */
const LS_KEY = "qr_scanned_codes_v1";
let scanned = JSON.parse(localStorage.getItem(LS_KEY)||"[]");
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(scanned)); render(); }
function render(){
  const ul=document.getElementById("list"); ul.innerHTML="";
  if(scanned.length===0){ const li=document.createElement("li"); li.className="muted"; li.textContent=I18N[lang].none; ul.appendChild(li); }
  else{ scanned.forEach((c,i)=>{ const li=document.createElement("li"); li.innerHTML=<span class="idx">${i+1}.</span> <strong>${c}</strong>; ul.appendChild(li); }); }
  document.getElementById("count").textContent=scanned.length;
}
render();

/* ===== Sesler: minimal bip (iOS uyumlu olmasÄ± iÃ§in WebAudio deÄŸil, kÄ±sa simple) ===== */
let audioCtx;
function unlockAudio(){ if(!audioCtx){ const AC=window.AudioContext||window.webkitAudioContext; if(AC) audioCtx=new AC(); } if(audioCtx&&audioCtx.state==="suspended") audioCtx.resume(); }
function beep(f=900,ms=120){ if(!audioCtx) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type="sine"; o.frequency.value=f; o.connect(g); g.connect(audioCtx.destination); g.gain.value=.12; o.start(); setTimeout(()=>{g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+.05); o.stop();}, ms); }
function okBeep(){ beep(900,120); }
function errBeep(){ beep(260,160); setTimeout(()=>beep(180,160),170); }

/* ===== Ã‡ekirdek: html5-qrcode â€” ilk Ã§alÄ±ÅŸan mantÄ±k ===== */
let qr = null;
let facing = "environment"; // sadece environment <-> user
const overlay = document.getElementById("overlay");
function flashGreen(){ overlay.style.borderColor="var(--ok)"; overlay.style.boxShadow="0 0 0 9999px #1ecb4f22"; setTimeout(()=>{overlay.style.borderColor="transparent"; overlay.style.boxShadow="none";}, 420); }
function flashRed(){ overlay.style.borderColor="var(--err)"; overlay.style.boxShadow="0 0 0 9999px #ff4d4f22"; setTimeout(()=>{overlay.style.borderColor="transparent"; overlay.style.boxShadow="none";}, 520); }

function extractCode(text){
  try{ const u=new URL(text); const last=u.pathname.split("/").filter(Boolean).pop()||""; if(last.length>=4) return last.slice(-4).toUpperCase(); }catch(_){}
  return (text.replace(/[^A-Za-z0-9]/g,"")).slice(-4).toUpperCase();
}

function onScanSuccess(decodedText){
  const code = extractCode(decodedText);
  if(!code) return;
  if(scanned.includes(code)){ errBeep(); flashRed(); snack(I18N[lang].already+code, false); return; }
  scanned.push(code); save(); okBeep(); flashGreen(); snack(I18N[lang].added+code, true);
}

function snack(msg, ok=true){
  const s=document.getElementById("snack");
  s.textContent=msg; s.className= ok ? "ok" : "err";
  s.style.top="14px"; setTimeout(()=>s.style.top="-80px", 1600);
}

async function startCamera(){
  unlockAudio();
  if(qr){ try{ await qr.stop(); }catch(_){} }
  qr = new Html5Qrcode("reader");
  const box = Math.min(Math.floor(window.innerWidth*0.92), Math.floor(window.innerHeight*0.70));
  // * Ä°lk Ã§alÄ±ÅŸan Ã§aÄŸrÄ± ÅŸekli: facingMode ile basit baÅŸlatma *
  await qr.start({ facingMode: facing }, { fps: 10, qrbox: box }, onScanSuccess);
}
async function stopCamera(){ if(qr){ try{ await qr.stop(); }catch(_){} } }

/* ===== Butonlar ===== */
document.getElementById("startBtn").addEventListener("click", startCamera);
document.getElementById("stopBtn").addEventListener("click", stopCamera);
document.getElementById("flipBtn").addEventListener("click", async ()=>{
  facing = (facing === "environment") ? "user" : "environment";
  await startCamera();
});
document.getElementById("copyBtn").addEventListener("click", async ()=>{
  const text = scanned.map((c,i)=>${i+1}. ${c}).join("\n");
  if(navigator.share){ try{ await navigator.share({text}); return;}catch(_){ } }
  await navigator.clipboard.writeText(text); snack("Kopjuar / KopyalandÄ± / Copied", true);
});
document.getElementById("waBtn").addEventListener("click", ()=>{
  const text = encodeURIComponent(scanned.map((c,i)=>${i+1}. ${c}).join("\n"));
  window.open("https://wa.me/?text="+text,"_blank");
});
document.getElementById("clearBtn").addEventListener("click", ()=>{
  if(!confirm("Pastro? / Temizle? / Clear?")) return;
  scanned=[]; save(); snack("Pastruar / Temizlendi / Cleared", true);
});

/* ===== Resize olduÄŸunda kutu oranÄ±nÄ± koru (isteÄŸe baÄŸlÄ±) ===== */
window.addEventListener("resize", ()=>{ if(qr){ startCamera(); }});
</script>
</body>
</html>
