<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>QR Liste</title>
<style>
  body{margin:0;background:#0f1115;color:#e7ebf5;font-family:sans-serif}
  header{padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
  .pill{padding:4px 10px;border-radius:999px;background:#1f2430;color:#a9b1c3;font-size:12px}
  .video-wrap{position:relative;aspect-ratio:3/4;background:#000;border-radius:12px;overflow:hidden}
  video{width:100%;height:100%;object-fit:cover}
  .scan-frame{position:absolute;inset:10%;border:2px solid rgba(255,255,255,.6);border-radius:12px}
  .glow-green{box-shadow:0 0 0 9999px rgba(0,255,0,.15) inset,0 0 20px #0f0 inset;border-color:#0f0}
  .glow-red{box-shadow:0 0 0 9999px rgba(255,0,0,.15) inset,0 0 20px #f00 inset;border-color:#f00}
  .controls{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px}
  button{border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn-primary{background:#29c06f;color:#000}
  .btn-danger{background:#ff5d5d;color:#000}
  .btn-warn{background:#ffc53d;color:#000}
  .list-card{margin-top:16px;background:#171a21;border-radius:14px;padding:8px 0}
  .item{display:flex;gap:12px;align-items:center;padding:12px 14px;border-bottom:1px dashed #23293a}
  .item:last-child{border-bottom:none}
  .index{width:32px;height:32px;border-radius:999px;background:#242a39;display:flex;
    align-items:center;justify-content:center;font-weight:800;color:#c0c7d9}
  .value{flex:1;font-size:18px;font-weight:800}
  .del-btn{background:#23293a;color:#ff9b9b;border-radius:8px;padding:2px 6px}
  .toolbar{position:fixed;left:0;right:0;bottom:0;display:flex;gap:10px;
    padding:10px;background:rgba(10,12,16,.9)}
  .toolbar .btn{flex:1}
  .manual{display:flex;gap:8px;margin-top:10px}
  .manual input{flex:1;padding:10px;background:#1b2030;border:1px solid #2a3246;color:#fff;border-radius:8px}
</style>
</head>
<body>
<header>
  <div><strong>QR Liste</strong> <span id="camStatus" class="pill">Kamera: Kapalı</span></div>
</header>

<div class="video-wrap">
  <video id="video" playsinline muted></video>
  <div id="scanFrame" class="scan-frame"></div>
</div>

<div class="controls">
  <button id="startBtn" class="btn-primary">Başlat</button>
  <button id="stopBtn">Durdur</button>
  <button id="switchBtn">Kamera Değiştir</button>
  <button id="torchBtn">Flaş</button>
  <button id="resetBtn" class="btn-danger">Temizle</button>
</div>
<div class="manual">
  <input id="manualInput" type="text" placeholder="Kod yaz...">
  <button id="manualAddBtn" class="btn-warn">Ekle</button>
</div>

<div class="list-card">
  <ul id="list"></ul>
</div>

<div class="toolbar">
  <button id="copyBtn" class="btn">Kopyala</button>
  <button id="waBtn" class="btn">WhatsApp</button>
</div>

<canvas id="capture"></canvas>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
const video=document.getElementById('video'),canvas=document.getElementById('capture'),
ctx=canvas.getContext('2d',{willReadFrequently:true}),listEl=document.getElementById('list'),
scanFrame=document.getElementById('scanFrame'),camStatus=document.getElementById('camStatus');
let stream=null,track=null,scanning=false,lastScanAt=0,items=[],seen=new Set(),torchOn=false,facing="environment";

function last4(s){return (s||"").replace(/[^0-9A-Za-z]/g,"").slice(-4).toUpperCase();}
function flashOverlay(dup){scanFrame.classList.remove("glow-green","glow-red");scanFrame.offsetWidth;
 scanFrame.classList.add(dup?"glow-red":"glow-green");
 setTimeout(()=>scanFrame.classList.remove("glow-green","glow-red"),350);}
function addCode(v){const dup=seen.has(v);if(!dup){seen.add(v);items.push(v);render();save();}
 flashOverlay(dup);}
function render(){listEl.innerHTML="";items.forEach((v,i)=>{const li=document.createElement("li");
 li.className="item";li.innerHTML=`<div class="index">${i+1}</div><div class="value">${v}</div>
 <button class="del-btn">×</button>`;li.querySelector(".del-btn").onclick=()=>{
  if(confirm("Silmek istediğine emin misin?")){items.splice(i,1);seen=new Set(items);render();save();}};
 listEl.appendChild(li);});}
function exportText(){return items.map((v,i)=>${i+1}. ${v}).join("\n");}
async function startCam(){stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:facing}});
 video.srcObject=stream;await video.play();scanning=true;camStatus.textContent="Kamera: Açık";
 track=stream.getVideoTracks()[0];torchBtn.disabled=!(track.getCapabilities&&track.getCapabilities().torch);
 scanLoop();}
function stopCam(){scanning=false;if(stream)stream.getTracks().forEach(t=>t.stop());video.srcObject=null;camStatus.textContent="Kamera: Kapalı";}
async function toggleTorch(){if(!track)return;torchOn=!torchOn;await track.applyConstraints({advanced:[{torch:torchOn}]});}
function switchCam(){facing=facing==="environment"?"user":"environment";stopCam();startCam();}
async function scanLoop(){if(!scanning)return;const now=performance.now();if(now-lastScanAt<150)return requestAnimationFrame(scanLoop);
 lastScanAt=now;if(video.readyState>=2){canvas.width=video.videoWidth;canvas.height=video.videoHeight;ctx.drawImage(video,0,0,canvas.width,canvas.height);
 const img=ctx.getImageData(0,0,canvas.width,canvas.height);const qr=jsQR(img.data,canvas.width,canvas.height);
 if(qr&&qr.data)addCode(last4(qr.data.trim()));}requestAnimationFrame(scanLoop);}
function save(){localStorage.setItem("qrItems",JSON.stringify(items));}
function load(){const r=localStorage.getItem("qrItems");if(r){items=JSON.parse(r);seen=new Set(items);render();}}
document.getElementById('startBtn').onclick=startCam;
document.getElementById('stopBtn').onclick=stopCam;
document.getElementById('torchBtn').onclick=toggleTorch;
document.getElementById('switchBtn').onclick=switchCam;
document.getElementById('resetBtn').onclick=()=>{if(confirm("Liste temizlensin mi?")){items=[];seen.clear();render();save();}};
document.getElementById('manualAddBtn').onclick=()=>{const v=last4(document.getElementById('manualInput').value);if(v)addCode(v);document.getElementById('manualInput').value="";};
document.getElementById('copyBtn').onclick=()=>navigator.clipboard.writeText(exportText());
document.getElementById('waBtn').onclick=()=>window.open("https://wa.me/?text="+encodeURIComponent(exportText()));
load();
</script>
</body>
</html>
