<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>QR/Barkod Listesi</title>
<style>
  :root{--bg:#0e0f12;--panel:#14161b;--soft:#1c1f26;--soft2:#0b0c10;--text:#e7ecf7;--muted:#9aa3b2;--accent:#22c55e;--danger:#ef4444;--chip:#2a2f3a}
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,var(--bg),#0b0c10 40%,#0a0b0f);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:720px;margin:14px auto 60px;padding:10px}
  .card{background:linear-gradient(180deg,var(--panel),var(--soft));border:1px solid #1a1f28;border-radius:22px;padding:14px 14px 18px;box-shadow:0 10px 28px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.03)}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}.space{flex:1}.title{font-weight:800;font-size:20px}
  .chip{background:var(--chip);color:#cfd7e6;padding:6px 10px;border-radius:999px;font-size:13px;border:1px solid #2e3440;display:flex;gap:8px;cursor:pointer}
  .flags{display:flex;gap:10px;font-size:20px;cursor:pointer}
  .scanner{margin-top:12px;background:var(--soft2);border-radius:18px;padding:14px;border:1px solid #222833}
  .scanbox{position:relative;width:100%;aspect-ratio:1/1;border-radius:14px;display:grid;place-items:center;overflow:hidden;background:#0b0d11;border:2px solid #2d3441}
  video{width:100%;height:100%;object-fit:cover;display:none}
  .frame{position:absolute;inset:18px;border:3px solid rgba(255,255,255,.25);border-radius:14px}
  canvas.overlay{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
  .buttons{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap}
  .btn{flex:1 1 120px;padding:13px 16px;border-radius:12px;text-align:center;font-weight:700;border:0;cursor:pointer;transition:transform .06s}
  .btn:active{transform:translateY(1px)} .green{background:var(--accent);color:#071108}.gray{background:#333a46;color:#e5ecf7}.red{background:var(--danger);color:#fff}
  .btn[disabled]{opacity:.45;pointer-events:none}
  .list{margin-top:16px;background:linear-gradient(180deg,var(--panel),var(--soft));border-radius:18px;padding:14px;border:1px solid #1a1f28}
  .hd{display:flex;align-items:center;gap:10px;font-weight:800;margin-bottom:10px}.count{opacity:.75}
  .item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;background:#11141a;border:1px solid #222833;border-radius:12px;padding:10px 12px;margin-bottom:10px}
  .badge{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:#272e3a;color:#cfe0ff;font-weight:800}
  .code{font-weight:900;letter-spacing:.5px}.time{color:var(--muted);font-size:12px}
  .del{width:30px;height:30px;border-radius:10px;background:#212733;color:#ff7b86;display:grid;place-items:center;cursor:pointer;border:1px solid #2f3542}
  .foot{display:flex;gap:14px;margin-top:14px}.footbtn{flex:1;background:#1b2029;color:#e5ecf7;border:1px solid #2a3140;border-radius:14px;padding:14px 16px;font-weight:800;cursor:pointer}
  .camselect{position:absolute;z-index:5;margin-top:6px;background:#0f1218;border:1px solid #2d3441;border-radius:12px;padding:10px;display:none;max-width:min(92vw,560px)}
  .camselect select{width:100%;background:#121620;color:#dfe3eb;border:1px solid #2a3140;border-radius:10px;padding:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row" style="position:relative">
      <div class="title" id="t-title">QR/Barkod Listesi</div>
      <div class="chip" id="camChip">Kamera: <strong id="camName">KapalÄ±</strong></div>
      <div class="space"></div>
      <div class="flags">
        <span role="button" data-lang="sq">ðŸ‡¦ðŸ‡±</span>
        <span role="button" data-lang="en">ðŸ‡¬ðŸ‡§</span>
        <span role="button" data-lang="tr">ðŸ‡¹ðŸ‡·</span>
      </div>
      <div class="camselect" id="camSelectWrap"><select id="cameraSelect"></select></div>
    </div>

    <div class="scanner">
      <div class="scanbox" id="scanbox">
        <video id="video" playsinline muted></video>
        <canvas id="overlay" class="overlay"></canvas>
        <div class="frame"></div>
      </div>
      <div class="buttons">
        <button class="btn green" id="btnStart">BaÅŸlat</button>
        <button class="btn gray"  id="btnStop" disabled>Durdur</button>
        <button class="btn gray"  id="btnFlash" disabled>IÅŸÄ±k</button>
        <button class="btn red"   id="btnClear">Temizle</button>
      </div>
    </div>

    <div class="list">
      <div class="hd"><span id="t-lista">Liste</span> <span class="count">Â· <span id="count">0</span></span></div>
      <div id="items"></div>
      <div class="foot">
        <button class="footbtn" id="btnCopy">Kopyala</button>
        <button class="footbtn" id="btnWa">WhatsApp</button>
      </div>
    </div>
  </div>
</div>

<!-- Sesler -->
<audio id="snd-ok"><source type="audio/mp3" src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAACQAAABJb2tp/////w8AAP//AAC//wAAAP//AACAgP//AAAAAP//AP8A//8AAA=="></audio>
<audio id="snd-err"><source type="audio/mp3" src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAACQAAABFcnJvcn////8PAAD//wAA//8AAAD//wAAgID//wAAAAD//wD/AP//AAAA"></audio>

<!-- jsQR (fallback iÃ§in) -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
(() => {
  // ============= Elemanlar & metinler
  const E = (id)=>document.getElementById(id);
  const els = {title:E('t-title'), camChip:E('camChip'), camName:E('camName'), camSelWrap:E('camSelectWrap'),
               camSel:E('cameraSelect'), video:E('video'), overlay:E('overlay'), start:E('btnStart'),
               stop:E('btnStop'), flash:E('btnFlash'), clear:E('btnClear'), items:E('items'), count:E('count'),
               copy:E('btnCopy'), wa:E('btnWa'), sndOk:E('snd-ok'), sndErr:E('snd-err'), scanbox:E('scanbox')};

  const i18n = {
    tr:{title:'QR/Barkod Listesi', start:'BaÅŸlat', stop:'Durdur', light:'IÅŸÄ±k', clear:'Temizle', list:'Liste', copy:'Kopyala'},
    sq:{title:'Lista QR/Bar',     start:'Start',  stop:'Stop',    light:'DritÃ«', clear:'Pastro', list:'Lista', copy:'Kopjo'},
    en:{title:'QR/Barcode List',  start:'Start',  stop:'Stop',    light:'Light', clear:'Clear',  list:'List',  copy:'Copy'}
  };
  let LANG = (localStorage.getItem('qr_meta_v1_lang')||'tr');
  const T = k => (i18n[LANG]||i18n.tr)[k];

  document.querySelectorAll('.flags [data-lang]').forEach(b=>{
    b.addEventListener('click', ()=>{ LANG=b.dataset.lang; syncTexts(); localStorage.setItem('qr_meta_v1_lang',LANG); });
  });
  function syncTexts(){
    els.title.textContent=T('title'); els.start.textContent=T('start'); els.stop.textContent=T('stop');
    els.flash.textContent=T('light'); els.clear.textContent=T('clear'); document.getElementById('t-lista').textContent=T('list');
    els.copy.textContent=T('copy');
  }
  syncTexts();

  // ============= Durum & KalÄ±cÄ± liste
  const LS_KEY='qr_list_items_v2';
  let list = [];
  try{ list=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{}
  render();

  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(list)); }
  function now(){ const d=new Date(); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
  function render(){
    els.items.innerHTML=''; els.count.textContent=list.length;
    list.forEach((x,i)=>{
      const row=document.createElement('div'); row.className='item';
      row.innerHTML=<div class="badge">${i+1}</div><div><div class="code">${x.value}</div><div class="time">${x.time}</div></div><div class="del">âœ•</div>;
      row.querySelector('.del').onclick=()=>{ list.splice(i,1); save(); render(); };
      els.items.appendChild(row);
    });
  }

  // ============= Kamera
  let stream=null, track=null, raf=null, torch=false;
  function setCamLabel(s){ els.camName.textContent=s; }
  async function enumerateCams(){
    const devs=await navigator.mediaDevices.enumerateDevices();
    return devs.filter(d=>d.kind==='videoinput');
  }
  async function start(deviceId){
    try{
      const constraints={video: deviceId?{deviceId:{exact:deviceId}}:{facingMode:{ideal:'environment'}}, audio:false};
      stream=await navigator.mediaDevices.getUserMedia(constraints);
      els.video.srcObject=stream; await els.video.play(); els.video.style.display='block';
      track=stream.getVideoTracks()[0]; setCamLabel(track.getSettings().label||'Kamera');
      const caps=track.getCapabilities?.()||{}; els.flash.disabled=!('torch' in caps);
      els.start.disabled=true; els.stop.disabled=false;
      scanLoop();
    }catch(e){ alert('Kamera aÃ§Ä±lamadÄ±: '+e.message); stop(); }
  }
  function stop(){
    if(raf) cancelAnimationFrame(raf);
    if(track){ try{track.stop();}catch{} track=null; }
    if(stream){ try{stream.getTracks().forEach(t=>t.stop());}catch{} stream=null; }
    els.video.pause(); els.video.removeAttribute('srcObject'); els.video.style.display='none';
    els.flash.disabled=true; setCamLabel('KapalÄ±'); els.start.disabled=false; els.stop.disabled=true;
  }
  async function toggleTorch(){
    if(!track) return; torch=!torch;
    try{ await track.applyConstraints({advanced:[{torch}]}); }catch{ torch=!torch; }
  }

  // ============= Okuma (BarcodeDetector -> jsQR yedeÄŸi)
  const hasBD = 'BarcodeDetector' in window;
  let detector=null;
  if(hasBD){
    try{
      detector=new BarcodeDetector({formats:[
        'qr_code','code_128','code_39','ean_13','ean_8','codabar','pdf417','aztec','data_matrix','upc_a','upc_e'
      ]});
    }catch{}
  }
  const workCanvas=document.createElement('canvas'); const wctx=workCanvas.getContext('2d',{willReadFrequently:true});
  const octx=els.overlay.getContext('2d');

  function drawBox(color){
    octx.clearRect(0,0,els.overlay.width,els.overlay.height);
    const r=els.scanbox.getBoundingClientRect(); els.overlay.width=r.width; els.overlay.height=r.height;
    octx.lineWidth=5; octx.strokeStyle=color; octx.strokeRect(18,18,r.width-36,r.height-36);
    setTimeout(()=>octx.clearRect(0,0,els.overlay.width,els.overlay.height), 600);
  }

  function extractCode(raw){
    if(!raw) return null;
    const s=String(raw).trim();
    const m = s.match(/([A-Za-z0-9]{4})$/);  // sonda 4 alfanÃ¼merik
    if(m) return m[1].toUpperCase();
    if(/^[A-Za-z0-9]{4}$/.test(s)) return s.toUpperCase();
    return null; // 4 haneli deÄŸilse alma
  }

  let lastHitAt = 0;
  function onDetect(raw){
    const code = extractCode(raw);
    if(!code) return;

    const dup = list.some(x=>x.value===code);
    if(dup){
      drawBox('rgba(239,68,68,.95)'); // kÄ±rmÄ±zÄ±
      try{ els.sndErr.currentTime=0; els.sndErr.play(); }catch{}
      lastHitAt=performance.now();
      return;
    }
    list.unshift({value:code, time:now()}); save(); render();
    drawBox('rgba(34,197,94,.95)');        // yeÅŸil
    try{ els.sndOk.currentTime=0; els.sndOk.play(); }catch{}
    lastHitAt=performance.now();
  }

  async function scanLoop(){
    if(!stream) return;
    const vw=els.video.videoWidth, vh=els.video.videoHeight;
    if(vw&&vh){
      workCanvas.width=vw; workCanvas.height=vh;
      wctx.drawImage(els.video,0,0,vw,vh);

      if(detector){
        try{
          const bit=await createImageBitmap(workCanvas);
          const codes=await detector.detect(bit);
          if(codes && codes.length){
            onDetect(codes[0].rawValue || codes[0].rawValueText || codes[0].value);
          }
        }catch{}
      }else{
        const img=wctx.getImageData(0,0,vw,vh);
        const qr=jsQR(img.data,vw,vh,{inversionAttempts:'dontInvert'});
        if(qr){ onDetect(qr.data); }
      }
    }
    raf=requestAnimationFrame(scanLoop);
  }

  // ============= Eventler
  els.start.onclick = async ()=>{
    const cams = await enumerateCams();
    if(cams.length>1){
      els.camSel.innerHTML=cams.map((d,i)=><option value="${d.deviceId}">${d.label||('Kamera '+(i+1))}</option>).join('');
      const r=els.camChip.getBoundingClientRect();
      els.camSelWrap.style.left=r.left+'px'; els.camSelWrap.style.top=(r.bottom+2+scrollY)+'px';
      els.camSelWrap.style.display='block';
      els.camSel.onchange=async ()=>{ els.camSelWrap.style.display='none'; await start(els.camSel.value); };
    }else{
      await start(cams[0]?.deviceId);
    }
  };
  els.camChip.onclick = async ()=>{ const cams=await enumerateCams(); if(cams.length){ els.start.click(); } };
  els.stop.onclick = stop;
  els.flash.onclick = toggleTorch;
  els.clear.onclick = ()=>{ list=[]; save(); render(); };

  els.copy.onclick = async ()=>{
    const text=list.map(x=>x.value).join('\n');
    try{ await navigator.clipboard.writeText(text); alert('KopyalandÄ±'); }catch{ prompt('KopyalayÄ±n:', text); }
  };
  els.wa.onclick = ()=>{
    const text=encodeURIComponent(list.map((x,i)=>${i+1}. ${x.value} (${x.time})).join('\n'));
    open(https://wa.me/?text=${text},'_blank');
  };

  // sayfa deÄŸiÅŸince kamerayÄ± kapat
  addEventListener('pagehide', stop);
})();
</script>
</body>
</html>
