<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Lista QR Â· 4 Shifrat e Fundit</title>
<style>
  :root{
    --bg:#0f1115;
    --card:#171a21;
    --muted:#a9b1c3;
    --text:#e7ebf5;
    --accent:#29c06f;
    --danger:#ff5d5d;
    --warn:#ffc53d;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
  }
  header{
    position:sticky; top:0; z-index:30;
    background:linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,0));
    padding:10px 16px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .flags{display:flex; gap:8px;}
  .flags button{background:none;border:none;font-size:20px;cursor:pointer}
  .app-title{font-size:16px;font-weight:700}
  .pill{padding:4px 10px;border-radius:999px;background:#1f2430;color:#a9b1c3;font-size:12px;}
  .last-scan{
    position:sticky; top:46px; z-index:25;
    display:flex; align-items:center; gap:8px;
    background:#122019; color:#bff4d1;
    border:1px solid #1b3a2b; border-left:4px solid var(--accent);
    margin:6px 12px; border-radius:10px; padding:8px 12px;
    font-size:14px;
  }
  .last-scan.duplicate{background:#2b1515;color:#f8c6c6;border-color:var(--danger)}
  .container{padding:10px 16px 120px 16px; max-width:840px; margin:0 auto;}
  .camera-card{background:var(--card);border-radius:14px;padding:12px;}
  .video-wrap{position:relative;border-radius:12px;overflow:hidden;background:#0a0c10;aspect-ratio:3/4;}
  video{width:100%;height:100%;object-fit:cover;display:block;}
  canvas#capture{display:none;}
  .scan-frame{position:absolute;inset:10%;border:2px solid rgba(255,255,255,.55);border-radius:12px;pointer-events:none;transition: box-shadow .12s, border-color .12s;}
  .glow-green{ box-shadow: 0 0 0 9999px rgba(0,128,0,.18) inset, 0 0 22px rgba(0,255,144,.75) inset; border-color: rgba(0,255,144,.95); }
  .glow-red{ box-shadow: 0 0 0 9999px rgba(255,0,0,.18) inset, 0 0 22px rgba(255,80,80,.9) inset; border-color: rgba(255,90,90,.95); }
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
  button,.btn{appearance:none;border:none;border-radius:12px;background:#222734;color:var(--text);padding:10px 14px;font-size:14px;font-weight:600;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .btn-primary{background:var(--accent);color:#07130e}
  .btn-danger{background:var(--danger);color:#260000}
  .btn-warn{background:var(--warn);color:#221a00}
  .list-card{margin-top:16px;background:var(--card);border-radius:14px;padding:8px 0;}
  .list-header{display:flex;justify-content:space-between;align-items:center;padding:8px 14px;border-bottom:1px solid #242a39;}
  .list{list-style:none;padding:0;margin:0;}
  .item{display:flex;gap:12px;align-items:center;padding:12px 14px;border-bottom:1px dashed #23293a;}
  .item:last-child{border-bottom:none}
  .index{width:32px;height:32px;border-radius:999px;background:#242a39;display:flex;align-items:center;justify-content:center;font-weight:800;color:#c0c7d9;flex:0 0 auto;}
  .value{flex:1;font-size:18px;font-weight:800;letter-spacing:.5px}
  .del-btn{background:#23293a;color:#ff9b9b;border-radius:10px;padding:4px 8px}
  .toolbar{position:fixed;left:0;right:0;bottom:0;z-index:20;backdrop-filter:blur(10px);background:rgba(10,12,16,.8);border-top:1px solid #242a39;padding:10px 16px;display:flex;gap:10px;}
  .toolbar .btn{flex:1;justify-content:center}
  .toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#161d2a;color:#e7f1ff;padding:8px 12px;border-radius:10px;border:1px solid #27324a;display:none;}
  .manual{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;}
  .manual input{flex:1; min-width:160px; background:#1b2030; border:1px solid #2a3246; color:#e7ebf5; padding:10px 12px; border-radius:10px; font-size:14px;}
</style>
</head>
<body>
<header>
  <div><span class="app-title" id="t-title">Lista QR</span> <span id="camStatus" class="pill">Kamera: Mbyllur</span></div>
  <div class="flags">
    <button onclick="setLang('sq')" title="Shqip">ðŸ‡¦ðŸ‡±</button>
    <button onclick="setLang('en')" title="English">ðŸ‡¬ðŸ‡§</button>
    <button onclick="setLang('tr')" title="TÃ¼rkÃ§e">ðŸ‡¹ðŸ‡·</button>
  </div>
</header>

<div id="lastBanner" class="last-scan" style="display:none;">
  <strong id="t-last">I fundit:</strong> <span id="lastValue">â€”</span>
</div>

<div class="container">
  <div class="camera-card">
    <div class="video-wrap">
      <video id="video" playsinline muted></video>
      <div id="scanFrame" class="scan-frame"></div>
    </div>
    <div class="controls">
      <button id="startBtn" class="btn-primary">Start</button>
      <button id="stopBtn" class="btn">Stop</button>
      <button id="torchBtn" class="btn">FlaÅŸ</button>
      <button id="resetBtn" class="btn-danger">Pastro</button>
    </div>
    <div class="manual">
      <input id="manualInput" type="text" maxlength="64" placeholder="Shkruaj kodin...">
      <button id="manualAddBtn" class="btn-warn">Shto</button>
    </div>
  </div>

  <div class="list-card">
    <div class="list-header">
      <div><strong id="t-list">Lista</strong> Â· <span id="count">0</span></div>
    </div>
    <ul id="list" class="list"></ul>
  </div>
</div>

<div class="toolbar">
  <button id="copyBtn" class="btn">Kopjo</button>
  <button id="waBtn" class="btn">WhatsApp</button>
</div>

<canvas id="capture"></canvas>
<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
const $=sel=>document.querySelector(sel);
const video=$('#video'),canvas=$('#capture'),ctx=canvas.getContext('2d',{willReadFrequently:true});
const startBtn=$('#startBtn'),stopBtn=$('#stopBtn'),torchBtn=$('#torchBtn'),resetBtn=$('#resetBtn');
const manualInput=$('#manualInput'),manualAddBtn=$('#manualAddBtn');
const listEl=$('#list'),countEl=$('#count'),lastBanner=$('#lastBanner'),lastValue=$('#lastValue'),scanFrame=$('#scanFrame');
const copyBtn=$('#copyBtn'),waBtn=$('#waBtn'),camStatus=$('#camStatus'),toastEl=$('#toast');
let stream=null,track=null,scanning=false,lastScanAt=0,items=[],torchOn=false;
let seen=new Set(); // track by displayed last4

const langs={
 sq:{title:"Lista QR",camOn:"Kamera: Hap",camOff:"Kamera: Mbyllur",list:"Lista",last:"I fundit:",copied:"Kopjuar!",start:"Start",stop:"Stop",clear:"Pastro",copy:"Kopjo",flash:"DritÃ«",placeholder:"Shkruaj kodin...",add:"Shto",confirmDel:"A jeni i sigurt pÃ«r fshirjen?", confirmClear:"TÃ« pastrohet lista?"},
 en:{title:"QR List",camOn:"Camera: On",camOff:"Camera: Off",list:"List",last:"Last:",copied:"Copied!",start:"Start",stop:"Stop",clear:"Clear",copy:"Copy",flash:"Flash",placeholder:"Type a code...",add:"Add",confirmDel:"Are you sure to delete?", confirmClear:"Clear the whole list?"},
 tr:{title:"QR Liste",camOn:"Kamera: AÃ§Ä±k",camOff:"Kamera: KapalÄ±",list:"Liste",last:"Son:",copied:"KopyalandÄ±!",start:"BaÅŸlat",stop:"Durdur",clear:"Temizle",copy:"Kopyala",flash:"FlaÅŸ",placeholder:"Kod yaz...",add:"Ekle",confirmDel:"Silmek istediÄŸine emin misin?", confirmClear:"Liste tamamen temizlensin mi?"}
};
let curLang="sq";

function setLang(l){
  curLang=l;
  $('#t-title').textContent=langs[l].title;
  $('#t-list').textContent=langs[l].list;
  $('#t-last').textContent=langs[l].last;
  camStatus.textContent=scanning?langs[l].camOn:langs[l].camOff;
  startBtn.textContent=langs[l].start;
  stopBtn.textContent=langs[l].stop;
  resetBtn.textContent=langs[l].clear;
  copyBtn.textContent=langs[l].copy;
  torchBtn.textContent=langs[l].flash;
  manualInput.placeholder=langs[l].placeholder;
  manualAddBtn.textContent=langs[l].add;
  waBtn.textContent="WhatsApp";
}
window.setLang=setLang;

function last4(s){const only=String(s).replace(/[^0-9A-Za-z]/g,'');return only.slice(-4).toUpperCase();}
function beep(freq=880){try{const ac=new (window.AudioContext||window.webkitAudioContext)();const o=ac.createOscillator();const g=ac.createGain();o.type='triangle';o.frequency.value=freq;o.connect(g);g.connect(ac.destination);g.gain.setValueAtTime(0.001,ac.currentTime);g.gain.exponentialRampToValueAtTime(0.2,ac.currentTime+0.02);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+0.15);o.start();o.stop(ac.currentTime+0.16);setTimeout(()=>ac.close(),250);}catch{}}
function showBanner(val,isDup){lastValue.textContent=val||'â€”';lastBanner.style.display='flex';lastBanner.classList.toggle('duplicate', !!isDup);}
function flashOverlay(isDup){scanFrame.classList.remove('glow-green','glow-red');scanFrame.offsetWidth;scanFrame.classList.add(isDup?'glow-red':'glow-green');clearTimeout(scanFrame._t);scanFrame._t=setTimeout(()=>scanFrame.classList.remove('glow-green','glow-red'), 350);}

function pushItem(value){ // value is last4
  const isDup = seen.has(value);
  if(!isDup){
    seen.add(value);
    items.push({value, time:new Date()});
    renderList(); save(); beep(880);
  }else{
    beep(440);
  }
  showBanner(value, isDup);
  flashOverlay(isDup);
}

function addFromScan(raw){ const val=last4(raw); if(val) pushItem(val); }
function addFromManual(){ const raw=manualInput.value.trim(); const val=last4(raw); if(!val){ showToast('â€”'); return; } pushItem(val); manualInput.value=''; }

function renderList(){
  listEl.innerHTML='';
  items.forEach((it,idx)=>{
    const li=document.createElement('li');
    li.className='item';
    li.innerHTML=`
      <div class="index">${idx+1}</div>
      <div class="value">${it.value}</div>
      <button class="del-btn" title="X">Ã—</button>`;
    li.querySelector('.del-btn').onclick=()=>{
      if(confirm(langs[curLang].confirmDel)){
        const val=items[idx].value;
        items.splice(idx,1);
        if(!items.some(x=>x.value===val)) seen.delete(val);
        renderList(); save();
      }
    };
    listEl.appendChild(li);
  });
  countEl.textContent=items.length;
}

function exportText(){
  return items.map((x,i)=>`${i+1}. ${x.value}`).join("\\n");
}

async function startCam(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject=stream;
    await video.play();
    scanning=true;
    camStatus.textContent=langs[curLang].camOn;
    track=stream.getVideoTracks()[0]||null;
    torchOn=false;
    const caps=track && track.getCapabilities ? track.getCapabilities() : {};
    torchBtn.disabled = !(caps && 'torch' in caps);
    scanLoop();
  }catch(e){ alert(e.message||e.name); }
}
function stopCam(){
  scanning=false;
  if(stream){ stream.getTracks().forEach(t=>t.stop()); }
  video.srcObject=null;
  track=null; torchOn=false;
  torchBtn.disabled=true;
  camStatus.textContent=langs[curLang].camOff;
}

async function toggleTorch(){
  if(!track || !track.applyConstraints){ showToast('No torch'); return; }
  const caps=track.getCapabilities ? track.getCapabilities() : {};
  if(!caps.torch){ showToast('Torch not supported'); return; }
  try{
    torchOn=!torchOn;
    await track.applyConstraints({ advanced:[{ torch: torchOn }] });
    showToast(torchOn ? (curLang==='tr'?'FlaÅŸ: AÃ§Ä±k':curLang==='en'?'Flash: On':'Drita: On') : (curLang==='tr'?'FlaÅŸ: KapalÄ±':curLang==='en'?'Flash: Off':'Drita: Off'));
  }catch(e){
    torchOn=false;
    showToast('Torch error');
  }
}

async function scanLoop(){
  if(!scanning) return;
  const now=performance.now();
  if(now-lastScanAt<140){ return requestAnimationFrame(scanLoop); }
  lastScanAt=now;
  if(video.readyState>=2){
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const img=ctx.getImageData(0,0,canvas.width,canvas.height);
    const qr=jsQR(img.data,canvas.width,canvas.height,{inversionAttempts:'dontInvert'});
    if(qr && qr.data){ addFromScan(qr.data.trim()); }
  }
  requestAnimationFrame(scanLoop);
}

function copyAll(){const t=exportText();if(!t){ showToast('â€”'); return; }navigator.clipboard.writeText(t).then(()=>showToast(langs[curLang].copied));}
function whatsapp(){const t=exportText();if(!t){ showToast('â€”'); return; }window.open("https://wa.me/?text="+encodeURIComponent(t),'_blank');}

function save(){localStorage.setItem("qrItems_v4", JSON.stringify(items.map(o=>({value:o.value,time:o.time||new Date()}))));}
function load(){const raw=localStorage.getItem("qrItems_v4");if(raw){try{const arr=JSON.parse(raw)||[];items=arr.map(o=>({value:o.value,time:new Date(o.time)}));items.forEach(x=>seen.add(x.value));renderList();}catch{}}}
function showToast(m){toastEl.textContent=m;toastEl.style.display='block';setTimeout(()=>toastEl.style.display='none',1400);}

// events
startBtn.onclick=startCam;
stopBtn.onclick=stopCam;
torchBtn.onclick=toggleTorch;
resetBtn.onclick=()=>{
  if(confirm(langs[curLang].confirmClear)){
    items=[]; seen.clear(); renderList(); save();
  }
};
manualAddBtn.onclick=addFromManual;
manualInput.addEventListener('keyup',e=>{ if(e.key==='Enter') addFromManual(); });

copyBtn.onclick=copyAll;
waBtn.onclick=whatsapp;

// init
load();
setLang('sq');
if (navigator.permissions && navigator.permissions.query){
  navigator.permissions.query({name:'camera'}).then(p=>{ if(p.state==='granted'){ startCam(); } }).catch(()=>{});
}
</script>
</body>
</html>
