<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="UTF-8">
<title>Lexues Barkodesh</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  /* ----- ORİJİNALİN GÖRSEL İYİLEŞTİRİLMİŞ HALİ ----- */
  body { font-family: Arial, sans-serif; text-align: center; margin: 0; background: #0f1115; color:#e8ecf2; }
  header{background:#151a22; border-bottom:1px solid #232b3b; padding:12px 14px; font-weight:800; letter-spacing:.2px}
  #reader { width: 100%; max-width: 420px; margin: 16px auto; border-radius:12px; overflow:hidden; }
  #resultList { margin: 12px auto 120px; width: 92%; max-width: 520px; text-align: left; background:#161b26; border:1px solid #232b3b; border-radius:12px; padding:0 }
  li { padding: 10px 12px; border-top: 1px solid #222b3a; display:flex; align-items:center; justify-content:space-between; }
  li:first-child{ border-top:0 }
  .btns { position:sticky; bottom:0; background:rgba(15,17,21,.9); backdrop-filter:blur(8px); border-top:1px solid #232b3b; padding:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
  button { padding: 10px 14px; margin: 0; border: none; border-radius: 10px; cursor: pointer; font-weight:700 }
  #copyBtn { background: #3b82f6; color: #fff; }
  #whatsappBtn { background: #25D366; color: #072b10; }
  /* Ek butonlar */
  #clearAllBtn{ background:#e74c3c; color:#fff; }
  #flashBtn{ background:#facc15; color:#1a1a00; }
  #manualInput{ flex:1 1 200px; padding:10px; border-radius:10px; border:1px solid #2a364a; background:#0f141f; color:#e8ecf2}
  #addBtn{ background:#0ea5e9; color:#002233 }
  .row{display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; max-width:520px; margin:8px auto}
  .chip{display:inline-block; background:#1b2231; border:1px solid #2a364a; color:#9aa3b2; padding:6px 10px; border-radius:999px; margin:8px 4px}
  .delBtn{background:transparent; color:#ffb4b4; border:1px solid #3a2323; padding:6px 10px; border-radius:8px; cursor:pointer}

  /* Overlay ve bildirim (orijinale uyumlu) */
  #overlay {
    position: absolute; top:0; left:0; width:100%; height:100%;
    pointer-events:none; border: 10px solid transparent; box-sizing:border-box; border-radius:12px;
    transition:border-color .2s, box-shadow .2s;
  }
  #notify {
    position: fixed; top:-60px; left:50%; transform:translateX(-50%);
    background:#1ecb4f; color:#0c2a10; padding:12px 18px; border-radius:10px;
    font-size:16px; font-weight:800; transition:top 0.45s; z-index:9999; border:1px solid #144d28;
  }
  #notify.error { background:#ffd6d6; color:#3a0b0b; border-color:#5b2323; }

  /* Kamera otomatik açılamazsa alt bant */
  #fallbackBar{
    position:fixed; left:0; right:0; bottom:0; z-index:9998;
    background:#1b2231; border-top:1px solid #2a364a; padding:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap
  }
  #fallbackBar button{ background:#3b82f6; color:#fff }
</style>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<header>📷 Lexues Barkodesh</header>

<!-- Kamera kapsayıcı -->
<div style="position:relative;max-width:520px;margin:0 auto">
  <div id="reader"></div>
  <div id="overlay"></div>
</div>

<!-- Durum chip'leri -->
<div class="row">
  <span class="chip" id="countChip">0 kode</span>
  <button id="flashBtn">🔦 Ndiz Fenerin</button>
</div>

<!-- Liste -->
<ul id="resultList"></ul>

<!-- Alt eylem çubuğu (orijinal butonlar + ekler) -->
<div class="btns">
  <button id="copyBtn">📋 Kopjo</button>
  <button id="whatsappBtn">📲 Dërgo në WhatsApp</button>
  <button id="clearAllBtn">🗑️ Pastro listen</button>
</div>

<!-- Manuel ekleme -->
<div class="row" style="margin-bottom:22px">
  <input id="manualInput" type="text" placeholder="Shkruaj kodin manualisht (p.sh. L8KQ)">
  <button id="addBtn">➕ Shto</button>
</div>

<!-- Yedek başlatma bandı -->
<div id="fallbackBar" style="display:none">
  <button id="fallbackStart">🎥 Hap kamerën (nëse nuk u hap automatikisht)</button>
</div>

<div id="notify"></div>

<audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="errorSound"   src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script>
/* ================== ORİJİNAL DEĞİŞKENLERİN ================== */
let scanned = [];
let count = 0;

/* ================== LOCALSTORAGE'DAN GERİ YÜKLE ================== */
(function restoreFromStorage(){
  try{
    const data = JSON.parse(localStorage.getItem("barkodList")||"[]");
    if(Array.isArray(data) && data.length){
      scanned = data.slice();
      count = scanned.length;
      rebuildListFromScanned();
    }
    updateCountChip();
  }catch(e){}
})();

/* ================== ORİJİNAL BİLDİRİM FONKSİYONU ================== */
function showNotification(text, isError=false){
  const notify = document.getElementById("notify");
  notify.textContent = text;
  notify.className = isError ? "error" : "";
  notify.style.top = "20px";
  setTimeout(()=>{ notify.style.top = "-60px"; }, 2000);
}

/* ================== YARDIMCILAR ================== */
function rebuildListFromScanned(){
  const ul = document.getElementById("resultList");
  ul.innerHTML = "";
  scanned.forEach((code, i)=>{
    const li = document.createElement("li");
    li.innerHTML = <span><span class="idx">${i+1}.</span> ${code}</span>;
    const del = document.createElement("button");
    del.className = "delBtn";
    del.textContent = "❌";
    del.onclick = ()=>{
      if(confirm("Je i sigurt që dëshiron ta fshish këtë?")){
        const idx = scanned.indexOf(code);
        if(idx>-1){ scanned.splice(idx,1); localStorage.setItem("barkodList", JSON.stringify(scanned)); }
        count = scanned.length;
        rebuildListFromScanned();
        updateCountChip();
      }
    };
    li.appendChild(del);
    ul.appendChild(li);
  });
}
function updateCountChip(){
  document.getElementById("countChip").textContent = (scanned.length||0) + " kode";
}

/* Yeni eklenen <li>’lere ❌ ve kalıcı kayıt (çekirdeğe dokunmadan) */
const listObserver = new MutationObserver((mutations)=>{
  let added = false;
  mutations.forEach(m=>{
    m.addedNodes.forEach(node=>{
      if(node.nodeName==="LI" && !node.querySelector(".delBtn")){
        const text = node.textContent.trim(); // "N. CODE"
        const parts = text.split(". ");
        const code = (parts[1]||"").trim();
        const wrap = document.createElement("span");
        wrap.textContent = text;
        node.innerHTML = "";
        node.appendChild(wrap);

        const del = document.createElement("button");
        del.className="delBtn";
        del.textContent="❌";
        del.onclick=()=>{
          if(confirm("Je i sigurt që dëshiron ta fshish këtë?")){
            const idx = scanned.indexOf(code);
            if(idx>-1){ scanned.splice(idx,1); localStorage.setItem("barkodList", JSON.stringify(scanned)); }
            count = scanned.length;
            rebuildListFromScanned();
            updateCountChip();
          }
        };
        node.appendChild(del);
        added = true;
      }
    });
  });
  if(added){
    // DOM’a yeni satır eklendiyse listeyi kalıcı kaydet ve sayaç güncelle
    localStorage.setItem("barkodList", JSON.stringify(scanned));
    updateCountChip();
  }
});
listObserver.observe(document.getElementById("resultList"), {childList:true});

/* ================== ORİJİNAL TARAMA CALLBACK'İN ================== */
function onScanSuccess(decodedText) {
  // linkten sadece son 4 karakteri al
  let code = decodedText.slice(-4);
  
  const overlay = document.getElementById("overlay");
  
  if(scanned.includes(code)){
    document.getElementById("errorSound").play();
    overlay.style.borderColor="red";
    setTimeout(()=> overlay.style.borderColor="transparent",500);
    showNotification(code + " zaten okutuldu!", true);
    return;
  }
  
  scanned.push(code);
  count++;
  
  let li = document.createElement("li");
  li.textContent = count + ". " + code;
  document.getElementById("resultList").appendChild(li);
  
  document.getElementById("successSound").play();
  overlay.style.borderColor="lime";
  setTimeout(()=> overlay.style.borderColor="transparent",500);
  showNotification(code + " eklendi ✅");
}

/* ================== ORİJİNAL KOPYALA / WHATSAPP ================== */
function copyList(){
  let text = scanned.map((c,i)=> (i+1)+". "+c).join("\n");
  navigator.clipboard.writeText(text);
  alert("Lista u kopjua!");
}
function sendWhatsApp(){
  let text = scanned.map((c,i)=> (i+1)+". "+c).join("%0A");
  window.open("https://wa.me/?text="+text,"_blank");
}
document.getElementById("copyBtn").onclick = copyList;
document.getElementById("whatsappBtn").onclick = sendWhatsApp;

/* ================== HEPSİNİ TEMİZLE (emin misin?) ================== */
document.getElementById("clearAllBtn").onclick = ()=>{
  if(confirm("Je i sigurt që dëshiron të pastrosh gjithë listën?")){
    scanned = [];
    count = 0;
    localStorage.setItem("barkodList", JSON.stringify(scanned));
    rebuildListFromScanned();
    updateCountChip();
  }
};

/* ================== MANUEL KOD EKLE ================== */
document.getElementById("addBtn").onclick = ()=>{
  const input = document.getElementById("manualInput");
  let code = (input.value||"").trim().toUpperCase();
  if(!code) return;
  if(code.length>4) code = code.slice(-4); // senin mantıkla aynı
  if(scanned.includes(code)){ showNotification(code+" tashmë ekziston!", true); return; }
  scanned.push(code);
  count++;
  const li=document.createElement("li");
  li.textContent = count + ". " + code;
  document.getElementById("resultList").appendChild(li);
  localStorage.setItem("barkodList", JSON.stringify(scanned));
  updateCountChip();
  input.value="";
  showNotification(code+" u shtua ✅");
};

/* ================== FLASH / TORCH AÇ-KAPAT ================== */
let torchOn = false;
document.getElementById("flashBtn").onclick = async ()=>{
  try{
    const video = document.querySelector("#reader video");
    const track = video && video.srcObject && video.srcObject.getVideoTracks ? video.srcObject.getVideoTracks()[0] : null;
    if(!track){ alert("Feneri përdor kamerën — së pari hap kamerën."); return; }
    const caps = track.getCapabilities ? track.getCapabilities() : null;
    if(!caps || (!caps.torch && !caps.fillLightMode)){ alert("Pajisja nuk mbështet fenerin."); return; }
    await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
    torchOn = !torchOn;
    document.getElementById("flashBtn").textContent = torchOn ? "🔦 Fik Fenerin" : "🔦 Ndiz Fenerin";
  }catch(e){
    alert("Fener nuk u aktivizua: " + (e.message||e));
  }
};

/* ================== YEDEK BAŞLATMA (Kamerayı aç butonu) ================== */
document.getElementById("fallbackStart").onclick = async ()=>{
  try{
    // iOS/Safari için izin diyaloğu
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
    // izin alındıysa hemen serbest bırak
    stream.getTracks().forEach(t=>t.stop());
    // html5-qrcode altındaki start zaten aşağıda çağrılı; izin sonrası tekrar denemek için sayfayı tazelemek yerine:
    // basitçe kullanıcıya bilgi verelim
    showNotification("Kamera gati. Provo sërish të skanosh ✅");
  }catch(err){
    showNotification("Leja e kamerës u refuzua: "+(err.name||"")+"", true);
  }
};

/* ================== ORİJİNAL BAŞLATMAN ================== */
new Html5Qrcode("reader").start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 250 },
  onScanSuccess
);

/* İlk yüklemede sayaç chip’ini güncelle */
updateCountChip();

/* Eğer kamera otomatik açılmazsa kullanıcıya görünür bir tetik verelim */
setTimeout(()=>{
  const hasVideo = document.querySelector("#reader video");
  if(!hasVideo){ document.getElementById("fallbackBar").style.display="flex"; }
}, 1200);
</script>
</body>
</html>
