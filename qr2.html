<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="UTF-8">
<title>Lexues Barkodesh</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  /* ----- SENƒ∞N ORƒ∞Jƒ∞NAL STƒ∞LLERƒ∞N ----- */
  body { font-family: Arial, sans-serif; text-align: center; margin: 0; background: #0f1115; color:#e8ecf2; }
  #reader { width: 100%; max-width: 420px; margin: 16px auto; border-radius:12px; overflow:hidden; }
  #resultList { margin: 12px auto 90px; width: 92%; max-width: 520px; text-align: left; background:#161b26; border:1px solid #232b3b; border-radius:12px; padding:0 }
  li { padding: 10px 12px; border-top: 1px solid #222b3a; display:flex; align-items:center; justify-content:space-between; }
  li:first-child{ border-top:0 }
  .btns { position:sticky; bottom:0; background:rgba(15,17,21,.9); backdrop-filter:blur(8px); border-top:1px solid #232b3b; padding:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
  button { padding: 10px 14px; margin: 0; border: none; border-radius: 10px; cursor: pointer; font-weight:700 }
  #copyBtn { background: #3b82f6; color: #fff; }
  #whatsappBtn { background: #25D366; color: #072b10; }
  /* ----- EK TASARIM ----- */
  header{background:#151a22; border-bottom:1px solid #232b3b; padding:12px 14px; font-weight:800; letter-spacing:.2px}
  .chip{display:inline-block; background:#1b2231; border:1px solid #2a364a; color:#9aa3b2; padding:6px 10px; border-radius:999px; margin:8px 4px}
  .row{display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; max-width:520px; margin:8px auto}
  .ghost{background:#1b2231; color:#e8ecf2; border:1px solid #2a364a}
  .danger{background:#e74c3c; color:#fff}
  .secondary{background:#0ea5e9; color:#002233}
  .accent{background:#facc15; color:#1a1a00}
  .muted{color:#9aa3b2}
  .idx{opacity:.7; margin-right:8px}
  .delBtn{background:transparent; color:#ffb4b4; border:1px solid #3a2323; padding:6px 10px; border-radius:8px; cursor:pointer}
  #manualInput{flex:1 1 200px; padding:10px; border-radius:10px; border:1px solid #2a364a; background:#0f141f; color:#e8ecf2}
  #overlay {
    position: absolute; top:0; left:0; width:100%; height:100%;
    pointer-events:none; border: 8px solid transparent; box-sizing:border-box; border-radius:12px;
    transition:border-color .2s, box-shadow .2s;
  }
  #notify {
    position: fixed; top:-60px; left:50%; transform:translateX(-50%);
    background:#1ecb4f; color:#0c2a10; padding:12px 18px; border-radius:10px;
    font-size:16px; font-weight:800; transition:top 0.45s; z-index:9999; border:1px solid #144d28;
  }
  #notify.error { background:#ffd6d6; color:#3a0b0b; border-color:#5b2323; }
</style>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<header>üì∑ Lexues Barkodesh</header>

<!-- Kamera kapsayƒ±cƒ± -->
<div style="position:relative;max-width:520px;margin:0 auto">
  <div id="reader"></div>
  <div id="overlay"></div>
</div>

<!-- Durum chip'leri -->
<div class="row">
  <span class="chip muted" id="countChip">0 kode</span>
  <button id="flashBtn" class="accent">üî¶ Ndiz Fenerin</button>
</div>

<!-- Liste -->
<ul id="resultList"></ul>

<!-- Alt eylem √ßubuƒüu -->
<div class="btns">
  <button id="copyBtn">üìã Kopjo</button>
  <button id="whatsappBtn">üì≤ D√´rgo n√´ WhatsApp</button>
  <button id="clearAllBtn" class="danger">üóëÔ∏è Pastro listen</button>
</div>

<!-- Manuel ekleme -->
<div class="row" style="margin-bottom:22px">
  <input id="manualInput" type="text" placeholder="Shkruaj kodin manualisht (p.sh. L8KQ)">
  <button id="addBtn" class="secondary">‚ûï Shto</button>
</div>

<div id="notify"></div>

<audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="errorSound"   src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script>
/* ========== SENƒ∞N ORƒ∞Jƒ∞NAL DEƒûƒ∞≈ûKENLERƒ∞N ========== */
let scanned = [];
let count = 0;

/* ========== EK: LOCALSTORAGE'DAN GERƒ∞ Y√úKLEME ========== */
(function restoreFromStorage(){
  try{
    const data = JSON.parse(localStorage.getItem("barkodList")||"[]");
    if(Array.isArray(data) && data.length){
      scanned = data.slice();
      count = scanned.length;
      rebuildListFromScanned(); // mevcut listeyi ekrana bas
    }
    updateCountChip();
  }catch(e){}
})();

/* ========== SENƒ∞N ORƒ∞Jƒ∞NAL Bƒ∞LDƒ∞Rƒ∞M FONKSƒ∞YONUN ========== */
function showNotification(text, isError=false){
  const notify = document.getElementById("notify");
  notify.textContent = text;
  notify.className = isError ? "error" : "";
  notify.style.top = "20px";
  setTimeout(()=>{ notify.style.top = "-60px"; }, 2000);
}

/* ========== YARDIMCI: Lƒ∞STEYƒ∞ YENƒ∞DEN √áƒ∞Z ========== */
function rebuildListFromScanned(){
  const ul = document.getElementById("resultList");
  ul.innerHTML = "";
  scanned.forEach((code, i)=>{
    const li = document.createElement("li");
    li.innerHTML = <span><span class="idx">${i+1}.</span> ${code}</span>;
    const del = document.createElement("button");
    del.className = "delBtn";
    del.textContent = "‚ùå";
    del.onclick = ()=>{
      if(confirm("Je i sigurt q√´ d√´shiron ta fshish k√´t√´?")){
        // diziden kaldƒ±r
        const idx = scanned.indexOf(code);
        if(idx>-1){ scanned.splice(idx,1); localStorage.setItem("barkodList", JSON.stringify(scanned)); }
        // sayƒ±mƒ± ve listeyi g√ºncelle
        count = scanned.length;
        rebuildListFromScanned();
        updateCountChip();
      }
    };
    li.appendChild(del);
    ul.appendChild(li);
  });
}

/* ========== YARDIMCI: COUNTER CHIP ========== */
function updateCountChip(){
  const chip = document.getElementById("countChip");
  chip.textContent = (scanned.length||0) + " kode";
}

/* ========== EK: YENƒ∞ EKLENEN Lƒ∞'YE Sƒ∞LME TU≈ûU EKLE (orijinali bozmadan) ========== */
const listObserver = new MutationObserver((mutations)=>{
  mutations.forEach(m=>{
    m.addedNodes.forEach(node=>{
      if(node.nodeName==="LI" && !node.querySelector(".delBtn")){
        const text = node.textContent.trim(); // "N. CODE"
        const parts = text.split(". "); // ["N", "CODE"]
        const code = parts[1] || "";
        const wrap = document.createElement("span");
        wrap.textContent = text;
        node.innerHTML = "";
        node.appendChild(wrap);

        const del = document.createElement("button");
        del.className="delBtn";
        del.textContent="‚ùå";
        del.onclick=()=>{
          if(confirm("Je i sigurt q√´ d√´shiron ta fshish k√´t√´?")){
            const idx = scanned.indexOf(code);
            if(idx>-1){ scanned.splice(idx,1); localStorage.setItem("barkodList", JSON.stringify(scanned)); }
            count = scanned.length;
            rebuildListFromScanned();
            updateCountChip();
          }
        };
        node.appendChild(del);
      }
    });
  });
});
listObserver.observe(document.getElementById("resultList"), {childList:true});

/* ========== SENƒ∞N ORƒ∞Jƒ∞NAL TARAYICI CALLBACK'ƒ∞N ========== */
function onScanSuccess(decodedText) {
  // linkten sadece son 4 karakteri al
  let code = decodedText.slice(-4);

  const overlay = document.getElementById("overlay");

  if(scanned.includes(code)){
    document.getElementById("errorSound").play();
    overlay.style.borderColor="red";
    overlay.style.boxShadow="0 0 0 9999px #ff4d4f22";
    setTimeout(()=>{ overlay.style.borderColor="transparent"; overlay.style.boxShadow="none"; },500);
    showNotification(code + " zaten okutuldu!", true);
    return;
  }

  scanned.push(code);
  count++;

  let li = document.createElement("li");
  li.textContent = count + ". " + code;
  document.getElementById("resultList").appendChild(li);

  document.getElementById("successSound").play();
  overlay.style.borderColor="lime";
  overlay.style.boxShadow="0 0 0 9999px #1ecb4f22";
  setTimeout(()=>{ overlay.style.borderColor="transparent"; overlay.style.boxShadow="none"; },500);
  showNotification(code + " eklendi ‚úÖ");

  // EK: kalƒ±cƒ± yap
  localStorage.setItem("barkodList", JSON.stringify(scanned));
  updateCountChip();
}

/* ========== SENƒ∞N ORƒ∞Jƒ∞NAL KOPYALA / WHATSAPP ========== */
function copyList(){
  let text = scanned.map((c,i)=> (i+1)+". "+c).join("\n");
  navigator.clipboard.writeText(text);
  alert("Lista u kopjua!");
}
function sendWhatsApp(){
  let text = scanned.map((c,i)=> (i+1)+". "+c).join("%0A");
  window.open("https://wa.me/?text="+text,"_blank");
}
document.getElementById("copyBtn").onclick = copyList;
document.getElementById("whatsappBtn").onclick = sendWhatsApp;

/* ========== EK: T√úM√úN√ú TEMƒ∞ZLE (emin misin?) ========== */
document.getElementById("clearAllBtn").onclick = ()=>{
  if(confirm("Je i sigurt q√´ d√´shiron t√´ pastrosh gjith√´ list√´n?")){
    scanned = [];
    count = 0;
    localStorage.setItem("barkodList", JSON.stringify(scanned));
    rebuildListFromScanned();
    updateCountChip();
  }
};

/* ========== EK: MANUEL KOD EKLE ========== */
document.getElementById("addBtn").onclick = ()=>{
  const input = document.getElementById("manualInput");
  let code = (input.value||"").trim().toUpperCase();
  if(!code) return;
  if(code.length>4) code = code.slice(-4); // senin mantƒ±kla tutarlƒ±
  if(scanned.includes(code)){
    showNotification(code+" tashm√´ ekziston!", true);
    return;
  }
  scanned.push(code);
  count++;
  const li=document.createElement("li");
  li.textContent = count + ". " + code;
  document.getElementById("resultList").appendChild(li);
  localStorage.setItem("barkodList", JSON.stringify(scanned));
  updateCountChip();
  input.value="";
  showNotification(code+" u shtua ‚úÖ");
};

/* ========== EK: FLASH / TORCH A√á-KAPAT ========== */
let torchOn = false;
document.getElementById("flashBtn").onclick = async ()=>{
  try{
    // html5-qrcode i√ßindeki video elementini bul
    const video = document.querySelector("#reader video");
    const track = video && video.srcObject && video.srcObject.getVideoTracks ? video.srcObject.getVideoTracks()[0] : null;
    if(!track){ alert("Feneri p√´rdor kamer√´n ‚Äî s√´ pari hap kamer√´n."); return; }
    const caps = await track.getCapabilities?.();
    if(!caps || (!caps.torch && !caps.fillLightMode)){ alert("Pajisja nuk mb√´shtet fenerin."); return; }
    await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
    torchOn = !torchOn;
    document.getElementById("flashBtn").textContent = torchOn ? "üî¶ Fik Fenerin" : "üî¶ Ndiz Fenerin";
  }catch(e){
    alert("Fener nuk u aktivizua: " + (e.message||e));
  }
};

/* ========== SENƒ∞N ORƒ∞Jƒ∞NAL BA≈ûLATMAN ========== */
new Html5Qrcode("reader").start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 250 },
  onScanSuccess
);

/* ========== EK: SAYFA Y√úKLENƒ∞NCE EKRANDAKƒ∞ SAYACI G√úNCELLE ========== */
updateCountChip();
</script>
</body>
</html>
