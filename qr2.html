<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="UTF-8">
<title>Lexues Barkodesh</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body{font-family:sans-serif;margin:0;background:#0f1115;color:#f2f2f2;text-align:center}
  header{background:#1a1f2d;padding:12px;font-size:18px;font-weight:600}
  #reader{width:100%;max-width:420px;margin:10px auto;border-radius:12px;overflow:hidden}
  #overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;border:8px solid transparent;box-sizing:border-box}
  #notify{position:fixed;top:-60px;left:50%;transform:translateX(-50%);background:#1ecb4f;
          color:#fff;padding:10px 20px;border-radius:8px;font-weight:600;transition:top .4s;z-index:9999}
  #notify.error{background:#e74c3c}
  ul{list-style:none;padding:0;margin:20px auto;max-width:420px;text-align:left;background:#1a1f2d;border-radius:12px;overflow:hidden}
  li{padding:10px 12px;border-top:1px solid #333;display:flex;justify-content:space-between;align-items:center}
  li:first-child{border-top:0}
  .btns,.manual{margin:15px auto;max-width:420px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
  button{flex:1;padding:10px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  #copyBtn{background:#3b82f6;color:#fff}
  #whatsappBtn{background:#25D366;color:#fff}
  #clearBtn{background:#e74c3c;color:#fff}
  #flashBtn{background:#facc15;color:#000}
  #manualInput{flex:2;padding:10px;border-radius:8px;border:1px solid #555}
  #addBtn{flex:1;background:#1ecb4f;color:#fff}
</style>
</head>
<body>

<header>📷 Lexues Barkodesh</header>

<div style="position:relative;max-width:420px;margin:auto">
  <div id="reader"></div>
  <div id="overlay"></div>
</div>

<ul id="resultList"></ul>

<div class="btns">
  <button id="copyBtn">📋 Kopjo</button>
  <button id="whatsappBtn">📲 Dërgo në WhatsApp</button>
  <button id="flashBtn">🔦 Ndiz Fenerin</button>
  <button id="clearBtn">🗑️ Pastro listen</button>
</div>

<div class="manual">
  <input type="text" id="manualInput" placeholder="Shkruaj kodin manualisht">
  <button id="addBtn">➕ Shto</button>
</div>

<div id="notify"></div>

<audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="errorSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script>
let scanned = JSON.parse(localStorage.getItem("barkodList")||"[]");
let count = scanned.length;
renderList();

function showNotification(text, isError=false){
  const notify=document.getElementById("notify");
  notify.textContent=text;
  notify.className=isError?"error":"";
  notify.style.top="20px";
  setTimeout(()=>{notify.style.top="-60px"},2000);
}

function renderList(){
  const ul=document.getElementById("resultList"); ul.innerHTML="";
  scanned.forEach((c,i)=>{
    let li=document.createElement("li");
    li.innerHTML=<span>${i+1}. ${c}</span>;
    let del=document.createElement("button");
    del.textContent="❌";
    del.style.background="transparent"; del.style.color="#ffb4b4";
    del.onclick=()=>{ if(confirm("Je i sigurt që dëshiron ta fshish këtë?")){ scanned.splice(i,1); save(); } };
    li.appendChild(del);
    ul.appendChild(li);
  });
}

function save(){
  localStorage.setItem("barkodList", JSON.stringify(scanned));
  count=scanned.length;
  renderList();
}

function addCode(code){
  code=code.toUpperCase();
  if(!code) return;
  const overlay=document.getElementById("overlay");
  if(scanned.includes(code)){
    document.getElementById("errorSound").play();
    overlay.style.borderColor="red";
    setTimeout(()=>overlay.style.borderColor="transparent",500);
    showNotification(code+" tashmë ekziston!",true);
    return;
  }
  scanned.push(code); save();
  document.getElementById("successSound").play();
  overlay.style.borderColor="lime";
  setTimeout(()=>overlay.style.borderColor="transparent",500);
  showNotification(code+" u shtua ✅");
}

function onScanSuccess(decodedText){
  let code = decodedText.slice(-4);
  addCode(code);
}

document.getElementById("copyBtn").onclick=()=>{
  let text=scanned.map((c,i)=>(i+1)+". "+c).join("\n");
  navigator.clipboard.writeText(text);
  alert("Lista u kopjua!");
};
document.getElementById("whatsappBtn").onclick=()=>{
  let text=scanned.map((c,i)=>(i+1)+". "+c).join("%0A");
  window.open("https://wa.me/?text="+text,"_blank");
};
document.getElementById("clearBtn").onclick=()=>{
  if(confirm("Je i sigurt që dëshiron të pastrosh gjithë listën?")){
    scanned=[]; save();
  }
};
document.getElementById("addBtn").onclick=()=>{
  const val=document.getElementById("manualInput").value.trim();
  if(val){ addCode(val); document.getElementById("manualInput").value=""; }
};

/* 🔦 Flash toggle */
let torchOn=false;
document.getElementById("flashBtn").onclick=()=>{
  const track=html5QrCode.getRunningTrack();
  if(track){
    const imageCapture=new ImageCapture(track);
    imageCapture.getPhotoCapabilities().then(cap=>{
      if(cap.torch||("fillLightMode" in cap)){
        track.applyConstraints({advanced:[{torch:!torchOn}]});
        torchOn=!torchOn;
        document.getElementById("flashBtn").textContent=torchOn?"🔦 Fik Fenerin":"🔦 Ndiz Fenerin";
      }else alert("Pajisja nuk mbështet fenerin");
    });
  }
};

let html5QrCode=new Html5Qrcode("reader");
html5QrCode.start(
  { facingMode:"environment" },
  { fps:10, qrbox:250 },
  onScanSuccess
);
</script>
</body>
</html>
