<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Shpenzime</title>
<style>
  :root{
    --bg:#0f1320;
    --card:#151a2c;
    --ink:#f5f7ff;
    --muted:#b7c0d8;
    --accent:#6ee7ff;
    --accent-ink:#00202a;
    --danger:#ff6b6b;
    --ok:#19d38d;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius:16px;
  }
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1200px 600px at 80% -10%, #1b2340 0%, #0f1320 45%, #0b0f1a 100%);
    color:var(--ink);
    font: 500 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    -webkit-font-smoothing:antialiased;
    text-rendering:optimizeLegibility;
  }
  header{
    background:rgba(10,14,25,.35);
    border-bottom: 1px solid rgba(255,255,255,.06);
  }
  .bar{
    display:flex; align-items:center; gap:12px;
    padding:14px 16px;
    max-width:850px; margin:0 auto;
  }
  .logo{
    width:38px; height:38px; border-radius:12px;
    background: linear-gradient(135deg, var(--accent), #a1ffb7);
    display:grid; place-items:center; color:var(--accent-ink);
    font-weight:900; box-shadow: var(--shadow);
  }
  .title{font-weight:800; letter-spacing:.2px}
  .sub{color:var(--muted); font-size:14px}
  main{max-width:850px; margin:14px auto 90px; padding:0 14px 40px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
    border:1px solid rgba(255,255,255,.08);
    border-radius:var(--radius);
    box-shadow: var(--shadow);
  }
  .card .hd{padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.06); display:flex; justify-content:space-between; align-items:center}
  .card .bd{padding:16px}
  .pill{background:rgba(255,255,255,.1); padding:6px 10px; border-radius:999px; color:var(--muted); font-size:13px}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .grid{
    display:grid; gap:10px;
    grid-template-columns: repeat(3, 1fr);
  }
  @media(min-width:480px){
    .grid{grid-template-columns: repeat(4, 1fr);}
  }
  @media(min-width:760px){
    .grid{grid-template-columns: repeat(6, 1fr);}
  }
  .cat{
    border:1px solid rgba(255,255,255,.08);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    color:var(--ink);
    border-radius:14px;
    padding:12px 10px;
    display:grid; place-items:center; gap:6px;
    min-height:82px;
    text-align:center; font-weight:600;
    box-shadow: var(--shadow);
    transition: transform .06s ease, background .2s;
    user-select:none;
  }
  .cat:active{ transform:scale(.98); }
  .cat .em{font-size:22px; display:block}
  .muted{color:var(--muted)}
  label{display:block; margin:10px 0 6px; color:var(--muted)}
  input, textarea, select, button{
    font: 600 18px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  #amount{
    width:100%; padding:18px 16px; border-radius:14px; border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06); color:var(--ink);
    outline:none; font-size:24px;
  }
  input::placeholder{color:#92a1c0}
  .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
  .btn{
    border:none; border-radius:12px; padding:12px 14px; font-weight:800; letter-spacing:.4px;
    background:linear-gradient(135deg, var(--accent), #a1ffb7); color: #002027; box-shadow: var(--shadow);
  }
  .btn.sec{
    background:rgba(255,255,255,.08); color:var(--ink); border:1px solid rgba(255,255,255,.12)
  }
  .btn.danger{ background: linear-gradient(135deg, var(--danger), #ffb0b0); color:#300}
  .steps{display:grid; gap:14px}
  .hide{display:none !important;}
  .list{display:grid; gap:10px}
  .item{
    display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center;
    padding:10px 12px; border-radius:12px;
    border:1px solid rgba(255,255,255,.08);
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
  }
  .amt{font-weight:900}
  .catpill{font-size:12px; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.12)}
  .note{color:var(--muted); font-size:13px}
  .section-hd{margin:18px 0 10px; color:var(--muted); text-transform:uppercase; font-size:12px; letter-spacing:.8px}
  .sumrow{display:flex; gap:12px; flex-wrap:wrap}
  .sumchip{padding:10px 12px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); border-radius:12px}
  .footbar{
    position:fixed; left:0; right:0; bottom:0; z-index:10;
    background:rgba(10,14,25,.8); backdrop-filter: blur(10px); border-top:1px solid rgba(255,255,255,.08);
  }
  .footwrap{max-width:850px; margin:0 auto; padding:10px 14px; display:flex; align-items:center; justify-content:space-between; gap:8px}
  .hint{color:var(--muted); font-size:13px}
  .fab{
    position:fixed; right:16px; bottom:70px; z-index:11;
    width:58px; height:58px; border-radius:50%; display:grid; place-items:center;
    background:linear-gradient(135deg, var(--ok), #a1ffb7); color:#01291a; border:none; box-shadow: var(--shadow);
    font-size:28px; font-weight:900;
  }
  .file{ position: relative; overflow:hidden; display:inline-grid; place-items:center; }
  .file input{position:absolute; inset:0; opacity:0; cursor:pointer}
  .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .mini{padding:8px 10px; font-size:14px; border-radius:10px}
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo">S</div>
      <div>
        <div class="title">Shpenzime</div>
        <div class="sub">I shpejtë, i thjeshtë, ruajtje lokale • Monedha: ALL (L)</div>
      </div>
      <div style="margin-left:auto" class="right">
        <button class="btn sec mini" id="btnExport">Shkarko CSV</button>
        <label class="btn sec mini file">Ngarko CSV
          <input type="file" id="fileCSV" accept=".csv">
        </label>
        <button class="btn danger mini" id="btnClear">Fshi gjithçka</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="hd">
        <div>Shpenzim i ri</div>
        <div class="pill">Hapi pas hapi: Shuma → Kategoria → Shënim</div>
      </div>
      <div class="bd">
        <div class="steps">
          <div id="step1">
            <label for="amount">Shuma (ALL)</label>
            <input id="amount" inputmode="numeric" pattern="[0-9]*" autocomplete="off" placeholder="p.sh. 1250" />
            <div class="actions">
              <button class="btn" id="next1">Vazhdo</button>
            </div>
          </div>

          <div id="step2" class="hide">
            <div class="section-hd">Zgjidh kategorinë</div>
            <div class="grid" id="catGrid">
            </div>
            <div class="actions">
              <button class="btn sec" id="back2">Mbrapa</button>
            </div>
          </div>

          <div id="step3" class="hide">
            <div class="section-hd">Shto shënim (opsionale)</div>
            <div class="row">
              <div id="chosenCat" class="catpill"></div>
            </div>
            <label for="note">Shënim</label>
            <input id="note" placeholder="p.sh. faturë marketi, targa, nr. fature…">
            <div class="actions">
              <button class="btn" id="save">Ruaj</button>
              <button class="btn sec" id="back3">Mbrapa</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="section-hd">Përmbledhje</div>
    <div class="sumrow" id="summary"></div>

    <div class="section-hd">Regjistrime</div>
    <section class="list" id="list"></section>
  </main>

  <button class="fab" id="fab">＋</button>

  <div class="footbar">
    <div class="footwrap">
      <div class="hint">Të dhënat ruhen në shfletues. Pas çdo regjistrimi mund ta shkarkosh CSV për kopje rezervë.</div>
      <div class="right">
        <button class="btn sec mini" id="btnToday">Sot</button>
        <button class="btn sec mini" id="btnWeek">Java</button>
        <button class="btn sec mini" id="btnMonth">Muaji</button>
        <button class="btn sec mini" id="btnAll">Të gjitha</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const KEY = 'andiExpensesV1';
  const state = {
    data: [],
    filter: 'today',
    draft: { amount: 0, category: '', note: '' }
  };

  const categories = [
    { id:'Qira', icon:'🏠' },
    { id:'Ujë', icon:'💧' },
    { id:'Energji', icon:'⚡️' },
    { id:'Internet', icon:'🌐' },
    { id:'Market', icon:'🛒' },
    { id:'Jashtë për të ngrënë', icon:'🍽️' },
    { id:'Larje/Pastrimi', icon:'🧴' },
    { id:'Rroba', icon:'👕' },
    { id:'Makina', icon:'🚗' },
    { id:'Tjetër', icon:'📝' }
  ];

  const $ = sel => document.querySelector(sel);
  function saveLS(){ localStorage.setItem(KEY, JSON.stringify(state.data)); }
  function loadLS(){
    try{ state.data = JSON.parse(localStorage.getItem(KEY) || '[]'); }
    catch(e){ state.data = []; }
  }
  function toALL(n){
    n = Number(n||0);
    return 'L ' + n.toLocaleString('tr-TR');
  }
  function ymd(d){
    const dt = new Date(d);
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,'0');
    const da = String(dt.getDate()).padStart(2,'0');
    return y+'-'+m+'-'+da;
  }
  function hms(d){
    const dt = new Date(d);
    const h = String(dt.getHours()).padStart(2,'0');
    const m = String(dt.getMinutes()).padStart(2,'0');
    return h+':'+m;
  }
  function todayStr(){ return ymd(new Date()); }

  function startOfWeek(d){
    const dt = new Date(d);
    dt.setHours(0,0,0,0);
    const day = dt.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    dt.setDate(dt.getDate() + diff);
    return dt;
  }
  function endOfWeek(d){
    const s = startOfWeek(d);
    const e = new Date(s);
    e.setDate(s.getDate()+6);
    e.setHours(23,59,59,999);
    return e;
  }
  function inFilter(i){
    const dt = new Date(i.ts);
    if(state.filter==='today'){
      return ymd(dt)===todayStr();
    }
    if(state.filter==='week'){
      const s = startOfWeek(new Date());
      const e = endOfWeek(new Date());
      return dt>=s && dt<=e;
    }
    if(state.filter==='month'){
      const now = new Date();
      return dt.getFullYear()===now.getFullYear() && dt.getMonth()===now.getMonth();
    }
    return true;
  }

  function renderCats(){
    const grid = $('#catGrid'); grid.innerHTML = '';
    categories.forEach(c=>{
      const b = document.createElement('button');
      b.className = 'cat';
      b.dataset.cat = c.id;
      b.innerHTML = `<span class="em">${c.icon}</span>${c.id}`;
      b.addEventListener('click', ()=>{
        state.draft.category = c.id;
        $('#chosenCat').textContent = c.id;
        gotoStep(3);
        $('#note').focus();
      });
      grid.appendChild(b);
    });
  }

  function gotoStep(n){
    $('#step1').classList.toggle('hide', n!==1);
    $('#step2').classList.toggle('hide', n!==2);
    $('#step3').classList.toggle('hide', n!==3);
  }

  function resetDraft(){
    state.draft = { amount: 0, category: '', note: '' };
    $('#amount').value = '';
    $('#note').value = '';
    $('#chosenCat').textContent = '';
    gotoStep(1);
  }

  function addItem(){
    const item = {
      id: 'E' + Date.now().toString(36) + Math.random().toString(36).slice(2,6),
      ts: new Date().toISOString(),
      amount: Number(state.draft.amount)||0,
      currency: 'ALL',
      category: state.draft.category || 'Tjetër',
      note: (state.draft.note||'').trim()
    };
    state.data.push(item);
    saveLS();
    renderAll();
    setTimeout(()=>{
      if(confirm('Ta shkarkoj si CSV?')){
        exportCSV();
      }
    }, 0);
    resetDraft();
  }

  function renderSummary(){
    const list = state.data.filter(inFilter);
    const total = list.reduce((a,b)=> a + (Number(b.amount)||0), 0);
    const byCat = {};
    list.forEach(i=> byCat[i.category] = (byCat[i.category]||0) + (Number(i.amount)||0));
    const top = Object.entries(byCat).sort((a,b)=> b[1]-a[1]).slice(0,3);

    const s = $('#summary'); s.innerHTML = '';
    const chips = [
      `<div class="sumchip"><b>Totali:</b> ${toALL(total)}</div>`,
      `<div class="sumchip"><b>Regjistrime:</b> ${list.length}</div>`,
      `<div class="sumchip"><b>Filtri:</b> ${(
        state.filter==='today'?'Sot':state.filter==='week'?'Java':state.filter==='month'?'Muaji':'Të gjitha'
      )}</div>`
    ];
    top.forEach(([cat, sum])=> chips.push(`<div class="sumchip"><b>${cat}:</b> ${toALL(sum)}</div>`));
    s.innerHTML = chips.join('');
  }

  function renderList(){
    const L = $('#list'); L.innerHTML = '';
    const items = state.data.slice().sort((a,b)=> new Date(b.ts)-new Date(a.ts));
    const filtered = items.filter(inFilter);

    if(!filtered.length){
      L.innerHTML = `<div class="muted">Ende nuk ka regjistrime.</div>`; return;
    }

    filtered.forEach(i=>{
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `
        <div class="catpill">${i.category}</div>
        <div>
          <div class="amt">${toALL(Number(i.amount)||0)}</div>
          <div class="note">${i.note?escapeHTML(i.note):''}</div>
          <div class="muted" style="font-size:12px">${ymd(i.ts)} • ${hms(i.ts)}</div>
        </div>
        <div>
          <button class="btn sec mini" data-del="${i.id}" title="Fshi">Fshi</button>
        </div>
      `;
      el.querySelector('[data-del]').addEventListener('click', ()=>{
        if(confirm('Ta fshij këtë regjistrim?')){
          const idx = state.data.findIndex(x=> x.id===i.id);
          if(idx>-1){ state.data.splice(idx,1); saveLS(); renderAll(); }
        }
      });
      L.appendChild(el);
    });
  }

  function escapeHTML(s){
    return s.replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function exportCSV(){
    const header = ['id','date','time','amount','currency','category','note'];
    const rows = state.data.map(i=>[
      i.id, ymd(i.ts), hms(i.ts), String(Number(i.amount)||0), i.currency, i.category, (i.note||'').replace(/"/g,'""')
    ]);
    const toCSV = [header].concat(rows).map(r=> r.map(c=> `"${c}"`).join(',')).join('\r\n');
    const blob = new Blob([toCSV], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    const now = new Date();
    const name = `shpenzime_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.csv`;
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
  }

  function importCSV(text){
    const lines = text.split(/\r?\n/).filter(Boolean);
    if(!lines.length) return;
    const header = lines.shift().split(',').map(s=> s.replace(/^"|"$/g,''));
    const idx = (name)=> header.indexOf(name);

    const seen = new Map(state.data.map(i=> [i.id, i]));

    lines.forEach(line=>{
      const cells = [];
      let current = ''; let inside = false;
      for(let ch of line){
        if(ch === '"'){ inside = !inside; continue; }
        if(ch === ',' && !inside){ cells.push(current); current=''; continue; }
        current += ch;
      }
      cells.push(current);
      const get = name => (cells[idx(name)]||'').trim();
      const id = get('id') || ('I' + Date.now().toString(36) + Math.random().toString(36).slice(2,6));
      const dt = get('date') && get('time') ? new Date(get('date') + 'T' + get('time') + ':00') : new Date();
      const amt = Number(get('amount')||0);
      const item = {
        id,
        ts: dt.toISOString(),
        amount: isNaN(amt)?0:amt,
        currency: get('currency')||'ALL',
        category: get('category')||'Tjetër',
        note: (get('note')||'').replace(/""/g,'"')
      };
      if(seen.has(item.id)){
        const idxExisting = state.data.findIndex(x=> x.id===item.id);
        if(idxExisting>-1) state.data[idxExisting] = item;
      } else {
        state.data.push(item);
        seen.set(item.id, item);
      }
    });
    saveLS();
    renderAll();
  }

  function renderAll(){
    renderSummary();
    renderList();
  }

  document.getElementById('next1').addEventListener('click', ()=>{
    const raw = String(document.getElementById('amount').value||'').replace(/[^\d]/g,'');
    const val = Number(raw||0);
    if(!val){ alert('Shkruaj shumën.'); document.getElementById('amount').focus(); return; }
    state.draft.amount = val;
    gotoStep(2);
  });
  document.getElementById('amount').addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      e.preventDefault(); document.getElementById('next1').click();
    }
  });
  document.getElementById('back2').addEventListener('click', ()=> gotoStep(1));
  document.getElementById('back3').addEventListener('click', ()=> gotoStep(2));
  document.getElementById('save').addEventListener('click', ()=>{
    state.draft.note = document.getElementById('note').value || '';
    if(!state.draft.category){ alert('Zgjidh kategorinë.'); gotoStep(2); return; }
    addItem();
  });
  document.getElementById('btnExport').addEventListener('click', exportCSV);
  document.getElementById('fileCSV').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = evt => importCSV(String(evt.target.result||''));
    reader.readAsText(f, 'utf-8');
    e.target.value = '';
  });
  document.getElementById('btnClear').addEventListener('click', ()=>{
    if(confirm('T’i fshij të gjitha? (Nuk kthehet mbrapsht)')){
      state.data = []; saveLS(); renderAll();
    }
  });
  document.getElementById('btnToday').addEventListener('click', ()=>{ state.filter='today'; renderAll(); });
  document.getElementById('btnWeek').addEventListener('click', ()=>{ state.filter='week'; renderAll(); });
  document.getElementById('btnMonth').addEventListener('click', ()=>{ state.filter='month'; renderAll(); });
  document.getElementById('btnAll').addEventListener('click', ()=>{ state.filter='all'; renderAll(); });
  document.getElementById('fab').addEventListener('click', ()=>{
    gotoStep(1); document.getElementById('amount').focus();
    window.scrollTo({top:0, behavior:'smooth'});
  });

  function gotoStep(n){
    document.getElementById('step1').classList.toggle('hide', n!==1);
    document.getElementById('step2').classList.toggle('hide', n!==2);
    document.getElementById('step3').classList.toggle('hide', n!==3);
  }

  renderCats();
  loadLS();
  renderAll();
  resetDraft();
})();
</script>
</body>
</html>
