<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Regjistrim Orari â€¢ Aplikacioni</title>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<!-- Bootstrap 5 CSS (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

<style>
  body{background:#f7f8fb;color:#111}
  .topbar{background:#1f6feb;color:white;padding:12px 16px}
  .card{margin-bottom:12px}
  .left-fixed {position:fixed; left:0; top:50%; transform:translateY(-50%); z-index:9999}
  .chip {writing-mode:vertical-rl; text-orientation:mixed; background:#ff6b6b;color:#fff;padding:6px 8px;border-radius:0 8px 8px 0; cursor:pointer}
  .admin-badge{background:#ffd43b;color:#111;padding:4px 8px;border-radius:8px;font-weight:600}
  pre {white-space:pre-wrap}
</style>
</head>
<body>

<div class="topbar d-flex justify-content-between align-items-center">
  <div>
    <strong>Regjistrim Orari</strong> â€¢ (Shqip)
  </div>
  <div id="top-controls">
    <span id="current-user-name" class="me-2"></span>
    <button class="btn btn-sm btn-light" id="btn-logout" style="display:none">Dil</button>
  </div>
</div>

<div class="container py-3">

  <div class="row">

    <div class="col-lg-4">
      <!-- Login / User panel -->
      <div class="card p-3">
        <h5>Hyr / Zgjidh pÃ«rdoruesin</h5>

        <div id="login-block">
          <div class="mb-2">
            <label class="form-label">Zgjedh emrin</label>
            <select id="user-select" class="form-select"></select>
          </div>

          <div class="mb-2">
            <label class="form-label">FjalÃ«kalim</label>
            <input id="password-input" class="form-control" placeholder="Vendos fjalÃ«kalimin" type="password"/>
          </div>

          <div class="mb-2 form-check">
            <input class="form-check-input" type="checkbox" id="opt-no-location"/>
            <label class="form-check-label" for="opt-no-location">DÃ«shiron tÃ« dÃ«rgosh pa lokacion (lokacione tÃ« Ã§aktivizuara)</label>
          </div>

          <div class="d-flex gap-2">
            <button id="btn-login" class="btn btn-primary">Hyr dhe Regjistro</button>
            <button id="btn-create" class="btn btn-outline-secondary">Krijo PÃ«rdorues (nÃ«se s'ekziston)</button>
          </div>
          <small class="text-muted d-block mt-2">Kur krijon, fjalÃ«kalimi ruhet (hash SHA-256).</small>
        </div>

        <div id="user-actions" style="display:none">
          <h6 id="welcome-title">Hej, <span id="display-name"></span></h6>
          <div class="mb-2">
            <button id="btn-checkin" class="btn btn-success w-100">Jam nÃ« punÃ« (Regjistro hyrje)</button>
          </div>
          <div class="mb-2">
            <label class="form-label">Sot shkova e dola â€” zgjedh kohÃ«n manual (opsionale)</label>
            <input id="manual-time" type="time" class="form-control"/>
            <button id="btn-manual-checkout" class="btn btn-warning w-100 mt-2">Sot - Kjo Ã«shtÃ« koha qÃ« dola (Regjistro dalje)</button>
          </div>
          <div class="mb-2">
            <label class="form-label">ShÃ«nim (opsional)</label>
            <input id="note" class="form-control" placeholder="PÃ«rshkruaje shkurt"/>
          </div>

          <div class="mt-2">
            <button id="btn-history" class="btn btn-outline-primary w-100">Shiko historinÃ« time</button>
          </div>
        </div>

      </div>

      <!-- Admin panel -->
      <div id="admin-panel" class="card p-3 mt-3" style="display:none">
        <h5>Panel Admin</h5>
        <div class="mb-2">
          <label class="form-label">Vendos lokacionin e punÃ«s (admin)</label>
          <div class="input-group mb-2">
            <input id="admin-lat" class="form-control" placeholder="Latitude"/>
            <input id="admin-lng" class="form-control" placeholder="Longitude"/>
          </div>
          <div class="input-group mb-2">
            <input id="allowed-radius" class="form-control" placeholder="Radius nÃ« metra (default 300)"/>
            <button id="btn-save-location" class="btn btn-primary">Ruaj Lokacion</button>
          </div>
          <div><small class="text-muted">Admin-lokacioni pÃ«rdoret pÃ«r tÃ« kontrolluar nÃ«se regjistrimi u bÃ« brenda 300m.</small></div>
        </div>

        <hr/>

        <h6>Menaxho PÃ«rdoruesit</h6>
        <div class="mb-2">
          <input id="new-username" class="form-control mb-1" placeholder="username (p.sh. punonjes4)"/>
          <input id="new-display" class="form-control mb-1" placeholder="emri shfaqes (p.sh. PunonjÃ«s 4)"/>
          <input id="new-password" class="form-control mb-1" placeholder="fjalÃ«kalim"/>
          <div class="form-check mb-1">
            <input class="form-check-input" type="checkbox" id="new-is-admin"/>
            <label class="form-check-label" for="new-is-admin">Lejo si admin</label>
          </div>
          <button id="btn-add-user" class="btn btn-success">Shto/Perditeso pÃ«rdorues</button>
        </div>

        <div class="mb-2">
          <h6>Lista e pÃ«rdoruesve</h6>
          <div id="user-list"></div>
        </div>

      </div>

    </div>

    <div class="col-lg-8">
      <!-- Reporting / history -->
      <div class="card p-3">
        <h5>Raporte & Eksport</h5>

        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Zgjidh pÃ«rdorues</label>
            <select id="report-user" class="form-select"><option value="all">TÃ« gjithÃ«</option></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Prej datÃ«s</label>
            <input id="report-from" type="date" class="form-control"/>
          </div>
          <div class="col-md-4">
            <label class="form-label">Deri nÃ« datÃ«</label>
            <input id="report-to" type="date" class="form-control"/>
          </div>
        </div>

        <div class="mt-2 d-flex gap-2">
          <button id="btn-generate" class="btn btn-primary">GÃ«nero raport</button>
          <button id="btn-copy-whatsapp" class="btn btn-success">Kopjo pÃ«r WhatsApp</button>
          <button id="btn-send-whatsapp" class="btn btn-outline-success">DÃ«rgo nÃ« WhatsApp</button>
        </div>

        <div class="mt-3">
          <h6>Rezultatet</h6>
          <div id="report-results" style="max-height:420px; overflow:auto;"></div>
        </div>
      </div>

      <!-- Kalkulim ore -->
      <div class="card p-3 mt-3">
        <h5>Llogarit orÃ«t e punÃ«s (07:00 - 16:00 baza)</h5>
        <div class="mb-2">
          <small class="text-muted">Sekuenca: pÃ«r Ã§do ditÃ«, shÃ«nojmÃ« hyrjet dhe daljet; llogaritim orÃ«n e brendshme (deri 16:00) + over-time pas 16:00.</small>
        </div>
        <div id="work-summary"></div>
      </div>

    </div>

  </div>

</div>

<!-- Left vertical 'Ã‡evir Kazan' style chip (but here it's 'Menu') -->
<div class="left-fixed">
  <div class="chip" id="open-menu" title="Menu">MENU</div>
</div>

<!-- Toast area -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:12000">
  <div id="toast-area"></div>
</div>

<script>
/* ============================
  KONFIGURIMI SUPABASE
   Vendos supabaseUrl dhe supabaseAnonKey si dha pÃ«rdoruesi
   (emri i projektit: oqrukzyimkwacdniavya)
   Kujdes: ky anon key Ã«shtÃ« i pÃ«rdoruesit (ju e shpÃ«tuat) dhe pÃ«rdoret kÃ«tu.
============================ */
const SUPABASE_URL = 'https://oqrukzyimkwacdniavya.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xcnVrenlpbWt3YWNkbmlhdnlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODg3MTgsImV4cCI6MjA3NDk2NDcxOH0.Z0gxZL72qWFcI-wJinQT_NEUBDaUk4qP0mP1acqXJbI';

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON);

/* HELPER: SHA-256 hashing per fjalÃ«kalim (hex) */
async function sha256hex(str){
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const hash = await crypto.subtle.digest('SHA-256', data);
  const arr = Array.from(new Uint8Array(hash));
  return arr.map(b => b.toString(16).padStart(2,'0')).join('');
}

/* UI helpers */
function toast(msg, type='info'){
  const id = 't'+Date.now();
  const div = document.createElement('div');
  div.className = 'toast align-items-center text-bg-'+(type==='error'?'danger':type)+' border-0';
  div.role='alert'; div.ariaLive='assertive'; div.ariaAtomic='true';
  div.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  document.getElementById('toast-area').appendChild(div);
  const b = new bootstrap.Toast(div, {delay:4000});
  b.show();
}

/* GLOBAL state */
let currentUser = null; // {id, username, display_name, is_admin}
let sessionPassword = null; // stored in sessionStorage optionally
let settingsCache = { admin_location: '0|0', allowed_radius_m: '300' };

/* Inicjalizimi: merr users, settings */
async function init(){
  await loadSettings();
  await loadUsersToSelect();
  await loadUserListAdmin();
  wireEvents();
  loadSession();
}

async function loadSettings(){
  try{
    const { data } = await supabase.from('app_settings').select('*');
    if(data){
      data.forEach(row => { settingsCache[row.key] = row.value; });
    }
    document.getElementById('allowed-radius').value = settingsCache.allowed_radius_m || '300';
    const [lat,lng] = (settingsCache.admin_location || '0|0').split('|');
    document.getElementById('admin-lat').value = lat || '';
    document.getElementById('admin-lng').value = lng || '';
  }catch(e){
    console.error('settings load',e);
  }
}

async function saveSetting(key,val){
  // upsert via RPC-like approach
  const existing = await supabase.from('app_settings').select('*').eq('key',key).maybeSingle();
  if(existing.error) console.warn(existing.error);
  if(existing.data){
    await supabase.from('app_settings').update({value:val}).eq('key',key);
  } else {
    await supabase.from('app_settings').insert({key:key, value:val});
  }
  settingsCache[key] = val;
  toast('U ruajt '+key,'success');
}

async function loadUsersToSelect(){
  const { data, error } = await supabase.from('users_app').select('id,username,display_name').order('display_name');
  if(error) { console.error(error); return; }
  const sel = document.getElementById('user-select');
  const rep = document.getElementById('report-user');
  sel.innerHTML = ''; rep.innerHTML = '<option value="all">TÃ« gjithÃ«</option>';
  data.forEach(u=>{
    const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display_name || u.username;
    sel.appendChild(opt);
    const opt2 = opt.cloneNode(true);
    rep.appendChild(opt2);
  });
}

/* Admin list */
async function loadUserListAdmin(){
  const container = document.getElementById('user-list');
  container.innerHTML = '';
  const { data } = await supabase.from('users_app').select('*').order('created_at', {ascending:false});
  if(data){
    data.forEach(u=>{
      const div = document.createElement('div');
      div.className = 'd-flex align-items-center gap-2 mb-1';
      div.innerHTML = `<div style="flex:1">${u.display_name||u.username} <small class="text-muted">(${u.username})</small></div>
        <div><button class="btn btn-sm btn-outline-primary btn-edit" data-id="${u.id}">Ndrysho</button></div>
        <div><button class="btn btn-sm btn-outline-danger btn-del" data-id="${u.id}">Fshi</button></div>`;
      container.appendChild(div);
    });
    container.querySelectorAll('.btn-edit').forEach(b=>{
      b.addEventListener('click',async e=>{
        const id = e.target.dataset.id;
        const { data } = await supabase.from('users_app').select('*').eq('id',id).maybeSingle();
        if(data){
          document.getElementById('new-username').value = data.username;
          document.getElementById('new-display').value = data.display_name;
          document.getElementById('new-password').value = '';
          document.getElementById('new-is-admin').checked = data.is_admin;
        }
      });
    });
    container.querySelectorAll('.btn-del').forEach(b=>{
      b.addEventListener('click', async e=>{
        if(!confirm('DÃ«shiron ta fshish kÃ«tÃ« pÃ«rdorues?')) return;
        const id = e.target.dataset.id;
        await supabase.from('users_app').delete().eq('id',id);
        toast('U fshi','success');
        await loadUsersToSelect();
        await loadUserListAdmin();
      });
    });
  }
}

/* Event wiring */
function wireEvents(){
  document.getElementById('btn-login').addEventListener('click', onLogin);
  document.getElementById('btn-create').addEventListener('click', onCreateUser);
  document.getElementById('btn-logout').addEventListener('click', onLogout);
  document.getElementById('btn-checkin').addEventListener('click', onCheckIn);
  document.getElementById('btn-manual-checkout').addEventListener('click', onManualCheckout);
  document.getElementById('btn-history').addEventListener('click', showMyHistory);
  document.getElementById('btn-add-user').addEventListener('click', onAddUserAdmin);
  document.getElementById('btn-save-location').addEventListener('click', onSaveAdminLocation);

  document.getElementById('btn-generate').addEventListener('click', generateReport);
  document.getElementById('btn-copy-whatsapp').addEventListener('click', copyWhatsAppText);
  document.getElementById('btn-send-whatsapp').addEventListener('click', sendWhatsAppText);

  document.getElementById('open-menu').addEventListener('click', ()=> {
    window.scrollTo({top:0, behavior:'smooth'});
    toast('Kliko nÃ« "Hyr" pÃ«r tÃ« vazhduar','info');
  });
}

/* Session: check if someone already logged (localStorage) */
function loadSession(){
  const id = localStorage.getItem('app_user_id');
  const pw = sessionStorage.getItem('app_user_pw'); // hashed pw
  if(id && pw){
    // fetch user
    supabase.from('users_app').select('*').eq('id',id).maybeSingle().then(res=>{
      if(res.data){
        currentUser = res.data;
        sessionPassword = pw;
        onLoggedIn();
      } else {
        localStorage.removeItem('app_user_id');
        sessionStorage.removeItem('app_user_pw');
      }
    });
  }
}

/* Login: check username selected and password */
async function onLogin(){
  const sel = document.getElementById('user-select').value;
  const pw = document.getElementById('password-input').value || '';
  if(!sel || !pw){ toast('Ploteso username dhe fjalekalim','error'); return; }
  const hash = await sha256hex(pw);
  const { data, error } = await supabase.from('users_app').select('*').eq('id',sel).maybeSingle();
  if(error) { console.error(error); toast('Gabim','error'); return; }
  if(!data){ toast('PÃ«rdoruesi nuk u gjet','error'); return; }
  if(data.password_hash !== hash){
    toast('FjalÃ«kalim i gabuar','error'); return;
  }
  currentUser = data;
  sessionPassword = hash;
  // store session
  localStorage.setItem('app_user_id', data.id);
  sessionStorage.setItem('app_user_pw', hash);
  onLoggedIn();
}

/* Create user (if not exists). Admin can also create via admin panel. */
async function onCreateUser(){
  const sel = document.getElementById('user-select');
  const username = prompt('Vendos username tÃ« ri (pa hapÃ«sira)', '');
  if(!username) return;
  const display = prompt('Emri shfaqÃ«s', username);
  const pw = prompt('Fjalekalim pÃ«r pÃ«rdoruesin', '');
  if(!pw){ toast('FjalÃ«kalim i nevojshÃ«m','error'); return; }
  const hash = await sha256hex(pw);
  // try insert
  const { error } = await supabase.from('users_app').insert({
    username: username,
    display_name: display,
    password_hash: hash,
    is_admin: false
  });
  if(error){
    toast('Gabim: '+error.message,'error');
    return;
  }
  toast('PÃ«rdoruesi u krijua','success');
  await loadUsersToSelect();
}

/* Add/update user from admin panel */
async function onAddUserAdmin(){
  const user = document.getElementById('new-username').value.trim();
  if(!user) { toast('Vendos username','error'); return; }
  const display = document.getElementById('new-display').value.trim() || user;
  const pw = document.getElementById('new-password').value;
  const isAdmin = document.getElementById('new-is-admin').checked;
  let hash = null;
  if(pw) hash = await sha256hex(pw);
  // check exists
  const existing = await supabase.from('users_app').select('*').eq('username', user).maybeSingle();
  if(existing.data){
    // update
    const patch = { display_name: display, is_admin: isAdmin };
    if(hash) patch.password_hash = hash;
    await supabase.from('users_app').update(patch).eq('username', user);
    toast('PÃ«rditÃ«suar','success');
  } else {
    await supabase.from('users_app').insert({ username:user, display_name:display, password_hash: hash || await sha256hex('1234'), is_admin:isAdmin });
    toast('Shtuar','success');
  }
  document.getElementById('new-username').value=''; document.getElementById('new-display').value=''; document.getElementById('new-password').value='';
  await loadUsersToSelect(); await loadUserListAdmin();
}

/* Logout */
function onLogout(){
  currentUser = null;
  sessionPassword = null;
  localStorage.removeItem('app_user_id');
  sessionStorage.removeItem('app_user_pw');
  document.getElementById('user-actions').style.display = 'none';
  document.getElementById('login-block').style.display = 'block';
  document.getElementById('admin-panel').style.display = 'none';
  document.getElementById('btn-logout').style.display = 'none';
  document.getElementById('current-user-name').textContent='';
  toast('U deconnectove','info');
}

/* After successful login */
function onLoggedIn(){
  document.getElementById('login-block').style.display='none';
  document.getElementById('user-actions').style.display='block';
  document.getElementById('display-name').textContent = currentUser.display_name || currentUser.username;
  document.getElementById('btn-logout').style.display = 'inline-block';
  document.getElementById('current-user-name').textContent = (currentUser.is_admin? 'ðŸ›¡ï¸ ' : '') + (currentUser.display_name || currentUser.username);
  if(currentUser.is_admin){
    document.getElementById('admin-panel').style.display = 'block';
  } else {
    document.getElementById('admin-panel').style.display = 'none';
  }
}

/* Save admin location */
async function onSaveAdminLocation(){
  const lat = document.getElementById('admin-lat').value.trim();
  const lng = document.getElementById('admin-lng').value.trim();
  const r = document.getElementById('allowed-radius').value.trim() || '300';
  if(!lat || !lng){ toast('Vendos lat & lng','error'); return; }
  await saveSetting('admin_location', `${lat}|${lng}`);
  await saveSetting('allowed_radius_m', r);
  toast('Lokacion admin ruajtur','success');
}

/* Register check-in event: use geolocation unless opted out */
async function onCheckIn(){
  if(!currentUser){ toast('Duhet tÃ« hysh me fjalÃ«kalim','error'); return; }
  const noLocation = document.getElementById('opt-no-location').checked;
  let lat=null,lng=null,distance=null,allowed=true;
  if(!noLocation && 'geolocation' in navigator){
    try{
      const pos = await new Promise((res,rej)=> navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:10000 }));
      lat = pos.coords.latitude; lng = pos.coords.longitude;
      // compute distance from admin
      const [alat,alng] = (settingsCache.admin_location || '0|0').split('|').map(Number);
      if(alat && alng) {
        distance = computeDistanceMeters(alat, alng, lat, lng);
        const allowedRadius = Number(settingsCache.allowed_radius_m || '300');
        allowed = distance <= allowedRadius;
      }
    }catch(err){
      console.warn('geo err',err);
      toast('Gabim marrja e lokacionit ose u refuzua','error');
      if(!confirm('Deshiron te dergosh pa lokacion?')) return;
    }
  } else {
    // no geolocation or opted out
  }

  // insert entry
  const payload = {
    user_id: currentUser.id,
    event_type: 'checkin',
    lat: lat,
    lng: lng,
    distance_meters: distance,
    location_allowed: allowed,
    note: document.getElementById('note').value || null
  };
  const { error } = await supabase.from('entries').insert(payload);
  if(error) { console.error(error); toast('Gabim regjistrimi','error'); return; }
  toast('Hyrja u regjistrua','success');
}

/* Manual checkout using selected time (today + time) */
async function onManualCheckout(){
  if(!currentUser){ toast('Hyni per te regjistruar','error'); return; }
  const t = document.getElementById('manual-time').value;
  if(!t){ toast('Zgjidh kohen e daljes','error'); return; }
  // build timestamp for today with chosen time
  const today = new Date();
  const [hh,mm] = t.split(':').map(Number);
  today.setHours(hh,mm,0,0);
  const manual_iso = today.toISOString();
  // location logic as above (or allow no-loc)
  const noLocation = document.getElementById('opt-no-location').checked;
  let lat=null,lng=null,distance=null,allowed=true;
  if(!noLocation && 'geolocation' in navigator){
    try{
      const pos = await new Promise((res,rej)=> navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:10000 }));
      lat = pos.coords.latitude; lng = pos.coords.longitude;
      const [alat,alng] = (settingsCache.admin_location || '0|0').split('|').map(Number);
      if(alat && alng) {
        distance = computeDistanceMeters(alat, alng, lat, lng);
        const allowedRadius = Number(settingsCache.allowed_radius_m || '300');
        allowed = distance <= allowedRadius;
      }
    }catch(err){
      if(!confirm('Deshiron te dergosh pa lokacion?')) return;
    }
  }
  const payload = {
    user_id: currentUser.id,
    event_type: 'checkout',
    ts: manual_iso,
    manual_time: manual_iso,
    lat: lat, lng: lng, distance_meters: distance, location_allowed: allowed,
    note: document.getElementById('note').value || null
  };
  const { error } = await supabase.from('entries').insert(payload);
  if(error){ console.error(error); toast('Gabim regjistrimi','error'); return; }
  toast('Dalja u regjistrua','success');
}

/* Show user's own history */
async function showMyHistory(){
  const { data } = await supabase.from('entries').select('*').eq('user_id', currentUser.id).order('ts', {ascending:false}).limit(200);
  const cont = document.getElementById('report-results');
  if(!data || data.length===0){ cont.innerHTML = '<div class="text-muted">S'+"'"+'ke regjistrime</div>'; return; }
  let html = '<table class="table table-sm"><thead><tr><th>Data</th><th>Lloji</th><th>KohÃ«</th><th>Lokacion</th><th>ShÃ«nim</th></tr></thead><tbody>';
  data.forEach(r=>{
    const d = new Date(r.ts);
    html += `<tr><td>${d.toLocaleDateString('sq-AL')}</td><td>${r.event_type}</td><td>${d.toLocaleTimeString('sq-AL')}</td><td>${r.lat? (r.distance_meters? Math.round(r.distance_meters)+'m':'brenda') : 'pa lok.'}</td><td>${r.note||''}</td></tr>`;
  });
  html += '</tbody></table>';
  cont.innerHTML = html;
}

/* Generate report (selected user/date range) */
let lastReportText = '';
async function generateReport(){
  const uid = document.getElementById('report-user').value;
  const from = document.getElementById('report-from').value;
  const to = document.getElementById('report-to').value;
  let q = supabase.from('entries').select('*, users_app(username, display_name)').order('ts', {ascending:true});
  if(uid && uid !== 'all') q = q.eq('user_id', uid);
  if(from) q = q.gte('ts', new Date(from+'T00:00:00').toISOString());
  if(to) q = q.lte('ts', new Date(to+'T23:59:59').toISOString());
  const { data, error } = await q;
  if(error) { console.error(error); toast('Gabim gjenerimi','error'); return; }
  // Format: group by user -> date -> events
  const grouped = {};
  data.forEach(r=>{
    const uid = r.user_id;
    const d = new Date(r.ts);
    const dateKey = d.toLocaleDateString('sq-AL');
    grouped[uid] = grouped[uid] || { user: r.users_app?.display_name || r.users_app?.username || uid, dates: {} };
    grouped[uid].dates[dateKey] = grouped[uid].dates[dateKey] || [];
    grouped[uid].dates[dateKey].push(r);
  });

  let outHtml = '';
  let textForWhats = '';
  for(const uidKey in grouped){
    outHtml += `<h6>${grouped[uidKey].user}</h6>`;
    textForWhats += `${grouped[uidKey].user}\n`;
    for(const dateKey in grouped[uidKey].dates){
      outHtml += `<strong>${dateKey}</strong><ul>`;
      textForWhats += `${dateKey}\n`;
      grouped[uidKey].dates[dateKey].forEach(ev=>{
        const t = new Date(ev.ts).toLocaleTimeString('sq-AL');
        outHtml += `<li>${t} â€” ${ev.event_type} ${ev.location_allowed ? '' : '(lok. jashtÃ«)'} ${ev.note? '- '+ev.note : ''}</li>`;
        textForWhats += ` - ${t} ${ev.event_type} ${ev.location_allowed ? '' : '(lok. jashtÃ«)'} ${ev.note? '- '+ev.note : ''}\n`;
      });
      outHtml += `</ul>`;
      textForWhats += `\n`;
    }
    textForWhats += `\n----------------\n`;
  }
  document.getElementById('report-results').innerHTML = outHtml || '<div class="text-muted">Nuk u gjet asgjÃ«.</div>';
  lastReportText = textForWhats || 'Raporti bosh';
}

/* Copy WhatsApp text to clipboard */
function copyWhatsAppText(){
  if(!lastReportText){ toast('GÃ«nero raportin parÃ«','error'); return; }
  navigator.clipboard.writeText(lastReportText).then(()=> toast('U kopjua tekbo p.sh. WhatsApp','success'));
}

/* Open WhatsApp send */
function sendWhatsAppText(){
  if(!lastReportText){ toast('GÃ«nero raportin parÃ«','error'); return; }
  const encoded = encodeURIComponent(lastReportText);
  // open web.whatsapp or mobile
  const url = (navigator.userAgent.includes('Mobi')) ? `whatsapp://send?text=${encoded}` : `https://web.whatsapp.com/send?text=${encoded}`;
  window.open(url,'_blank');
}

/* Compute distance between two lat/lng (meters) - Haversine */
function computeDistanceMeters(lat1, lon1, lat2, lon2) {
  function rad(x){return x*Math.PI/180;}
  const R = 6378137; // Earth radius in meters
  const dLat = rad(lat2 - lat1);
  const dLon = rad(lon2 - lon1);
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(rad(lat1)) * Math.cos(rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* Work hours summary: read entries in date range and compute worked time between checkin-checkout pairs */
async function computeWorkSummaryForRange(fromDate, toDate){
  const { data } = await supabase.from('entries').select('*, users_app(username, display_name)').order('ts', {ascending:true});
  if(!data) return;

  // filter by date range if provided
  let rows = data;
  if(fromDate) rows = rows.filter(r => new Date(r.ts) >= new Date(fromDate+'T00:00:00'));
  if(toDate) rows = rows.filter(r => new Date(r.ts) <= new Date(toDate+'T23:59:59'));

  // group by user -> date
  const groups = {};
  rows.forEach(r=>{
    const uid = r.user_id;
    const dateKey = new Date(r.ts).toLocaleDateString('sq-AL');
    groups[uid] = groups[uid] || { name: r.users_app?.display_name || r.users_app?.username || uid, dates: {} };
    groups[uid].dates[dateKey] = groups[uid].dates[dateKey] || [];
    groups[uid].dates[dateKey].push(r);
  });

  const results = [];
  for(const uid in groups){
    let totalRegular = 0; let totalOver = 0;
    for(const dateKey in groups[uid].dates){
      // sort events by time
      const events = groups[uid].dates[dateKey].sort((a,b)=>new Date(a.ts)-new Date(b.ts));
      // pair checkin->checkout sequentially
      for(let i=0;i<events.length;i++){
        if(events[i].event_type==='checkin'){
          // find next checkout after this
          let nextCheckout = null;
          for(let j=i+1;j<events.length;j++){
            if(events[j].event_type==='checkout'){ nextCheckout = events[j]; break; }
          }
          if(nextCheckout){
            const t1 = new Date(events[i].ts);
            const t2 = new Date(nextCheckout.ts);
            let seconds = (t2 - t1)/1000;
            if(seconds < 0) continue;
            // compute regular vs overtime (07:00-16:00 regular)
            const baseStart = new Date(t1); baseStart.setHours(7,0,0,0);
            const baseEnd = new Date(t1); baseEnd.setHours(16,0,0,0);
            // overlap logic
            const start = t1;
            const end = t2;
            const regStart = new Date(Math.max(start, baseStart));
            const regEnd = new Date(Math.min(end, baseEnd));
            let regSec = 0;
            if(regEnd > regStart) regSec = (regEnd - regStart)/1000;
            const overSec = seconds - regSec;
            totalRegular += regSec;
            if(overSec>0) totalOver += overSec;
          }
        }
      }
    }
    results.push({
      user: groups[uid].name,
      regular_hours: (totalRegular/3600),
      overtime_hours: (totalOver/3600)
    });
  }

  // render
  const summaryDiv = document.getElementById('work-summary');
  let html = '<table class="table table-sm"><thead><tr><th>PÃ«rdorues</th><th>OrÃ« (07-16)</th><th>OrÃ« mbipunesÃ«</th></tr></thead><tbody>';
  results.forEach(r=>{
    html += `<tr><td>${r.user}</td><td>${r.regular_hours.toFixed(2)}</td><td>${r.overtime_hours.toFixed(2)}</td></tr>`;
  });
  html += '</tbody></table>';
  summaryDiv.innerHTML = html;
}

/* build periodic summary initially and every 30s */
setInterval(()=> computeWorkSummaryForRange(document.getElementById('report-from').value, document.getElementById('report-to').value), 30000);

/* copy last report text var helper functions for buttons */
let lastReportTextGlobal = '';

/* init app */
init().then(()=> {
  // compute initial summary
  computeWorkSummaryForRange();
  // attach change listeners for date filters to update summary
  document.getElementById('report-from').addEventListener('change', ()=> computeWorkSummaryForRange(document.getElementById('report-from').value, document.getElementById('report-to').value));
  document.getElementById('report-to').addEventListener('change', ()=> computeWorkSummaryForRange(document.getElementById('report-from').value, document.getElementById('report-to').value));
});

</script>
</body>
</html>
