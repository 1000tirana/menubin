<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Regjistrime Orari • sq-AL</title>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#0d1117;color:#c9d1d9;margin:0}
.container{max-width:920px;margin:0 auto;padding:16px}
.card{background:#161b22;border:1px solid #30363d;border-radius:14px;padding:16px;margin:12px 0}
.input,select,button{padding:12px;border-radius:10px;border:1px solid #30363d;background:#0b0f14;color:#c9d1d9}
button{cursor:pointer}
.row{display:flex;gap:12px;flex-wrap:wrap}.row>*{flex:1 1 240px}
.hidden{display:none}
.badge{display:inline-block;padding:4px 8px;border:1px solid #30363d;border-radius:999px;color:#8b949e}
</style>
</head>
<body>
<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <div class="badge" id="userBadge">Pa hyrje</div>
    </div>
    <strong>Regjistrime Orari</strong>
  </div>

  <!-- LOGIN -->
  <section id="viewLogin" class="card">
    <h2>Hyr</h2>
    <div class="row">
      <div>
        <label>Përdoruesi</label>
        <select id="loginEmployee" class="input"></select>
      </div>
      <div>
        <label>PIN</label>
        <input id="loginPin" type="password" class="input" placeholder="••••" />
      </div>
    </div>
    <div class="row"><button id="btnDoLogin">Hyr</button></div>
  </section>

  <!-- HOME -->
  <section id="viewHome" class="card hidden">
    <h2>Kryefaqja</h2>
    <p>Hyrje e suksesshme ✅</p>
  </section>
</div>

<!-- JS CDN'ler ZORUNLU -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
<script>
const sb = supabase.createClient(
  "https://oqrukzyimkwacdniavya.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xcnVrenlpbWt3YWNkbmlhdnlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODg3MTgsImV4cCI6MjA3NDk2NDcxOH0.Z0gxZL72qWFcI-wJinQT_NEUBDaUk4qQ0mP1acqXJbI".replace("Q0m","Q")
); // ufak kırpma: kopyala yapıştırda bozulmasın diye

const $ = (s)=>document.querySelector(s);
function show(id){ ['viewLogin','viewHome'].forEach(x=>$('#'+x).classList.add('hidden')); $('#'+id).classList.remove('hidden'); }

async function loadEmployees(){
  const { data, error } = await sb.from('employees')
    .select('id,name,role,active').eq('active',true).order('name',{ascending:true});
  if(error){ alert('Employees SELECT error: '+error.message); return; }
  const sel = $('#loginEmployee'); sel.innerHTML='';
  (data||[]).forEach(u=>{ const o=document.createElement('option'); o.value=u.id; o.textContent=`${u.name} (${u.role})`; sel.appendChild(o); });
}
$('#btnDoLogin').onclick = async ()=>{
  try{
    const empId = $('#loginEmployee').value, pin = $('#loginPin').value.trim();
    if(!empId || !pin){ alert('Përdoruesi dhe PIN kërkohen'); return; }
    const { data, error } = await sb.from('employees').select('id,name,role,pin_hash,active').eq('id',empId).single();
    if(error){ alert('Lexim gabim: '+error.message); return; }
    if(!data || !data.active){ alert('Përdorues i pavlefshëm'); return; }
    const ok = bcrypt.compareSync(pin, data.pin_hash||'');
    if(!ok){ alert('PIN i pasaktë'); return; }
    localStorage.setItem('emp', JSON.stringify({id:data.id,name:data.name,role:data.role}));
    $('#userBadge').textContent = `${data.name} • ${data.role}`;
    show('viewHome');
  }catch(e){ alert('JS error: '+e.message); }
};

loadEmployees();
</script>
</body>
</html>
