<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Regjistrimi i Pranisë • Aplikacion</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{padding:20px;background:#f6f8fa;font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    .card {box-shadow:0 4px 18px rgba(0,0,0,.06)}
    .small-muted{font-size:0.85rem;color:#6b7280}
    .left-float {position:fixed; left:0; top:40%; transform:rotate(-90deg) translateY(-50%); transform-origin:left top; z-index:1000;}
    .fab {position:fixed; right:1rem; bottom:1rem; z-index:1000}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
</head>
<body>
  <div class="left-float">
    <button id="openAppBtn" class="btn btn-danger btn-lg">Rrotullo &nbsp; Fitoni</button>
  </div>

  <div class="container" id="app" style="max-width:980px">
    <div class="card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="m-0">Aplikacioni i Pranisë</h4>
        <div>
          <span id="currentUserLabel" class="me-2 small-muted">Jo i identifikuar</span>
          <button id="btnLogout" class="btn btn-outline-secondary btn-sm" style="display:none">Shkyçu</button>
        </div>
      </div>
      <p class="small-muted mt-2 mb-0">Faqe në gjuhën shqipe • Vendosni të dhënat tuaja dhe regjistroni hyrjet/daljet.</p>
    </div>

    <!-- Login / Choose user -->
    <div class="card p-3 mb-3">
      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Emri i punonjësit</label>
          <select id="userSelect" class="form-select"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Fjalëkalimi (PIN)</label>
          <input id="passwordInput" class="form-control" type="password" placeholder="Fjalëkalimi" />
        </div>
      </div>

      <div class="mt-3 d-flex gap-2">
        <button id="btnLogin" class="btn btn-primary">Hyr (Fjalëkalim)</button>
        <button id="btnOpenAsGuest" class="btn btn-outline-secondary">Hyr Pa Login (Vetëm Shikim)</button>
        <div class="form-check ms-auto">
          <input class="form-check-input" type="checkbox" id="noLocationCheckbox">
          <label class="form-check-label" for="noLocationCheckbox">Dërgo pa lokacion (pa kërkesë)</label>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card p-3">
          <h5>Regjistrimet</h5>
          <div class="d-grid gap-2">
            <button id="btnClockIn" class="btn btn-success">Kam ardhur në punë (RREND)</button>
            <div class="input-group">
              <input id="manualOutTime" type="time" class="form-control" />
              <button id="btnManualOut" class="btn btn-warning">Sot në këtë orë dola</button>
            </div>
            <small class="small-muted">Nëse doni, mund të vendosni orën e daljes manualisht</small>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card p-3">
          <h5>Shikoni Regjistrimet</h5>
          <div class="mb-2">
            <label class="form-label">Nga</label>
            <input id="filterFrom" type="date" class="form-control" />
            <label class="form-label mt-2">Deri</label>
            <input id="filterTo" type="date" class="form-control" />
          </div>
          <div class="d-flex gap-2">
            <button id="btnLoadRecords" class="btn btn-outline-primary">Shiko</button>
            <button id="btnShareWhatsApp" class="btn btn-success">Dërgo në WhatsApp</button>
            <button id="btnExportCSV" class="btn btn-secondary">Eksporto CSV</button>
          </div>
          <div id="recordsArea" class="mt-2 small" style="max-height:220px;overflow:auto"></div>
        </div>
      </div>
    </div>

    <!-- Admin panel -->
    <div id="adminPanel" style="display:none" class="card p-3 mt-3">
      <h5>Paneli i Adminit</h5>
      <div class="row g-2">
        <div class="col-md-4">
          <input id="newName" class="form-control" placeholder="Emri i punonjësit" />
        </div>
        <div class="col-md-3">
          <input id="newPassword" class="form-control" placeholder="PIN (shembull 1234)" />
        </div>
        <div class="col-md-3">
          <input id="newLat" class="form-control" placeholder="Lat (admin lokacion)" />
        </div>
        <div class="col-md-2">
          <input id="newLng" class="form-control" placeholder="Lng" />
        </div>
      </div>
      <div class="row g-2 mt-2">
        <div class="col-md-2">
          <input id="newRadius" type="number" class="form-control" placeholder="Radius (m)" value="300"/>
        </div>
        <div class="col-md-4">
          <button id="btnAddUser" class="btn btn-primary">Shto / Ruaj Punonjës</button>
          <button id="btnRefreshUsers" class="btn btn-outline-secondary">Rifresko</button>
        </div>
      </div>

      <hr />
      <div id="adminUsersList" style="max-height:220px;overflow:auto"></div>
    </div>

  </div>

  <script>
  // ---------- Supabase init ----------
  const SUPABASE_URL = "https://oqrukzyimkwacdniavya.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xcnVrenlpbWt3YWNkbmlhdnlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODg3MTgsImV4cCI6MjA3NDk2NDcxOH0.Z0gxZL72qWFcI-wJinQT_NEUBDaUk4qP0mP1acqXJbI";
  const supabase = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ---------- Helpers ----------
  function sha256hex(msg){
    const enc = new TextEncoder();
    const data = enc.encode(msg);
    return crypto.subtle.digest("SHA-256", data).then(h=>{
      return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,"0")).join("");
    });
  }
  function nowISO(){ return new Date().toISOString(); }
  function fmtDT(iso){ const d=new Date(iso); return d.toLocaleString('sq-AL'); }
  function distanceMeters(lat1,lon1,lat2,lon2){
    // haversine
    const R=6371000;
    const toRad = x => x*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
  }

  // Mesai hesap: normal 07:00-16:00
  function calcShift(inISO,outISO){
    const inD=new Date(inISO), outD=new Date(outISO);
    if(outD<inD) return {regularMinutes:0,overtimeMinutes:0,totalMinutes:0};
    const total = (outD - inD)/60000;
    // create window for same day(s)
    let regular=0;
    // iterate minute windows per day (fast approach split by day)
    let cur=new Date(inD);
    while(cur < outD){
      const dayStart = new Date(cur); dayStart.setHours(7,0,0,0);
      const dayEnd = new Date(cur); dayEnd.setHours(16,0,0,0);
      const segStart = new Date(Math.max(cur, dayStart));
      const segEnd = new Date(Math.min(outD, dayEnd));
      if(segEnd > segStart) regular += (segEnd - segStart)/60000;
      // move to next day 00:00
      cur = new Date(cur); cur.setDate(cur.getDate()+1); cur.setHours(0,0,0,0);
    }
    const overtime = total - regular;
    return {regularMinutes: Math.round(regular), overtimeMinutes: Math.round(overtime), totalMinutes: Math.round(total)};
  }

  // ---------- UI binding ----------
  const userSelect = document.getElementById('userSelect');
  const passwordInput = document.getElementById('passwordInput');
  const btnLogin = document.getElementById('btnLogin');
  const btnOpenAsGuest = document.getElementById('btnOpenAsGuest');
  const btnClockIn = document.getElementById('btnClockIn');
  const btnManualOut = document.getElementById('btnManualOut');
  const manualOutTime = document.getElementById('manualOutTime');
  const noLocationCheckbox = document.getElementById('noLocationCheckbox');
  const currentUserLabel = document.getElementById('currentUserLabel');
  const btnLogout = document.getElementById('btnLogout');
  const btnLoadRecords = document.getElementById('btnLoadRecords');
  const recordsArea = document.getElementById('recordsArea');
  const filterFrom = document.getElementById('filterFrom');
  const filterTo = document.getElementById('filterTo');
  const btnShareWhatsApp = document.getElementById('btnShareWhatsApp');
  const btnExportCSV = document.getElementById('btnExportCSV');

  // admin
  const adminPanel = document.getElementById('adminPanel');
  const newName = document.getElementById('newName');
  const newPassword = document.getElementById('newPassword');
  const newLat = document.getElementById('newLat');
  const newLng = document.getElementById('newLng');
  const newRadius = document.getElementById('newRadius');
  const btnAddUser = document.getElementById('btnAddUser');
  const adminUsersList = document.getElementById('adminUsersList');
  const btnRefreshUsers = document.getElementById('btnRefreshUsers');

  let currentUser = null; // {id,name,role,...}

  // Load users to select
  async function loadUsers(){
    userSelect.innerHTML = '';
    const { data, error } = await supabase.from('users').select('*').order('name');
    if(error){ console.error(error); return; }
    data.forEach(u=>{
      const o = document.createElement('option');
      o.value = u.id;
      o.textContent = u.name + (u.role==='admin' ? ' (Admin)' : '');
      userSelect.appendChild(o);
    });
    refreshAdminList();
  }

  async function refreshAdminList(){
    const { data } = await supabase.from('users').select('*').order('name');
    adminUsersList.innerHTML = '';
    data.forEach(u=>{
      const div = document.createElement('div');
      div.className='d-flex align-items-center gap-2 py-2 border-bottom';
      div.innerHTML = `
        <div style="flex:1"><strong>${u.name}</strong><div class="small-muted">ID: ${u.id} • ${u.role}</div></div>
        <div class="text-end">
          <button class="btn btn-sm btn-outline-secondary btn-edit" data-id="${u.id}">Ndrysho</button>
          <button class="btn btn-sm btn-danger btn-del" data-id="${u.id}">Fshi</button>
        </div>
      `;
      adminUsersList.appendChild(div);
    });
    // attach
    adminUsersList.querySelectorAll('.btn-del').forEach(b=>{
      b.onclick = async ()=> {
        const id=b.dataset.id;
        if(!confirm('A jeni i sigurt që doni ta fshini?')) return;
        await supabase.from('users').delete().eq('id',id);
        await loadUsers();
      }
    });
    adminUsersList.querySelectorAll('.btn-edit').forEach(b=>{
      b.onclick = async ()=>{
        const id=b.dataset.id;
        const { data } = await supabase.from('users').select('*').eq('id',id).single();
        if(!data) return alert('User not found');
        newName.value = data.name;
        newLat.value = data.allowed_lat || '';
        newLng.value = data.allowed_lng || '';
        newRadius.value = data.allowed_radius_meters || 300;
        newPassword.value = ''; // leave blank
        btnAddUser.dataset.editId = id;
        window.scrollTo({top:0, behavior:'smooth'});
      }
    });
  }

  btnRefreshUsers.onclick = loadUsers;
  btnAddUser.onclick = async ()=>{
    const name = newName.value.trim();
    if(!name) return alert('Vendosni emrin');
    const password = newPassword.value.trim();
    const lat = parseFloat(newLat.value) || null;
    const lng = parseFloat(newLng.value) || null;
    const radius = parseInt(newRadius.value || '300');

    let payload = { name, allowed_lat: lat, allowed_lng: lng, allowed_radius_meters: radius, role:'worker' };
    // set password hash if provided
    if(password){
      payload.password_hash = await sha256hex(password);
    }
    if(btnAddUser.dataset.editId){
      const id=btnAddUser.dataset.editId;
      // don't overwrite password when blank
      if(!password) delete payload.password_hash;
      const { error } = await supabase.from('users').update(payload).eq('id',id);
      if(error) return alert('Gabim: ' + error.message);
      delete btnAddUser.dataset.editId;
    } else {
      // create
      if(!password) return alert('Vendos PIN për përdoruesin e ri');
      payload.password_hash = await sha256hex(password);
      const { error } = await supabase.from('users').insert([payload]);
      if(error) return alert('Gabim: ' + error.message);
    }
    newName.value=''; newPassword.value=''; newLat.value=''; newLng.value=''; newRadius.value='300';
    await loadUsers();
  }

  btnLogin.onclick = async ()=>{
    const id = userSelect.value;
    const pin = passwordInput.value.trim();
    if(!id || !pin) return alert('Zgjidhni punonjës dhe vendosni fjalëkalimin');
    const { data, error } = await supabase.from('users').select('*').eq('id',id).single();
    if(error || !data) return alert('Përdoruesi nuk u gjet');
    const hash = await sha256hex(pin);
    if(hash !== data.password_hash) return alert('Fjalëkalimi gabim');
    currentUser = data;
    onLogin();
  }

  btnOpenAsGuest.onclick = async ()=>{
    const id = userSelect.value;
    if(!id) return alert('Zgjidhni punonjës');
    const { data } = await supabase.from('users').select('*').eq('id',id).single();
    currentUser = data;
    currentUser.guest = true;
    onLogin();
  }

  btnLogout.onclick = ()=>{
    currentUser = null;
    currentUserLabel.textContent = 'Jo i identifikuar';
    btnLogout.style.display = 'none';
    adminPanel.style.display = 'none';
    document.getElementById('btnClockIn').disabled = false;
  }

  function onLogin(){
    currentUserLabel.textContent = currentUser.name + (currentUser.role==='admin' ? ' (Admin)' : '');
    btnLogout.style.display = 'inline-block';
    if(currentUser.role==='admin') adminPanel.style.display = 'block'; else adminPanel.style.display = 'none';
    document.getElementById('btnClockIn').disabled = false;
  }

  // Clock-in
  btnClockIn.onclick = async ()=>{
    if(!currentUser) return alert('Hyni me llogarinë tuaj ose zgjidhni si guest');
    const wantNoLoc = noLocationCheckbox.checked;
    let lat=null,lng=null, out_of_range=false;
    if(!wantNoLoc && navigator.geolocation){
      try{
        const pos = await new Promise((res,rej)=> navigator.geolocation.getCurrentPosition(res,rej,{timeout:15000}));
        lat = pos.coords.latitude; lng = pos.coords.longitude;
        if(currentUser.allowed_lat && currentUser.allowed_lng){
          const d = distanceMeters(currentUser.allowed_lat, currentUser.allowed_lng, lat, lng);
          out_of_range = d > (currentUser.allowed_radius_meters || 300);
        }
      }catch(e){
        console.warn('location err',e);
        if(!confirm('Lokacioni nuk u mor. Dërgo pa lokacion?')) return;
      }
    } else {
      if(!wantNoLoc && !navigator.geolocation) alert('Shfletuesi juaj nuk mbështet geolocation.');
    }

    const payload = {
      user_id: currentUser.id,
      type: 'in',
      timestamp: nowISO(),
      lat, lng, out_of_range
    };
    const { error } = await supabase.from('attendances').insert([payload]);
    if(error) return alert('Gabim në regjistrim: ' + error.message);
    alert('Regjistrim hyrje u ruajt: ' + fmtDT(payload.timestamp) + (out_of_range ? ' (Jeni jashtë zonës)' : ''));
  }

  // Manual out
  btnManualOut.onclick = async ()=>{
    if(!currentUser) return alert('Hyni me llogarinë tuaj ose zgjidhni si guest');
    const time = manualOutTime.value;
    if(!time) return alert('Zgjidhni orën e daljes');
    // Compose today's date + time
    const today = new Date();
    const [hh,mm] = time.split(':').map(x=>parseInt(x));
    const outD = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hh, mm, 0);
    const outISO = outD.toISOString();

    let lat=null,lng=null,out_of_range=false;
    const wantNoLoc = noLocationCheckbox.checked;
    if(!wantNoLoc && navigator.geolocation){
      try{
        const pos = await new Promise((res,rej)=> navigator.geolocation.getCurrentPosition(res,rej,{timeout:15000}));
        lat = pos.coords.latitude; lng = pos.coords.longitude;
        if(currentUser.allowed_lat && currentUser.allowed_lng){
          const d = distanceMeters(currentUser.allowed_lat, currentUser.allowed_lng, lat, lng);
          out_of_range = d > (currentUser.allowed_radius_meters || 300);
        }
      }catch(e){
        if(!confirm('Lokacioni nuk u mor. Dërgo pa lokacion?')) return;
      }
    }

    const payload = { user_id: currentUser.id, type:'out', timestamp: outISO, lat, lng, out_of_range };
    const { error } = await supabase.from('attendances').insert([payload]);
    if(error) return alert('Gabim në regjistrim: ' + error.message);
    alert('Regjistrim dalje u ruajt: ' + fmtDT(outISO) + (out_of_range ? ' (Jeni jashtë zonës)' : ''));
  }

  // Load records
  btnLoadRecords.onclick = async ()=>{
    if(!currentUser) return alert('Hyni me llogarinë tuaj ose zgjidhni si guest');
    const from = filterFrom.value ? new Date(filterFrom.value).toISOString() : null;
    const to = filterTo.value ? (new Date(filterTo.value).setHours(23,59,59,999), new Date(filterTo.value).toISOString()) : null;
    let query = supabase.from('attendances').select('*,users(name)').order('timestamp', {ascending:false});
    if(currentUser.role !== 'admin') query = query.eq('user_id', currentUser.id);
    if(from) query = query.gte('timestamp', from);
    if(to) query = query.lte('timestamp', new Date(filterTo.value + 'T23:59:59').toISOString());
    const { data, error } = await query;
    if(error) return alert('Gabim në marrjen e të dhënave: ' + error.message);
    recordsArea.innerHTML = '';
    if(!data || data.length===0){ recordsArea.textContent = 'Nuk ka regjistrime për periudhën.'; return; }
    // Pair up in/out by sequencing per user per day - but for simplicity, just list items and compute pairs by matching the closest previous 'in'
    // Build pairs
    const byUser = {};
    data.slice().reverse().forEach(r=>{ // chronological
      if(!byUser[r.user_id]) byUser[r.user_id] = [];
      byUser[r.user_id].push(r);
    });
    // for each user, build pairs
    let html = '';
    for(const uid in byUser){
      const arr = byUser[uid];
      html += `<div class="mb-2"><strong>${arr[0].users.name}</strong><div class="small-muted">(${arr.length} regjistrime)</div></div>`;
      for(let i=0;i<arr.length;i++){
        const r = arr[i];
        html += `<div class="border rounded p-2 mb-1"><div>${r.type.toUpperCase()}: ${fmtDT(r.timestamp)}</div>`;
        html += `<div class="small-muted">Lokacion: ${r.lat? r.lat.toFixed(5)+', '+r.lng.toFixed(5): 'Pa lokacion'} ${r.out_of_range ? ' • JASHTË ZONËS' : ''}</div>`;
        html += `</div>`;
      }
    }
    recordsArea.innerHTML = html;
  }

  // WhatsApp share/export
  btnShareWhatsApp.onclick = async ()=>{
    if(!currentUser) return alert('Hyni me llogarinë tuaj ose zgjidhni si guest');
    const from = filterFrom.value ? new Date(filterFrom.value) : null;
    const to = filterTo.value ? new Date(filterTo.value) : null;
    // fetch attendances
    let query = supabase.from('attendances').select('*').order('timestamp',{ascending:true});
    if(currentUser.role !== 'admin') query = query.eq('user_id', currentUser.id);
    if(from) query = query.gte('timestamp', from.toISOString());
    if(to) query = query.lte('timestamp', new Date(to.getFullYear(),to.getMonth(),to.getDate(),23,59,59).toISOString());
    const { data, error } = await query;
    if(error) return alert('Gabim: ' + error.message);
    if(!data || data.length===0) return alert('Nuk ka të dhëna për periudhën');

    // Build readable text grouped by day and pairs
    // We will pair ins and outs in chronological order for the user (simple algorithm)
    const grouped = {};
    for(const r of data){
      const day = r.timestamp.slice(0,10);
      if(!grouped[day]) grouped[day]=[];
      grouped[day].push(r);
    }
    let text = `Raporti i pranisë për ${currentUser.name || 'përdorues'}\n`;
    for(const day of Object.keys(grouped).sort()){
      text += `\n📅 ${day}\n`;
      const items = grouped[day];
      // pair sequentially: find in then next out
      for(let i=0;i<items.length;i++){
        const a = items[i];
        if(a.type==='in'){
          // find next out after index i
          let out = null;
          for(let j=i+1;j<items.length;j++){
            if(items[j].type==='out'){ out = items[j]; break; }
          }
          if(out){
            const c = calcShift(a.timestamp, out.timestamp);
            text += ` - Hyrje: ${new Date(a.timestamp).toLocaleTimeString('sq-AL')} • Dalje: ${new Date(out.timestamp).toLocaleTimeString('sq-AL')}\n   Mesai: ${Math.floor(c.totalMinutes/60)}h ${c.totalMinutes%60}m (Rregull: ${Math.floor(c.regularMinutes/60)}h ${c.regularMinutes%60}m, Overtime: ${Math.floor(c.overtimeMinutes/60)}h ${c.overtimeMinutes%60}m)\n`;
          } else {
            text += ` - Hyrje: ${new Date(a.timestamp).toLocaleTimeString('sq-AL')} • Dalje: - (ende pa dalje)\n`;
          }
        } else if(a.type==='out'){
          // if no previous in, show out only
          text += ` - Dalje: ${new Date(a.timestamp).toLocaleTimeString('sq-AL')} (pa hyrje të regjistruar)\n`;
        }
      }
    }

    // prepare WhatsApp link
    const encoded = encodeURIComponent(text);
    const waLink = `https://wa.me/?text=${encoded}`;
    window.open(waLink,'_blank');
  }

  btnExportCSV.onclick = async ()=>{
    if(!currentUser) return alert('Hyni me llogarinë tuaj');
    const from = filterFrom.value ? new Date(filterFrom.value).toISOString() : null;
    const to = filterTo.value ? new Date(filterTo.value + 'T23:59:59').toISOString() : null;
    let query = supabase.from('attendances').select('*,users(name)').order('timestamp',{ascending:true});
    if(currentUser.role!=='admin') query = query.eq('user_id', currentUser.id);
    if(from) query = query.gte('timestamp', from);
    if(to) query = query.lte('timestamp', to);
    const { data } = await query;
    if(!data) return alert('Nuk ka të dhëna');
    let csv = 'user,name,type,timestamp,lat,lng,out_of_range\n';
    data.forEach(r=>{
      csv += `${r.user_id},"${r.users?.name||''}",${r.type},${r.timestamp},${r.lat||''},${r.lng||''},${r.out_of_range?1:0}\n`;
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download = 'attendances.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  // initial load
  loadUsers();

  // openAppBtn scroll into view
  document.getElementById('openAppBtn').onclick = ()=> window.scrollTo({top:0, behavior:'smooth'});
  </script>
</body>
</html>
