<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Regjistrime Orari • DEBUG</title>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#0d1117;color:#c9d1d9;margin:0}
.container{max-width:980px;margin:0 auto;padding:16px}
.card{background:#161b22;border:1px solid #30363d;border-radius:14px;padding:16px;margin:12px 0}
.input,select,button,textarea{padding:10px 12px;border-radius:10px;border:1px solid #30363d;background:#0b0f14;color:#c9d1d9}
button{cursor:pointer}
pre{white-space:pre-wrap;background:#0b0f14;border:1px solid #30363d;padding:12px;border-radius:10px;max-height:320px;overflow:auto}
small{color:#8b949e}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row>*{flex:1 1 240px}
</style>
</head>
<body>
<div class="container">
  <h1>DEBUG • Hyrje problemi ayıklama</h1>
  <div class="card">
    <p>Adımlar:</p>
    <ol>
      <li><b>Load Employees</b> → dropdown doluyor mu?</li>
      <li><b>Try Login</b> → seçili kullanıcıyı ve PIN'i test eder.</li>
    </ol>
    <div class="row">
      <div>
        <label>Përdoruesi</label>
        <select id="sel" class="input"></select>
      </div>
      <div>
        <label>PIN</label>
        <input id="pin" class="input" placeholder="PIN">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="b1">Load Employees</button>
      <button id="b2">Try Login</button>
    </div>
  </div>
  <div class="card">
    <h3>Log</h3>
    <pre id="log">(no log)</pre>
    <small>Hata/çıktıları burada görüp bana ekran görüntüsü atabilirsin.</small>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
<script>
const sb = supabase.createClient(
  "https://oqrukzyimkwacdniavya.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xcnVrenlpbWt3YWNkbmlhdnlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODg3MTgsImV4cCI6MjA3NDk2NDcxOH0.Z0gxZL72qWFcI-wJinQT_NEUBDaUk4qP0mP1acqXJbI"
);
const logEl = document.getElementById('log');
function log(){ logEl.textContent += '\n' + Array.from(arguments).map(x=> typeof x==='string'? x : JSON.stringify(x,null,2)).join(' '); }
async function loadEmployees(){
  log('STEP loadEmployees: start');
  const res = await sb.from('employees').select('id,name,role,active,pin_hash,home_lat,home_lng,home_radius_m').order('name',{ascending:true});
  log('employees SELECT result:', res);
  const sel = document.getElementById('sel');
  sel.innerHTML='';
  if(res.error){ return; }
  if(!res.data || res.data.length===0){ log('No rows in employees'); return; }
  res.data.forEach(r=>{
    const o=document.createElement('option');
    o.value=r.id; o.textContent=`${r.name} (${r.role}) [active=${r.active}]`;
    sel.appendChild(o);
  });
  log('STEP loadEmployees: done; count=', res.data.length);
}
async function tryLogin(){
  const id = document.getElementById('sel').value;
  const pin = document.getElementById('pin').value.trim();
  if(!id){ log('No user selected'); return; }
  if(!pin){ log('No PIN'); return; }
  log('STEP tryLogin for id=', id);
  const res = await sb.from('employees').select('id,name,role,active,pin_hash,home_lat,home_lng,home_radius_m').eq('id', id).single();
  log('SELECT single result:', res);
  if(res.error){ return; }
  const ok = await bcrypt.compare(pin, res.data.pin_hash||'');
  log('bcrypt compare:', ok? 'OK':'FAIL');
  if(ok){ log('LOGIN OK ✅ name='+res.data.name+' role='+res.data.role); }
  else{ log('LOGIN FAIL ❌ (PIN yanlış)'); }
}
document.getElementById('b1').onclick = loadEmployees;
document.getElementById('b2').onclick = tryLogin;
loadEmployees();
</script>
</body>
</html>
