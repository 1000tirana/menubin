<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>Normal Holding • Shpenzimet</title>
<meta name="theme-color" content="#0d1117">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL@1,0;wght@400..700" rel="stylesheet">
<style>
:root{
  --bg:#0d1117;--card:#161b22;--border:#30363d;--text:#c9d1d9;--muted:#8b949e;
  --primary:#2ea043;--primary2:#238636;--blue:#1f6feb;--danger:#f85149;
  --navh:86px; --safe-top:env(safe-area-inset-top,0px); --safe-bottom:env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box} html,body{height:100%;background:var(--bg);color:var(--text);margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
.wrap{display:flex;flex-direction:column;min-height:100vh;padding-bottom:calc(var(--navh)+var(--safe-bottom))}
header{background:linear-gradient(135deg,var(--primary2),var(--primary));color:#fff;padding:calc(12px+var(--safe-top)) 14px 12px;border-bottom-left-radius:20px;border-bottom-right-radius:20px}
header .row{display:flex;justify-content:space-between;align-items:center}
header .title{display:flex;gap:8px;font-size:20px;font-weight:900;margin-top:6px}
header .big{font-size:30px;font-weight:900;margin-top:8px}
header .muted{opacity:.9}
.stats{display:flex;gap:10px;padding:10px 12px;transform:translateY(-10px)}
.card{flex:1;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
main{padding:0 12px 20px}

.msr{font-family:"Material Symbols Rounded";font-weight:400;font-style:normal;font-size:24px;line-height:1;display:inline-block}
.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#21262d;color:#e6edf3;padding:6px 10px;border-radius:999px;font-weight:800;cursor:pointer}
.chip.active{background:#1f6feb;color:#fff;border-color:#1f6feb}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

h3.sec{margin:0 0 10px}
.list{display:flex;flex-direction:column;gap:10px}
.item{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
.ic{width:44px;height:44px;display:grid;place-items:center;font-size:26px}
.meta{flex:1;min-width:0}.meta .t{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.meta .s{font-size:12px;color:var(--muted)}
.amt{font-weight:900}
.badge{font-size:12px;padding:2px 6px;border-radius:999px;background:#21262d;border:1px solid var(--border);margin-left:6px}

input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text);font-size:16px;-webkit-appearance:none}
label{font-size:13px;color:var(--muted)}
.rowf{display:flex;gap:10px}
.btnP,.btnS{padding:12px 16px;border-radius:12px;border:1px solid var(--border);font-weight:800;cursor:pointer}
.btnP{flex:1;background:linear-gradient(180deg,var(--primary),var(--primary2));border-color:#2ea043;color:#fff}
.btnS{flex:1;background:#21262d;color:#e6edf3}

details.box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px 12px}
details.box>summary{cursor:pointer;font-weight:800;color:#e6edf3;list-style:none}
details.box>summary::-webkit-details-marker{display:none}

nav.nav{
  --fab-gap:110px; position:fixed;left:0;right:0;bottom:0;height:calc(var(--navh)+var(--safe-bottom));
  padding:0 12px var(--safe-bottom);background:var(--card);border-top:1px solid var(--border);
  display:grid;grid-template-columns:1fr 1fr var(--fab-gap) 1fr 1fr;align-items:center;z-index:2000
}
.nav .btn{justify-self:center;display:flex;flex-direction:column;align-items:center;color:var(--muted);gap:4px;cursor:pointer}
.nav .btn.active{color:#79c0ff}
.nav .ico{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;background:#21262d;border:1px solid var(--border)}
.nav .fab{position:absolute;left:50%;transform:translateX(-50%);top:-24px;width:64px;height:64px;border-radius:999px;display:grid;place-items:center;font-size:32px;border:1px solid rgba(255,255,255,.06);background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%)}

.tab{display:none}.tab.active{display:block}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:end;padding:14px;z-index:3000}
.modal.on{display:grid}
.sheet{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 14px 18px;width:100%}

.gate{position:fixed;inset:0;display:none;place-items:center;background:var(--bg);padding:18px;z-index:4000}
.panel{background:var(--card);border:1px solid var(--border);width:min(520px,92vw);border-radius:16px;padding:18px}
.tabs{display:flex;gap:6px;margin-bottom:10px}
.tabs button{flex:1;border:1px solid var(--border);padding:10px;border-radius:10px;background:#21262d;color:#e6edf3;cursor:pointer}
.tabs button.active{background:linear-gradient(180deg,var(--primary),var(--primary2));border-color:#2ea043;color:#fff}
.picker-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;max-height:45vh;overflow:auto;margin-top:8px}
.picker-grid button{border:1px solid var(--border);background:#21262d;border-radius:10px;width:44px;height:44px;font-size:22px;cursor:pointer}

@media(min-width:720px){.wrap{max-width:520px;margin:0 auto}}
</style>
</head>
<body>

<!-- GİRİŞ -->
<div id="gate" class="gate">
  <div class="panel">
    <div class="tabs">
      <button id="tabLoginBtn" class="active" onclick="swapAuth('login')">Hyr</button>
      <button id="tabRegBtn" onclick="swapAuth('reg')">Regjistrohu</button>
    </div>
    <div id="authLogin">
      <label>Email</label><input id="loginEmail" placeholder="user@email.com" autocomplete="username">
      <div class="rowf" style="margin-top:8px"><div style="flex:1"><label>Fjalëkalimi</label><input id="loginPass" type="password" autocomplete="current-password" placeholder="••••••"></div></div>
      <div class="rowf" style="margin-top:8px"><button class="btnP" onclick="login()">Hyr</button></div>
      <div id="authMsg" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="authReg" style="display:none">
      <label>Email</label><input id="regEmail" placeholder="user@email.com" autocomplete="username">
      <div class="rowf" style="margin-top:8px"><div style="flex:1"><label>Fjalëkalimi</label><input id="regPass" type="password" autocomplete="new-password" placeholder="min. 6"></div></div>
      <div class="rowf" style="margin-top:8px"><button class="btnS" onclick="swapAuth('login')">Kthehu</button><button class="btnP" onclick="registerUser()">Krijo</button></div>
      <div id="regMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="wrap" id="app" style="display:none">
  <header>
    <div class="row"><div style="font-weight:900">Normal Holding</div><div class="muted" id="who">@user</div></div>
    <div class="title"><span class="msr">savings</span><span id="hdrText">Bilanci</span></div>
    <div class="big" id="hdrVal">0</div>
    <div class="muted" id="hdrSub">Gjendja − shpenzimet (cüzdan)</div>
    <!-- GEÇİCİ CÜZDAN SEÇİMİ -->
    <div class="chips" id="walletChips"></div>
    <!-- Toplam Net (kurla) -->
    <div class="muted" style="margin-top:8px">🌐 Toplam net (seçili PB): <b id="totalNet">0</b> — Kur: <span id="fxTime">—</span></div>
  </header>

  <div class="stats">
    <div class="card"><div class="muted" id="s1name">📊 Totale</div><div style="font-weight:800" id="stat1">0</div></div>
    <div class="card"><div class="muted" id="s2name">📅 Sot</div><div style="font-weight:800" id="stat2">0</div></div>
    <div class="card"><div class="muted" id="s3name">🗓️ Muaj</div><div style="font-weight:800" id="stat3">0</div></div>
  </div>

  <main>
    <!-- HOME -->
    <section id="tab-home" class="tab active">
      <h3 class="sec">👛 Cüzdanlar</h3>
      <div id="wallets" class="list"></div>

      <h3 class="sec" style="margin-top:14px">🕒 Të fundit</h3>
      <div id="recentList" class="list"></div>
      <div id="emptyHome" class="muted" style="text-align:center;margin-top:12px">Asnjë hyrje.</div>
    </section>

    <!-- LİSTE -->
    <section id="tab-list" class="tab">
      <h3 class="sec">📋 Lista</h3>
      <div class="rowf" style="margin-bottom:8px">
        <input id="q" placeholder="Kërko..." oninput="drawAll()">
        <select id="fCat" onchange="drawAll()"><option value="">Të gjitha</option></select>
      </div>
      <div id="allList" class="list"></div>
    </section>

    <!-- BORÇ -->
    <section id="tab-debts" class="tab">
      <h3 class="sec">💳 Borxhet</h3>
      <div class="rowf" style="margin-bottom:8px"><input id="dq" placeholder="Kërko..." oninput="drawDebts()"></div>
      <div class="list" id="debtList"></div>
      <div id="emptyDebts" class="muted" style="text-align:center;margin-top:12px">Asnjë borxh.</div>
    </section>

    <!-- AYARLAR -->
    <section id="tab-settings" class="tab">
      <h3 class="sec">⚙️ Cilësime</h3>
      <div class="item">
        <div class="ic">👤</div>
        <div class="meta"><div class="t">Përdoruesi</div><div class="s" id="userInfo">—</div></div>
        <button class="btnS" onclick="logout()"><span class="msr">logout</span>&nbsp;Dil</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">💱 Varsayılan cüzdan & format</h4>
        <div class="rowf">
          <div style="flex:1"><label>Varsayılan para birimi</label>
            <select id="prefCurrency"><option>ALL</option><option>EUR</option><option>TRY</option><option>USD</option></select></div>
          <div style="flex:1"><label>Format</label>
            <select id="prefFormat"><option value="eu">23.456,78</option><option value="us">23,456.78</option></select></div>
        </div>
        <div class="rowf" style="margin-top:10px"><button class="btnP" onclick="savePrefs()">Kaydet</button></div>
        <div class="muted" style="margin-top:6px">Not: Başlıkta yaptığın seçim <b>geçici</b>dir; yenileyince yine buradaki seçim geçerli olur.</div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">🏦 Cüzdan bakiyesi (seçili PB: <span id="currTag">ALL</span>)</h4>
        <input id="balInput" type="number" step="0.01" inputmode="decimal" placeholder="p.sh. 5000">
        <div class="rowf" style="margin-top:10px"><button class="btnP" onclick="saveBalance()">Bakiyeyi kaydet</button></div>
        <div id="balMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <details class="box" style="margin-top:12px">
        <summary>📂 Kategoriler</summary>
        <div id="catList" class="list" style="margin-top:8px"></div>
        <div style="border-top:1px solid var(--border);margin:10px 0"></div>
        <div class="rowf">
          <div style="width:120px">
            <label>Emoji</label>
            <button class="btnS" id="emojiBtn" onclick="openEmojiPicker()"> <span id="emojiPreview" style="font-size:22px">🍔</span> &nbsp;Seç</button>
            <input id="newCatEmoji" value="🍔" hidden>
          </div>
          <div style="flex:1"><label>Ad</label><input id="newCatName" placeholder="p.sh. Ushqime"></div>
        </div>
        <div class="rowf" style="margin-top:10px"><button class="btnP" onclick="addCategory()">Ekle</button></div>
        <div id="catMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </details>
    </section>
  </main>
</div>

<!-- NAV -->
<nav class="nav" id="navbar" style="display:none">
  <div class="btn active" data-tab="home" onclick="switchTab('home')"><div class="ico"><span class="msr">home</span></div><small>Kreu</small></div>
  <div class="btn" data-tab="list" onclick="switchTab('list')"><div class="ico"><span class="msr">list</span></div><small>Lista</small></div>
  <div class="btn" data-tab="debts" onclick="switchTab('debts')"><div class="ico"><span class="msr">credit_card</span></div><small>Borxhet</small></div>
  <div class="btn" data-tab="settings" onclick="switchTab('settings')"><div class="ico"><span class="msr">settings</span></div><small>Cilësime</small></div>
  <button class="fab" id="openAdd">＋</button>
</nav>

<!-- MODAL: harcama -->
<div class="modal" id="modalExp"><div class="sheet">
  <h3 style="margin:4px 0 10px">➕ Shpenzim i ri</h3>
  <div class="rowf"><div style="flex:2"><label>Ad</label><input id="mName" placeholder="Karburant"></div><div style="flex:1"><label>Tutar</label><input id="mAmt" type="number" step="0.01" inputmode="decimal"></div></div>
  <div class="rowf" style="margin-top:8px"><div style="flex:1"><label>Kategori</label><select id="mCat"></select></div><div style="flex:1"><label>Tarih</label><input id="mDate" type="date"></div></div>
  <div class="rowf" style="margin-top:10px"><button class="btnS" onclick="closeModal('Exp')">Kapat</button><button class="btnP" onclick="saveExpense()">Kaydet</button></div>
</div></div>

<!-- MODAL: borç -->
<div class="modal" id="modalDebt"><div class="sheet">
  <h3 style="margin:4px 0 10px">➕ Borxh i ri</h3>
  <div class="rowf"><div style="flex:1"><label>Taraf</label><input id="dParty" placeholder="Arben"></div><div style="flex:1"><label>Tutar</label><input id="dAmt" type="number" step="0.01" inputmode="decimal"></div></div>
  <div class="rowf" style="margin-top:8px"><div style="flex:1"><label>Açıklama</label><input id="dName" placeholder="opsionale"></div><div style="flex:1"><label>Vade</label><input id="dDate" type="date"></div></div>
  <div class="rowf" style="margin-top:10px"><button class="btnS" onclick="closeModal('Debt')">Kapat</button><button class="btnP" onclick="saveDebt()">Kaydet</button></div>
</div></div>

<!-- MODAL: emoji -->
<div class="modal" id="modalEmoji"><div class="sheet">
  <h3 style="margin:4px 0 10px">🙂 Emoji seç</h3>
  <div id="emojiGrid" class="picker-grid"></div>
  <div class="rowf" style="margin-top:8px"><button class="btnS" onclick="closeModal('Emoji')">Kapat</button></div>
</div></div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* Supabase — kendi URL/Anon anahtarını yaz */
const SUPABASE_URL  = 'https://nvpjqvggaiipwziolend.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cGpxdmdnYWlpcHd6aW9sZW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4OTExNzcsImV4cCI6MjA3NDQ2NzE3N30.PnJh09kx-kK8iChgQl2M1eTw5P2qRZUEO31wVY7_iP4';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* Uygulama durumu */
let sessionUser=null, items=[], debts=[], cats=[];
let profile={default_currency:'ALL', num_format:'eu', balances:{}};
let tempCurr=null;                       // başlıktaki geçici seçim
const ALLCURR=['ALL','EUR','TRY','USD'];
let ratesBaseUSD=null, ratesTime='—';    // canlı kur (USD bazlı)

/* Yardımcılar */
function nf(){return new Intl.NumberFormat(profile.num_format==='us'?'en-US':'de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});}
function money(n,c){return nf().format(Number(n||0))+' '+(c??currentCurr());}
function currentCurr(){return tempCurr || profile.default_currency || 'ALL';}
function emailShort(e){return e?e.split('@')[0]:'@user'}
function isToday(x){const d=new Date(x.d),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()&&d.getDate()==t.getDate()}
function isThisMonth(x){const d=new Date(x.d),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()}
function convert(amount,from,to){ if(from===to) return Number(amount||0); if(!ratesBaseUSD) return Number(amount||0); return Number(amount||0) * (ratesBaseUSD[to]/ratesBaseUSD[from]); }

/* Kur çekme */
async function loadFx(){
  try{
    const r=await fetch('https://api.exchangerate.host/latest?base=USD&symbols=ALL,EUR,TRY,USD');
    const j=await r.json(); ratesBaseUSD=j.rates; ratesTime=new Date(j.date+'T00:00:00').toLocaleDateString();
    document.getElementById('fxTime').textContent=ratesTime;
    refreshHeader();
  }catch(e){console.warn('FX error',e)}
}

/* Auth */
async function registerUser(){const email=document.getElementById('regEmail').value.trim(), pass=document.getElementById('regPass').value;
  const box=document.getElementById('regMsg'); box.textContent='';
  if(!email||pass.length<6){box.textContent='Email / şifre (min.6)';return;}
  const {error}=await supabase.auth.signUp({email,password:pass}); box.textContent=error?('Hata: '+error.message):'Mail onayı gönderildi.';}
async function login(){const email=document.getElementById('loginEmail').value.trim(), pass=document.getElementById('loginPass').value;
  const box=document.getElementById('authMsg'); const {error}=await supabase.auth.signInWithPassword({email,password:pass});
  if(error) box.textContent='Hata: '+error.message;}
async function logout(){await supabase.auth.signOut()}

/* Profil / tercih */
async function ensureProfile(){
  let {data}=await supabase.from('profiles').select('*').eq('user_id',sessionUser.id).maybeSingle();
  if(!data){
    const ins={user_id:sessionUser.id, default_currency:'ALL', num_format:'eu', balances:{}};
    const {data:created}=await supabase.from('profiles').insert(ins).select().single();
    data=created;
  }
  profile=data||profile; tempCurr=null;
  document.getElementById('prefCurrency').value=profile.default_currency;
  document.getElementById('prefFormat').value=profile.num_format;
  document.getElementById('balInput').value=Number(profile.balances[currentCurr()]||0);
  document.getElementById('currTag').textContent=currentCurr();
  drawWalletChips();
  refreshHeader();
}
async function savePrefs(){
  const c=document.getElementById('prefCurrency').value, f=document.getElementById('prefFormat').value;
  const {data,error}=await supabase.from('profiles').update({default_currency:c,num_format:f}).eq('user_id',sessionUser.id).select().single();
  if(error){alert('Hata: '+error.message);return;}
  profile=data; tempCurr=null; drawWalletChips(); document.getElementById('balInput').value=Number(profile.balances[currentCurr()]||0); refreshHeader(); drawAll(); drawDebts(); drawWallets();
}
async function saveBalance(){
  const v=parseFloat(document.getElementById('balInput').value||'0')||0;
  const b={...(profile.balances||{})}; b[currentCurr()]=v;
  const {data,error}=await supabase.from('profiles').update({balances:b}).eq('user_id',sessionUser.id).select().single();
  const box=document.getElementById('balMsg'); if(error){box.textContent='Hata: '+error.message;return;}
  profile=data; box.textContent='Kaydedildi.'; refreshHeader(); drawWallets();
}

/* Kategoriler */
const DEFAULT_CATS=[{name:'Ushqime',emoji:'🍔'},{name:'Transport',emoji:'⛽'},{name:'Shtëpia',emoji:'🏠'},{name:'Argëtim',emoji:'🎟️'},{name:'Fatura',emoji:'💡'},{name:'Të tjera',emoji:'🧾'}];
async function ensureCategoriesSeed(){
  const {data}=await supabase.from('categories').select('id').eq('user_id',sessionUser.id).limit(1);
  if(!data||!data.length) await supabase.from('categories').insert(DEFAULT_CATS.map(c=>({...c,user_id:sessionUser.id})));
}
async function loadCategories(){
  const {data}=await supabase.from('categories').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:true});
  cats=(data||[]).map(r=>({id:r.id,name:r.name,emoji:r.emoji}));
  const list=document.getElementById('catList'); list.innerHTML='';
  cats.forEach(c=>{const el=document.createElement('div');el.className='item';
    el.innerHTML=<div class="ic">${c.emoji||'•'}</div><div class="meta"><div class="t">${c.name}</div><div class="s">Kişisel</div></div><button class="btnS" onclick="delCat('${c.id}')">Sil</button>;
    list.appendChild(el);
  });
  // seçimler
  const m=document.getElementById('mCat'), f=document.getElementById('fCat'); if(m) m.innerHTML=''; if(f) f.innerHTML='<option value="">Të gjitha</option>';
  cats.forEach(c=>{const o=new Option(${c.emoji||'•'} ${c.name},c.name); m?.appendChild(o); f?.appendChild(new Option(c.name,c.name));});
}
async function addCategory(){
  const name=(document.getElementById('newCatName').value||'').trim(), emoji=document.getElementById('newCatEmoji').value||'🧾';
  const msg=document.getElementById('catMsg'); msg.textContent='';
  if(!name){msg.textContent='Ad gerekli.';return;}
  const {data,error}=await supabase.from('categories').insert({user_id:sessionUser.id,name,emoji}).select().single();
  if(error){msg.textContent='Hata: '+error.message;return;}
  document.getElementById('newCatName').value=''; await loadCategories(); msg.textContent='Eklendi.';
}
async function delCat(id){if(!confirm('Silinsin mi?')) return; await supabase.from('categories').delete().eq('id',id).eq('user_id',sessionUser.id); loadCategories();}
function openEmojiPicker(){openModal('Emoji')}
function drawEmojiGrid(){const picks='🍔 🥗 🍕 🍰 ☕ 🍺 🛒 🚌 ⛽ 🚕 🛠️ 🧽 🎁 🎮 🎬 🎟️ 💡 📱 💻 🏠 ⚽ 🧾 💊 ✈️ 🚗 🪙 💳 🎓 📚 🔌 🔋 👟 🍼 🧻 🧴'.split(' ');
  const grid=document.getElementById('emojiGrid'); picks.forEach(e=>{const b=document.createElement('button');b.textContent=e;b.onclick=()=>{document.getElementById('newCatEmoji').value=e;document.getElementById('emojiPreview').textContent=e;closeModal('Emoji')};grid.appendChild(b)});}

/* Harcamalar */
function emojiFor(cat){const f=cats.find(c=>c.name===cat);return f?f.emoji:'💸';}
async function loadExpenses(){const {data,error}=await supabase.from('expenses').select('*').eq('user_id',sessionUser.id).order('d',{ascending:false}).limit(2000); if(error){alert('Hata (expenses): '+error.message);return;} items=data||[]; drawHome(); drawAll(); refreshHeader(); drawWallets();}
async function saveExpense(){
  const name=document.getElementById('mName').value.trim(), amt=parseFloat(document.getElementById('mAmt').value), cat=document.getElementById('mCat').value, d=document.getElementById('mDate').value;
  if(!name||!amt||!d){alert('Ad, tutar, tarih gerekir.');return;}
  const curr=currentCurr(); const {data,error}=await supabase.from('expenses').insert({user_id:sessionUser.id,name,amount:amt,category:cat,d,curr}).select().single();
  if(error){alert('Hata: '+error.message);return;}
  items.unshift(data); closeModal('Exp'); document.getElementById('mName').value=''; document.getElementById('mAmt').value=''; drawHome(); drawAll(); refreshHeader(); drawWallets();
}
async function delExpense(id){if(!confirm('Silinsin mi?'))return; await supabase.from('expenses').delete().eq('id',id).eq('user_id',sessionUser.id); items=items.filter(x=>x.id!==id); drawHome(); drawAll(); refreshHeader(); drawWallets();}
function rowExpense(x){const el=document.createElement('div');el.className='item';
  el.innerHTML=`<div class="ic">${emojiFor(x.category)}</div>
  <div class="meta"><div class="t">${x.name}<span class="badge">${x.curr||'ALL'}</span></div><div class="s">${x.category||'—'} • ${new Date(x.d+'T00:00:00').toLocaleDateString('sq-AL')}</div></div>
  <div class="amt">${money(x.amount,x.curr)}</div>
  <button class="btnS" onclick="delExpense('${x.id}')">Sil</button>`;
  return el;}
function drawHome(){
  const list=document.getElementById('recentList'); list.innerHTML='';
  const rec=[...items].sort((a,b)=>b.d.localeCompare(a.d)).slice(0,8);
  rec.forEach(x=>list.appendChild(rowExpense(x)));
  document.getElementById('emptyHome').style.display=rec.length?'none':'block';
}
function drawAll(){
  const q=(document.getElementById('q')?.value||'').toLowerCase(), cat=document.getElementById('fCat')?.value||'';
  let arr=[...items]; if(q) arr=arr.filter(x=>x.name.toLowerCase().includes(q)||(x.category||'').toLowerCase().includes(q)); if(cat) arr=arr.filter(x=>x.category===cat);
  const box=document.getElementById('allList'); box.innerHTML=''; arr.forEach(x=>box.appendChild(rowExpense(x)));
}

/* Borçlar */
async function loadDebts(){const {data,error}=await supabase.from('debts').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:false}); if(error){alert('Hata (debts): '+error.message);return;} debts=data||[]; drawDebts(); refreshHeader(); drawWallets();}
async function saveDebt(){const party=document.getElementById('dParty').value.trim(), name=document.getElementById('dName').value.trim(), amt=parseFloat(document.getElementById('dAmt').value), due=document.getElementById('dDate').value||null;
  if(!party||!amt){alert('Taraf ve tutar gerekir');return;} const curr=currentCurr(); const row={user_id:sessionUser.id,party,name,amount:amt,kind:'borrow',due,status:'open',curr};
  const {data,error}=await supabase.from('debts').insert(row).select().single(); if(error){alert('Hata: '+error.message);return;} debts.unshift(data); closeModal('Debt'); drawDebts(); refreshHeader(); drawWallets();}
async function delDebt(id){if(!confirm('Silinsin mi?'))return; await supabase.from('debts').delete().eq('id',id).eq('user_id',sessionUser.id); debts=debts.filter(x=>x.id!==id); drawDebts(); refreshHeader(); drawWallets();}
async function payDebt(id){if(!confirm('Ödendi işaretlensin?'))return; const {data,error}=await supabase.from('debts').update({status:'paid'}).eq('id',id).eq('user_id',sessionUser.id).select().single(); if(!error){debts=debts.map(x=>x.id===id?data:x); drawDebts(); refreshHeader();}}
function drawDebts(){
  const box=document.getElementById('debtList'); box.innerHTML='';
  debts.forEach(x=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div class="ic">${x.status==='paid'?'✅':'💳'}</div>
      <div class="meta"><div class="t">${x.party}<span class="badge">${x.curr||'ALL'}</span></div>
      <div class="s">${x.name||''} ${x.due?('• Afat: '+new Date(x.due+'T00:00:00').toLocaleDateString('sq-AL')):''}</div></div>
      <div class="amt">${money(x.amount,x.curr)}</div>
      ${x.status==='open'
        ? <button class="btnS" onclick="payDebt('${x.id}')">Paguaj</button>
        : <span class="badge">Paguar</span>}
      <button class="btnS" onclick="delDebt('${x.id}')">Sil</button>`;
    box.appendChild(el);
  });
  document.getElementById('emptyDebts').style.display=debts.length?'none':'block';
}

/* Cüzdanlar & özetler */
function spentByCurrency(){
  const map={}; items.forEach(x=>{const c=x.curr||'ALL'; map[c]=(map[c]||0)+Number(x.amount||0)}); return map;
}
function walletValue(currency){ // bakiye - gider
  const bal=Number((profile.balances||{})[currency]||0);
  const sp =Number(spentByCurrency()[currency]||0);
  return bal - sp;
}
function drawWallets(){
  const box=document.getElementById('wallets'); box.innerHTML='';
  const sp=spentByCurrency();
  ALLCURR.forEach(c=>{
    const el=document.createElement('div'); el.className='item';
    const bal=Number((profile.balances||{})[c]||0);
    const rem=walletValue(c);
    el.innerHTML=`<div class="ic">👛</div>
      <div class="meta"><div class="t">${c} cüzdanı</div><div class="s">Bakiye: ${nf().format(bal)} • Harcama: ${nf().format(sp[c]||0)}</div></div>
      <div class="amt">${nf().format(rem)} ${c}</div>`;
    box.appendChild(el);
  });
}
function drawWalletChips(){
  const row=document.getElementById('walletChips'); row.innerHTML='';
  ALLCURR.forEach(c=>{const b=document.createElement('button');b.className='chip'; if(currentCurr()===c) b.classList.add('active');
    b.innerHTML=<span class="msr">account_balance_wallet</span>${c};
    b.onclick=()=>{tempCurr=c; document.getElementById('balInput').value=Number((profile.balances||{})[currentCurr()]||0); document.getElementById('currTag').textContent=currentCurr(); drawWalletChips(); refreshHeader();};
    row.appendChild(b);
  });
}

/* Başlık ve istatistikler */
function refreshHeader(){
  const curr=currentCurr();
  // ana başlık net = bakiye(curr) - harcamalar(curr)
  const net=walletValue(curr);
  document.getElementById('hdrVal').textContent = nf().format(net)+' '+curr;
  document.getElementById('hdrSub').textContent = 'Cüzdan: '+curr+' • format '+(profile.num_format==='us'?'23,456.78':'23.456,78');
  document.getElementById('who').textContent = emailShort(sessionUser?.email);
  // istatistikler (sadece curr'e ait)
  const today=items.filter(x=>x.curr===curr && isToday(x)).reduce((s,a)=>s+Number(a.amount||0),0);
  const month=items.filter(x=>x.curr===curr && isThisMonth(x)).reduce((s,a)=>s+Number(a.amount||0),0);
  const total=items.filter(x=>x.curr===curr).reduce((s,a)=>s+Number(a.amount||0),0);
  document.getElementById('stat1').textContent=money(total,curr);
  document.getElementById('stat2').textContent=money(today,curr);
  document.getElementById('stat3').textContent=money(month,curr);
  // toplam net (tüm cüzdanların seçili PB'ye çevrilip toplanması)
  let tot=0; ALLCURR.forEach(c=>{tot += convert(walletValue(c), c, curr);});
  document.getElementById('totalNet').textContent=nf().format(tot)+' '+curr;
}

/* Modal yardımcıları */
function openModal(tag){document.getElementById('modal'+tag).classList.add('on')}
function closeModal(tag){document.getElementById('modal'+tag).classList.remove('on')}
function switchTab(t){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); document.querySelectorAll('.nav .btn').forEach(x=>x.classList.remove('active')); document.querySelector(.nav .btn[data-tab="${t}"]).classList.add('active');}

/* Başlangıç */
document.addEventListener('DOMContentLoaded', async () => {
  // Emoji grid
  drawEmojiGrid();
  // FAB: home→harcama, debts→borç
  document.getElementById('openAdd').addEventListener('click',()=>{const t=document.querySelector('.nav .btn.active').dataset.tab; if(t==='debts') openModal('Debt'); else openModal('Exp');});
  // Tarih default
  document.getElementById('mDate').value=new Date().toISOString().slice(0,10);
  document.getElementById('dDate').value=new Date().toISOString().slice(0,10);

  // Auth session
  const s=await supabase.auth.getSession(); if(s.data.session?.user){sessionUser=s.data.session.user; showApp();} else showGate();
  supabase.auth.onAuthStateChange(async (_e,session)=>{if(session?.user){sessionUser=session.user; showApp();} else showGate();});

  async function showApp(){
    document.getElementById('gate').style.display='none';
    document.getElementById('app').style.display='block';
    document.getElementById('navbar').style.display='grid';
    await ensureProfile(); await ensureCategoriesSeed(); await loadCategories(); await loadExpenses(); await loadDebts(); await loadFx();
  }
  function showGate(){document.getElementById('gate').style.display='grid';document.getElementById('app').style.display='none';document.getElementById('navbar').style.display='none';}
});
function swapAuth(w){document.getElementById('tabLoginBtn').classList.toggle('active',w==='login');document.getElementById('tabRegBtn').classList.toggle('active',w==='reg');document.getElementById('authLogin').style.display=w==='login'?'block':'none';document.getElementById('authReg').style.display=w==='reg'?'block':'none';}
</script>
</body>
</html>
