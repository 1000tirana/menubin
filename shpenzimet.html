<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Shpenzimet • Normal Holding (Cloud)</title>
  <meta name="theme-color" content="#6a5ae0">
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#1f2340; --muted:#7c82a1;
      --primary:#6a5ae0; --primary2:#7f6ff0; --danger:#ff5959;
      --shadow:0 10px 30px rgba(0,0,0,.08)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .wrap{display:flex;flex-direction:column;min-height:100vh;padding-bottom:78px}
    /* Header */
    header{
      background:linear-gradient(135deg,var(--primary),var(--primary2));
      color:#fff;border-bottom-left-radius:28px;border-bottom-right-radius:28px;
      padding:20px 18px 16px; box-shadow:0 10px 26px rgba(106,90,224,.28)
    }
    header .top{display:flex;justify-content:space-between;align-items:center}
    header .title{font-size:24px;font-weight:900;display:flex;gap:10px;margin-top:8px}
    header .big{font-size:38px;font-weight:900;margin-top:10px}
    header .muted{opacity:.9}
    /* Stats */
    .stats{display:flex;gap:12px;padding:12px 14px;transform:translateY(-18px)}
    .card{flex:1;background:var(--card);border-radius:16px;padding:12px;box-shadow:var(--shadow)}
    .muted{color:var(--muted)}
    /* Main */
    main{padding:0 14px 24px}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .item{display:flex;gap:12px;align-items:center;background:#fff;border-radius:14px;box-shadow:var(--shadow);padding:12px}
    .ic{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:var(--primary);color:#fff}
    .meta{flex:1}.meta .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.meta .s{font-size:12px;color:var(--muted)}
    .amt{font-weight:800}
    .del{border:none;background:transparent;color:var(--danger);font-size:20px;cursor:pointer}
    .row{display:flex;gap:10px}
    label{font-size:13px;color:var(--muted)}
    input,select{width:100%;padding:12px;border:1px solid #e6e7ee;border-radius:12px;font-size:16px;background:#fff;-webkit-appearance:none}
    .actions{display:flex;gap:10px;margin-top:10px}
    .btnP{flex:1;background:var(--primary);color:#fff;border:none;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    .btnS{flex:1;background:#f0f1f8;color:#1f2340;border:none;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    h3.sec{margin:0 0 8px}
    /* Bottom nav: 5-col grid + centered FAB */
    nav.nav{
      position:fixed;left:0;right:0;bottom:0;height:70px;background:#fff;
      display:grid;grid-template-columns:1fr 1fr auto 1fr 1fr;align-items:center;
      box-shadow:0 -8px 28px rgba(0,0,0,.06);border-top-left-radius:16px;border-top-right-radius:16px;padding:0 10px
    }
    .btn{justify-self:center;display:flex;flex-direction:column;align-items:center;gap:4px;font-size:12px;color:var(--muted);text-decoration:none}
    .btn.active{color:var(--primary);font-weight:800}
    .fab{justify-self:center;transform:translateY(-20px);width:60px;height:60px;background:var(--primary);border-radius:999px;color:#fff;font-size:28px;display:grid;place-items:center;border:none;box-shadow:0 12px 28px rgba(106,90,224,.45);cursor:pointer}
    .tab{display:none}.tab.active{display:block}
    /* Modal bottom sheets */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;place-items:end;padding:14px}
    .modal.on{display:grid}
    .sheet{background:#fff;border-radius:22px;padding:14px 14px 18px;width:100%;box-shadow:0 -10px 26px rgba(0,0,0,.14)}
    /* Auth gate */
    .gate{position:fixed;inset:0;display:grid;place-items:center;background:var(--bg);padding:18px}
    .panel{background:#fff;width:min(520px,92vw);border-radius:20px;padding:18px;box-shadow:var(--shadow)}
    .tabs{display:flex;gap:6px;margin-bottom:10px}
    .tabs button{flex:1;border:none;padding:10px;border-radius:10px;background:#f1f2fa;cursor:pointer}
    .tabs button.active{background:var(--primary);color:#fff;font-weight:700}
    @media(min-width:720px){.wrap{max-width:520px;margin:0 auto}}
  </style>
</head>
<body>
<!-- AUTH GATE -->
<div id="gate" class="gate">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900;font-size:20px">Normal Holding</div>
      <div class="muted">Shpenzimet • Cloud</div>
    </div>
    <div class="tabs">
      <button id="tabLoginBtn" class="active" onclick="swapAuth('login')">Hyrje</button>
      <button id="tabRegBtn" onclick="swapAuth('reg')">Regjistrohu</button>
    </div>
    <div id="authLogin">
      <label>Email</label>
      <input id="loginEmail" placeholder="darti@example.com" autocomplete="username">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>Fjalëkalimi</label><input id="loginPass" type="password" autocomplete="current-password" placeholder="••••••••"></div>
      </div>
      <div class="actions"><button class="btnP" onclick="login()">Hyr</button></div>
      <div id="authMsg" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="authReg" style="display:none">
      <label>Email</label>
      <input id="regEmail" placeholder="darti@example.com" autocomplete="username">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>Fjalëkalimi</label><input id="regPass" type="password" autocomplete="new-password" placeholder="min. 6"></div>
      </div>
      <div class="actions"><button class="btnS" onclick="swapAuth('login')">Kthehu</button><button class="btnP" onclick="registerUser()">Krijo llogari</button></div>
      <div id="regMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="wrap" id="app" hidden>
  <header>
    <div class="top">
      <div style="font-weight:800">Normal Holding</div>
      <div class="muted" id="who">@user</div>
    </div>
    <div class="title"><span id="hdrIcon">💰</span><span id="hdrText">Shpenzimet</span></div>
    <div class="big"><span id="hdrTotal">0</span> L</div>
    <div class="muted" id="hdrSub">Këtë muaj</div>
  </header>

  <div class="stats">
    <div class="card"><div class="muted" id="s1name">📊 Totale</div><div style="font-weight:800;font-size:20px"><span id="stat1">0</span> L</div></div>
    <div class="card"><div class="muted" id="s2name">📅 Sot</div><div style="font-weight:800;font-size:20px"><span id="stat2">0</span> L</div></div>
    <div class="card"><div class="muted" id="s3name">🗓️ Muaj</div><div style="font-weight:800;font-size:20px"><span id="stat3">0</span> L</div></div>
  </div>

  <main>
    <!-- Home -->
    <section id="tab-home" class="tab active">
      <h3 class="sec">🕒 Të fundit</h3>
      <div id="recentList" class="list"></div>
      <div id="emptyHome" class="muted" style="text-align:center;margin-top:16px">Asnjë shpenzim deri tani.</div>
    </section>

    <!-- All list -->
    <section id="tab-list" class="tab">
      <h3 class="sec">📚 Lista</h3>
      <div class="row" style="margin:8px 0 10px">
        <input id="q" placeholder="Kërko..." oninput="renderAll()">
        <select id="fCat" onchange="renderAll()"><option value="">Të gjitha</option></select>
      </div>
      <div id="allList" class="list"></div>
    </section>

    <!-- Debts -->
    <section id="tab-debts" class="tab">
      <h3 class="sec">💳 Borxhet</h3>
      <div class="row" style="margin:8px 0 10px">
        <input id="dq" placeholder="Kërko borxhe..." oninput="renderDebts()">
        <select id="dKind" onchange="renderDebts()">
          <option value="">Gjitha</option>
          <option value="lend">Dhash hua (verdëm)</option>
          <option value="borrow">Mora hua (aldım)</option>
        </select>
        <select id="dStatus" onchange="renderDebts()">
          <option value="">Gjitha</option><option value="open">Detyrim</option><option value="paid">Pagova</option>
        </select>
      </div>
      <div id="debtList" class="list"></div>
      <div id="emptyDebts" class="muted" style="text-align:center;margin-top:16px">Asnjë borxh deri tani.</div>
    </section>

    <!-- Settings -->
    <section id="tab-settings" class="tab">
      <h3 class="sec">⚙️ Cilësime</h3>
      <div class="item">
        <div class="ic">👤</div>
        <div class="meta"><div class="t">Përdoruesi</div><div class="s muted" id="userInfo">—</div></div>
        <button class="del" style="color:#555" onclick="logout()">🚪</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">📧 Ndrysho email</h4>
        <div class="row"><input id="newEmail" placeholder="email i ri p.sh. user@domain.com"></div>
        <div class="actions"><button class="btnP" onclick="changeEmail()">Ruaj email</button></div>
        <div id="emailMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">🔐 Ndrysho fjalëkalimin</h4>
        <div class="row">
          <input id="newPass" type="password" placeholder="Fjalëkalimi i ri (min. 6)">
          <input id="newPass2" type="password" placeholder="Përsërit fjalëkalimin">
        </div>
        <div class="actions"><button class="btnP" onclick="changePassword()">Ruaj fjalëkalimin</button></div>
        <div id="passMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>
    </section>
  </main>
</div>

<!-- Bottom nav -->
<nav class="nav" id="navbar" hidden>
  <a class="btn active" data-tab="home" onclick="switchTab('home')">🏠<span>Kreu</span></a>
  <a class="btn" data-tab="list" onclick="switchTab('list')">📋<span>Lista</span></a>
  <button class="fab" id="openAdd" aria-label="Shto">＋</button>
  <a class="btn" data-tab="debts" onclick="switchTab('debts')">💳<span>Borxhe</span></a>
  <a class="btn" data-tab="settings" onclick="switchTab('settings')">⚙️<span>Cilësime</span></a>
</nav>

<!-- Expense modal -->
<div class="modal" id="modalExp">
  <div class="sheet">
    <h3 style="margin:4px 0 10px">➕ Shto shpenzim</h3>
    <div class="row">
      <div style="flex:2"><label>Emri</label><input id="mName" placeholder="p.sh. Karburant"></div>
      <div style="flex:1"><label>Shuma (L)</label><input id="mAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div style="flex:1"><label>Kategoria</label><select id="mCat"></select></div>
      <div style="flex:1"><label>Data</label><input id="mDate" type="date"></div>
    </div>
    <div class="actions"><button class="btnS" onclick="closeModal('Exp')">Mbyll</button><button class="btnP" onclick="saveExpense()">Ruaj</button></div>
  </div>
</div>

<!-- Debt modal -->
<div class="modal" id="modalDebt">
  <div class="sheet">
    <h3 style="margin:4px 0 10px">➕ Shto borxh</h3>
    <div class="row">
      <div style="flex:2"><label>Emri</label><input id="dName" placeholder="p.sh. Telefon i ri"></div>
      <div style="flex:1"><label>Shuma (L)</label><input id="dAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div style="flex:1"><label>Lloj (Tip)</label>
        <select id="dType">
          <option value="lend">Dhash hua (borç verdim)</option>
          <option value="borrow">Mora hua (borç aldım)</option>
        </select>
      </div>
      <div style="flex:1"><label>Status</label>
        <select id="dStat">
          <option value="open">Detyrim (ödenecek)</option>
          <option value="paid">Pagova (ödendi)</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div style="flex:1"><label>Afati (vade)</label><input id="dDate" type="date"></div>
    </div>
    <div class="actions"><button class="btnS" onclick="closeModal('Debt')">Mbyll</button><button class="btnP" onclick="saveDebt()">Ruaj</button></div>
  </div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ====== Senden alınan hosting bilgileri ======
const SUPABASE_URL = 'https://nvpjqvggaiipwziolend.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cGpxdmdnYWlpcHd6aW9sZW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4OTExNzcsImV4cCI6MjA3NDQ2NzE3N30.PnJh09kx-kK8iChgQl2M1eTw5P2qRZUEO31wVY7_iP4';
// =============================================
/* SQL (bir kez):
create extension if not exists pgcrypto;
create table if not exists public.expenses (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  name text not null, amount numeric not null, category text not null,
  d date not null, created_at timestamptz default now()
);
alter table public.expenses enable row level security;
create index if not exists expenses_user_d on public.expenses(user_id, d);

create table if not exists public.debts (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  name text not null, amount numeric not null,
  status text not null default 'open', due date, created_at timestamptz default now(), 
  kind text not null default 'lend'  -- 'lend' | 'borrow'
);
alter table public.debts enable row level security;
create index if not exists debts_user_due on public.debts(user_id, due);
create index if not exists debts_user_kind on public.debts(user_id, kind);

-- RLS (her iki tablo için):
-- SELECT  using (auth.uid() = user_id)
-- INSERT  with check (auth.uid() = user_id)
-- UPDATE  using (auth.uid() = user_id) with check (auth.uid() = user_id)
-- DELETE  using (auth.uid() = user_id)
*/
const DEFAULT_CATS=['Ushqime','Transport','Shtëpia','Argëtim','Fatura','Të tjera'];
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let sessionUser=null, items=[], debts=[], activeTab='home';

document.addEventListener('DOMContentLoaded', async () => {
  // categories
  const mCat=document.getElementById('mCat'); const fCat=document.getElementById('fCat');
  DEFAULT_CATS.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; mCat.appendChild(o.cloneNode(true)); fCat.appendChild(o); });
  document.getElementById('mDate').value = new Date().toISOString().slice(0,10);
  document.getElementById('dDate').value = new Date().toISOString().slice(0,10);

  document.getElementById('openAdd').addEventListener('click', () => {
    if(activeTab==='debts') openModal('Debt'); else openModal('Exp');
  });

  // restore session
  const { data: { session } } = await supabase.auth.getSession();
  if(session?.user){ sessionUser=session.user; showApp(); await Promise.all([loadExpenses(), loadAllDebts()]); } else showGate();

  supabase.auth.onAuthStateChange(async (_event, session) => {
    if(session?.user){ sessionUser=session.user; showApp(); await Promise.all([loadExpenses(), loadAllDebts()]); }
    else { sessionUser=null; showGate(); }
  });
});

function shortEmail(e){ return e ? e.split('@')[0] : '@user'; }
function showGate(){ document.getElementById('gate').style.display='grid'; document.getElementById('app').hidden=true; document.getElementById('navbar').hidden=true; }
function showApp(){
  document.getElementById('gate').style.display='none'; document.getElementById('app').hidden=false; document.getElementById('navbar').hidden=false;
  document.getElementById('who').textContent = shortEmail(sessionUser?.email);
  document.getElementById('userInfo').textContent = shortEmail(sessionUser?.email);
  updateHeader(); render(); renderDebts();
}
function swapAuth(which){
  document.getElementById('tabLoginBtn').classList.toggle('active', which==='login');
  document.getElementById('tabRegBtn').classList.toggle('active', which==='reg');
  document.getElementById('authLogin').style.display = (which==='login')?'block':'none';
  document.getElementById('authReg').style.display = (which==='reg')?'block':'none';
}
async function registerUser(){
  const email=document.getElementById('regEmail').value.trim();
  const pass=document.getElementById('regPass').value;
  const box=document.getElementById('regMsg'); box.textContent='';
  if(!email || pass.length<6){ box.textContent='Email dhe fjalëkalim ≥ 6.'; return; }
  const { error } = await supabase.auth.signUp({ email, password: pass });
  box.textContent = error? ('Gabim: '+error.message) : 'U krijua. Email onayı gerekiyorsa kutunu kontrol et.';
}
async function login(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value;
  const box=document.getElementById('authMsg'); box.textContent='';
  const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
  if(error) box.textContent='Gabim: '+error.message;
}
async function logout(){ await supabase.auth.signOut(); }

function switchTab(t){
  activeTab=t;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
  document.querySelectorAll('.btn').forEach(x=>x.classList.remove('active'));
  document.querySelector(`.btn[data-tab="${t}"]`)?.classList.add('active');
  updateHeader();
  if(t==='list') renderAll();
  if(t==='debts') renderDebts();
}
function updateHeader(){
  const icon=document.getElementById('hdrIcon'), text=document.getElementById('hdrText'), sub=document.getElementById('hdrSub');
  const s1=document.getElementById('s1name'), s2=document.getElementById('s2name'), s3=document.getElementById('s3name');

  if(activeTab==='debts'){
    icon.textContent='💳'; text.textContent='Borxhet'; sub.textContent='Detyrimet tuaja';
    const total=sum(debts.map(n=>Number(n.amount||0)));
    const open=sum(debts.filter(x=>x.status!=='paid').map(n=>Number(n.amount||0)));
    const paid=sum(debts.filter(x=>x.status==='paid').map(n=>Number(n.amount||0)));
    setText('hdrTotal',fmt(open));
    s1.textContent='Gjithsej'; s2.textContent='Detyrim'; s3.textContent='Pagova';
    setText('stat1',fmt(total)); setText('stat2',fmt(open)); setText('stat3',fmt(paid));
  }else{
    icon.textContent='💰'; text.textContent='Shpenzimet'; sub.textContent='Këtë muaj';
    const total=sum(items.map(x=>Number(x.amount||0)));
    const today=sum(items.filter(isToday).map(x=>Number(x.amount||0)));
    const month=sum(items.filter(isThisMonth).map(x=>Number(x.amount||0)));
    setText('hdrTotal',fmt(month));
    s1.textContent='Totale'; s2.textContent='Sot'; s3.textContent='Muaj';
    setText('stat1',fmt(total)); setText('stat2',fmt(today)); setText('stat3',fmt(month));
  }
}
function openModal(kind){ document.getElementById('modal'+kind).classList.add('on'); }
function closeModal(kind){ document.getElementById('modal'+kind).classList.remove('on'); }

/* ===== Account ops ===== */
async function changeEmail(){
  const el=document.getElementById('newEmail'); const msg=document.getElementById('emailMsg'); msg.textContent='';
  const newEmail=(el.value||'').trim(); if(!newEmail||!newEmail.includes('@')){ msg.textContent='Shkruaj një email të vlefshëm.'; return; }
  const { error } = await supabase.auth.updateUser({ email:newEmail });
  if(error){ msg.textContent='Gabim: '+error.message; return; }
  msg.textContent='Konfirmim linku u dërgua te email-i i ri. Onaylayınca güncellenir.'; el.value='';
}
async function changePassword(){
  const p1=document.getElementById('newPass').value, p2=document.getElementById('newPass2').value, msg=document.getElementById('passMsg'); msg.textContent='';
  if(!p1||p1.length<6){ msg.textContent='Fjalëkalimi ≥ 6.'; return; }
  if(p1!==p2){ msg.textContent='Fjalëkalimet nuk përputhen.'; return; }
  const { error } = await supabase.auth.updateUser({ password:p1 });
  if(error){ msg.textContent='Gabim: '+error.message; return; }
  msg.textContent='Fjalëkalimi u përditësua.'; document.getElementById('newPass').value=''; document.getElementById('newPass2').value='';
}

/* ===== Expenses ===== */
async function saveExpense(){
  const name=document.getElementById('mName').value.trim();
  const amt=parseFloat(document.getElementById('mAmt').value);
  const cat=document.getElementById('mCat').value;
  const date=document.getElementById('mDate').value;
  if(!name||!amt||!date||isNaN(amt)){ alert('Plotësoni emrin, shumën dhe datën.'); return; }
  const { data, error } = await supabase.from('expenses').insert({ user_id:sessionUser.id, name, amount:amt, category:cat, d:date }).select().single();
  if(error){ alert('Gabim: '+error.message); return; }
  items.unshift(data);
  document.getElementById('mName').value=''; document.getElementById('mAmt').value='';
  closeModal('Exp'); render(); renderAll(); updateHeader();
}
async function delExpense(id){
  if(!confirm('Fshini këtë shpenzim?')) return;
  const { error } = await supabase.from('expenses').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){ alert('Gabim: '+error.message); return; }
  items=items.filter(x=>x.id!==id); render(); renderAll(); updateHeader();
}
async function loadExpenses(){
  const { data, error } = await supabase.from('expenses').select('*').eq('user_id',sessionUser.id).order('d',{ascending:false}).limit(2000);
  if(error){ alert('Gabim ngarkimi: '+error.message); return; }
  items=data||[]; render(); renderAll(); updateHeader();
}
function render(){
  const recent=[...items].sort((a,b)=>b.d.localeCompare(a.d)).slice(0,8);
  const list=document.getElementById('recentList'); list.innerHTML='';
  if(recent.length===0){ document.getElementById('emptyHome').style.display='block'; }
  else{ document.getElementById('emptyHome').style.display='none'; recent.forEach(x=>list.appendChild(row(x))); }
}
function renderAll(){
  const q=(document.getElementById('q').value||'').trim().toLowerCase();
  const cat=document.getElementById('fCat').value;
  let arr=[...items].sort((a,b)=>b.d.localeCompare(a.d));
  if(q) arr=arr.filter(x=>x.name.toLowerCase().includes(q)||(x.category||'').toLowerCase().includes(q));
  if(cat) arr=arr.filter(x=>x.category===cat);
  const box=document.getElementById('allList'); box.innerHTML=''; arr.forEach(x=>box.appendChild(row(x)));
}
function row(x){
  const el=document.createElement('div'); el.className='item';
  const ic=document.createElement('div'); ic.className='ic'; ic.textContent=pickEmoji(x.category);
  const meta=document.createElement('div'); meta.className='meta';
  const t=document.createElement('div'); t.className='t'; t.textContent=x.name;
  const s=document.createElement('div'); s.className='s'; s.textContent=[x.category,pretty(x.d)].filter(Boolean).join(' • ');
  meta.appendChild(t); meta.appendChild(s);
  const amt=document.createElement('div'); amt.className='amt'; amt.textContent=fmt(x.amount)+' L';
  const del=document.createElement('button'); del.className='del'; del.textContent='🗑️'; del.onclick=()=>delExpense(x.id);
  el.append(ic,meta,amt,del); return el;
}
function pickEmoji(cat){ const m={'Ushqime':'🍔','Transport':'⛽','Shtëpia':'🏠','Argëtim':'🎟️','Fatura':'💡','Të tjera':'🧾'}; return m[cat]||'💸'; }

/* ===== Debts ===== */
async function saveDebt(){
  const name=document.getElementById('dName').value.trim();
  const amt=parseFloat(document.getElementById('dAmt').value);
  const kind=document.getElementById('dType').value;     // 'lend' | 'borrow'
  const status=document.getElementById('dStat').value;   // 'open' | 'paid'
  const due=document.getElementById('dDate').value || null;
  if(!name||!amt||isNaN(amt)){ alert('Plotëso emrin dhe shumën.'); return; }
  const payload={ user_id:sessionUser.id, name, amount:amt, status, due, kind };
  const { data, error } = await supabase.from('debts').insert(payload).select().single();
  if(error){ alert('Gabim: '+error.message); return; }
  debts.unshift(data);
  document.getElementById('dName').value=''; document.getElementById('dAmt').value='';
  closeModal('Debt'); renderDebts(); updateHeader();
}
async function delDebt(id){
  if(!confirm('Fshini këtë borxh?')) return;
  const { error } = await supabase.from('debts').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){ alert('Gabim: '+error.message); return; }
  debts=debts.filter(x=>x.id!==id); renderDebts(); updateHeader();
}
async function loadAllDebts(){
  const { data, error } = await supabase.from('debts').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:false}).limit(2000);
  if(error){ debts=[]; return; }  // tablo yoksa sessiz geç
  debts=data||[]; renderDebts(); updateHeader();
}
function renderDebts(){
  const q=(document.getElementById('dq').value||'').trim().toLowerCase();
  const st=document.getElementById('dStatus').value;
  const kind=document.getElementById('dKind').value;
  let arr=[...debts];
  if(q) arr=arr.filter(x=>x.name.toLowerCase().includes(q));
  if(st) arr=arr.filter(x=>x.status===st);
  if(kind) arr=arr.filter(x=>x.kind===kind);

  const box=document.getElementById('debtList'); box.innerHTML='';
  if(arr.length===0){ document.getElementById('emptyDebts').style.display='block'; }
  else{
    document.getElementById('emptyDebts').style.display='none';
    arr.forEach(x=>{
      const el=document.createElement('div'); el.className='item';
      const ic=document.createElement('div'); ic.className='ic'; ic.textContent=(x.status==='paid')?'✅':'💳';
      const meta=document.createElement('div'); meta.className='meta';
      const t=document.createElement('div'); t.className='t'; t.textContent=x.name;
      const bits=[];
      bits.push(x.kind==='lend' ? 'Dhash hua (verdëm)' : 'Mora hua (aldım)');
      bits.push(x.status==='paid' ? 'Pagova' : 'Detyrim');
      if(x.due) bits.push('Afati: '+pretty(x.due));
      const s=document.createElement('div'); s.className='s'; s.textContent=bits.join(' • ');
      meta.appendChild(t); meta.appendChild(s);
      const amt=document.createElement('div'); amt.className='amt'; amt.textContent=fmt(x.amount)+' L';
      const del=document.createElement('button'); del.className='del'; del.textContent='🗑️'; del.onclick=()=>delDebt(x.id);
      el.append(ic,meta,amt,del); box.appendChild(el);
    });
  }
}

/* Helpers */
function setText(id,v){ const e=document.getElementById(id); if(e) e.textContent=v; }
function sum(a){ return a.reduce((s,n)=>s+Number(n||0),0); }
function fmt(n){ return (Math.round(n*100)/100).toLocaleString('sq-AL'); }
function isToday(x){ const d=new Date(x.d); const t=new Date(); return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()&&d.getDate()==t.getDate(); }
function isThisMonth(x){ const d=new Date(x.d); const t=new Date(); return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth(); }
function pretty(iso){ const d=new Date(iso+'T00:00:00'); return d.toLocaleDateString('sq-AL',{day:'2-digit',month:'short',year:'numeric'}); }
</script>
</body>
</html>
