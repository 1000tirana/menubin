<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Normal Holding ‚Ä¢ Shpenzimet</title>
<meta name="theme-color" content="#0d1117">
<style>
:root{
  --bg:#0d1117; --card:#161b22; --border:#30363d;
  --text:#c9d1d9; --muted:#8b949e;
  --primary:#2ea043; --primary2:#238636;
  --blue:#1f6feb; --danger:#f85149;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bottom:env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box}
html,body{height:100%;background:var(--bg);overscroll-behavior:none;overflow-x:hidden}
body{margin:0;color:var(--text);font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;touch-action:manipulation}
.wrap{display:flex;flex-direction:column;min-height:100vh;padding-bottom:calc(110px + var(--safe-bottom))}
header{
  background:linear-gradient(135deg,var(--primary2) 0%, var(--primary) 100%);
  color:#fff;border-bottom-left-radius:22px;border-bottom-right-radius:22px;
  padding:calc(10px + var(--safe-top)) 16px 12px; box-shadow:0 10px 28px rgba(35,134,54,.35)
}
header .top{display:flex;justify-content:space-between;align-items:center}
header .title{font-size:20px;font-weight:900;display:flex;gap:8px;margin-top:6px}
header .big{font-size:32px;font-weight:900;margin-top:8px}
header .muted{color:#e6edf3;opacity:.8}
.stats{display:flex;gap:10px;padding:10px 12px;transform:translateY(-12px)}
.card{flex:1;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
main{padding:0 12px 20px}
h3.sec{margin:0 0 8px}
.list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.item{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px}

/* Liste ikonlarƒ± (ye≈üil cam) */
.ic{width:52px;height:52px;border-radius:50%;display:grid;place-items:center;color:#0d1117;
  background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
  box-shadow:inset 0 1px 4px rgba(0,0,0,.6), 0 6px 14px rgba(0,0,0,.4);
  border:1px solid rgba(255,255,255,.06); font-size:24px}
.meta{flex:1}
.meta .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#e6edf3}
.meta .s{font-size:12px;color:var(--muted)}
.amt{font-weight:900;color:#e6edf3}
.del{border:none;background:transparent;color:var(--danger);font-size:20px;cursor:pointer}

.row{display:flex;gap:10px;align-items:stretch}
label{font-size:13px;color:var(--muted)}
input,select,button.inputlike{
  width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;
  font-size:16px;background:var(--card);color:var(--text);-webkit-appearance:none;
  min-height:48px;display:flex;align-items:center;justify-content:flex-start
}
.inputlike span{display:inline-block;line-height:1}
.actions{display:flex;gap:10px;margin-top:10px}
.btnP,.btnS,.btnMini{font-size:16px;touch-action:manipulation;-webkit-tap-highlight-color:transparent;user-select:none}
.btnP{flex:1;background:linear-gradient(180deg,var(--primary) 0%, var(--primary2) 100%);color:#fff;border:1px solid #2ea043;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
.btnS{flex:1;background:#21262d;color:#e6edf3;border:1px solid var(--border);padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
.btnMini{background:#21262d;border:1px solid var(--border);padding:8px 10px;border-radius:10px;font-weight:800;color:#e6edf3;cursor:pointer}
.chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#1f6feb;color:#fff}

/* Alt NAV */
nav.nav{
  --fab-gap:110px;
  position:fixed;left:0;right:0;bottom:0;transform:translateZ(0);
  height:calc(76px + var(--safe-bottom));padding:0 12px var(--safe-bottom);
  background:var(--card);border-top:1px solid var(--border);box-shadow:0 -10px 30px rgba(0,0,0,.35);
  border-top-left-radius:16px;border-top-right-radius:16px;z-index:2000;
  display:grid;grid-template-columns:1fr 1fr var(--fab-gap) 1fr 1fr;align-items:center;
  backface-visibility:hidden;will-change:transform
}
.btn{justify-self:center;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);text-decoration:none}
.btn:nth-of-type(1){grid-column:1}.btn:nth-of-type(2){grid-column:2}.btn:nth-of-type(3){grid-column:4}.btn:nth-of-type(4){grid-column:5}
.btn .ico{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;color:#0d1117;
  background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
  box-shadow:inset 0 1px 3px rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.06);font-size:24px}
.btn.active{color:#79c0ff}
.btn.active .ico{background:radial-gradient(circle at 30% 30%, #cfe7ff 0%, #9dd2ff 45%, #1f6feb 100%)}

/* FAB */
.nav .fab{
  position:absolute;left:50%;transform:translateX(-50%);
  top:-22px;width:56px;height:56px;border-radius:999px;
  background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
  border:1px solid rgba(255,255,255,.06);color:#0d1117;font-size:28px;
  display:grid;place-items:center;box-shadow:0 14px 26px rgba(0,0,0,.5), inset 0 1px 4px rgba(0,0,0,.6);
  cursor:pointer;z-index:2100;pointer-events:auto
}
@supports (-webkit-touch-callout: none){.nav .fab{top:-24px}}
.tab{display:none}.tab.active{display:block}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:end;padding:14px;z-index:3000}
.modal.on{display:grid}
.sheet{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:18px;padding:14px 14px 18px;width:100%;box-shadow:0 -12px 30px rgba(0,0,0,.5)}

/* Auth gate */
.gate{position:fixed;inset:0;display:none;place-items:center;background:var(--bg);padding:18px;z-index:4000}
.panel{background:var(--card);border:1px solid var(--border);width:min(520px,92vw);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
.tabs{display:flex;gap:6px;margin-bottom:10px}
.tabs button{flex:1;border:1px solid var(--border);padding:10px;border-radius:10px;background:#21262d;color:#e6edf3;cursor:pointer}
.tabs button.active{background:linear-gradient(180deg,var(--primary) 0%, var(--primary2) 100%);border-color:#2ea043;color:#fff;font-weight:800}

/* Emoji picker + sade √∂nizleme */
.picker-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;max-height:45vh;overflow:auto;margin-top:8px}
.picker-grid button{border:1px solid var(--border);background:#21262d;border-radius:10px;width:44px;height:44px;font-size:22px;cursor:pointer}
.emoji-preview{font-size:24px;line-height:1;display:inline-block;margin-right:6px}

@media(min-width:720px){.wrap{max-width:520px;margin:0 auto}}
</style>
</head>
<body>

<!-- ===== HYRJE / REGJISTRIM ===== -->
<div id="gate" class="gate">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900;font-size:18px">Normal Holding</div>
      <div class="muted">Shpenzimet ‚Ä¢ Cloud</div>
    </div>
    <div class="tabs">
      <button id="tabLoginBtn" class="active" onclick="swapAuth('login')">Hyrje</button>
      <button id="tabRegBtn" onclick="swapAuth('reg')">Regjistrohu</button>
    </div>
    <div id="authLogin">
      <label>Email</label>
      <input id="loginEmail" placeholder="emri@gmail.com" autocomplete="username">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>Fjal√´kalimi</label><input id="loginPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      </div>
      <div class="actions"><button class="btnP" onclick="login()">Hyr</button></div>
      <div id="authMsg" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="authReg" style="display:none">
      <label>Email</label>
      <input id="regEmail" placeholder="emri@gmail.com" autocomplete="username">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>Fjal√´kalimi</label><input id="regPass" type="password" autocomplete="new-password" placeholder="min. 6"></div>
      </div>
      <div class="actions"><button class="btnS" onclick="swapAuth('login')">Kthehu</button><button class="btnP" onclick="registerUser()">Krijo llogari</button></div>
      <div id="regMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- ===== APP ===== -->
<div class="wrap" id="app" style="display:none">
  <header>
    <div class="top">
      <div style="font-weight:800">Normal Holding</div>
      <div class="muted" id="who">@p√´rdoruesi</div>
    </div>
    <div class="title"><span id="hdrIcon">üí∞</span><span id="hdrText">Bilanci</span></div>
    <div class="big"><span id="hdrTotal">0</span> <span id="hdrSym">L</span></div>
    <div class="muted" id="hdrSub">Gjendja ‚àí Shpenzimet (totale)</div>
  </header>

  <div class="stats">
    <div class="card"><div class="muted" id="s1name">üìä Totale</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat1">0</span> <span id="sym1">L</span></div></div>
    <div class="card"><div class="muted" id="s2name">üìÖ Sot</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat2">0</span> <span id="sym2">L</span></div></div>
    <div class="card"><div class="muted" id="s3name">üóìÔ∏è Muaj</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat3">0</span> <span id="sym3">L</span></div></div>
  </div>

  <main>
    <section id="tab-home" class="tab active">
      <h3 class="sec">üïí T√´ fundit</h3>
      <div id="recentList" class="list"></div>
      <div id="emptyHome" class="muted" style="text-align:center;margin-top:16px">Asnj√´ shpenzim deri tani.</div>
    </section>

    <section id="tab-list" class="tab">
      <h3 class="sec">üìö Lista</h3>
      <div class="row" style="margin:8px 0 10px">
        <input id="q" placeholder="K√´rko..." oninput="drawAll()">
        <select id="fCat" onchange="drawAll()"><option value="">T√´ gjitha</option></select>
      </div>
      <div id="allList" class="list"></div>
    </section>

    <section id="tab-debts" class="tab">
      <h3 class="sec">üí≥ Borxhet</h3>
      <div class="row" style="margin:8px 0 10px"><input id="dq" placeholder="K√´rko borxhe..." oninput="drawDebts()"></div>
      <div class="seg three" id="dSegFilter" style="margin-bottom:8px">
        <button type="button" class="active" data-val="">T√´ gjitha</button>
        <button type="button" data-val="borrow">Mora hua</button>
        <button type="button" data-val="lend">Dhash hua</button>
      </div>
      <div id="debtList" class="list"></div>
      <div id="emptyDebts" class="muted" style="text-align:center;margin-top:16px">Asnj√´ borxh deri tani.</div>
    </section>

    <section id="tab-settings" class="tab">
      <h3 class="sec">‚öôÔ∏è Cil√´sime</h3>

      <div class="item">
        <div class="ic">üë§</div>
        <div class="meta"><div class="t">P√´rdoruesi</div><div class="s muted" id="userInfo">‚Äî</div></div>
        <button class="del" style="color:#e6edf3" onclick="logout()">üö™</button>
      </div>

      <!-- Para birimi & format -->
      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">üí± Monedha & format</h4>
        <div class="row">
          <div style="flex:1">
            <label>Monedha aktuale (p√´r hyrjet e reja)</label>
            <select id="prefCurr">
              <option value="ALL">ALL ‚Äî Albania Lek</option>
              <option value="EUR">EUR ‚Äî Euro</option>
              <option value="TRY">TRY ‚Äî Turkish Lira</option>
              <option value="USD">USD ‚Äî US Dollar</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Formati i numrave</label>
            <select id="prefFmt">
              <option value="eu">23.456,78</option>
              <option value="us">23,456.78</option>
            </select>
          </div>
        </div>
        <div class="actions"><button class="btnP" onclick="savePrefs()">Ruaj preferencat</button></div>
        <div id="prefMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <!-- Bakiye (se√ßili para birimi i√ßin) -->
      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">üíº Gjendja e monedh√´s <span id="balCurrLabel">ALL</span></h4>
        <div class="row"><input id="balInput" type="number" step="0.01" inputmode="decimal" placeholder="p.sh. 50000"></div>
        <div class="actions"><button class="btnP" onclick="saveBalance()">Ruaj gjendjen</button></div>
        <div class="muted" id="balMsg" style="margin-top:6px;font-size:12px"></div>
      </div>

      <!-- Kategoriler -->
      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">üè∑Ô∏è Kategoriat</h4>
        <div id="catList" class="list" style="margin-top:8px"></div>
        <div style="border-top:1px solid var(--border);margin:12px 0"></div>
        <div class="row">
          <div style="width:160px">
            <label>Emoji</label>
            <button class="inputlike" id="emojiBtn" onclick="openEmojiPicker()">
              <span id="emojiPreview" class="emoji-preview">üçî</span>
              <span>Zgjidh emoji</span>
            </button>
            <input id="newCatEmoji" value="üçî" hidden>
          </div>
          <div style="flex:1">
            <label>Emri i kategoris√´</label>
            <input id="newCatName" placeholder="p.sh. Ushqime">
          </div>
        </div>
        <div class="actions"><button class="btnP" onclick="addCategory()">Shto kategori</button></div>
        <div id="catMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">üìß Ndrysho email</h4>
        <div class="row"><input id="newEmail" placeholder="email i ri p.sh. user@domain.com"></div>
        <div class="actions"><button class="btnP" onclick="changeEmail()">Ruaj email</button></div>
        <div id="emailMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">üîê Ndrysho fjal√´kalimin</h4>
        <div class="row">
          <input id="newPass"  type="password" minlength="6" autocomplete="new-password" placeholder="Fjal√´kalimi i ri (min. 6)">
          <input id="newPass2" type="password" minlength="6" autocomplete="new-password" placeholder="P√´rs√´rit fjal√´kalimin">
        </div>
        <div class="actions"><button class="btnP" onclick="changePassword()">Ruaj fjal√´kalimin</button></div>
        <div id="passMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>
    </section>
  </main>
</div>

<!-- Alt men√º + FAB -->
<nav class="nav" id="navbar" style="display:none">
  <a class="btn active" data-tab="home" onclick="switchTab('home')"><span class="ico">üè†</span><span>Kreu</span></a>
  <a class="btn" data-tab="list" onclick="switchTab('list')"><span class="ico">üìã</span><span>Lista</span></a>
  <a class="btn" data-tab="debts" onclick="switchTab('debts')"><span class="ico">üí≥</span><span>Borxhet</span></a>
  <a class="btn" data-tab="settings" onclick="switchTab('settings')"><span class="ico">‚öôÔ∏è</span><span>Cil√´sime</span></a>
  <button class="fab" id="openAdd" aria-label="Shto">Ôºã</button>
</nav>

<!-- Modal: Shpenzim -->
<div class="modal" id="modalExp"><div class="sheet">
  <h3 style="margin:4px 0 10px">‚ûï Shto shpenzim</h3>
  <div class="row"><div style="flex:2"><label>Emri</label><input id="mName" placeholder="p.sh. Karburant"></div><div style="flex:1"><label>Shuma</label><input id="mAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label>Kategoria</label><select id="mCat"></select></div><div style="flex:1"><label>Data</label><input id="mDate" type="date"></div></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Exp')">Mbyll</button><button class="btnP" onclick="saveExpense()">Ruaj</button></div>
</div></div>

<!-- Modal: Borxh -->
<div class="modal" id="modalDebt"><div class="sheet">
  <h3 style="margin:4px 0 10px">‚ûï Shto borxh</h3>
  <div class="row">
    <div style="flex:1"><label>Pal√´ (Emri)</label><input id="dParty" placeholder="p.sh. Arben / ACME sh.p.k."></div>
    <div style="flex:1"><label>Shuma</label><input id="dAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label>Lloji</label><div id="segType" class="seg two"><button type="button" class="active" data-val="borrow">Mora hua</button><button type="button" data-val="lend">Dhash hua</button></div></div>
    <div style="flex:1"><label>Afati (opsionale)</label><input id="dDate" type="date"></div>
  </div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label>P√´rshkrimi (opsionale)</label><input id="dName" placeholder="p.sh. Telefon i ri"></div></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Debt')">Mbyll</button><button class="btnP" onclick="saveDebt()">Ruaj</button></div>
</div></div>

<!-- Modal: Emoji se√ßici -->
<div class="modal" id="modalEmoji"><div class="sheet">
  <h3 style="margin:4px 0 10px">üôÇ Zgjidh nj√´ emoji</h3>
  <div id="emojiGrid" class="picker-grid"></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Emoji')">Mbyll</button></div>
</div></div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL='https://nvpjqvggaiipwziolend.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cGpxdmdnYWlpcHd6aW9sZW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4OTExNzcsImV4cCI6MjA3NDQ2NzE3N30.PnJh09kx-kK8iChgQl2M1eTw5P2qRZUEO31wVY7_iP4';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/* Currencies */
const CURRENCIES=[
  {code:'ALL', name:'Albania Lek', sym:'L', locale:'sq-AL'},
  {code:'EUR', name:'Euro',        sym:'‚Ç¨', locale:'de-DE'},
  {code:'TRY', name:'Turkish Lira',sym:'‚Ç∫', locale:'tr-TR'},
  {code:'USD', name:'US Dollar',   sym:'$', locale:'en-US'},
];

function currSym(c){return (CURRENCIES.find(x=>x.code===c)||CURRENCIES[0]).sym}
function currLocale(c,fmt){ // fmt: 'eu' | 'us'
  if(fmt==='us') return 'en-US';
  return (CURRENCIES.find(x=>x.code===c)||CURRENCIES[0]).locale;
}

let sessionUser=null, items=[], debts=[], profile={balances:{}, pref_currency:'ALL', numfmt:'eu'}, cats=[], activeTab='home';

document.addEventListener('DOMContentLoaded', async () => {
  // Emoji grid
  'üçî ü•ó üçï üç∞ ‚òï üç∫ üõí üöå ‚õΩ üöï üõ†Ô∏è üßΩ üßí üéÅ üéÆ üé¨ üéüÔ∏è üí° üì± üíª üè† üêæ ‚öΩ üßæ üíä üßØ üß™ üß≥ ‚úàÔ∏è üöó ‚õµ ü™ô üí≥ üíé üéì üìö üñ•Ô∏è üîå üîã üß• üëü üçº üßª üß¥ üê∂ üê±'
  .split(' ').forEach(e=>{const b=document.createElement('button');b.textContent=e;b.onclick=()=>{gid('newCatEmoji').value=e;gid('emojiPreview').textContent=e;closeModal('Emoji')};gid('emojiGrid').appendChild(b)});

  gid('mDate').value=new Date().toISOString().slice(0,10);
  gid('dDate').value=new Date().toISOString().slice(0,10);

  qsa('#segType button').forEach(b=>b.onclick=()=>toggleSeg('segType',b));
  qsa('#dSegFilter button').forEach(b=>b.onclick=()=>{toggleSeg('dSegFilter',b);drawDebts();});

  const fab=gid('openAdd'); const onFab=()=>{activeTab==='debts'?openModal('Debt'):openModal('Exp')};
  ['pointerup','touchend','click'].forEach(ev=>fab.addEventListener(ev,onFab,{passive:true}));

  const {data:{session}}=await supabase.auth.getSession();
  if(session?.user){sessionUser=session.user; showApp(); await Promise.all([ensureProfile(), ensureCategoriesSeed(), loadCategories(), loadExpenses(), loadDebts()]);}
  else showGate();

  supabase.auth.onAuthStateChange(async (_e,session)=>{
    if(session?.user){sessionUser=session.user; showApp(); await Promise.all([ensureProfile(), ensureCategoriesSeed(), loadCategories(), loadExpenses(), loadDebts()]);}
    else{sessionUser=null; showGate();}
  });
});

/* Helpers */
const gid=id=>document.getElementById(id);
const qsa=(sel,root=document)=>Array.from(root.querySelectorAll(sel));
function emailShort(e){return e?e.split('@')[0]:'@p√´rdoruesi'}
function showGate(){gid('gate').style.display='grid';gid('app').style.display='none';gid('navbar').style.display='none'}
function showApp(){gid('gate').style.display='none';gid('app').style.display='block';gid('navbar').style.display='grid';gid('who').textContent=emailShort(sessionUser?.email);gid('userInfo').textContent=emailShort(sessionUser?.email);refreshHeader();drawHome();drawDebts()}
function swapAuth(w){gid('tabLoginBtn').classList.toggle('active',w==='login');gid('tabRegBtn').classList.toggle('active',w==='reg');gid('authLogin').style.display=(w==='login')?'block':'none';gid('authReg').style.display=(w==='reg')?'block':'none'}
async function registerUser(){const email=gid('regEmail').value.trim();const pass=gid('regPass').value;const box=gid('regMsg');box.textContent='';if(!email||pass.length<6){box.textContent='Email dhe fjal√´kalim ‚â• 6.';return;}const {error}=await supabase.auth.signUp({email,password:pass});box.textContent=error?('Gabim: '+error.message):'Llogaria u krijua. Kontrollo email-in.'}
async function login(){const email=gid('loginEmail').value.trim();const pass=gid('loginPass').value;const box=gid('authMsg');box.textContent='';const {error}=await supabase.auth.signInWithPassword({email,password:pass});if(error) box.textContent='Gabim: '+error.message}
async function logout(){await supabase.auth.signOut()}
function switchTab(t){activeTab=t;qsa('.tab').forEach(x=>x.classList.remove('active'));gid('tab-'+t).classList.add('active');qsa('.btn').forEach(x=>x.classList.remove('active'));document.querySelector(`.btn[data-tab="${t}"]`)?.classList.add('active');refreshHeader();if(t==='list')drawAll();if(t==='debts')drawDebts();}
function openModal(w){gid('modal'+w).classList.add('on')}
function closeModal(w){gid('modal'+w).classList.remove('on')}
function toggleSeg(id,btn){const p=gid(id);qsa('button',p).forEach(x=>x.classList.remove('active'));btn.classList.add('active')}
function segValue(id){return document.querySelector('#'+id+' .active')?.dataset.val||''}
function resetSeg(id,val){const p=gid(id);qsa('button',p).forEach(x=>x.classList.toggle('active',x.dataset.val===val))}
function setText(id,v){const e=gid(id);if(e)e.textContent=v}
function sum(a){return a.reduce((s,n)=>s+Number(n||0),0)}
function fmt(n,c){const fmt=(profile.numfmt||'eu');const loc=currLocale(c||profile.pref_currency||'ALL',fmt);return (Math.round(Number(n||0)*100)/100).toLocaleString(loc)}
function isToday(x){const d=new Date(x.d),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()&&d.getDate()==t.getDate()}
function isThisMonth(x){const d=new Date(x.d),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()}
function fmtDate(iso){const d=new Date((iso||'')+'T00:00:00');if(isNaN(d)) return '';return d.toLocaleDateString('sq-AL',{day:'2-digit',month:'short',year:'numeric'})}

/* Profile & prefs */
async function ensureProfile(){
  // try get
  let data=null;
  try{({data}=await supabase.from('profiles').select('*').eq('user_id',sessionUser.id).single());}catch{}
  if(!data){
    ({data}=await supabase.from('profiles').upsert({user_id:sessionUser.id,balances:{ALL:0},pref_currency:'ALL',numfmt:'eu'}).select().single());
  }
  profile=data||{balances:{ALL:0},pref_currency:'ALL',numfmt:'eu'};
  // compat
  if(!profile.balances) profile.balances={ALL:(profile.balance||0)};
  if(!profile.pref_currency) profile.pref_currency='ALL';
  if(!profile.numfmt) profile.numfmt='eu';

  // fill UI
  gid('prefCurr').value=profile.pref_currency;
  gid('prefFmt').value=profile.numfmt;
  gid('balCurrLabel').textContent=profile.pref_currency;
  gid('balInput').value=getBalance(profile.pref_currency);

  refreshHeader();
}
function getBalance(curr){return Number((profile.balances||{})[curr]||0)}
async function savePrefs(){
  profile.pref_currency=gid('prefCurr').value;
  profile.numfmt=gid('prefFmt').value;
  gid('balCurrLabel').textContent=profile.pref_currency;
  gid('prefMsg').textContent='';
  const {error}=await supabase.from('profiles').upsert({
    user_id:sessionUser.id,
    pref_currency:profile.pref_currency,
    numfmt:profile.numfmt,
    balances:profile.balances||{}
  });
  gid('prefMsg').textContent= error?('Gabim: '+error.message) : 'Preferencat u ruajt√´n.';
  // ekran tazele
  gid('balInput').value=getBalance(profile.pref_currency);
  refreshHeader(); drawHome(); drawAll(); drawDebts();
}
async function saveBalance(){
  const curr=profile.pref_currency;
  const v=parseFloat(gid('balInput').value||'0')||0;
  profile.balances=profile.balances||{}; profile.balances[curr]=v;
  const {error}=await supabase.from('profiles').upsert({
    user_id:sessionUser.id,balances:profile.balances,
    pref_currency:profile.pref_currency,numfmt:profile.numfmt
  });
  gid('balMsg').textContent= error?('Gabim: '+error.message) : 'U ruajt.';
  refreshHeader();
}

/* Kategoriler */
const DEFAULT_CATS=[{name:'Ushqime',emoji:'üçî'},{name:'Transport',emoji:'‚õΩ'},{name:'Sht√´pia',emoji:'üè†'},{name:'Arg√´tim',emoji:'üéüÔ∏è'},{name:'Fatura',emoji:'üí°'},{name:'T√´ tjera',emoji:'üßæ'}];
async function ensureCategoriesSeed(){
  const {data}=await supabase.from('categories').select('id').eq('user_id',sessionUser.id).limit(1);
  if(!data || data.length===0){await supabase.from('categories').insert(DEFAULT_CATS.map(c=>({...c,user_id:sessionUser.id}))); }
}
async function loadCategories(){
  const {data,error}=await supabase.from('categories').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:true});
  cats=(error?DEFAULT_CATS:data||[]).map(r=>({name:r.name,emoji:r.emoji,id:r.id}));
  renderCatList(); refreshCategorySelects(); drawAll();
}
function renderCatList(){
  const box=gid('catList'); box.innerHTML='';
  cats.forEach(c=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.style.fontSize='28px'; ic.textContent=c.emoji||'üßæ';
    const meta=document.createElement('div'); meta.className='meta';
    const t=document.createElement('div'); t.className='t'; t.textContent=c.name;
    const s=document.createElement('div'); s.className='s'; s.textContent='Kategori personale';
    meta.appendChild(t); meta.appendChild(s);
    const del=document.createElement('button'); del.className='del'; del.textContent='üóëÔ∏è'; del.onclick=()=>deleteCategory(c.id);
    el.append(ic,meta,del); box.appendChild(el);
  });
}
function refreshCategorySelects(){
  const mCat=gid('mCat'), fCat=gid('fCat'); mCat.innerHTML=''; fCat.innerHTML='<option value="">T√´ gjitha</option>';
  cats.forEach(c=>{
    const o=document.createElement('option'); o.value=c.name; o.textContent=(c.emoji||'‚Ä¢')+' '+c.name;
    mCat.appendChild(o.cloneNode(true));
    const o2=document.createElement('option'); o2.value=c.name; o2.textContent=c.name; fCat.appendChild(o2);
  });
}
async function addCategory(){
  const name=(gid('newCatName').value||'').trim();
  const emoji=(gid('newCatEmoji').value||'').trim()||'üßæ';
  const msg=gid('catMsg'); msg.textContent='';
  if(!name){msg.textContent='Shkruaj emrin e kategoris√´.';return;}
  const {data,error}=await supabase.from('categories').insert({user_id:sessionUser.id,name,emoji}).select().single();
  if(error){msg.textContent='Gabim: '+error.message;return;}
  cats.push({name:data.name,emoji:data.emoji,id:data.id}); gid('newCatName').value=''; renderCatList(); refreshCategorySelects();
  msg.textContent='U shtua.';
}
async function deleteCategory(id){
  if(!confirm('Fshije k√´t√´ kategori?')) return;
  const {error}=await supabase.from('categories').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){alert('Gabim: '+error.message);return;}
  cats=cats.filter(c=>c.id!==id); renderCatList(); refreshCategorySelects(); drawAll();
}
function emojiFor(catName){
  const hit=cats.find(c=>c.name===catName);
  if(hit) return hit.emoji||'üßæ';
  const m={'Ushqime':'üçî','Transport':'‚õΩ','Sht√´pia':'üè†','Arg√´tim':'üéüÔ∏è','Fatura':'üí°','T√´ tjera':'üßæ'};
  return m[catName]||'üí∏';
}

/* Ba≈ülƒ±k/istatistikler */
function refreshHeader(){
  const cur=profile.pref_currency||'ALL', sym=currSym(cur);
  setText('hdrSym',sym); setText('sym1',sym); setText('sym2',sym); setText('sym3',sym);
  const icon=gid('hdrIcon'), text=gid('hdrText'), sub=gid('hdrSub');
  const s1=gid('s1name'), s2=gid('s2name'), s3=gid('s3name');

  if(activeTab==='debts'){
    icon.textContent='üí≥'; text.textContent='Borxhet'; sub.textContent='Detyrimet & M√´ detyrohen';
    const arr=debts.filter(x=>(x.currency||'ALL')===cur);
    const borrowOpen=sum(arr.filter(x=>x.kind==='borrow' && x.status!=='paid').map(n=>Number(n.amount||0)));
    const lendOpen=sum(arr.filter(x=>x.kind==='lend' && x.status!=='paid').map(n=>Number(n.amount||0)));
    setText('hdrTotal',fmt(borrowOpen,cur));
    s1.textContent='Gjithsej'; s2.textContent='Detyrime'; s3.textContent='M√´ detyrohen';
    setText('stat1',fmt(sum(arr.map(n=>Number(n.amount||0))),cur));
    setText('stat2',fmt(borrowOpen,cur));
    setText('stat3',fmt(lendOpen,cur));
  }else{
    icon.textContent='üí∞'; text.textContent='Bilanci'; sub.textContent='Gjendja ‚àí Shpenzimet (totale)';
    const arr=items.filter(x=>(x.currency||'ALL')===cur);
    const total=sum(arr.map(x=>Number(x.amount||0)));
    const today=sum(arr.filter(isToday).map(x=>Number(x.amount||0)));
    const month=sum(arr.filter(isThisMonth).map(x=>Number(x.amount||0)));
    const remain=getBalance(cur) - total;
    setText('hdrTotal',fmt(remain,cur));
    s1.textContent='Totale'; s2.textContent='Sot'; s3.textContent='Muaj';
    setText('stat1',fmt(total,cur)); setText('stat2',fmt(today,cur)); setText('stat3',fmt(month,cur));
  }
}

/* Shpenzimet */
async function loadExpenses(){
  const {data,error}=await supabase.from('expenses').select('*').eq('user_id',sessionUser.id).order('d',{ascending:false}).limit(2000);
  if(error){alert('Gabim ngarkimi (shpenzime): '+error.message);return;}
  items=(data||[]).map(x=>({...x,currency:x.currency||'ALL'})); drawHome(); drawAll(); refreshHeader();
}
async function saveExpense(){
  const name=gid('mName').value.trim();
  const amt=parseFloat(gid('mAmt').value);
  const cat=gid('mCat').value;
  const d  =gid('mDate').value;
  const cur=profile.pref_currency||'ALL';
  if(!name||!amt||!d||isNaN(amt)){alert('Plot√´soni emrin, shum√´n dhe dat√´n.');return;}
  const {data,error}=await supabase.from('expenses').insert({user_id:sessionUser.id,name,amount:amt,category:cat,d,currency:cur}).select().single();
  if(error){alert('Gabim: '+error.message);return;}
  items.unshift(data); gid('mName').value=''; gid('mAmt').value=''; closeModal('Exp'); drawHome(); drawAll(); refreshHeader();
}
async function delExpense(id){
  if(!confirm('Fshini k√´t√´ shpenzim?'))return;
  const {error}=await supabase.from('expenses').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){alert('Gabim: '+error.message);return;}
  items=items.filter(x=>x.id!==id); drawHome(); drawAll(); refreshHeader();
}
function rowExpense(x){
  const el=document.createElement('div'); el.className='item';
  const ic=document.createElement('div'); ic.className='ic'; ic.textContent=emojiFor(x.category);
  const meta=document.createElement('div'); meta.className='meta';
  const t=document.createElement('div'); t.className='t'; t.textContent=x.name;
  const s=document.createElement('div'); s.className='s'; s.textContent=[x.category,fmtDate(x.d)].filter(Boolean).join(' ‚Ä¢ ');
  meta.appendChild(t); meta.appendChild(s);
  const amt=document.createElement('div'); amt.className='amt'; amt.textContent=fmt(x.amount,x.currency)+' '+currSym(x.currency);
  const del=document.createElement('button'); del.className='del'; del.textContent='üóëÔ∏è'; del.onclick=()=>delExpense(x.id);
  el.append(ic,meta,amt,del); return el;
}
function drawHome(){
  const recent=[...items].sort((a,b)=>b.d.localeCompare(a.d)).slice(0,8);
  const list=gid('recentList'); list.innerHTML='';
  gid('emptyHome').style.display=recent.length?'none':'block';
  recent.forEach(x=>list.appendChild(rowExpense(x)));
}
function drawAll(){
  const q=(gid('q').value||'').trim().toLowerCase();
  const cat=gid('fCat').value;
  const cur=profile.pref_currency||'ALL';
  let arr=[...items].filter(x=>(x.currency||'ALL')===cur).sort((a,b)=>b.d.localeCompare(a.d));
  if(q)arr=arr.filter(x=>x.name.toLowerCase().includes(q)||(x.category||'').toLowerCase().includes(q));
  if(cat)arr=arr.filter(x=>x.category===cat);
  const box=gid('allList'); box.innerHTML=''; arr.forEach(x=>box.appendChild(rowExpense(x)));
}

/* Borxhet */
async function loadDebts(){
  const {data,error}=await supabase.from('debts').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:false}).limit(2000);
  if(error){alert('Gabim ngarkimi (borxhe): '+error.message);return;}
  debts=(data||[]).map(x=>({...x,currency:x.currency||'ALL'})); drawDebts(); refreshHeader();
}
async function saveDebt(){
  const party=gid('dParty').value.trim();
  const name =(gid('dName').value||'').trim();
  const amt  =parseFloat(gid('dAmt').value);
  const kind =segValue('segType');
  const due  =gid('dDate').value||null;
  const cur  =profile.pref_currency||'ALL';
  if(!party||!amt||isNaN(amt)){alert('Shkruaj Pal√´n (Emri) dhe shum√´n.');return;}
  const payload={user_id:sessionUser.id,party,name,amount:amt,kind,due,status:'open',currency:cur};
  const {data,error}=await supabase.from('debts').insert(payload).select().single();
  if(error){alert('Gabim: '+error.message);return;}
  debts.unshift(data); gid('dParty').value=''; gid('dName').value=''; gid('dAmt').value=''; resetSeg('segType','borrow');
  closeModal('Debt'); drawDebts(); refreshHeader();
}
async function delDebt(id){
  if(!confirm('Fshini k√´t√´ borxh?'))return;
  const {error}=await supabase.from('debts').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){alert('Gabim: '+error.message);return;}
  debts=debts.filter(x=>x.id!==id); drawDebts(); refreshHeader();
}
async function payDebt(id){
  if(!confirm('Borxhi u pagua. Je i sigurt?')) return;
  const {data,error}=await supabase.from('debts').update({status:'paid'}).eq('id',id).eq('user_id',sessionUser.id).select().single();
  if(error){alert('Gabim: '+error.message);return;}
  debts=debts.map(x=>x.id===id?data:x); drawDebts(); refreshHeader();
}
function drawDebts(){
  const q=(gid('dq').value||'').trim().toLowerCase();
  const kindFilter=segValue('dSegFilter');
  const cur=profile.pref_currency||'ALL';

  let arr=[...debts].filter(x=>(x.currency||'ALL')===cur);
  if(q)arr=arr.filter(x=>(x.party||'').toLowerCase().includes(q)||(x.name||'').toLowerCase().includes(q));
  if(kindFilter)arr=arr.filter(x=>x.kind===kindFilter);

  const box=gid('debtList'); box.innerHTML='';
  gid('emptyDebts').style.display=arr.length?'none':'block';

  arr.forEach(x=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ic'; ic.textContent=(x.status==='paid')?'‚úÖ':'üí≥';
    const meta=document.createElement('div'); meta.className='meta';
    const t=document.createElement('div'); t.className='t'; t.textContent=x.party || '(pa em√´r)';
    const bits=[x.kind==='borrow'?'Mora hua':'Dhash hua']; if(x.name) bits.push(x.name); if(x.due) bits.push('Afati: '+fmtDate(x.due));
    const s=document.createElement('div'); s.className='s'; s.textContent=bits.join(' ‚Ä¢ ');
    meta.appendChild(t); meta.appendChild(s);

    const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
    const amt=document.createElement('div'); amt.className='amt'; amt.textContent=fmt(x.amount,x.currency)+' '+currSym(x.currency);
    right.appendChild(amt);

    if(x.status==='open'){
      const pay=document.createElement('button'); pay.className='btnMini'; pay.textContent=(x.kind==='borrow')?'Paguaj':'U kthye';
      pay.onclick=()=>payDebt(x.id); right.appendChild(pay);
    }else{
      const badge=document.createElement('span'); badge.className='chip'; badge.textContent='Paguar'; right.appendChild(badge);
    }

    const del=document.createElement('button'); del.className='del'; del.textContent='üóëÔ∏è'; del.onclick=()=>delDebt(x.id);
    el.append(ic,meta,right,del); box.appendChild(el);
  });
}

/* Email & Password */
async function changeEmail(){const e=(gid('newEmail').value||'').trim();const m=gid('emailMsg');m.textContent='';if(!e||!e.includes('@')){m.textContent='Shkruaj nj√´ email t√´ vlefsh√´m.';return;}const {error}=await supabase.auth.updateUser({email:e});m.textContent=error?('Gabim: '+error.message):'U d√´rgua linku i konfirmimit.'}
async function changePassword(){
  const p1=gid('newPass').value, p2=gid('newPass2').value, m=gid('passMsg'); m.textContent='';
  if(!sessionUser){ m.textContent='Duhet t√´ jesh i ky√ßur.'; showGate(); return; }
  if(!p1||p1.length<6){ m.textContent='Fjal√´kalimi ‚â• 6.'; return; }
  if(p1!==p2){ m.textContent='Fjal√´kalimet nuk p√´rputhen.'; return; }
  try{ await supabase.auth.refreshSession(); }catch(e){}
  let { error } = await supabase.auth.updateUser({ password:p1 });
  if(error && /Auth session missing/i.test(error.message||'')){
    const { data:{ session } } = await supabase.auth.getSession();
    if(!session){ m.textContent='Sesioni ka skaduar. Hyni s√´rish.'; await supabase.auth.signOut(); showGate(); return; }
    ({ error } = await supabase.auth.updateUser({ password:p1 }));
  }
  if(error){ m.textContent='Gabim: '+(error.message||'Nuk u p√´rdit√´sua.'); return; }
  gid('newPass').value=''; gid('newPass2').value=''; m.textContent='Fjal√´kalimi u p√´rdit√´sua. Hyni s√´rish.'; await supabase.auth.signOut(); showGate();
}
</script>
</body>
</html>
