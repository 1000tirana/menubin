<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Normal Holding ‚Ä¢ Shpenzimet (FINALE)</title>
<meta name="theme-color" content="#0d1117">
<style>
  :root{
    --bg:#0d1117; --card:#161b22; --border:#30363d;
    --text:#c9d1d9; --muted:#8b949e;
    --primary:#2ea043; --primary2:#238636;
    --blue:#1f6feb; --danger:#f85149;
    --safe-top:env(safe-area-inset-top,0px);
    --safe-bottom:env(safe-area-inset-bottom,0px);
    --nav-h:76px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;background:var(--bg);overscroll-behavior:none;overflow-x:hidden}
  body{margin:0;color:var(--text);font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;touch-action:manipulation}
  .wrap{display:flex;flex-direction:column;min-height:100vh;padding-bottom:calc(var(--nav-h) + var(--safe-bottom))}
  header{
    background:linear-gradient(135deg,var(--primary2) 0%, var(--primary) 100%);
    color:#fff;border-bottom-left-radius:22px;border-bottom-right-radius:22px;
    padding:calc(10px + var(--safe-top)) 16px 12px; box-shadow:0 10px 28px rgba(35,134,54,.35)
  }
  header .top{display:flex;justify-content:space-between;align-items:center}
  header .title{font-size:20px;font-weight:900;display:flex;gap:8px;margin-top:6px}
  header .big{font-size:32px;font-weight:900;margin-top:8px}
  header .muted{color:#e6edf3;opacity:.8}
  .stats{display:flex;gap:10px;padding:10px 12px;transform:translateY(-12px)}
  .card{flex:1;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  main{padding:0 12px 20px}
  h3.sec{margin:0 0 8px}
  .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
  .item{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:12px}

  .ic{width:52px;height:52px;border-radius:50%;display:grid;place-items:center;color:#0d1117;
    background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
    box-shadow:inset 0 1px 4px rgba(0,0,0,.6), 0 6px 14px rgba(0,0,0,.4);
    border:1px solid rgba(255,255,255,.06); font-size:24px}
  .meta{flex:1}
  .meta .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#e6edf3}
  .meta .s{font-size:12px;color:var(--muted)}
  .amt{font-weight:900;color:#e6edf3;white-space:nowrap}
  .del{border:none;background:transparent;color:var(--danger);font-size:20px;cursor:pointer}

  .row{display:flex;gap:10px}
  label{font-size:13px;color:var(--muted)}
  input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;
    font-size:16px;background:var(--card);color:var(--text);-webkit-appearance:none}
  .actions{display:flex;gap:10px;margin-top:10px}
  .btnP,.btnS,.btnMini{font-size:16px;touch-action:manipulation;-webkit-tap-highlight-color:transparent;user-select:none}
  .btnP{flex:1;background:linear-gradient(180deg,var(--primary) 0%, var(--primary2) 100%);color:#fff;border:1px solid #2ea043;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
  .btnS{flex:1;background:#21262d;color:#e6edf3;border:1px solid var(--border);padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
  .btnMini{background:#21262d;border:1px solid var(--border);padding:8px 10px;border-radius:10px;font-weight:800;color:#e6edf3;cursor:pointer}
  .chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#1f6feb;color:#fff}

  /* Para ≈üeridi */
  .curr-strip{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
  .curr-pill{
    padding:8px 12px;border-radius:999px;border:1px solid var(--border);
    background:#21262d;color:#e6edf3;font-weight:800;font-size:13px;cursor:pointer;
  }
  .curr-pill.active{background:linear-gradient(180deg,#1f6feb 0%, #1158c7 100%);color:#fff}
  @media(max-width:360px){ .curr-pill{padding:6px 10px;font-size:12px} }
  
  /* Yeni eklenen d√∂viz toplamƒ± alanƒ± */
  .header-fx-summary {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-top: 8px;
      gap: 16px;
  }
  .header-fx-summary .fx-total {
      text-align: right;
      font-size: 28px; /* Biraz k√º√ß√ºltt√ºm */
      font-weight: 900;
      color: #e6edf3;
      opacity: 1;
      line-height: 1.2;
  }
  .header-fx-summary .fx-label {
      font-size: 12px;
      font-weight: 800;
      color: #e6edf3;
      opacity: 0.7;
      margin-bottom: 0px;
      white-space: nowrap;
  }
  .header-fx-summary .main-balance{
    flex:1;
  }
  .header-fx-summary .fx-wallet-total{
    flex-shrink: 0;
    text-align: right;
  }

  /* Alt NAV */
  nav.nav{
    --fab-gap: 110px;
    position:fixed;left:0;right:0;bottom:0;transform:translateZ(0);
    height:calc(var(--nav-h) + var(--safe-bottom));padding:0 12px var(--safe-bottom);
    background:var(--card);border-top:1px solid var(--border);box-shadow:0 -10px 30px rgba(0,0,0,.35);
    border-top-left-radius:16px;border-top-right-radius:16px;z-index:2000;
    display:grid;grid-template-columns:1fr 1fr var(--fab-gap) 1fr 1fr;align-items:center;
    backface-visibility:hidden;will-change:transform
  }
  .btn{justify-self:center;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);text-decoration:none;cursor:pointer}
  .btn:nth-of-type(1){grid-column:1}.btn:nth-of-type(2){grid-column:2}.btn:nth-of-type(3){grid-column:4}.btn:nth-of-type(4){grid-column:5}
  .btn .ico{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;color:#0d1117;
    background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
    box-shadow:inset 0 1px 3px rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.06);font-size:24px}
  .btn.active{color:#79c0ff}
  .btn.active .ico{background:radial-gradient(circle at 30% 30%, #cfe7ff 0%, #9dd2ff 45%, #1f6feb 100%)}

  /* FAB */
  .nav .fab{
    position:absolute;left:50%;transform:translateX(-50%);
    top:-22px;width:56px;height:56px;border-radius:999px;
    background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
    border:1px solid rgba(255,255,255,.06);color:#0d1117;font-size:28px;
    display:grid;place-items:center;box-shadow:0 14px 26px rgba(0,0,0,.5), inset 0 1px 4px rgba(0,0,0,.6);
    cursor:pointer;z-index:2100;pointer-events:auto
  }
  @supports (-webkit-touch-callout: none){.nav .fab{top:-24px}}
  .tab{display:none}.tab.active{display:block}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:end;padding:14px;z-index:3000}
  .modal.on{display:grid}
  .sheet{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px 14px 18px;width:100%;box-shadow:0 -12px 30px rgba(0,0,0,.5)}

  /* Auth gate */
  .gate{position:fixed;inset:0;display:grid;place-items:center;background:var(--bg);padding:18px;z-index:4000}
  .panel{background:var(--card);border:1px solid var(--border);width:min(520px,92vw);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .tabs{display:flex;gap:6px;margin-bottom:10px}
  .tabs button{flex:1;border:1px solid var(--border);padding:10px;border-radius:10px;background:#21262d;color:#e6edf3;cursor:pointer}
  .tabs button.active{background:linear-gradient(180deg,var(--primary) 0%, var(--primary2) 100%);border-color:#2ea043;color:#fff;font-weight:800}

  /* Segmentler */
  .seg{background:#21262d;border:1px solid var(--border);border-radius:10px;padding:4px;display:grid;gap:4px}
  .seg.two{grid-template-columns:1fr 1fr}.seg.three{grid-template-columns:1fr 1fr 1fr}
  .seg button{border:none;padding:10px;border-radius:8px;background:transparent;cursor:pointer;font-weight:800;color:#e6edf3}
  .seg button.active{background:linear-gradient(180deg,#1f6feb 0%, #1158c7 100%);color:#fff}

  /* Emoji picker modal */
  .picker-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;max-height:45vh;overflow:auto;margin-top:8px}
  .picker-grid button{border:1px solid var(--border);background:#21262d;border-radius:10px;width:44px;height:44px;font-size:22px;cursor:pointer}
  #emojiBtn{display:flex;gap:8px;align-items:center;width:100%}

  @media(min-width:720px){.wrap{max-width:520px;margin:0 auto}}
</style>
</head>
<body>

<div id="gate" class="gate">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900;font-size:18px">Normal Holding</div>
      <div class="muted">Shpenzimet ‚Ä¢ Cloud</div>
    </div>
    <div class="tabs">
      <button id="tabLoginBtn" class="active" onclick="swapAuth('login')">Hyrje</button>
      <button id="tabRegBtn" onclick="swapAuth('reg')">Regjistrohu</button>
    </div>
    <div id="authLogin">
      <label>Email</label>
      <input id="loginEmail" placeholder="emri@gmail.com" autocomplete="username">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>Fjal√´kalimi</label><input id="loginPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      </div>
      <div class="actions"><button class="btnP" onclick="login()">Hyr</button></div>
      <div id="authMsg" class="muted" style="margin-top:6px;color:var(--danger)"></div>
    </div>
    <div id="authReg" style="display:none">
      <label>Email</label>
      <input id="regEmail" placeholder="emri@gmail.com" autocomplete="username">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>Fjal√´kalimi</label><input id="regPass" type="password" autocomplete="new-password" placeholder="min. 6"></div>
      </div>
      <div class="actions"><button class="btnS" onclick="swapAuth('login')">Kthehu</button><button class="btnP" onclick="registerUser()">Krijo llogari</button></div>
      <div id="regMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<div class="wrap" id="app" style="display:none">
  <header>
    <div class="top">
      <div style="font-weight:800">Normal Holding</div>
      <div class="muted" id="who">@p√´rdoruesi</div>
    </div>
    <div class="header-fx-summary">
        <div class="main-balance">
            <div class="title"><span id="hdrIcon">üí∞</span><span id="hdrText">Bilanci</span></div>
            <div class="big"><span id="hdrTotal">0</span></div>
            <div class="muted" id="hdrSub">Gjendja e monedh√´s aktuale ‚àí Shpenzimet (totale)</div>
        </div>
        <div class="fx-wallet-total">
            <div class="fx-label">Totali i C√ºzdan√´ve</div>
            <div class="fx-total"><span id="hdrTotalFX">0</span></div>
        </div>
    </div>


    <div id="currStrip" class="curr-strip"></div>
  </header>

  <div id="statsRow" class="stats">
    <div class="card"><div class="muted">üìä Totale</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat1">0</span></div></div>
    <div class="card"><div class="muted">üìÖ Sot</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat2">0</span></div></div>
    <div class="card"><div class="muted">üóìÔ∏è Muaj</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat3">0</span></div></div>
  </div>

  <main>
    <section id="tab-home" class="tab active">
      <h3 class="sec">üïí T√´ fundit</h3>
      <div id="recentList" class="list"></div>
      <div id="emptyHome" class="muted" style="text-align:center;margin-top:16px">Asnj√´ hyrje deri tani.</div>
    </section>

    <section id="tab-list" class="tab">
      <h3 class="sec">üìö Lista</h3>
      <div class="row" style="margin:8px 0 10px">
        <input id="q" placeholder="K√´rko..." oninput="drawAll()">
        <select id="fCat" onchange="drawAll()"><option value="">T√´ gjitha</option></select>
      </div>
      <div id="allList" class="list"></div>
    </section>

    <section id="tab-debts" class="tab">
      <h3 class="sec">üí≥ Borxhet</h3>
      <div class="row" style="margin:8px 0 10px"><input id="dq" placeholder="K√´rko borxhe..." oninput="drawDebts()"></div>
      <div class="seg three" id="dSegFilter" style="margin-bottom:8px">
        <button type="button" class="active" data-val="">T√´ gjitha</button>
        <button type="button" data-val="borrow">Mora hua</button>
        <button type="button" data-val="lend">Dhash hua</button>
      </div>
      <div id="debtList" class="list"></div>
      <div id="emptyDebts" class="muted" style="text-align:center;margin-top:16px">Asnj√´ borxh deri tani.</div>
    </section>

    <section id="tab-settings" class="tab">
      <h3 class="sec">‚öôÔ∏è Cil√´sime</h3>

      <div class="item">
        <div class="ic">üë§</div>
        <div class="meta"><div class="t">P√´rdoruesi</div><div class="s muted" id="userInfo">‚Äî</div></div>
        <button class="del" style="color:#e6edf3" onclick="logout()">üö™</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">üí± Monedha & format</h4>
        <div class="row">
          <select id="setCurr" style="flex:1">
            <option>ALL ‚Äî Albania Lek</option>
            <option>EUR ‚Äî Euro</option>
            <option>USD ‚Äî US Dollar</option>
            <option>TRY ‚Äî Turkish Lira</option>
          </select>
          <select id="setFmt" style="flex:1">
            <option value="eu">23.456,78</option>
            <option value="us">23,456.78</option>
          </select>
        </div>
        <div class="actions"><button class="btnP" onclick="savePrefs()">Ruaj preferencat</button></div>
        <div id="prefsMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">üßæ Gjendja (Balanca)</h4>
        <div class="row">
            <select id="balCurrSelect" style="flex:1" onchange="updateBalInput()">
                <option>ALL</option><option>EUR</option><option>USD</option><option>TRY</option>
            </select>
            <input id="balInput" type="number" step="0.01" inputmode="decimal" placeholder="0.00" style="flex:2">
        </div>
        <div class="actions"><button class="btnP" onclick="saveBalance()">Ruaj gjendjen</button></div>
        <div id="balMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">üè∑Ô∏è Kategoriat</h4>
        <div id="catList" class="list" style="margin-top:8px"></div>
        <div style="border-top:1px solid var(--border);margin:12px 0"></div>
        <div class="row">
          <div style="width:132px">
            <label>Emoji</label>
            <button class="btnS" id="emojiBtn" onclick="openModal('Emoji')">
              <span id="emojiPreview" style="font-size:22px">üçî</span>
              <span style="margin-left:6px">Zgjidh emoji</span>
            </button>
            <input id="newCatEmoji" value="üçî" hidden>
          </div>
          <div style="flex:1">
            <label>Emri i kategoris√´</label>
            <input id="newCatName" placeholder="p.sh. Ushqime">
          </div>
        </div>
        <div class="actions"><button class="btnP" onclick="addCategory()">Shto kategori</button></div>
        <div id="catMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">üîÑ Konvertues</h4>
        <div class="row">
          <input id="cvAmt" type="number" step="0.01" inputmode="decimal" placeholder="Shuma" style="flex:1">
          <select id="cvFrom" style="flex:1">
            <option>ALL</option><option>EUR</option><option>USD</option><option>TRY</option>
          </select>
          <select id="cvTo" style="flex:1">
            <option>EUR</option><option>ALL</option><option>USD</option><option>TRY</option>
          </select>
        </div>
        <div class="actions"><button class="btnS" onclick="doConvert()">Konverto</button></div>
        <div id="cvRes" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">üßπ Cache & reset</h4>
        <div class="actions"><button class="btnS" onclick="clearAppCache()">Cache&#39;i temizle dhe sƒ±f√´rla</button></div>
        <div id="cacheMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

    </section>
  </main>
</div>

<nav class="nav" id="navbar" style="display:none">
  <a class="btn active" data-tab="home"><span class="ico">üè†</span><span>Kreu</span></a>
  <a class="btn" data-tab="list"><span class="ico">üìã</span><span>Lista</span></a>
  <a class="btn" data-tab="debts"><span class="ico">üí≥</span><span>Borxhet</span></a>
  <a class="btn" data-tab="settings"><span class="ico">‚öôÔ∏è</span><span>Cil√´sime</span></a>
  <button class="fab" id="openAdd" aria-label="Shto">Ôºã</button>
</nav>

<div class="modal" id="modalExp"><div class="sheet">
  <h3 style="margin:4px 0 10px">‚ûï Shto shpenzim</h3>
  <div class="row">
    <div style="flex:2"><label>Emri</label><input id="mName" placeholder="p.sh. Karburant"></div>
    <div style="flex:1"><label>Shuma</label><input id="mAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label>Kategoria</label><select id="mCat"></select></div>
    <div style="flex:1"><label>Data</label><input id="mDate" type="date"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label>Monedha (D√∂viz)</label><select id="mCurr"></select></div>
  </div>
  <div class="actions"><button class="btnS" onclick="closeModal('Exp')">Mbyll</button><button class="btnP" onclick="saveExpense()">Ruaj</button></div>
</div></div>

<div class="modal" id="modalDebt"><div class="sheet">
  <h3 style="margin:4px 0 10px">‚ûï Shto borxh</h3>
  <div class="row">
    <div style="flex:1"><label>Pal√´ (Emri)</label><input id="dParty" placeholder="p.sh. Arben / ACME sh.p.k."></div>
    <div style="flex:1"><label>Shuma</label><input id="dAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label>Lloji</label><div id="segType" class="seg two"><button type="button" class="active" data-val="borrow">Mora hua</button><button type="button" data-val="lend">Dhash hua</button></div></div>
    <div style="flex:1"><label>Afati (opsionale)</label><input id="dDate" type="date"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label>P√´rshkrimi (opsionale)</label><input id="dName" placeholder="p.sh. Telefon i ri"></div>
  </div>
  <div class="actions"><button class="btnS" onclick="closeModal('Debt')">Mbyll</button><button class="btnP" onclick="saveDebt()">Ruaj</button></div>
</div></div>

<div class="modal" id="modalEmoji"><div class="sheet">
  <h3 style="margin:4px 0 10px">üôÇ Zgjidh nj√´ emoji</h3>
  <div id="emojiGrid" class="picker-grid"></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Emoji')">Mbyll</button></div>
</div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ========= SUPABASE & GLOBAL VARS ========= */
const SUPABASE_URL='https://nvpjqvggaiipwziolend.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cGpxdmdnYWlpcHd6aW9sZW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4OTExNzcsImV4cCI6MjA3NDQ2NzE3N30.PnJh09kx-kK8iChgQl2M1eTw5P2qRZUEO31wVY7_iP4';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

let sessionUser=null, items=[], debts=[], profile={default_currency:'ALL',num_format:'eu',balances:{ALL:0,EUR:0,USD:0,TRY:0}}, cats=[], activeTab='home';
let rates = {ALL:1, EUR:1, USD:1, TRY:1};
const SUPPORTED = ['ALL','EUR','USD','TRY'];
let viewCurrency = null; // Aktif g√∂r√ºnt√ºleme para birimi

/* ===== DOM READY & INIT ===== */
document.addEventListener('DOMContentLoaded', async () => {
  showGate();

  // Emoji Grid ve Diƒüer UI Hazƒ±rlƒ±klarƒ± (Kategori, Tarih vs.)
  'üçî ü•ó üçï üç∞ ‚òï üç∫ üõí üöå ‚õΩ üöï üõ†Ô∏è üßΩ üéÅ üéÆ üé¨ üéüÔ∏è üí° üì± üíª üè† üêæ ‚öΩ üßæ üíä ‚úàÔ∏è üöó üí≥ üíé üéì üìö üîå üîã üëü üçº üßª üß¥ üê∂ üê±'.split(' ')
    .forEach(e=>{
      const b=document.createElement('button');
      b.textContent=e;
      b.onclick=()=>{
        document.getElementById('newCatEmoji').value=e;
        document.getElementById('emojiPreview').textContent=e;
        closeModal('Emoji');
      };
      document.getElementById('emojiGrid').appendChild(b);
    });

  const today = new Date().toISOString().slice(0,10);
  document.getElementById('mDate').value=today;
  document.getElementById('dDate').value=today;

  const mCurrSelect = document.getElementById('mCurr');
  SUPPORTED.forEach(c => {
      const option = document.createElement('option');
      option.value = c; option.textContent = c;
      mCurrSelect.appendChild(option);
  });
  
  document.getElementById('balCurrSelect').value = profile.default_currency || 'ALL';

  document.querySelectorAll('#segType button').forEach(b=>b.onclick=()=>toggleSeg('segType',b));
  document.querySelectorAll('#dSegFilter button').forEach(b=>b.onclick=()=>{toggleSeg('dSegFilter',b);drawDebts();});

  const fab=document.getElementById('openAdd');
  const fabOpen=()=>{ if(activeTab==='debts') openModal('Debt'); else openModal('Exp'); };
  ['pointerup','touchend','click'].forEach(ev=>fab.addEventListener(ev,fabOpen,{passive:true}));

  document.querySelectorAll('nav.nav .btn').forEach(btn=>btn.addEventListener('click', ()=>switchTab(btn.dataset.tab)));

  // Ngarko sesionin
  try{
    const {data:{session}}=await supabase.auth.getSession();
    if(session?.user){ sessionUser=session.user; showApp(); await bootstrap(); }
  }catch(e){console.error("Session load error:", e)}

  // Monitoro ndryshimet e sesionit
  supabase.auth.onAuthStateChange(async (_e,session)=>{
    if(session?.user){sessionUser=session.user; showApp(); await bootstrap();}
    else{sessionUser=null; showGate();}
  });

  loadRates(); // Kurlarƒ± ba≈ülat
});

/* ===== BOOTSTRAP: Ngarkon t√´ gjitha t√´ dh√´nat e p√´rdoruesit (ƒ∞lk Y√ºkleme Sƒ±rasƒ± D√ºzeltildi) ===== */
async function bootstrap(){
  await ensureProfile(); // Profil y√ºkle/olu≈ütur
  renderCurrStrip(); // Para ≈üeridini profile g√∂re √ßiz
  await Promise.all([ensureCategoriesSeed(), loadCategories(), loadExpenses(), loadDebts()]); // Verileri y√ºkle
  refreshHeader(); // Header'ƒ± hesapla ve g√∂ster
}

/* ===== UI helpers (Gjendja e aplikacionit) ===== */
function emailShort(e){return e?e.split('@')[0]:'@p√´rdoruesi'}
function showGate(){
  document.getElementById('gate').style.display='grid';
  document.getElementById('app').style.display='none';
  document.getElementById('navbar').style.display='none';
}
function showApp(){
  document.getElementById('gate').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('navbar').style.display='grid';
  document.getElementById('who').textContent=emailShort(sessionUser?.email);
  document.getElementById('userInfo').textContent=sessionUser?.email||'-';
  document.getElementById('mCurr').value = profile.default_currency || 'ALL'; // Modal varsayƒ±lan d√∂viz
}
function swapAuth(w){
  document.getElementById('tabLoginBtn').classList.toggle('active',w==='login');
  document.getElementById('tabRegBtn').classList.toggle('active',w==='reg');
  document.getElementById('authLogin').style.display=(w==='login')?'block':'none';
  document.getElementById('authReg').style.display=(w==='reg')?'block':'none';
  setText('authMsg', ''); setText('regMsg', '');
}
async function registerUser(){
  const email=document.getElementById('regEmail').value.trim();
  const pass=document.getElementById('regPass').value;
  const box=document.getElementById('regMsg'); box.textContent='';
  if(!email||pass.length<6){box.textContent='Email dhe fjal√´kalim ‚â• 6.';return;}
  const {error}=await supabase.auth.signUp({email,password:pass});
  box.textContent=error?('Gabim: '+error.message):'Llogaria u krijua. Kontrollo email-in p√´r t√´ hyr√´.';
}
async function login(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value;
  const box=document.getElementById('authMsg'); box.textContent='';
  
  // LOGIN LOGIC FIX: Invalid credential hatasƒ±nƒ± yakalama
  const {error}=await supabase.auth.signInWithPassword({email,password:pass});
  if(error) {
    console.error("Login Error:", error);
    box.textContent='Gabim: ' + (error.message.includes('Invalid login') ? 'Kredenciale t√´ pavlefshme ose e-maili i pa konfirmuar.' : error.message);
  } else {
    box.textContent = ''; // Ba≈üarƒ±lƒ± giri≈ü
  }
}
async function logout(){await supabase.auth.signOut()}

/* ===== NAV (Ndryshimi i skedave) ===== */
function switchTab(name){
  document.querySelectorAll('.tab').forEach(sec=>sec.classList.toggle('active', sec.id==='tab-'+name));
  document.querySelectorAll('nav.nav .btn').forEach(btn=>btn.classList.toggle('active', btn.dataset.tab===name));
  activeTab=name;
  document.getElementById('statsRow').style.display=(name==='settings')?'none':'flex';
  refreshHeader(); 
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ===== Profil (Preferencat e P√´rdoruesit) ===== */
async function ensureProfile(){
  try{
    let {data}=await supabase.from('profiles').select('*').eq('user_id',sessionUser.id).maybeSingle();
    const defaultBalances = {ALL:0, EUR:0, USD:0, TRY:0};

    if(data) {
        // Balanslarƒ± kontrol et ve eksik olanlarƒ± default ile doldur
        const safeBalances = {...defaultBalances, ...(data.balances || {})};
        profile = {...data, balances: safeBalances};
    }
    else{
      // Yeni kullanƒ±cƒ±: Default profil olu≈ütur
      const def={user_id:sessionUser.id,default_currency:'ALL',num_format:'eu',balances:defaultBalances};
      const {data:newp, error: insertError}=await supabase.from('profiles').insert(def).select().single();
      if (insertError) throw insertError;
      profile=newp||def;
    }
  }catch(e){
    console.error("Gabim n√´ marrjen/krijimin e profilit:", e);
    // Hata durumunda uygulama kilitlenmesin
    profile = {user_id:sessionUser.id,default_currency:'ALL',num_format:'eu',balances:{ALL:0,EUR:0,USD:0,TRY:0}};
  }
  
  // Konfiguro UI-n√´ e cil√´simeve
  document.getElementById('setFmt').value=profile.num_format||'eu';
  const c=profile.default_currency||'ALL';
  const currencyOption = SUPPORTED.includes(c)? c + ' ‚Äî ' + (c==='ALL'?'Albania Lek':c==='EUR'?'Euro':c==='USD'?'US Dollar':'Turkish Lira') : 'ALL ‚Äî Albania Lek';
  document.getElementById('setCurr').value = currencyOption;
  document.getElementById('balCurrSelect').value = c;
  updateBalInput(); 
  refreshHeader();
}
function updateBalInput() {
    const selectedCurr = document.getElementById('balCurrSelect').value;
    const balance = profile.balances?.[selectedCurr] ?? 0;
    document.getElementById('balInput').value = balance;
    document.getElementById('mCurr').value = profile.default_currency || 'ALL';
}
async function savePrefs(){
  const sel=document.getElementById('setCurr').value.split(' ‚Äî ')[0];
  const fmt=document.getElementById('setFmt').value;
  
  // Kontrol: Sadece desteklenen d√∂vizleri kullan
  if (!SUPPORTED.includes(sel)) {
      document.getElementById('prefsMsg').textContent = 'Gabim: Monedha e zgjedhur nuk mb√´shtetet.'; return;
  }

  const {data,error}=await supabase.from('profiles').update({default_currency:sel,num_format:fmt}).eq('user_id',sessionUser.id).select().single();
  document.getElementById('prefsMsg').textContent=error?('Gabim: '+error.message):'U ruajt.';
  if(!error){
    profile=data;
    document.getElementById('balCurrSelect').value = sel;
    updateBalInput();
    viewCurrency = sel; // Default kur deƒüi≈üti, g√∂r√ºnt√ºleme kurunu da ayarla
    renderCurrStrip();
    refreshHeader();
  }
}
async function saveBalance(){
  const val=parseFloat(document.getElementById('balInput').value||'0')||0;
  const curr=document.getElementById('balCurrSelect').value;
  const newBalances={...(profile.balances||{})}; 
  newBalances[curr]=val;
  
  const {data,error}=await supabase.from('profiles').update({balances:newBalances}).eq('user_id',sessionUser.id).select().single();
  document.getElementById('balMsg').textContent=error?('Gabim: '+error.message):'U ruajt.';
  if(!error){
    profile=data;
    // Sadece mevcut g√∂r√ºn√ºm para birimindeki bakiye deƒüi≈ütiyse ba≈ülƒ±ƒüƒ± yenile.
    if(curr === (viewCurrency || profile.default_currency)) refreshHeader();
  }
}

/* ===== Kategorit√´ (Aynƒ± kaldƒ±) ===== */
const DEFAULT_CATS=[
  {name:'Ushqime',emoji:'üçî'},{name:'Transport',emoji:'‚õΩ'},{name:'Sht√´pia',emoji:'üè†'},
  {name:'Arg√´tim',emoji:'üéüÔ∏è'},{name:'Fatura',emoji:'üí°'},{name:'T√´ tjera',emoji:'üßæ'}
];
async function ensureCategoriesSeed(){
  const {data}=await supabase.from('categories').select('id').eq('user_id',sessionUser.id).limit(1);
  if(!data || data.length===0){
    await supabase.from('categories').insert(DEFAULT_CATS.map(c=>({...c,user_id:sessionUser.id})));
  }
}
async function loadCategories(){
  const {data,error}=await supabase.from('categories').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:true});
  if(!error && data){cats=data.map(r=>({name:r.name,emoji:r.emoji,id:r.id}))}
  renderCatList(); refreshCategorySelects(); drawAll();
}
function renderCatList(){
  const box=document.getElementById('catList'); box.innerHTML='';
  cats.forEach(c=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ic'; ic.textContent=c.emoji||'üßæ';
    const meta=document.createElement('div'); meta.className='meta';
    const t=document.createElement('div'); t.className='t'; t.textContent=c.name;
    const s=document.createElement('div'); s.className='s'; s.textContent='Kategori personale';
    meta.append(t,s);
    const del=document.createElement('button'); del.className='del'; del.textContent='üóëÔ∏è';
    del.onclick=()=>deleteCategory(c.id);
    el.append(ic,meta,del); box.appendChild(el);
  });
}
function refreshCategorySelects(){
  const mCat=document.getElementById('mCat'), fCat=document.getElementById('fCat');
  mCat.innerHTML=''; fCat.innerHTML='<option value="">T√´ gjitha</option>';
  cats.forEach(c=>{
    const o=document.createElement('option'); o.value=c.name; o.textContent=(c.emoji||'‚Ä¢')+' '+c.name;
    mCat.appendChild(o.cloneNode(true));
    const o2=document.createElement('option'); o2.value=c.name; o2.textContent=c.name; fCat.appendChild(o2);
  });
}
async function addCategory(){
  const name=(document.getElementById('newCatName').value||'').trim();
  const emoji=(document.getElementById('newCatEmoji').value||'').trim() || 'üßæ';
  const msg=document.getElementById('catMsg'); msg.textContent='';
  if(!name){msg.textContent='Shkruaj emrin e kategoris√´.';return;}
  const {data,error}=await supabase.from('categories').insert({user_id:sessionUser.id,name,emoji}).select().single();
  if(error){msg.textContent='Gabim: '+error.message;return;}
  cats.push({name:data.name,emoji:data.emoji,id:data.id}); document.getElementById('newCatName').value=''; renderCatList(); refreshCategorySelects();
  msg.textContent='U shtua.';
}
async function deleteCategory(id){
  if(!confirm('Fshije k√´t√´ kategori?')) return;
  const {error}=await supabase.from('categories').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){alert('Gabim: '+error.message);return;}
  cats=cats.filter(c=>c.id!==id); renderCatList(); refreshCategorySelects(); drawAll();
}
function emojiFor(catName){
  const hit=cats.find(c=>c.name===catName);
  return (hit?hit.emoji:'üí∏');
}

/* ===== Kurset e K√´mbimit (Rates - D√ºzeltildi) ===== */
async function loadRates(){
  try{
    const cache = JSON.parse(localStorage.getItem('nh_rates_cache')||'{}');
    // 6 saatlik cache s√ºresi
    if(cache.t && (Date.now()-cache.t) < 6*60*60*1000){ rates = cache.rates; refreshHeader(); return; } 
    
    // Base EUR olarak √ßekiyoruz, daha sonra ALL bazƒ±na √ßeviriyoruz
    const url = 'https://api.exchangerate.host/latest?base=EUR&symbols=ALL,USD,TRY'; 
    const res = await fetch(url,{cache:'no-store'}); 
    if (!res.ok) throw new Error("API response not OK");
    const js = await res.json();
    
    // API'dan gelen kurlar (1 EUR = X ALL, Y USD, Z TRY)
    const eurRates = {EUR:1, ALL:js?.rates?.ALL||1, USD:js?.rates?.USD||1, TRY:js?.rates?.TRY||1};
    
    // HER ≈ûEYƒ∞ ALL bazƒ±na √ßevir: (1 ALL = 1/eurRates.ALL EUR)
    // 1 ALL ka√ß ALL -> 1
    // 1 EUR ka√ß ALL -> eurRates.ALL
    // 1 USD ka√ß ALL -> (1/eurRates.USD) EUR * eurRates.ALL
    // 1 TRY ka√ß ALL -> (1/eurRates.TRY) EUR * eurRates.ALL
    
    rates = {
      ALL: 1, 
      EUR: eurRates.ALL, 
      USD: eurRates.ALL / eurRates.USD, 
      TRY: eurRates.ALL / eurRates.TRY
    };
    
    localStorage.setItem('nh_rates_cache', JSON.stringify({t:Date.now(), rates}));
  }catch(e){
    // Hata durumunda default kurlarƒ± kullan (ALL bazƒ±nda)
    rates = {ALL:1, EUR:130, USD:100, TRY:3.5}; // √ñrnek kurlar (1 EUR = 130 ALL, 1 USD = 100 ALL, 1 TRY = 3.5 ALL)
    console.warn("Kurlar y√ºklenemedi. √ñrnek kurlar kullanƒ±lƒ±yor.", e);
  }
  
  // Kurlar y√ºklendikten sonra Strip ve Header'ƒ± yenile
  renderCurrStrip(); 
  refreshHeader();
}

/**
 * Konvertim: T√´ kthesh shum√´n nga nj√´ monedh√´ n√´ tjetr√´n.
 * @param {number} amount Shuma p√´r t'u konvertuar.
 * @param {string} from Monedha burimore (p.sh., 'EUR').
 * @param {string} to Monedha destinacion (p.sh., 'ALL').
 * @returns {number} Shuma e konvertuar.
 */
function fx(amount, from, to){
  const A = Number(amount)||0; 
  from = from?.toUpperCase() || 'ALL'; // null/undefined/bo≈ü ise ALL kabul et
  to = to?.toUpperCase() || 'ALL';
  if(from===to) return A;
  
  // rFrom: 1 FROM ka√ß ALL, rTo: 1 TO ka√ß ALL
  const rFrom = rates[from] ?? rates['ALL']; 
  const rTo   = rates[to]   ?? rates['ALL'];
  
  // (A * rFrom) / rTo
  return (A * rFrom) / rTo;
}

function renderCurrStrip(){
  const box = document.getElementById('currStrip');
  if(!box) return;
  box.innerHTML = '';
  // viewCurrency set edilmemi≈üse default_currency'yi kullan
  const currentView = viewCurrency || (profile?.default_currency || 'ALL'); 

  SUPPORTED.forEach(code=>{
    const b=document.createElement('button');
    b.className='curr-pill'; b.dataset.c=code; b.textContent=code;
    b.onclick=()=>{
      viewCurrency=code;
      box.querySelectorAll('.curr-pill').forEach(x=>x.classList.toggle('active', x.dataset.c===code));
      refreshHeader();
    };
    box.appendChild(b);
    if(code === currentView) b.classList.add('active');
  });
}
function doConvert(){
  const a=parseFloat(document.getElementById('cvAmt').value||'0');
  if(isNaN(a) || a===0){document.getElementById('cvRes').textContent='‚Äî';return;}
  const f=document.getElementById('cvFrom').value, t=document.getElementById('cvTo').value;
  const r=fx(a,f,t); document.getElementById('cvRes').textContent=`${fmt(r)} ${t}`;
}

/* ===== Header/Statistika (Llogaritjet - D√ºzeltildi) ===== */
function refreshHeader(){
  const to = viewCurrency || (profile?.default_currency || 'ALL');
  
  // 1. Shpenzimet e konvertuara
  const totalExpenses = (items||[]).reduce((s,x)=> s + fx(x.amount, x.curr, to), 0);
  const todayExpenses = (items||[]).filter(isToday).reduce((s,x)=> s + fx(x.amount, x.curr, to), 0);
  const monthExpenses = (items||[]).filter(isThisMonth).reduce((s,x)=> s + fx(x.amount, x.curr, to), 0);
  
  // 2. Balanca e monedh√´s aktuale t√´ caktuar nga settings (Default Balance)
  const defaultCurr = profile?.default_currency || 'ALL';
  const balMap = profile?.balances || {}; 
  const defaultBalInView = fx(Number(balMap[defaultCurr]||0), defaultCurr, to);

  // 3. Totali i t√´ gjitha c√ºzdan√´ve (Total Wallets FX - ƒ∞STENEN TOPLAM)
  let totalWalletsFX = 0;
  SUPPORTED.forEach(c => {
      const balance = Number(balMap[c] || 0);
      // Toplam c√ºzdan = Her bir c√ºzdan bakiyesini g√∂r√ºnt√ºleme kuruna √ßevir ve topla
      totalWalletsFX += fx(balance, c, to); 
  });
  
  // 4. Llogaritja e borxheve (vet√´m ato t√´ hapura)
  const debtCurr = profile?.default_currency || 'ALL'; // Bor√ßlar varsayƒ±lan kurda tutulur varsayƒ±mƒ±
  const totalDebts = (debts||[]).filter(x=>x.status==='open').reduce((sum,x)=>{
    const amountInView = fx(x.amount, debtCurr, to); 
    return sum + (x.kind==='borrow'? amountInView : -amountInView);
  }, 0);

  let totalForHeader, headerText, headerSub;

  if (activeTab === 'debts') {
      totalForHeader = totalDebts; 
      headerText = 'Borxhet';
      headerSub  = `Detyrimet & M√´ detyrohen (${to})`;
  } else {
      // P√´r Kreu/Lista: Trego balanc√´n e monedh√´s parazgjedhur - total shpenzime
      totalForHeader = defaultBalInView - totalExpenses; 
      headerText = 'Bilanci';
      headerSub  = `Gjendja e ${defaultCurr} - Shpenzimet (${to})`;
  }

  // Vendosja e vlerave
  setText('hdrTotal', `${fmt(totalForHeader)} ${to}`);
  setText('hdrTotalFX', `${fmt(totalWalletsFX)} ${to}`); // C√ºzdanlarƒ±n toplamƒ±
  setText('stat1', `${fmt(totalExpenses)} ${to}`); 
  setText('stat2', `${fmt(todayExpenses)} ${to}`); 
  setText('stat3', `${fmt(monthExpenses)} ${to}`);
  document.getElementById('hdrIcon').textContent = (activeTab==='debts')?'üí≥':'üí∞';
  document.getElementById('hdrText').textContent = headerText;
  document.getElementById('hdrSub').textContent  = headerSub;
}

/* ===== Shpenzimet (Expenses - D√ºzeltildi) ===== */
async function loadExpenses(){
  try{
    const {data,error}=await supabase.from('expenses').select('*').eq('user_id',sessionUser.id).order('d',{ascending:false}).limit(2000);
    if(error) throw error;
    // Data.curr alanƒ±nƒ±n NULL gelmesi ihtimaline kar≈üƒ± ALL atamasƒ± yapƒ±lƒ±yor.
    items=data.map(x => ({...x, curr: x.curr || 'ALL'})) || []; 
    drawHome(); drawAll(); refreshHeader();
  }catch(e){
    console.error('Gabim ngarkimi (shpenzime):', e);
    // Hata mesajƒ± g√∂sterme veya loglama
  }
}
async function saveExpense(){
  const name=document.getElementById('mName').value.trim();
  const amt=parseFloat(document.getElementById('mAmt').value);
  const cat=document.getElementById('mCat').value;
  const d=document.getElementById('mDate').value;
  const curr=document.getElementById('mCurr').value.toUpperCase(); 
  
  if(!name||isNaN(amt)||(amt<=0)||!d){alert('Plot√´soni emrin, shum√´n (>0) dhe dat√´n.');return;}
  
  const payload = {user_id:sessionUser.id,name,amount:amt,category:cat,d,curr};
  const {data,error}=await supabase.from('expenses').insert(payload).select().single();
  
  if(error){alert('Gabim: '+error.message);return;}
  
  items.unshift({...data, curr: data.curr || 'ALL'}); // Yeni harcamayƒ± eklerken curr alanƒ±nƒ± kontrol et
  document.getElementById('mName').value='';document.getElementById('mAmt').value='';
  closeModal('Exp');drawHome();drawAll();refreshHeader();
}
async function delExpense(id){
  if(!confirm('Fshini k√´t√´ shpenzim?'))return;
  const {error}=await supabase.from('expenses').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){alert('Gabim: '+error.message);return;}
  items=items.filter(x=>x.id!==id);drawHome();drawAll();refreshHeader();
}
function drawHome(){
  const recent=[...items].sort((a,b)=>b.d.localeCompare(a.d)).slice(0,12);
  const list=document.getElementById('recentList'); list.innerHTML='';
  document.getElementById('emptyHome').style.display=recent.length?'none':'block';
  recent.forEach(x=>list.appendChild(rowExpense(x)));
}
function drawAll(){
  const q=(document.getElementById('q').value||'').trim().toLowerCase();
  const cat=document.getElementById('fCat').value;
  let arr=[...items].sort((a,b)=>b.d.localeCompare(a.d));
  if(q)arr=arr.filter(x=>x.name.toLowerCase().includes(q)||(x.category||'').toLowerCase().includes(q));
  if(cat)arr=arr.filter(x=>x.category===cat);
  const box=document.getElementById('allList'); box.innerHTML=''; arr.forEach(x=>box.appendChild(rowExpense(x)));
}
function rowExpense(x){
  const el=document.createElement('div');el.className='item';
  const ic=document.createElement('div');ic.className='ic';ic.textContent=emojiFor(x.category);
  const meta=document.createElement('div');meta.className='meta';
  const t=document.createElement('div');t.className='t';t.textContent=x.name;
  // Harcamanƒ±n orijinal d√∂viz birimi g√∂steriliyor (ƒ∞stenen √∂zellik)
  const currency = x.curr || 'ALL'; 
  const s=document.createElement('div');s.className='s';s.textContent=[x.category, fmtDate(x.d)].filter(Boolean).join(' ‚Ä¢ ');
  meta.append(t,s);
  const amt=document.createElement('div');amt.className='amt';
  amt.textContent=`${fmt(x.amount)} ${currency}`;
  const del=document.createElement('button');del.className='del';del.textContent='üóëÔ∏è';del.onclick=()=>delExpense(x.id);
  el.append(ic,meta,amt,del); return el;
}

/* ===== Borxhet (Debts - Aynƒ± kaldƒ±) ===== */
async function loadDebts(){
  try{
    const {data,error}=await supabase.from('debts').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:false}).limit(2000);
    if(error) throw error;
    debts=data||[]; drawDebts(); refreshHeader();
  }catch(e){
    console.error('Gabim ngarkimi (borxhe):', e);
  }
}
async function saveDebt(){
  const party=document.getElementById('dParty').value.trim();
  const name=(document.getElementById('dName').value||'').trim();
  const amt=parseFloat(document.getElementById('dAmt').value);
  const kind=segValue('segType');
  const due=document.getElementById('dDate').value||null;
  if(!party||isNaN(amt)||(amt<=0)){alert('Shkruaj Pal√´n (Emri) dhe shum√´n (>0).');return;}
  
  const payload={user_id:sessionUser.id,party,name,amount:amt,kind,due,status:'open'}; 
  const {data,error}=await supabase.from('debts').insert(payload).select().single();
  
  if(error){alert('Gabim: '+error.message);return;}
  
  debts.unshift(data);
  document.getElementById('dParty').value='';document.getElementById('dName').value='';document.getElementById('dAmt').value='';resetSeg('segType','borrow');
  closeModal('Debt');drawDebts();refreshHeader();
}
async function delDebt(id){
  if(!confirm('Fshini k√´t√´ borxh?'))return;
  const {error}=await supabase.from('debts').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){alert('Gabim: '+error.message);return;}
  debts=debts.filter(x=>x.id!==id);drawDebts();refreshHeader();
}
async function payDebt(id){
  if(!confirm('Borxhi u pagua. Je i sigurt?')) return;
  const {data,error}=await supabase.from('debts').update({status:'paid'}).eq('id',id).eq('user_id',sessionUser.id).select().single();
  if(error){alert('Gabim: '+error.message);return;}
  debts=debts.map(x=>x.id===id?data:x);drawDebts();refreshHeader();
}
function drawDebts(){
  const q=(document.getElementById('dq').value||'').trim().toLowerCase();
  const kindFilter=segValue('dSegFilter');
  let arr=[...debts].sort((a,b)=>b.created_at.localeCompare(a.created_at));

  if(q)arr=arr.filter(x=>(x.party||'').toLowerCase().includes(q)||(x.name||'').toLowerCase().includes(q));
  if(kindFilter)arr=arr.filter(x=>x.kind===kindFilter);

  const box=document.getElementById('debtList'); box.innerHTML='';
  document.getElementById('emptyDebts').style.display=arr.length?'none':'block';

  arr.forEach(x=>{
    const el=document.createElement('div'); el.className='item';
    const isPaid = x.status==='paid';
    const ic=document.createElement('div'); ic.className='ic'; ic.textContent=isPaid?'‚úÖ':'üí≥';
    const meta=document.createElement('div'); meta.className='meta';
    const t=document.createElement('div'); t.className='t'; t.textContent=x.party || '(pa em√´r)';
    const kindText = x.kind==='borrow'?'Mora hua':'Dhash hua';
    const bits=[kindText]; if(x.name) bits.push(x.name); if(x.due) bits.push('Afati: '+fmtDate(x.due));
    const s=document.createElement('div'); s.className='s'; s.textContent=bits.join(' ‚Ä¢ ');
    meta.append(t,s);

    const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
    const amt=document.createElement('div'); amt.className='amt'; 
    const defaultCurr = profile?.default_currency || 'ALL';
    amt.textContent=`${fmt(x.amount)} ${defaultCurr}`;

    right.appendChild(amt);

    if(!isPaid){
      const pay=document.createElement('button'); pay.className='btnMini'; pay.textContent=(x.kind==='borrow')?'Paguaj':'U kthye';
      pay.onclick=()=>payDebt(x.id); right.appendChild(pay);
    }else{
      const badge=document.createElement('span'); badge.className='chip'; badge.textContent='Paguar'; right.appendChild(badge);
    }

    const del=document.createElement('button'); del.className='del'; del.textContent='üóëÔ∏è'; del.onclick=()=>delDebt(x.id);
    el.append(ic,meta,right,del); box.appendChild(el);
  });
}

/* ===== Helpers (Funksione t√´ p√´rgjithshme) ===== */
function toggleSeg(id,btn){const p=document.getElementById(id);p.querySelectorAll('button').forEach(x=>x.classList.remove('active'));btn.classList.add('active')}
function segValue(id){return document.querySelector('#'+id+' .active')?.dataset.val||''}
function resetSeg(id,val){const p=document.getElementById(id);p.querySelectorAll('button').forEach(x=>x.classList.toggle('active',x.dataset.val===val))}
function openModal(w){document.getElementById('modal'+w).classList.add('on')}
function closeModal(w){document.getElementById('modal'+w).classList.remove('on')}
function setText(id,v){const e=document.getElementById(id);if(e)e.textContent=v}
function isToday(x){
  if(!x.d) return false;
  const d=new Date(x.d+'T00:00:00'),t=new Date(); // Tarih formatƒ± d√ºzeltildi
  return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()&&d.getDate()==t.getDate();
}
function isThisMonth(x){
  if(!x.d) return false;
  const d=new Date(x.d+'T00:00:00'),t=new Date(); // Tarih formatƒ± d√ºzeltildi
  return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth();
}
function fmtDate(iso){
  const d=new Date((iso||'')+'T00:00:00');
  return isNaN(d.getTime())?'':d.toLocaleDateString('sq-AL',{day:'2-digit',month:'short',year:'numeric'});
}
function fmt(n){
  const f=profile?.num_format||'eu';
  const v=(Math.round((Number(n)||0)*100)/100);
  return f==='us' ? v.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})
                  : v.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
}

/* ===== Cache / Reset (Aynƒ± kaldƒ±) ===== */
async function clearAppCache(){
  try{
    localStorage.removeItem('nh_rates_cache');
    if (indexedDB && indexedDB.databases) {
      const dbs = await indexedDB.databases();
      await Promise.all((dbs||[]).map(d=> new Promise(res=>{
        try{ const req = indexedDB.deleteDatabase(d.name); req.onsuccess=req.onerror=req.onblocked=()=>res(); }
        catch{ res(); }
      })));
    }
    await supabase.auth.signOut();
    document.getElementById('cacheMsg').textContent='Cache u pastrua. Aplikacioni u rifreskua.';
    setTimeout(()=>location.reload(),600);
  }catch(e){
    document.getElementById('cacheMsg').textContent='Problem gjat√´ pastrimit: '+(e?.message||e);
  }
}
</script>
</body>
</html>
