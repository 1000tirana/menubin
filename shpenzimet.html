<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Normal Holding ‚Ä¢ Portofoli</title>
<meta name="theme-color" content="#0d1117">
<style>
:root{
  --bg:#0d1117; --card:#161b22; --border:#30363d;
  --text:#c9d1d9; --muted:#8b949e; --ok:#2ea043; --ok2:#238636;
  --chip:#21262d; --blue:#1f6feb; --danger:#f85149;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --safe-top:env(safe-area-inset-top,0px); --safe-bottom:env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box} html,body{height:100%;background:var(--bg);overflow-x:hidden}
body{margin:0;color:var(--text);font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}

.wrap{display:flex;flex-direction:column;min-height:100vh;padding-bottom:calc(100px + var(--safe-bottom))}
header{background:linear-gradient(135deg,var(--ok2) 0%, var(--ok) 100%);color:#fff;
  border-bottom-left-radius:22px;border-bottom-right-radius:22px;
  padding:calc(10px + var(--safe-top)) 16px 12px; box-shadow:0 10px 28px rgba(35,134,54,.35)}
header .top{display:flex;justify-content:space-between;align-items:center}
header .big{font-size:36px;font-weight:900;margin-top:8px}
header .sub{opacity:.85}
.row{display:flex;gap:10px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:12px}
.stats{display:flex;gap:10px;padding:10px 12px;transform:translateY(-12px)}
.stat{flex:1} .muted{color:var(--muted)}
main{padding:0 12px 18px}
h3{margin:10px 0}

.list{display:flex;flex-direction:column;gap:10px}
.item{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px}
.ic{width:52px;height:52px;border-radius:50%;display:grid;place-items:center;font-size:26px;
  background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
  color:#0d1117;border:1px solid rgba(255,255,255,.06);box-shadow:inset 0 1px 4px rgba(0,0,0,.6),0 6px 14px rgba(0,0,0,.4)}
.meta{flex:1} .meta .t{font-weight:800;color:#e6edf3} .meta .s{font-size:12px;color:var(--muted)}
.amt{font-weight:900}
.del{border:none;background:transparent;color:var(--danger);font-size:20px;cursor:pointer}

.btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:var(--chip);color:#e6edf3;font-weight:800;cursor:pointer}
.btnP{background:linear-gradient(180deg,var(--ok) 0%, var(--ok2) 100%);border-color:#2ea043;color:#fff}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text);font-size:16px}

.chips{display:flex;gap:8px;margin:8px 0}
.chips button{border:1px solid var(--border);background:var(--chip);color:#e6edf3;border-radius:999px;padding:8px 14px;font-weight:900;cursor:pointer}
.chips button.active{background:#1f6feb}

nav.nav{
  --fab-gap: 110px;
  position:fixed;left:0;right:0;bottom:0;height:calc(80px + var(--safe-bottom));
  padding:0 12px var(--safe-bottom);background:var(--card);border-top:1px solid var(--border);
  box-shadow:0 -10px 30px rgba(0,0,0,.35);display:grid;grid-template-columns:1fr 1fr var(--fab-gap) 1fr 1fr;align-items:center;z-index:2000
}
.nav .btnTab{justify-self:center;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);text-decoration:none}
.nav .btnTab.active{color:#79c0ff}
.nav .ico{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);color:#0d1117;border:1px solid rgba(255,255,255,.06)}
.fab{position:absolute;left:50%;transform:translateX(-50%);top:-26px;width:64px;height:64px;border-radius:50%;
  background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);border:1px solid rgba(255,255,255,.06);display:grid;place-items:center;font-size:32px;box-shadow:0 14px 26px rgba(0,0,0,.5)}

.tab{display:none}.tab.active{display:block}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:end;padding:14px;z-index:3000}
.modal.on{display:grid}
.sheet{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px 14px 18px;width:100%}
@media(min-width:720px){.wrap{max-width:520px;margin:0 auto}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="top"><div style="font-weight:900">Normal Holding</div><div id="who" class="sub">@user</div></div>
    <div style="font-size:22px;font-weight:900">üíº Portofoli</div>
    <div class="big"><span id="hdrTotal">0</span> <span id="hdrCurr">ALL</span></div>
    <div id="rateLine" class="sub">‚Äî</div>
    <div class="chips">
      <button class="chip" data-curr="ALL">ALL</button>
      <button class="chip" data-curr="EUR">EUR</button>
      <button class="chip" data-curr="USD">USD</button>
      <button class="chip" data-curr="TRY">TRY</button>
    </div>
  </header>

  <div class="stats">
    <div class="card stat"><div class="muted">Shpenzime totale</div><div style="font-weight:900;font-size:18px" id="kpiTotal">0</div></div>
    <div class="card stat"><div class="muted">Sot</div><div style="font-weight:900;font-size:18px" id="kpiToday">0</div></div>
    <div class="card stat"><div class="muted">K√´t√´ muaj</div><div style="font-weight:900;font-size:18px" id="kpiMonth">0</div></div>
  </div>

  <main>
    <section id="tab-home" class="tab active">
      <h3>üïí T√´ fundit</h3>
      <div id="recentList" class="list"></div>
      <div class="muted" id="emptyHome" style="text-align:center;margin-top:10px">Asgj√´ ende.</div>
    </section>

    <section id="tab-settings" class="tab">
      <h3>‚öôÔ∏è Cil√´sime</h3>
      <div class="card">
        <div class="row">
          <div style="flex:1">
            <label>Gjuha</label>
            <select id="prefLang">
              <option value="sq">Shqip</option><option value="tr">T√ºrk√ße</option><option value="en">English</option><option value="it">Italiano</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Monedha default</label>
            <select id="prefCurr">
              <option>ALL</option><option>EUR</option><option>USD</option><option>TRY</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Formati i numrave</label>
            <select id="prefFmt"><option value="eu">23.456,78</option><option value="us">23,456.78</option></select>
          </div>
        </div>
        <div class="row" style="margin-top:10px"><button class="btn btnP" id="savePrefs">Ruaj</button></div>
        <div id="prefMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <label>Gjendja e kulet√´s (ALL/EUR/USD/TRY sipas zgjedhjes posht√´)</label>
        <div class="row" style="margin-top:6px">
          <select id="balCurr"><option>ALL</option><option>EUR</option><option>USD</option><option>TRY</option></select>
          <input id="balAmt" type="number" inputmode="decimal" placeholder="p.sh. 5000">
        </div>
        <div class="row" style="margin-top:8px"><button class="btn btnP" id="saveBalance">Ruaj gjendjen</button></div>
        <div id="balMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>
    </section>
  </main>
</div>

<nav class="nav">
  <a class="btnTab active" data-go="home"><span class="ico">üè†</span><span>Kreu</span></a>
  <a class="btnTab" data-go="settings"><span class="ico">‚öôÔ∏è</span><span>Cil√´sime</span></a>
  <button class="fab" id="openAdd">Ôºã</button>
  <a class="btnTab" data-go="debts" id="goDebts"><span class="ico">üí≥</span><span>Borxhet</span></a>
  <a class="btnTab" data-go="list"><span class="ico">üìã</span><span>Lista</span></a>
</nav>

<!-- Modal: Shpenzim (kƒ±sa) -->
<div class="modal" id="mExp"><div class="sheet">
  <h3>‚ûï Shto shpenzim</h3>
  <div class="row"><input id="eName" placeholder="p.sh. Karburant"><input id="eAmt" type="number" inputmode="decimal" placeholder="0"></div>
  <div class="row" style="margin-top:8px">
    <select id="eCurr"><option>ALL</option><option>EUR</option><option>USD</option><option>TRY</option></select>
    <input id="eDate" type="date">
  </div>
  <div class="row" style="margin-top:8px"><button class="btn" onclick="closeM('mExp')">Mbyll</button><button class="btn btnP" id="btnSaveExp">Ruaj</button></div>
</div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*** 0) Supabase ***/
const SUPABASE_URL='https://nvpjqvggaiipwziolend.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cGpxdmdnYWlpcHd6aW9sZW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4OTExNzcsImV4cCI6MjA3NDQ2NzE3N30.PnJh09kx-kK8iChgQl2M1eTw5P2qRZUEO31wVY7_iP4';
const db = window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/*** 1) Durum ***/
let me=null, profile={default_currency:'ALL', num_format:'eu', lang:'sq', balances:{}};
let items=[]; // expenses
let viewCurr=null; // ALL/EUR/USD/TRY ‚Äì √ºstteki √ßiplerle ge√ßici g√∂r√ºn√ºm
let rates={ALL:1, EUR:1, USD:1, TRY:1}; // ALL bazlƒ± oranlar (ALL=1)

/*** 2) Yardƒ±mcƒ±lar ***/
const $=s=>document.querySelector(s);
const set=(id,v)=>{const e=document.getElementById(id); if(e) e.textContent=v}
const fmt=(n, curr)=> {
  const nf = profile.num_format==='us' ? 'en-US' : 'de-DE';
  return Number(n||0).toLocaleString(nf,{minimumFractionDigits:2,maximumFractionDigits:2}) + (curr?(' '+curr):'');
}
const isToday = iso => { const d=new Date(iso), t=new Date(); return d.getFullYear()==t.getFullYear() && d.getMonth()==t.getMonth() && d.getDate()==t.getDate() }
const isThisMonth = iso => { const d=new Date(iso), t=new Date(); return d.getFullYear()==t.getFullYear() && d.getMonth()==t.getMonth() }

/*** 3) Kur ‚Äì frankfurter.app (√ºcretsiz, anahtarsƒ±z). ALL bazlƒ± √ßekeriz. ***/
async function loadRates(){
  // Cache (1 saat)
  const cache=JSON.parse(localStorage.getItem('rates_cache')||'{}');
  if(cache.t && (Date.now()-cache.t)<3600*1000){ rates=cache.r; drawHeader(); return }
  // ALL -> EUR,USD,TRY oranlarƒ±nƒ± √ßek
  // Frankfurter baz para birimini desteklemiyorsa zincirleme hesaplarƒ±z:
  // EUR tabanƒ±nƒ± √ßek -> ALL, USD, TRY oranlarƒ±; sonra ALL bazƒ±na √ßeviririz.
  const res = await fetch('https://api.frankfurter.app/latest?from=EUR&to=ALL,USD,TRY').then(r=>r.json()).catch(()=>null);
  if(res && res.rates){
    // EUR->ALL = x, EUR->USD = y, EUR->TRY = z
    // ALL bazƒ±na √ßevirmek i√ßin: 1 ALL = 1/(EUR->ALL) EUR; 1 ALL = (USD/EUR) / (ALL/EUR) USD vb.
    const eur_all = res.rates.ALL;              // 1 EUR = eur_all ALL
    const eur_usd = res.rates.USD;              // 1 EUR = eur_usd USD
    const eur_try = res.rates.TRY;              // 1 EUR = eur_try TRY
    rates.ALL = 1;
    rates.EUR = 1/eur_all;                      // 1 ALL = ? EUR
    rates.USD = (eur_usd/eur_all);              // 1 ALL = ? USD
    rates.TRY = (eur_try/eur_all);              // 1 ALL = ? TRY
    localStorage.setItem('rates_cache', JSON.stringify({t:Date.now(), r:rates}));
  }
  drawHeader();
}

/*** 4) Auth & y√ºklemeler ***/
document.addEventListener('DOMContentLoaded', async ()=>{
  const {data:{session}} = await db.auth.getSession();
  if(!session){ await db.auth.signInWithPassword({email:'demo@demo.com', password:'demodemo'}).catch(()=>{}); }
  const s2 = (await db.auth.getSession()).data.session;
  me = s2?.user || null;
  $('#who').textContent = me?.email?.split('@')[0] || '@user';

  await ensureProfile();
  await Promise.all([loadExpenses(), loadRates()]);
  bindUI();
});

async function ensureProfile(){
  let {data, error} = await db.from('profiles').select('*').eq('user_id', me.id).single();
  if(!data){
    const ins = await db.from('profiles').insert({user_id:me.id}).select().single();
    data = ins.data;
  }
  if(data) profile=data;
  // UI
  $('#prefCurr').value = profile.default_currency||'ALL';
  $('#prefFmt').value  = profile.num_format||'eu';
  $('#prefLang').value = profile.lang||'sq';
  $('#balCurr').value  = 'ALL';
}

async function loadExpenses(){
  const q = await db.from('expenses').select('*').eq('user_id', me.id).order('d',{ascending:false}).limit(500);
  items = q.data||[];
  drawHome();
}

/*** 5) Hesaplamalar ***/
function convertFromALL(vALL, to){ return vALL * (rates[to]||1) }
function convert(v, from, to){
  if(from===to) return v;
  // √∂nce ALL'e, sonra hedefe
  const all = v / (rates[from]||1);
  return all * (rates[to]||1);
}

function totalsIn(curr){
  // harcamalar (yalnƒ±z expenses) ‚Äì se√ßili curr'de
  const total = items.reduce((s,x)=> s + convert(Number(x.amount||0), x.curr||'ALL', curr), 0);
  const today = items.filter(x=>isToday(x.d)).reduce((s,x)=> s + convert(Number(x.amount||0), x.curr||'ALL', curr), 0);
  const month = items.filter(x=>isThisMonth(x.d)).reduce((s,x)=> s + convert(Number(x.amount||0), x.curr||'ALL', curr), 0);
  return {total, today, month};
}

function portfolioIn(curr){
  // kullanƒ±cƒ± c√ºzdan bakiyeleri (profile.balances) {"ALL":5000,"EUR":120,...}
  const b = profile.balances||{};
  const sumALL =
    (Number(b.ALL||0))
    + convert(Number(b.EUR||0),'EUR','ALL')
    + convert(Number(b.USD||0),'USD','ALL')
    + convert(Number(b.TRY||0),'TRY','ALL');
  return convertFromALL(sumALL, curr);
}

/*** 6) √áizimler ***/
function drawHeader(){
  const curr = viewCurr || (profile.default_currency||'ALL');
  const k = totalsIn(curr);
  set('hdrCurr', curr);
  set('hdrTotal', fmt(portfolioIn(curr) - k.total, null));    // Portf√∂y - harcama
  set('kpiTotal', fmt(k.total, curr));
  set('kpiToday', fmt(k.today, curr));
  set('kpiMonth', fmt(k.month, curr));

  // 1 ALL = ? EUR / USD / TRY satƒ±rƒ±
  const line = `1 ALL = ${fmt(rates.EUR, 'EUR')} ‚Ä¢ 1 ALL = ${fmt(rates.USD,'USD')} ‚Ä¢ 1 ALL = ${fmt(rates.TRY,'TRY')}`;
  $('#rateLine').textContent = line;

  // chips aktiflik
  document.querySelectorAll('.chips .chip, .chips button').forEach(b=>{
    const c=b.dataset.curr; b.classList.toggle('active', c===curr);
  });
}

function drawHome(){
  const list=$('#recentList'); list.innerHTML='';
  const recent=[...items].slice(0,8);
  $('#emptyHome').style.display= recent.length?'none':'block';
  const curr = viewCurr || (profile.default_currency||'ALL');
  recent.forEach(x=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ic'; ic.textContent='üçî';
    const meta=document.createElement('div'); meta.className='meta';
    const t=document.createElement('div'); t.className='t'; t.textContent=x.name;
    const s=document.createElement('div'); s.className='s'; s.textContent=new Date(x.d).toLocaleDateString();
    meta.append(t,s);
    const amt=document.createElement('div'); amt.className='amt';
    amt.textContent = fmt(convert(Number(x.amount||0), x.curr||'ALL', curr), curr);
    const del=document.createElement('button'); del.className='del'; del.textContent='üóëÔ∏è';
    del.onclick=()=>delExpense(x.id);
    el.append(ic,meta,amt,del); list.append(el);
  });
  drawHeader();
}

/*** 7) UI ***/
function bindUI(){
  // chips
  document.querySelectorAll('.chips button,.chips .chip').forEach(b=>{
    b.onclick=()=>{ viewCurr=b.dataset.curr; drawHome(); }
  });

  // alt men√º
  document.querySelectorAll('.btnTab').forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll('.btnTab').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const go=b.dataset.go;
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.getElementById('tab-'+go)?.classList.add('active');
    }
  });

  // fab
  ['click','touchend','pointerup'].forEach(ev=>$('#openAdd').addEventListener(ev,()=>openM('mExp'),{passive:true}));

  // modal kaydet
  $('#btnSaveExp').onclick=saveExpense;

  // ayarlar
  $('#savePrefs').onclick=savePrefs;
  $('#saveBalance').onclick=saveBalance;

  // tarih inputlarƒ±
  $('#eDate').value=new Date().toISOString().slice(0,10);
}

function openM(id){ document.getElementById(id).classList.add('on') }
function closeM(id){ document.getElementById(id).classList.remove('on') }

/*** 8) CRUD ***/
async function saveExpense(){
  const name=$('#eName').value.trim();
  const amt=parseFloat($('#eAmt').value);
  const curr=$('#eCurr').value;
  const d=$('#eDate').value;
  if(!name||!amt||!d||isNaN(amt)){ alert('Plot√´so fushat.'); return }
  const {data,error}=await db.from('expenses').insert({user_id:me.id,name,amount:amt,curr,d}).select().single();
  if(error){ alert('Gabim: '+error.message); return }
  items.unshift(data);
  $('#eName').value=''; $('#eAmt').value='';
  closeM('mExp'); drawHome();
}

async function delExpense(id){
  if(!confirm('Fshini k√´t√´ hyrje?')) return;
  const {error}=await db.from('expenses').delete().eq('id',id).eq('user_id',me.id);
  if(!error){ items=items.filter(x=>x.id!==id); drawHome(); }
}

async function savePrefs(){
  const payload={
    default_currency: $('#prefCurr').value,
    num_format: $('#prefFmt').value,
    lang: $('#prefLang').value
  };
  const {data,error}=await db.from('profiles').upsert({user_id:me.id, ...payload}).select().single();
  $('#prefMsg').textContent = error ? ('Gabim: '+error.message) : 'U ruajt.';
  if(!error){ profile={...profile,...data}; drawHome(); }
}

async function saveBalance(){
  const c=$('#balCurr').value; const v=parseFloat($('#balAmt').value||'0');
  const newBal={...(profile.balances||{})}; newBal[c]=v;
  const {data,error}=await db.from('profiles').upsert({user_id:me.id, balances:newBal}).select().single();
  $('#balMsg').textContent = error ? ('Gabim: '+error.message) : 'U ruajt.';
  if(!error){ profile.balances=data.balances; drawHome(); }
}
</script>
</body>
</html>
