<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no">
<title>Normal Holding • Kuletat & Shpenzimet</title>
<meta name="theme-color" content="#0d1117">
<style>
/* ===========================================================
   SQL: RUN ONCE  (Supabase SQL editor'ına yapıştır → çalıştır)
==============================================================
create table if not exists public.profiles (
  user_id uuid primary key references auth.users(id) on delete cascade,
  default_currency text not null default 'ALL',
  num_format text not null default 'eu',       -- 'eu' | 'us'
  lang text not null default 'sq',             -- 'sq' | 'tr' | 'en' | 'it'
  balances jsonb not null default '{}'::jsonb, -- {"ALL":0,"EUR":0,"USD":0,"TRY":0}
  created_at timestamptz not null default now()
);

create table if not exists public.categories (
  id bigint generated by default as identity primary key,
  user_id uuid not null references auth.users(id) on delete cascade,
  name text not null,
  emoji text,
  created_at timestamptz not null default now()
);

create table if not exists public.expenses (
  id bigint generated by default as identity primary key,
  user_id uuid not null references auth.users(id) on delete cascade,
  name text not null,
  amount numeric not null,
  category text,
  d date not null default current_date,
  curr text not null default 'ALL',
  created_at timestamptz not null default now()
);

create table if not exists public.debts (
  id bigint generated by default as identity primary key,
  user_id uuid not null references auth.users(id) on delete cascade,
  party text not null,
  name text,
  amount numeric not null,
  kind text not null check (kind in ('borrow','lend')),
  due date,
  curr text not null default 'ALL',
  status text not null default 'open',
  created_at timestamptz not null default now()
);

-- indexes
create index if not exists expenses_user_date_idx on public.expenses(user_id, d desc);
create index if not exists debts_user_created_idx on public.debts(user_id, created_at desc);

-- RLS
alter table public.profiles  enable row level security;
alter table public.categories enable row level security;
alter table public.expenses  enable row level security;
alter table public.debts     enable row level security;

do $$begin
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='profiles' and polname='profiles_own') then
    execute 'create policy "profiles_own" on public.profiles for all using (auth.uid()=user_id) with check (auth.uid()=user_id);';
  end if;
end$$;

do $$begin
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='categories' and polname='categories_own') then
    execute ''||
    'create policy "categories_own" on public.categories for all '||
    'using (auth.uid()=user_id) with check (auth.uid()=user_id);';
  end if;
end$$;

do $$begin
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='expenses' and polname='expenses_own') then
    execute 'create policy "expenses_own" on public.expenses for all using (auth.uid()=user_id) with check (auth.uid()=user_id);';
  end if;
end$$;

do $$begin
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='debts' and polname='debts_own') then
    execute 'create policy "debts_own" on public.debts for all using (auth.uid()=user_id) with check (auth.uid()=user_id);';
  end if;
end$$;

-- backfill (güvenli)
update public.expenses set curr='ALL' where curr is null or curr='';
update public.debts    set curr='ALL' where curr is null or curr='';
=========================================================== */

:root{
  --bg:#0d1117; --card:#161b22; --border:#30363d; --muted:#8b949e; --text:#c9d1d9;
  --primary:#2ea043; --primary2:#238636; --blue:#1f6feb; --danger:#f85149;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --safe-top:env(safe-area-inset-top,0px); --safe-bottom:env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box}
html,body{height:100%;background:var(--bg);color:var(--text);overscroll-behavior:none}
body{margin:0;font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
.wrap{min-height:100vh;display:flex;flex-direction:column;padding-bottom:calc(92px + var(--safe-bottom))}
header{
  background:linear-gradient(135deg,var(--primary2),var(--primary));
  color:#fff;border-bottom-left-radius:22px;border-bottom-right-radius:22px;
  padding:calc(10px + var(--safe-top)) 16px 12px; box-shadow:0 10px 28px rgba(35,134,54,.35)
}
header .top{display:flex;justify-content:space-between;align-items:center}
header .title{font-size:20px;font-weight:900;display:flex;gap:8px;margin-top:6px}
header .big{font-size:32px;font-weight:900;margin-top:8px}
header .muted{opacity:.85}
.pills{display:flex;gap:10px;margin:10px 0 0;flex-wrap:wrap}
.pills button{border:none;background:#21262d;border:1px solid var(--border);padding:8px 14px;border-radius:999px;color:#e6edf3;cursor:pointer;font-weight:800}
.pills button.active{background:linear-gradient(180deg,#1f6feb,#1158c7);color:#fff}
.rateLine{margin-top:8px;font-size:12px;opacity:.9}

.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:10px 12px;transform:translateY(-12px)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
h3.sec{margin:0 12px 8px}
.list{display:flex;flex-direction:column;gap:10px;margin:12px}
.item{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px}
.ic{width:48px;height:48px;border-radius:12px;display:grid;place-items:center;font-size:24px;background:#21262d;border:1px solid var(--border)}
.meta{flex:1}
.meta .t{font-weight:800;color:#e6edf3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta .s{font-size:12px;color:var(--muted)}
.amt{font-weight:900;color:#e6edf3}
.del{border:none;background:transparent;color:var(--danger);font-size:20px;cursor:pointer}

.row{display:flex;gap:10px}
label{font-size:13px;color:var(--muted)}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:16px;background:var(--card);color:var(--text)}
.actions{display:flex;gap:10px;margin-top:10px}
.btnP,.btnS,.btnMini{font-size:16px;cursor:pointer}
.btnP{flex:1;background:linear-gradient(180deg,var(--primary),var(--primary2));color:#fff;border:1px solid #2ea043;padding:12px 16px;border-radius:12px;font-weight:800}
.btnS{flex:1;background:#21262d;color:#e6edf3;border:1px solid var(--border);padding:12px 16px;border-radius:12px;font-weight:800}
.btnMini{background:#21262d;border:1px solid var(--border);padding:8px 10px;border-radius:10px;font-weight:800;color:#e6edf3}

/* Nav */
nav.nav{
  position:fixed;left:0;right:0;bottom:0;height:calc(84px + var(--safe-bottom));
  padding:10px 12px calc(12px + var(--safe-bottom));
  background:var(--card);border-top:1px solid var(--border);box-shadow:0 -10px 30px rgba(0,0,0,.35);
  border-top-left-radius:16px;border-top-right-radius:16px;z-index:1000;
  display:grid;grid-template-columns:1fr 1fr 90px 1fr 1fr;align-items:center
}
.btn{justify-self:center;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);text-decoration:none}
.btn .ico{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;color:#0d1117;
  background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
  box-shadow:inset 0 1px 3px rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.06);font-size:24px}
.btn.active{color:#79c0ff}
.btn.active .ico{background:radial-gradient(circle at 30% 30%, #cfe7ff 0%, #9dd2ff 45%, #1f6feb 100%)}
.fab{
  position:absolute;left:50%;transform:translateX(-50%);top:-26px;width:62px;height:62px;border-radius:50%;
  display:grid;place-items:center;background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
  color:#0d1117;border:1px solid rgba(255,255,255,.06);font-size:30px;box-shadow:0 14px 26px rgba(0,0,0,.5), inset 0 1px 4px rgba(0,0,0,.6)
}

/* Tabs + Modals */
.tab{display:none}.tab.active{display:block}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:end;padding:14px;z-index:1200}
.modal.on{display:grid}
.sheet{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px;width:100%;box-shadow:0 -12px 30px rgba(0,0,0,.5)}

/* Gate */
.gate{position:fixed;inset:0;display:none;place-items:center;background:var(--bg);padding:18px;z-index:1400}
.panel{background:var(--card);border:1px solid var(--border);width:min(520px,92vw);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
.tabs{display:flex;gap:6px;margin-bottom:10px}
.tabs button{flex:1;border:1px solid var(--border);padding:10px;border-radius:10px;background:#21262d;color:#e6edf3;cursor:pointer}
.tabs button.active{background:linear-gradient(180deg,var(--primary),var(--primary2));border-color:#2ea043;color:#fff;font-weight:800}

/* Emoji picker */
.picker-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;max-height:45vh;overflow:auto;margin-top:8px}
.picker-grid button{border:1px solid var(--border);background:#21262d;border-radius:10px;width:44px;height:44px;font-size:22px;cursor:pointer}

@media(min-width:720px){.wrap{max-width:520px;margin:0 auto}}
</style>
</head>
<body>

<!-- ========== AUTH ========== -->
<div id="gate" class="gate">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900;font-size:18px" data-i18n="appTitle">Normal Holding</div>
      <div class="muted">Cloud</div>
    </div>
    <div class="tabs">
      <button id="tabLoginBtn" class="active" onclick="swapAuth('login')" data-i18n="login">Hyrje</button>
      <button id="tabRegBtn" onclick="swapAuth('reg')" data-i18n="register">Regjistrohu</button>
    </div>
    <div id="authLogin">
      <label data-i18n="email">Email</label>
      <input id="loginEmail" autocomplete="username" placeholder="emri@gmail.com">
      <div class="row" style="margin-top:8px">
        <div style="flex:1">
          <label data-i18n="password">Fjalëkalimi</label>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="••••••">
        </div>
      </div>
      <div class="actions"><button class="btnP" onclick="login()" data-i18n="login">Hyr</button></div>
      <div id="authMsg" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="authReg" style="display:none">
      <label data-i18n="email">Email</label>
      <input id="regEmail" autocomplete="username" placeholder="emri@gmail.com">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label data-i18n="password">Fjalëkalimi</label><input id="regPass" type="password" autocomplete="new-password" placeholder="min. 6"></div>
      </div>
      <div class="actions"><button class="btnS" onclick="swapAuth('login')" data-i18n="back">Kthehu</button><button class="btnP" onclick="registerUser()" data-i18n="createAccount">Krijo llogari</button></div>
      <div id="regMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- ========== APP ========== -->
<div class="wrap" id="app" style="display:none">
  <header>
    <div class="top">
      <div style="font-weight:800">Normal Holding</div>
      <div class="muted" id="who">@user</div>
    </div>
    <div class="title"><span>💼</span><span data-i18n="portfolio">Portofoli</span></div>
    <div class="big"><span id="hdrPortfolio">0</span> <span id="hdrCurr">ALL</span></div>
    <div class="muted rateLine" id="rateLine">—</div>

    <!-- Geçici görünüm (pills) -->
    <div class="pills" id="pillRow">
      <button data-cur="ALL" class="active">ALL</button>
      <button data-cur="EUR">EUR</button>
      <button data-cur="USD">USD</button>
      <button data-cur="TRY">TRY</button>
    </div>
  </header>

  <div class="stats">
    <div class="card"><div class="muted" data-i18n="totals">Shpenzime totale</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="statTotal">0</span> <span id="sCur1">ALL</span></div></div>
    <div class="card"><div class="muted" data-i18n="today">Sot</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="statToday">0</span> <span id="sCur2">ALL</span></div></div>
    <div class="card"><div class="muted" data-i18n="month">Këtë muaj</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="statMonth">0</span> <span id="sCur3">ALL</span></div></div>
  </div>

  <main>
    <section id="tab-home" class="tab active">
      <h3 class="sec">🕒 <span data-i18n="recent">Të fundit</span></h3>
      <div id="recentList" class="list"></div>
      <div id="emptyHome" class="muted" style="text-align:center;margin:16px" data-i18n="noExpenses">Asnjë hyrje deri tani.</div>
    </section>

    <section id="tab-list" class="tab">
      <h3 class="sec">📚 <span data-i18n="list">Lista</span></h3>
      <div class="row" style="margin:12px">
        <input id="q" placeholder="Kërko..." oninput="drawAll()">
        <select id="fCat" onchange="drawAll()"><option value="" data-i18n="all">Të gjitha</option></select>
      </div>
      <div id="allList" class="list"></div>
    </section>

    <section id="tab-debts" class="tab">
      <h3 class="sec">💳 <span data-i18n="debts">Borxhet</span></h3>
      <div class="row" style="margin:12px"><input id="dq" placeholder="Kërko borxhe..." oninput="drawDebts()"></div>
      <div class="row" style="margin:0 12px 8px">
        <div class="seg three" id="dSegFilter" style="flex:1">
          <button type="button" class="active" data-val="" data-i18n="all">Të gjitha</button>
          <button type="button" data-val="borrow" data-i18n="borrow">Mora hua</button>
          <button type="button" data-val="lend" data-i18n="lend">Dhash hua</button>
        </div>
      </div>
      <div id="debtList" class="list"></div>
      <div id="emptyDebts" class="muted" style="text-align:center;margin:16px" data-i18n="noDebts">Asnjë borxh.</div>
    </section>

    <section id="tab-settings" class="tab">
      <h3 class="sec">⚙️ <span data-i18n="settings">Cilësime</span></h3>

      <div class="card" style="margin:12px">
        <h4 style="margin:0 0 8px">🌐 <span data-i18n="language">Gjuha e aplikacionit</span></h4>
        <div class="row">
          <select id="prefLang" style="flex:1">
            <option value="sq">Shqip</option>
            <option value="tr">Türkçe</option>
            <option value="en">English</option>
            <option value="it">Italiano</option>
          </select>
          <select id="prefCurrency" style="flex:1">
            <option>ALL</option><option>EUR</option><option>USD</option><option>TRY</option>
          </select>
          <select id="prefFormat" style="flex:1">
            <option value="eu">23.456,78</option>
            <option value="us">23,456.78</option>
          </select>
        </div>
        <div class="actions"><button class="btnP" onclick="savePrefs()" data-i18n="savePrefs">Ruaj</button></div>
        <div id="prefMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="card" style="margin:12px">
        <h4 style="margin:0 0 8px">💼 <span data-i18n="walletBalanceFor">Gjendja e kuletës</span> (<span id="balCurLabel">ALL</span>)</h4>
        <div class="row"><input id="balInput" type="number" inputmode="decimal" placeholder="p.sh. 5000"></div>
        <div class="actions"><button class="btnP" onclick="saveBalance()" data-i18n="save">Ruaj</button></div>
        <div id="balMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="card" style="margin:12px">
        <h4 style="margin:0 0 8px">🏷️ <span data-i18n="categories">Kategoriat</span></h4>
        <div id="catList" class="list" style="margin-top:8px"></div>
        <div style="border-top:1px solid var(--border);margin:12px 0"></div>
        <div class="row">
          <div style="width:130px">
            <label data-i18n="chooseEmoji">Emoji</label>
            <button class="btnS" id="emojiBtn" onclick="openEmojiPicker()"><span id="emojiPreview">🍔</span> <span data-i18n="chooseEmoji">Zgjidh emoji</span></button>
            <input id="newCatEmoji" value="🍔" hidden>
          </div>
          <div style="flex:1">
            <label data-i18n="categoryName">Emri i kategorisë</label>
            <input id="newCatName" placeholder="p.sh. Ushqime">
          </div>
        </div>
        <div class="actions"><button class="btnP" onclick="addCategory()" data-i18n="addCategory">Shto kategori</button></div>
        <div id="catMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="card" style="margin:12px">
        <h4 style="margin:0 0 8px">📧 <span data-i18n="changeEmail">Ndrysho email</span></h4>
        <div class="row"><input id="newEmail" placeholder="user@domain.com"></div>
        <div class="actions"><button class="btnP" onclick="changeEmail()" data-i18n="save">Ruaj</button></div>
        <div id="emailMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="card" style="margin:12px">
        <h4 style="margin:0 0 8px">🔐 <span data-i18n="changePassword">Ndrysho fjalëkalimin</span></h4>
        <div class="row"><input id="newPass" type="password" placeholder="min. 6"><input id="newPass2" type="password" placeholder="Përsërit"></div>
        <div class="actions"><button class="btnP" onclick="changePassword()" data-i18n="save">Ruaj</button></div>
        <div id="passMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>
    </section>
  </main>
</div>

<!-- NAV -->
<nav class="nav" id="navbar" style="display:none">
  <a class="btn active" data-tab="home" onclick="switchTab('home')"><span class="ico">🏠</span><span data-i18n="home">Kreu</span></a>
  <a class="btn" data-tab="list" onclick="switchTab('list')"><span class="ico">📋</span><span data-i18n="list">Lista</span></a>
  <button class="fab" id="openAdd" aria-label="Shto">＋</button>
  <a class="btn" data-tab="debts" onclick="switchTab('debts')"><span class="ico">💳</span><span data-i18n="debts">Borxhet</span></a>
  <a class="btn" data-tab="settings" onclick="switchTab('settings')"><span class="ico">⚙️</span><span data-i18n="settings">Cilësime</span></a>
</nav>

<!-- Modals -->
<div class="modal" id="modalExp"><div class="sheet">
  <h3 style="margin:4px 0 10px">➕ <span data-i18n="addExpense">Shto shpenzim</span></h3>
  <div class="row"><div style="flex:2"><label data-i18n="name">Emri</label><input id="mName" placeholder="p.sh. Karburant"></div><div style="flex:1"><label data-i18n="amount">Shuma</label><input id="mAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label data-i18n="category">Kategoria</label><select id="mCat"></select></div><div style="flex:1"><label data-i18n="date">Data</label><input id="mDate" type="date"></div></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Exp')" data-i18n="close">Mbyll</button><button class="btnP" onclick="saveExpense()" data-i18n="save">Ruaj</button></div>
</div></div>

<div class="modal" id="modalDebt"><div class="sheet">
  <h3 style="margin:4px 0 10px">➕ <span data-i18n="addDebt">Shto borxh</span></h3>
  <div class="row"><div style="flex:1"><label data-i18n="party">Palë</label><input id="dParty" placeholder="p.sh. Arben"></div><div style="flex:1"><label data-i18n="amount">Shuma</label><input id="dAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div></div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label data-i18n="type">Lloji</label><div id="segType" class="seg two"><button type="button" class="active" data-val="borrow" data-i18n="borrow">Mora hua</button><button type="button" data-val="lend" data-i18n="lend">Dhash hua</button></div></div>
    <div style="flex:1"><label data-i18n="due">Afati</label><input id="dDate" type="date"></div>
  </div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label data-i18n="description">Përshkrimi</label><input id="dName" placeholder="opsionale"></div></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Debt')" data-i18n="close">Mbyll</button><button class="btnP" onclick="saveDebt()" data-i18n="save">Ruaj</button></div>
</div></div>

<div class="modal" id="modalEmoji"><div class="sheet">
  <h3 style="margin:4px 0 10px">🙂 <span data-i18n="chooseEmoji">Zgjidh emoji</span></h3>
  <div id="emojiGrid" class="picker-grid"></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Emoji')" data-i18n="close">Mbyll</button></div>
</div></div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*** Supabase config (seninki) ***/
const SUPABASE_URL  = 'https://nvpjqvggaiipwziolend.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cGpxdmdnYWlpcHd6aW9sZW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4OTExNzcsImV4cCI6MjA3NDQ2NzE3N30.PnJh09kx-kK8iChgQl2M1eTw5P2qRZUEO31wVY7_iP4';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/*** Global durum ***/
let sessionUser=null, items=[], debts=[], cats=[], profile={default_currency:'ALL', num_format:'eu', lang:'sq', balances:{}};
let displayCurr='ALL';
let fx = { base:'EUR', rates:{EUR:1, ALL:0, USD:0, TRY:0} };

/*** I18N ***/
const I18N={
  sq:{appTitle:'Normal Holding',login:'Hyrje',register:'Regjistrohu',back:'Kthehu',createAccount:'Krijo llogari',email:'Email',password:'Fjalëkalimi',portfolio:'Portofoli',totals:'Shpenzime totale',today:'Sot',month:'Këtë muaj',recent:'Të fundit',noExpenses:'Asnjë hyrje deri tani.',list:'Lista',all:'Të gjitha',debts:'Borxhet',noDebts:'Asnjë borxh.',settings:'Cilësime',language:'Gjuha e aplikacionit',savePrefs:'Ruaj',walletBalanceFor:'Gjendja e kuletës',categories:'Kategoriat',chooseEmoji:'Zgjidh emoji',addCategory:'Shto kategori',changeEmail:'Ndrysho email',changePassword:'Ndrysho fjalëkalimin',addExpense:'Shto shpenzim',addDebt:'Shto borxh',name:'Emri',amount:'Shuma',category:'Kategoria',date:'Data',close:'Mbyll',save:'Ruaj',party:'Palë',type:'Lloji',borrow:'Mora hua',lend:'Dhash hua',due:'Afati',description:'Përshkrimi',paid:'Paguar',pay:'Paguaj',returned:'U kthye',confirmPay:'Je i sigurt?',delete:'Fshije',home:'Kreu',categoryName:'Emri i kategorisë'},
  tr:{appTitle:'Normal Holding',login:'Giriş',register:'Kayıt ol',back:'Geri',createAccount:'Hesap oluştur',email:'E-posta',password:'Şifre',portfolio:'Portföy',totals:'Toplam harcama',today:'Bugün',month:'Bu ay',recent:'Son işlemler',noExpenses:'Henüz kayıt yok.',list:'Liste',all:'Tümü',debts:'Borçlar',noDebts:'Borç yok.',settings:'Ayarlar',language:'Uygulama dili',savePrefs:'Kaydet',walletBalanceFor:'Cüzdan bakiyesi',categories:'Kategoriler',chooseEmoji:'Emoji seç',addCategory:'Kategori ekle',changeEmail:'E-postayı değiştir',changePassword:'Şifre değiştir',addExpense:'Harcama ekle',addDebt:'Borç ekle',name:'Ad',amount:'Tutar',category:'Kategori',date:'Tarih',close:'Kapat',save:'Kaydet',party:'Taraf',type:'Tür',borrow:'Borç aldım',lend:'Borç verdim',due:'Vade',description:'Açıklama',paid:'Ödendi',pay:'Öde',returned:'Geri aldım',confirmPay:'Emin misin?',delete:'Sil',home:'Ana sayfa',categoryName:'Kategori adı'},
  en:{appTitle:'Normal Holding',login:'Sign in',register:'Sign up',back:'Back',createAccount:'Create account',email:'Email',password:'Password',portfolio:'Portfolio',totals:'Total spend',today:'Today',month:'This month',recent:'Recent',noExpenses:'No entries yet.',list:'List',all:'All',debts:'Debts',noDebts:'No debts.',settings:'Settings',language:'App language',savePrefs:'Save',walletBalanceFor:'Wallet balance',categories:'Categories',chooseEmoji:'Choose emoji',addCategory:'Add category',changeEmail:'Change email',changePassword:'Change password',addExpense:'Add expense',addDebt:'Add debt',name:'Name',amount:'Amount',category:'Category',date:'Date',close:'Close',save:'Save',party:'Party',type:'Type',borrow:'Borrowed',lend:'Lent',due:'Due',description:'Description',paid:'Paid',pay:'Pay',returned:'Returned',confirmPay:'Are you sure?',delete:'Delete',home:'Home',categoryName:'Category name'},
  it:{appTitle:'Normal Holding',login:'Accedi',register:'Registrati',back:'Indietro',createAccount:'Crea account',email:'Email',password:'Password',portfolio:'Portafoglio',totals:'Spesa totale',today:'Oggi',month:'Questo mese',recent:'Recenti',noExpenses:'Nessuna voce.',list:'Lista',all:'Tutti',debts:'Debiti',noDebts:'Nessun debito.',settings:'Impostazioni',language:'Lingua app',savePrefs:'Salva',walletBalanceFor:'Saldo portafoglio',categories:'Categorie',chooseEmoji:'Scegli emoji',addCategory:'Aggiungi categoria',changeEmail:'Cambia email',changePassword:'Cambia password',addExpense:'Aggiungi spesa',addDebt:'Aggiungi debito',name:'Nome',amount:'Importo',category:'Categoria',date:'Data',close:'Chiudi',save:'Salva',party:'Parte',type:'Tipo',borrow:'Ho preso',lend:'Ho dato',due:'Scadenza',description:'Descrizione',paid:'Pagato',pay:'Paga',returned:'Restituito',confirmPay:'Sei sicuro?',delete:'Elimina',home:'Home',categoryName:'Nome categoria'}
};
function t(key){const L=I18N[profile.lang||'sq']||I18N.sq;return L[key]||key;}
function applyI18n(){document.querySelectorAll('[data-i18n]').forEach(el=>{el.textContent=t(el.dataset.i18n);});}

/*** Başlat ***/
document.addEventListener('DOMContentLoaded', async () => {
  // Emoji seçenekleri
  '🍔 🥗 🍕 🍰 ☕ 🍺 🛒 🚌 ⛽ 🚕 🛠️ 🧽 🎁 🎮 🎬 🎟️ 💡 📱 💻 🏠 🐾 ⚽ 🧾 💊 ✈️ 🚗 🪙 💳 🎓 📚 🧥 👟 🍼 🧻 🧴'.split(' ').forEach(e=>{
    const b=document.createElement('button'); b.textContent=e;
    b.onclick=()=>{document.getElementById('newCatEmoji').value=e;document.getElementById('emojiPreview').textContent=e;closeModal('Emoji')};
    document.getElementById('emojiGrid').appendChild(b);
  });

  // Borç türü filtreleri
  document.querySelectorAll('#segType button').forEach(b=>b.onclick=()=>toggleSeg('segType',b));
  document.querySelectorAll('#dSegFilter button').forEach(b=>b.onclick=()=>{toggleSeg('dSegFilter',b);drawDebts()});

  // FAB (tek tık)
  document.getElementById('openAdd').addEventListener('click',()=>{ if(activeTab==='debts') openModal('Debt'); else openModal('Exp'); });

  // Görsel para birimi (ephemeral)
  document.querySelectorAll('#pillRow button').forEach(b=>{
    b.addEventListener('click',()=>{document.querySelectorAll('#pillRow button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); displayCurr=b.dataset.cur; refreshHeader();});
  });

  const today=new Date().toISOString().slice(0,10);
  document.getElementById('mDate').value=today; document.getElementById('dDate').value=today;

  await loadRates(); setInterval(loadRates, 3600*1000); // saatlik

  const {data:{session}} = await supabase.auth.getSession();
  if(session?.user){sessionUser=session.user; showApp(); await afterLoginLoad();}
  else showGate();

  supabase.auth.onAuthStateChange(async (_e,session)=>{
    if(session?.user){sessionUser=session.user; showApp(); await afterLoginLoad();}
    else{sessionUser=null; showGate();}
  });
});

async function afterLoginLoad(){
  await ensureProfile();
  applyI18n();
  await ensureCategoriesSeed();
  await Promise.all([loadCategories(), loadExpenses(), loadDebts()]);
  refreshHeader(); drawHome(); drawAll(); drawDebts();
}

/*** Kur & dönüştürme (Frankfurter, EUR taban) ***/
async function loadRates(){
  try{
    const cache=JSON.parse(localStorage.getItem('fx_cache_v1')||'null');
    const now=Date.now();
    if(cache && (now-cache.ts)<3600*1000){ fx=cache.fx; updateRateLine(); return; }

    const r=await fetch('https://api.frankfurter.app/latest?from=EUR&to=ALL,USD,TRY');
    const j=await r.json();
    fx={ base:'EUR', rates:{EUR:1, ...j.rates} };
    localStorage.setItem('fx_cache_v1', JSON.stringify({ts:now, fx}));
    updateRateLine();
  }catch(e){ console.warn('Kur çekilemedi',e); }
}
function updateRateLine(){
  const cur=(profile.default_currency||'ALL').toUpperCase();
  const map=(from)=>['ALL','EUR','USD','TRY'].filter(c=>c!==from).map(to=>`1 ${from} = ${fmtNum(rate(from,to))} ${to}`).join(' • ');
  document.getElementById('rateLine').textContent = map(cur);
}
function rate(from,to){
  from=from.toUpperCase(); to=to.toUpperCase();
  if(from===to) return 1;
  // EUR tabanlı
  const toEUR = from==='EUR' ? 1 : 1/(fx.rates[from]||1);
  const fromEUR = to==='EUR' ? 1 : (fx.rates[to]||1);
  return toEUR*fromEUR;
}
function convert(amount, from, to){ return amount*rate(from||'ALL', to||'ALL'); }

/*** UI yardımcıları ***/
let activeTab='home';
function switchTab(t){activeTab=t;document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.getElementById('tab-'+t).classList.add('active');document.querySelectorAll('.btn').forEach(x=>x.classList.remove('active'));document.querySelector(`.btn[data-tab="${t}"]`)?.classList.add('active');if(t==='list')drawAll();if(t==='debts')drawDebts();if(t==='settings')updateSettingsUI();}
function showGate(){document.getElementById('gate').style.display='grid';document.getElementById('app').style.display='none';document.getElementById('navbar').style.display='none'}
function showApp(){document.getElementById('gate').style.display='none';document.getElementById('app').style.display='block';document.getElementById('navbar').style.display='grid';document.getElementById('who').textContent=(sessionUser?.email||'').split('@')[0];}
function openModal(w){document.getElementById('modal'+w).classList.add('on')}
function closeModal(w){document.getElementById('modal'+w).classList.remove('on')}
function toggleSeg(id,btn){const p=document.getElementById(id);p.querySelectorAll('button').forEach(x=>x.classList.remove('active'));btn.classList.add('active')}
function segValue(id){return document.querySelector('#'+id+' .active')?.dataset.val||''}
function sum(a){return a.reduce((s,n)=>s+Number(n||0),0)}
function fmtNum(n){return (profile.num_format==='eu' ? (Math.round(n*100)/100).toLocaleString('tr-TR') : (Math.round(n*100)/100).toLocaleString('en-US'))}
function fmtDate(iso){const d=new Date(iso+'T00:00:00');return d.toLocaleDateString(profile.lang||'sq',{day:'2-digit',month:'short',year:'numeric'})}

/*** Profil ***/
async function ensureProfile(){
  try{
    const {data}=await supabase.from('profiles').select('*').eq('user_id',sessionUser.id).single();
    if(data) profile=data; else {
      const {data:ins}=await supabase.from('profiles').insert({user_id:sessionUser.id,default_currency:'ALL',num_format:'eu',lang:'sq',balances:{ALL:0,EUR:0,USD:0,TRY:0}}).select().single();
      profile=ins||profile;
    }
  }catch{}
  if(!profile.balances) profile.balances={ALL:0,EUR:0,USD:0,TRY:0};
  displayCurr=(profile.default_currency||'ALL').toUpperCase();
  document.querySelectorAll('#pillRow button').forEach(b=>b.classList.toggle('active',b.dataset.cur===displayCurr));
}
async function savePrefs(){
  const lang=document.getElementById('prefLang').value;
  const cur=document.getElementById('prefCurrency').value.toUpperCase();
  const fmt=document.getElementById('prefFormat').value;
  const {data,error}=await supabase.from('profiles').upsert({user_id:sessionUser.id,default_currency:cur,num_format:fmt,lang,balances:profile.balances}).select().single();
  document.getElementById('prefMsg').textContent=error?('Gabim: '+error.message):t('save');
  if(!error){profile=data;applyI18n();displayCurr=cur;updateSettingsUI();refreshHeader();updateRateLine();}
}
function updateSettingsUI(){
  document.getElementById('prefLang').value=profile.lang||'sq';
  document.getElementById('prefCurrency').value=(profile.default_currency||'ALL').toUpperCase();
  document.getElementById('prefFormat').value=profile.num_format||'eu';
  const dc=(profile.default_currency||'ALL').toUpperCase();
  document.getElementById('balCurLabel').textContent=dc;
  document.getElementById('balInput').value = Number(profile.balances?.[dc]||0);
}
async function saveBalance(){
  const dc=(profile.default_currency||'ALL').toUpperCase();
  const v=parseFloat(document.getElementById('balInput').value)||0;
  const balances={...profile.balances,[dc]:v};
  const {data,error}=await supabase.from('profiles').upsert({user_id:sessionUser.id,default_currency:dc,num_format:profile.num_format,lang:profile.lang,balances}).select().single();
  document.getElementById('balMsg').textContent=error?('Gabim: '+error.message):t('save');
  if(!error){profile=data;refreshHeader();}
}
async function changeEmail(){const e=(document.getElementById('newEmail').value||'').trim();const m=document.getElementById('emailMsg');m.textContent='';if(!e||!e.includes('@')){m.textContent='Email?';return;}const {error}=await supabase.auth.updateUser({email:e});m.textContent=error?('Gabim: '+error.message):'OK.'}
async function changePassword(){const p1=document.getElementById('newPass').value,p2=document.getElementById('newPass2').value,m=document.getElementById('passMsg');m.textContent='';if(!p1||p1.length<6){m.textContent='≥6';return;}if(p1!==p2){m.textContent='!=';return;}const {error}=await supabase.auth.updateUser({password:p1});m.textContent=error?('Gabim: '+error.message):'OK.';if(!error){document.getElementById('newPass').value='';document.getElementById('newPass2').value='';}}
async function logout(){await supabase.auth.signOut()}

/*** Kategoriler (156 seed) ***/
const CORE_CATS=[
  ['Ushqime','🍔'],['Supermarket','🛒'],['Kafe','☕'],['Restorant','🍕'],['Ëmbëlsira','🍰'],
  ['Transport','⛽'],['Taksi','🚕'],['Biletë','🚌'],['Karburant','⛽'],['Parkim','🅿️'],
  ['Shtëpia','🏠'],['Qira','🏠'],['Energjia','💡'],['Uji','🚰'],['Internet','🌐'],
  ['Telefoni','📱'],['TV','📺'],['Riparim','🛠️'],['Pastrimi','🧽'],
  ['Shëndeti','💊'],['Doktor','🩺'],['Farmaci','💊'],
  ['Veshje','🧥'],['Këpucë','👟'],['Kozmetikë','💄'],
  ['Argëtim','🎮'],['Kinema','🎬'],['Evente','🎟️'],['Abonime','💿'],
  ['Edukimi','📚'],['Kurs','🎓'],['Libra','📖'],
  ['Teknologji','💻'],['Telefon','📱'],['Laptop','💻'],['Aksesore','🔌'],
  ['Udhëtim','✈️'],['Hotel','🏨'],['Makina','🚗'],['Sigurim','🛡️'],
  ['Dhoma fëmijësh','🍼'],['Kafshë','🐾'],['Sport','⚽'],
  ['Të tjera','🧾']
];
// 156’ya tamamlamak için jenerik “Kategori #” ekliyoruz:
while(CORE_CATS.length<156){ CORE_CATS.push([`Kategori ${CORE_CATS.length+1}`,'🧾']); }

async function ensureCategoriesSeed(){
  const {data}=await supabase.from('categories').select('id').eq('user_id',sessionUser.id).limit(1);
  if(!data || !data.length){
    await supabase.from('categories').insert(CORE_CATS.map(([name,emoji])=>({user_id:sessionUser.id,name,emoji})));
  }
}
async function loadCategories(){
  const {data,error}=await supabase.from('categories').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:true});
  if(!error && data){cats=data.map(r=>({name:r.name,emoji:r.emoji,id:r.id}))}
  renderCatList(); refreshCategorySelects();
}
function renderCatList(){
  const box=document.getElementById('catList'); box.innerHTML='';
  cats.slice(0,50).forEach(c=>{ // Ayarlarda hafiflik için ilk 50 göster; hepsi kayıtta kullanılabilir
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ic'; ic.textContent=c.emoji||'🧾';
    const meta=document.createElement('div'); meta.className='meta';
    const t=document.createElement('div'); t.className='t'; t.textContent=c.name;
    const s=document.createElement('div'); s.className='s'; s.textContent='—';
    meta.appendChild(t); meta.appendChild(s);
    const del=document.createElement('button'); del.className='del'; del.textContent='🗑️'; del.onclick=()=>deleteCategory(c.id);
    el.append(ic,meta,del); box.appendChild(el);
  });
}
function refreshCategorySelects(){
  const mCat=document.getElementById('mCat'), fCat=document.getElementById('fCat');
  mCat.innerHTML=''; fCat.innerHTML='<option value="">'+t('all')+'</option>';
  cats.forEach(c=>{
    const o=document.createElement('option'); o.value=c.name; o.textContent=(c.emoji||'•')+' '+c.name;
    mCat.appendChild(o.cloneNode(true));
    const o2=document.createElement('option'); o2.value=c.name; o2.textContent=c.name; fCat.appendChild(o2);
  });
}
async function addCategory(){
  const name=(document.getElementById('newCatName').value||'').trim();
  const emoji=(document.getElementById('newCatEmoji').value||'').trim()||'🧾';
  const msg=document.getElementById('catMsg'); msg.textContent='';
  if(!name){msg.textContent='…';return;}
  const {data,error}=await supabase.from('categories').insert({user_id:sessionUser.id,name,emoji}).select().single();
  if(error){msg.textContent='Gabim: '+error.message;return;}
  cats.push({name:data.name,emoji:data.emoji,id:data.id}); document.getElementById('newCatName').value='';
  renderCatList(); refreshCategorySelects(); msg.textContent='OK';
}
async function deleteCategory(id){
  if(!confirm(t('delete')+'?')) return;
  const {error}=await supabase.from('categories').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){alert('Gabim: '+error.message);return;}
  cats=cats.filter(c=>c.id!==id); renderCatList(); refreshCategorySelects(); drawAll();
}
function emojiFor(cat){const hit=cats.find(c=>c.name===cat);return hit?hit.emoji:'💸'}

/*** Harcamalar (expense → ilgili cüzdandan düş) ***/
async function loadExpenses(){
  const {data,error}=await supabase.from('expenses').select('*').eq('user_id',sessionUser.id).order('d',{ascending:false}).limit(2000);
  if(error){alert('Gabim (shpenzime): '+error.message);return;}
  items=data||[]; drawHome(); drawAll(); refreshHeader();
}
async function saveExpense(){
  const name=document.getElementById('mName').value.trim();
  const amt=parseFloat(document.getElementById('mAmt').value);
  const cat=document.getElementById('mCat').value||null;
  const d=document.getElementById('mDate').value;
  const curr=(profile?.default_currency||'ALL').toUpperCase();
  if(!name||!amt||!d||isNaN(amt)){alert('Emri, shuma, data.');return;}
  const {data,error}=await supabase.from('expenses').insert({user_id:sessionUser.id,name,amount:amt,category:cat,d,curr}).select().single();
  if(error){alert('Gabim: '+error.message);return;}
  items.unshift(data); await applyBalanceDelta(curr, -amt);
  document.getElementById('mName').value=''; document.getElementById('mAmt').value=''; closeModal('Exp');
  drawHome(); drawAll(); refreshHeader();
}
async function delExpense(id){
  if(!confirm(t('delete')+'?'))return;
  const row=items.find(x=>x.id===id);
  const {error}=await supabase.from('expenses').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){alert('Gabim: '+error.message);return;}
  if(row) await applyBalanceDelta((row.curr||'ALL').toUpperCase(), +Number(row.amount||0)); // geri ekle
  items=items.filter(x=>x.id!==id); drawHome(); drawAll(); refreshHeader();
}
function drawHome(){
  const recent=[...items].sort((a,b)=>b.d.localeCompare(a.d)).slice(0,8);
  const list=document.getElementById('recentList'); list.innerHTML='';
  document.getElementById('emptyHome').style.display=recent.length?'none':'block';
  recent.forEach(x=>list.appendChild(rowExpense(x)));
}
function drawAll(){
  const q=(document.getElementById('q').value||'').toLowerCase();
  const cat=document.getElementById('fCat').value;
  let arr=[...items].sort((a,b)=>b.d.localeCompare(a.d));
  if(q) arr=arr.filter(x=>x.name.toLowerCase().includes(q)||(x.category||'').toLowerCase().includes(q));
  if(cat) arr=arr.filter(x=>x.category===cat);
  const box=document.getElementById('allList'); box.innerHTML='';
  arr.forEach(x=>box.appendChild(rowExpense(x)));
}
function rowExpense(x){
  const el=document.createElement('div'); el.className='item';
  const ic=document.createElement('div'); ic.className='ic'; ic.textContent=emojiFor(x.category);
  const meta=document.createElement('div'); meta.className='meta';
  const t=document.createElement('div'); t.className='t'; t.textContent=x.name;
  const s=document.createElement('div'); s.className='s'; s.textContent=[x.category,fmtDate(x.d)].filter(Boolean).join(' • ');
  meta.appendChild(t); meta.appendChild(s);
  const amt=document.createElement('div'); amt.className='amt'; amt.textContent=fmtNum(x.amount)+' '+(x.curr||'ALL');
  const del=document.createElement('button'); del.className='del'; del.textContent='🗑️'; del.onclick=()=>delExpense(x.id);
  el.append(ic,meta,amt,del); return el;
}

/*** Borçlar (kasa etkisiyle) ***/
async function loadDebts(){const {data,error}=await supabase.from('debts').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:false}).limit(2000);if(error){alert('Gabim (borxhe): '+error.message);return;}debts=data||[];drawDebts();refreshHeader();}
async function saveDebt(){
  const party=document.getElementById('dParty').value.trim();
  const name=(document.getElementById('dName').value||'').trim();
  const amt=parseFloat(document.getElementById('dAmt').value);
  const kind=segValue('segType'); const due=document.getElementById('dDate').value||null;
  const curr=(profile?.default_currency||'ALL').toUpperCase();
  if(!party||!amt||isNaN(amt)){alert('Palë + shuma.');return;}
  const payload={user_id:sessionUser.id,party,name,amount:amt,kind,due,status:'open',curr};
  const {data,error}=await supabase.from('debts').insert(payload).select().single();
  if(error){alert('Gabim: '+error.message);return;}
  debts.unshift(data);
  // kasa etkisi: borrow -> para girer (+), lend -> para çıkar (-)
  await applyBalanceDelta(curr, kind==='borrow'? +amt : -amt);
  document.getElementById('dParty').value='';document.getElementById('dName').value='';document.getElementById('dAmt').value='';toggleSeg('segType',document.querySelector('#segType [data-val="borrow"]'));
  closeModal('Debt');drawDebts();refreshHeader();
}
async function delDebt(id){
  if(!confirm(t('delete')+'?'))return;
  const row=debts.find(x=>x.id===id);
  const {error}=await supabase.from('debts').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){alert('Gabim: '+error.message);return;}
  // silerken kasa düzelt: open durumunda silinirse tersini uygula
  if(row && row.status==='open'){
    await applyBalanceDelta((row.curr||'ALL').toUpperCase(), row.kind==='borrow' ? -Number(row.amount||0) : +Number(row.amount||0));
  }
  debts=debts.filter(x=>x.id!==id);drawDebts();refreshHeader();
}
async function payDebt(id){
  if(!confirm(t('confirmPay'))) return;
  const row=debts.find(x=>x.id===id); if(!row) return;
  const {data,error}=await supabase.from('debts').update({status:'paid'}).eq('id',id).eq('user_id',sessionUser.id).select().single();
  if(error){alert('Gabim: '+error.message);return;}
  debts=debts.map(x=>x.id===id?data:x);
  // kasa etkisi: open→paid geçişi; borrow öderken para çıkar (-), lend geri alırken para girer (+)
  await applyBalanceDelta((row.curr||'ALL').toUpperCase(), row.kind==='borrow' ? -Number(row.amount||0) : +Number(row.amount||0));
  drawDebts(); refreshHeader();
}
function drawDebts(){
  const q=(document.getElementById('dq').value||'').toLowerCase();
  const kindFilter=segValue('dSegFilter');
  let arr=[...debts]; if(q)arr=arr.filter(x=>(x.party||'').toLowerCase().includes(q)||(x.name||'').toLowerCase().includes(q));
  if(kindFilter)arr=arr.filter(x=>x.kind===kindFilter);
  const box=document.getElementById('debtList'); box.innerHTML=''; document.getElementById('emptyDebts').style.display=arr.length?'none':'block';
  arr.forEach(x=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ic'; ic.textContent=(x.status==='paid')?'✅':'💳';
    const meta=document.createElement('div'); meta.className='meta';
    const t=document.createElement('div'); t.className='t'; t.textContent=x.party||'(—)';
    const bits=[x.kind==='borrow'?t('borrow'):t('lend')]; if(x.name) bits.push(x.name); if(x.due) bits.push(''+t('due')+': '+fmtDate(x.due));
    const s=document.createElement('div'); s.className='s'; s.textContent=bits.join(' • ');
    meta.appendChild(t); meta.appendChild(s);
    const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
    const amt=document.createElement('div'); amt.className='amt'; amt.textContent=fmtNum(x.amount)+' '+(x.curr||'ALL');
    right.appendChild(amt);
    if(x.status==='open'){const pay=document.createElement('button'); pay.className='btnMini'; pay.textContent=(x.kind==='borrow')?t('pay'):t('returned'); pay.onclick=()=>payDebt(x.id); right.appendChild(pay);}
    const del=document.createElement('button'); del.className='del'; del.textContent='🗑️'; del.onclick=()=>delDebt(x.id);
    el.append(ic,meta,right,del); box.appendChild(el);
  });
}

/*** Portföy & istatistik header ***/
function refreshHeader(){
  const cur=displayCurr.toUpperCase();
  ['sCur1','sCur2','sCur3','hdrCurr'].forEach(id=>{const e=document.getElementById(id); if(e) e.textContent=cur;});
  // Portföy = tüm cüzdanlar displayCurr'a çevrilip toplanır
  const walletsTotal =
    convert(Number(profile.balances.ALL||0),'ALL',cur) +
    convert(Number(profile.balances.EUR||0),'EUR',cur) +
    convert(Number(profile.balances.USD||0),'USD',cur) +
    convert(Number(profile.balances.TRY||0),'TRY',cur);
  document.getElementById('hdrPortfolio').textContent = fmtNum(walletsTotal);

  // Harcama istatistikleri (seçilen görünüme çevrilmiş)
  const total = sum(items.map(x=>convert(Number(x.amount||0), x.curr||'ALL', cur)));
  const today = sum(items.filter(isToday).map(x=>convert(Number(x.amount||0), x.curr||'ALL', cur)));
  const month = sum(items.filter(isThisMonth).map(x=>convert(Number(x.amount||0), x.curr||'ALL', cur)));
  document.getElementById('statTotal').textContent=fmtNum(total);
  document.getElementById('statToday').textContent=fmtNum(today);
  document.getElementById('statMonth').textContent=fmtNum(month);
}

/*** Bakiye değiştirici (tek noktadan) ***/
async function applyBalanceDelta(curr, delta){
  curr=(curr||'ALL').toUpperCase();
  const balances={...profile.balances, [curr]:Number(profile.balances?.[curr]||0)+Number(delta||0)};
  const {data,error}=await supabase.from('profiles').upsert({user_id:sessionUser.id,default_currency:profile.default_currency,num_format:profile.num_format,lang:profile.lang,balances}).select().single();
  if(!error){profile=data;} else {console.warn('balance upsert err',error);}
}

/*** Liste yardımcıları ***/
function isToday(x){const d=new Date(x.d),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()&&d.getDate()==t.getDate()}
function isThisMonth(x){const d=new Date(x.d),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()}

/*** Auth ***/
function swapAuth(w){document.getElementById('tabLoginBtn').classList.toggle('active',w==='login');document.getElementById('tabRegBtn').classList.toggle('active',w==='reg');document.getElementById('authLogin').style.display=(w==='login')?'block':'none';document.getElementById('authReg').style.display=(w==='reg')?'block':'none'}
async function registerUser(){const email=document.getElementById('regEmail').value.trim();const pass=document.getElementById('regPass').value;const box=document.getElementById('regMsg');box.textContent='';if(!email||pass.length<6){box.textContent='Email + ≥6.';return;}const {error}=await supabase.auth.signUp({email,password:pass});box.textContent=error?('Gabim: '+error.message):'OK.'}
async function login(){const email=document.getElementById('loginEmail').value.trim();const pass=document.getElementById('loginPass').value;const box=document.getElementById('authMsg');box.textContent='';const {error}=await supabase.auth.signInWithPassword({email,password:pass});if(error) box.textContent='Gabim: '+error.message}
</script>
</body>
</html>
