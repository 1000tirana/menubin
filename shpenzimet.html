<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Normal Holding ‚Ä¢ Shpenzimet</title>
<meta name="theme-color" content="#0d1117">
<style>
:root{
  --bg:#0d1117; --card:#161b22; --border:#30363d;
  --text:#c9d1d9; --muted:#8b949e;
  --primary:#2ea043; --primary2:#238636; --blue:#1f6feb; --danger:#f85149;
  --safe-top:env(safe-area-inset-top,0px); --safe-bottom:env(safe-area-inset-bottom,0px);
  --nav-h:90px; /* alt men√º y√ºksekliƒüi (padding hesaplarƒ± bununla) */
}
*{box-sizing:border-box} html,body{height:100%;background:var(--bg);overflow-x:hidden;overscroll-behavior:none}
body{margin:0;color:var(--text);font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;touch-action:manipulation}

.wrap{display:flex;flex-direction:column;min-height:100vh;padding-bottom:calc(var(--nav-h) + var(--safe-bottom) + 12px)}
/* √úst ba≈ülƒ±k */
header{
  background:linear-gradient(135deg,var(--primary2) 0%, var(--primary) 100%); color:#fff;
  border-bottom-left-radius:18px;border-bottom-right-radius:18px;
  padding:calc(10px + var(--safe-top)) 16px 12px; box-shadow:0 10px 28px rgba(35,134,54,.35)
}
header .top{display:flex;justify-content:space-between;align-items:center}
header .title{font-size:20px;font-weight:900;display:flex;gap:8px;margin-top:6px}
header .big{font-size:34px;font-weight:900;margin-top:8px}
header .muted{color:#e6edf3;opacity:.85}

.stats{display:flex;gap:10px;padding:10px 12px;transform:translateY(-10px)}
.card{flex:1;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
main{padding:0 12px 18px}
h3.sec{margin:0 0 8px}

.list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.item{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.25);padding:12px}
.ic{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;font-size:22px;
  background:#0d1117;border:1px solid rgba(255,255,255,.06);box-shadow:inset 0 1px 3px rgba(0,0,0,.5),0 4px 10px rgba(0,0,0,.3)}
.meta{flex:1}
.meta .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#e6edf3}
.meta .s{font-size:12px;color:var(--muted)}
.amt{font-weight:900;color:#e6edf3;white-space:nowrap}
.badge{font-size:11px;border:1px solid var(--border);padding:2px 6px;border-radius:999px;color:#e6edf3}

/* formlar */
.row{display:flex;gap:10px} label{font-size:13px;color:var(--muted)}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:16px;background:var(--card);color:var(--text)}
.actions{display:flex;gap:10px;margin-top:10px}
.btnP,.btnS,.btnMini{font-size:16px;user-select:none;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
.btnP{flex:1;background:linear-gradient(180deg,var(--primary) 0%, var(--primary2) 100%);color:#fff;border:1px solid #2ea043;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
.btnS{flex:1;background:#21262d;color:#e6edf3;border:1px solid var(--border);padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
.btnMini{background:#21262d;border:1px solid var(--border);padding:8px 10px;border-radius:10px;font-weight:800;color:#e6edf3;cursor:pointer}

/* Alt NAV (sabit aralƒ±klar & tƒ±klanma) */
nav.nav{
  position:fixed;left:0;right:0;bottom:0;height:calc(var(--nav-h) + var(--safe-bottom));padding:0 16px calc(8px + var(--safe-bottom));
  background:var(--card);border-top:1px solid var(--border);box-shadow:0 -10px 30px rgba(0,0,0,.35);
  border-top-left-radius:16px;border-top-right-radius:16px;z-index:2000;
  display:grid;grid-template-columns:1fr 1fr 110px 1fr 1fr;align-items:center
}
.btn{justify-self:center;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);text-decoration:none}
.btn:nth-of-type(1){grid-column:1}.btn:nth-of-type(2){grid-column:2}.btn:nth-of-type(3){grid-column:4}.btn:nth-of-type(4){grid-column:5}
.btn .ico{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;font-size:22px;background:#0d1117;border:1px solid rgba(255,255,255,.06);box-shadow:inset 0 1px 3px rgba(0,0,0,.5)}
.btn.active{color:#79c0ff}
/* FAB (hep tƒ±klanƒ±r) */
.nav .fab{
  position:absolute;left:50%;transform:translateX(-50%);top:-22px;width:62px;height:62px;border-radius:999px;
  background:linear-gradient(180deg,var(--primary) 0%, var(--primary2) 100%); color:#0d1117; font-size:30px;
  border:1px solid rgba(255,255,255,.08);display:grid;place-items:center;box-shadow:0 16px 28px rgba(0,0,0,.55), inset 0 1px 4px rgba(0,0,0,.55);
  cursor:pointer;z-index:2100;pointer-events:auto
}
.tab{display:none}.tab.active{display:block}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:end;padding:14px;z-index:3000}
.modal.on{display:grid}
.sheet{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:18px;padding:14px 14px 18px;width:100%;box-shadow:0 -12px 30px rgba(0,0,0,.5)}

/* Auth gate */
.gate{position:fixed;inset:0;display:none;place-items:center;background:var(--bg);padding:18px;z-index:4000}
.panel{background:var(--card);border:1px solid var(--border);width:min(520px,92vw);border-radius:16px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
.tabs{display:flex;gap:6px;margin-bottom:10px}
.tabs button{flex:1;border:1px solid var(--border);padding:10px;border-radius:10px;background:#21262d;color:#e6edf3;cursor:pointer}
.tabs button.active{background:linear-gradient(180deg,var(--primary) 0%, var(--primary2) 100%);border-color:#2ea043;color:#fff;font-weight:800}

/* Category accordion */
.details{border:1px solid var(--border);border-radius:14px;background:var(--card);box-shadow:0 8px 24px rgba(0,0,0,.25);margin-top:12px}
.details summary{list-style:none;padding:14px 12px;cursor:pointer;font-weight:800}
.details[open] summary{border-bottom:1px solid var(--border)}
/* Emoji picker modal */
.picker-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;max-height:45vh;overflow:auto;margin-top:8px}
.picker-grid button{border:1px solid var(--border);background:#21262d;border-radius:10px;width:44px;height:44px;font-size:22px;cursor:pointer}
#emojiBtn{display:flex;gap:8px;align-items:center}
@media(min-width:720px){.wrap{max-width:520px;margin:0 auto}}
</style>
</head>
<body>

<!-- Gƒ∞Rƒ∞≈û / KAYIT -->
<div id="gate" class="gate">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900;font-size:18px">Normal Holding</div>
      <div class="muted">Shpenzimet ‚Ä¢ Cloud</div>
    </div>
    <div class="tabs">
      <button id="tabLoginBtn" class="active" onclick="swapAuth('login')">Hyrje</button>
      <button id="tabRegBtn" onclick="swapAuth('reg')">Regjistrohu</button>
    </div>
    <div id="authLogin">
      <label>Email</label>
      <input id="loginEmail" placeholder="emri@gmail.com" autocomplete="username">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>Fjal√´kalimi</label><input id="loginPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      </div>
      <div class="actions"><button class="btnP" onclick="login()">Hyr</button></div>
      <div id="authMsg" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="authReg" style="display:none">
      <label>Email</label>
      <input id="regEmail" placeholder="emri@gmail.com" autocomplete="username">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>Fjal√´kalimi</label><input id="regPass" type="password" autocomplete="new-password" placeholder="min. 6"></div>
      </div>
      <div class="actions"><button class="btnS" onclick="swapAuth('login')">Kthehu</button><button class="btnP" onclick="registerUser()">Krijo llogari</button></div>
      <div id="regMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="wrap" id="app" style="display:none">
  <header>
    <div class="top"><div style="font-weight:800">Normal Holding</div><div class="muted" id="who">@user</div></div>
    <div class="title"><span id="hdrIcon">üí∞</span><span id="hdrText">Bilanci</span></div>
    <div class="big"><span id="hdrTotal">0</span> <span id="hdrCur">L</span></div>
    <div class="muted" id="hdrSub">Gjendja ‚àí Shpenzimet (totale)</div>
  </header>

  <div class="stats">
    <div class="card"><div class="muted" id="s1name">üìä Totale</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat1">0</span> <span id="sCur1">L</span></div></div>
    <div class="card"><div class="muted" id="s2name">üìÖ Sot</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat2">0</span> <span id="sCur2">L</span></div></div>
    <div class="card"><div class="muted" id="s3name">üóìÔ∏è Muaj</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat3">0</span> <span id="sCur3">L</span></div></div>
  </div>

  <main>
    <section id="tab-home" class="tab active">
      <h3 class="sec">üïí T√´ fundit</h3>
      <div id="recentList" class="list"></div>
      <div id="emptyHome" class="muted" style="text-align:center;margin-top:16px">Asnj√´ hyrje deri tani.</div>
    </section>

    <section id="tab-list" class="tab">
      <h3 class="sec">üìö Lista</h3>
      <div class="row" style="margin:8px 0 10px">
        <input id="q" placeholder="K√´rko..." oninput="drawAll()">
        <select id="fCat" onchange="drawAll()"><option value="">T√´ gjitha</option></select>
      </div>
      <div id="allList" class="list"></div>
    </section>

    <section id="tab-debts" class="tab">
      <h3 class="sec">üí≥ Borxhet</h3>
      <div class="row" style="margin:8px 0 10px"><input id="dq" placeholder="K√´rko borxhe..." oninput="drawDebts()"></div>
      <div class="row" style="margin-bottom:8px">
        <div class="btnS" style="flex:1;display:flex;align-items:center;gap:8px;justify-content:center">
          <span>Filt√´r</span>
          <select id="dSeg" style="background:transparent;border:none" onchange="drawDebts()">
            <option value="">T√´ gjitha</option>
            <option value="borrow">Mora hua</option>
            <option value="lend">Dhash hua</option>
          </select>
        </div>
      </div>
      <div id="debtList" class="list"></div>
      <div id="emptyDebts" class="muted" style="text-align:center;margin-top:16px">Asnj√´ borxh deri tani.</div>
    </section>

    <section id="tab-settings" class="tab">
      <!-- SADECE AYARLAR ‚Äì √ºst metrik yok -->
      <div class="item" style="margin-top:10px">
        <div class="ic">üë§</div>
        <div class="meta"><div class="t">P√´rdoruesi</div><div class="s muted" id="userInfo">‚Äî</div></div>
        <button class="btnMini" onclick="logout()">Dil</button>
      </div>

      <div class="details" open>
        <summary>üí± Monedha & format</summary>
        <div style="padding:12px">
          <div class="row">
            <div style="flex:1"><label>Monedha aktuale (p√´r hyrjet e reja)</label>
              <select id="prefCurrency">
                <option value="ALL">ALL ‚Äî Albania Lek</option>
                <option value="EUR">EUR ‚Äî Euro</option>
                <option value="TRY">TRY ‚Äî Turkish Lira</option>
                <option value="USD">USD ‚Äî US Dollar</option>
              </select>
            </div>
            <div style="flex:1"><label>Formati i numrave</label>
              <select id="prefNum">
                <option value="eu">23.456,78</option>
                <option value="us">23,456.78</option>
              </select>
            </div>
          </div>
          <div class="actions"><button class="btnP" onclick="savePrefs()">Ruaj preferencat</button></div>
          <div id="prefMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
        </div>
      </div>

      <div class="details">
        <summary>üíº Gjendja e monedh√´s aktuale</summary>
        <div style="padding:12px">
          <div class="row"><input id="balInput" type="number" step="0.01" inputmode="decimal" placeholder="p.sh. 5000"></div>
          <div class="actions"><button class="btnP" onclick="saveBalance()">Ruaj gjendjen</button></div>
          <div class="muted" id="balMsg" style="margin-top:6px;font-size:12px"></div>
        </div>
      </div>

      <div class="details">
        <summary>üè∑Ô∏è Kategoriat</summary>
        <div style="padding:12px">
          <div id="catList" class="list"></div>
          <div style="border-top:1px solid var(--border);margin:12px 0"></div>
          <div class="row">
            <div style="width:150px">
              <label>Emoji</label>
              <button class="btnS" id="emojiBtn" onclick="openEmojiPicker()">üçî Zgjidh emoji</button>
              <input id="newCatEmoji" value="üçî" hidden>
            </div>
            <div style="flex:1">
              <label>Emri i kategoris√´</label>
              <input id="newCatName" placeholder="p.sh. Ushqime">
            </div>
          </div>
          <div class="actions"><button class="btnP" onclick="addCategory()">Shto kategori</button></div>
          <div id="catMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
        </div>
      </div>

      <div class="details">
        <summary>üìß Ndrysho email</summary>
        <div style="padding:12px">
          <div class="row"><input id="newEmail" placeholder="email i ri p.sh. user@domain.com"></div>
          <div class="actions"><button class="btnP" onclick="changeEmail()">Ruaj email</button></div>
          <div id="emailMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
        </div>
      </div>

      <div class="details">
        <summary>üîê Ndrysho fjal√´kalimin</summary>
        <div style="padding:12px">
          <div class="row"><input id="newPass" type="password" placeholder="Fjal√´kalimi i ri (min. 6)"><input id="newPass2" type="password" placeholder="P√´rs√´rit fjal√´kalimin"></div>
          <div class="actions"><button class="btnP" onclick="changePassword()">Ruaj fjal√´kalimin</button></div>
          <div id="passMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- NAV + FAB -->
<nav class="nav" id="navbar" style="display:none">
  <a class="btn active" data-tab="home" onclick="switchTab('home')"><span class="ico">üè†</span><span>Kreu</span></a>
  <a class="btn" data-tab="list" onclick="switchTab('list')"><span class="ico">üìã</span><span>Lista</span></a>
  <a class="btn" data-tab="debts" onclick="switchTab('debts')"><span class="ico">üí≥</span><span>Borxhet</span></a>
  <a class="btn" data-tab="settings" onclick="switchTab('settings')"><span class="ico">‚öôÔ∏è</span><span>Cil√´sime</span></a>
  <button class="fab" id="openAdd" aria-label="Shto">Ôºã</button>
</nav>

<!-- MODAL: Expense -->
<div class="modal" id="modalExp"><div class="sheet">
  <h3 style="margin:4px 0 10px">‚ûï Shto hyrje</h3>
  <div class="row"><div style="flex:2"><label>Emri</label><input id="mName" placeholder="p.sh. Karburant"></div><div style="flex:1"><label>Shuma</label><input id="mAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div></div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label>Kategoria</label><select id="mCat"></select></div>
    <div style="flex:1"><label>Data</label><input id="mDate" type="date"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label>Monedha</label>
      <select id="mCur">
        <option value="__profile__">(Si preferenca)</option>
        <option value="ALL">ALL</option><option value="EUR">EUR</option><option value="TRY">TRY</option><option value="USD">USD</option>
      </select>
    </div>
  </div>
  <div class="actions"><button class="btnS" onclick="closeModal('Exp')">Mbyll</button><button class="btnP" onclick="saveExpense()">Ruaj</button></div>
</div></div>

<!-- MODAL: Debt -->
<div class="modal" id="modalDebt"><div class="sheet">
  <h3 style="margin:4px 0 10px">‚ûï Shto borxh</h3>
  <div class="row">
    <div style="flex:1"><label>Pal√´ (Emri)</label><input id="dParty" placeholder="p.sh. Arben / ACME sh.p.k."></div>
    <div style="flex:1"><label>Shuma</label><input id="dAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label>Lloji</label>
      <select id="dKind"><option value="borrow">Mora hua</option><option value="lend">Dhash hua</option></select>
    </div>
    <div style="flex:1"><label>Afati (ops.)</label><input id="dDate" type="date"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label>Monedha</label>
      <select id="dCur">
        <option value="__profile__">(Si preferenca)</option>
        <option value="ALL">ALL</option><option value="EUR">EUR</option><option value="TRY">TRY</option><option value="USD">USD</option>
      </select>
    </div>
    <div style="flex:1"><label>P√´rshkrimi (ops.)</label><input id="dName" placeholder="p.sh. Telefon i ri"></div>
  </div>
  <div class="actions"><button class="btnS" onclick="closeModal('Debt')">Mbyll</button><button class="btnP" onclick="saveDebt()">Ruaj</button></div>
</div></div>

<!-- MODAL: Emoji -->
<div class="modal" id="modalEmoji"><div class="sheet">
  <h3 style="margin:4px 0 10px">üôÇ Zgjidh nj√´ emoji</h3>
  <div id="emojiGrid" class="picker-grid"></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Emoji')">Mbyll</button></div>
</div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*** Supabase ***/
const SUPABASE_URL='https://nvpjqvggaiipwziolend.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cGpxdmdnYWlpcHd6aW9sZW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4OTExNzcsImV4cCI6MjA3NDQ2NzE3N30.PnJh09kx-kK8iChgQl2M1eTw5P2qRZUEO31wVY7_iP4';
const supabase = window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/*** State ***/
const DEFAULT_CATS=[{name:'Ushqime',emoji:'üçî'},{name:'Transport',emoji:'‚õΩ'},{name:'Sht√´pia',emoji:'üè†'},{name:'Arg√´tim',emoji:'üéüÔ∏è'},{name:'Fatura',emoji:'üí°'},{name:'T√´ tjera',emoji:'üßæ'}];
let sessionUser=null, items=[], debts=[], cats=[...DEFAULT_CATS];
let profile={default_currency:'ALL',num_format:'eu',balances:{}};
let activeTab='home';

/*** Boot ***/
document.addEventListener('DOMContentLoaded', async () => {
  // Emoji grid
  'üçî ü•ó üçï üç∞ ‚òï üç∫ üõí üöå ‚õΩ üöï üõ†Ô∏è üßΩ üéÅ üé¨ üéüÔ∏è üí° üì± üíª üè† ‚öΩ üßæ üíä ‚úàÔ∏è üöó üí≥ üíé üìö üîå üß• üëü üçº üßª üê∂ üê±'.split(' ').forEach(e=>{
    const b=document.createElement('button'); b.textContent=e;
    b.onclick=()=>{document.getElementById('newCatEmoji').value=e; document.getElementById('emojiBtn').textContent=e+' Zgjidh emoji'; closeModal('Emoji')};
    document.getElementById('emojiGrid').appendChild(b);
  });

  // FAB open
  const fabOpen=()=>{ if(activeTab==='debts') openModal('Debt'); else openModal('Exp'); };
  ['pointerup','touchend','click'].forEach(ev=>document.getElementById('openAdd').addEventListener(ev,fabOpen,{passive:true}));

  // Defaults
  document.getElementById('mDate').value=new Date().toISOString().slice(0,10);
  document.getElementById('dDate').value=new Date().toISOString().slice(0,10);

  // Auth restore
  const {data:{session}}=await supabase.auth.getSession();
  if(session?.user){sessionUser=session.user; showApp(); await Promise.all([ensureProfile(), ensureCategoriesSeed(), loadCategories(), loadExpenses(), loadDebts()]);}
  else showGate();

  supabase.auth.onAuthStateChange(async (_e,session)=>{
    if(session?.user){sessionUser=session.user; showApp(); await Promise.all([ensureProfile(), ensureCategoriesSeed(), loadCategories(), loadExpenses(), loadDebts()]);}
    else{sessionUser=null; showGate();}
  });
});

/*** UI helpers ***/
function emailShort(e){return e?e.split('@')[0]:'@user'}
function showGate(){document.getElementById('gate').style.display='grid';document.getElementById('app').style.display='none';document.getElementById('navbar').style.display='none'}
function showApp(){document.getElementById('gate').style.display='none';document.getElementById('app').style.display='block';document.getElementById('navbar').style.display='grid';document.getElementById('who').textContent=emailShort(sessionUser?.email);document.getElementById('userInfo').textContent=sessionUser?.email||'-';refreshHeader();drawHome();drawDebts()}
function swapAuth(w){document.getElementById('tabLoginBtn').classList.toggle('active',w==='login');document.getElementById('tabRegBtn').classList.toggle('active',w==='reg');document.getElementById('authLogin').style.display=(w==='login')?'block':'none';document.getElementById('authReg').style.display=(w==='reg')?'block':'none'}
async function registerUser(){const email=document.getElementById('regEmail').value.trim();const pass=document.getElementById('regPass').value;const box=document.getElementById('regMsg');box.textContent='';if(!email||pass.length<6){box.textContent='Email dhe fjal√´kalim ‚â• 6.';return;}const {error}=await supabase.auth.signUp({email,password:pass});box.textContent=error?('Gabim: '+error.message):'Llogaria u krijua. Kontrollo email-in.'}
async function login(){const email=document.getElementById('loginEmail').value.trim();const pass=document.getElementById('loginPass').value;const box=document.getElementById('authMsg');box.textContent='';const {error}=await supabase.auth.signInWithPassword({email,password:pass});if(error) box.textContent='Gabim: '+error.message}
async function logout(){await supabase.auth.signOut()}

function switchTab(t){activeTab=t;document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.getElementById('tab-'+t).classList.add('active');document.querySelectorAll('.btn').forEach(x=>x.classList.remove('active'));document.querySelector(`.btn[data-tab="${t}"]`)?.classList.add('active');refreshHeader();if(t==='list')drawAll();if(t==='debts')drawDebts();}

/*** Profile & preferences ***/
async function ensureProfile(){
  try{
    const {data}=await supabase.from('profiles').select('*').eq('user_id',sessionUser.id).single();
    if(data) profile={...profile,...data,balances:data.balances||{}};
    else{
      const payload={user_id:sessionUser.id,default_currency:'ALL',num_format:'eu',balances:{}};
      const {data:ins}=await supabase.from('profiles').insert(payload).select().single();
      profile={...profile,...ins};
    }
  }catch(e){}
  // set inputs
  document.getElementById('prefCurrency').value=profile.default_currency||'ALL';
  document.getElementById('prefNum').value=profile.num_format||'eu';
  refreshHeader(); refreshCategorySelects();
}
async function savePrefs(){
  const cur=document.getElementById('prefCurrency').value;
  const num=document.getElementById('prefNum').value;
  const {data,error}=await supabase.from('profiles').upsert({user_id:sessionUser.id,default_currency:cur,num_format:num}).select().single();
  document.getElementById('prefMsg').textContent=error?('Gabim: '+error.message):'U ruajt.';
  if(!error){profile={...profile,...data}; refreshHeader();}
}
async function saveBalance(){
  const v=parseFloat(document.getElementById('balInput').value)||0;
  const cur=profile.default_currency||'ALL';
  const newBal={...(profile.balances||{})}; newBal[cur]=v;
  const {data,error}=await supabase.from('profiles').upsert({user_id:sessionUser.id,balances:newBal}).select().single();
  document.getElementById('balMsg').textContent=error?('Gabim: '+error.message):'U ruajt.';
  if(!error){profile={...profile,...data}; refreshHeader();}
}
async function changeEmail(){
  const e=(document.getElementById('newEmail').value||'').trim(); const m=document.getElementById('emailMsg'); m.textContent='';
  if(!e||!e.includes('@')){m.textContent='Shkruaj nj√´ email t√´ vlefsh√´m.';return;}
  const {error}=await supabase.auth.updateUser({email:e});
  m.textContent=error?('Gabim: '+error.message):'U d√´rgua linku i konfirmimit.';
}
async function changePassword(){
  const p1=document.getElementById('newPass').value,p2=document.getElementById('newPass2').value,m=document.getElementById('passMsg');m.textContent='';
  if(!p1||p1.length<6){m.textContent='Fjal√´kalimi ‚â• 6.';return;} if(p1!==p2){m.textContent='Fjal√´kalimet nuk p√´rputhen.';return;}
  const {data:{session}}=await supabase.auth.getSession(); if(!session){m.textContent='Duhet t√´ hyni p√´rs√´ri (session mungon).'; return;}
  const {error}=await supabase.auth.updateUser({password:p1});
  m.textContent=error?('Gabim: '+error.message):'Fjal√´kalimi u p√´rdit√´sua.'; if(!error){document.getElementById('newPass').value='';document.getElementById('newPass2').value='';}
}

/*** Categories ***/
async function ensureCategoriesSeed(){
  const {data}=await supabase.from('categories').select('id').eq('user_id',sessionUser.id).limit(1);
  if(!data||data.length===0){ await supabase.from('categories').insert(DEFAULT_CATS.map(c=>({...c,user_id:sessionUser.id}))); }
}
async function loadCategories(){
  const {data,error}=await supabase.from('categories').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:true});
  if(!error && data){cats=data.map(r=>({name:r.name,emoji:r.emoji,id:r.id}))}
  renderCatList(); refreshCategorySelects(); drawAll();
}
function renderCatList(){
  const box=document.getElementById('catList'); box.innerHTML='';
  cats.forEach(c=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ic'; ic.textContent=c.emoji||'üßæ';
    const meta=document.createElement('div'); meta.className='meta';
    meta.innerHTML=`<div class="t">${escapeHtml(c.name)}</div><div class="s">Kategori personale</div>`;
    const del=document.createElement('button'); del.className='btnMini'; del.textContent='Fshi'; del.onclick=()=>deleteCategory(c.id);
    el.append(ic,meta,del); box.appendChild(el);
  });
}
function refreshCategorySelects(){
  const mCat=document.getElementById('mCat'), fCat=document.getElementById('fCat');
  mCat.innerHTML=''; fCat.innerHTML='<option value="">T√´ gjitha</option>';
  cats.forEach(c=>{
    const o=document.createElement('option'); o.value=c.name; o.textContent=(c.emoji||'‚Ä¢')+' '+c.name;
    mCat.appendChild(o.cloneNode(true));
    const o2=document.createElement('option'); o2.value=c.name; o2.textContent=c.name; fCat.appendChild(o2);
  });
}
async function addCategory(){
  const name=(document.getElementById('newCatName').value||'').trim(); const emoji=(document.getElementById('newCatEmoji').value||'').trim()||'üßæ';
  const msg=document.getElementById('catMsg'); msg.textContent='';
  if(!name){msg.textContent='Shkruaj emrin e kategoris√´.';return;}
  const {data,error}=await supabase.from('categories').insert({user_id:sessionUser.id,name,emoji}).select().single();
  if(error){msg.textContent='Gabim: '+error.message;return;}
  cats.push({name:data.name,emoji:data.emoji,id:data.id}); document.getElementById('newCatName').value=''; renderCatList(); refreshCategorySelects();
  msg.textContent='U shtua.';
}
async function deleteCategory(id){
  if(!confirm('Fshije k√´t√´ kategori?')) return;
  const {error}=await supabase.from('categories').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){alert('Gabim: '+error.message);return;}
  cats=cats.filter(c=>c.id!==id); renderCatList(); refreshCategorySelects(); drawAll();
}
function openEmojiPicker(){openModal('Emoji')}

/*** Header & stats ***/
function refreshHeader(){
  const cur=profile.default_currency||'ALL'; setText('hdrCur',curSymbol(cur)); setText('sCur1',curSymbol(cur)); setText('sCur2',curSymbol(cur)); setText('sCur3',curSymbol(cur));
  if(activeTab==='debts'){
    setText('hdrText','Borxhet'); setText('hdrSub','Detyrimet & M√´ detyrohen'); document.getElementById('hdrIcon').textContent='üí≥';
    const total=sum(debts.map(x=>Number(x.amount||0)));
    const borrowOpen=sum(debts.filter(x=>x.kind==='borrow' && x.status!=='paid').map(n=>Number(n.amount||0)));
    const lendOpen=sum(debts.filter(x=>x.kind==='lend' && x.status!=='paid').map(n=>Number(n.amount||0)));
    setText('hdrTotal',fmt(total,cur)); setText('stat1',fmt(total,cur)); setText('stat2',fmt(borrowOpen,cur)); setText('stat3',fmt(lendOpen,cur));
  }else{
    setText('hdrText','Bilanci'); setText('hdrSub','Gjendja ‚àí Shpenzimet (totale)'); document.getElementById('hdrIcon').textContent='üí∞';
    const curKey=profile.default_currency||'ALL';
    const total=sum(items.filter(it=>getCur(it)===curKey).map(x=>Number(x.amount||0)));
    const today=sum(items.filter(it=>getCur(it)===curKey && isToday(it.d)).map(x=>Number(x.amount||0)));
    const month=sum(items.filter(it=>getCur(it)===curKey && isThisMonth(it.d)).map(x=>Number(x.amount||0)));
    const remain=num(profile.balances?.[curKey]||0) - total;
    setText('hdrTotal',fmt(remain,curKey)); setText('stat1',fmt(total,curKey)); setText('stat2',fmt(today,curKey)); setText('stat3',fmt(month,curKey));
  }
}

/*** Expenses ***/
async function loadExpenses(){
  const {data,error}=await supabase.from('expenses').select('*').eq('user_id',sessionUser.id).order('d',{ascending:false}).limit(2000);
  if(error){alert('Gabim (shpenzime): '+error.message);return;}
  items=data||[]; drawHome(); drawAll(); refreshHeader();
}
async function saveExpense(){
  const name=(document.getElementById('mName').value||'').trim();
  const amt=parseFloat(document.getElementById('mAmt').value);
  const cat=document.getElementById('mCat').value||null;
  const d=document.getElementById('mDate').value;
  const curSel=document.getElementById('mCur').value;
  const cur=(curSel==='__profile__')?(profile.default_currency||'ALL'):curSel;
  if(!name||!amt||!d||isNaN(amt)){alert('Plot√´soni emrin, shum√´n dhe dat√´n.');return;}
  const {data,error}=await supabase.from('expenses').insert({user_id:sessionUser.id,name,amount:amt,category:cat,d,currency:cur}).select().single();
  if(error){alert('Gabim: '+error.message);return;}
  items.unshift(data); document.getElementById('mName').value=''; document.getElementById('mAmt').value=''; closeModal('Exp'); drawHome(); drawAll(); refreshHeader();
}
async function delExpense(id){if(!confirm('Fshini k√´t√´ hyrje?'))return;const {error}=await supabase.from('expenses').delete().eq('id',id).eq('user_id',sessionUser.id);if(error){alert('Gabim: '+error.message);return;}items=items.filter(x=>x.id!==id);drawHome();drawAll();refreshHeader();}
function rowExpense(x){
  const el=document.createElement('div'); el.className='item';
  const ic=document.createElement('div'); ic.className='ic'; ic.textContent=emojiFor(x.category);
  const meta=document.createElement('div'); meta.className='meta';
  const t=document.createElement('div'); t.className='t'; t.textContent=x.name;
  const s=document.createElement('div'); s.className='s'; s.textContent=[x.category,fmtDate(x.d)].filter(Boolean).join(' ‚Ä¢ ');
  meta.appendChild(t); meta.appendChild(s);
  const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
  const cur=getCur(x); right.appendChild(makeBadge(cur));
  const amt=document.createElement('div'); amt.className='amt'; amt.textContent=fmt(x.amount,cur)+' '+cur;
  const del=document.createElement('button'); del.className='btnMini'; del.textContent='Fshi'; del.onclick=()=>delExpense(x.id);
  right.appendChild(amt); right.appendChild(del);
  el.append(ic,meta,right); return el;
}
function drawHome(){const recent=[...items].sort((a,b)=>b.d.localeCompare(a.d)).slice(0,8);const list=document.getElementById('recentList');list.innerHTML='';document.getElementById('emptyHome').style.display=recent.length?'none':'block';recent.forEach(x=>list.appendChild(rowExpense(x)))}
function drawAll(){
  const q=(document.getElementById('q').value||'').trim().toLowerCase(); const cat=document.getElementById('fCat').value;
  let arr=[...items].sort((a,b)=>b.d.localeCompare(a.d));
  if(q)arr=arr.filter(x=>x.name.toLowerCase().includes(q)||(x.category||'').toLowerCase().includes(q));
  if(cat)arr=arr.filter(x=>x.category===cat);
  const box=document.getElementById('allList'); box.innerHTML=''; arr.forEach(x=>box.appendChild(rowExpense(x)));
}

/*** Debts ***/
async function loadDebts(){const {data,error}=await supabase.from('debts').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:false}).limit(2000);if(error){alert('Gabim (borxhe): '+error.message);return;}debts=data||[];drawDebts();refreshHeader();}
async function saveDebt(){
  const party=(document.getElementById('dParty').value||'').trim(), name=(document.getElementById('dName').value||'').trim();
  const amt=parseFloat(document.getElementById('dAmt').value); const kind=document.getElementById('dKind').value; const due=document.getElementById('dDate').value||null;
  const curSel=document.getElementById('dCur').value; const currency=(curSel==='__profile__')?(profile.default_currency||'ALL'):curSel;
  if(!party||!amt||isNaN(amt)){alert('Shkruaj Pal√´n (Emri) dhe shum√´n.');return;}
  const payload={user_id:sessionUser.id,party,name,amount:amt,kind,due,status:'open',currency};
  const {data,error}=await supabase.from('debts').insert(payload).select().single();
  if(error){alert('Gabim: '+error.message);return;}
  debts.unshift(data); document.getElementById('dParty').value=''; document.getElementById('dName').value=''; document.getElementById('dAmt').value=''; document.getElementById('dKind').value='borrow'; closeModal('Debt'); drawDebts(); refreshHeader();
}
async function delDebt(id){if(!confirm('Fshini k√´t√´ borxh?'))return;const {error}=await supabase.from('debts').delete().eq('id',id).eq('user_id',sessionUser.id);if(error){alert('Gabim: '+error.message);return;}debts=debts.filter(x=>x.id!==id);drawDebts();refreshHeader();}
async function payDebt(id){
  if(!confirm('Je i sigurt q√´ ky borxh u pagua?')) return;
  const {data,error}=await supabase.from('debts').update({status:'paid'}).eq('id',id).eq('user_id',sessionUser.id).select().single();
  if(error){alert('Gabim: '+error.message);return;}
  debts=debts.map(x=>x.id===id?data:x); drawDebts(); refreshHeader();
}
function drawDebts(){
  const q=(document.getElementById('dq').value||'').trim().toLowerCase(); const kindFilter=document.getElementById('dSeg').value;
  let arr=[...debts];
  if(q)arr=arr.filter(x=>(x.party||'').toLowerCase().includes(q)||(x.name||'').toLowerCase().includes(q));
  if(kindFilter)arr=arr.filter(x=>x.kind===kindFilter);
  const box=document.getElementById('debtList'); box.innerHTML='';
  document.getElementById('emptyDebts').style.display=arr.length?'none':'block';
  arr.forEach(x=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ic'; ic.textContent=(x.status==='paid')?'‚úÖ':'üí≥';
    const meta=document.createElement('div'); meta.className='meta';
    const t=document.createElement('div'); t.className='t'; t.textContent=x.party||'(pa em√´r)';
    const bits=[x.kind==='borrow'?'Mora hua':'Dhash hua']; if(x.name) bits.push(x.name); if(x.due) bits.push('Afati: '+fmtDate(x.due));
    const s=document.createElement('div'); s.className='s'; s.textContent=bits.join(' ‚Ä¢ ');
    meta.appendChild(t); meta.appendChild(s);
    const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
    right.appendChild(makeBadge(x.currency||profile.default_currency||'ALL'));
    const amt=document.createElement('div'); amt.className='amt'; amt.textContent=fmt(x.amount,x.currency||profile.default_currency||'ALL')+' '+(x.currency||'');
    right.appendChild(amt);
    if(x.status==='open'){ const pay=document.createElement('button'); pay.className='btnMini'; pay.textContent=(x.kind==='borrow')?'Paguaj':'U kthye'; pay.onclick=()=>payDebt(x.id); right.appendChild(pay);}
    const del=document.createElement('button'); del.className='btnMini'; del.textContent='Fshi'; del.onclick=()=>delDebt(x.id); el.append(ic,meta,right,del); box.appendChild(el);
  });
}

/*** Helpers ***/
function openModal(w){document.getElementById('modal'+w).classList.add('on')}
function closeModal(w){document.getElementById('modal'+w).classList.remove('on')}
function setText(id,v){const e=document.getElementById(id); if(e) e.textContent=v}
function sum(a){return a.reduce((s,n)=>s+Number(n||0),0)}
function num(n){return Number(n||0)}
function isToday(iso){const d=new Date(iso); const t=new Date(); return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()&&d.getDate()==t.getDate()}
function isThisMonth(iso){const d=new Date(iso); const t=new Date(); return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()}
function fmtDate(iso){const d=new Date(iso+'T00:00:00');return d.toLocaleDateString('sq-AL',{day:'2-digit',month:'short',year:'numeric'})}
function fmt(v,cur){const n=Math.round(Number(v||0)*100)/100; const f=(profile.num_format||'eu')==='eu'?{minimumFractionDigits:2}:{minimumFractionDigits:2,localeMatcher:'lookup'}; const loc=(profile.num_format||'eu')==='eu'?'sq-AL':'en-US'; return n.toLocaleString(loc,f)}
function curSymbol(c){return c||'L'}
function getCur(x){return x.currency || profile.default_currency || 'ALL'}
function emojiFor(catName){const hit=cats.find(c=>c.name===catName);return hit?(hit.emoji||'üßæ'):'üí∏'}
function makeBadge(cur){const b=document.createElement('span'); b.className='badge'; b.textContent=cur; return b}
function escapeHtml(s=''){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
</script>

<!-- ===== Supabase SQL (bir defa √ßalƒ±≈ütƒ±r) =====
1) Profiles: kolonlar
-----------------------------------------------
alter table public.profiles
  add column if not exists default_currency text default 'ALL',
  add column if not exists num_format text default 'eu',
  add column if not exists balances jsonb default '{}'::jsonb,
  add column if not exists pin_hash text;

-- RLS (varsa atla)
alter table public.profiles enable row level security;
create policy if not exists "profiles select own" on public.profiles
  for select using (auth.uid() = user_id);
create policy if not exists "profiles upsert own" on public.profiles
  for insert with check (auth.uid() = user_id);
create policy if not exists "profiles update own" on public.profiles
  for update using (auth.uid() = user_id);

2) Categories
-----------------------------------------------
create table if not exists public.categories(
  id bigint generated by default as identity primary key,
  user_id uuid not null,
  name text not null,
  emoji text,
  created_at timestamp with time zone default now()
);
alter table public.categories enable row level security;
create policy if not exists "categories select own" on public.categories for select using (auth.uid()=user_id);
create policy if not exists "categories insert own" on public.categories for insert with check (auth.uid()=user_id);
create policy if not exists "categories update own" on public.categories for update using (auth.uid()=user_id);
create policy if not exists "categories delete own" on public.categories for delete using (auth.uid()=user_id);

3) Expenses (currency desteƒüi)
-----------------------------------------------
create table if not exists public.expenses(
  id bigint generated by default as identity primary key,
  user_id uuid not null,
  name text not null,
  amount numeric not null,
  category text,
  d date not null,
  currency text,               -- eski kayƒ±tlar null kalabilir (uyumluluk)
  created_at timestamp with time zone default now()
);
alter table public.expenses enable row level security;
create policy if not exists "expenses select own" on public.expenses for select using (auth.uid()=user_id);
create policy if not exists "expenses insert own" on public.expenses for insert with check (auth.uid()=user_id);
create policy if not exists "expenses update own" on public.expenses for update using (auth.uid()=user_id);
create policy if not exists "expenses delete own" on public.expenses for delete using (auth.uid()=user_id);

4) Debts (currency + status)
-----------------------------------------------
create table if not exists public.debts(
  id bigint generated by default as identity primary key,
  user_id uuid not null,
  party text not null,
  name text,
  amount numeric not null,
  kind text not null check (kind in ('borrow','lend')),
  status text not null default 'open' check (status in ('open','paid')),
  currency text,
  due date,
  created_at timestamp with time zone default now()
);
alter table public.debts enable row level security;
create policy if not exists "debts select own" on public.debts for select using (auth.uid()=user_id);
create policy if not exists "debts insert own" on public.debts for insert with check (auth.uid()=user_id);
create policy if not exists "debts update own" on public.debts for update using (auth.uid()=user_id);
create policy if not exists "debts delete own" on public.debts for delete using (auth.uid()=user_id);

-- ƒ∞ndeksler
create index if not exists expenses_user_d on public.expenses(user_id,d);
create index if not exists debts_user_kind on public.debts(user_id,kind);
create index if not exists debts_user_due on public.debts(user_id,due);
-->
</body>
</html>
