<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Normal Holding</title>
<meta name="theme-color" content="#0d1117">
<style>
:root{
  --bg:#0d1117; --card:#161b22; --border:#30363d;
  --text:#c9d1d9; --muted:#8b949e;
  --primary:#2ea043; --primary2:#238636;
  --blue:#1f6feb; --danger:#f85149;
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bottom:env(safe-area-inset-bottom,0px);
  --nav-h:86px;
}
*{box-sizing:border-box}
html,body{height:100%;background:var(--bg);overflow-x:hidden;overscroll-behavior:none}
body{margin:0;color:var(--text);font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
.wrap{display:flex;flex-direction:column;min-height:100vh;padding-bottom:calc(var(--nav-h)+var(--safe-bottom))}
h1,h2,h3,h4{margin:0 0 8px}
.muted{color:var(--muted)}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.row{display:flex;gap:10px}
label{font-size:13px;color:var(--muted)}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:16px;background:var(--card);color:var(--text);-webkit-appearance:none}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 16px;border-radius:12px;border:1px solid var(--border);font-weight:800;background:#21262d;color:#e6edf3;cursor:pointer}
.btn.p{background:linear-gradient(180deg,var(--primary) 0%,var(--primary2) 100%);border-color:#2ea043;color:#fff}
.btn.d{background:#2a1111;color:#fff;border-color:#4d1a1a}
.btn.s{background:#21262d}
.grid{display:grid;gap:10px}
.list{display:flex;flex-direction:column;gap:10px}
.item{display:flex;align-items:center;gap:12px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
.ic{font-size:28px;line-height:1}
.meta{flex:1}
.meta .t{font-weight:900;color:#e6edf3}
.meta .s{font-size:12px;color:var(--muted)}
.amt{font-weight:900}
.kbd{font:600 12px ui-monospace,monospace;background:#0b1620;border:1px solid #0e2238;border-radius:6px;padding:2px 6px}

/* header */
header{
  background:linear-gradient(135deg,var(--primary2),var(--primary));
  border-bottom-left-radius:22px;border-bottom-right-radius:22px;
  padding:calc(8px + var(--safe-top)) 16px 12px;color:#fff;box-shadow:0 10px 30px rgba(35,134,54,.35)
}
header .top{display:flex;justify-content:space-between;align-items:center}
header .big{font-size:34px;font-weight:900;margin-top:6px}
.stats{display:flex;gap:10px;padding:10px 12px;transform:translateY(-10px)}
.stat{flex:1;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}

/* quick currency switch (geÃ§ici gÃ¶rÃ¼ntÃ¼leme) */
.switch{display:flex;gap:6px;margin-top:6px}
.switch select{max-width:140px}

/* tabs */
main{padding:0 12px 16px}
.tab{display:none}.tab.active{display:block}

/* bottom nav */
nav.nav{
  position:fixed;left:0;right:0;bottom:0;height:var(--nav-h);
  padding:10px 16px calc(10px + var(--safe-bottom));background:var(--card);
  border-top:1px solid var(--border);box-shadow:0 -10px 30px rgba(0,0,0,.35);
  border-top-left-radius:16px;border-top-right-radius:16px;display:grid;
  grid-template-columns:1fr 1fr 70px 1fr 1fr;align-items:center;z-index:2000
}
.nav a{justify-self:center;display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted);text-decoration:none}
.nav a.active{color:#79c0ff}
.nav .fab{position:absolute;left:50%;transform:translateX(-50%);top:-24px;width:64px;height:64px;border-radius:999px;background:#39d353;color:#0b2211;border:2px solid #2ea043;display:grid;place-items:center;font-size:32px;cursor:pointer;box-shadow:0 18px 30px rgba(0,0,0,.45)}
/* modal */
.modal{position:fixed;inset:0;display:none;place-items:end;padding:14px;background:rgba(0,0,0,.45);z-index:3000}
.modal.on{display:grid}
.sheet{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px 14px 18px;width:100%;max-width:560px;margin:0 auto}

/* auth */
.gate{position:fixed;inset:0;display:none;place-items:center;padding:18px;background:var(--bg);z-index:4000}
.panel{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);width:min(560px,92vw)}
.tabs{display:flex;gap:6px;margin-bottom:10px}
.tabs button{flex:1} .tabs .active{background:linear-gradient(180deg,var(--blue) 0%,#1158c7 100%);border-color:#1158c7;color:#fff}

@media(min-width:768px){.wrap{max-width:560px;margin:0 auto}}
</style>
</head>
<body>

<!-- AUTH -->
<div id="gate" class="gate">
  <div class="panel">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div style="font-weight:900;font-size:18px">Normal Holding</div>
      <div class="muted">Shpenzimet â€¢ Cloud</div>
    </div>
    <div class="tabs">
      <button id="bTabLogin" class="btn s active" onclick="swapAuth('login')">Hyrje</button>
      <button id="bTabReg" class="btn s" onclick="swapAuth('reg')">Regjistrohu</button>
    </div>
    <div id="authLogin">
      <label>Email</label><input id="loginEmail" placeholder="emri@gmail.com" autocomplete="username">
      <div class="row" style="margin-top:8px"><div style="flex:1"><label>FjalÃ«kalimi</label><input id="loginPass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div></div>
      <div class="row" style="margin-top:10px"><button class="btn p" style="flex:1" onclick="login()">Hyr</button></div>
      <div id="authMsg" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="authReg" style="display:none">
      <label>Email</label><input id="regEmail" placeholder="emri@gmail.com" autocomplete="username">
      <div class="row" style="margin-top:8px"><div style="flex:1"><label>FjalÃ«kalimi</label><input id="regPass" type="password" autocomplete="new-password" placeholder="min. 6"></div></div>
      <div class="row" style="margin-top:10px"><button class="btn s" style="flex:1" onclick="swapAuth('login')">Kthehu</button><button class="btn p" style="flex:1" onclick="registerUser()">Krijo llogari</button></div>
      <div id="regMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="wrap" style="display:none">
  <header>
    <div class="top">
      <div style="font-weight:900">Normal Holding</div>
      <div id="who" class="muted">@user</div>
    </div>
    <h2 id="hdrTitle">ğŸ’° Bilanci</h2>
    <div class="switch">
      <select id="viewCurr" onchange="setViewCurr(this.value)">
        <option>ALL</option><option>EUR</option><option>TRY</option><option>USD</option>
      </select>
      <div class="muted" id="netLine" style="margin-left:auto"></div>
    </div>
    <div class="big"><span id="hdrAmount">0</span> <span id="hdrCCY">ALL</span></div>
    <div class="muted" id="hdrSub">Gjendja âˆ’ Shpenzimet (nÃ« cÃ¼zdan)</div>
  </header>

  <div class="stats">
    <div class="stat"><div class="muted">ğŸ“Š Totale</div><div style="font-weight:900"><span id="stTotal">0</span> <span id="stCCY1">ALL</span></div></div>
    <div class="stat"><div class="muted">ğŸ“… Sot</div><div style="font-weight:900"><span id="stToday">0</span> <span id="stCCY2">ALL</span></div></div>
    <div class="stat"><div class="muted">ğŸ—“ï¸ Muaj</div><div style="font-weight:900"><span id="stMonth">0</span> <span id="stCCY3">ALL</span></div></div>
  </div>

  <main>
    <!-- HOME -->
    <section id="tab-home" class="tab active">
      <h3>ğŸ•’ TÃ« fundit</h3>
      <div id="recent" class="list"></div>
      <div id="emptyHome" class="muted" style="text-align:center;margin-top:10px">AsnjÃ« hyrje deri tani.</div>
    </section>

    <!-- LIST -->
    <section id="tab-list" class="tab">
      <h3>ğŸ“š Lista</h3>
      <div class="row" style="margin:8px 0 10px">
        <input id="q" placeholder="KÃ«rko..." oninput="drawAll()">
        <select id="fCurr" onchange="drawAll()"><option value="">CCY</option><option>ALL</option><option>EUR</option><option>TRY</option><option>USD</option></select>
      </div>
      <div id="allList" class="list"></div>
    </section>

    <!-- DEBTS -->
    <section id="tab-debts" class="tab">
      <h3>ğŸ’³ Borxhet</h3>
      <div class="row" style="margin:8px 0 10px">
        <input id="dq" placeholder="KÃ«rko..." oninput="drawDebts()">
      </div>
      <div class="grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:8px">
        <button class="btn s" id="dfltAll" onclick="setDebtFilter('')">TÃ« gjitha</button>
        <button class="btn s" id="dfltBorrow" onclick="setDebtFilter('borrow')">Mora hua</button>
        <button class="btn s" id="dfltLend" onclick="setDebtFilter('lend')">Dhash hua</button>
      </div>
      <div id="debtList" class="list"></div>
      <div id="emptyDebts" class="muted" style="text-align:center;margin-top:10px">AsnjÃ« borxh.</div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="tab">
      <h3>âš™ï¸ CilÃ«sime</h3>

      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:900" id="userName">PÃ«rdoruesi</div>
            <div class="muted" id="userMail">â€”</div>
          </div>
          <button class="btn s" onclick="logout()">Dil</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>ğŸ’± Monedha & format</h4>
        <div class="row" style="margin-top:6px">
          <div style="flex:1">
            <label>Monedha aktuale (pÃ«r hyrjet e reja)</label>
            <select id="prefCurr">
              <option>ALL</option><option>EUR</option><option>TRY</option><option>USD</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Formati i numrave</label>
            <select id="prefFmt">
              <option value="eu">23.456,78</option>
              <option value="us">23,456.78</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Gjuha / Dil</label>
            <select id="prefLang">
              <option value="sq">Shqip</option>
              <option value="tr">TÃ¼rkÃ§e</option>
              <option value="en">English</option>
              <option value="it">Italiano</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:10px"><button class="btn p" style="flex:1" onclick="savePrefs()">Ruaj preferencat</button></div>
        <div id="prefsMsg" class="muted" style="margin-top:6px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>ğŸ‘› Gjendja e monedhÃ«s aktuale (<span id="balCurrLbl">ALL</span>)</h4>
        <div class="row" style="margin-top:6px">
          <input id="balInput" type="number" step="0.01" inputmode="decimal" placeholder="p.sh. 5000">
        </div>
        <div class="row" style="margin-top:10px"><button class="btn p" style="flex:1" onclick="saveBalance()">Ruaj gjendjen</button></div>
        <div id="balMsg" class="muted" style="margin-top:6px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>ğŸ·ï¸ Kategoriat</h4>
        <div id="catList" class="list" style="margin-top:8px"></div>
        <div style="border-top:1px solid var(--border);margin:12px 0"></div>
        <div class="row">
          <div style="width:120px">
            <label>Emoji</label>
            <input id="newCatEmoji" value="ğŸ”">
          </div>
          <div style="flex:1">
            <label>Emri i kategorisÃ«</label>
            <input id="newCatName" placeholder="p.sh. Ushqime">
          </div>
        </div>
        <div class="row" style="margin-top:10px"><button class="btn p" style="flex:1" onclick="addCategory()">Shto kategori</button></div>
        <div id="catMsg" class="muted" style="margin-top:6px"></div>
      </div>
    </section>
  </main>
</div>

<!-- NAV -->
<nav class="nav" id="navbar" style="display:none">
  <a class="active" data-tab="home" onclick="switchTab('home')">ğŸ <small>Kreu</small></a>
  <a data-tab="list" onclick="switchTab('list')">ğŸ“‹<small>Lista</small></a>
  <button class="fab" id="openAdd" aria-label="Shto">+</button>
  <a data-tab="debts" onclick="switchTab('debts')">ğŸ’³<small>Borxhet</small></a>
  <a data-tab="settings" onclick="switchTab('settings')">âš™ï¸<small>CilÃ«sime</small></a>
</nav>

<!-- MODALS -->
<div class="modal" id="mExp"><div class="sheet">
  <h3>â• Shto hyrje</h3>
  <div class="row"><div style="flex:2"><label>Emri</label><input id="eName" placeholder="p.sh. Karburant"></div><div style="flex:1"><label>Shuma</label><input id="eAmt" type="number" step="0.01" inputmode="decimal"></div></div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label>Kategoria</label><select id="eCat"></select></div>
    <div style="flex:1"><label>Data</label><input id="eDate" type="date"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label>Lloj</label><select id="eKind"><option value="exp">Shpenzim</option><option value="inc">TÃ« ardhura</option></select></div>
    <div style="flex:1"><label>Monedha</label><select id="eCurr"><option>ALL</option><option>EUR</option><option>TRY</option><option>USD</option></select></div>
  </div>
  <div class="row" style="margin-top:10px"><button class="btn s" style="flex:1" onclick="closeModal('mExp')">Mbyll</button><button class="btn p" style="flex:1" onclick="saveExpense()">Ruaj</button></div>
</div></div>

<div class="modal" id="mDebt"><div class="sheet">
  <h3>â• Shto borxh</h3>
  <div class="row"><div style="flex:1"><label>PalÃ«</label><input id="dParty" placeholder="p.sh. Arben/ACME"></div><div style="flex:1"><label>Shuma</label><input id="dAmt" type="number" step="0.01"></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label>Lloj</label><select id="dKind"><option value="borrow">Mora hua</option><option value="lend">Dhash hua</option></select></div><div style="flex:1"><label>Monedha</label><select id="dCurr"><option>ALL</option><option>EUR</option><option>TRY</option><option>USD</option></select></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label>Afati</label><input id="dDate" type="date"></div><div style="flex:1"><label>PÃ«rshkrimi</label><input id="dName"></div></div>
  <div class="row" style="margin-top:10px"><button class="btn s" style="flex:1" onclick="closeModal('mDebt')">Mbyll</button><button class="btn p" style="flex:1" onclick="saveDebt()">Ruaj</button></div>
</div></div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*** CONFIG ***/
const SUPABASE_URL='https://nvpjqvggaiipwziolend.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cGpxdmdnYWlpcHd6aW9sZW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4OTExNzcsImV4cCI6MjA3NDQ2NzE3N30.PnJh09kx-kK8iChgQl2M1eTw5P2qRZUEO31wVY7_iP4';
const sb = window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/*** STATE ***/
let me=null, profile={default_currency:'ALL',num_format:'eu',lang:'sq',balances:{}};
let cats=[], items=[], debts=[];
let viewCurr='ALL', debtFilter='';

/*** I18N (kÄ±saltÄ±lmÄ±ÅŸ) ***/
const I18N={
  sq:{Balance:'Bilanci',Recent:'TÃ« fundit',Expenses:'Shpenzim',Income:'TÃ« ardhura',Save:'Ruaj'},
  tr:{Balance:'BilanÃ§o',Recent:'Son iÅŸlemler',Expenses:'Gider',Income:'Gelir',Save:'Kaydet'},
  en:{Balance:'Balance',Recent:'Recent',Expenses:'Expense',Income:'Income',Save:'Save'},
  it:{Balance:'Saldo',Recent:'Recenti',Expenses:'Spesa',Income:'Entrata',Save:'Salva'}
};
const t=(k)=> (I18N[profile.lang||'sq']||I18N.sq)[k]||k;

/*** INIT ***/
document.addEventListener('DOMContentLoaded', async ()=>{
  document.getElementById('eDate').value=new Date().toISOString().slice(0,10);
  document.getElementById('dDate').value=new Date().toISOString().slice(0,10);

  document.getElementById('openAdd').addEventListener('click', () => {
    if(activeTab==='debts') openModal('mDebt'); else openModal('mExp');
  });

  const { data:{session} } = await sb.auth.getSession();
  if(session?.user){ me=session.user; await boot(); } else showGate();

  sb.auth.onAuthStateChange(async (_e,session)=>{
    if(session?.user){ me=session.user; await boot(); } else showGate();
  });
});

function showGate(){ byId('gate').style.display='grid'; byId('app').style.display='none'; byId('navbar').style.display='none'; }
async function boot(){
  byId('gate').style.display='none'; byId('app').style.display='block'; byId('navbar').style.display='grid';
  byId('who').textContent=(me.email||'').split('@')[0];
  byId('userMail').textContent=me.email||'';
  await Promise.all([ensureProfile(),ensureDefaultCats(),loadCats(),loadItems(),loadDebts()]);
  viewCurr = profile.default_currency || 'ALL';
  byId('viewCurr').value=viewCurr;
  byId('prefCurr').value=profile.default_currency||'ALL';
  byId('prefFmt').value=profile.num_format||'eu';
  byId('prefLang').value=profile.lang||'sq';
  byId('balCurrLbl').textContent=profile.default_currency||'ALL';
  byId('balInput').value = Number(profile.balances?.[profile.default_currency]||0);
  refreshHeader(); drawHome(); drawAll(); drawDebts(); renderCatList(); refreshCatSelect();
}

/*** AUTH ***/
function swapAuth(w){
  byId('bTabLogin').classList.toggle('active', w==='login');
  byId('bTabReg').classList.toggle('active', w==='reg');
  byId('authLogin').style.display=w==='login'?'block':'none';
  byId('authReg').style.display=w==='reg'?'block':'none';
}
async function login(){
  const email=val('loginEmail'), pass=val('loginPass');
  const {error}=await sb.auth.signInWithPassword({email,password:pass});
  byId('authMsg').textContent=error?error.message:'';
}
async function registerUser(){
  const email=val('regEmail'), pass=val('regPass');
  const {error}=await sb.auth.signUp({email,password:pass});
  byId('regMsg').textContent=error?error.message:'Kontrollo email-in pÃ«r verifikim.';
}
async function logout(){ await sb.auth.signOut(); }

/*** SUPABASE LOAD/SAVE ***/
async function ensureProfile(){
  try{
    const {data}=await sb.from('profiles').select('*').eq('user_id',me.id).single();
    profile = data || profile;
  }catch{
    const {data}=await sb.from('profiles').upsert({user_id:me.id,default_currency:'ALL',num_format:'eu',lang:'sq',balances:{}}).select().single();
    profile = data || profile;
  }
  byId('userName').textContent=(me.email||'').split('@')[0];
}
async function savePrefs(){
  const dc=val('prefCurr')||'ALL', fmt=val('prefFmt')||'eu', lng=val('prefLang')||'sq';
  const {data,error}=await sb.from('profiles').update({default_currency:dc,num_format:fmt,lang:lng}).eq('user_id',me.id).select().single();
  byId('prefsMsg').textContent = error?('Gabim: '+error.message):'U ruajt.';
  if(!error){ profile=data; viewCurr=profile.default_currency; byId('viewCurr').value=viewCurr; byId('balCurrLbl').textContent=viewCurr; refreshHeader(); }
}
async function saveBalance(){
  const v=parseFloat(val('balInput'))||0;
  const n={...(profile.balances||{})}; n[profile.default_currency]=v;
  const {data,error}=await sb.from('profiles').update({balances:n}).eq('user_id',me.id).select().single();
  byId('balMsg').textContent = error?('Gabim: '+error.message):'U ruajt.';
  if(!error){ profile=data; refreshHeader(); }
}

/*** CATEGORIES ***/
async function ensureDefaultCats(){
  const {data}=await sb.from('categories').select('id').eq('user_id',me.id).limit(1);
  if(!data || !data.length){
    const seed=[['ğŸ”','Ushqime'],['â›½','Transport'],['ğŸ ','ShtÃ«pia'],['ğŸŸï¸','ArgÃ«tim'],['ğŸ’¡','Fatura'],['ğŸ§¾','TÃ« tjera']]
      .map(x=>({user_id:me.id,emoji:x[0],name:x[1]}));
    await sb.from('categories').insert(seed);
  }
}
async function loadCats(){
  const {data}=await sb.from('categories').select('*').eq('user_id',me.id).order('created_at',{ascending:true});
  cats=data||[];
}
function renderCatList(){
  const box=byId('catList'); box.innerHTML='';
  cats.forEach(c=>{
    const el=div('item'); el.innerHTML=`<div class="ic">${c.emoji||'ğŸ§¾'}</div>
      <div class="meta"><div class="t">${esc(c.name)}</div><div class="s muted">Kategori personale</div></div>`;
    const del=btn('ğŸ—‘ï¸','btn s'); del.onclick=()=>deleteCategory(c.id);
    el.appendChild(del); box.appendChild(el);
  });
}
function refreshCatSelect(){
  const s=byId('eCat'); s.innerHTML='';
  cats.forEach(c=>{ const o=document.createElement('option'); o.value=c.name; o.textContent=`${c.emoji||'â€¢'} ${c.name}`; s.appendChild(o); });
}
async function addCategory(){
  const emoji=(val('newCatEmoji')||'').trim()||'ğŸ§¾';
  const name=(val('newCatName')||'').trim();
  if(!name){ byId('catMsg').textContent='Shkruaj emrin.'; return; }
  const {data,error}=await sb.from('categories').insert({user_id:me.id,emoji,name}).select().single();
  if(error){ byId('catMsg').textContent='Gabim: '+error.message; return; }
  cats.push(data); renderCatList(); refreshCatSelect(); byId('newCatName').value=''; byId('catMsg').textContent='U shtua.';
}
async function deleteCategory(id){
  if(!confirm('Fshije kategorinÃ«?')) return;
  const {error}=await sb.from('categories').delete().eq('id',id).eq('user_id',me.id);
  if(!error){ cats=cats.filter(x=>x.id!==id); renderCatList(); refreshCatSelect(); }
}

/*** ITEMS (EXP/INC) ***/
async function loadItems(){
  const {data,error}=await sb.from('expenses').select('*').eq('user_id',me.id).order('d',{ascending:false}).limit(5000);
  if(!error) items=data||[];
}
async function saveExpense(){
  const name=(val('eName')||'').trim(), amt=parseFloat(val('eAmt'))||0, d=val('eDate'), cat=val('eCat'), kind=val('eKind'), curr=val('eCurr')||profile.default_currency;
  if(!name||!amt||!d){ alert('PlotÃ«so emrin, shumÃ«n, datÃ«n.'); return; }
  const {data,error}=await sb.from('expenses').insert({user_id:me.id,name,amount:amt,d,category:cat,kind,curr}).select().single();
  if(error){ alert('Gabim: '+error.message); return; }
  items.unshift(data); closeModal('mExp'); refreshHeader(); drawHome(); drawAll();
}
async function delItem(id){
  if(!confirm('Fshije hyrjen?')) return;
  const {error}=await sb.from('expenses').delete().eq('id',id).eq('user_id',me.id);
  if(!error){ items=items.filter(x=>x.id!==id); refreshHeader(); drawHome(); drawAll(); }
}
function itemRow(x){
  const el=div('item');
  el.innerHTML=`<div class="ic">${emoFor(x.category)}</div>
  <div class="meta"><div class="t">${esc(x.name)}</div><div class="s">${esc(x.category||'â€¢')} â€¢ ${fmtDate(x.d)} â€¢ ${x.kind==='inc'?t('Income'):t('Expenses')}</div></div>
  <div class="amt">${fmt(x.amount,x.curr)} ${x.curr}</div>`;
  const del=btn('ğŸ—‘ï¸','btn s'); del.onclick=()=>delItem(x.id); el.appendChild(del); return el;
}
function drawHome(){
  const box=byId('recent'); box.innerHTML='';
  const rec=[...items].sort((a,b)=>b.d.localeCompare(a.d)).slice(0,8);
  rec.forEach(x=>box.appendChild(itemRow(x)));
  byId('emptyHome').style.display = rec.length?'none':'block';
}
function drawAll(){
  let arr=[...items].sort((a,b)=>b.d.localeCompare(a.d));
  const q=(val('q')||'').toLowerCase(), fc=val('fCurr')||'';
  if(q) arr=arr.filter(x=>(x.name||'').toLowerCase().includes(q)||(x.category||'').toLowerCase().includes(q));
  if(fc) arr=arr.filter(x=>x.curr===fc);
  const box=byId('allList'); box.innerHTML=''; arr.forEach(x=>box.appendChild(itemRow(x)));
}

/*** DEBTS ***/
async function loadDebts(){
  const {data,error}=await sb.from('debts').select('*').eq('user_id',me.id).order('created_at',{ascending:false});
  if(!error) debts=data||[];
}
function setDebtFilter(v){ debtFilter=v; drawDebts(); }
async function payDebt(id){
  if(!confirm('Paguar?')) return;
  const {data,error}=await sb.from('debts').update({status:'paid'}).eq('id',id).eq('user_id',me.id).select().single();
  if(!error){ debts=debts.map(x=>x.id===id?data:x); drawDebts(); }
}
async function saveDebt(){
  const party=(val('dParty')||'').trim(), amount=parseFloat(val('dAmt'))||0, due=val('dDate')||null, name=(val('dName')||'').trim(), kind=val('dKind'), curr=val('dCurr')||profile.default_currency;
  if(!party||!amount){ alert('PalÃ« & shuma.'); return; }
  const {data,error}=await sb.from('debts').insert({user_id:me.id,party,amount,curr,kind,due,name,status:'open'}).select().single();
  if(error){ alert('Gabim: '+error.message); return; }
  debts.unshift(data); closeModal('mDebt'); drawDebts(); refreshHeader();
}
async function delDebt(id){
  if(!confirm('Fshije?')) return;
  const {error}=await sb.from('debts').delete().eq('id',id).eq('user_id',me.id);
  if(!error){ debts=debts.filter(x=>x.id!==id); drawDebts(); refreshHeader(); }
}
function drawDebts(){
  let arr=[...debts]; const q=(val('dq')||'').toLowerCase();
  if(q) arr=arr.filter(x=>(x.party||'').toLowerCase().includes(q)||(x.name||'').toLowerCase().includes(q));
  if(debtFilter) arr=arr.filter(x=>x.kind===debtFilter);
  const box=byId('debtList'); box.innerHTML=''; byId('emptyDebts').style.display=arr.length?'none':'block';
  arr.forEach(x=>{
    const el=div('item');
    el.innerHTML=`<div class="ic">${x.status==='paid'?'âœ…':'ğŸ’³'}</div>
      <div class="meta"><div class="t">${esc(x.party||'(pa emÃ«r)')}</div>
      <div class="s">${x.kind==='borrow'?'Mora hua':'Dhash hua'} â€¢ ${x.name?esc(x.name)+' â€¢ ':''}${x.due?('Afati: '+fmtDate(x.due)):'â€”'}</div></div>
      <div class="amt">${fmt(x.amount,x.curr)} ${x.curr}</div>`;
    if(x.status==='open'){ const b=btn('Paguaj','btn s'); b.onclick=()=>payDebt(x.id); el.appendChild(b); }
    const d=btn('ğŸ—‘ï¸','btn s'); d.onclick=()=>delDebt(x.id); el.appendChild(d);
    box.appendChild(el);
  });
}

/*** HEADER & RATES ***/
let rates={}; // Ã¶r: {ALL:{EUR:0.0096,...}, EUR:{ALL:104.3,...}}
async function ensureRates(){
  const syms=['ALL','EUR','TRY','USD'];
  try{
    // exchangerate.host â€“ Ã¼cretsiz
    const base='https://api.exchangerate.host/latest';
    // hepsi iÃ§in dÃ¶ngÃ¼
    for(const b of syms){
      const res = await fetch(`${base}?base=${b}&symbols=${syms.join(',')}`);
      const js = await res.json();
      rates[b]=js.rates||{};
      rates[b][b]=1;
    }
  }catch{ /* Ã§evrim baÅŸarÄ±sÄ±zsa sabit fallback */ 
    rates={ALL:{ALL:1,EUR:0.009,TRY:0.32,USD:0.0095},
           EUR:{EUR:1,ALL:110,TRY:35,USD:1.07},
           TRY:{TRY:1,ALL:3.1,EUR:0.028,USD:0.031},
           USD:{USD:1,ALL:104,EUR:0.93,TRY:32}};
  }
}
function setViewCurr(c){ viewCurr=c; refreshHeader(); }
function sumArr(a){return a.reduce((s,n)=>s+Number(n||0),0)}
function fmt(n,ccy){ const loc=(profile.num_format||'eu')==='eu'?'sq-AL':'en-US'; return new Intl.NumberFormat(loc,{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(n||0)); }
function fmtDate(iso){ const d=new Date(iso+'T00:00:00'); return d.toLocaleDateString('sq-AL',{day:'2-digit',month:'short',year:'numeric'}) }
function emoFor(cat){ const hit=cats.find(c=>c.name===cat); return hit?(hit.emoji||'â€¢'):'ğŸ’¸'; }

async function refreshHeader(){
  byId('hdrTitle').textContent='ğŸ’° '+t('Balance');
  byId('hdrCCY').textContent=viewCurr;
  byId('stCCY1').textContent=viewCurr; byId('stCCY2').textContent=viewCurr; byId('stCCY3').textContent=viewCurr;

  if(!rates.EUR) await ensureRates();

  // cÃ¼zdan bakiyesi
  const bal = Number(profile.balances?.[viewCurr]||0);

  // bu para birimindeki hareketler (inc - exp)
  const totalExp = sumArr(items.filter(x=>x.curr===viewCurr && x.kind==='exp').map(x=>x.amount));
  const totalInc = sumArr(items.filter(x=>x.curr===viewCurr && x.kind==='inc').map(x=>x.amount));
  const remain = bal + totalInc - totalExp;

  byId('hdrAmount').textContent=fmt(remain,viewCurr);
  byId('stTotal').textContent=fmt(totalExp,viewCurr);
  const today = items.filter(x=>x.curr===viewCurr && x.kind==='exp' && isToday(x.d))
                     .reduce((s,x)=>s+x.amount,0);
  byId('stToday').textContent=fmt(today,viewCurr);
  const month = items.filter(x=>x.curr===viewCurr && x.kind==='exp' && isThisMonth(x.d))
                     .reduce((s,x)=>s+x.amount,0);
  byId('stMonth').textContent=fmt(month,viewCurr);

  // Net worth (tÃ¼m cÃ¼zdanlarÄ± seÃ§ili gÃ¶rÃ¼ntÃ¼ para birimine Ã§evir)
  let net=0;
  for(const [ccy,amount] of Object.entries(profile.balances||{})){
    net += Number(amount||0) * (rates[ccy]?.[viewCurr]||1);
  }
  byId('netLine').textContent='Net: '+fmt(net,viewCurr)+' '+viewCurr;
}
function isToday(iso){ const d=new Date(iso), t=new Date(); return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()&&d.getDate()==t.getDate(); }
function isThisMonth(iso){ const d=new Date(iso), t=new Date(); return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth(); }

/*** UI helpers ***/
let activeTab='home';
function switchTab(t){ activeTab=t; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); byId('tab-'+t).classList.add('active'); document.querySelectorAll('.nav a').forEach(x=>x.classList.remove('active')); document.querySelector(`.nav a[data-tab="${t}"]`)?.classList.add('active'); if(t==='list') drawAll(); if(t==='debts') drawDebts(); }
function openModal(id){ byId(id).classList.add('on'); }
function closeModal(id){ byId(id).classList.remove('on'); }
function byId(id){return document.getElementById(id)}
function val(id){return byId(id).value}
function esc(s){return (s||'').replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]))}
function div(c){const e=document.createElement('div'); e.className=c; return e;}
function btn(txt,cls){const b=document.createElement('button'); b.className=cls; b.textContent=txt; return b;}
</script>

<!--
========================================================
                    SUPABASE  SQL
========================================================
AÅŸaÄŸÄ±yÄ± Supabase SQL editor'da 1 kez Ã§alÄ±ÅŸtÄ±rÄ±n.
Mevcut tablo/politikalar varsa otomatik atlar.
-->
<!--
-- SCHEMA
create table if not exists public.profiles(
  user_id uuid primary key references auth.users(id) on delete cascade,
  default_currency text not null default 'ALL',
  num_format text not null default 'eu',
  lang text not null default 'sq',
  balances jsonb not null default '{}'::jsonb
);

create table if not exists public.categories(
  id bigserial primary key,
  user_id uuid not null references auth.users(id) on delete cascade,
  name text not null,
  emoji text not null default 'ğŸ§¾',
  created_at timestamp with time zone default now()
);

create table if not exists public.expenses(
  id bigserial primary key,
  user_id uuid not null references auth.users(id) on delete cascade,
  name text not null,
  amount numeric not null,
  curr text not null default 'ALL',
  kind text not null default 'exp', -- 'exp' | 'inc'
  category text,
  d date not null default (now() at time zone 'utc')::date,
  created_at timestamp with time zone default now()
);

create table if not exists public.debts(
  id bigserial primary key,
  user_id uuid not null references auth.users(id) on delete cascade,
  party text,
  amount numeric not null,
  curr text not null default 'ALL',
  kind text not null default 'borrow', -- 'borrow' | 'lend'
  due date,
  name text,
  status text not null default 'open',
  created_at timestamp with time zone default now()
);

-- INDEXES
create index if not exists idx_expenses_user on public.expenses(user_id);
create index if not exists idx_debts_user on public.debts(user_id);
create index if not exists idx_cats_user on public.categories(user_id);

-- RLS
alter table public.profiles enable row level security;
alter table public.categories enable row level security;
alter table public.expenses enable row level security;
alter table public.debts enable row level security;

-- policies (idempotent)
do $$
begin
  if not exists (select 1 from pg_policies where schemaname='public' and tablename='profiles' and policyname='profiles own') then
    create policy "profiles own" on public.profiles
      using (auth.uid() = user_id) with check (auth.uid() = user_id);
  end if;

  if not exists (select 1 from pg_policies where schemaname='public' and tablename='categories' and policyname='categories own') then
    create policy "categories own" on public.categories
      using (auth.uid() = user_id) with check (auth.uid() = user_id);
  end if;

  if not exists (select 1 from pg_policies where schemaname='public' and tablename='expenses' and policyname='expenses own') then
    create policy "expenses own" on public.expenses
      using (auth.uid() = user_id) with check (auth.uid() = user_id);
  end if;

  if not exists (select 1 from pg_policies where schemaname='public' and tablename='debts' and policyname='debts own') then
    create policy "debts own" on public.debts
      using (auth.uid() = user_id) with check (auth.uid() = user_id);
  end if;
end$$;
-->
</body>
</html>
