<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Normal Holding â€¢ Shpenzimet</title>
<meta name="theme-color" content="#0d1117" />
<style>
:root{
  --bg:#0d1117; --card:#161b22; --border:#30363d;
  --text:#c9d1d9; --muted:#8b949e;
  --primary:#2ea043; --primary2:#238636; --blue:#1f6feb; --danger:#f85149;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --safe-top:env(safe-area-inset-top,0px); --safe-bottom:env(safe-area-inset-bottom,0px);
  --navh:86px;
}
*{box-sizing:border-box}
html,body{height:100%;background:var(--bg);overscroll-behavior:none;overflow-x:hidden}
body{margin:0;color:var(--text);font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;touch-action:manipulation;-webkit-tap-highlight-color:transparent}

.wrap{display:flex;flex-direction:column;min-height:100vh;padding-bottom:calc(var(--navh) + var(--safe-bottom))}
header{
  background:linear-gradient(135deg,var(--primary2) 0%, var(--primary) 100%);
  color:#fff;border-bottom-left-radius:22px;border-bottom-right-radius:22px;
  padding:calc(10px + var(--safe-top)) 16px 12px; box-shadow:0 10px 28px rgba(35,134,54,.35)
}
header .top{display:flex;justify-content:space-between;align-items:center}
header .title{font-size:20px;font-weight:900;display:flex;gap:8px;margin-top:6px}
header .big{font-size:32px;font-weight:900;margin-top:8px}
header .muted{color:#e6edf3;opacity:.85}

.stats{display:flex;gap:10px;padding:10px 12px;transform:translateY(-12px)}
.card{flex:1;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:var(--shadow)}

#currBar{padding:0 12px 6px;transform:translateY(-6px)}
.seg{background:#21262d;border:1px solid var(--border);border-radius:10px;padding:4px;display:grid;gap:4px}
.seg.two{grid-template-columns:1fr 1fr}.seg.three{grid-template-columns:1fr 1fr 1fr}
.seg.four{grid-template-columns:repeat(4,1fr)}
.seg button{border:none;padding:10px;border-radius:8px;background:transparent;cursor:pointer;font-weight:800;color:#e6edf3}
.seg button.active{background:linear-gradient(180deg,#1f6feb 0%, #1158c7 100%);color:#fff}

main{padding:0 12px 20px}
h3.sec{margin:0 0 8px}
.list{display:flex;flex-direction:column;gap:10px;margin-top:12px}

.item{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px}
.ic{width:48px;height:48px;display:grid;place-items:center;font-size:26px}
.meta{flex:1;min-width:0}
.meta .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#e6edf3}
.meta .s{font-size:12px;color:var(--muted)}
.amt{font-weight:900;color:#e6edf3}
.del{border:none;background:transparent;color:var(--danger);font-size:20px;cursor:pointer}

.row{display:flex;gap:10px}
label{font-size:13px;color:var(--muted)}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;
  font-size:16px;background:var(--card);color:var(--text);-webkit-appearance:none}
.actions{display:flex;gap:10px;margin-top:10px}
.btnP,.btnS,.btnMini{font-size:16px;user-select:none;cursor:pointer}
.btnP{flex:1;background:linear-gradient(180deg,var(--primary) 0%, var(--primary2) 100%);color:#fff;border:1px solid #2ea043;padding:12px 16px;border-radius:12px;font-weight:800}
.btnS{flex:1;background:#21262d;color:#e6edf3;border:1px solid var(--border);padding:12px 16px;border-radius:12px;font-weight:800}
.btnMini{background:#21262d;border:1px solid var(--border);padding:8px 10px;border-radius:10px;font-weight:800;color:#e6edf3}

.chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#1f6feb;color:#fff}

/* Bilanci i tÃ« gjitha monedhave */
.bgrid{padding:0 12px 4px;transform:translateY(-4px);display:grid;grid-template-columns:1fr 1fr;gap:10px}
.bal{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow:var(--shadow);cursor:pointer}
.bal .tt{display:flex;justify-content:space-between;align-items:center;font-weight:800;margin-bottom:4px;color:#e6edf3}
.bal .val{font-size:18px;font-weight:900}
.bal .sub{font-size:12px;color:var(--muted)}
.bal.active{border-color:var(--blue);box-shadow:0 0 0 2px rgba(31,111,235,.2)}

@media(min-width:520px){.bgrid{grid-template-columns:repeat(4,1fr)}}

 /* Alt NAV */
nav.nav{
  --fab-gap: 110px;
  position:fixed;left:0;right:0;bottom:0;transform:translateZ(0);
  height:calc(var(--navh) + var(--safe-bottom));padding:0 12px var(--safe-bottom);
  background:var(--card);border-top:1px solid var(--border);box-shadow:0 -10px 30px rgba(0,0,0,.35);
  border-top-left-radius:16px;border-top-right-radius:16px;z-index:2000;
  display:grid;grid-template-columns:1fr 1fr var(--fab-gap) 1fr 1fr;align-items:center;
  backface-visibility:hidden;will-change:transform
}
.btn{justify-self:center;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);text-decoration:none}
.btn:nth-of-type(1){grid-column:1}.btn:nth-of-type(2){grid-column:2}.btn:nth-of-type(3){grid-column:4}.btn:nth-of-type(4){grid-column:5}
.btn .ico{width:44px;height:44px;display:grid;place-items:center;font-size:26px;border-radius:50%}
.btn.active{color:#79c0ff}
.nav .fab{
  position:absolute;left:50%;transform:translateX(-50%);
  top:-24px;width:64px;height:64px;border-radius:999px;
  background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
  border:1px solid rgba(255,255,255,.06);color:#0d1117;font-size:32px;
  display:grid;place-items:center;box-shadow:0 14px 26px rgba(0,0,0,.5), inset 0 1px 4px rgba(0,0,0,.6);
  cursor:pointer;z-index:2100;pointer-events:auto
}
@supports (-webkit-touch-callout: none){.nav .fab{top:-26px}}
.tab{display:none}.tab.active{display:block}

/* Modals & gate (same as before) */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:end;padding:14px;z-index:3000}
.modal.on{display:grid}
.sheet{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:18px;padding:14px 14px 18px;width:100%;box-shadow:0 -12px 30px rgba(0,0,0,.5)}
.gate{position:fixed;inset:0;display:none;place-items:center;background:var(--bg);padding:18px;z-index:4000}
.panel{background:var(--card);border:1px solid var(--border);width:min(520px,92vw);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
.tabs{display:flex;gap:6px;margin-bottom:10px}
.tabs button{flex:1;border:1px solid var(--border);padding:10px;border-radius:10px;background:#21262d;color:#e6edf3;cursor:pointer}
.tabs button.active{background:linear-gradient(180deg,var(--primary) 0%, var(--primary2) 100%);border-color:#2ea043;color:#fff;font-weight:800}

.picker-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;max-height:45vh;overflow:auto;margin-top:8px}
.picker-grid button{border:1px solid var(--border);background:#21262d;border-radius:10px;width:44px;height:44px;font-size:22px;cursor:pointer}
#emojiBtn{display:flex;gap:8px;align-items:center;width:100%}
details.box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px 12px}
details.box>summary{cursor:pointer;font-weight:800;color:#e6edf3;list-style:none}
details.box>summary::-webkit-details-marker{display:none}

@media(min-width:720px){.wrap{max-width:520px;margin:0 auto}}
</style>
</head>
<body>

<!-- Gate -->
<div id="gate" class="gate">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900;font-size:18px">Normal Holding</div>
      <div class="muted">Shpenzimet â€¢ Cloud</div>
    </div>
    <div class="tabs">
      <button id="tabLoginBtn" class="active" onclick="swapAuth('login')">Hyrje</button>
      <button id="tabRegBtn" onclick="swapAuth('reg')">Regjistrohu</button>
    </div>
    <div id="authLogin">
      <label>Email</label>
      <input id="loginEmail" placeholder="emri@gmail.com" autocomplete="username">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>FjalÃ«kalimi</label><input id="loginPass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
      </div>
      <div class="actions"><button class="btnP" onclick="login()">Hyr</button></div>
      <div id="authMsg" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="authReg" style="display:none">
      <label>Email</label>
      <input id="regEmail" placeholder="emri@gmail.com" autocomplete="username">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>FjalÃ«kalimi</label><input id="regPass" type="password" autocomplete="new-password" placeholder="min. 6"></div>
      </div>
      <div class="actions"><button class="btnS" onclick="swapAuth('login')">Kthehu</button><button class="btnP" onclick="registerUser()">Krijo llogari</button></div>
      <div id="regMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- App -->
<div class="wrap" id="app" style="display:none">
  <header id="hdr">
    <div class="top">
      <div style="font-weight:800">Normal Holding</div>
      <div class="muted" id="who">@pÃ«rdoruesi</div>
    </div>
    <div class="title"><span id="hdrIcon">ğŸ’°</span><span id="hdrText">Bilanci</span></div>
    <div class="big" id="hdrBig"><span id="hdrTotal">0</span></div>
    <div class="muted" id="hdrSub">Gjendja âˆ’ Shpenzimet (totale)</div>
  </header>

  <div class="stats" id="statsRow">
    <div class="card"><div class="muted" id="s1name">ğŸ“Š Totale</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat1">0</span></div></div>
    <div class="card"><div class="muted" id="s2name">ğŸ“… Sot</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat2">0</span></div></div>
    <div class="card"><div class="muted" id="s3name">ğŸ—“ï¸ Muaj</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat3">0</span></div></div>
  </div>

  <!-- HÄ±zlÄ± para seÃ§imi -->
  <div id="currBar" style="display:none">
    <div class="seg four" id="segCurr">
      <button type="button" data-val="ALL">ALL</button>
      <button type="button" data-val="EUR">EUR</button>
      <button type="button" data-val="USD">USD</button>
      <button type="button" data-val="TRY">TRY</button>
    </div>
  </div>

  <!-- Bilanci i tÃ« gjitha monedhave -->
  <div class="bgrid" id="allBalances"></div>

  <main>
    <!-- Home -->
    <section id="tab-home" class="tab active">
      <h3 class="sec">ğŸ•’ TÃ« fundit</h3>
      <div id="recentList" class="list"></div>
      <div id="emptyHome" class="muted" style="text-align:center;margin-top:16px">AsnjÃ« hyrje deri tani.</div>
    </section>

    <!-- List -->
    <section id="tab-list" class="tab">
      <h3 class="sec">ğŸ“š Lista</h3>
      <div class="row" style="margin:8px 0 10px">
        <input id="q" placeholder="KÃ«rko..." oninput="drawAll()">
        <select id="fCat" onchange="drawAll()"><option value="">TÃ« gjitha</option></select>
      </div>
      <div id="allList" class="list"></div>
    </section>

    <!-- Debts -->
    <section id="tab-debts" class="tab">
      <h3 class="sec">ğŸ’³ Borxhet</h3>
      <div class="row" style="margin:8px 0 10px"><input id="dq" placeholder="KÃ«rko borxhe..." oninput="drawDebts()"></div>
      <div class="seg three" id="dSegFilter" style="margin-bottom:8px">
        <button type="button" class="active" data-val="">TÃ« gjitha</button>
        <button type="button" data-val="borrow">Mora hua</button>
        <button type="button" data-val="lend">Dhash hua</button>
      </div>
      <div id="debtList" class="list"></div>
      <div id="emptyDebts" class="muted" style="text-align:center;margin-top:16px">AsnjÃ« borxh deri tani.</div>
    </section>

    <!-- Settings -->
    <section id="tab-settings" class="tab">
      <h3 class="sec">âš™ï¸ CilÃ«sime</h3>

      <div class="item">
        <div class="ic">ğŸ‘¤</div>
        <div class="meta"><div class="t">PÃ«rdoruesi</div><div class="s muted" id="userInfo">â€”</div></div>
        <button class="btnMini" onclick="logout()">Dil</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">ğŸ’± Monedha & formati</h4>
        <div class="row">
          <div style="flex:1">
            <label>Monedha aktuale (pÃ«r hyrjet e reja)</label>
            <select id="prefCurrency">
              <option>ALL</option><option>EUR</option><option>USD</option><option>TRY</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Formati i numrave</label>
            <select id="prefFormat">
              <option value="eu">23.456,78</option>
              <option value="us">23,456.78</option>
            </select>
          </div>
        </div>
        <div class="actions"><button class="btnP" onclick="savePrefs()">Ruaj preferencat</button></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">ğŸ¦ Gjendja e monedhÃ«s aktuale (<span id="currTag">ALL</span>)</h4>
        <div class="row"><input id="balInput" type="number" step="0.01" inputmode="decimal" placeholder="p.sh. 5000"></div>
        <div class="actions"><button class="btnP" onclick="saveBalance()">Ruaj gjendjen</button></div>
        <div class="muted" id="balMsg" style="margin-top:6px;font-size:12px"></div>
      </div>

      <details class="box" style="margin-top:12px">
        <summary>ğŸ“‚ Kategorit</summary>
        <div id="catList" class="list" style="margin-top:8px"></div>
        <div style="border-top:1px solid var(--border);margin:12px 0"></div>
        <div class="row">
          <div style="width:120px">
            <label>Emoji</label>
            <button class="btnS" id="emojiBtn" onclick="openEmojiPicker()"> <span id="emojiPreview" style="font-size:22px">ğŸ”</span> &nbsp;Zgjidh emoji</button>
            <input id="newCatEmoji" value="ğŸ”" hidden>
          </div>
          <div style="flex:1">
            <label>Emri i kategorisÃ«</label>
            <input id="newCatName" placeholder="p.sh. Ushqime">
          </div>
        </div>
        <div class="actions"><button class="btnP" onclick="addCategory()">Shto kategori</button></div>
        <div id="catMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </details>

      <details class="box" style="margin-top:12px">
        <summary>âœ‰ï¸ Ndrysho email</summary>
        <div class="row" style="margin-top:8px"><input id="newEmail" placeholder="email i ri p.sh. user@domain.com"></div>
        <div class="actions"><button class="btnP" onclick="changeEmail()">Ruaj email</button></div>
        <div id="emailMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </details>

      <details class="box" style="margin-top:12px">
        <summary>ğŸ” Ndrysho fjalÃ«kalimin</summary>
        <div class="row" style="margin-top:8px">
          <input id="newPass" type="password" placeholder="FjalÃ«kalimi i ri (min. 6)">
          <input id="newPass2" type="password" placeholder="PÃ«rsÃ«rit fjalÃ«kalimin">
        </div>
        <div class="actions"><button class="btnP" onclick="changePassword()">Ruaj fjalÃ«kalimin</button></div>
        <div id="passMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </details>
    </section>
  </main>
</div>

<!-- Bottom nav -->
<nav class="nav" id="navbar" style="display:none">
  <a class="btn active" data-tab="home" onclick="switchTab('home')"><span class="ico">ğŸ </span><span>Kreu</span></a>
  <a class="btn" data-tab="list" onclick="switchTab('list')"><span class="ico">ğŸ“‹</span><span>Lista</span></a>
  <a class="btn" data-tab="debts" onclick="switchTab('debts')"><span class="ico">ğŸ’³</span><span>Borxhet</span></a>
  <a class="btn" data-tab="settings" onclick="switchTab('settings')"><span class="ico">âš™ï¸</span><span>CilÃ«sime</span></a>
  <button class="fab" id="openAdd" aria-label="Shto">ï¼‹</button>
</nav>

<!-- Modals (expense/debt/emoji) -->
<div class="modal" id="modalExp"><div class="sheet">
  <h3 style="margin:4px 0 10px">â• Shto shpenzim</h3>
  <div class="row"><div style="flex:2"><label>Emri</label><input id="mName" placeholder="p.sh. Karburant"></div><div style="flex:1"><label>Shuma</label><input id="mAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label>Kategoria</label><select id="mCat"></select></div><div style="flex:1"><label>Data</label><input id="mDate" type="date"></div></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Exp')">Mbyll</button><button class="btnP" onclick="saveExpense()">Ruaj</button></div>
</div></div>

<div class="modal" id="modalDebt"><div class="sheet">
  <h3 style="margin:4px 0 10px">â• Shto borxh</h3>
  <div class="row">
    <div style="flex:1"><label>PalÃ« (Emri)</label><input id="dParty" placeholder="p.sh. Arben / ACME sh.p.k."></div>
    <div style="flex:1"><label>Shuma</label><input id="dAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label>Lloji</label><div id="segType" class="seg two"><button type="button" class="active" data-val="borrow">Mora hua</button><button type="button" data-val="lend">Dhash hua</button></div></div>
    <div style="flex:1"><label>Afati (opsionale)</label><input id="dDate" type="date"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label>PÃ«rshkrimi (opsionale)</label><input id="dName" placeholder="p.sh. Telefon i ri"></div>
  </div>
  <div class="actions"><button class="btnS" onclick="closeModal('Debt')">Mbyll</button><button class="btnP" onclick="saveDebt()">Ruaj</button></div>
</div></div>

<div class="modal" id="modalEmoji"><div class="sheet">
  <h3 style="margin:4px 0 10px">ğŸ™‚ Zgjidh njÃ« emoji</h3>
  <div id="emojiGrid" class="picker-grid"></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Emoji')">Mbyll</button></div>
</div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL='https://nvpjqvggaiipwziolend.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cGpxdmdnYWlpcHd6aW9sZW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4OTExNzcsImV4cCI6MjA3NDQ2NzE3N30.PnJh09kx-kK8iChgQl2M1eTw5P2qRZUEO31wVY7_iP4';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

let sessionUser=null, items=[], debts=[], profile=null, cats=[];
let activeTab='home';
const DEFAULT_CATS=[{name:'Ushqime',emoji:'ğŸ”'},{name:'Transport',emoji:'â›½'},{name:'ShtÃ«pia',emoji:'ğŸ '},{name:'ArgÃ«tim',emoji:'ğŸŸï¸'},{name:'Fatura',emoji:'ğŸ’¡'},{name:'TÃ« tjera',emoji:'ğŸ§¾'}];
const CURRENCIES=['ALL','EUR','USD','TRY'];
let prefs={curr:'ALL', fmt:'eu', balances:{}};
let viewCurr=null;

function emailShort(e){return e?e.split('@')[0]:'@pÃ«rdoruesi'}
function showGate(){document.getElementById('gate').style.display='grid';document.getElementById('app').style.display='none';document.getElementById('navbar').style.display='none'}
function showApp(){document.getElementById('gate').style.display='none';document.getElementById('app').style.display='block';document.getElementById('navbar').style.display='grid';document.getElementById('who').textContent=emailShort(sessionUser?.email);document.getElementById('userInfo').textContent=sessionUser?.email||'â€”';refreshHeader();drawHome();drawDebts()}
function swapAuth(w){document.getElementById('tabLoginBtn').classList.toggle('active',w==='login');document.getElementById('tabRegBtn').classList.toggle('active',w==='reg');document.getElementById('authLogin').style.display=(w==='login')?'block':'none';document.getElementById('authReg').style.display=(w==='reg')?'block':'none'}
function setText(id,v){const e=document.getElementById(id);if(e)e.textContent=v}
function sum(a){return a.reduce((s,n)=>s+Number(n||0),0)}
function fmtDate(iso){const d=new Date(iso+'T00:00:00');return d.toLocaleDateString('sq-AL',{day:'2-digit',month:'short',year:'numeric'})}
function isToday(x){const d=new Date(x.d),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()&&d.getDate()==t.getDate()}
function isThisMonth(x){const d=new Date(x.d),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()}
function toggleSeg(id,btn){const p=document.getElementById(id);p.querySelectorAll('button').forEach(x=>x.classList.remove('active'));btn.classList.add('active')}
function segValue(id){return document.querySelector('#'+id+' .active')?.dataset.val||''}
function resetSeg(id,val){const p=document.getElementById(id);p.querySelectorAll('button').forEach(x=>x.classList.toggle('active',x.dataset.val===val))}
function openModal(w){document.getElementById('modal'+w).classList.add('on')}
function closeModal(w){document.getElementById('modal'+w).classList.remove('on')}
function emojiFor(catName){const hit=cats.find(c=>c.name===catName); return hit?hit.emoji:'ğŸ’¸';}
const activeCurr=()=> (viewCurr || prefs.curr);

/* Money */
function setPrefsFromProfile(p){
  prefs.curr = p?.default_currency || 'ALL';
  prefs.fmt  = p?.num_format || 'eu';
  prefs.balances = p?.balances || {};
  document.getElementById('prefCurrency').value=prefs.curr;
  document.getElementById('prefFormat').value=prefs.fmt;
  document.getElementById('balInput').value = Number(prefs.balances[prefs.curr] || 0);
  setText('currTag', prefs.curr);
  resetSeg('segCurr', prefs.curr);
  viewCurr=null;
}
function money(n, currOverride){
  const nf = (prefs.fmt==='us')
    ? new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})
    : new Intl.NumberFormat('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const c = currOverride || activeCurr();
  return nf.format(Number(n||0))+' '+c;
}

/* Auth */
async function registerUser(){const email=document.getElementById('regEmail').value.trim();const pass=document.getElementById('regPass').value;const box=document.getElementById('regMsg');box.textContent='';if(!email||pass.length<6){box.textContent='Email dhe fjalÃ«kalim â‰¥ 6.';return;}const {error}=await supabase.auth.signUp({email,password:pass});box.textContent=error?('Gabim: '+error.message):'Llogaria u krijua. Kontrollo email-in.'}
async function login(){const email=document.getElementById('loginEmail').value.trim();const pass=document.getElementById('loginPass').value;const box=document.getElementById('authMsg');box.textContent='';const {error}=await supabase.auth.signInWithPassword({email,password:pass});if(error) box.textContent='Gabim: '+error.message}
async function logout(){await supabase.auth.signOut()}

/* Profile */
async function ensureProfile(){
  try{
    const {data} = await supabase.from('profiles').select('*').eq('user_id',sessionUser.id).maybeSingle();
    if(!data){
      const ins={user_id:sessionUser.id, default_currency:'ALL', num_format:'eu', balances:{}};
      const {data:created}=await supabase.from('profiles').insert(ins).select().single();
      profile=created;
    }else profile=data;
  }catch{ profile={default_currency:'ALL', num_format:'eu', balances:{}} }
  setPrefsFromProfile(profile);
  refreshHeader();
}
async function savePrefs(){
  const newCurr=document.getElementById('prefCurrency').value;
  const newFmt=document.getElementById('prefFormat').value;
  const {error}=await supabase.from('profiles').update({default_currency:newCurr, num_format:newFmt}).eq('user_id',sessionUser.id);
  if(!error){profile.default_currency=newCurr;profile.num_format=newFmt;setPrefsFromProfile(profile);drawHome();drawAll();drawDebts();refreshHeader();}
  else alert('Gabim: '+error.message);
}
async function saveBalance(){
  const raw=document.getElementById('balInput').value; const val=isNaN(parseFloat(raw))?0:parseFloat(raw);
  const balances={...(profile.balances||{})}; balances[prefs.curr]=val;
  const {data,error}=await supabase.from('profiles').update({balances}).eq('user_id',sessionUser.id).select().single();
  const msg=document.getElementById('balMsg');
  if(error){msg.textContent='Gabim: '+error.message;return;}
  profile=data; setPrefsFromProfile(profile); msg.textContent='U ruajt.'; refreshHeader();
}
async function changeEmail(){const e=(document.getElementById('newEmail').value||'').trim();const m=document.getElementById('emailMsg');m.textContent='';if(!e||!e.includes('@')){m.textContent='Shkruaj njÃ« email tÃ« vlefshÃ«m.';return;}const {error}=await supabase.auth.updateUser({email:e});m.textContent=error?('Gabim: '+error.message):'U dÃ«rgua linku i konfirmimit.'}
async function changePassword(){const p1=document.getElementById('newPass').value,p2=document.getElementById('newPass2').value,m=document.getElementById('passMsg');m.textContent='';if(!p1||p1.length<6){m.textContent='FjalÃ«kalimi â‰¥ 6.';return;}if(p1!==p2){m.textContent='FjalÃ«kalimet nuk pÃ«rputhen.';return;}const {error}=await supabase.auth.updateUser({password:p1});m.textContent=error?('Gabim: '+error.message):'FjalÃ«kalimi u pÃ«rditÃ«sua.';if(!error){document.getElementById('newPass').value='';document.getElementById('newPass2').value='';}}

/* Categories */
async function ensureCategoriesSeed(){const {data}=await supabase.from('categories').select('id').eq('user_id',sessionUser.id).limit(1);if(!data||data.length===0){await supabase.from('categories').insert(DEFAULT_CATS.map(c=>({...c,user_id:sessionUser.id})))}}
async function loadCategories(){const {data,error}=await supabase.from('categories').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:true});if(!error&&data){cats=data.map(r=>({name:r.name,emoji:r.emoji,id:r.id}))}renderCatList();refreshCategorySelects();drawAll();}
function renderCatList(){const box=document.getElementById('catList');if(!box)return;box.innerHTML='';cats.forEach(c=>{const el=document.createElement('div');el.className='item';const ic=document.createElement('div');ic.className='ic';ic.textContent=c.emoji||'ğŸ§¾';const meta=document.createElement('div');meta.className='meta';const t=document.createElement('div');t.className='t';t.textContent=c.name;const s=document.createElement('div');s.className='s';s.textContent='Kategori personale';meta.appendChild(t);meta.appendChild(s);const del=document.createElement('button');del.className='btnMini';del.textContent='Fshi';del.onclick=()=>deleteCategory(c.id);el.append(ic,meta,del);box.appendChild(el);});}
function refreshCategorySelects(){const mCat=document.getElementById('mCat'), fCat=document.getElementById('fCat');if(!mCat||!fCat)return;mCat.innerHTML='';fCat.innerHTML='<option value="">TÃ« gjitha</option>';cats.forEach(c=>{const o=document.createElement('option');o.value=c.name;o.textContent=(c.emoji||'â€¢')+' '+c.name;mCat.appendChild(o.cloneNode(true));const o2=document.createElement('option');o2.value=c.name;o2.textContent=c.name;fCat.appendChild(o2);});}
async function addCategory(){const name=(document.getElementById('newCatName').value||'').trim();const emoji=(document.getElementById('newCatEmoji').value||'').trim()||'ğŸ§¾';const msg=document.getElementById('catMsg');msg.textContent='';if(!name){msg.textContent='Shkruaj emrin e kategorisÃ«.';return;}const {data,error}=await supabase.from('categories').insert({user_id:sessionUser.id,name,emoji}).select().single();if(error){msg.textContent='Gabim: '+error.message;return;}cats.push({name:data.name,emoji:data.emoji,id:data.id});document.getElementById('newCatName').value='';renderCatList();refreshCategorySelects();msg.textContent='U shtua.'}
async function deleteCategory(id){if(!confirm('Fshije kÃ«tÃ« kategori?'))return;const {error}=await supabase.from('categories').delete().eq('id',id).eq('user_id',sessionUser.id);if(error){alert('Gabim: '+error.message);return;}cats=cats.filter(c=>c.id!==id);renderCatList();refreshCategorySelects();drawAll();}
function openEmojiPicker(){openModal('Emoji')}

/* Expenses */
async function loadExpenses(){const {data,error}=await supabase.from('expenses').select('*').eq('user_id',sessionUser.id).order('d',{ascending:false}).limit(2000);if(error){alert('Gabim ngarkimi (shpenzime): '+error.message);return;}items=data||[];drawHome();drawAll();refreshHeader();}
async function saveExpense(){const name=document.getElementById('mName').value.trim();const amt=parseFloat(document.getElementById('mAmt').value);const cat=document.getElementById('mCat').value;const d=document.getElementById('mDate').value;if(!name||!amt||!d||isNaN(amt)){alert('PlotÃ«soni emrin, shumÃ«n dhe datÃ«n.');return;}const row={user_id:sessionUser.id,name,amount:amt,category:cat,d,curr:prefs.curr};const {data,error}=await supabase.from('expenses').insert(row).select().single();if(error){alert('Gabim: '+error.message);return;}items.unshift(data);document.getElementById('mName').value='';document.getElementById('mAmt').value='';closeModal('Exp');drawHome();drawAll();refreshHeader();}
async function delExpense(id){if(!confirm('Fshini kÃ«tÃ« shpenzim?'))return;const {error}=await supabase.from('expenses').delete().eq('id',id).eq('user_id',sessionUser.id);if(error){alert('Gabim: '+error.message);return;}items=items.filter(x=>x.id!==id);drawHome();drawAll();refreshHeader();}
function rowExpense(x){const el=document.createElement('div');el.className='item';const ic=document.createElement('div');ic.className='ic';ic.textContent=emojiFor(x.category);const meta=document.createElement('div');meta.className='meta';const t=document.createElement('div');t.className='t';t.textContent=x.name;const s=document.createElement('div');s.className='s';s.textContent=[x.category, fmtDate(x.d), (x.curr||prefs.curr)].filter(Boolean).join(' â€¢ ');meta.appendChild(t);meta.appendChild(s);const amt=document.createElement('div');amt.className='amt';amt.textContent=money(x.amount, activeCurr());const del=document.createElement('button');del.className='del';del.textContent='ğŸ—‘ï¸';del.onclick=()=>delExpense(x.id);el.append(ic,meta,amt,del);return el;}
function drawHome(){const curr=activeCurr();const recent=[...items].filter(x=>(!x.curr && curr===prefs.curr) || x.curr===curr).sort((a,b)=>b.d.localeCompare(a.d)).slice(0,8);const list=document.getElementById('recentList');list.innerHTML='';document.getElementById('emptyHome').style.display=recent.length?'none':'block';recent.forEach(x=>list.appendChild(rowExpense(x)));}
function drawAll(){const curr=activeCurr();const q=(document.getElementById('q')?.value||'').trim().toLowerCase();const cat=document.getElementById('fCat')?.value||'';let arr=[...items].filter(x=>(!x.curr && curr===prefs.curr) || x.curr===curr).sort((a,b)=>b.d.localeCompare(a.d));if(q)arr=arr.filter(x=>x.name.toLowerCase().includes(q)||(x.category||'').toLowerCase().includes(q));if(cat)arr=arr.filter(x=>x.category===cat);const box=document.getElementById('allList');if(!box)return;box.innerHTML='';arr.forEach(x=>box.appendChild(rowExpense(x)));}

/* Debts */
async function loadDebts(){const {data,error}=await supabase.from('debts').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:false}).limit(2000);if(error){alert('Gabim ngarkimi (borxhe): '+error.message);return;}debts=data||[];drawDebts();refreshHeader();}
async function saveDebt(){const party=document.getElementById('dParty').value.trim();const name=(document.getElementById('dName').value||'').trim();const amt=parseFloat(document.getElementById('dAmt').value);const kind=segValue('segType');const due=document.getElementById('dDate').value||null;if(!party||!amt||isNaN(amt)){alert('Shkruaj PalÃ«n (Emri) dhe shumÃ«n.');return;}const row={user_id:sessionUser.id,party,name,amount:amt,kind,due,status:'open',curr:prefs.curr};const {data,error}=await supabase.from('debts').insert(row).select().single();if(error){alert('Gabim: '+error.message);return;}debts.unshift(data);document.getElementById('dParty').value='';document.getElementById('dName').value='';document.getElementById('dAmt').value='';resetSeg('segType','borrow');closeModal('Debt');drawDebts();refreshHeader();}
async function delDebt(id){if(!confirm('Fshini kÃ«tÃ« borxh?'))return;const {error}=await supabase.from('debts').delete().eq('id',id).eq('user_id',sessionUser.id);if(error){alert('Gabim: '+error.message);return;}debts=debts.filter(x=>x.id!==id);drawDebts();refreshHeader();}
async function payDebt(id){if(!confirm('Borxhi u pagua. Je i sigurt?')) return;const {data,error}=await supabase.from('debts').update({status:'paid'}).eq('id',id).eq('user_id',sessionUser.id).select().single();if(error){alert('Gabim: '+error.message);return;}debts=debts.map(x=>x.id===id?data:x);drawDebts();refreshHeader();}
function drawDebts(){const curr=activeCurr();const q=(document.getElementById('dq')?.value||'').trim().toLowerCase();const kindFilter=segValue('dSegFilter');let arr=[...debts].filter(x=>(!x.curr && curr===prefs.curr) || x.curr===curr);if(q)arr=arr.filter(x=>(x.party||'').toLowerCase().includes(q)||(x.name||'').toLowerCase().includes(q));if(kindFilter)arr=arr.filter(x=>x.kind===kindFilter);const box=document.getElementById('debtList');if(!box)return;box.innerHTML='';document.getElementById('emptyDebts').style.display=arr.length?'none':'block';arr.forEach(x=>{const el=document.createElement('div');el.className='item';const ic=document.createElement('div');ic.className='ic';ic.textContent=(x.status==='paid')?'âœ…':'ğŸ’³';const meta=document.createElement('div');meta.className='meta';const t=document.createElement('div');t.className='t';t.textContent=x.party || '(pa emÃ«r)';const bits=[x.kind==='borrow'?'Mora hua':'Dhash hua'];if(x.name)bits.push(x.name);if(x.due)bits.push('Afati: '+fmtDate(x.due));bits.push(x.curr||prefs.curr);const s=document.createElement('div');s.className='s';s.textContent=bits.join(' â€¢ ');meta.appendChild(t);meta.appendChild(s);const right=document.createElement('div');right.style.display='flex';right.style.alignItems='center';right.style.gap='8px';const amt=document.createElement('div');amt.className='amt';amt.textContent=money(x.amount, curr);right.appendChild(amt);if(x.status==='open'){const pay=document.createElement('button');pay.className='btnMini';pay.textContent=(x.kind==='borrow')?'Paguaj':'U kthye';pay.onclick=()=>payDebt(x.id);right.appendChild(pay);}else{const badge=document.createElement('span');badge.className='chip';badge.textContent='Paguar';right.appendChild(badge);}const del=document.createElement('button');del.className='del';del.textContent='ğŸ—‘ï¸';del.onclick=()=>delDebt(x.id);el.append(ic,meta,right,del);box.appendChild(el);});if(activeTab==='debts'){const borrowOpen=sum(arr.filter(x=>x.kind==='borrow'&&x.status!=='paid').map(n=>Number(n.amount||0)));const lendOpen=sum(arr.filter(x=>x.kind==='lend'&&x.status!=='paid').map(n=>Number(n.amount||0)));setText('hdrTotal', money(borrowOpen, curr).replace(' '+curr,''));setText('stat1', money(sum(arr.map(n=>Number(n.amount||0))), curr) );setText('stat2', money(borrowOpen, curr));setText('stat3', money(lendOpen, curr));}}

/* --- Bilanci i tÃ« gjitha monedhave --- */
function calcCurrencySummary(){
  const spent={ALL:0,EUR:0,USD:0,TRY:0};
  items.forEach(x=>{
    const c=x.curr || prefs.curr; // fallback
    if(spent[c]==null) spent[c]=0;
    spent[c]+=Number(x.amount||0);
  });
  return CURRENCIES.map(c=>{
    const bal=Number(profile?.balances?.[c]||0);
    const sp =Number(spent[c]||0);
    return {curr:c, balance:bal, spent:sp, remain:bal-sp};
  });
}
function setViewCurrency(c){
  viewCurr=c; resetSeg('segCurr',c);
  drawHome(); drawAll(); drawDebts(); refreshHeader();
}
function drawAllBalances(){
  const grid=document.getElementById('allBalances'); if(!grid) return;
  const data=calcCurrencySummary();
  grid.innerHTML='';
  data.forEach(o=>{
    const el=document.createElement('div'); el.className='bal';
    if(activeCurr()===o.curr) el.classList.add('active');
    el.innerHTML=
      `<div class="tt"><span>${o.curr}</span><span class="sub">${o.remain>=0?'Bilanc':'MungesÃ«'}</span></div>
       <div class="val">${money(o.remain, o.curr)}</div>
       <div class="sub">Gjendje ${money(o.balance,o.curr)} â€¢ Shpenzime ${money(o.spent,o.curr)}</div>`;
    el.onclick=()=>setViewCurrency(o.curr);
    grid.appendChild(el);
  });
}

/* Header & tabs */
function refreshHeader(){
  const icon=document.getElementById('hdrIcon'), text=document.getElementById('hdrText'), sub=document.getElementById('hdrSub');
  const statsRow=document.getElementById('statsRow'); const big=document.getElementById('hdrBig'); const currBar=document.getElementById('currBar');

  currBar.style.display = (activeTab==='home') ? 'block' : 'none';
  // yeni bÃ¶lÃ¼m her zaman Ã§izilsin (Ã¶zellikle Homeâ€™da)
  drawAllBalances();

  if(activeTab==='debts'){icon.textContent='ğŸ’³';text.textContent='Borxhet';sub.textContent='Detyrimet & MÃ« detyrohen';statsRow.style.display='flex';big.style.display='block';}
  else if(activeTab==='settings'){icon.textContent='âš™ï¸';text.textContent='CilÃ«sime';sub.textContent='';statsRow.style.display='none';big.style.display='none';}
  else{icon.textContent='ğŸ’°';text.textContent='Bilanci';sub.textContent='Gjendja âˆ’ Shpenzimet (totale)';statsRow.style.display='flex';big.style.display='block';}

  const curr=activeCurr();
  const total=sum(items.filter(x=>(!x.curr && curr===prefs.curr) || x.curr===curr).map(x=>Number(x.amount||0)));
  const today=sum(items.filter(x=>((!x.curr && curr===prefs.curr) || x.curr===curr) && isToday(x)).map(x=>Number(x.amount||0)));
  const month=sum(items.filter(x=>((!x.curr && curr===prefs.curr) || x.curr===curr) && isThisMonth(x)).map(x=>Number(x.amount||0)));
  const remain=Number(prefs.balances[curr]||0) - total;

  const nf = new Intl.NumberFormat(prefs.fmt==='us'?'en-US':'de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
  setText('hdrTotal', nf.format(remain) + ' ' + curr);
  setText('s1name', activeTab==='debts'?'Gjithsej':'Totale');
  setText('s2name', activeTab==='debts'?'Detyrime':'Sot');
  setText('s3name', activeTab==='debts'?'MÃ« detyrohen':'Muaj');
  setText('stat1', money(activeTab==='debts'?sum(debts.filter(x=>(!x.curr && curr===prefs.curr) || x.curr===curr).map(n=>Number(n.amount||0))):total, curr));
  setText('stat2', money(activeTab==='debts'?sum(debts.filter(x=>((!x.curr && curr===prefs.curr) || x.curr===curr)&&x.kind==='borrow'&&x.status!=='paid').map(n=>Number(n.amount||0))):today, curr));
  setText('stat3', money(activeTab==='debts'?sum(debts.filter(x=>((!x.curr && curr===prefs.curr) || x.curr===curr)&&x.kind==='lend'  &&x.status!=='paid').map(n=>Number(n.amount||0))):month, curr));
  setText('currTag', prefs.curr);
}

function switchTab(t){
  activeTab=t;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
  document.querySelectorAll('.btn').forEach(x=>x.classList.remove('active'));
  document.querySelector(`.btn[data-tab="${t}"]`)?.classList.add('active');
  if(t==='list') drawAll();
  if(t==='debts') drawDebts();
  refreshHeader();
}

/* Boot */
document.addEventListener('DOMContentLoaded', async () => {
  const picks='ğŸ” ğŸ¥— ğŸ• ğŸ° â˜• ğŸº ğŸ›’ ğŸšŒ â›½ ğŸš• ğŸ› ï¸ ğŸ§½ ğŸ ğŸ® ğŸ¬ ğŸŸï¸ ğŸ’¡ ğŸ“± ğŸ’» ğŸ  âš½ ğŸ§¾ ğŸ’Š âœˆï¸ ğŸš— ğŸª™ ğŸ’³ ğŸ“ ğŸ“š ğŸ”Œ ğŸ”‹ ğŸ‘Ÿ ğŸ¼ ğŸ§» ğŸ§´'.split(' ');
  const grid=document.getElementById('emojiGrid');
  picks.forEach(e=>{const b=document.createElement('button');b.textContent=e;b.onclick=()=>{document.getElementById('newCatEmoji').value=e;document.getElementById('emojiPreview').textContent=e;closeModal('Emoji')};grid.appendChild(b)});
  document.getElementById('mDate').value=new Date().toISOString().slice(0,10);
  document.getElementById('dDate').value=new Date().toISOString().slice(0,10);
  document.querySelectorAll('#segType button').forEach(b=>b.onclick=()=>toggleSeg('segType',b));
  document.querySelectorAll('#dSegFilter button').forEach(b=>b.onclick=()=>{toggleSeg('dSegFilter',b);drawDebts();});
  document.querySelectorAll('#segCurr button').forEach(b=>{b.onclick=()=>{toggleSeg('segCurr',b);viewCurr=b.dataset.val;drawHome();drawAll();drawDebts();refreshHeader();};});
  const fab=document.getElementById('openAdd');const fabOpen=()=>{ if(activeTab==='debts') openModal('Debt'); else openModal('Exp'); };['pointerup','touchend','click'].forEach(ev=>fab.addEventListener(ev,fabOpen,{passive:true}));
  const {data:{session}}=await supabase.auth.getSession();
  if(session?.user){sessionUser=session.user; showApp(); await Promise.all([ensureProfile(), ensureCategoriesSeed(), loadCategories(), loadExpenses(), loadDebts()]);}
  else showGate();
  supabase.auth.onAuthStateChange(async (_e,session)=>{if(session?.user){sessionUser=session.user; showApp(); await Promise.all([ensureProfile(), ensureCategoriesSeed(), loadCategories(), loadExpenses(), loadDebts()]);}else{sessionUser=null; showGate();}});
});
</script>
</body>
</html>
