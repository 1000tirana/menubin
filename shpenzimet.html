<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Normal Holding â€¢ Shpenzimet</title>
<meta name="theme-color" content="#0d1117" />

<!-- Material Symbols -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL@1,GRAD@0,opsz@24,wght@700" rel="stylesheet">
<style>
:root{
  --bg:#0d1117; --card:#161b22; --muted:#8b949e; --border:#30363d;
  --txt:#c9d1d9; --hi:#e6edf3; --g1:#2ea043; --g2:#238636; --blue:#1f6feb; --danger:#f85149;
  --navh:86px; --safe-b:env(safe-area-inset-bottom,0px); --safe-t:env(safe-area-inset-top,0px);
}
*{box-sizing:border-box} html,body{height:100%;background:var(--bg)}
body{margin:0;color:var(--txt);font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;-webkit-tap-highlight-color:transparent}

.material-symbols-rounded{font-variation-settings:'FILL' 1,'wght' 700,'GRAD' 0,'opsz' 24}
.iconbtn{width:46px;height:46px;border-radius:50%;display:grid;place-items:center;background:#21262d;border:1px solid var(--border);color:#e6edf3}

.wrap{display:flex;flex-direction:column;min-height:100vh;padding-bottom:calc(var(--navh)+var(--safe-b))}
header{
  padding:calc(10px + var(--safe-t)) 14px 14px;
  background:linear-gradient(135deg,var(--g2) 0%, var(--g1) 100%);
  color:#fff;border-bottom-left-radius:22px;border-bottom-right-radius:22px;
  box-shadow:0 10px 28px rgba(30,120,50,.35)
}
.h-top{display:flex;justify-content:space-between;align-items:center}
.h-title{display:flex;align-items:center;gap:8px;font-weight:900;font-size:18px;margin-top:4px}
.h-balance{font-size:32px;font-weight:900;margin:8px 0 2px}
.h-sub{opacity:.9}

.wallets{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.wallets .chip{border:1px solid rgba(255,255,255,.35);color:#03300f;background:radial-gradient(circle at 30% 20%, #eafff1 0%, #c8f0d6 50%, #2ea043 100%);
  padding:8px 12px;border-radius:12px;font-weight:900;cursor:pointer}
.wallets .chip.off{background:#1f232a;color:#e6edf3;border-color:#3a3f47}

.stats{display:flex;gap:10px;padding:10px 12px 0;transform:translateY(-10px)}
.card{flex:1;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
.card .n{color:var(--muted);font-size:12px} .card .v{font-weight:900;color:#e6edf3;font-size:18px;margin-top:2px}

main{padding:0 12px 20px}
h3.sec{margin:8px 0 6px}
.list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
.item{display:flex;align-items:center;gap:12px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
.ic{width:46px;height:46px;border-radius:50%;display:grid;place-items:center;background:#1e232a;border:1px solid var(--border);font-size:24px}
.meta{flex:1} .meta .t{font-weight:800;color:#e6edf3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta .s{font-size:12px;color:var(--muted)} .amt{font-weight:900}
.del{background:transparent;border:none;font-size:20px;cursor:pointer;color:var(--danger)}

.row{display:flex;gap:10px}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--txt);font-size:16px}
label{font-size:12px;color:var(--muted)}
.btnP{background:linear-gradient(180deg,var(--g1) 0%, var(--g2) 100%);border:1px solid #2ea043;color:#fff;border-radius:12px;padding:12px 14px;font-weight:900;cursor:pointer}
.btnS{background:#21262d;border:1px solid var(--border);color:#e6edf3;border-radius:12px;padding:12px 14px;font-weight:900;cursor:pointer}
.actions{display:flex;gap:10px;margin-top:10px}

.nav{position:fixed;left:0;right:0;bottom:0;height:calc(var(--navh)+var(--safe-b));padding:0 12px var(--safe-b);
  background:var(--card);border-top:1px solid var(--border);display:grid;grid-template-columns:1fr 1fr 110px 1fr 1fr;align-items:center;z-index:9}
.nav a{justify-self:center;text-decoration:none;color:var(--muted);display:flex;flex-direction:column;align-items:center;gap:6px}
.nav a .round{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;background:#1f232a;border:1px solid var(--border)}
.nav a.active{color:#79c0ff}
.fab{position:absolute;left:50%;top:-24px;transform:translateX(-50%);width:64px;height:64px;border-radius:999px;display:grid;place-items:center;
  background:radial-gradient(circle at 30% 30%,#e6ffec 0%,#c7eed6 45%,#2ea043 100%);border:1px solid rgba(255,255,255,.06);font-size:30px}

.tab{display:none}.tab.active{display:block}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:end;padding:14px}
.modal.on{display:grid}
.sheet{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 14px 18px;width:100%}
.gate{position:fixed;inset:0;display:none;place-items:center;background:var(--bg);padding:18px}
.panel{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;width:min(520px,94vw)}
.tabs{display:flex;gap:6px;margin:8px 0} .tabs button{flex:1} .tabs .active{background:linear-gradient(180deg,var(--g1) 0%, var(--g2) 100%);color:#fff;border-color:#2ea043}

details.box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px 12px}
details.box>summary{cursor:pointer;font-weight:800;list-style:none;color:#e6edf3}
details.box>summary::-webkit-details-marker{display:none}

.badge{display:inline-block;background:#1f6feb;color:#fff;font-size:11px;padding:3px 7px;border-radius:999px}
.rate{font-size:12px;color:#062b10;background:#eafff1;border:1px solid #bde7c9;padding:6px 8px;border-radius:10px;display:inline-flex;gap:6px;align-items:center;color:#1a3b24}
@media(min-width:720px){.wrap{max-width:520px;margin:0 auto}}
</style>
</head>
<body>

<!-- Auth -->
<div id="gate" class="gate">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900">Normal Holding</div>
      <div class="rate"><span class="material-symbols-rounded">cloud</span> Shpenzimet â€¢ Cloud</div>
    </div>
    <div class="tabs">
      <button id="btnLg" class="btnS active" onclick="authMode('login')">Hyr</button>
      <button id="btnRg" class="btnS" onclick="authMode('reg')">Regjistrohu</button>
    </div>
    <div id="boxLogin">
      <label>Email</label><input id="lgEmail" autocomplete="username" placeholder="user@mail.com">
      <div class="row" style="margin-top:8px"><div style="flex:1"><label>FjalÃ«kalimi</label><input id="lgPass" type="password" autocomplete="current-password"></div></div>
      <div class="actions"><button class="btnP" onclick="doLogin()">Hyr</button></div>
      <div id="lgMsg" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="boxReg" style="display:none">
      <label>Email</label><input id="rgEmail" placeholder="user@mail.com">
      <div class="row" style="margin-top:8px"><div style="flex:1"><label>FjalÃ«kalimi</label><input id="rgPass" type="password" autocomplete="new-password" placeholder="min. 6"></div></div>
      <div class="actions"><button class="btnS" onclick="authMode('login')">Kthehu</button><button class="btnP" onclick="doRegister()">Krijo</button></div>
      <div id="rgMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- App -->
<div id="app" class="wrap" style="display:none">
  <header>
    <div class="h-top">
      <div class="h-title"><span class="material-symbols-rounded">account_balance_wallet</span><span id="hdrTitle">Bilanci</span></div>
      <div id="who" class="badge">@user</div>
    </div>
    <div class="h-balance" id="hdrBal">0</div>
    <div class="h-sub" id="hdrSub">Gjendja â€“ Shpenzime (monedha e zgjedhur)</div>

    <!-- CÃ¼zdan seÃ§ici: gÃ¶rÃ¼ntÃ¼leme (persist etmez) -->
    <div class="wallets" id="walletChips"></div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <div class="rate"><span class="material-symbols-rounded">trending_up</span> <span id="rateLine">â€”</span></div>
      <div class="rate"><span class="material-symbols-rounded">savings</span> <b>Totale (tÃ« gjitha cÃ¼zdanÃ«t):</b>&nbsp;<span id="netWorth">â€”</span></div>
    </div>
  </header>

  <div class="stats">
    <div class="card"><div class="n" id="s1n">Totale</div><div class="v" id="s1v">0</div></div>
    <div class="card"><div class="n" id="s2n">Sot</div><div class="v" id="s2v">0</div></div>
    <div class="card"><div class="n" id="s3n">Muaj</div><div class="v" id="s3v">0</div></div>
  </div>

  <main>
    <!-- HOME -->
    <section id="tab-home" class="tab active">
      <h3 class="sec">ğŸ•’ TÃ« fundit</h3>
      <div id="homeList" class="list"></div>
      <div id="homeEmpty" class="muted" style="text-align:center;margin-top:8px">AsnjÃ« hyrje.</div>
    </section>

    <!-- LIST -->
    <section id="tab-list" class="tab">
      <h3 class="sec">ğŸ“š Lista (tÃ« gjitha monedhat)</h3>
      <div class="row" style="margin:6px 0 10px">
        <input id="q" placeholder="KÃ«rko..." oninput="drawList()">
        <select id="fCurr" onchange="drawList()">
          <option value="">TÃ« gjitha</option>
          <option>ALL</option><option>EUR</option><option>TRY</option><option>USD</option>
        </select>
      </div>
      <div id="fullList" class="list"></div>
    </section>

    <!-- DEBTS -->
    <section id="tab-debts" class="tab">
      <h3 class="sec">ğŸ’³ Borxhet</h3>
      <div class="row" style="margin:6px 0 10px">
        <input id="dq" placeholder="KÃ«rko..." oninput="drawDebts()">
        <select id="dCurr" onchange="drawDebts()">
          <option value="">TÃ« gjitha</option><option>ALL</option><option>EUR</option><option>TRY</option><option>USD</option>
        </select>
      </div>
      <div id="debtList" class="list"></div>
      <div id="debtEmpty" class="muted" style="text-align:center;margin-top:8px">AsnjÃ« borxh.</div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="tab">
      <h3 class="sec">âš™ï¸ CilÃ«sime</h3>

      <div class="item">
        <div class="ic"><span class="material-symbols-rounded">person</span></div>
        <div class="meta"><div class="t">PÃ«rdoruesi</div><div class="s" id="userMail">â€”</div></div>
        <button class="iconbtn" title="Dil" onclick="logout()"><span class="material-symbols-rounded">logout</span></button>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row">
          <div style="flex:1">
            <label>Monedha bazÃ« (hyrjet e reja & varsayÄ±lan gÃ¶rÃ¼nÃ¼m)</label>
            <select id="prefCurrency"><option>ALL</option><option>EUR</option><option>TRY</option><option>USD</option></select>
          </div>
          <div style="flex:1">
            <label>Formati</label>
            <select id="prefFormat">
              <option value="eu">23.456,78</option>
              <option value="us">23,456.78</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Gjuha / Dil</label>
            <select id="prefLang"><option value="sq">Shqip</option><option value="tr">TÃ¼rkÃ§e</option><option value="en">English</option><option value="it">Italiano</option></select>
          </div>
        </div>
        <div class="actions"><button class="btnP" onclick="savePrefs()">Ruaj preferencat</button></div>
      </div>

      <div class="card" style="margin-top:12px">
        <label>Gjendja e monedhÃ«s aktuale: <b id="balCurr">ALL</b></label>
        <div class="row" style="margin-top:6px"><input id="balInput" type="number" step="0.01" placeholder="p.sh. 5000"></div>
        <div class="actions"><button class="btnP" onclick="saveBalance()">Ruaj gjendjen</button></div>
        <div id="balMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>
    </section>
  </main>
</div>

<!-- NAV -->
<nav id="nav" class="nav" style="display:none">
  <a data-tab="home" class="active" onclick="switchTab('home')"><span class="round"><span class="material-symbols-rounded">home</span></span><small>Kreu</small></a>
  <a data-tab="list" onclick="switchTab('list')"><span class="round"><span class="material-symbols-rounded">list_alt</span></span><small>Lista</small></a>
  <button class="fab" id="fab" title="Shto"><span class="material-symbols-rounded">add</span></button>
  <a data-tab="debts" onclick="switchTab('debts')"><span class="round"><span class="material-symbols-rounded">credit_card</span></span><small>Borxhet</small></a>
  <a data-tab="settings" onclick="switchTab('settings')"><span class="round"><span class="material-symbols-rounded">settings</span></span><small>CilÃ«sime</small></a>
</nav>

<!-- MODALS -->
<div id="mExp" class="modal"><div class="sheet">
  <h3 style="margin:0 0 10px">â• Shto shpenzim</h3>
  <div class="row"><div style="flex:2"><label>Emri</label><input id="eName" placeholder="p.sh. Karburant"></div><div style="flex:1"><label>Shuma</label><input id="eAmt" type="number" step="0.01"></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label>Kategoria</label><input id="eCat" placeholder="p.sh. Ushqime"></div><div style="flex:1"><label>Data</label><input id="eDate" type="date"></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label>Monedha (ruhen bÃ¶yle)</label><select id="eCurr"><option>ALL</option><option>EUR</option><option>TRY</option><option>USD</option></select></div></div>
  <div class="actions"><button class="btnS" onclick="closeM('mExp')">Mbyll</button><button class="btnP" onclick="saveExpense()">Ruaj</button></div>
</div></div>

<div id="mDebt" class="modal"><div class="sheet">
  <h3 style="margin:0 0 10px">â• Shto borxh</h3>
  <div class="row"><div style="flex:1"><label>PalÃ«</label><input id="pName" placeholder="p.sh. Arben"></div><div style="flex:1"><label>Shuma</label><input id="pAmt" type="number" step="0.01"></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label>Lloji</label><select id="pKind"><option value="borrow">Mora hua</option><option value="lend">Dhash hua</option></select></div><div style="flex:1"><label>Afati</label><input id="pDue" type="date"></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label>Monedha</label><select id="pCurr"><option>ALL</option><option>EUR</option><option>TRY</option><option>USD</option></select></div></div>
  <div class="actions"><button class="btnS" onclick="closeM('mDebt')">Mbyll</button><button class="btnP" onclick="saveDebt()">Ruaj</button></div>
</div></div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ==== Supabase: kendi projenle deÄŸiÅŸtir ==== */
const SUPABASE_URL  = 'https://YOUR-PROJECT.supabase.co';
const SUPABASE_ANON = 'YOUR-ANON-KEY';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ==== State ==== */
let user=null;
let items=[], debts=[];
let profile={default_currency:'ALL',num_format:'eu',balances:{},lang:'sq'};
let viewCurr='ALL'; // Ã¼stte geÃ§ici gÃ¶rÃ¼nÃ¼m
let rates={};       // canlÄ± kurlar

const CURRENCIES=['ALL','EUR','TRY','USD'];

/* ==== Utils ==== */
const $=id=>document.getElementById(id);
const todayStr=()=>new Date().toISOString().slice(0,10);
const nf=()=> new Intl.NumberFormat(profile.num_format==='us'?'en-US':'de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
const money=(n,c=viewCurr)=> nf().format(Number(n||0))+' '+c;
const sum=a=>a.reduce((s,x)=>s+Number(x||0),0);
const dEq=(a,b)=> new Date(a).toDateString()===new Date(b).toDateString();
const sameMonth=(d)=>{const t=new Date(),x=new Date(d);return t.getFullYear()==x.getFullYear()&&t.getMonth()==x.getMonth()}

/* ==== Live FX ==== */
async function loadRates(base=viewCurr){
  try{
    const res = await fetch(`https://api.exchangerate.host/latest?base=${base}&symbols=${CURRENCIES.join(',')}`);
    const j=await res.json(); rates=j.rates||{};
    $('rateLine').textContent=`1 ${base} = ${CURRENCIES.filter(x=>x!==base).map(c=>nf().format(rates[c])+' '+c).join(' â€¢ ')}`;
  }catch{ $('rateLine').textContent='â€”'; }
}
function convert(amount, from, to){
  if(from===to) return Number(amount||0);
  // EÄŸer oranlar base=viewCurr ise cross hesap:
  // from -> base -> to
  const base=viewCurr;
  let map=rates;
  // EÄŸer base=viewCurr deÄŸilse Ã¶nce loadRates Ã§aÄŸrÄ±lÄ±râ€¦
  if(base!==to){/* yaklaÅŸÄ±k */ }
  // amount (from) -> viewCurr
  // 1 base = rates[X] X
  // 1 X = 1/rates[X] base
  const toBase = (amt, f)=>{
    if(f===base) return amt;
    if(!rates[f]) return amt; // tahmini
    return amt / rates[f];
  }
  const baseAmt=toBase(Number(amount||0), from);
  if(to===base) return baseAmt;
  if(!rates[to]) return baseAmt; // tahmini
  return baseAmt * rates[to];
}

/* ==== UI ==== */
function authMode(m){$('btnLg').classList.toggle('active',m==='login');$('btnRg').classList.toggle('active',m==='reg');$('boxLogin').style.display=m==='login'?'block':'none';$('boxReg').style.display=m==='reg'?'block':'none'}
function showApp(){ $('gate').style.display='none'; $('app').style.display='block'; $('nav').style.display='grid'; $('who').textContent='@'+(user.email||'user').split('@')[0]; $('userMail').textContent=user.email||'â€”' }
function showGate(){ $('gate').style.display='grid'; $('app').style.display='none'; $('nav').style.display='none' }
function switchTab(t){ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); $('tab-'+t).classList.add('active'); document.querySelectorAll('.nav a').forEach(a=>a.classList.toggle('active',a.dataset.tab===t)); refreshHeader(); if(t==='list') drawList(); if(t==='debts') drawDebts(); }
function openM(id){$(id).classList.add('on')} function closeM(id){$(id).classList.remove('on')}

function buildWalletChips(){
  const box=$('walletChips'); box.innerHTML='';
  CURRENCIES.forEach(c=>{
    const b=document.createElement('div'); b.className='chip '+(c===viewCurr?'':'off'); b.textContent=c; b.onclick=()=>{viewCurr=c; buildWalletChips(); $('balCurr').textContent=c; // gÃ¶rÃ¼nÃ¼m geÃ§ici
      $('eCurr').value=profile.default_currency; // yeni kayÄ±tlar ayar para birimiyle
      refreshHeader(); loadRates(c);
    };
    box.appendChild(b);
  });
}

function rowExpense(x){
  const el=document.createElement('div'); el.className='item';
  const ic=document.createElement('div'); ic.className='ic'; ic.textContent='ğŸ’¸';
  const meta=document.createElement('div'); meta.className='meta';
  const t=document.createElement('div'); t.className='t'; t.textContent=x.name;
  const s=document.createElement('div'); s.className='s'; s.textContent=[x.category||'â€”', new Date(x.d).toLocaleDateString(), x.curr].join(' â€¢ ');
  const amt=document.createElement('div'); amt.className='amt'; amt.textContent=money(convert(x.amount,x.curr,viewCurr), viewCurr);
  const bin=document.createElement('button'); bin.className='del'; bin.textContent='ğŸ—‘ï¸'; bin.onclick=()=>delExpense(x.id);
  meta.appendChild(t); meta.appendChild(s);
  el.append(ic,meta,amt,bin); return el;
}
function rowDebt(x){
  const el=document.createElement('div'); el.className='item';
  const ic=document.createElement('div'); ic.className='ic'; ic.textContent=x.status==='paid'?'âœ…':'ğŸ’³';
  const meta=document.createElement('div'); meta.className='meta';
  const t=document.createElement('div'); t.className='t'; t.textContent=x.party||'(pa emÃ«r)';
  const s=document.createElement('div'); s.className='s'; s.textContent=[x.kind==='borrow'?'Mora hua':'Dhash hua', x.name||'', x.due?('Afati: '+new Date(x.due).toLocaleDateString()):'', x.curr].filter(Boolean).join(' â€¢ ');
  const amt=document.createElement('div'); amt.className='amt'; amt.textContent=money(convert(x.amount,x.curr,viewCurr), viewCurr);
  const bin=document.createElement('button'); bin.className='del'; bin.textContent='ğŸ—‘ï¸'; bin.onclick=()=>delDebt(x.id);
  meta.appendChild(t); meta.appendChild(s);
  el.append(ic,meta,amt,bin); return el;
}

/* ==== Header / draw ==== */
function refreshHeader(){
  // stats sadece gÃ¶rÃ¼nÃ¼m para birimi Ã¼zerinden
  const arr=items.map(x=>({amt:convert(x.amount,x.curr,viewCurr), d:x.d}));
  const total = sum(arr.map(x=>x.amt));
  const today = sum(arr.filter(x=>dEq(x.d,todayStr())).map(x=>x.amt));
  const month = sum(arr.filter(x=>sameMonth(x.d)).map(x=>x.amt));
  // cÃ¼zdan bakiyesi (yalnÄ±z seÃ§ili cÃ¼zdan)
  const wallet = Number(profile.balances?.[viewCurr]||0) - total;
  $('hdrBal').textContent = nf().format(wallet)+' '+viewCurr;
  $('s1v').textContent = nf().format(total)+' '+viewCurr;
  $('s2v').textContent = nf().format(today)+' '+viewCurr;
  $('s3v').textContent = nf().format(month)+' '+viewCurr;

  // Net worth = tÃ¼m cÃ¼zdan bakiyeleri (bal+/-) seÃ§ili kurâ€™a Ã§evrilmiÅŸ
  const worth = CURRENCIES
      .map(c=> convert(Number(profile.balances?.[c]||0), c, viewCurr)
                 - sum(items.filter(i=>i.curr===c).map(i=>convert(i.amount,c,viewCurr))) )
      .reduce((a,b)=>a+b,0);
  $('netWorth').textContent = nf().format(worth)+' '+viewCurr;

  // fill inputs / labels
  $('balCurr').textContent=viewCurr;
}
function drawHome(){
  const box=$('homeList'); box.innerHTML='';
  const recent=[...items].sort((a,b)=>b.d.localeCompare(a.d)).slice(0,8);
  recent.forEach(x=>box.appendChild(rowExpense(x)));
  $('homeEmpty').style.display=recent.length?'none':'block';
}
function drawList(){
  const q=($('q').value||'').toLowerCase(), f=($('fCurr').value||'');
  const box=$('fullList'); box.innerHTML='';
  let arr=[...items];
  if(q) arr=arr.filter(x=>x.name.toLowerCase().includes(q)||(x.category||'').toLowerCase().includes(q));
  if(f) arr=arr.filter(x=>x.curr===f);
  arr.sort((a,b)=>b.d.localeCompare(a.d)).forEach(x=>box.appendChild(rowExpense(x)));
}
function drawDebts(){
  const q=($('dq').value||'').toLowerCase(), f=($('dCurr').value||'');
  const box=$('debtList'); box.innerHTML='';
  let arr=[...debts];
  if(q) arr=arr.filter(x=>(x.party||'').toLowerCase().includes(q)||(x.name||'').toLowerCase().includes(q));
  if(f) arr=arr.filter(x=>x.curr===f);
  arr.forEach(x=>box.appendChild(rowDebt(x)));
  $('debtEmpty').style.display=arr.length?'none':'block';
}

/* ==== Data ==== */
async function ensureProfile(){
  const {data} = await sb.from('profiles').select('*').eq('user_id',user.id).maybeSingle();
  if(!data){
    const {data:p}=await sb.from('profiles').insert({user_id:user.id,default_currency:'ALL',num_format:'eu',balances:{},lang:'sq'}).select().single();
    Object.assign(profile,p);
  }else Object.assign(profile,data);
  // gÃ¶rÃ¼nÃ¼m ayarÄ±
  viewCurr = profile.default_currency || 'ALL';
  $('prefCurrency').value=profile.default_currency||'ALL';
  $('prefFormat').value=profile.num_format||'eu';
  $('prefLang').value=profile.lang||'sq';
  buildWalletChips();
  await loadRates(viewCurr);
}
async function savePrefs(){
  const dc=$('prefCurrency').value, fmt=$('prefFormat').value, lang=$('prefLang').value;
  const {data,error}=await sb.from('profiles').update({default_currency:dc,num_format:fmt,lang}).eq('user_id',user.id).select().single();
  if(!error){ Object.assign(profile,data); viewCurr=profile.default_currency; buildWalletChips(); refreshHeader(); await loadRates(viewCurr); }
}
async function saveBalance(){
  const v=parseFloat($('balInput').value)||0;
  const bal={...(profile.balances||{})}; bal[viewCurr]=v;
  const {data,error}=await sb.from('profiles').update({balances:bal}).eq('user_id',user.id).select().single();
  $('balMsg').textContent = error?('Gabim: '+error.message):'U ruajt.';
  if(!error){ profile=data; refreshHeader(); }
}
async function loadExpenses(){
  const {data,error}=await sb.from('expenses').select('*').eq('user_id',user.id).order('d',{ascending:false}).limit(2000);
  if(!error){ items=data||[]; drawHome(); drawList(); refreshHeader(); }
}
async function saveExpense(){
  const row={user_id:user.id,name:$('eName').value.trim(),amount:parseFloat($('eAmt').value),category:$('eCat').value.trim(),d:$('eDate').value||todayStr(),curr:$('eCurr').value};
  if(!row.name||!row.amount){alert('Emri & shuma!');return;}
  const {data,error}=await sb.from('expenses').insert(row).select().single();
  if(error){alert(error.message);return;}
  items.unshift(data); closeM('mExp'); $('eName').value=''; $('eAmt').value=''; drawHome(); drawList(); refreshHeader();
}
async function delExpense(id){ if(!confirm('Fshije?')) return; const {error}=await sb.from('expenses').delete().eq('id',id).eq('user_id',user.id); if(!error){items=items.filter(x=>x.id!==id); drawHome(); drawList(); refreshHeader();}}

async function loadDebts(){
  const {data,error}=await sb.from('debts').select('*').eq('user_id',user.id).order('created_at',{ascending:false}).limit(2000);
  if(!error){ debts=data||[]; drawDebts(); refreshHeader(); }
}
async function saveDebt(){
  const row={user_id:user.id,party:$('pName').value.trim(),amount:parseFloat($('pAmt').value),kind:$('pKind').value,due:$('pDue').value||null,status:'open',curr:$('pCurr').value};
  if(!row.party||!row.amount){alert('PalÃ« & shuma!');return;}
  const {data,error}=await sb.from('debts').insert(row).select().single();
  if(error){alert(error.message);return;}
  debts.unshift(data); closeM('mDebt'); $('pName').value=''; $('pAmt').value=''; drawDebts(); refreshHeader();
}
async function delDebt(id){ if(!confirm('Fshije?')) return; const {error}=await sb.from('debts').delete().eq('id',id).eq('user_id',user.id); if(!error){debts=debts.filter(x=>x.id!==id); drawDebts(); refreshHeader();}}

/* ==== Auth ==== */
async function doRegister(){ const e=$('rgEmail').value, p=$('rgPass').value; const {error}=await sb.auth.signUp({email:e,password:p}); $('rgMsg').textContent=error?('Gabim: '+error.message):'U dÃ«rgua email verifikimi.' }
async function doLogin(){ const e=$('lgEmail').value, p=$('lgPass').value; const {error}=await sb.auth.signInWithPassword({email:e,password:p}); $('lgMsg').textContent=error?('Gabim: '+error.message):'' }
async function logout(){ await sb.auth.signOut() }

/* ==== Boot ==== */
document.addEventListener('DOMContentLoaded', async ()=>{
  $('fab').onclick=()=>{ if(document.querySelector('.tab.active')===$('tab-debts')) openM('mDebt'); else openM('mExp'); };
  $('eDate').value=todayStr(); $('pDue').value=todayStr();

  const {data:{session}}=await sb.auth.getSession();
  if(session?.user){ user=session.user; showApp(); await ensureProfile(); await Promise.all([loadExpenses(),loadDebts()]); }
  else showGate();

  sb.auth.onAuthStateChange(async (_e,s)=>{
    if(s?.user){ user=s.user; showApp(); await ensureProfile(); await Promise.all([loadExpenses(),loadDebts()]); }
    else{ user=null; showGate(); }
  });
});
</script>
</body>
</html>
