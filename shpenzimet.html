<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>Normal Holding • Shpenzimet</title>
<meta name="theme-color" content="#0d1117">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Material+Symbols+Rounded:FILL@0..1&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d1117; --card:#161b22; --muted:#8b949e; --text:#c9d1d9;
  --border:#30363d; --primary:#2ea043; --primary2:#238636; --blue:#1f6feb; --danger:#f85149;
  --safe-top:env(safe-area-inset-top,0px); --safe-bottom:env(safe-area-inset-bottom,0px);
  --nav-h:86px;
}
*{box-sizing:border-box}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overscroll-behavior:none}
body{margin:0}
a{color:inherit;text-decoration:none}
.wrap{min-height:100vh;display:flex;flex-direction:column;padding-bottom:calc(var(--nav-h)+var(--safe-bottom))}
header{
  background:linear-gradient(135deg,var(--primary2),var(--primary));
  color:#fff;border-bottom-left-radius:22px;border-bottom-right-radius:22px;
  padding:calc(12px + var(--safe-top)) 14px 12px; box-shadow:0 10px 28px rgba(35,134,54,.35)
}
.h-top{display:flex;justify-content:space-between;align-items:center;font-weight:800}
.h-title{display:flex;gap:8px;align-items:center;margin-top:6px}
.h-big{font-size:32px;font-weight:800;margin-top:6px}
.h-sub{opacity:.85}
.stat-row{display:flex;gap:10px;padding:10px 12px;transform:translateY(-10px)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;flex:1}
main{padding:0 12px 18px}
h3{margin:0 0 10px}
.list{display:flex;flex-direction:column;gap:10px}
.item{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
.i-ico{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;
  background:#111; color:#9ee2a1; border:1px solid #1f2a22}
.i-ico .ms{font-size:26px}
.meta{flex:1}
.meta .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta .s{font-size:12px;color:var(--muted)}
.amt{font-weight:800}
.btnx{border:none;border-radius:10px;padding:10px 12px;background:#21262d;border:1px solid var(--border);color:#e6edf3;cursor:pointer;font-weight:800}
.btnp{background:linear-gradient(180deg,var(--primary),var(--primary2));border-color:#2ea043;color:#fff}
.btns{background:#21262d}
.badge{display:inline-block;border-radius:999px;padding:4px 8px;font-size:12px;background:#1f6feb;color:#fff}
.row{display:flex;gap:10px}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text);font-size:16px}
label{font-size:13px;color:var(--muted)}
.chips{display:flex;gap:8px;margin-top:8px}
.chips button{border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.15);color:#fff;border-radius:999px;padding:6px 10px;font-weight:800}
.chips button.active{background:#0b3d2a}

/* NAV + FAB */
nav.nav{
  position:fixed;left:0;right:0;bottom:0;height:var(--nav-h);padding:8px 16px calc(8px + var(--safe-bottom));
  background:var(--card);border-top:1px solid var(--border);
  display:grid;grid-template-columns:1fr 1fr 90px 1fr 1fr;align-items:center;gap:8px;z-index:50
}
.nbtn{justify-self:center;display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted)}
.nbtn .round{width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:#0f1a13;border:1px solid #1e2a22}
.nbtn .ms{font-size:26px}
.nbtn.active{color:#79c0ff}
.fab{position:absolute;left:50%;transform:translateX(-50%);top:-26px;width:64px;height:64px;border-radius:50%;
  background:#1b3526;border:1px solid #274a37;display:grid;place-items:center;box-shadow:0 18px 30px rgba(0,0,0,.55)}
.fab .ms{font-size:32px;color:#9ee2a1}

/* MODALS */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:end;padding:14px;z-index:60}
.modal.on{display:grid}
.sheet{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px;width:100%}
.picker{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;max-height:46vh;overflow:auto}
.pick{border:1px solid var(--border);border-radius:10px;background:#21262d;height:46px;font-size:24px}

/* AUTH */
.gate{position:fixed;inset:0;display:none;place-items:center;background:var(--bg);padding:18px}
.panel{width:min(540px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
.tabs{display:flex;gap:6px;margin-bottom:8px}
.tabbtn{flex:1} .tabbtn.active{background:linear-gradient(180deg,var(--primary),var(--primary2));border-color:#2ea043;color:#fff}

/* small tweaks */
small.muted{color:var(--muted)}
@media(min-width:720px){.wrap{max-width:640px;margin:0 auto}}
</style>
</head>
<body>

<!-- GATE -->
<div id="gate" class="gate">
  <div class="panel">
    <div class="h-top" style="margin-bottom:6px"><div style="font-weight:800">Normal Holding</div><small class="muted">cloud</small></div>
    <div class="tabs">
      <button id="bLogin" class="btnx tabbtn active" onclick="swapAuth('login')">Hyr</button>
      <button id="bReg" class="btnx tabbtn" onclick="swapAuth('reg')">Regjistrohu</button>
    </div>
    <div id="authLogin">
      <label>Email</label><input id="loginEmail" placeholder="emri@gmail.com" autocomplete="username">
      <div class="row" style="margin-top:8px"><div style="flex:1"><label>Fjalëkalimi</label><input id="loginPass" type="password" autocomplete="current-password" placeholder="••••••"></div></div>
      <div class="row" style="margin-top:10px"><button class="btnx btnp" style="flex:1" onclick="login()">Hyr</button></div>
      <div id="authMsg" class="muted" style="margin-top:8px"></div>
    </div>
    <div id="authReg" style="display:none">
      <label>Email</label><input id="regEmail" placeholder="emri@gmail.com" autocomplete="username">
      <div class="row" style="margin-top:8px"><div style="flex:1"><label>Fjalëkalimi</label><input id="regPass" type="password" autocomplete="new-password" placeholder="min. 6"></div></div>
      <div class="row" style="margin-top:10px"><button class="btnx" style="flex:1" onclick="swapAuth('login')">Kthehu</button><button class="btnx btnp" style="flex:1" onclick="registerUser()">Krijo</button></div>
      <div id="regMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="wrap" style="display:none">
  <header>
    <div class="h-top"><div style="font-weight:800">Normal Holding</div><div id="who" class="h-sub">@user</div></div>
    <div class="h-title"><span class="material-symbols-rounded">account_balance_wallet</span><b id="hdrText">Bilanci</b></div>
    <div class="h-big" id="walletVal">0</div>
    <div class="h-sub" id="walletSub">Gjendja − Shpenzimet (totale)</div>
    <div class="chips">
      <button id="chipALL" onclick="setView('ALL')">ALL</button>
      <button id="chipEUR" onclick="setView('EUR')">EUR</button>
      <button id="chipTRY" onclick="setView('TRY')">TRY</button>
    </div>
  </header>

  <div class="stat-row">
    <div class="card"><div class="h-sub">Totale</div><div style="font-weight:800" id="stTotal">0</div></div>
    <div class="card"><div class="h-sub">Sot</div><div style="font-weight:800" id="stToday">0</div></div>
    <div class="card"><div class="h-sub">Muaj</div><div style="font-weight:800" id="stMonth">0</div></div>
  </div>

  <main>
    <!-- HOME -->
    <section id="tab-home">
      <h3>🕒 Të fundit</h3>
      <div id="recentList" class="list"></div>
      <div id="emptyHome" class="muted" style="text-align:center;margin-top:10px">Asnjë hyrje deri tani.</div>

      <div class="row" style="margin-top:12px">
        <div class="card"><div class="h-sub">Shuma ALL</div><div id="sumALL" style="font-weight:800">0</div></div>
        <div class="card"><div class="h-sub">Shuma EUR</div><div id="sumEUR" style="font-weight:800">0</div></div>
        <div class="card"><div class="h-sub">Shuma TRY</div><div id="sumTRY" style="font-weight:800">0</div></div>
      </div>
    </section>

    <!-- LIST -->
    <section id="tab-list" style="display:none">
      <h3>📚 Lista</h3>
      <div class="row" style="margin:8px 0 10px">
        <input id="q" placeholder="Kërko..." oninput="drawAll()">
        <select id="fCurr" onchange="drawAll()">
          <option value="">Të gjitha</option>
          <option>ALL</option><option>EUR</option><option>TRY</option>
        </select>
      </div>
      <div id="allList" class="list"></div>
    </section>

    <!-- DEBTS -->
    <section id="tab-debts" style="display:none">
      <h3>💳 Borxhet</h3>
      <div class="row" style="margin:8px 0 10px"><input id="dq" placeholder="Kërko borxhe..." oninput="drawDebts()"></div>
      <div id="debtList" class="list"></div>
      <div id="emptyDebts" class="muted" style="text-align:center;margin-top:10px">Asnjë borxh.</div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" style="display:none">
      <h3 class="sec"><span class="material-symbols-rounded" style="vertical-align:-6px">settings</span> Cilësime</h3>

      <div class="item">
        <div class="i-ico"><span class="material-symbols-rounded ms">person</span></div>
        <div class="meta"><div class="t">Përdoruesi</div><div class="s" id="userInfo">—</div></div>
        <button class="btnx" onclick="logout()">Dil</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">💱 Monedha & format</h4>
        <div class="row">
          <div style="flex:2">
            <label>Monedha aktuale (për hyrjet e reja)</label>
            <select id="prefCurr">
              <option>ALL</option><option>EUR</option><option>TRY</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Formati i numrave</label>
            <select id="prefFmt">
              <option value="eu">23.456,78</option>
              <option value="us">23,456.78</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Gjuha</label>
            <select id="prefLang">
              <option value="sq">Shqip</option>
              <option value="tr">Türkçe</option>
              <option value="en">English</option>
              <option value="it">Italiano</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:10px"><button class="btnx btnp" style="flex:1" onclick="savePrefs()">Ruaj preferencat</button></div>
        <small id="prefMsg" class="muted"></small>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">👛 Gjendja e cüzdanit</h4>
        <div class="row">
          <div><label>ALL</label><input id="balALL" type="number" step="0.01" inputmode="decimal"></div>
          <div><label>EUR</label><input id="balEUR" type="number" step="0.01" inputmode="decimal"></div>
          <div><label>TRY</label><input id="balTRY" type="number" step="0.01" inputmode="decimal"></div>
        </div>
        <div class="row" style="margin-top:10px"><button class="btnx btnp" style="flex:1" onclick="saveBalances()">Ruaj gjendjen</button></div>
        <small id="balMsg" class="muted"></small>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">🏷️ Kategoriat</h4>
        <div id="catList" class="list"></div>
        <div class="row" style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px">
          <div style="width:140px">
            <label>Emoji</label>
            <button class="btnx" onclick="openPicker()"><span id="emPrev" style="font-size:22px">🍔</span> Zgjidh emoji</button>
            <input id="emVal" value="🍔" hidden>
          </div>
          <div style="flex:1">
            <label>Emri i kategorisë</label>
            <input id="catName" placeholder="p.sh. Ushqime">
          </div>
          <div><label>&nbsp;</label><button class="btnx btnp" onclick="addCategory()">Shto kategori</button></div>
        </div>
        <small id="catMsg" class="muted"></small>
      </div>
    </section>
  </main>
</div>

<!-- NAV -->
<nav class="nav" id="navbar" style="display:none">
  <a class="nbtn active" data-tab="home" onclick="switchTab('home')"><span class="round"><span class="material-symbols-rounded ms">home</span></span><small>Kreu</small></a>
  <a class="nbtn" data-tab="list" onclick="switchTab('list')"><span class="round"><span class="material-symbols-rounded ms">list</span></span><small>Lista</small></a>
  <button class="fab" id="fab"><span class="material-symbols-rounded ms">add</span></button>
  <a class="nbtn" data-tab="debts" onclick="switchTab('debts')"><span class="round"><span class="material-symbols-rounded ms">credit_card</span></span><small>Borxhet</small></a>
  <a class="nbtn" data-tab="settings" onclick="switchTab('settings')"><span class="round"><span class="material-symbols-rounded ms">settings</span></span><small>Cilësime</small></a>
</nav>

<!-- MODAL: Expense -->
<div class="modal" id="mExp"><div class="sheet">
  <h3>➕ Shto shpenzim</h3>
  <div class="row"><div style="flex:2"><label>Emri</label><input id="eName" placeholder="p.sh. Karburant"></div><div style="flex:1"><label>Shuma</label><input id="eAmt" type="number" step="0.01" inputmode="decimal"></div></div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label>Kategoria</label><select id="eCat"></select></div>
    <div style="flex:1"><label>Data</label><input id="eDate" type="date"></div>
    <div style="width:120px"><label>Monedha</label><select id="eCurr"><option>ALL</option><option>EUR</option><option>TRY</option></select></div>
  </div>
  <div class="row" style="margin-top:10px"><button class="btnx" onclick="closeModal('mExp')">Mbyll</button><button class="btnx btnp" onclick="saveExpense()">Ruaj</button></div>
</div></div>

<!-- MODAL: Debt -->
<div class="modal" id="mDebt"><div class="sheet">
  <h3>➕ Shto borxh</h3>
  <div class="row"><div style="flex:1"><label>Palë</label><input id="dParty"></div><div style="flex:1"><label>Shuma</label><input id="dAmt" type="number" step="0.01" inputmode="decimal"></div></div>
  <div class="row" style="margin-top:8px">
    <div style="width:120px"><label>Monedha</label><select id="dCurr"><option>ALL</option><option>EUR</option><option>TRY</option></select></div>
    <div style="flex:1"><label>Afati</label><input id="dDue" type="date"></div>
  </div>
  <div class="row" style="margin-top:10px"><button class="btnx" onclick="closeModal('mDebt')">Mbyll</button><button class="btnx btnp" onclick="saveDebt()">Ruaj</button></div>
</div></div>

<!-- MODAL: Emoji picker -->
<div class="modal" id="mPick"><div class="sheet">
  <h3>🙂 Zgjidh emoji</h3>
  <div id="pickGrid" class="picker"></div>
  <div class="row" style="margin-top:10px"><button class="btnx" style="flex:1" onclick="closeModal('mPick')">Mbyll</button></div>
</div></div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*** ====== CONFIG ====== ***/
const SUPABASE_URL = 'PASTE_SUPABASE_URL';
const SUPABASE_ANON_KEY = 'PASTE_SUPABASE_ANON_KEY';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let sessionUser=null;
let viewCurr='ALL';             // geçici görüntüleme
let prefs={ default_currency:'ALL', num_format:'eu', lang:'sq' };
let balances={ALL:0,EUR:0,TRY:0};
let cats=[], items=[], debts=[];
let rates={EUR:{EUR:1,ALL:0,TRY:0}, ALL:{ALL:1,EUR:0,TRY:0}, TRY:{TRY:1,EUR:0,ALL:0}};

/*** ====== UTIL ====== ***/
const $=sel=>document.querySelector(sel);
const setText=(id,v)=>{const el=document.getElementById(id); if(el) el.textContent=v};
function fmt(n,fmtKey=prefs.num_format){const v=Number(n||0); const opt={minimumFractionDigits:2, maximumFractionDigits:2};
  const loc=fmtKey==='eu'?'de-DE':'en-US'; return v.toLocaleString(loc,opt)}
function todayISO(){return new Date().toISOString().slice(0,10)}
function convert(amount,from,to){if(from===to) return amount; const r = rates[from]?.[to]||0; return Number(amount||0)*r}
function sum(a){return a.reduce((s,n)=>s+Number(n||0),0)}
function isToday(d){const t=new Date(), x=new Date(d); return t.getFullYear()==x.getFullYear()&&t.getMonth()==x.getMonth()&&t.getDate()==x.getDate()}
function isThisMonth(d){const t=new Date(), x=new Date(d); return t.getFullYear()==x.getFullYear()&&t.getMonth()==x.getMonth()}

/*** ====== AUTH ====== ***/
function swapAuth(which){$('#bLogin').classList.toggle('active',which==='login');$('#bReg').classList.toggle('active',which==='reg');$('#authLogin').style.display=which==='login'?'block':'none';$('#authReg').style.display=which==='reg'?'block':'none'}
async function registerUser(){const email=$('#regEmail').value.trim(), pass=$('#regPass').value, box=$('#regMsg'); box.textContent='';
  if(!email || pass.length<6){box.textContent='Email ose fjalëkalim i gabuar.'; return;}
  const {error}=await supabase.auth.signUp({email,password:pass}); box.textContent=error?('Gabim: '+error.message):'U krijua. Kontrollo email-in.'}
async function login(){const email=$('#loginEmail').value.trim(), pass=$('#loginPass').value, box=$('#authMsg'); box.textContent='';
  const {error}=await supabase.auth.signInWithPassword({email,password:pass}); if(error) box.textContent='Gabim: '+error.message}
async function logout(){await supabase.auth.signOut()}

/*** ====== APP LIFECYCLE ====== ***/
document.addEventListener('DOMContentLoaded', async ()=>{
  $('#eDate').value=todayISO(); $('#dDue').value=todayISO();
  buildPicker();

  const {data:{session}} = await supabase.auth.getSession();
  if(session?.user){ sessionUser=session.user; showApp(); await initialLoad(); } else showGate();

  supabase.auth.onAuthStateChange(async (_e, session)=>{
    if(session?.user){sessionUser=session.user; showApp(); await initialLoad();} else showGate();
  });

  $('#fab').addEventListener('click', ()=>{ if(activeTab==='debts') openModal('mDebt'); else openModal('mExp'); });
});
function showGate(){ $('#gate').style.display='grid'; $('#app').style.display='none'; $('#navbar').style.display='none' }
function showApp(){ $('#gate').style.display='none'; $('#app').style.display='block'; $('#navbar').style.display='grid' }

async function initialLoad(){
  $('#who').textContent=sessionUser.email.split('@')[0];
  await ensureProfile();
  await loadCategories();
  await Promise.all([loadExpenses(), loadDebts(), fetchRates()]);
  setView(prefs.default_currency, true); // true = kalıcıdan geldi
}

/*** ====== PROFILE / PREFS ====== ***/
async function ensureProfile(){
  const {data, error} = await supabase.from('profiles').select('*').eq('user_id', sessionUser.id).single();
  if(error && error.code==='PGRST116'){ // not found
    const insert={user_id:sessionUser.id, default_currency:'ALL', num_format:'eu', balances:{ALL:0,EUR:0,TRY:0}, lang:localStorage.getItem('lang')||'sq'};
    const {data:created}=await supabase.from('profiles').insert(insert).select().single(); prefs=created; balances=created.balances||balances;
  } else { prefs=data; balances=data.balances||balances; }
  // UI bind
  $('#prefCurr').value=prefs.default_currency||'ALL';
  $('#prefFmt').value=prefs.num_format||'eu';
  $('#prefLang').value=prefs.lang||'sq';
  $('#balALL').value=balances.ALL||0; $('#balEUR').value=balances.EUR||0; $('#balTRY').value=balances.TRY||0;
  $('#userInfo').textContent=sessionUser.email;
  localStorage.setItem('lang', prefs.lang||'sq');
}
async function savePrefs(){
  const next={ default_currency:$('#prefCurr').value, num_format:$('#prefFmt').value, lang:$('#prefLang').value };
  const {data,error}=await supabase.from('profiles').update(next).eq('user_id',sessionUser.id).select().single();
  $('#prefMsg').textContent=error?('Gabim: '+error.message):'U ruajt.';
  if(!error){ prefs={...prefs,...next}; localStorage.setItem('lang', prefs.lang); setView(prefs.default_currency,true); refreshHeader(); }
}
async function saveBalances(){
  const next={ ALL:Number($('#balALL').value||0), EUR:Number($('#balEUR').value||0), TRY:Number($('#balTRY').value||0) };
  const {data,error}=await supabase.from('profiles').update({balances:next}).eq('user_id',sessionUser.id).select().single();
  $('#balMsg').textContent=error?('Gabim: '+error.message):'U ruajt.';
  if(!error){ balances=next; refreshHeader(); }
}

/*** ====== CURRENCIES / RATES ====== ***/
async function fetchRates(){
  try{
    // 1 EUR bazlı çekip ALL ve TRY al, sonra ikincil dönüşümleri oluştur
    const r1=await fetch('https://api.exchangerate.host/latest?base=EUR&symbols=ALL,TRY,EUR').then(r=>r.json());
    rates.EUR.ALL=r1.rates.ALL; rates.EUR.TRY=r1.rates.TRY; rates.EUR.EUR=1;
    rates.ALL.EUR=1/r1.rates.ALL; rates.TRY.EUR=1/r1.rates.TRY;
    rates.ALL.TRY=r1.rates.TRY/r1.rates.ALL; rates.TRY.ALL=r1.rates.ALL/r1.rates.TRY;
    rates.ALL.ALL=1; rates.TRY.TRY=1;
  }catch(e){ console.warn('rate fetch fail',e) }
}

/*** ====== TABS ====== ***/
let activeTab='home';
function switchTab(t){ activeTab=t;
  document.querySelectorAll('[data-tab]').forEach(x=>x.classList.remove('active'));
  document.querySelector(`[data-tab="${t}"]`)?.classList.add('active');
  ['home','list','debts','settings'].forEach(id=>document.getElementById('tab-'+id)?.style?.display='none');
  document.getElementById('tab-'+t).style.display='block';
  refreshHeader(); if(t==='list') drawAll(); if(t==='debts') drawDebts();
}

/*** ====== HEADER / CHIPS ====== ***/
function setView(curr,fromDefault=false){
  viewCurr=curr;
  ['ALL','EUR','TRY'].forEach(k=>document.getElementById('chip'+k).classList.toggle('active',k===curr));
  refreshHeader();
  if(fromDefault) return;
  // geçici sadece görünüm değişir
}
function refreshHeader(){
  // Cüzdanım: seçili görünüm birimine göre (balances[curr] - expenses in that curr)
  const totalInView = sum(items.filter(i=>i.curr===viewCurr).map(i=>Number(i.amount||0)));
  const remain = Number(balances[viewCurr]||0) - totalInView;
  setText('walletVal', fmt(remain)+' '+viewCurr);
  setText('walletSub','Gjendja – Shpenzimet ('+viewCurr+')');

  // istatistikler (viewCurr)
  const arr=items.filter(i=>i.curr===viewCurr);
  setText('stTotal', fmt(sum(arr.map(i=>i.amount)))+' '+viewCurr);
  setText('stToday', fmt(sum(arr.filter(i=>isToday(i.d)).map(i=>i.amount)))+' '+viewCurr);
  setText('stMonth', fmt(sum(arr.filter(i=>isThisMonth(i.d)).map(i=>i.amount)))+' '+viewCurr);

  // alt toplamlar her para
  setText('sumALL', fmt(sum(items.filter(i=>i.curr==='ALL').map(i=>i.amount)))+' ALL');
  setText('sumEUR', fmt(sum(items.filter(i=>i.curr==='EUR').map(i=>i.amount)))+' EUR');
  setText('sumTRY', fmt(sum(items.filter(i=>i.curr==='TRY').map(i=>i.amount)))+' TRY');
}

/*** ====== CATEGORIES ====== ***/
async function loadCategories(){
  const {data,error}=await supabase.from('categories').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:true});
  cats = data||[];
  // seed defaults if empty
  if(!cats.length){
    const defaults=[{name:'Ushqime',emoji:'🍔'},{name:'Transport',emoji:'⛽'},{name:'Shtëpia',emoji:'🏠'},{name:'Argëtim',emoji:'🎟️'},{name:'Fatura',emoji:'💡'}]
      .map(x=>({...x,user_id:sessionUser.id}));
    await supabase.from('categories').insert(defaults); const {data:again}=await supabase.from('categories').select('*').eq('user_id',sessionUser.id); cats=again||[];
  }
  drawCats(); fillCatSelects();
}
function drawCats(){
  const box=$('#catList'); box.innerHTML='';
  cats.forEach(c=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML = `<div class="i-ico">${c.emoji}</div>
      <div class="meta"><div class="t">${c.name}</div><div class="s">Kategori personale</div></div>
      <button class="btnx" onclick="delCat('${c.id}')"><span class="material-symbols-rounded">delete</span></button>`;
    box.appendChild(el);
  });
}
function fillCatSelects(){
  const sel=$('#eCat'); sel.innerHTML=''; cats.forEach(c=>{const o=document.createElement('option'); o.value=c.name; o.textContent=`${c.emoji} ${c.name}`; sel.appendChild(o)});
}
async function addCategory(){
  const name=$('#catName').value.trim(), emoji=$('#emVal').value||'🧾';
  if(!name){$('#catMsg').textContent='Shkruaj emrin.'; return;}
  const {data,error}=await supabase.from('categories').insert({user_id:sessionUser.id,name,emoji}).select().single();
  if(error){$('#catMsg').textContent='Gabim: '+error.message; return;}
  cats.push(data); $('#catName').value=''; drawCats(); fillCatSelects(); $('#catMsg').textContent='U shtua.';
}
async function delCat(id){
  await supabase.from('categories').delete().eq('id',id).eq('user_id',sessionUser.id);
  cats=cats.filter(c=>c.id!==id); drawCats(); fillCatSelects();
}
function openPicker(){ openModal('mPick') }
function buildPicker(){
  const list='🍔 🥗 🍕 🍰 ☕ 🍺 🛒 🚌 ⛽ 🚕 🛠️ 🧽 🎁 🎮 🎬 🎟️ 💡 📱 💻 🏠 🧾 🐾 ⚽ 💊 ✈️ 🚗 🪙 💳 🎓 📚 🔌 🔋 👟 🍼 🧻 🧴'.split(' ');
  const g=$('#pickGrid'); g.innerHTML=''; list.forEach(e=>{const b=document.createElement('button'); b.className='pick'; b.textContent=e; b.onclick=()=>{$('#emVal').value=e; $('#emPrev').textContent=e; closeModal('mPick')}; g.appendChild(b)});
}

/*** ====== EXPENSES ====== ***/
async function loadExpenses(){
  const {data,error}=await supabase.from('expenses').select('*').eq('user_id',sessionUser.id).order('d',{ascending:false}).limit(1000);
  items=data||[]; drawHome(); drawAll(); refreshHeader();
}
function rowExpense(x){
  const el=document.createElement('div'); el.className='item';
  el.innerHTML=`<div class="i-ico"><span class="material-symbols-rounded ms">receipt</span></div>
  <div class="meta"><div class="t">${x.name}</div><div class="s">${x.category||'-'} • ${new Date(x.d).toLocaleDateString('sq-AL')} • ${x.curr}</div></div>
  <div class="amt">${fmt(x.amount)} ${x.curr}</div>
  <button class="btnx" onclick="delExpense('${x.id}')"><span class="material-symbols-rounded">delete</span></button>`;
  return el;
}
function drawHome(){
  const r=[...items].slice(0,8); const box=$('#recentList'); box.innerHTML=''; $('#emptyHome').style.display=r.length?'none':'block';
  r.forEach(x=>box.appendChild(rowExpense(x)));
}
function drawAll(){
  const q=($('#q').value||'').toLowerCase(); const f=$('#fCurr').value;
  let arr=[...items]; if(q) arr=arr.filter(x=>x.name.toLowerCase().includes(q)||(x.category||'').toLowerCase().includes(q));
  if(f) arr=arr.filter(x=>x.curr===f);
  const box=$('#allList'); box.innerHTML=''; arr.forEach(x=>box.appendChild(rowExpense(x)));
}
async function saveExpense(){
  const name=$('#eName').value.trim(), amt=parseFloat($('#eAmt').value), cat=$('#eCat').value, d=$('#eDate').value, curr=$('#eCurr').value;
  if(!name||!amt||!d||!curr){alert('Plotëso fushat.'); return;}
  const {data,error}=await supabase.from('expenses').insert({user_id:sessionUser.id,name,amount:amt,category:cat,d,curr}).select().single();
  if(error){alert('Gabim: '+error.message); return;}
  items.unshift(data); closeModal('mExp'); $('#eName').value=''; $('#eAmt').value=''; refreshHeader(); drawHome(); drawAll();
}
async function delExpense(id){
  if(!confirm('Fshije?')) return;
  await supabase.from('expenses').delete().eq('id',id).eq('user_id',sessionUser.id);
  items=items.filter(x=>x.id!==id); refreshHeader(); drawHome(); drawAll();
}

/*** ====== DEBTS ====== ***/
async function loadDebts(){
  const {data,error}=await supabase.from('debts').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:false}).limit(1000);
  debts=data||[]; drawDebts();
}
function drawDebts(){
  const q=($('#dq').value||'').toLowerCase(); let arr=[...debts]; if(q) arr=arr.filter(x=>(x.party||'').toLowerCase().includes(q));
  const box=$('#debtList'); box.innerHTML=''; $('#emptyDebts').style.display=arr.length?'none':'block';
  arr.forEach(x=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML = `<div class="i-ico"><span class="material-symbols-rounded ms">${x.status==='paid'?'check':'credit_card'}</span></div>
      <div class="meta"><div class="t">${x.party||'(pa emër)'}</div><div class="s">${x.curr} • ${x.due?new Date(x.due).toLocaleDateString('sq-AL'):''}</div></div>
      <div class="amt">${fmt(x.amount)} ${x.curr}</div>
      ${x.status==='open'?`<button class="btnx" onclick="payDebt('${x.id}')">Paguar</button>`:`<span class="badge">Paguar</span>`}
      <button class="btnx" onclick="delDebt('${x.id}')"><span class="material-symbols-rounded">delete</span></button>`;
    box.appendChild(el);
  });
}
async function saveDebt(){
  const party=$('#dParty').value.trim(), amt=parseFloat($('#dAmt').value), due=$('#dDue').value||null, curr=$('#dCurr').value;
  if(!party||!amt||!curr){alert('Plotëso fushat.'); return;}
  const payload={user_id:sessionUser.id,party,amount:amt,due,curr,status:'open'};
  const {data,error}=await supabase.from('debts').insert(payload).select().single();
  if(error){alert('Gabim: '+error.message); return;}
  debts.unshift(data); closeModal('mDebt'); $('#dParty').value=''; $('#dAmt').value=''; drawDebts();
}
async function payDebt(id){
  if(!confirm('Je i sigurt?')) return;
  const {data}=await supabase.from('debts').update({status:'paid'}).eq('id',id).eq('user_id',sessionUser.id).select().single();
  debts=debts.map(x=>x.id===id?data:x); drawDebts();
}
async function delDebt(id){
  if(!confirm('Fshije?')) return;
  await supabase.from('debts').delete().eq('id',id).eq('user_id',sessionUser.id);
  debts=debts.filter(x=>x.id!==id); drawDebts();
}

/*** ====== MODALS ====== ***/
function openModal(id){ document.getElementById(id).classList.add('on') }
function closeModal(id){ document.getElementById(id).classList.remove('on') }
</script>
</body>
</html>
