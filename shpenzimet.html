<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Normal Holding</title>
<meta name="theme-color" content="#0d1117">

<style>
:root{
  --bg:#0d1117; --panel:#0f1720; --card:#111923; --border:#263246;
  --text:#c9d1d9; --muted:#8b949e;
  --primary:#2ea043; --primary2:#238636;
  --blue:#1f6feb; --danger:#f85149; --warn:#d29922;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bottom:env(safe-area-inset-bottom,0px);
  --nav-h:92px;
}
*{box-sizing:border-box}
html,body{height:100%;background:var(--bg);color:var(--text);overflow-x:hidden;overscroll-behavior:none}
body{margin:0;font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
a{color:inherit}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

/* App wrap (alttaki nav için güvenli boşluk) */
.wrap{display:flex;flex-direction:column;min-height:100vh;padding-bottom:calc(var(--nav-h) + var(--safe-bottom))}
main{padding:0 12px 18px}

/* Header */
header{
  background:linear-gradient(135deg,var(--primary2) 0%, var(--primary) 100%);
  color:#fff;border-bottom-left-radius:20px;border-bottom-right-radius:20px;
  padding:calc(10px + var(--safe-top)) 16px 12px; box-shadow:0 10px 28px rgba(35,134,54,.35)
}
header .top{display:flex;justify-content:space-between;align-items:center}
header .title{display:flex;gap:8px;align-items:center;margin:6px 0 0}
.logo-emoji{font-size:26px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.25))}
.h-big{font-size:32px;font-weight:900;line-height:1.05;margin-top:6px}
.h-sub{opacity:.85}

/* Stats */
.stats{display:flex;gap:10px;padding:10px 10px 0;transform:translateY(-10px)}
.card{flex:1;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
.card .k{font-size:13px;color:var(--muted)}
.card .v{font-weight:900;color:#e6edf3;margin-top:4px}

/* List rows */
.list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.item{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px}
.ico{width:50px;height:50px;border-radius:50%;display:grid;place-items:center;font-size:26px;color:#0d1117;
  background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
  box-shadow:inset 0 1px 4px rgba(0,0,0,.6), 0 6px 14px rgba(0,0,0,.4);
  border:1px solid rgba(255,255,255,.06)}
.meta{flex:1;min-width:0}
.meta .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#e6edf3}
.meta .s{font-size:12px;color:var(--muted)}
.amt{font-weight:900;color:#e6edf3;white-space:nowrap}
.del{border:none;background:transparent;color:var(--danger);font-size:20px;cursor:pointer}

/* Inputs / buttons */
.row{display:flex;gap:10px}
label{font-size:13px;color:var(--muted)}
input,select,textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:16px;background:#0c141d;color:var(--text)}
textarea{min-height:80px;resize:vertical}
.actions{display:flex;gap:10px;margin-top:10px}
.btnP,.btnS,.btnMini{font-size:16px;user-select:none;touch-action:manipulation}
.btnP{flex:1;background:linear-gradient(180deg,var(--primary) 0%, var(--primary2) 100%);color:#fff;border:1px solid #2ea043;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
.btnS{flex:1;background:#0c141d;color:#e6edf3;border:1px solid var(--border);padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
.btnMini{background:#0c141d;border:1px solid var(--border);padding:8px 10px;border-radius:10px;font-weight:800;color:#e6edf3;cursor:pointer}
.badge{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#1f6feb;color:#fff}

/* Tabs */
.tab{display:none}.tab.active{display:block}

/* Bottom nav */
nav.nav{
  --fab-gap:110px;
  position:fixed;left:0;right:0;bottom:0;height:calc(var(--nav-h) + var(--safe-bottom));
  padding:0 12px calc(10px + var(--safe-bottom)); background:var(--panel);border-top:1px solid var(--border);
  box-shadow:0 -10px 30px rgba(0,0,0,.35);border-top-left-radius:16px;border-top-right-radius:16px;
  display:grid;grid-template-columns:1fr 1fr var(--fab-gap) 1fr 1fr;align-items:center;z-index:2000;
  backface-visibility:hidden;will-change:transform
}
.btn{justify-self:center;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);text-decoration:none}
.btn:nth-of-type(1){grid-column:1}.btn:nth-of-type(2){grid-column:2}.btn:nth-of-type(3){grid-column:4}.btn:nth-of-type(4){grid-column:5}
.btn .b-ico{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;font-size:22px;color:#0d1117;
  background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);border:1px solid rgba(255,255,255,.06);
  box-shadow:inset 0 1px 3px rgba(0,0,0,.6)}
.btn.active{color:#79c0ff}
.btn.active .b-ico{background:radial-gradient(circle at 30% 30%, #cfe7ff 0%, #9dd2ff 45%, #1f6feb 100%)}

/* FAB */
.nav .fab{position:absolute;left:50%;transform:translateX(-50%);top:-24px;width:60px;height:60px;border-radius:999px;
  background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);border:1px solid rgba(255,255,255,.06);
  color:#0d1117;font-size:30px;display:grid;place-items:center;box-shadow:0 14px 26px rgba(0,0,0,.5), inset 0 1px 4px rgba(0,0,0,.6);
  cursor:pointer;z-index:2100;pointer-events:auto}

/* Modal sheet */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:end;padding:14px;z-index:3000}
.modal.on{display:grid}
.sheet{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:18px;padding:14px;width:100%;box-shadow:0 -12px 30px rgba(0,0,0,.5)}

/* Collapsible */
.coll{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);margin:10px 0}
.coll > .head{display:flex;align-items:center;gap:10px;padding:12px 14px;cursor:pointer}
.coll > .body{padding:0 14px 14px;display:none}
.coll.open > .body{display:block}

/* Emoji picker (simple) */
.picker-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;max-height:45vh;overflow:auto;margin-top:8px}
.picker-grid button{border:1px solid var(--border);background:#0c141d;border-radius:10px;width:44px;height:44px;font-size:22px;cursor:pointer}

@media(min-width:720px){.wrap{max-width:560px;margin:0 auto}}
</style>
</head>
<body>

<!-- AUTH GATE -->
<div id="gate" class="wrap" style="display:none;place-items:center;min-height:100vh">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow);width:min(520px,92vw)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:900;font-size:18px">Normal Holding</div>
      <div class="muted">Shpenzimet • Cloud</div>
    </div>
    <div class="row" style="margin-top:4px">
      <div style="flex:1">
        <label>Email</label>
        <input id="authEmail" placeholder="emri@gmail.com" autocomplete="username">
      </div>
      <div style="flex:1">
        <label>Fjalëkalimi</label>
        <input id="authPass" type="password" placeholder="••••••••" autocomplete="current-password">
      </div>
    </div>
    <div class="actions">
      <button class="btnS" onclick="registerUser()">Regjistrohu</button>
      <button class="btnP" onclick="login()">Hyr</button>
    </div>
    <div id="authMsg" class="muted" style="margin-top:6px"></div>
  </div>
</div>

<!-- APP -->
<div id="app" class="wrap" style="display:none">
  <header id="hdr">
    <div class="top">
      <div style="font-weight:800">Normal Holding</div>
      <div id="who" class="h-sub">—</div>
    </div>
    <div class="title"><span class="logo-emoji" id="hdrIcon">💰</span><b id="hdrText">Bilanci</b></div>
    <div class="h-big"><span id="hdrTotal">0</span></div>
    <div id="hdrSub" class="h-sub">Gjendja − Shpenzimet (totale)</div>
  </header>

  <div class="stats">
    <div class="card"><div class="k" id="s1name">📊 Totale</div><div class="v"><span id="stat1">0</span></div></div>
    <div class="card"><div class="k" id="s2name">📅 Sot</div><div class="v"><span id="stat2">0</span></div></div>
    <div class="card"><div class="k" id="s3name">🗓️ Muaj</div><div class="v"><span id="stat3">0</span></div></div>
  </div>

  <main>
    <!-- HOME -->
    <section id="tab-home" class="tab active">
      <h3 style="margin:8px 2px">🕒 Të fundit</h3>
      <div id="recentList" class="list"></div>
      <div id="emptyHome" class="muted" style="text-align:center;margin-top:14px">Asnjë hyrje deri tani.</div>
    </section>

    <!-- LIST -->
    <section id="tab-list" class="tab">
      <h3 style="margin:8px 2px">📚 Lista</h3>
      <div class="row" style="margin:6px 0 10px">
        <input id="q" placeholder="Kërko..." oninput="drawAll()">
        <select id="fCat" onchange="drawAll()"><option value="">Të gjitha</option></select>
      </div>
      <div id="allList" class="list"></div>
    </section>

    <!-- DEBTS -->
    <section id="tab-debts" class="tab">
      <h3 style="margin:8px 2px">💳 Borxhet</h3>
      <div class="row" style="margin:6px 0 10px"><input id="dq" placeholder="Kërko borxhe..." oninput="drawDebts()"></div>
      <div class="row" id="dSegFilter" style="margin-bottom:8px">
        <button class="btnMini active" data-val="">Të gjitha</button>
        <button class="btnMini" data-val="borrow">Mora hua</button>
        <button class="btnMini" data-val="lend">Dhash hua</button>
      </div>
      <div id="debtList" class="list"></div>
      <div id="emptyDebts" class="muted" style="text-align:center;margin-top:14px">Asnjë borxh.</div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="tab">
      <h3 style="margin:8px 2px">⚙️ Cilësime</h3>

      <div class="coll open">
        <div class="head" onclick="toggleColl(this)">
          <div class="logo-emoji">👤</div><b style="flex:1">Përdoruesi</b>
          <button class="btnMini" onclick="event.stopPropagation(); logout()">Dil</button>
        </div>
        <div class="body"><div class="muted" id="userInfo">—</div></div>
      </div>

      <div class="coll open">
        <div class="head" onclick="toggleColl(this)">
          <div class="logo-emoji">💱</div><b style="flex:1">Monedha & format</b>
        </div>
        <div class="body">
          <div class="row">
            <div style="flex:1">
              <label>Monedha aktuale (për hyrjet e reja)</label>
              <select id="curSel">
                <option value="ALL">ALL — Albania Lek</option>
                <option value="EUR">EUR — Euro</option>
                <option value="USD">USD — US Dollar</option>
                <option value="TRY">TRY — Türk Lirası</option>
              </select>
            </div>
            <div style="width:160px">
              <label>Formati i numrave</label>
              <select id="fmtSel">
                <option value="eu">23.456,78</option>
                <option value="us">23,456.78</option>
              </select>
            </div>
          </div>
          <div class="actions"><button class="btnP" onclick="savePrefs()">Ruaj preferencat</button></div>
          <div id="prefMsg" class="muted" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="coll">
        <div class="head" onclick="toggleColl(this)">
          <div class="logo-emoji">💰</div><b style="flex:1">Gjendja e monedhës aktuale</b>
        </div>
        <div class="body">
          <div class="row"><input id="balInput" type="number" step="0.01" inputmode="decimal" placeholder="p.sh. 5000"></div>
          <div class="actions"><button class="btnP" onclick="saveBalance()">Ruaj gjendjen</button></div>
          <div id="balMsg" class="muted" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="coll">
        <div class="head" onclick="toggleColl(this)">
          <div class="logo-emoji">🏷️</div><b style="flex:1">Kategoriat</b>
        </div>
        <div class="body">
          <div id="catList" class="list"></div>
          <div style="border-top:1px solid var(--border);margin:12px 0"></div>
          <div class="row">
            <div style="width:120px">
              <label>Emoji</label>
              <button class="btnS" id="emojiBtn" onclick="openEmojiPicker()"><span id="emojiPreview" style="font-size:24px">🍔</span> <span style="margin-left:6px">Zgjidh</span></button>
              <input id="newCatEmoji" value="🍔" hidden>
            </div>
            <div style="flex:1">
              <label>Emri i kategorisë</label>
              <input id="newCatName" placeholder="p.sh. Ushqime">
            </div>
          </div>
          <div class="actions"><button class="btnP" onclick="addCategory()">Shto kategori</button></div>
          <div id="catMsg" class="muted" style="margin-top:6px"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- BOTTOM NAV -->
<nav class="nav" id="navbar" style="display:none">
  <a class="btn active" data-tab="home" onclick="switchTab('home')"><span class="b-ico">🏠</span><span>Kreu</span></a>
  <a class="btn" data-tab="list" onclick="switchTab('list')"><span class="b-ico">📋</span><span>Lista</span></a>
  <a class="btn" data-tab="debits" onclick="switchTab('debts')"><span class="b-ico">💳</span><span>Borxhet</span></a>
  <a class="btn" data-tab="settings" onclick="switchTab('settings')"><span class="b-ico">⚙️</span><span>Cilësime</span></a>
  <button class="fab" id="openAdd" aria-label="Shto">＋</button>
</nav>

<!-- MODAL: EXPENSE -->
<div class="modal" id="modalExp"><div class="sheet">
  <h3 style="margin:4px 0 10px">➕ Shto hyrje</h3>
  <div class="row"><div style="flex:2"><label>Emri</label><input id="mName" placeholder="p.sh. Karburant"></div><div style="flex:1"><label>Shuma</label><input id="mAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label>Kategoria</label><select id="mCat"></select></div><div style="flex:1"><label>Data</label><input id="mDate" type="date"></div></div>
  <div class="row" id="rowExpCurr" style="margin-top:8px;display:none"><div style="flex:1"><label>Monedha</label><select id="mCurr"><option>ALL</option><option>EUR</option><option>USD</option><option>TRY</option></select></div><div style="flex:1"></div></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Exp')">Mbyll</button><button class="btnP" onclick="saveExpense()">Ruaj</button></div>
</div></div>

<!-- MODAL: DEBT -->
<div class="modal" id="modalDebt"><div class="sheet">
  <h3 style="margin:4px 0 10px">➕ Shto borxh</h3>
  <div class="row"><div style="flex:1"><label>Palë</label><input id="dParty" placeholder="p.sh. Arben / ACME sh.p.k."></div><div style="flex:1"><label>Shuma</label><input id="dAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label>Lloji</label>
    <div class="row" id="segType"><button class="btnMini active" data-val="borrow">Mora hua</button><button class="btnMini" data-val="lend">Dhash hua</button></div>
  </div><div style="flex:1"><label>Afati (ops.)</label><input id="dDate" type="date"></div></div>
  <div class="row" id="rowDebtCurr" style="margin-top:8px;display:none"><div style="flex:1"><label>Monedha</label><select id="dCurr"><option>ALL</option><option>EUR</option><option>USD</option><option>TRY</option></select></div><div style="flex:1"><label>Përshkrimi (ops.)</label><input id="dName" placeholder="p.sh. Telefon i ri"></div></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Debt')">Mbyll</button><button class="btnP" onclick="saveDebt()">Ruaj</button></div>
</div></div>

<!-- MODAL: EMOJI PICKER -->
<div class="modal" id="modalEmoji"><div class="sheet">
  <h3 style="margin:4px 0 10px">🙂 Zgjidh një emoji</h3>
  <div id="emojiGrid" class="picker-grid"></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Emoji')">Mbyll</button></div>
</div></div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== Supabase config ===== */
const SUPABASE_URL  = 'https://nvpjqvggaiipwziolend.supabase.co';                 // <- kendi URL'in
const SUPABASE_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cGpxdmdnYWlpcHd6aW9sZW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4OTExNzcsImV4cCI6MjA3NDQ2NzE3N30.PnJh09kx-kK8iChgQl2M1eTw5P2qRZUEO31wVY7_iP4';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== State ===== */
let sessionUser = null;
let items = [];     // expenses
let debts = [];
let cats  = [];     // categories
let profile = { default_currency:'ALL', num_format:'eu', balances:null, balance:0 };

let activeTab = 'home';
let hasExpCurr = false;   // expenses.curr column?
let hasDebtCurr = false;  // debts.curr column?
let hasBalances = false;  // profiles.balances jsonb?
let hasBalance  = false;  // profiles.balance number?

/* ===== Utils ===== */
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const setText = (id,v)=>{const e=document.getElementById(id); if(e) e.textContent=v};
const todayISO = ()=> new Date().toISOString().slice(0,10);
const fmt = (n, f=profile.num_format||'eu', curr='')=>{
  if(isNaN(n)) n=0;
  const s = (Math.round(n*100)/100).toLocaleString(f==='eu'?'de-DE':'en-US',{minimumFractionDigits:2, maximumFractionDigits:2});
  return curr ? `${s} ${curr}` : s;
};
const fmtDate = iso => { const d = new Date(iso+'T00:00:00'); return d.toLocaleDateString('sq-AL',{day:'2-digit',month:'short',year:'numeric'}) };
const sum = a => a.reduce((s,n)=>s+Number(n||0),0);
function toggleColl(h){ const p=h.parentElement; p.classList.toggle('open') }
function openModal(w){ qs('#modal'+w).classList.add('on') }
function closeModal(w){ qs('#modal'+w).classList.remove('on') }
function emailShort(e){ return e?e.split('@')[0]:'—' }

/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', async () => {
  // Emoji grid
  '🍔 🥗 🍕 🍰 ☕ 🍺 🛒 🚌 ⛽ 🚕 🛠️ 🧽 🎁 🎮 🎬 🎟️ 💡 📱 💻 🏠 🐾 ⚽ 🧾 💊 ✈️ 🚗 🪙 💳 📚 🖥️ 🔌 🔋 🧥 👟 🍼 🧻 🧴'.split(' ').forEach(e=>{
    const b=document.createElement('button'); b.textContent=e;
    b.onclick=()=>{qs('#newCatEmoji').value=e; qs('#emojiPreview').textContent=e; closeModal('Emoji')};
    qs('#emojiGrid').appendChild(b);
  });

  // Tap toggles
  qsa('#segType .btnMini').forEach(b=>b.onclick=()=>{qsa('#segType .btnMini').forEach(x=>x.classList.remove('active')); b.classList.add('active')});
  qsa('#dSegFilter .btnMini').forEach(b=>b.onclick=()=>{qsa('#dSegFilter .btnMini').forEach(x=>x.classList.remove('active')); b.classList.add('active'); drawDebts()});

  // FAB open logic
  const fabOpen = ()=>{ if(activeTab==='debts') openModal('Debt'); else openModal('Exp'); };
  ['click','pointerup','touchend'].forEach(ev=>qs('#openAdd').addEventListener(ev,fabOpen,{passive:true}));

  // Dates default
  qs('#mDate').value = todayISO();
  qs('#dDate').value = todayISO();

  // Session
  const { data:{session} } = await supabase.auth.getSession();
  if(session?.user){ sessionUser=session.user; await afterLogin(); } else showGate();

  supabase.auth.onAuthStateChange(async (_e, sess)=>{
    if(sess?.user){ sessionUser=sess.user; await afterLogin(); }
    else { sessionUser=null; showGate(); }
  });
});

/* ===== Auth ===== */
async function registerUser(){
  const email = qs('#authEmail').value.trim();
  const pass  = qs('#authPass').value;
  const box   = qs('#authMsg'); box.textContent='';
  if(!email || pass.length<6){ box.textContent='Email dhe fjalëkalim ≥ 6.'; return }
  const { error } = await supabase.auth.signUp({ email, password: pass });
  box.textContent = error ? ('Gabim: '+error.message) : 'Llogaria u krijua. Kontrollo email-in.';
}
async function login(){
  const email = qs('#authEmail').value.trim();
  const pass  = qs('#authPass').value;
  const box   = qs('#authMsg'); box.textContent='';
  const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
  if(error) box.textContent = 'Gabim: '+error.message;
}
async function logout(){ await supabase.auth.signOut() }

function showGate(){ qs('#gate').style.display='grid'; qs('#app').style.display='none'; qs('#navbar').style.display='none' }
function showApp(){  qs('#gate').style.display='none'; qs('#app').style.display='block'; qs('#navbar').style.display='grid' }

/* ===== After login ===== */
async function afterLogin(){
  showApp();
  qs('#who').textContent = sessionUser.email;
  qs('#userInfo').textContent = sessionUser.email;

  // Detect optional columns (curr, balances)
  await detectSchema();

  // Load data (profile -> categories -> expenses/debts)
  await ensureProfile();
  await loadCategories();
  await loadExpenses();
  await loadDebts();

  // UI init
  refreshHeader(); drawHome(); drawAll(); drawDebts();
}

/* ===== Schema detection (graceful) ===== */
async function detectSchema(){
  // expenses.curr
  try{ const t = await supabase.from('expenses').select('id,curr').limit(1); hasExpCurr = !t.error; }catch{ hasExpCurr=false }
  // debts.curr
  try{ const t = await supabase.from('debts').select('id,curr').limit(1);  hasDebtCurr = !t.error; }catch{ hasDebtCurr=false }
  // profiles.balances & profiles.balance
  try{ const t = await supabase.from('profiles').select('balances').eq('user_id',sessionUser.id).limit(1);
       hasBalances = !t.error; }catch{ hasBalances=false }
  try{ const t = await supabase.from('profiles').select('balance').eq('user_id',sessionUser.id).limit(1);
       hasBalance = !t.error; }catch{ hasBalance=false }

  // Show currency row in modals only if column exists
  qs('#rowExpCurr').style.display = hasExpCurr ? 'flex' : 'none';
  qs('#rowDebtCurr').style.display = hasDebtCurr ? 'flex' : 'none';
}

/* ===== Profile / prefs ===== */
async function ensureProfile(){
  // read
  let r = await supabase.from('profiles').select('user_id,default_currency,num_format,balances,balance').eq('user_id',sessionUser.id).maybeSingle();
  if(r.error && r.error.code!=='PGRST116'){ console.warn(r.error); }
  if(!r.data){
    // create minimal row
    const ins = await supabase.from('profiles').upsert({ user_id:sessionUser.id, default_currency:'ALL', num_format:'eu' }).select().single();
    if(!ins.error) r.data = ins.data;
  }
  profile.default_currency = r.data?.default_currency || 'ALL';
  profile.num_format      = r.data?.num_format || 'eu';
  profile.balances        = r.data?.balances || null;
  profile.balance         = r.data?.balance ?? 0;

  // UI set
  qs('#curSel').value = profile.default_currency;
  qs('#fmtSel').value = profile.num_format;
  qs('#mCurr').value  = profile.default_currency;
  qs('#dCurr').value  = profile.default_currency;

  refreshHeader();
}

async function savePrefs(){
  const curr = qs('#curSel').value;
  const fmtK = qs('#fmtSel').value;
  const { data, error } = await supabase.from('profiles').upsert({
    user_id: sessionUser.id, default_currency: curr, num_format: fmtK
  }).select().single();
  qs('#prefMsg').textContent = error?('Gabim: '+error.message):'U ruajt.';
  if(!error){ profile.default_currency = curr; profile.num_format = fmtK; refreshHeader(); }
}

function getBalanceFor(curr){
  if(hasBalances && profile.balances && typeof profile.balances === 'object') return Number(profile.balances[curr]||0);
  return Number(profile.balance||0);
}
async function applyBalanceDelta(curr,delta){
  if(hasBalances){
    const map = {...(profile.balances||{})};
    map[curr] = Number(map[curr]||0) + delta;
    const { data,error } = await supabase.from('profiles').upsert({ user_id:sessionUser.id, balances: map }).select().single();
    if(!error){ profile.balances = data.balances; refreshHeader() }
  }else if(hasBalance){
    const { data,error } = await supabase.from('profiles').upsert({ user_id:sessionUser.id, balance: Number(profile.balance||0)+delta }).select().single();
    if(!error){ profile.balance = data.balance; refreshHeader() }
  }
}
async function saveBalance(){
  const curr = qs('#curSel').value;
  const v    = Number(qs('#balInput').value||0);
  let error=null;
  if(hasBalances){
    const map = {...(profile.balances||{})}; map[curr]=v;
    const r = await supabase.from('profiles').upsert({ user_id:sessionUser.id, balances: map }).select().single();
    error = r.error; if(!error) profile.balances=r.data.balances;
  }else{
    const r = await supabase.from('profiles').upsert({ user_id:sessionUser.id, balance: v }).select().single();
    error = r.error; if(!error) profile.balance=r.data.balance;
  }
  qs('#balMsg').textContent = error?('Gabim: '+error.message):'U ruajt.';
  refreshHeader();
}

/* ===== Categories ===== */
const DEFAULT_CATS=[{name:'Ushqime',emoji:'🍔'},{name:'Transport',emoji:'⛽'},{name:'Shtëpia',emoji:'🏠'},{name:'Argëtim',emoji:'🎟️'},{name:'Fatura',emoji:'💡'},{name:'Të tjera',emoji:'🧾'}];
async function loadCategories(){
  // seed if empty
  let c = await supabase.from('categories').select('id').eq('user_id',sessionUser.id).limit(1);
  if(!c.error && (!c.data || c.data.length===0)){
    await supabase.from('categories').insert(DEFAULT_CATS.map(x=>({...x,user_id:sessionUser.id})));
  }
  const r = await supabase.from('categories').select('id,name,emoji').eq('user_id',sessionUser.id).order('created_at',{ascending:true});
  if(!r.error){ cats = r.data; renderCatList(); refreshCategorySelects(); }
}
function renderCatList(){
  const box=qs('#catList'); box.innerHTML='';
  cats.forEach(c=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ico'; ic.textContent=c.emoji||'🧾';
    const meta=document.createElement('div'); meta.className='meta'; const t=document.createElement('div'); t.className='t'; t.textContent=c.name;
    const s=document.createElement('div'); s.className='s'; s.textContent='Kategori personale'; meta.append(t,s);
    const del=document.createElement('button'); del.className='btnMini'; del.textContent='Fshi'; del.onclick=()=>deleteCategory(c.id);
    el.append(ic,meta,del); box.appendChild(el);
  });
}
function refreshCategorySelects(){
  const mCat=qs('#mCat'), fCat=qs('#fCat'); mCat.innerHTML=''; fCat.innerHTML='<option value="">Të gjitha</option>';
  cats.forEach(c=>{
    const o=document.createElement('option'); o.value=c.name; o.textContent=(c.emoji||'•')+' '+c.name;
    mCat.appendChild(o.cloneNode(true));
    const o2=document.createElement('option'); o2.value=c.name; o2.textContent=c.name; fCat.appendChild(o2);
  });
}
async function addCategory(){
  const name=(qs('#newCatName').value||'').trim();
  const emoji=(qs('#newCatEmoji').value||'').trim()||'🧾';
  const msg=qs('#catMsg'); msg.textContent='';
  if(!name){ msg.textContent='Shkruaj emrin.'; return }
  const r = await supabase.from('categories').insert({user_id:sessionUser.id,name,emoji}).select().single();
  msg.textContent = r.error ? ('Gabim: '+r.error.message) : 'U shtua.';
  if(!r.error){ cats.push(r.data); qs('#newCatName').value=''; renderCatList(); refreshCategorySelects() }
}
async function deleteCategory(id){
  if(!confirm('Fshije këtë kategori?')) return;
  const r = await supabase.from('categories').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(!r.error){ cats = cats.filter(c=>c.id!==id); renderCatList(); refreshCategorySelects(); drawAll() }
}
function emojiFor(catName){
  const hit=cats.find(c=>c.name===catName);
  if(hit) return hit.emoji || '🧾';
  const m={'Ushqime':'🍔','Transport':'⛽','Shtëpia':'🏠','Argëtim':'🎟️','Fatura':'💡','Të tjera':'🧾'};
  return m[catName] || '💸';
}
function openEmojiPicker(){ openModal('Emoji') }

/* ===== Expenses ===== */
async function loadExpenses(){
  const r = await supabase.from('expenses').select('*').eq('user_id',sessionUser.id).order('d',{ascending:false}).limit(2000);
  if(r.error){ alert('Gabim ngarkimi (shpenzime): '+r.error.message); return }
  items = r.data || [];
  drawHome(); drawAll(); refreshHeader();
}
async function saveExpense(){
  const name=(qs('#mName').value||'').trim();
  const amt = Number(qs('#mAmt').value||0);
  const cat = qs('#mCat').value;
  const d   = qs('#mDate').value || todayISO();
  let curr  = hasExpCurr ? qs('#mCurr').value : profile.default_currency;
  if(!name || !amt){ alert('Emri dhe shuma!'); return }
  const payload = { user_id:sessionUser.id, name, amount:amt, category:cat, d };
  if(hasExpCurr) payload.curr = curr;
  const r = await supabase.from('expenses').insert(payload).select().single();
  if(r.error){ alert('Gabim: '+r.error.message); return }
  items.unshift(r.data);
  if(hasBalances || hasBalance){ await applyBalanceDelta(curr, -amt) } // harcama -> bakiye düş
  qs('#mName').value=''; qs('#mAmt').value=''; closeModal('Exp');
  drawHome(); drawAll(); refreshHeader();
}
async function delExpense(id){
  if(!confirm('Fshini këtë hyrje?')) return;
  // Opsiyonel: iade bakiyeyi geri eklemek istersen burada tutar ve curr okunmalı
  const row = items.find(x=>x.id===id); let delta=null, curr=null;
  if(row){ delta=Number(row.amount||0); curr=(row.curr||profile.default_currency) }
  const r = await supabase.from('expenses').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(!r.error){ items = items.filter(x=>x.id!==id); if(delta!=null && (hasBalances||hasBalance)) await applyBalanceDelta(curr, delta); drawHome(); drawAll(); refreshHeader() }
}
function drawHome(){
  const list=qs('#recentList'); list.innerHTML=''; const recent=[...items].sort((a,b)=>b.d.localeCompare(a.d)).slice(0,8);
  qs('#emptyHome').style.display = recent.length?'none':'block';
  recent.forEach(x=>list.appendChild(rowExpense(x)));
}
function drawAll(){
  const q=(qs('#q').value||'').trim().toLowerCase(); const cat=qs('#fCat').value;
  let arr=[...items].sort((a,b)=>b.d.localeCompare(a.d));
  if(q)   arr=arr.filter(x=>x.name.toLowerCase().includes(q)||(x.category||'').toLowerCase().includes(q));
  if(cat) arr=arr.filter(x=>x.category===cat);
  const box=qs('#allList'); box.innerHTML='';
  arr.forEach(x=>box.appendChild(rowExpense(x)));
}
function rowExpense(x){
  const el=document.createElement('div'); el.className='item';
  const ic=document.createElement('div'); ic.className='ico'; ic.textContent=emojiFor(x.category);
  const meta=document.createElement('div'); meta.className='meta';
  const t=document.createElement('div'); t.className='t'; t.textContent=x.name;
  const s=document.createElement('div'); s.className='s'; const ctag = (x.category||''); const dtag = fmtDate(x.d); const ccode = x.curr || profile.default_currency;
  s.textContent=[ctag,dtag,ccode].filter(Boolean).join(' • ');
  meta.append(t,s);
  const amt=document.createElement('div'); amt.className='amt'; amt.textContent=fmt(x.amount, undefined, (x.curr||profile.default_currency));
  const del=document.createElement('button'); del.className='del'; del.textContent='🗑️'; del.onclick=()=>delExpense(x.id);
  el.append(ic,meta,amt,del); return el;
}

/* ===== Debts ===== */
async function loadDebts(){
  const r = await supabase.from('debts').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:false}).limit(2000);
  if(r.error){ alert('Gabim ngarkimi (borxhe): '+r.error.message); return }
  debts = r.data || []; drawDebts(); refreshHeader();
}
async function saveDebt(){
  const party=(qs('#dParty').value||'').trim();
  const amt  = Number(qs('#dAmt').value||0);
  const name =(qs('#dName').value||'').trim();
  const due  = qs('#dDate').value||null;
  const kind = qs('#segType .active')?.dataset.val || 'borrow';
  let curr   = hasDebtCurr ? qs('#dCurr').value : profile.default_currency;
  if(!party || !amt){ alert('Palë dhe shuma!'); return }
  const payload={ user_id:sessionUser.id, party, amount:amt, name, due, kind, status:'open' };
  if(hasDebtCurr) payload.curr = curr;
  const r=await supabase.from('debts').insert(payload).select().single();
  if(r.error){ alert('Gabim: '+r.error.message); return }
  debts.unshift(r.data);
  // Borrow -> para çıktı, Lend -> para çıktı mı? (borç verdim) evet -amt
  if(hasBalances||hasBalance){ if(kind==='lend') await applyBalanceDelta(curr, -amt) }
  qs('#dParty').value=''; qs('#dName').value=''; qs('#dAmt').value=''; closeModal('Debt'); drawDebts(); refreshHeader();
}
async function delDebt(id){
  if(!confirm('Fshini këtë borxh?')) return;
  const r=await supabase.from('debts').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(!r.error){ debts=debts.filter(x=>x.id!==id); drawDebts(); refreshHeader() }
}
async function payDebt(id){
  const row=debts.find(x=>x.id===id); if(!row) return;
  if(!confirm('Borxhi u pagua. Je i sigurt?')) return;
  const r=await supabase.from('debts').update({status:'paid'}).eq('id',id).eq('user_id',sessionUser.id).select().single();
  if(r.error){ alert('Gabim: '+r.error.message); return }
  debts=debts.map(x=>x.id===id?r.data:x); drawDebts(); refreshHeader();
  // Balance etkisi: borrow (mora hua) -> öderken bakiye ↓; lend (dhash hua) -> geri alırken bakiye ↑
  const curr = row.curr || profile.default_currency;
  const delta = row.kind==='borrow' ? -Number(row.amount||0) : +Number(row.amount||0);
  if(hasBalances||hasBalance) await applyBalanceDelta(curr, delta);
}
function drawDebts(){
  const q=(qs('#dq').value||'').trim().toLowerCase();
  const f=qs('#dSegFilter .active')?.dataset.val || '';
  let arr=[...debts];
  if(q) arr=arr.filter(x=>(x.party||'').toLowerCase().includes(q)||(x.name||'').toLowerCase().includes(q));
  if(f) arr=arr.filter(x=>x.kind===f);
  const box=qs('#debtList'); box.innerHTML=''; qs('#emptyDebts').style.display=arr.length?'none':'block';
  arr.forEach(x=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ico'; ic.textContent=(x.status==='paid')?'✅':'💳';
    const meta=document.createElement('div'); meta.className='meta';
    const t=document.createElement('div'); t.className='t'; t.textContent=x.party||'(pa emër)';
    const bits=[x.kind==='borrow'?'Mora hua':'Dhash hua']; if(x.name)bits.push(x.name);
    if(x.due) bits.push('Afati: '+fmtDate(x.due)); if(x.curr) bits.push(x.curr);
    const s=document.createElement('div'); s.className='s'; s.textContent=bits.join(' • '); meta.append(t,s);
    const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
    const amt=document.createElement('div'); amt.className='amt'; amt.textContent=fmt(x.amount, undefined, (x.curr||profile.default_currency));
    right.appendChild(amt);
    if(x.status==='open'){ const pay=document.createElement('button'); pay.className='btnMini'; pay.textContent=(x.kind==='borrow')?'Paguaj':'U kthye'; pay.onclick=()=>payDebt(x.id); right.appendChild(pay) }
    else{ const b=document.createElement('span'); b.className='badge'; b.textContent='Paguar'; right.appendChild(b) }
    const del=document.createElement('button'); del.className='del'; del.textContent='🗑️'; del.onclick=()=>delDebt(x.id);
    el.append(ic,meta,right,del); box.appendChild(el);
  });
}

/* ===== Header / stats ===== */
function refreshHeader(){
  const icon=qs('#hdrIcon'), text=qs('#hdrText'), sub=qs('#hdrSub');
  const s1=qs('#s1name'), s2=qs('#s2name'), s3=qs('#s3name');
  const curr = qs('#curSel').value || profile.default_currency;

  if(activeTab==='debts'){
    icon.textContent='💳'; text.textContent='Borxhet'; sub.textContent='Detyrimet & Më detyrohen';
    const borrowOpen=sum(debts.filter(x=>x.kind==='borrow' && x.status!=='paid').map(n=>Number(n.amount||0)));
    const lendOpen  =sum(debts.filter(x=>x.kind==='lend'   && x.status!=='paid').map(n=>Number(n.amount||0)));
    setText('hdrTotal', fmt(borrowOpen - lendOpen, undefined, curr));
    s1.textContent='Gjithsej'; s2.textContent='Detyrime'; s3.textContent='Më detyrohen';
    setText('stat1', fmt(sum(debts.map(n=>Number(n.amount||0))), undefined, curr));
    setText('stat2', fmt(borrowOpen, undefined, curr));
    setText('stat3', fmt(lendOpen,   undefined, curr));
  }else{
    icon.textContent='💰'; text.textContent='Bilanci'; sub.textContent='Gjendja − Shpenzimet (totale)';
    const total = sum(items.filter(x=>(x.curr||curr)=== (hasExpCurr?(x.curr||curr):curr)).map(x=>Number(x.amount||0)));
    const today = sum(items.filter(x=>isToday(x) && ((x.curr||curr)===(hasExpCurr?(x.curr||curr):curr))).map(x=>Number(x.amount||0)));
    const month = sum(items.filter(x=>isThisMonth(x) && ((x.curr||curr)===(hasExpCurr?(x.curr||curr):curr))).map(x=>Number(x.amount||0)));
    const remain = getBalanceFor(curr) - total;
    setText('hdrTotal', fmt(remain, undefined, curr));
    s1.textContent='Totale'; s2.textContent='Sot'; s3.textContent='Muaj';
    setText('stat1', fmt(total, undefined, curr));
    setText('stat2', fmt(today, undefined, curr));
    setText('stat3', fmt(month, undefined, curr));
  }
}
function isToday(x){const d=new Date(x.d),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()&&d.getDate()==t.getDate()}
function isThisMonth(x){const d=new Date(x.d),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()}

/* ===== Tabs ===== */
function switchTab(t){
  activeTab = t;
  qsa('.tab').forEach(x=>x.classList.remove('active')); qs('#tab-'+(t==='debits'?'debts':t)).classList.add('active');
  qsa('.btn').forEach(x=>x.classList.remove('active')); qs(`.btn[data-tab="${t}"]`)?.classList.add('active');
  if(t==='list') drawAll(); if(t==='debts') drawDebts(); refreshHeader();
}
</script>

</body>
</html>
