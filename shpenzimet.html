<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Normal Holding • Shpenzimet</title>

<!-- Google Icons (Material Symbols) -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,500,0,0" rel="stylesheet" />

<style>
:root{
  --bg:#0d1117; --card:#161b22; --border:#30363d;
  --text:#c9d1d9; --muted:#8b949e;
  --primary:#2ea043; --primary2:#238636; --blue:#1f6feb; --danger:#f85149;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --navh:86px; --safe-top:env(safe-area-inset-top,0px); --safe-bottom:env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
body{margin:0;-webkit-tap-highlight-color:transparent;overscroll-behavior:none}

.wrap{min-height:100vh;display:flex;flex-direction:column;padding-bottom:calc(var(--navh)+var(--safe-bottom))}
header{
  background:linear-gradient(135deg,var(--primary2),var(--primary));
  color:#fff;border-bottom-left-radius:22px;border-bottom-right-radius:22px;
  padding:calc(10px + var(--safe-top)) 16px 12px; box-shadow:0 10px 28px rgba(35,134,54,.35)
}
header .top{display:flex;justify-content:space-between;align-items:center}
header .who{opacity:.9}
header .title{display:flex;gap:8px;align-items:baseline;margin-top:6px}
header .title .name{font-weight:900;font-size:20px}
header .big{font-size:30px;font-weight:900;margin-top:8px}
header .sub{opacity:.9}

.seg{display:inline-grid;gap:6px;background:#1d222a;border:1px solid var(--border);border-radius:12px;padding:5px;margin-top:10px}
.seg button{
  border:none;background:transparent;color:#e6edf3;padding:8px 12px;border-radius:8px;font-weight:800;cursor:pointer
}
.seg button.active{background:linear-gradient(180deg,#1f6feb,#1158c7);color:#fff}

.stats{display:flex;gap:10px;padding:10px 12px;transform:translateY(-12px)}
.card{flex:1;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
.card h5{margin:0 0 6px;font-size:12px;color:#e6edf3;opacity:.85}
.card .v{font-weight:900;font-size:18px}

main{padding:0 12px 16px}
h3.sec{margin:0 0 6px}

.list{display:flex;flex-direction:column;gap:10px}
.item{display:flex;align-items:center;gap:12px;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px}
.ic{width:44px;height:44px;display:grid;place-items:center;border-radius:50%;background:#0f141b;border:1px solid rgba(255,255,255,.06);font-size:24px}
.meta{flex:1;min-width:0}
.meta .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta .s{font-size:12px;color:var(--muted)}
.amt{font-weight:900}
.del{border:none;background:transparent;color:var(--danger);font-size:22px;cursor:pointer}

.row{display:flex;gap:10px}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text);font-size:16px}
label{font-size:12px;color:var(--muted)}
.actions{display:flex;gap:10px;margin-top:10px}
.btnP,.btnS{flex:1;padding:12px 16px;border-radius:12px;font-weight:800;border:1px solid}
.btnP{background:linear-gradient(180deg,var(--primary),var(--primary2));border-color:#2ea043;color:#fff}
.btnS{background:#21262d;border-color:var(--border);color:#e6edf3}

.badge{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#1f6feb;color:#fff}

nav{
  position:fixed;left:0;right:0;bottom:0;height:calc(var(--navh)+var(--safe-bottom));
  padding:0 12px var(--safe-bottom);background:var(--card);border-top:1px solid var(--border);
  box-shadow:0 -10px 30px rgba(0,0,0,.35);border-top-left-radius:16px;border-top-right-radius:16px;
  display:grid;grid-template-columns:1fr 1fr 110px 1fr 1fr;align-items:center;z-index:1000
}
.navbtn{justify-self:center;display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted);text-decoration:none}
.navbtn .ms{font-family:'Material Symbols Rounded';font-size:26px;line-height:1;border-radius:50%;width:44px;height:44px;display:grid;place-items:center;background:#0f141b;border:1px solid rgba(255,255,255,.06)}
.navbtn.active{color:#79c0ff}
.fab{position:absolute;left:50%;transform:translateX(-50%);top:-26px;width:64px;height:64px;border-radius:999px;
  background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
  border:1px solid rgba(255,255,255,.06);display:grid;place-items:center;color:#0d1117;font-size:34px;box-shadow:0 14px 26px rgba(0,0,0,.5)
}

.modal{position:fixed;inset:0;display:none;place-items:end;background:rgba(0,0,0,.45);padding:14px;z-index:1200}
.modal.on{display:grid}
.sheet{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px 14px 16px}

.gate{position:fixed;inset:0;display:none;place-items:center;background:var(--bg);padding:18px;z-index:2000}
.panel{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;width:min(520px,92vw)}
.tabs{display:flex;gap:6px;margin-bottom:10px}
.tabs button{flex:1;border:1px solid var(--border);background:#21262d;color:#e6edf3;border-radius:10px;padding:10px;font-weight:800}
.tabs button.active{background:linear-gradient(180deg,var(--primary),var(--primary2));border-color:#2ea043;color:#fff}

/* detay kutuları */
details.box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px 12px}
details.box>summary{list-style:none;cursor:pointer;font-weight:800}
details.box>summary::-webkit-details-marker{display:none}

@media(min-width:720px){.wrap{max-width:560px;margin:0 auto}}
</style>
</head>
<body>

<!-- GİRİŞ -->
<div id="gate" class="gate">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center"><b>Normal Holding</b><span class="muted">Bulut</span></div>
    <div class="tabs">
      <button id="tLogin" class="active" onclick="swAuth('login')">Giriş</button>
      <button id="tReg" onclick="swAuth('reg')">Kayıt</button>
    </div>
    <div id="vLogin">
      <label>Email</label><input id="loginEmail" placeholder="user@mail.com" autocomplete="username">
      <div class="row" style="margin-top:8px"><div style="flex:1"><label>Şifre</label><input id="loginPass" type="password" autocomplete="current-password" placeholder="••••••"></div></div>
      <div class="actions"><button class="btnP" onclick="login()">Giriş yap</button></div>
      <div id="authMsg" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="vReg" style="display:none">
      <label>Email</label><input id="regEmail" placeholder="user@mail.com" autocomplete="username">
      <div class="row" style="margin-top:8px"><div style="flex:1"><label>Şifre (≥6)</label><input id="regPass" type="password" autocomplete="new-password"></div></div>
      <div class="actions"><button class="btnS" onclick="swAuth('login')">Geri</button><button class="btnP" onclick="registerUser()">Hesap oluştur</button></div>
      <div id="regMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- UYGULAMA -->
<div id="app" class="wrap" style="display:none">
  <header>
    <div class="top">
      <div style="font-weight:900">Normal Holding</div>
      <div class="who" id="who">@</div>
    </div>
    <div class="title"><span class="name" id="hdrTitle">Cüzdan</span><span class="badge" id="netBadge" style="display:none"></span></div>
    <div class="big" id="hdrBig">0</div>
    <div class="sub" id="hdrSub">Toplam (varsayılan kura çevrildi): 0</div>

    <!-- Geçici CÜZDAN görünümü -->
    <div id="walletSeg" class="seg" style="grid-template-columns:repeat(4,1fr)"></div>
  </header>

  <div class="stats">
    <div class="card"><h5>Bu cüzdan – Toplam harcama</h5><div class="v" id="stTotal">0</div></div>
    <div class="card"><h5>Bugün</h5><div class="v" id="stToday">0</div></div>
    <div class="card"><h5>Bu ay</h5><div class="v" id="stMonth">0</div></div>
  </div>

  <main>
    <!-- ANA -->
    <section id="tab-home">
      <h3 class="sec">💼 Cüzdanlar (hepsi)</h3>
      <div id="walletsList" class="list" style="margin-bottom:8px"></div>

      <h3 class="sec" style="margin-top:10px">🕒 Son hareketler (tüm kurlar)</h3>
      <div id="recentList" class="list"></div>
      <div id="emptyHome" class="muted" style="text-align:center;margin-top:10px">Henüz hareket yok.</div>
    </section>

    <!-- AYARLAR -->
    <section id="tab-settings" style="display:none">
      <h3 class="sec">⚙️ Ayarlar</h3>

      <div class="item">
        <div class="ic"><span class="material-symbols-rounded ms">account_circle</span></div>
        <div class="meta"><div class="t">Kullanıcı</div><div class="s" id="userInfo">—</div></div>
        <button class="btnS" onclick="logout()"><span class="material-symbols-rounded">logout</span>&nbsp;Çıkış</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">💱 Varsayılan para birimi & sayı formatı</h4>
        <div class="row">
          <div style="flex:1">
            <label>Varsayılan para birimi</label>
            <select id="prefCurrency">
              <option>ALL</option><option>EUR</option><option>TRY</option><option>USD</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Sayı formatı</label>
            <select id="prefFormat">
              <option value="eu">23.456,78</option>
              <option value="us">23,456.78</option>
            </select>
          </div>
        </div>
        <div class="actions"><button class="btnP" onclick="savePrefs()">Kaydet</button></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">🏦 Mevcut para (seçili varsayılan için)</h4>
        <div class="row"><input id="balInput" type="number" step="0.01" placeholder="örn. 5000"></div>
        <div class="actions"><button class="btnP" onclick="saveBalance()">Kaydet</button></div>
        <div id="balMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <details class="box" style="margin-top:12px">
        <summary>📂 Kategoriler</summary>
        <div id="catList" class="list" style="margin-top:8px"></div>
        <div style="border-top:1px solid var(--border);margin:12px 0"></div>
        <div class="row">
          <div style="width:120px">
            <label>Emoji</label>
            <input id="newCatEmoji" value="🍔" />
          </div>
          <div style="flex:1">
            <label>Ad</label>
            <input id="newCatName" placeholder="örn. Yemek">
          </div>
        </div>
        <div class="actions"><button class="btnP" onclick="addCategory()">Ekle</button></div>
        <div id="catMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </details>
    </section>
  </main>
</div>

<!-- ALT NAV -->
<nav id="nav" style="display:none">
  <a class="navbtn active" data-tab="home" onclick="switchTab('home')">
    <span class="ms material-symbols-rounded">home</span><small>Ana</small>
  </a>
  <a class="navbtn" data-tab="settings" onclick="switchTab('settings')">
    <span class="ms material-symbols-rounded">settings</span><small>Ayarlar</small>
  </a>
  <button class="fab" id="fab">＋</button>
  <span></span><span></span>
</nav>

<!-- HAREKET EKLE MODAL -->
<div class="modal" id="mExp"><div class="sheet">
  <h3 style="margin:4px 0 8px">➕ Harcama ekle (aktif cüzdan)</h3>
  <div class="row"><div style="flex:2"><label>Ad</label><input id="xName" placeholder="örn. Benzin"></div><div style="flex:1"><label>Tutar</label><input id="xAmt" type="number" step="0.01" placeholder="0"></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label>Kategori</label><select id="xCat"></select></div><div style="flex:1"><label>Tarih</label><input id="xDate" type="date"></div></div>
  <div class="actions"><button class="btnS" onclick="closeExp()">Kapat</button><button class="btnP" onclick="saveExpense()">Kaydet</button></div>
</div></div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== Supabase (kendi projen ile değiştir) ===== */
const SUPABASE_URL='https://nvpjqvggaiipwziolend.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cGpxdmdnYWlpcHd6aW9sZW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4OTExNzcsImV4cCI6MjA3NDQ2NzE3N30.PnJh09kx-kK8iChgQl2M1eTw5P2qRZUEO31wVY7_iP4';
const sb = window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/* ===== State ===== */
const CURRENCIES=['ALL','EUR','TRY','USD'];   // TL = TRY
let user=null, profile=null, items=[], cats=[];
let prefs={curr:'ALL', fmt:'eu', balances:{}};
let walletView='ALL';               // başlıkta geçici seçili cüzdan
let ratesBaseEUR={base:'EUR',rates:{}};  // online kurlar (EUR tabanlı)

/* ===== Helpers ===== */
const $=id=>document.getElementById(id);
const nf=()=> new Intl.NumberFormat(prefs.fmt==='us'?'en-US':'de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
const money=(n,c=walletView)=> nf().format(Number(n||0))+' '+c;
const dateStr=iso=> new Date(iso+'T00:00:00').toLocaleDateString('tr-TR',{day:'2-digit',month:'short',year:'numeric'});
const isToday=d=>{const t=new Date(),x=new Date(d);return x.toDateString()===t.toDateString()};
const isThisMonth=d=>{const t=new Date(),x=new Date(d);return x.getFullYear()==t.getFullYear()&&x.getMonth()==t.getMonth()};

/* EUR tabanlı dönüştürme */
function convert(amount, from, to){
  if(!amount || from===to) return Number(amount||0);
  const r = ratesBaseEUR.rates || {};
  // from -> EUR
  let eur = (from==='EUR') ? Number(amount) : Number(amount)/ (r[from]||1);
  // EUR -> to
  return (to==='EUR') ? eur : eur * (r[to]||1);
}

/* ===== Auth ===== */
function swAuth(which){ $('tLogin').classList.toggle('active',which==='login'); $('tReg').classList.toggle('active',which==='reg'); $('vLogin').style.display=(which==='login')?'block':'none'; $('vReg').style.display=(which==='reg')?'block':'none';}
async function registerUser(){const email=$('regEmail').value.trim(), pass=$('regPass').value; const m=$('regMsg'); m.textContent=''; if(!email||pass.length<6){m.textContent='Email/şifre geçersiz';return;} const {error}=await sb.auth.signUp({email,password:pass}); m.textContent=error?('Hata: '+error.message):'Kaydedildi. Mailini doğrula.'}
async function login(){const email=$('loginEmail').value.trim(), pass=$('loginPass').value; const m=$('authMsg'); m.textContent=''; const {error}=await sb.auth.signInWithPassword({email,password:pass}); if(error) m.textContent='Hata: '+error.message;}
async function logout(){await sb.auth.signOut()}

/* ===== Profile ===== */
async function ensureProfile(){
  const {data} = await sb.from('profiles').select('*').eq('user_id',user.id).maybeSingle();
  if(!data){
    const ins={user_id:user.id, default_currency:'ALL', num_format:'eu', balances:{}};
    const {data:p}=await sb.from('profiles').insert(ins).select().single(); profile=p;
  }else profile=data;
  prefs.curr=profile.default_currency||'ALL';
  prefs.fmt=profile.num_format||'eu';
  prefs.balances=profile.balances||{};
  walletView=prefs.curr; // başlarken varsayılan
  $('prefCurrency').value=prefs.curr; $('prefFormat').value=prefs.fmt;
  $('balInput').value=Number(prefs.balances[prefs.curr]||0);
  $('who').textContent=(user.email||'').split('@')[0];
  $('userInfo').textContent=user.email||'—';
}

/* ===== Rates (online) ===== */
async function fetchRates(){
  try{
    const syms=CURRENCIES.join(',');
    const url=`https://api.exchangerate.host/latest?base=EUR&symbols=${syms}`;
    const res=await fetch(url,{cache:'no-store'});
    const js=await res.json();
    if(js && js.rates){ratesBaseEUR={base:'EUR',rates:js.rates}}
  }catch(e){
    // Basit yedek oranlar (yaklaşık)
    ratesBaseEUR={base:'EUR',rates:{EUR:1,USD:1.08,TRY:35,ALL:100}};
  }
}

/* ===== Categories ===== */
async function loadCats(){
  const seed=[{name:'Yemek',emoji:'🍔'},{name:'Ulaşım',emoji:'⛽'},{name:'Ev',emoji:'🏠'},{name:'Eğlence',emoji:'🎟️'},{name:'Fatura',emoji:'💡'},{name:'Diğer',emoji:'🧾'}];
  const {data:have}=await sb.from('categories').select('id').eq('user_id',user.id).limit(1);
  if(!have||have.length===0){await sb.from('categories').insert(seed.map(c=>({...c,user_id:user.id})));}
  const {data}=await sb.from('categories').select('*').eq('user_id',user.id).order('created_at',{ascending:true});
  cats=(data||[]).map(r=>({id:r.id,name:r.name,emoji:r.emoji}));
  // picker
  const sel=$('xCat'); sel.innerHTML=''; cats.forEach(c=>{const o=document.createElement('option'); o.value=c.name; o.textContent=(c.emoji||'•')+' '+c.name; sel.appendChild(o);});
  // list
  const box=$('catList'); box.innerHTML=''; cats.forEach(c=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div class="ic">${c.emoji||'•'}</div><div class="meta"><div class="t">${c.name}</div><div class="s">Kişisel kategori</div></div>
    <button class="btnS" onclick="delCat(${c.id})"><span class="material-symbols-rounded">delete</span>&nbsp;Sil</button>`;
    box.appendChild(el);
  });
}
async function addCategory(){
  const name=($('newCatName').value||'').trim(); const emoji=($('newCatEmoji').value||'').trim()||'🧾'; const m=$('catMsg'); m.textContent='';
  if(!name){m.textContent='Kategori adı boş olamaz.';return;}
  const {data,error}=await sb.from('categories').insert({user_id:user.id,name,emoji}).select().single();
  if(error){m.textContent='Hata: '+error.message;return;}
  $('newCatName').value=''; await loadCats(); m.textContent='Eklendi.';
}
async function delCat(id){ if(!confirm('Silinsin mi?'))return; await sb.from('categories').delete().eq('user_id',user.id).eq('id',id); await loadCats(); }

/* ===== Expenses ===== */
async function loadExpenses(){
  const {data,error}=await sb.from('expenses').select('*').eq('user_id',user.id).order('d',{ascending:false}).limit(2000);
  if(error){alert('Hata (harcamalar): '+error.message); return;}
  items=data||[];
  drawHome(); refreshHeader();
}
async function saveExpense(){
  const name=$('xName').value.trim(), amt=parseFloat($('xAmt').value), cat=$('xCat').value, d=$('xDate').value;
  if(!name || !amt || !d || isNaN(amt)){alert('Ad, tutar, tarih zorunlu.');return;}
  const row={user_id:user.id,name,amount:amt,category:cat,d,curr:walletView};  // EK: curr
  const {data,error}=await sb.from('expenses').insert(row).select().single();
  if(error){alert('Hata: '+error.message);return;}
  items.unshift(data); $('xName').value=''; $('xAmt').value=''; closeExp(); drawHome(); refreshHeader();
}
async function delExpense(id){ if(!confirm('Silinsin mi?'))return; await sb.from('expenses').delete().eq('user_id',user.id).eq('id',id); items=items.filter(x=>x.id!==id); drawHome(); refreshHeader(); }

/* ===== Balances (profile.balances jsonb) ===== */
async function saveBalance(){
  const val=parseFloat($('balInput').value||'0')||0;
  const balances={...(profile.balances||{})}; balances[prefs.curr]=val;
  const {data,error}=await sb.from('profiles').update({balances}).eq('user_id',user.id).select().single();
  if(error){$('balMsg').textContent='Hata: '+error.message;return;}
  profile=data; prefs.balances=profile.balances||{}; $('balMsg').textContent='Kaydedildi.'; drawHome(); refreshHeader();
}

/* ===== Prefs ===== */
async function savePrefs(){
  const nc=$('prefCurrency').value, nfsel=$('prefFormat').value;
  const {data,error}=await sb.from('profiles').update({default_currency:nc,num_format:nfsel}).eq('user_id',user.id).select().single();
  if(error){alert('Hata: '+error.message);return;}
  profile=data; prefs.curr=profile.default_currency; prefs.fmt=profile.num_format; walletView=prefs.curr;
  $('balInput').value=Number((profile.balances||{})[prefs.curr]||0);
  buildWalletSeg(); drawHome(); refreshHeader();
}

/* ===== UI ===== */
function openExp(){ $('xDate').value=new Date().toISOString().slice(0,10); $('mExp').classList.add('on'); }
function closeExp(){ $('mExp').classList.remove('on'); }
function switchTab(t){
  if(t==='home'){ $('tab-home').style.display='block'; $('tab-settings').style.display='none'; }
  else{ $('tab-home').style.display='none'; $('tab-settings').style.display='block'; }
  document.querySelectorAll('.navbtn').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.navbtn[data-tab="${t}"]`).classList.add('active');
}
function buildWalletSeg(){
  const box=$('walletSeg'); box.innerHTML='';
  CURRENCIES.forEach(c=>{
    const b=document.createElement('button'); b.textContent=c; b.className=(c===walletView)?'active':''; b.onclick=()=>{walletView=c; buildWalletSeg(); drawHome(); refreshHeader();}
    box.appendChild(b);
  });
}
function renderWallets(){
  const box=$('walletsList'); box.innerHTML='';
  CURRENCIES.forEach(c=>{
    const sumExp=items.filter(x=>x.curr===c).reduce((s,n)=>s+Number(n.amount||0),0);
    const bal=Number((prefs.balances||{})[c]||0);
    const remain=bal - sumExp;
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div class="ic">💼</div>
      <div class="meta"><div class="t">${c} cüzdanı</div><div class="s">Bakiye: ${nf().format(bal)} • Harcama: ${nf().format(sumExp)}</div></div>
      <div class="amt">${nf().format(remain)} ${c}</div>`;
    box.appendChild(el);
  });
}
function rowExpense(x){
  const el=document.createElement('div'); el.className='item';
  const emoji = (cats.find(c=>c.name===x.category)||{}).emoji || '💸';
  el.innerHTML=`<div class="ic">${emoji}</div>
    <div class="meta"><div class="t">${x.name}</div><div class="s">${x.category||'-'} • ${dateStr(x.d)} • ${x.curr||'?'}</div></div>
    <div class="amt">${nf().format(x.amount)} ${x.curr||''}</div>
    <button class="del" title="Sil" onclick="delExpense(${x.id})">🗑️</button>`;
  return el;
}
function drawHome(){
  // son hareketler (tüm kurlar)
  const list=$('recentList'); list.innerHTML='';
  const recent=[...items].sort((a,b)=>b.d.localeCompare(a.d)).slice(0,12);
  recent.forEach(x=>list.appendChild(rowExpense(x)));
  $('emptyHome').style.display=recent.length?'none':'block';
  renderWallets();

  // kategori select
  const sel=$('xCat'); if(sel && sel.options.length===0){ cats.forEach(c=>{const o=document.createElement('option'); o.value=c.name; o.textContent=(c.emoji||'•')+' '+c.name; sel.appendChild(o);}); }
}

/* Başlık ve istatistikler */
function refreshHeader(){
  // Aktif cüzdan için rakamlar
  const expW=items.filter(x=>x.curr===walletView);
  const today=expW.filter(x=>isToday(x.d)).reduce((s,n)=>s+Number(n.amount||0),0);
  const month=expW.filter(x=>isThisMonth(x.d)).reduce((s,n)=>s+Number(n.amount||0),0);
  const total=expW.reduce((s,n)=>s+Number(n.amount||0),0);
  const bal=Number((prefs.balances||{})[walletView]||0);
  const remain=bal - total;

  $('hdrTitle').textContent=`${walletView} cüzdanı`;
  $('hdrBig').textContent = nf().format(remain) + ' ' + walletView;
  $('stTotal').textContent = nf().format(total) + ' ' + walletView;
  $('stToday').textContent = nf().format(today) + ' ' + walletView;
  $('stMonth').textContent = nf().format(month) + ' ' + walletView;

  // Net varlık: tüm cüzdanların (bakiye - o cüzdan harcaması) toplamı, PROFİL VARSAYILAN kura çevrilerek
  const def = prefs.curr || 'ALL';
  let netEUR = 0;
  CURRENCIES.forEach(c=>{
    const exp = items.filter(x=>x.curr===c).reduce((s,n)=>s+Number(n.amount||0),0);
    const bal = Number((prefs.balances||{})[c]||0);
    const remain = bal - exp; // o cüzdanın neti
    netEUR += convert(remain, c, 'EUR');
  });
  const netInDef = convert(netEUR, 'EUR', def);
  $('hdrSub').textContent = `Toplam (varsayılan ${def}): ${nf().format(netInDef)} ${def}`;
  $('netBadge').style.display='inline-block';
  $('netBadge').textContent='kurlar güncel';
}

/* ===== Boot ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  // FAB
  $('fab').addEventListener('click', openExp);
  $('xDate').value=new Date().toISOString().slice(0,10);

  // Auth session
  const {data:{session}} = await sb.auth.getSession();
  if(session?.user){ user=session.user; await afterLogin(); } else { $('gate').style.display='grid'; }

  sb.auth.onAuthStateChange(async (_e,session)=>{
    if(session?.user){ user=session.user; await afterLogin(); } else { user=null; $('gate').style.display='grid'; $('app').style.display='none'; $('nav').style.display='none'; }
  });
});

async function afterLogin(){
  $('gate').style.display='none'; $('app').style.display='block'; $('nav').style.display='grid';
  await ensureProfile();
  await fetchRates();
  buildWalletSeg();
  await loadCats();
  await loadExpenses();
  refreshHeader();
}
</script>

<!-- ============================  SQL – TEK SEFER ÇALIŞTIR  ============================
Supabase SQL Editöründe topluca çalıştır (her satır güvenlidir, "IF NOT EXISTS" / DO $$ ile). -->
<!--
-- 1) PROFİL
create table if not exists public.profiles (
  user_id uuid primary key references auth.users(id) on delete cascade,
  default_currency text not null default 'ALL',
  num_format text not null default 'eu',
  balances jsonb not null default '{}'::jsonb
);
alter table public.profiles enable row level security;
do $$ begin
  create policy "profiles_select_own" on public.profiles for select using (auth.uid()=user_id);
exception when duplicate_object then null; end $$;
do $$ begin
  create policy "profiles_update_own" on public.profiles for update using (auth.uid()=user_id) with check (auth.uid()=user_id);
exception when duplicate_object then null; end $$;

-- 2) KATEGORİ
create table if not exists public.categories (
  id bigserial primary key,
  user_id uuid not null references auth.users(id) on delete cascade,
  name text not null,
  emoji text default '🧾',
  created_at timestamp with time zone default now()
);
alter table public.categories enable row level security;
do $$ begin
  create policy "cat_all_own" on public.categories
  for all using (auth.uid()=user_id) with check (auth.uid()=user_id);
exception when duplicate_object then null; end $$;

-- 3) HARCAMALAR
create table if not exists public.expenses (
  id bigserial primary key,
  user_id uuid not null references auth.users(id) on delete cascade,
  name text not null,
  amount numeric(12,2) not null,
  category text,
  d date not null,
  curr text not null default 'ALL',
  created_at timestamp with time zone default now()
);
-- eksikse curr ekle
do $$ begin
  alter table public.expenses add column curr text not null default 'ALL';
exception when duplicate_column then null; end $$;

create index if not exists exp_user_idx on public.expenses(user_id);
create index if not exists exp_date_idx on public.expenses(d);

alter table public.expenses enable row level security;
do $$ begin
  create policy "exp_all_own" on public.expenses
  for all using (auth.uid()=user_id) with check (auth.uid()=user_id);
exception when duplicate_object then null; end $$;
-->
</body>
</html>
