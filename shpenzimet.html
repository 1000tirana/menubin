<!DOCTYPE html>
<html lang="sq" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>Normal Holding • Shpenzimet</title>
<meta name="theme-color" content="#0d1117">

<!-- Google Icons (Material Symbols Rounded) -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,500,0,0" rel="stylesheet">

<style>
:root{
  --bg:#0d1117; --card:#161b22; --border:#30363d;
  --text:#c9d1d9; --muted:#8b949e;
  --primary:#2ea043; --primary2:#238636;
  --blue:#1f6feb; --danger:#f85149;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bottom:env(safe-area-inset-bottom,0px);
  --nav-h:88px;
}
*{box-sizing:border-box}
html,body{height:100%;background:var(--bg);overscroll-behavior-y:none;overflow-x:hidden}
body{margin:0;color:var(--text);font:400 16px ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
.wrap{display:flex;flex-direction:column;min-height:100vh;padding-bottom:calc(var(--nav-h) + var(--safe-bottom))}
header{
  background:linear-gradient(135deg,var(--primary2) 0%, var(--primary) 100%);
  color:#fff;border-bottom-left-radius:22px;border-bottom-right-radius:22px;
  padding:calc(10px + var(--safe-top)) 16px 12px; box-shadow:0 10px 28px rgba(35,134,54,.35)
}
header .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
header .title{display:flex;align-items:center;gap:10px;margin-top:6px}
header .title .t{font-size:22px;font-weight:900}
header .big{font-size:34px;font-weight:900;margin-top:8px}
header .muted{color:#e6edf3;opacity:.8}
header .seg{display:flex;gap:6px}
header .seg button{border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.15);color:#fff;padding:6px 10px;border-radius:999px;font-weight:700}
header .seg button.active{background:#fff;color:#0d1117}

.stats{display:flex;gap:10px;padding:10px 12px;transform:translateY(-12px)}
.card{flex:1;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
.card h4{margin:0 0 8px;font-size:14px;color:#e6edf3}
main{padding:0 12px 20px}
h3.sec{margin:0 0 8px}

.list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.item{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px}

.ic{width:52px;height:52px;border-radius:50%;display:grid;place-items:center;
  background:#101418;border:1px solid #1f2328;box-shadow:inset 0 1px 2px rgba(255,255,255,.04), 0 10px 22px rgba(0,0,0,.45);font-size:26px}
.meta{flex:1}
.meta .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#e6edf3}
.meta .s{font-size:12px;color:var(--muted)}
.amt{font-weight:900;color:#e6edf3}
.del{border:none;background:transparent;color:var(--danger);font-size:20px;cursor:pointer}

.row{display:flex;gap:10px}
label{font-size:13px;color:var(--muted)}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;
  font-size:16px;background:var(--card);color:var(--text);-webkit-appearance:none}
select{padding-right:30px}
.actions{display:flex;gap:10px;margin-top:10px}
.btnP,.btnS,.btnMini{font-size:16px;-webkit-tap-highlight-color:transparent; user-select:none}
.btnP{flex:1;background:linear-gradient(180deg,var(--primary) 0%, var(--primary2) 100%);color:#fff;border:1px solid #2ea043;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
.btnS{flex:1;background:#21262d;color:#e6edf3;border:1px solid var(--border);padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
.btnMini{background:#21262d;border:1px solid var(--border);padding:8px 10px;border-radius:10px;font-weight:800;color:#e6edf3;cursor:pointer}
.chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#1f6feb;color:#fff}

/* Alt NAV */
nav.nav{
  position:fixed;left:0;right:0;bottom:0;transform:translateZ(0);
  height:var(--nav-h);padding:10px 12px calc(10px + var(--safe-bottom));
  background:var(--card);border-top:1px solid var(--border);box-shadow:0 -10px 30px rgba(0,0,0,.35);
  border-top-left-radius:16px;border-top-right-radius:16px;z-index:2000;
  display:grid;grid-template-columns:1fr 1fr 90px 1fr 1fr;align-items:center;
}
.btn{justify-self:center;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);text-decoration:none}
.btn .ms{font-family:"Material Symbols Rounded";font-size:24px;line-height:24px}
.btn .ico{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;
  background:#101418;border:1px solid #1f2328;box-shadow:inset 0 1px 2px rgba(255,255,255,.04), 0 10px 22px rgba(0,0,0,.45)}
.btn.active{color:#79c0ff}
.btn.active .ico{outline:2px solid #79c0ff33}

.nav .fab{
  position:absolute;left:50%;transform:translateX(-50%);
  top:-22px;width:58px;height:58px;border-radius:999px;
  background:#1a7f37;border:1px solid #36c270;color:#fff;font-size:30px;
  display:grid;place-items:center;box-shadow:0 14px 26px rgba(0,0,0,.5), inset 0 1px 4px rgba(255,255,255,.15);
  cursor:pointer;z-index:2100;pointer-events:auto
}
@supports (-webkit-touch-callout: none){.nav .fab{top:-24px}}
.tab{display:none}.tab.active{display:block}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:end;padding:14px;z-index:3000}
.modal.on{display:grid}
.sheet{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:18px;padding:14px 14px 18px;width:100%;box-shadow:0 -12px 30px rgba(0,0,0,.5)}

/* Collapsible */
.cHead{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0f141a}
.cBody{margin-top:10px}

/* Emoji picker modal */
.picker-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;max-height:45vh;overflow:auto;margin-top:8px}
.picker-grid button{border:1px solid var(--border);background:#21262d;border-radius:10px;width:44px;height:44px;font-size:22px;cursor:pointer}
#emojiBtn{display:flex;gap:8px;align-items:center;width:100%}
#emojiPreview{font-size:28px;width:44px;height:44px;display:grid;place-items:center}

/* Helper */
.hide{display:none!important}
@media(min-width:720px){.wrap{max-width:520px;margin:0 auto}}
</style>
</head>
<body>

/* === HATA YAKALAYICI & DEBUG === */
const DEBUG = location.search.includes('debug');
function overlay(msg){
  if(!DEBUG) return;
  let o = document.getElementById('debugOverlay');
  if(!o){
    o = document.createElement('pre');
    o.id='debugOverlay';
    Object.assign(o.style,{
      position:'fixed',inset:'12px',background:'rgba(0,0,0,.85)',
      color:'#9fe',padding:'12px',zIndex:99999,overflow:'auto',
      border:'1px solid #355',borderRadius:'8px',fontSize:'12px'
    });
    document.body.appendChild(o);
  }
  o.textContent = String(msg);
}
window.addEventListener('error', e=>overlay(e.error?.stack||e.message));
window.addEventListener('unhandledrejection', e=>overlay(e.reason?.stack||e.reason));

/* === AÇILIŞ === */
document.addEventListener('DOMContentLoaded', init);

async function init(){
  // Loader görünür
  const loader = document.getElementById('gate') || document.body;
  try{
    // 1) Oturum durumunu al
    const {data:{session}} = await supabase.auth.getSession();

    // 2) Ekranı göster – veri yüklemeyi BEKLEMEDEN
    if(session?.user){
      sessionUser = session.user;
      showApp();
    }else{
      showGate();
    }

    // 3) Veri yükleme: kilitlenmesin diye allSettled
    const jobs = [
      ensureProfile(),
      ensureCategoriesSeed(),
      loadCategories(),
      loadExpenses(),
      loadDebts()
    ];
    Promise.allSettled(jobs).then(()=>refreshHeader());

    // 4) Oturum değişirse yine çalışsın
    supabase.auth.onAuthStateChange(async (_e,s)=>{
      if(s?.user){
        sessionUser = s.user;
        showApp();
        Promise.allSettled([ensureProfile(),ensureCategoriesSeed(),loadCategories(),loadExpenses(),loadDebts()])
          .then(()=>refreshHeader());
      }else{
        sessionUser = null;
        showGate();
      }
    });

    // 5) 8 sn’de oturum yoksa kapatma – loaderda kalmasın
    setTimeout(()=>{ if(!sessionUser){ showGate(); } }, 8000);

  }catch(err){
    overlay(err?.stack||err);
    showGate(); // en azından arayüz açılsın
  }
}

<!-- GATE -->
<div id="gate" class="wrap hide">
  <main style="display:grid;place-items:center;min-height:100vh;padding-bottom:0">
    <div class="card" style="width:min(560px,92vw);padding:16px;border-radius:16px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900;font-size:18px" id="g_app">Normal Holding</div>
        <div class="muted" id="g_cloud">Shpenzimet • Cloud</div>
      </div>
      <div class="row" style="margin-top:12px">
        <div style="flex:1"><label id="g_email_l">Email</label><input id="loginEmail" placeholder="emri@gmail.com" autocomplete="username"></div>
        <div style="flex:1"><label id="g_pass_l">Fjalëkalimi</label><input id="loginPass" type="password" autocomplete="current-password" placeholder="•••••••"></div>
      </div>
      <div class="actions"><button class="btnS" id="btnReg">Regjistrohu</button><button class="btnP" id="btnLogin">Hyr</button></div>
      <div id="authMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </main>
</div>

<!-- APP -->
<div class="wrap hide" id="app">
  <header>
    <div class="top">
      <div style="font-weight:800" id="h_appname">Normal Holding</div>
      <div class="muted" id="who">@user</div>
    </div>
    <div class="title">
      <span class="ms" style="font-family:'Material Symbols Rounded';">account_balance_wallet</span>
      <span class="t" id="hdrText">Bilanci</span>
      <div style="flex:1"></div>
      <!-- Görünüm Cüzdanı -->
      <div class="seg" id="viewCurrSeg"></div>
    </div>
    <div class="big"><span id="hdrTotal">0,00</span> <span id="hdrCurr">ALL</span></div>
    <div class="muted" id="hdrSub">Gjendja − Shpenzimet (totale)</div>
  </header>

  <div class="stats" id="statsRow">
    <div class="card"><h4 id="s1name">📊 Totale</h4><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat1">0,00</span> <span id="sCurr1">ALL</span></div></div>
    <div class="card"><h4 id="s2name">📅 Sot</h4><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat2">0,00</span> <span id="sCurr2">ALL</span></div></div>
    <div class="card"><h4 id="s3name">🗓️ Muaj</h4><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="stat3">0,00</span> <span id="sCurr3">ALL</span></div></div>
  </div>

  <main>
    <section id="tab-home" class="tab active">
      <h3 class="sec" id="t_recent">🕒 Të fundit</h3>
      <div id="recentList" class="list"></div>
      <div id="emptyHome" class="muted" style="text-align:center;margin-top:16px">Asnjë hyrje deri tani.</div>
    </section>

    <section id="tab-list" class="tab">
      <h3 class="sec" id="t_list">📚 Lista</h3>
      <div class="row" style="margin:8px 0 10px">
        <input id="q" placeholder="Kërko..." oninput="drawAll()">
        <select id="fCat" onchange="drawAll()"><option value="" id="f_all">Të gjitha</option></select>
      </div>
      <div id="allList" class="list"></div>
    </section>

    <section id="tab-debts" class="tab">
      <h3 class="sec" id="t_debts">💳 Borxhet</h3>
      <div class="row" style="margin:8px 0 10px"><input id="dq" placeholder="Kërko borxhe..." oninput="drawDebts()"></div>
      <div class="row" style="gap:6px;margin-bottom:6px">
        <button class="btnMini" id="dAll">Të gjitha</button>
        <button class="btnMini" id="dBorrow">Mora hua</button>
        <button class="btnMini" id="dLend">Dhash hua</button>
      </div>
      <div id="debtList" class="list"></div>
      <div id="emptyDebts" class="muted" style="text-align:center;margin-top:16px">Asnjë borxh deri tani.</div>
    </section>

    <section id="tab-settings" class="tab">
      <h3 class="sec" id="t_settings">⚙️ Cilësime</h3>

      <div class="item">
        <div class="ic"><span class="ms">person</span></div>
        <div class="meta"><div class="t" id="u_user">Përdoruesi</div><div class="s muted" id="userInfo">—</div></div>
        <button class="btnMini" onclick="logout()" id="u_logout">Dil</button>
      </div>

      <!-- Preferenca -->
      <div class="card" style="margin-top:12px">
        <div class="cHead" onclick="toggleBox('prefBox')">
          <div><span class="ms">payments</span> <b id="prefTitle">Monedha & format</b></div>
          <span class="ms">expand_more</span>
        </div>
        <div id="prefBox" class="cBody">
          <div class="row" style="margin-top:10px">
            <div style="flex:1">
              <label id="prefCurrLbl">Monedha aktuale (për hyrjet e reja)</label>
              <select id="prefCurr">
                <option value="ALL">ALL — Albania Lek</option>
                <option value="EUR">EUR — Euro</option>
                <option value="TRY">TRY — Turkish Lira</option>
                <option value="USD">USD — US Dollar</option>
              </select>
            </div>
            <div style="flex:1">
              <label id="prefFmtLbl">Formati i numrave</label>
              <select id="prefFmt">
                <option value="eu">23.456,78</option>
                <option value="us">23,456.78</option>
              </select>
            </div>
          </div>
          <div class="actions"><button class="btnP" onclick="savePrefs()" id="prefSave">Ruaj preferencat</button></div>
          <div id="prefMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
        </div>
      </div>

      <!-- Dil -->
      <div class="card" style="margin-top:12px">
        <div class="cHead" onclick="toggleBox('langBox')">
          <div><span class="ms">translate</span> <b id="langTitle">Gjuha</b></div>
          <span class="ms">expand_more</span>
        </div>
        <div id="langBox" class="cBody">
          <div class="row" style="margin-top:10px">
            <select id="prefLang">
              <option value="sq">Shqip (default)</option>
              <option value="en">English</option>
              <option value="tr">Türkçe</option>
            </select>
          </div>
          <div class="actions"><button class="btnP" onclick="saveLanguage()" id="langSave">Ruaj</button></div>
          <div id="langMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
        </div>
      </div>

      <!-- Gjendja e monedhës aktive -->
      <div class="card" style="margin-top:12px">
        <div class="cHead" onclick="toggleBox('balBox')">
          <div><span class="ms">account_balance</span> <b id="balTitle">Gjendja e monedhës aktuale (<span id="balCurrLbl">ALL</span>)</b></div>
          <span class="ms">expand_more</span>
        </div>
        <div id="balBox" class="cBody">
          <div class="row" style="margin-top:10px"><input id="balInput" type="number" step="0.01" inputmode="decimal" placeholder="p.sh. 5000"></div>
          <div class="actions"><button class="btnP" onclick="saveBalance()" id="balSave">Ruaj gjendjen</button></div>
          <div class="muted" id="balMsg" style="margin-top:6px;font-size:12px"></div>
        </div>
      </div>

      <!-- Kategoriat -->
      <div class="card" style="margin-top:12px">
        <div class="cHead" onclick="toggleBox('catBox')">
          <div><span class="ms">label</span> <b id="catTitle">Kategoritë</b></div>
          <span class="ms">expand_more</span>
        </div>
        <div id="catBox" class="cBody">
          <div id="catList" class="list" style="margin-top:8px"></div>
          <div style="border-top:1px solid var(--border);margin:12px 0"></div>
          <div class="row">
            <div style="width:140px">
              <label id="catEmojiLbl">Emoji</label>
              <button class="btnS" id="emojiBtn" onclick="openEmojiPicker()"><span id="emojiPreview">🍔</span> <span id="catEmojiBtn">Zgjidh emoji</span></button>
              <input id="newCatEmoji" value="🍔" hidden>
            </div>
            <div style="flex:1">
              <label id="catNameLbl">Emri i kategorisë</label>
              <input id="newCatName" placeholder="p.sh. Ushqime">
            </div>
          </div>
          <div class="actions"><button class="btnP" onclick="addCategory()" id="catAdd">Shto kategori</button></div>
          <div id="catMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
        </div>
      </div>

      <!-- Ndrysho email / fjalëkalim -->
      <div class="card" style="margin-top:12px">
        <div class="cHead" onclick="toggleBox('accBox')">
          <div><span class="ms">manage_accounts</span> <b id="accTitle">Llogaria</b></div>
          <span class="ms">expand_more</span>
        </div>
        <div id="accBox" class="cBody">
          <div class="row" style="margin-top:10px"><input id="newEmail" placeholder="email i ri p.sh. user@domain.com"></div>
          <div class="actions"><button class="btnP" onclick="changeEmail()" id="emailSave">Ruaj email</button></div>
          <div id="emailMsg" class="muted" style="margin-top:6px;font-size:12px"></div>

          <div style="height:10px"></div>
          <div class="row">
            <input id="newPass" type="password" placeholder="Fjalëkalimi i ri (min. 6)">
            <input id="newPass2" type="password" placeholder="Përsërit fjalëkalimin">
          </div>
          <div class="actions"><button class="btnP" onclick="changePassword()" id="passSave">Ruaj fjalëkalimin</button></div>
          <div id="passMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Alt menü + FAB -->
<nav class="nav hide" id="navbar">
  <a class="btn active" data-tab="home" onclick="switchTab('home')"><div class="ico"><span class="ms">home</span></div><span id="navHome">Kreu</span></a>
  <a class="btn" data-tab="list" onclick="switchTab('list')"><div class="ico"><span class="ms">task</span></div><span id="navList">Lista</span></a>
  <a class="btn" data-tab="debts" onclick="switchTab('debts')"><div class="ico"><span class="ms">credit_card</span></div><span id="navDebts">Borxhet</span></a>
  <a class="btn" data-tab="settings" onclick="switchTab('settings')"><div class="ico"><span class="ms">settings</span></div><span id="navSettings">Cilësime</span></a>
  <button class="fab" id="openAdd" aria-label="Shto">＋</button>
</nav>

<!-- Modal: Shpenzim -->
<div class="modal" id="modalExp"><div class="sheet">
  <h3 style="margin:4px 0 10px" id="mExpT">➕ Shto shpenzim</h3>
  <div class="row"><div style="flex:2"><label id="mNameL">Emri</label><input id="mName" placeholder="p.sh. Karburant"></div><div style="flex:1"><label id="mAmtL">Shuma</label><input id="mAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label id="mCatL">Kategoria</label><select id="mCat"></select></div><div style="flex:1"><label id="mDateL">Data</label><input id="mDate" type="date"></div></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Exp')" id="mClose">Mbyll</button><button class="btnP" onclick="saveExpense()" id="mSave">Ruaj</button></div>
</div></div>

<!-- Modal: Borxh -->
<div class="modal" id="modalDebt"><div class="sheet">
  <h3 style="margin:4px 0 10px" id="dT">➕ Shto borxh</h3>
  <div class="row">
    <div style="flex:1"><label id="dPartyL">Palë (Emri)</label><input id="dParty" placeholder="p.sh. Arben / ACME sh.p.k."></div>
    <div style="flex:1"><label id="dAmtL">Shuma</label><input id="dAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label id="dKindL">Lloji</label>
      <select id="dKind">
        <option value="borrow" id="dKindBorrow">Mora hua</option>
        <option value="lend" id="dKindLend">Dhash hua</option>
      </select>
    </div>
    <div style="flex:1"><label id="dDueL">Afati (opsionale)</label><input id="dDate" type="date"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <div style="flex:1"><label id="dNameL">Përshkrimi (opsionale)</label><input id="dName" placeholder="p.sh. Telefon i ri"></div>
  </div>
  <div class="actions"><button class="btnS" onclick="closeModal('Debt')" id="dClose">Mbyll</button><button class="btnP" onclick="saveDebt()" id="dSave">Ruaj</button></div>
</div></div>

<!-- Modal: Emoji seçici -->
<div class="modal" id="modalEmoji"><div class="sheet">
  <h3 style="margin:4px 0 10px" id="emoT">🙂 Zgjidh një emoji</h3>
  <div id="emojiGrid" class="picker-grid"></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Emoji')" id="emoClose">Mbyll</button></div>
</div></div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

<script>
/* ---------- Boot & hata yakalayıcı ---------- */
(function(){
  const boot = document.getElementById('boot');
  function showError(msg){
    if(!boot) return;
    boot.innerHTML =
      '<div style="max-width:560px;padding:16px;border:1px solid #30363d;border-radius:12px;background:#161b22;box-shadow:0 10px 30px rgba(0,0,0,.35)">' +
      '<div style="font-weight:800;margin-bottom:8px">⚠️ Hata</div>' +
      '<div style="white-space:pre-wrap;word-break:break-word;color:#f85149">' + (msg||'Bilinmeyen hata') + '</div>' +
      '<div style="margin-top:10px;color:#8b949e">Sayfayı yenileyin. Devam ederse, SQL şemasını uyguladığınızdan emin olun.</div>' +
      '</div>';
  }
  window.addEventListener('error', e=>showError(e.message||String(e)));
  window.addEventListener('unhandledrejection', e=>showError((e.reason&&e.reason.message)||String(e.reason)));
})();

/* ---------- App State ---------- */
const SUPABASE_URL='https://nvpjqvggaiipwziolend.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cGpxdmdnYWlpcHd6aW9sZW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4OTExNzcsImV4cCI6MjA3NDQ2NzE3N30.PnJh09kx-kK8iChgQl2M1eTw5P2qRZUEO31wVY7_iP4';

let supabase;            // client
let sessionUser=null;    // auth user
let profile={default_currency:'ALL', num_format:'eu', balances:{}, lang:'sq'}; 
let cats=[]; let items=[], debts=[];
let activeTab='home'; let viewCurr='ALL';
let rates={EUR:{ALL:100,TRY:36.0,USD:1.07,EUR:1}, ALL:{EUR:0.01,TRY:0.36,USD:0.0107,ALL:1}, TRY:{EUR:0.0278,ALL:2.77,USD:0.0298,TRY:1}, USD:{EUR:0.93,ALL:93.0,TRY:33.5,USD:1}};

/* ---------- i18n ---------- */
const I18N={
  sq:{app:'Normal Holding',cloud:'Shpenzimet • Cloud',
      nav_home:'Kreu',nav_list:'Lista',nav_debts:'Borxhet',nav_settings:'Cilësime',
      hdr_balance:'Bilanci',hdr_debts:'Borxhet',hdr_sub:'Gjendja − Shpenzimet (totale)',
      stat_total:'📊 Totale',stat_today:'📅 Sot',stat_month:'🗓️ Muaj',
      recent:'🕒 Të fundit',empty_home:'Asnjë hyrje deri tani.',
      list:'📚 Lista',search:'Kërko...',all:'Të gjitha',
      debts:'💳 Borxhet',debt_search:'Kërko borxhe...',debts_all:'Të gjitha',debts_borrow:'Mora hua',debts_lend:'Dhash hua',empty_debts:'Asnjë borxh deri tani.',
      user:'Përdoruesi',logout:'Dil',
      pref_title:'Monedha & format',pref_curr:'Monedha aktuale (për hyrjet e reja)',pref_fmt:'Formati i numrave',pref_save:'Ruaj preferencat',saved:'U ruajt.',
      lang_title:'Gjuha',lang_save:'Ruaj',
      bal_title:'Gjendja e monedhës aktuale',bal_save:'Ruaj gjendjen',
      cats:'Kategoritë',cat_personal:'Kategori personale',cat_emoji:'Emoji',cat_choose:'Zgjidh emoji',cat_name:'Emri i kategorisë',cat_ph:'p.sh. Ushqime',cat_add:'Shto kategori',cat_added:'U shtua.',delete:'Fshi',
      acc:'Llogaria',email_save:'Ruaj email',pass_save:'Ruaj fjalëkalimin',pass_min:'Fjalëkalimi ≥ 6.',pass_mis:'Fjalëkalimet nuk përputhen.',email_done:'U dërgua linku i konfirmimit.',pass_done:'U përditësua.',
      gate_email:'Email',gate_pass:'Fjalëkalimi',register:'Regjistrohu',login:'Hyr',
      m_exp:'➕ Shto shpenzim',name:'Emri',amount:'Shuma',category:'Kategoria',date:'Data',close:'Mbyll',save:'Ruaj',
      m_debt:'➕ Shto borxh',party:'Palë (Emri)',kind:'Lloji',kind_borrow:'Mora hua',kind_lend:'Dhash hua',due:'Afati (opsionale)',desc:'Përshkrimi (opsionale)',
      paid:'Paguar',pay:'Paguaj',returned:'U kthye',
      c_del:'Fshije këtë shpenzim?', c_del_cat:'Fshije këtë kategori?', c_pay:'Borxhi u pagua. Je i sigurt?'
  },
  en:{app:'Normal Holding',cloud:'Expenses • Cloud',
      nav_home:'Home',nav_list:'List',nav_debts:'Debts',nav_settings:'Settings',
      hdr_balance:'Balance',hdr_debts:'Debts',hdr_sub:'Balance − Expenses (total)',
      stat_total:'📊 Total',stat_today:'📅 Today',stat_month:'🗓️ Month',
      recent:'🕒 Recent',empty_home:'No entries yet.',
      list:'📚 List',search:'Search...',all:'All',
      debts:'💳 Debts',debt_search:'Search debts...',debts_all:'All',debts_borrow:'Borrowed',debts_lend:'Lent',empty_debts:'No debts yet.',
      user:'User',logout:'Logout',
      pref_title:'Currency & format',pref_curr:'Active currency (for new entries)',pref_fmt:'Number format',pref_save:'Save preferences',saved:'Saved.',
      lang_title:'Language',lang_save:'Save',
      bal_title:'Current currency balance',bal_save:'Save balance',
      cats:'Categories',cat_personal:'Personal category',cat_emoji:'Emoji',cat_choose:'Choose emoji',cat_name:'Category name',cat_ph:'e.g. Food',cat_add:'Add category',cat_added:'Added.',delete:'Delete',
      acc:'Account',email_save:'Save email',pass_save:'Save password',pass_min:'Password ≥ 6.',pass_mis:'Passwords do not match.',email_done:'Confirmation email sent.',pass_done:'Updated.',
      gate_email:'Email',gate_pass:'Password',register:'Sign up',login:'Sign in',
      m_exp:'➕ Add expense',name:'Name',amount:'Amount',category:'Category',date:'Date',close:'Close',save:'Save',
      m_debt:'➕ Add debt',party:'Party (Name)',kind:'Type',kind_borrow:'Borrowed',kind_lend:'Lent',due:'Due (optional)',desc:'Description (optional)',
      paid:'Paid',pay:'Pay',returned:'Returned',
      c_del:'Delete this expense?', c_del_cat:'Delete this category?', c_pay:'Debt paid. Are you sure?'
  },
  tr:{app:'Normal Holding',cloud:'Harcamalar • Bulut',
      nav_home:'Ana',nav_list:'Liste',nav_debts:'Borçlar',nav_settings:'Ayarlar',
      hdr_balance:'Bilanço',hdr_debts:'Borçlar',hdr_sub:'Bakiye − Harcamalar (toplam)',
      stat_total:'📊 Toplam',stat_today:'📅 Bugün',stat_month:'🗓️ Ay',
      recent:'🕒 Son kayıtlar',empty_home:'Henüz kayıt yok.',
      list:'📚 Liste',search:'Ara...',all:'Tümü',
      debts:'💳 Borçlar',debt_search:'Borç ara...',debts_all:'Tümü',debts_borrow:'Aldım',debts_lend:'Verdim',empty_debts:'Henüz borç yok.',
      user:'Kullanıcı',logout:'Çıkış',
      pref_title:'Para birimi & format',pref_curr:'Aktif para birimi (yeni girişler)',pref_fmt:'Sayı biçimi',pref_save:'Tercihleri kaydet',saved:'Kaydedildi.',
      lang_title:'Dil',lang_save:'Kaydet',
      bal_title:'Aktif para birimi bakiyesi',bal_save:'Bakiyeyi kaydet',
      cats:'Kategoriler',cat_personal:'Kişisel kategori',cat_emoji:'Emoji',cat_choose:'Emoji seç',cat_name:'Kategori adı',cat_ph:'örn. Yiyecek',cat_add:'Kategori ekle',cat_added:'Eklendi.',delete:'Sil',
      acc:'Hesap',email_save:'E-postayı kaydet',pass_save:'Şifreyi kaydet',pass_min:'Şifre ≥ 6.',pass_mis:'Şifreler uyuşmuyor.',email_done:'Onay e-postası gönderildi.',pass_done:'Güncellendi.',
      gate_email:'E-posta',gate_pass:'Şifre',register:'Kayıt ol',login:'Giriş yap',
      m_exp:'➕ Harcama ekle',name:'Ad',amount:'Tutar',category:'Kategori',date:'Tarih',close:'Kapat',save:'Kaydet',
      m_debt:'➕ Borç ekle',party:'Kişi (Ad)',kind:'Tür',kind_borrow:'Aldım',kind_lend:'Verdim',due:'Vade (ops.)',desc:'Açıklama (ops.)',
      paid:'Ödendi',pay:'Öde',returned:'Döndü',
      c_del:'Bu harcama silinsin mi?', c_del_cat:'Bu kategori silinsin mi?', c_pay:'Borç ödendi. Emin misin?'
  }
};
function t(k){const L=profile?.lang||'sq'; return (I18N[L]&&I18N[L][k])||I18N.sq[k]||k;}
function i18nApply(){
  document.documentElement.lang=profile.lang||'sq';
  // Gate
  setText('g_app',t('app')); setText('g_cloud',t('cloud'));
  setText('g_email_l',t('gate_email')); setText('g_pass_l',t('gate_pass'));
  setText('btnReg',t('register')); setText('btnLogin',t('login'));
  // Header & stats
  setText('h_appname',t('app'));
  setText('hdrText', activeTab==='debts'?t('hdr_debts'):t('hdr_balance'));
  setText('hdrSub',t('hdr_sub'));
  setText('s1name',t('stat_total')); setText('s2name',t('stat_today')); setText('s3name',t('stat_month'));
  // Tabs
  setText('t_recent',t('recent')); document.getElementById('emptyHome').textContent=t('empty_home');
  setText('t_list',t('list'));
  document.getElementById('q').placeholder=t('search'); setText('f_all',t('all'));
  setText('t_debts',t('debts')); document.getElementById('dq').placeholder=t('debt_search');
  setText('dAll',t('debts_all')); setText('dBorrow',t('debts_borrow')); setText('dLend',t('debts_lend'));
  document.getElementById('emptyDebts').textContent=t('empty_debts');
  setText('t_settings',t('nav_settings'));
  // User row
  setText('u_user',t('user')); setText('u_logout',t('logout'));
  // Preferences
  setText('prefTitle',t('pref_title')); setText('prefCurrLbl',t('pref_curr')); setText('prefFmtLbl',t('pref_fmt')); setText('prefSave',t('pref_save'));
  // Language
  setText('langTitle',t('lang_title')); setText('langSave',t('lang_save'));
  // Balance
  setText('balTitle',t('bal_title')+' ('+ (profile.default_currency||'ALL') +')'); setText('balSave',t('bal_save'));
  // Categories
  setText('catTitle',t('cats')); setText('catEmojiLbl',t('cat_emoji')); setText('catEmojiBtn',t('cat_choose'));
  setText('catNameLbl',t('cat_name')); document.getElementById('newCatName').placeholder=t('cat_ph'); setText('catAdd',t('cat_add'));
  // Account
  setText('accTitle',t('acc')); setText('emailSave',t('email_save')); setText('passSave',t('pass_save'));
  // Nav labels
  setText('navHome',t('nav_home')); setText('navList',t('nav_list')); setText('navDebts',t('nav_debts')); setText('navSettings',t('nav_settings'));
  // Modals
  setText('mExpT',t('m_exp')); setText('mNameL',t('name')); setText('mAmtL',t('amount')); setText('mCatL',t('category')); setText('mDateL',t('date'));
  setText('mClose',t('close')); setText('mSave',t('save'));
  setText('dT',t('m_debt')); setText('dPartyL',t('party')); setText('dAmtL',t('amount')); setText('dKindL',t('kind'));
  setText('dKindBorrow',t('kind_borrow')); setText('dKindLend',t('kind_lend')); setText('dDueL',t('due')); setText('dNameL',t('desc'));
  setText('dClose',t('close')); setText('dSave',t('save'));
}

/* ---------- helpers ---------- */
function fmtNum(n){ const f=profile?.num_format==='us' ? {m:',', d:'.'} : {m:'.', d:','};
  const s=(Math.round(n*100)/100).toFixed(2);
  const [A,B]=s.split('.');
  return A.replace(/\B(?=(\d{3})+(?!\d))/g,f.m)+f.d+B;
}
function setText(id,v){const e=document.getElementById(id); if(e) e.textContent=v;}
function toggleBox(id){document.getElementById(id)?.classList.toggle('hide')}
function openModal(w){document.getElementById('modal'+w).classList.add('on')}
function closeModal(w){document.getElementById('modal'+w).classList.remove('on')}
function emailShort(e){return e?e.split('@')[0]:''}
function todayISO(){return new Date().toISOString().slice(0,10)}
function sum(a){return a.reduce((s,n)=>s+Number(n||0),0)}
function toCurr(amount, from, to){ if(!from||!to||from===to) return amount; const r=(rates[from]&&rates[from][to])||1; return amount*r;}

/* ---------- UI wiring ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  if(!window.supabase) throw new Error('Supabase JS yüklenmedi');
  supabase = window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

  // Emoji grid
  '🍔 🥗 🍕 🍰 ☕ 🍺 🛒 🚌 ⛽ 🚕 🛠️ 🧽 🎁 🎮 🎬 🎟️ 💡 📱 💻 🏠 🐾 ⚽ 🧾 💊 ✈️ 🚗 🪙 💳 💎 🎓 📚 🔌 🔋 🧥 👟 🍼 🧻 🧴'.split(' ').forEach(e=>{
    const b=document.createElement('button'); b.textContent=e; b.onclick=()=>{document.getElementById('newCatEmoji').value=e;document.getElementById('emojiPreview').textContent=e;closeModal('Emoji')};
    document.getElementById('emojiGrid').appendChild(b);
  });

  document.getElementById('mDate').value=todayISO();
  document.getElementById('dDate').value=todayISO();

  // Auth buttons
  document.getElementById('btnLogin').onclick=login;
  document.getElementById('btnReg').onclick=registerUser;

  // FAB – tab göre modallar
  const fab=document.getElementById('openAdd');
  const fabOpen=()=>{ if(activeTab==='debts') openModal('Debt'); else openModal('Exp'); };
  ['pointerup','touchend','click'].forEach(ev=>fab.addEventListener(ev,fabOpen,{passive:true}));

  // Debt quick filter
  document.getElementById('dAll').onclick=()=>{drawDebts('');};
  document.getElementById('dBorrow').onclick=()=>{drawDebts('borrow');};
  document.getElementById('dLend').onclick=()=>{drawDebts('lend');};

  // Auth session
  const {data:{session}}=await supabase.auth.getSession();
  if(session?.user){sessionUser=session.user; await bootApp();}
  else showGate();

  supabase.auth.onAuthStateChange(async (_e,session)=>{
    if(session?.user){sessionUser=session.user; await bootApp();}
    else{sessionUser=null; showGate();}
  });

  // Kur oranları (cache 12s)
  try{
    const cache=JSON.parse(localStorage.getItem('nh_rates')||'{}');
    if(cache.t && Date.now()-cache.t<12*60*60*1000 && cache.r){rates=cache.r;}
    else{
      const r=await fetch('https://api.exchangerate.host/latest?base=EUR').then(r=>r.json()).catch(()=>null);
      if(r && r.rates){
        const R=r.rates;
        rates.EUR={EUR:1, USD:R.USD, TRY:R.TRY, ALL:R.ALL};
        rates.USD={EUR:1/R.USD, USD:1, TRY:R.TRY/R.USD, ALL:R.ALL/R.USD};
        rates.TRY={EUR:1/R.TRY, USD:R.USD/R.TRY, TRY:1, ALL:R.ALL/R.TRY};
        rates.ALL={EUR:1/R.ALL, USD:R.USD/R.ALL, TRY:R.TRY/R.ALL, ALL:1};
        localStorage.setItem('nh_rates',JSON.stringify({t:Date.now(), r:rates}));
      }
    }
  }catch{}
});

async function bootApp(){
  try{
    await Promise.all([ensureProfile(), ensureCategoriesSeed()]);
    await Promise.all([loadCategories(), loadExpenses(), loadDebts()]);
    viewCurr = profile.default_currency || 'ALL';
    buildViewCurrSeg();
    showApp();
  }finally{
    document.getElementById('boot')?.remove();
  }
}

function showGate(){document.getElementById('boot')?.remove();document.getElementById('gate').classList.remove('hide');document.getElementById('app').classList.add('hide');document.getElementById('navbar').classList.add('hide'); i18nApply();}
function showApp(){document.getElementById('gate').classList.add('hide');document.getElementById('app').classList.remove('hide');document.getElementById('navbar').classList.remove('hide');document.getElementById('who').textContent=emailShort(sessionUser?.email);document.getElementById('userInfo').textContent=sessionUser?.email||'';i18nApply();refreshHeader();drawHome();drawDebts();}

/* ---------- Auth ---------- */
async function registerUser(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value;
  const box=document.getElementById('authMsg'); box.textContent='';
  if(!email||pass.length<6){box.textContent=t('pass_min');return;}
  const {error}=await supabase.auth.signUp({email,password:pass});
  box.textContent=error?('Gabim: '+error.message):t('email_done');
}
async function login(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value;
  const box=document.getElementById('authMsg'); box.textContent='';
  const {error}=await supabase.auth.signInWithPassword({email,password:pass});
  if(error) box.textContent='Gabim: '+error.message;
}
async function logout(){await supabase.auth.signOut()}

/* ---------- Profile & Prefs ---------- */
async function ensureProfile(){
  try{
    const {data} = await supabase.from('profiles').select('*').eq('user_id',sessionUser.id).maybeSingle();
    if(data){ profile=data; if(!profile.lang) profile.lang='sq'; }
    else{
      const fresh={user_id:sessionUser.id, default_currency:'ALL', num_format:'eu', balances:{}, lang:'sq'};
      const {data:ins}=await supabase.from('profiles').insert(fresh).select().single();
      profile=ins||fresh;
    }
  }catch(err){ console.warn('profile err',err); }
  document.getElementById('prefCurr').value=profile.default_currency||'ALL';
  document.getElementById('prefFmt').value=profile.num_format||'eu';
  document.getElementById('balCurrLbl').textContent=profile.default_currency||'ALL';
  document.getElementById('balInput').value=(profile.balances?.[profile.default_currency]||0);
  document.getElementById('prefLang').value=profile.lang||'sq';
}
async function savePrefs(){
  const curr=document.getElementById('prefCurr').value;
  const fmt=document.getElementById('prefFmt').value;
  const {data,error}=await supabase.from('profiles').update({default_currency:curr,num_format:fmt}).eq('user_id',sessionUser.id).select().single();
  document.getElementById('prefMsg').textContent=error?('Gabim: '+error.message):t('saved');
  if(!error){profile=data; viewCurr=profile.default_currency; buildViewCurrSeg(); refreshHeader(); i18nApply();}
}
async function saveLanguage(){
  const lang=document.getElementById('prefLang').value||'sq';
  const {data,error}=await supabase.from('profiles').update({lang}).eq('user_id',sessionUser.id).select().single();
  document.getElementById('langMsg').textContent=error?('Gabim: '+error.message):t('saved');
  if(!error){profile=data; i18nApply(); refreshHeader();}
}
async function saveBalance(){
  const v=parseFloat(document.getElementById('balInput').value)||0;
  const c=profile.default_currency||'ALL';
  const balances={...(profile.balances||{})}; balances[c]=v;
  const {data,error}=await supabase.from('profiles').update({balances}).eq('user_id',sessionUser.id).select().single();
  document.getElementById('balMsg').textContent=error?('Gabim: '+error.message):t('saved');
  if(!error){profile=data; refreshHeader();}
}
async function changeEmail(){
  const e=(document.getElementById('newEmail').value||'').trim();
  const m=document.getElementById('emailMsg'); m.textContent='';
  if(!e||!e.includes('@')){m.textContent='Shkruaj një email të vlefshëm.';return;}
  const {error}=await supabase.auth.updateUser({email:e});
  m.textContent=error?('Gabim: '+error.message):t('email_done');
}
async function changePassword(){
  const p1=document.getElementById('newPass').value,p2=document.getElementById('newPass2').value,m=document.getElementById('passMsg');
  m.textContent='';
  if(!p1||p1.length<6){m.textContent=t('pass_min');return;}
  if(p1!==p2){m.textContent=t('pass_mis');return;}
  const {error}=await supabase.auth.updateUser({password:p1});
  m.textContent=error?('Gabim: '+error.message):t('pass_done');
  if(!error){document.getElementById('newPass').value='';document.getElementById('newPass2').value='';}
}

/* ---------- Categories ---------- */
const DEFAULT_CATS=[{name:'Ushqime',emoji:'🍔'},{name:'Transport',emoji:'⛽'},{name:'Shtëpia',emoji:'🏠'},{name:'Argëtim',emoji:'🎟️'},{name:'Fatura',emoji:'💡'},{name:'Të tjera',emoji:'🧾'}];
async function ensureCategoriesSeed(){
  const {data}=await supabase.from('categories').select('id').eq('user_id',sessionUser.id).limit(1);
  if(!data||data.length===0){
    await supabase.from('categories').insert(DEFAULT_CATS.map(c=>({...c,user_id:sessionUser.id})));
  }
}
async function loadCategories(){
  const {data,error}=await supabase.from('categories').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:true});
  cats=(error?DEFAULT_CATS:(data||[]));
  renderCatList(); refreshCategorySelects(); drawAll();
}
function renderCatList(){
  const box=document.getElementById('catList'); box.innerHTML='';
  cats.forEach(c=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ic'; ic.textContent=c.emoji||'🧾';
    const meta=document.createElement('div'); meta.className='meta';
    const t=document.createElement('div'); t.className='t'; t.textContent=c.name;
    const s=document.createElement('div'); s.className='s'; s.textContent=t('cat_personal');
    meta.appendChild(t); meta.appendChild(s);
    const del=document.createElement('button'); del.className='btnMini'; del.textContent=t('delete');
    del.onclick=()=>deleteCategory(c.id);
    el.append(ic,meta,del); box.appendChild(el);
  });
}
function refreshCategorySelects(){
  const mCat=document.getElementById('mCat'), fCat=document.getElementById('fCat');
  mCat.innerHTML=''; fCat.innerHTML='<option value="">'+t('all')+'</option>';
  (Array.isArray(cats)?cats:DEFAULT_CATS).forEach(c=>{
    const o=document.createElement('option'); o.value=c.name; o.textContent=(c.emoji||'•')+' '+c.name;
    mCat.appendChild(o.cloneNode(true));
    const o2=document.createElement('option'); o2.value=c.name; o2.textContent=c.name; fCat.appendChild(o2);
  });
}
async function addCategory(){
  const name=(document.getElementById('newCatName').value||'').trim();
  const emoji=(document.getElementById('newCatEmoji').value||'').trim()||'🧾';
  const msg=document.getElementById('catMsg'); msg.textContent='';
  if(!name){msg.textContent=t('cat_name');return;}
  const {data,error}=await supabase.from('categories').insert({user_id:sessionUser.id,name,emoji}).select().single();
  if(error){msg.textContent='Gabim: '+error.message;return;}
  cats.push({name:data.name,emoji:data.emoji,id:data.id}); document.getElementById('newCatName').value=''; renderCatList(); refreshCategorySelects();
  msg.textContent=t('cat_added');
}
async function deleteCategory(id){
  if(!confirm(t('c_del_cat'))) return;
  const {error}=await supabase.from('categories').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){alert('Gabim: '+error.message);return;}
  cats=cats.filter(c=>c.id!==id); renderCatList(); refreshCategorySelects(); drawAll();
}
function emojiFor(catName){
  const hit=(Array.isArray(cats)?cats:DEFAULT_CATS).find(c=>c.name===catName);
  return (hit?hit.emoji:null) || '💸';
}

/* ---------- Header & Stats ---------- */
function buildViewCurrSeg(){
  const seg=document.getElementById('viewCurrSeg'); seg.innerHTML='';
  ['ALL','EUR','TRY','USD'].forEach(c=>{
    const b=document.createElement('button'); b.textContent=c; b.className=c===viewCurr?'active':''; b.onclick=()=>{viewCurr=c;refreshHeader();drawHome();drawAll();drawDebts();};
    seg.appendChild(b);
  });
  setText('hdrCurr',viewCurr); setText('sCurr1',viewCurr); setText('sCurr2',viewCurr); setText('sCurr3',viewCurr);
  document.getElementById('balCurrLbl').textContent=profile.default_currency||'ALL';
}
function switchTab(t){
  activeTab=t;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
  document.querySelectorAll('.btn').forEach(x=>x.classList.remove('active'));
  document.querySelector(`.btn[data-tab="${t}"]`)?.classList.add('active');
  document.getElementById('statsRow').style.display=(t==='settings')?'none':'flex';
  i18nApply();
  refreshHeader();
  if(t==='list')drawAll();
  if(t==='debts')drawDebts();
}
function refreshHeader(){
  const total=sum(items.map(x=>toCurr(Number(x.amount||0), x.curr||'ALL', viewCurr)));
  const today=sum(items.filter(isToday).map(x=>toCurr(Number(x.amount||0),(x.curr||'ALL'),viewCurr)));
  const month=sum(items.filter(isThisMonth).map(x=>toCurr(Number(x.amount||0),(x.curr||'ALL'),viewCurr)));
  const bal=Number(profile.balances?.[viewCurr]||0);
  const remain=bal - total;
  setText('hdrText', activeTab==='debts'?t('hdr_debts'):t('hdr_balance'));
  setText('hdrTotal', fmtNum(remain));
  setText('hdrCurr', viewCurr);
  setText('s1name', t('stat_total'));
  setText('stat1', fmtNum(total));
  setText('stat2', fmtNum(today));
  setText('stat3', fmtNum(month));
}

/* ---------- Expenses ---------- */
async function loadExpenses(){
  const {data,error}=await supabase.from('expenses').select('*').eq('user_id',sessionUser.id).order('d',{ascending:false}).limit(2000);
  items=error?[]:(data||[]);
  drawHome(); drawAll(); refreshHeader();
}
async function saveExpense(){
  const name=document.getElementById('mName').value.trim();
  const amt=parseFloat(document.getElementById('mAmt').value);
  const cat=document.getElementById('mCat').value;
  const d=document.getElementById('mDate').value;
  if(!name||!amt||!d||isNaN(amt)){alert('Plotësoni emrin, shumën dhe datën.');return;}
  const payload={user_id:sessionUser.id,name,amount:amt,category:cat,d,curr:profile.default_currency||'ALL'};
  let resp=await supabase.from('expenses').insert(payload).select().single();
  if(resp.error && /column .*curr/.test(resp.error.message||'')){
    const {curr, ...noCurr}=payload; resp=await supabase.from('expenses').insert(noCurr).select().single();
  }
  if(resp.error){alert('Gabim: '+resp.error.message);return;}
  items.unshift(resp.data);
  document.getElementById('mName').value='';document.getElementById('mAmt').value='';closeModal('Exp');
  drawHome(); drawAll(); refreshHeader();
}
async function delExpense(id){
  if(!confirm(t('c_del')))return;
  const {error}=await supabase.from('expenses').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){alert('Gabim: '+error.message);return;}
  items=items.filter(x=>x.id!==id); drawHome(); drawAll(); refreshHeader();
}
function drawHome(){
  const recent=[...items].sort((a,b)=>b.d.localeCompare(a.d)).slice(0,8);
  const list=document.getElementById('recentList'); list.innerHTML='';
  document.getElementById('emptyHome').style.display=recent.length?'none':'block';
  recent.forEach(x=>list.appendChild(rowExpense(x)));
}
function drawAll(){
  const q=(document.getElementById('q').value||'').trim().toLowerCase();
  const cat=document.getElementById('fCat').value;
  let arr=[...items].sort((a,b)=>b.d.localeCompare(a.d));
  if(q)arr=arr.filter(x=>x.name.toLowerCase().includes(q)||(x.category||'').toLowerCase().includes(q));
  if(cat)arr=arr.filter(x=>x.category===cat);
  const box=document.getElementById('allList'); box.innerHTML='';
  arr.forEach(x=>box.appendChild(rowExpense(x)));
}
function rowExpense(x){
  const el=document.createElement('div'); el.className='item';
  const ic=document.createElement('div'); ic.className='ic'; ic.textContent=emojiFor(x.category);
  const meta=document.createElement('div'); meta.className='meta';
  const t0=document.createElement('div'); t0.className='t'; t0.textContent=x.name;
  const s=document.createElement('div'); s.className='s'; s.textContent=[x.category, fmtDate(x.d)].filter(Boolean).join(' • ');
  meta.appendChild(t0); meta.appendChild(s);
  const amt=document.createElement('div'); amt.className='amt'; amt.textContent=fmtNum(toCurr(x.amount, x.curr||'ALL', viewCurr))+' '+viewCurr;
  const del=document.createElement('button'); del.className='del'; del.innerHTML='🗑️'; del.onclick=()=>delExpense(x.id);
  el.append(ic,meta,amt,del); return el;
}

/* ---------- Debts ---------- */
async function loadDebts(){
  const {data,error}=await supabase.from('debts').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:false}).limit(2000);
  debts=error?[]:(data||[]); drawDebts(); refreshHeader();
}
async function saveDebt(){
  const party=document.getElementById('dParty').value.trim();
  const name=(document.getElementById('dName').value||'').trim();
  const amt=parseFloat(document.getElementById('dAmt').value);
  const kind=document.getElementById('dKind').value;
  const due=document.getElementById('dDate').value||null;
  if(!party||!amt||isNaN(amt)){alert('Shkruaj Palën (Emri) dhe shumën.');return;}
  const payload={user_id:sessionUser.id,party,name,amount:amt,kind,due,status:'open',curr:profile.default_currency||'ALL'};
  let resp=await supabase.from('debts').insert(payload).select().single();
  if(resp.error && /column .*curr/.test(resp.error.message||'')){
    const {curr, ...noCurr}=payload; resp=await supabase.from('debts').insert(noCurr).select().single();
  }
  if(resp.error){alert('Gabim: '+resp.error.message);return;}
  debts.unshift(resp.data);
  document.getElementById('dParty').value='';document.getElementById('dName').value='';document.getElementById('dAmt').value='';document.getElementById('dKind').value='borrow';
  closeModal('Debt'); drawDebts(); refreshHeader();
}
async function delDebt(id){
  if(!confirm(t('c_del')))return;
  const {error}=await supabase.from('debts').delete().eq('id',id).eq('user_id',sessionUser.id);
  if(error){alert('Gabim: '+error.message);return;}
  debts=debts.filter(x=>x.id!==id); drawDebts(); refreshHeader();
}
async function payDebt(id){
  if(!confirm(t('c_pay'))) return;
  const {data,error}=await supabase.from('debts').update({status:'paid'}).eq('id',id).eq('user_id',sessionUser.id).select().single();
  if(error){alert('Gabim: '+error.message);return;}
  debts=debts.map(x=>x.id===id?data:x); drawDebts(); refreshHeader();
}
function drawDebts(kindFilter=''){
  const q=(document.getElementById('dq').value||'').trim().toLowerCase();
  let arr=[...debts];
  if(q)arr=arr.filter(x=>(x.party||'').toLowerCase().includes(q)||(x.name||'').toLowerCase().includes(q));
  if(kindFilter)arr=arr.filter(x=>x.kind===kindFilter);

  const box=document.getElementById('debtList'); box.innerHTML='';
  document.getElementById('emptyDebts').style.display=arr.length?'none':'block';

  arr.forEach(x=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ic'; ic.innerHTML=(x.status==='paid')?'✅':'💳';
    const meta=document.createElement('div'); meta.className='meta';
    const t0=document.createElement('div'); t0.className='t'; t0.textContent=x.party || '(pa emër)';
    const bits=[x.kind==='borrow'?t('debts_borrow'):t('debts_lend')]; if(x.name) bits.push(x.name); if(x.due) bits.push('Afati: '+fmtDate(x.due));
    const s=document.createElement('div'); s.className='s'; s.textContent=bits.join(' • ');
    meta.appendChild(t0); meta.appendChild(s);
    const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
    const amt=document.createElement('div'); amt.className='amt';
    amt.textContent=fmtNum(toCurr(x.amount, x.curr||'ALL', viewCurr))+' '+viewCurr;
    right.appendChild(amt);
    if(x.status==='open'){
      const pay=document.createElement('button'); pay.className='btnMini'; pay.textContent=(x.kind==='borrow')?t('pay'):t('returned');
      pay.onclick=()=>payDebt(x.id); right.appendChild(pay);
    }else{
      const badge=document.createElement('span'); badge.className='chip'; badge.textContent=t('paid'); right.appendChild(badge);
    }
    const del=document.createElement('button'); del.className='del'; del.textContent='🗑️'; del.onclick=()=>delDebt(x.id);
    el.append(ic,meta,right,del); box.appendChild(el);
  });
}

/* ---------- small helpers ---------- */
function isToday(x){const d=new Date(x.d),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()&&d.getDate()==t.getDate()}
function isThisMonth(x){const d=new Date(x.d),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()}
function fmtDate(iso){const d=new Date((iso||todayISO())+'T00:00:00');return d.toLocaleDateString('sq-AL',{day:'2-digit',month:'short',year:'numeric'})}
</script>

</body>
</html>
