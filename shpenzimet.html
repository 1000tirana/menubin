<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Normal Holding â€¢ Shpenzimet</title>
<meta name="theme-color" content="#0d1117">

<!-- =========================================================
   SUPABASE: ÅEMA + RLS (bir kere Ã§alÄ±ÅŸtÄ±r)
   ---------------------------------------------------------
   -- SQL Editor'a yapÄ±ÅŸtÄ±r â†’ Run
-------------------------------------------------------------
create extension if not exists pgcrypto;

-- KullanÄ±cÄ± profili / tercihleri
create table if not exists public.profiles(
  user_id uuid primary key references auth.users(id) on delete cascade,
  balance numeric default 0,
  currency text not null default 'ALL',
  num_format text not null default 'eu',  -- 'eu' => 23.456,78  | 'us' => 23,456.78
  week_start int not null default 1,      -- 1=HÃ«n (Pazartesi), 0=Die (Pazar)
  locale text not null default 'sq-AL',
  setup_done boolean not null default false,
  pin_hash text,                          -- app iÃ§i PIN (opsiyonel, SHA256)
  created_at timestamptz default now()
);

-- Harcama
create table if not exists public.expenses(
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  name text not null,
  amount numeric not null,
  category text not null,
  d date not null,
  created_at timestamptz default now()
);
create index if not exists expenses_user_d on public.expenses(user_id, d);

-- Gelir
create table if not exists public.incomes(
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  name text not null,
  amount numeric not null,
  category text not null,
  d date not null,
  created_at timestamptz default now()
);
create index if not exists incomes_user_d on public.incomes(user_id, d);

-- Kategori (gider + gelir)
create table if not exists public.categories(
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  name text not null,
  emoji text,
  kind text not null default 'expense',   -- 'expense' | 'income'
  created_at timestamptz default now()
);
create index if not exists categories_user_kind on public.categories(user_id, kind);

-- BorÃ§
create table if not exists public.debts(
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  party text not null,                    -- kiÅŸi/ÅŸirket adÄ±
  name text,                              -- aÃ§Ä±klama
  amount numeric not null,
  kind text not null default 'borrow',    -- borrow (mora hua) | lend (dhash hua)
  status text not null default 'open',    -- open | paid
  due date,
  created_at timestamptz default now()
);
create index if not exists debts_user_kind on public.debts(user_id, kind);

-- Basit hatÄ±rlatmalar (opsiyonel, uygulama iÃ§inde uyarÄ±)
create table if not exists public.reminders(
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  text text not null,
  at timestamptz not null,
  is_done boolean not null default false,
  created_at timestamptz default now()
);
create index if not exists reminders_user_at on public.reminders(user_id, at);

-- RLS
alter table public.profiles  enable row level security;
alter table public.expenses  enable row level security;
alter table public.incomes   enable row level security;
alter table public.categories enable row level security;
alter table public.debts     enable row level security;
alter table public.reminders enable row level security;

-- Policies (idempotent)
do $$
begin
  if not exists (select 1 from pg_policies where polname='profiles_select_own') then
    create policy profiles_select_own on public.profiles
      for select using (auth.uid() = user_id);
  end if;
  if not exists (select 1 from pg_policies where polname='profiles_upsert_own') then
    create policy profiles_upsert_own on public.profiles
      for insert with check (auth.uid() = user_id);
    create policy profiles_update_own on public.profiles
      for update using (auth.uid() = user_id);
  end if;

  if not exists (select 1 from pg_policies where polname='expenses_all_own') then
    create policy expenses_all_own on public.expenses
      using (auth.uid() = user_id) with check (auth.uid() = user_id);
  end if;

  if not exists (select 1 from pg_policies where polname='incomes_all_own') then
    create policy incomes_all_own on public.incomes
      using (auth.uid() = user_id) with check (auth.uid() = user_id);
  end if;

  if not exists (select 1 from pg_policies where polname='categories_all_own') then
    create policy categories_all_own on public.categories
      using (auth.uid() = user_id) with check (auth.uid() = user_id);
  end if;

  if not exists (select 1 from pg_policies where polname='debts_all_own') then
    create policy debts_all_own on public.debts
      using (auth.uid() = user_id) with check (auth.uid() = user_id);
  end if;

  if not exists (select 1 from pg_policies where polname='reminders_all_own') then
    create policy reminders_all_own on public.reminders
      using (auth.uid() = user_id) with check (auth.uid() = user_id);
  end if;
end $$;
========================================================= -->

<style>
/* ---------- GitHub koyu tema + senin â€œyuvarlak-Ä±ÅŸÄ±kâ€ ikon stillerin ---------- */
:root{
  --bg:#0d1117; --card:#161b22; --border:#30363d;
  --text:#c9d1d9; --muted:#8b949e;
  --primary:#2ea043; --primary2:#238636; --blue:#1f6feb; --danger:#f85149;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --safe-top:env(safe-area-inset-top,0px); --safe-bottom:env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box} html,body{height:100%;background:var(--bg)}
body{margin:0;color:var(--text);font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;touch-action:manipulation;overscroll-behavior:none}

/* App shell */
.wrap{display:flex;flex-direction:column;min-height:100vh;padding-bottom:calc(110px + var(--safe-bottom))}
header{background:linear-gradient(135deg,var(--primary2),var(--primary));color:#fff;border-bottom-left-radius:18px;border-bottom-right-radius:18px;padding:calc(8px + var(--safe-top)) 14px 10px;box-shadow:0 8px 26px rgba(35,134,54,.35)}
header .top{display:flex;justify-content:space-between;align-items:center}
header .title{font-size:18px;font-weight:900;display:flex;gap:8px;margin-top:6px}
header .big{font-size:30px;font-weight:900;margin-top:6px}
header .muted{color:#e6edf3;opacity:.8}
.stats{display:flex;gap:10px;padding:10px 12px;transform:translateY(-10px)}
.card{flex:1;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
main{padding:0 12px 20px}
h3.sec{margin:0 0 8px}
.list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.item{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px}

/* Yuvarlak â€œÄ±ÅŸÄ±klÄ±â€ ikon */
.ic{width:52px;height:52px;border-radius:50%;display:grid;place-items:center;color:#0d1117;
  background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
  box-shadow:inset 0 1px 4px rgba(0,0,0,.6), 0 6px 14px rgba(0,0,0,.4);
  border:1px solid rgba(255,255,255,.06); font-size:24px}
.meta{flex:1}.meta .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#e6edf3}
.meta .s{font-size:12px;color:var(--muted)}
.amt{font-weight:900;color:#e6edf3}
.del{border:none;background:transparent;color:var(--danger);font-size:20px;cursor:pointer}

.row{display:flex;gap:10px}
label{font-size:13px;color:var(--muted)}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:16px;background:var(--card);color:var(--text);-webkit-appearance:none}
.actions{display:flex;gap:10px;margin-top:10px}
.btnP,.btnS,.btnMini{font-size:16px;user-select:none;-webkit-tap-highlight-color:transparent}
.btnP{flex:1;background:linear-gradient(180deg,var(--primary),var(--primary2));color:#fff;border:1px solid #2ea043;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
.btnS{flex:1;background:#21262d;color:#e6edf3;border:1px solid var(--border);padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
.btnMini{background:#21262d;border:1px solid var(--border);padding:8px 10px;border-radius:10px;font-weight:800;color:#e6edf3;cursor:pointer}
.chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#1f6feb;color:#fff}

/* Alt nav â€” ortada fab boÅŸluÄŸu */
nav.nav{
  --fab-gap:110px;
  position:fixed;left:0;right:0;bottom:0;height:calc(76px + var(--safe-bottom));padding:0 12px var(--safe-bottom);
  background:var(--card);border-top:1px solid var(--border);box-shadow:0 -10px 30px rgba(0,0,0,.35);
  border-top-left-radius:16px;border-top-right-radius:16px;z-index:2000;
  display:grid;grid-template-columns:1fr 1fr var(--fab-gap) 1fr 1fr;align-items:center
}
.btn{justify-self:center;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);text-decoration:none}
.btn:nth-of-type(1){grid-column:1}.btn:nth-of-type(2){grid-column:2}.btn:nth-of-type(3){grid-column:4}.btn:nth-of-type(4){grid-column:5}
.btn .ico{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;color:#0d1117;
  background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
  box-shadow:inset 0 1px 3px rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.06);font-size:24px}
.btn.active{color:#79c0ff}
.btn.active .ico{background:radial-gradient(circle at 30% 30%, #cfe7ff 0%, #9dd2ff 45%, #1f6feb 100%)}

/* FAB (biraz kÃ¼Ã§Ã¼k) */
.nav .fab{position:absolute;left:50%;transform:translateX(-50%);top:-22px;width:56px;height:56px;border-radius:999px;
  background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);
  border:1px solid rgba(255,255,255,.06);color:#0d1117;font-size:28px;display:grid;place-items:center;
  box-shadow:0 14px 26px rgba(0,0,0,.5), inset 0 1px 4px rgba(0,0,0,.6);cursor:pointer;z-index:2100}

/* Modal/sheets */
.tab{display:none}.tab.active{display:block}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:end;padding:14px;z-index:3000}
.modal.on{display:grid}
.sheet{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:18px;padding:14px 14px 18px;width:100%;box-shadow:0 -12px 30px rgba(0,0,0,.5)}

/* Auth gate */
.gate{position:fixed;inset:0;display:none;place-items:center;background:var(--bg);padding:18px;z-index:4000}
.panel{background:var(--card);border:1px solid var(--border);width:min(520px,92vw);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
.tabs{display:flex;gap:6px;margin-bottom:10px}.tabs button{flex:1;border:1px solid var(--border);padding:10px;border-radius:10px;background:#21262d;color:#e6edf3;cursor:pointer}
.tabs button.active{background:linear-gradient(180deg,var(--primary),var(--primary2));border-color:#2ea043;color:#fff;font-weight:800}

/* Segmentler */
.seg{background:#21262d;border:1px solid var(--border);border-radius:10px;padding:4px;display:grid;gap:4px}
.seg.two{grid-template-columns:1fr 1fr}.seg.three{grid-template-columns:1fr 1fr 1fr}
.seg button{border:none;padding:10px;border-radius:8px;background:transparent;cursor:pointer;font-weight:800;color:#e6edf3}
.seg button.active{background:linear-gradient(180deg,#1f6feb,#1158c7);color:#fff}

/* Emoji picker */
.picker-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;max-height:45vh;overflow:auto;margin-top:8px}
.picker-grid button{border:1px solid var(--border);background:#21262d;border-radius:10px;width:44px;height:44px;font-size:22px;cursor:pointer}
#emojiBtn{display:flex;gap:8px;align-items:center;width:100%}

/* Onboarding */
.onb{position:fixed;inset:0;background:var(--bg);display:none;z-index:4500;padding:16px}
.onb .box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;height:100%;display:flex;flex-direction:column;gap:12px}

/* PIN kilidi (opsiyonel) */
.pinGate{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;place-items:center;z-index:5000}
.pinBox{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;width:min(420px,92vw)}
.pinBox input{letter-spacing:6px;text-align:center}

@media(min-width:720px){.wrap{max-width:520px;margin:0 auto}}
</style>
</head>
<body>

<!-- ============== GÄ°RÄ°Å / KAYIT ============== -->
<div id="gate" class="gate">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900;font-size:18px">Normal Holding</div>
      <div class="muted">Shpenzimet â€¢ Cloud</div>
    </div>
    <div class="tabs">
      <button id="tabLoginBtn" class="active" onclick="swapAuth('login')">Hyrje</button>
      <button id="tabRegBtn" onclick="swapAuth('reg')">Regjistrohu</button>
    </div>
    <div id="authLogin">
      <label>Email</label>
      <input id="loginEmail" placeholder="emri@gmail.com" autocomplete="username">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>FjalÃ«kalimi</label><input id="loginPass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div>
      </div>
      <div class="actions"><button class="btnP" onclick="login()">Hyr</button></div>
      <div id="authMsg" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="authReg" style="display:none">
      <label>Email</label>
      <input id="regEmail" placeholder="emri@gmail.com" autocomplete="username">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>FjalÃ«kalimi</label><input id="regPass" type="password" autocomplete="new-password" placeholder="min. 6"></div>
      </div>
      <div class="actions"><button class="btnS" onclick="swapAuth('login')">Kthehu</button><button class="btnP" onclick="registerUser()">Krijo llogari</button></div>
      <div id="regMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- ============== ONBOARDING (ilk kurulum) ============== -->
<div id="onb" class="onb">
  <div class="box">
    <h3 style="margin:6px 0">ğŸš€ Fillimi i shpejtÃ«</h3>
    <div class="card">
      <h4 style="margin:0 0 8px">Preferencat kryesore</h4>
      <div class="row">
        <div style="flex:1">
          <label>Monedha</label>
          <select id="onbCurrency">
            <option value="ALL" selected>ALL â€” Albania Lek</option>
            <option value="EUR">EUR â€” Euro</option>
            <option value="USD">USD â€” US Dollar</option>
            <option value="TRY">TRY â€” TÃ¼rk LirasÄ±</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div style="flex:1">
          <label>Dita e parÃ« e javÃ«s</label>
          <div id="onbWeek" class="seg two">
            <button class="active" data-val="1">E hÃ«nÃ«</button>
            <button data-val="0">E diel</button>
          </div>
        </div>
        <div style="flex:1">
          <label>Formati i numrave</label>
          <div id="onbNum" class="seg two">
            <button class="active" data-val="eu">23.456,78</button>
            <button data-val="us">23,456.78</button>
          </div>
        </div>
      </div>
      <div class="actions" style="margin-top:12px"><button class="btnP" onclick="finishOnboarding()">Vazhdo</button></div>
    </div>
  </div>
</div>

<!-- ============== PIN KÄ°LÄ°DÄ° (opsiyonel) ============== -->
<div id="pinGate" class="pinGate">
  <div class="pinBox">
    <h3 style="margin:0 0 8px">ğŸ”’ Fut PIN-in</h3>
    <input id="pinInput" maxlength="6" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric">
    <div class="actions" style="margin-top:10px"><button class="btnP" onclick="checkPin()">Hap</button></div>
    <div id="pinMsg" class="muted" style="margin-top:6px"></div>
  </div>
</div>

<!-- ============== UYGULAMA ============== -->
<div class="wrap" id="app" style="display:none">
  <header>
    <div class="top">
      <div style="font-weight:800">Normal Holding</div>
      <div class="muted" id="who">@pÃ«rdoruesi</div>
    </div>
    <div class="title"><span id="hdrIcon">ğŸ’°</span><span id="hdrText">Bilanci</span></div>
    <div class="big"><span id="hdrTotal">0</span> <span id="currSym">L</span></div>
    <div class="muted" id="hdrSub">Gjendja + TÃ« ardhura âˆ’ Shpenzime</div>
  </header>

  <div class="stats">
    <div class="card"><div class="muted">Shpenzime (muaj)</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="statExpMonth">0</span> <span id="currSym1">L</span></div></div>
    <div class="card"><div class="muted">TÃ« ardhura (muaj)</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="statIncMonth">0</span> <span id="currSym2">L</span></div></div>
    <div class="card"><div class="muted">Sot</div><div style="font-weight:800;font-size:18px;color:#e6edf3"><span id="statTodayNet">0</span> <span id="currSym3">L</span></div></div>
  </div>

  <main>
    <section id="tab-home" class="tab active">
      <h3 class="sec">ğŸ•’ TÃ« fundit (shpenzime + tÃ« ardhura)</h3>
      <div id="recentList" class="list"></div>
      <div id="emptyHome" class="muted" style="text-align:center;margin-top:12px">AsgjÃ« pÃ«r tani.</div>
    </section>

    <section id="tab-list" class="tab">
      <h3 class="sec">ğŸ“š Shpenzimet</h3>
      <div class="row" style="margin:8px 0 10px">
        <input id="q" placeholder="KÃ«rko..." oninput="drawAll()">
        <select id="fCat" onchange="drawAll()"><option value="">TÃ« gjitha</option></select>
      </div>
      <div id="allList" class="list"></div>
    </section>

    <section id="tab-debts" class="tab">
      <h3 class="sec">ğŸ’³ Borxhet</h3>
      <div class="row" style="margin:8px 0 10px"><input id="dq" placeholder="KÃ«rko borxhe..." oninput="drawDebts()"></div>
      <div class="seg three" id="dSegFilter" style="margin-bottom:8px">
        <button type="button" class="active" data-val="">TÃ« gjitha</button>
        <button type="button" data-val="borrow">Mora hua</button>
        <button type="button" data-val="lend">Dhash hua</button>
      </div>
      <div id="debtList" class="list"></div>
      <div id="emptyDebts" class="muted" style="text-align:center;margin-top:16px">AsnjÃ« borxh.</div>
    </section>

    <section id="tab-settings" class="tab">
      <h3 class="sec">âš™ï¸ CilÃ«sime</h3>

      <div class="item">
        <div class="ic">ğŸ‘¤</div>
        <div class="meta"><div class="t">PÃ«rdoruesi</div><div class="s muted" id="userInfo">â€”</div></div>
        <button class="del" style="color:#e6edf3" onclick="logout()">ğŸšª</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">ğŸ’¼ Gjendja fillestare</h4>
        <div class="row"><input id="balInput" type="number" step="0.01" inputmode="decimal" placeholder="p.sh. 50000"></div>
        <div class="actions"><button class="btnP" onclick="saveBalance()">Ruaj gjendjen</button></div>
        <div class="muted" id="balMsg" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">ğŸŒ Preferencat</h4>
        <div class="row">
          <div style="flex:1"><label>Monedha</label><select id="prefCurrency" onchange="savePrefs()">
            <option value="ALL">ALL â€” Albania Lek</option><option value="EUR">EUR â€” Euro</option><option value="USD">USD â€” US Dollar</option><option value="TRY">TRY â€” TÃ¼rk LirasÄ±</option>
          </select></div>
          <div style="flex:1"><label>Dita e parÃ«</label><select id="prefWeek" onchange="savePrefs()"><option value="1">E hÃ«nÃ«</option><option value="0">E diel</option></select></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div style="flex:1"><label>Formati i numrave</label><select id="prefNum" onchange="savePrefs()"><option value="eu">23.456,78</option><option value="us">23,456.78</option></select></div>
          <div style="flex:1"><label>Gjuha</label><select id="prefLang" onchange="savePrefs()"><option value="sq-AL">Shqip</option><option value="tr-TR">TÃ¼rkÃ§e</option></select></div>
        </div>
        <div class="muted" id="prefMsg" style="margin-top:6px;font-size:12px"></div>
      </div>

      <!-- KATEGORÄ°LER -->
      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">ğŸ·ï¸ Kategoriat</h4>
        <div id="catList" class="list" style="margin-top:8px"></div>
        <div style="border-top:1px solid var(--border);margin:12px 0"></div>
        <div class="row">
          <div style="width:130px">
            <label>Emoji</label>
            <button class="btnS" id="emojiBtn" onclick="openEmojiPicker()">
              <span id="emojiPreview" class="ic" style="width:38px;height:38px;font-size:20px;background:radial-gradient(circle at 30% 30%, #e6ffec 0%, #c7eed6 45%, #2ea043 100%);margin-right:8px">ğŸ”</span>
              Zgjidh emoji
            </button>
            <input id="newCatEmoji" value="ğŸ”" hidden>
          </div>
          <div style="flex:1">
            <label>Emri i kategorisÃ«</label><input id="newCatName" placeholder="p.sh. Ushqime">
          </div>
          <div style="width:160px">
            <label>Lloji</label><select id="newCatKind"><option value="expense">Shpenzim</option><option value="income">TÃ« ardhura</option></select>
          </div>
        </div>
        <div class="actions"><button class="btnP" onclick="addCategory()">Shto kategori</button></div>
        <div id="catMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <!-- PIN -->
      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">ğŸ”’ PIN i aplikacionit (opsional)</h4>
        <div class="row"><input id="pinNew" placeholder="PIN (4-6 shifra)" inputmode="numeric" maxlength="6"><input id="pinAgain" placeholder="PÃ«rsÃ«rit PIN" inputmode="numeric" maxlength="6"></div>
        <div class="actions"><button class="btnP" onclick="savePin()">Ruaj PIN</button><button class="btnS" onclick="removePin()">Hiq PIN</button></div>
        <div id="pinSaveMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <!-- E-posta / Åifre -->
      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">ğŸ“§ / ğŸ” Llogaria</h4>
        <div class="row"><input id="newEmail" placeholder="email i ri p.sh. user@domain.com"><button class="btnMini" onclick="changeEmail()">Ruaj email</button></div>
        <div class="row" style="margin-top:8px"><input id="newPass" type="password" placeholder="FjalÃ«kalimi i ri (min. 6)"><input id="newPass2" type="password" placeholder="PÃ«rsÃ«rit fjalÃ«kalimin"><button class="btnMini" onclick="changePassword()">Ruaj fjalÃ«kalimin</button></div>
        <div id="acctMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <!-- Yedekle / Geri yÃ¼kle -->
      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">ğŸ—‚ï¸ Yedekle & Geri ngarko</h4>
        <div class="row">
          <button class="btnP" onclick="exportData()">Eksporto JSON</button>
          <input id="impFile" type="file" accept="application/json" style="display:none" onchange="importData(event)">
          <button class="btnS" onclick="document.getElementById('impFile').click()">Ngarko JSON</button>
        </div>
        <div id="backupMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <!-- HatÄ±rlatÄ±cÄ±lar (uygulama iÃ§i) -->
      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px;color:#e6edf3">â° Kujtuesit</h4>
        <div class="row"><input id="remText" placeholder="p.sh. Paguaj qiranÃ«"><input id="remAt" type="datetime-local"></div>
        <div class="actions"><button class="btnP" onclick="addReminder()">Shto kujtues</button></div>
        <div id="remList" class="list" style="margin-top:10px"></div>
      </div>
    </section>
  </main>
</div>

<!-- Alt menÃ¼ -->
<nav class="nav" id="navbar" style="display:none">
  <a class="btn active" data-tab="home" onclick="switchTab('home')"><span class="ico">ğŸ </span><span>Kreu</span></a>
  <a class="btn" data-tab="list" onclick="switchTab('list')"><span class="ico">ğŸ“‹</span><span>Lista</span></a>
  <a class="btn" data-tab="debts" onclick="switchTab('debts')"><span class="ico">ğŸ’³</span><span>Borxhet</span></a>
  <a class="btn" data-tab="settings" onclick="switchTab('settings')"><span class="ico">âš™ï¸</span><span>CilÃ«sime</span></a>
  <button class="fab" id="openAdd" aria-label="Shto">ï¼‹</button>
</nav>

<!-- Modal: Ekle (Expense/Income seÃ§imi) -->
<div class="modal" id="modalAdd"><div class="sheet">
  <h3 style="margin:4px 0 10px">â• Shto</h3>
  <div id="segAdd" class="seg two"><button class="active" data-val="expense">Shpenzim</button><button data-val="income">TÃ« ardhura</button></div>
  <div id="boxExp" style="margin-top:10px">
    <div class="row"><div style="flex:2"><label>Emri</label><input id="mName" placeholder="p.sh. Karburant"></div><div style="flex:1"><label>Shuma</label><input id="mAmt" type="number" step="0.01" inputmode="decimal"></div></div>
    <div class="row" style="margin-top:8px"><div style="flex:1"><label>Kategoria</label><select id="mCat"></select></div><div style="flex:1"><label>Data</label><input id="mDate" type="date"></div></div>
  </div>
  <div id="boxInc" style="display:none;margin-top:10px">
    <div class="row"><div style="flex:2"><label>Burimi</label><input id="iName" placeholder="p.sh. PagÃ«"></div><div style="flex:1"><label>Shuma</label><input id="iAmt" type="number" step="0.01" inputmode="decimal"></div></div>
    <div class="row" style="margin-top:8px"><div style="flex:1"><label>Kategoria</label><select id="iCat"></select></div><div style="flex:1"><label>Data</label><input id="iDate" type="date"></div></div>
  </div>
  <div class="actions"><button class="btnS" onclick="closeModal('Add')">Mbyll</button><button class="btnP" onclick="saveAdd()">Ruaj</button></div>
</div></div>

<!-- Modal: Emoji seÃ§ici -->
<div class="modal" id="modalEmoji"><div class="sheet">
  <h3 style="margin:4px 0 10px">ğŸ™‚ Zgjidh njÃ« emoji</h3>
  <div id="emojiGrid" class="picker-grid"></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Emoji')">Mbyll</button></div>
</div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== Supabase ayarlarÄ±n ===== */
const SUPABASE_URL='https://nvpjqvggaiipwziolend.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cGpxdmdnYWlpcHd6aW9sZW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4OTExNzcsImV4cCI6MjA3NDQ2NzE3N30.PnJh09kx-kK8iChgQl2M1eTw5P2qRZUEO31wVY7_iP4';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/* ===== VarsayÄ±lan kategoriler ===== */
const DEF_EXP=[{name:'Ushqime',emoji:'ğŸ”'},{name:'Transport',emoji:'â›½'},{name:'ShtÃ«pia',emoji:'ğŸ '},{name:'ArgÃ«tim',emoji:'ğŸŸï¸'},{name:'Fatura',emoji:'ğŸ’¡'},{name:'TÃ« tjera',emoji:'ğŸ§¾'}];
const DEF_INC=[{name:'PagÃ«',emoji:'ğŸ’¼'},{name:'Shitje',emoji:'ğŸ’³'},{name:'TÃ« tjera',emoji:'ğŸ’°'}];

let sessionUser=null, profile={balance:0,currency:'ALL',num_format:'eu',week_start:1,locale:'sq-AL',setup_done:false};
let cats=[], expenses=[], incomes=[], debts=[], reminders=[];
let activeTab='home', currSymbol='L';

document.addEventListener('DOMContentLoaded', async () => {
  // Emoji grid
  'ğŸ” ğŸ¥— ğŸ• ğŸ° â˜• ğŸº ğŸ›’ ğŸšŒ â›½ ğŸš• ğŸ› ï¸ ğŸ§½ ğŸ ğŸ® ğŸ¬ ğŸŸï¸ ğŸ’¡ ğŸ“± ğŸ’» ğŸ  âš½ ğŸ§¾ ğŸ’Š âœˆï¸ ğŸš— ğŸ’³ ğŸ’ ğŸ’¼ ğŸ’°'.split(' ').forEach(e=>{
    const b=document.createElement('button');b.textContent=e;b.onclick=()=>{id('newCatEmoji').value=e;id('emojiPreview').textContent=e;closeModal('Emoji')};id('emojiGrid').appendChild(b)
  });

  // FAB
  const fab=id('openAdd'); ['pointerup','touchend','click'].forEach(ev=>fab.addEventListener(ev,()=>openAddSheet(),{passive:true}));

  // Toggle add type
  qAll('#segAdd button').forEach(b=>b.onclick=()=>{toggleSeg('segAdd',b); const v=segValue('segAdd'); id('boxExp').style.display=v==='expense'?'block':'none'; id('boxInc').style.display=v==='income'?'block':'none';});

  // auth
  const {data:{session}}=await supabase.auth.getSession();
  if(session?.user){sessionUser=session.user; await boot();}
  else showGate();

  supabase.auth.onAuthStateChange(async (_e,session)=>{
    if(session?.user){sessionUser=session.user; await boot();}
    else{sessionUser=null; showGate();}
  });
});

/* ===== Boot ===== */
async function boot(){
  await Promise.all([loadProfile(), seedCategories(), loadCategories(), loadAllData()]);
  showApp();
  if(!profile.setup_done) showOnboarding();
  maybeShowPin();
  startReminderTicker();
}

/* ===== UI helpers ===== */
const id = s=>document.getElementById(s);
const q  = s=>document.querySelector(s);
const qAll = s=>document.querySelectorAll(s);
function emailShort(e){return e?e.split('@')[0]:'@pÃ«rdoruesi'}
function setText(s,v){const e=id(s);if(e)e.textContent=v}
function openModal(w){id('modal'+w).classList.add('on')}
function closeModal(w){id('modal'+w).classList.remove('on')}
function toggleSeg(idp,btn){const p=id(idp);p.querySelectorAll('button').forEach(x=>x.classList.remove('active'));btn.classList.add('active')}
function segValue(idp){return id(idp).querySelector('.active')?.dataset.val||''}
function fmtNum(n){const x=Math.round(n*100)/100; if(profile.num_format==='us'){return x.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:2})} return x.toLocaleString('de-DE',{minimumFractionDigits:0,maximumFractionDigits:2})}
function todayISO(){return new Date().toISOString().slice(0,10)}
function isThisMonthISO(iso){const d=new Date(iso+'T00:00:00'),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()}
function isTodayISO(iso){const d=new Date(iso+'T00:00:00'),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()&&d.getDate()==t.getDate()}
function fmtDate(iso){const d=new Date(iso+'T00:00:00');return d.toLocaleDateString(profile.locale||'sq-AL',{day:'2-digit',month:'short',year:'numeric'})}
function currencySymbol(code){return ({ALL:'L',EUR:'â‚¬',USD:'$',TRY:'â‚º'})[code]||code}

/* ===== Gate / App ===== */
function showGate(){id('gate').style.display='grid';id('app').style.display='none';id('navbar').style.display='none'}
function showApp(){id('gate').style.display='none';id('app').style.display='block';id('navbar').style.display='grid';id('who').textContent=emailShort(sessionUser?.email);id('userInfo').textContent=emailShort(sessionUser?.email);applyCurrency()}

/* ===== Onboarding ===== */
function showOnboarding(){
  id('onb').style.display='block';
  // defaults
  id('onbCurrency').value=profile.currency||'ALL';
  resetSeg('onbWeek', String(profile.week_start||1));
  resetSeg('onbNum', profile.num_format||'eu');
  qAll('#onbWeek button').forEach(b=>b.onclick=()=>toggleSeg('onbWeek',b));
  qAll('#onbNum button').forEach(b=>b.onclick=()=>toggleSeg('onbNum',b));
}
function resetSeg(seg,val){const p=id(seg);p.querySelectorAll('button').forEach(x=>x.classList.toggle('active', String(x.dataset.val)===String(val)))}
async function finishOnboarding(){
  profile.currency=id('onbCurrency').value;
  profile.week_start=Number(segValue('onbWeek'));
  profile.num_format=segValue('onbNum');
  profile.setup_done=true;
  await supabase.from('profiles').upsert({user_id:sessionUser.id, ...profile}).select();
  id('onb').style.display='none';
  applyCurrency(); refreshHeader(); drawAll(); drawHome();
}

/* ===== PIN (opsiyonel) ===== */
function maybeShowPin(){ if(profile.pin_hash){ id('pinGate').style.display='grid'; } }
async function savePin(){
  const p1=id('pinNew').value.trim(), p2=id('pinAgain').value.trim();
  const box=id('pinSaveMsg'); box.textContent='';
  if(!p1 || p1!==p2 || p1.length<4){ box.textContent='PIN â‰¥ 4 dhe i njÃ«jtÃ« nÃ« tÃ« dy fushat.'; return; }
  const hash=await sha256(p1); const {error}=await supabase.from('profiles').update({pin_hash:hash}).eq('user_id',sessionUser.id);
  box.textContent=error?('Gabim: '+error.message):'U ruajt.';
  if(!error){ profile.pin_hash=hash; id('pinNew').value=''; id('pinAgain').value=''; }
}
async function removePin(){ await supabase.from('profiles').update({pin_hash:null}).eq('user_id',sessionUser.id); profile.pin_hash=null; id('pinSaveMsg').textContent='PIN u hoq.' }
async function checkPin(){
  const v=id('pinInput').value.trim(); const box=id('pinMsg');
  if(!v){box.textContent='Shkruaj PIN.';return;}
  const ok = (await sha256(v))===profile.pin_hash;
  if(ok){ id('pinGate').style.display='none'; id('pinInput').value=''; box.textContent=''; }
  else { box.textContent='PIN i pasaktÃ«.'; }
}
async function sha256(s){const buf=new TextEncoder().encode(s);const dig=await crypto.subtle.digest('SHA-256',buf);return Array.from(new Uint8Array(dig)).map(b=>b.toString(16).padStart(2,'0')).join('')}

/* ===== Auth ===== */
async function registerUser(){const email=id('regEmail').value.trim(), pass=id('regPass').value;const box=id('regMsg');box.textContent=''; if(!email||pass.length<6){box.textContent='Email dhe fjalÃ«kalim â‰¥ 6.';return;} const {error}=await supabase.auth.signUp({email,password:pass,options:{emailRedirectTo:location.origin+location.pathname}}); box.textContent=error?('Gabim: '+error.message):'Llogaria u krijua. Kontrollo email-in.'}
async function login(){const email=id('loginEmail').value.trim(), pass=id('loginPass').value;const box=id('authMsg');box.textContent=''; const {error}=await supabase.auth.signInWithPassword({email,password:pass}); if(error) box.textContent='Gabim: '+error.message}
async function logout(){await supabase.auth.signOut()}

/* ===== Profile & Prefs ===== */
async function loadProfile(){
  const {data,error}=await supabase.from('profiles').select('*').eq('user_id',sessionUser.id).single();
  if(error && error.code!=='PGRST116'){ /* not found */ }
  profile = data || profile;
  // defaults
  id('balInput').value=profile.balance??0;
  id('prefCurrency').value=profile.currency||'ALL';
  id('prefWeek').value=String(profile.week_start??1);
  id('prefNum').value=profile.num_format||'eu';
  id('prefLang').value=profile.locale||'sq-AL';
  applyCurrency();
}
function applyCurrency(){ currSymbol=currencySymbol(profile.currency||'ALL'); ['currSym','currSym1','currSym2','currSym3'].forEach(s=>setText(s,currSymbol)); refreshHeader(); }
async function saveBalance(){const v=parseFloat(id('balInput').value);const b=isNaN(v)?0:v;const {data,error}=await supabase.from('profiles').upsert({user_id:sessionUser.id,balance:b}).select().single();id('balMsg').textContent=error?('Gabim: '+error.message):'U ruajt.'; if(!error){profile=data; refreshHeader();}}
async function savePrefs(){
  profile.currency=id('prefCurrency').value;
  profile.week_start=Number(id('prefWeek').value);
  profile.num_format=id('prefNum').value;
  profile.locale=id('prefLang').value;
  const {error}=await supabase.from('profiles').upsert({user_id:sessionUser.id, ...profile});
  id('prefMsg').textContent=error?('Gabim: '+error.message):'U ruajt.';
  applyCurrency(); drawHome(); drawAll(); drawDebts();
}
async function changeEmail(){const e=(id('newEmail').value||'').trim();const box=id('acctMsg');box.textContent=''; if(!e||!e.includes('@')){box.textContent='Email i pavlefshÃ«m.';return;} const {error}=await supabase.auth.updateUser({email:e}); box.textContent=error?('Gabim: '+error.message):'U dÃ«rgua linku i konfirmimit.'}
async function changePassword(){const p1=id('newPass').value,p2=id('newPass2').value,box=id('acctMsg');box.textContent=''; if(!p1||p1.length<6){box.textContent='FjalÃ«kalimi â‰¥ 6.';return;} if(p1!==p2){box.textContent='Nuk pÃ«rputhen.';return;} const {error}=await supabase.auth.updateUser({password:p1}); box.textContent=error?('Gabim: '+error.message):'U pÃ«rditÃ«sua.'; if(!error){id('newPass').value='';id('newPass2').value='';}}

/* ===== Kategoriler ===== */
async function seedCategories(){
  const {data}=await supabase.from('categories').select('id').eq('user_id',sessionUser.id).limit(1);
  if(!data || data.length===0){
    await supabase.from('categories').insert([
      ...DEF_EXP.map(x=>({...x,kind:'expense',user_id:sessionUser.id})),
      ...DEF_INC.map(x=>({...x,kind:'income',user_id:sessionUser.id}))
    ]);
  }
}
async function loadCategories(){
  const {data}=await supabase.from('categories').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:true});
  cats=data||[]; renderCatList(); refreshCategorySelects();
}
function renderCatList(){
  const box=id('catList'); box.innerHTML='';
  const groups=[['Kategori shpenzimesh','expense'],['Kategori tÃ« ardhurash','income']];
  groups.forEach(([title,k])=>{
    const head=document.createElement('div'); head.className='item'; head.innerHTML=`<div class="ic">ğŸ“‚</div><div class="meta"><div class="t">${title}</div><div class="s muted">Personale</div></div>`; box.appendChild(head);
    cats.filter(c=>c.kind===k).forEach(c=>{
      const el=document.createElement('div'); el.className='item';
      const ic=document.createElement('div'); ic.className='ic'; ic.textContent=c.emoji||'â€¢';
      const meta=document.createElement('div'); meta.className='meta'; meta.innerHTML=`<div class="t">${c.name}</div><div class="s muted">${k==='expense'?'Shpenzim':'TÃ« ardhura'}</div>`;
      const del=document.createElement('button'); del.className='del'; del.textContent='ğŸ—‘ï¸'; del.onclick=()=>deleteCategory(c.id);
      el.append(ic,meta,del); box.appendChild(el);
    });
  });
}
function refreshCategorySelects(){
  const mCat=id('mCat'), iCat=id('iCat'), fCat=id('fCat');
  mCat.innerHTML=''; iCat.innerHTML=''; fCat.innerHTML='<option value="">TÃ« gjitha</option>';
  cats.forEach(c=>{
    if(c.kind==='expense'){ const o=document.createElement('option'); o.value=c.name; o.textContent=(c.emoji||'')+' '+c.name; mCat.appendChild(o); fCat.appendChild(o.cloneNode(true)); }
    if(c.kind==='income'){ const o2=document.createElement('option'); o2.value=c.name; o2.textContent=(c.emoji||'')+' '+c.name; iCat.appendChild(o2); }
  });
}
async function addCategory(){
  const name=(id('newCatName').value||'').trim();
  const emoji=(id('newCatEmoji').value||'').trim()||'â€¢';
  const kind=id('newCatKind').value;
  const msg=id('catMsg'); msg.textContent='';
  if(!name){msg.textContent='Emri i kategorisÃ«?';return;}
  const {data,error}=await supabase.from('categories').insert({user_id:sessionUser.id,name,emoji,kind}).select().single();
  if(error){msg.textContent='Gabim: '+error.message;return;}
  cats.push(data); id('newCatName').value=''; renderCatList(); refreshCategorySelects(); msg.textContent='U shtua.';
}
async function deleteCategory(idc){
  if(!confirm('Fshije kÃ«tÃ« kategori?'))return;
  const {error}=await supabase.from('categories').delete().eq('id',idc).eq('user_id',sessionUser.id);
  if(error){alert('Gabim: '+error.message);return;}
  cats=cats.filter(x=>x.id!==idc); renderCatList(); refreshCategorySelects(); drawAll();
}

/* ===== Veriler ===== */
async function loadAllData(){
  const [e,i,d,r]=await Promise.all([
    supabase.from('expenses').select('*').eq('user_id',sessionUser.id).order('d',{ascending:false}).limit(2000),
    supabase.from('incomes').select('*').eq('user_id',sessionUser.id).order('d',{ascending:false}).limit(2000),
    supabase.from('debts').select('*').eq('user_id',sessionUser.id).order('created_at',{ascending:false}).limit(2000),
    supabase.from('reminders').select('*').eq('user_id',sessionUser.id).order('at',{ascending:true}).limit(2000),
  ]);
  expenses=e.data||[]; incomes=i.data||[]; debts=d.data||[]; reminders=r.data||[];
  drawAll(); drawHome(); drawDebts(); renderReminders(); refreshHeader();
}

/* ===== Header & Ã¶zet ===== */
function refreshHeader(){
  const expMonth= sum(expenses.filter(x=>isThisMonthISO(x.d)).map(x=>Number(x.amount||0)));
  const incMonth= sum(incomes .filter(x=>isThisMonthISO(x.d)).map(x=>Number(x.amount||0)));
  const todayNet = sum(incomes.filter(x=>isTodayISO(x.d)).map(x=>+x.amount)) - sum(expenses.filter(x=>isTodayISO(x.d)).map(x=>+x.amount));
  const totalExp = sum(expenses.map(x=>+x.amount));
  const totalInc = sum(incomes.map(x=>+x.amount));
  const balance   = Number(profile.balance||0) + totalInc - totalExp;

  setText('hdrTotal', fmtNum(balance));
  setText('statExpMonth', fmtNum(expMonth));
  setText('statIncMonth', fmtNum(incMonth));
  setText('statTodayNet', fmtNum(todayNet));
}

/* ===== Ekle (Expense/Income) ===== */
function openAddSheet(){
  id('mDate').value = todayISO();
  id('iDate').value = todayISO();
  openModal('Add');
}
async function saveAdd(){
  const mode = segValue('segAdd'); // expense | income
  if(mode==='expense'){
    const name=id('mName').value.trim(), amt=parseFloat(id('mAmt').value), cat=id('mCat').value, d=id('mDate').value;
    if(!name||!amt||!d||isNaN(amt)){alert('PlotÃ«soni fushat.');return;}
    const {data,error}=await supabase.from('expenses').insert({user_id:sessionUser.id,name,amount:amt,category:cat,d}).select().single();
    if(error){alert('Gabim: '+error.message);return;}
    expenses.unshift(data);
  }else{
    const name=id('iName').value.trim(), amt=parseFloat(id('iAmt').value), cat=id('iCat').value, d=id('iDate').value;
    if(!name||!amt||!d||isNaN(amt)){alert('PlotÃ«soni fushat.');return;}
    const {data,error}=await supabase.from('incomes').insert({user_id:sessionUser.id,name,amount:amt,category:cat,d}).select().single();
    if(error){alert('Gabim: '+error.message);return;}
    incomes.unshift(data);
  }
  closeModal('Add'); clearAddInputs(); drawHome(); drawAll(); refreshHeader();
}
function clearAddInputs(){['mName','mAmt','iName','iAmt'].forEach(k=>{const e=id(k); if(e) e.value='';})}

/* ===== Ã‡izimler ===== */
function drawHome(){
  const merged=[
    ...expenses.map(x=>({type:'exp',d:x.d,name:x.name,category:x.category,amount:+x.amount})),
    ...incomes .map(x=>({type:'inc',d:x.d,name:x.name,category:x.category,amount:+x.amount}))
  ].sort((a,b)=>b.d.localeCompare(a.d)).slice(0,10);

  const list=id('recentList'); list.innerHTML='';
  id('emptyHome').style.display = merged.length?'none':'block';
  merged.forEach(x=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ic'; ic.textContent= x.type==='exp' ? emojiFor(x.category) : 'ğŸ’°';
    const meta=document.createElement('div'); meta.className='meta';
    const t=document.createElement('div'); t.className='t'; t.textContent = x.name;
    const s=document.createElement('div'); s.className='s'; s.textContent = (x.type==='exp'?'Shpenzim':'TÃ« ardhura')+' â€¢ '+(x.category||'')+' â€¢ '+fmtDate(x.d);
    meta.append(t,s);
    const amt=document.createElement('div'); amt.className='amt'; amt.textContent=(x.type==='exp'?'-':'+')+fmtNum(x.amount)+' '+currSymbol;
    el.append(ic,meta,amt); list.appendChild(el);
  });
}
function drawAll(){
  const qv=(id('q').value||'').trim().toLowerCase(); const cat=id('fCat').value;
  let arr=[...expenses].sort((a,b)=>b.d.localeCompare(a.d));
  if(qv) arr=arr.filter(x=>x.name.toLowerCase().includes(qv)||(x.category||'').toLowerCase().includes(qv));
  if(cat) arr=arr.filter(x=>x.category===cat);
  const box=id('allList'); box.innerHTML='';
  arr.forEach(x=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ic'; ic.textContent=emojiFor(x.category);
    const meta=document.createElement('div'); meta.className='meta'; meta.innerHTML=`<div class="t">${x.name}</div><div class="s">${x.category} â€¢ ${fmtDate(x.d)}</div>`;
    const amt=document.createElement('div'); amt.className='amt'; amt.textContent=fmtNum(x.amount)+' '+currSymbol;
    const del=document.createElement('button'); del.className='del'; del.textContent='ğŸ—‘ï¸'; del.onclick=()=>delExpense(x.id);
    el.append(ic,meta,amt,del); box.appendChild(el);
  });
}
async function delExpense(idRow){ if(!confirm('Fshini kÃ«tÃ« shpenzim?')) return; const {error}=await supabase.from('expenses').delete().eq('id',idRow).eq('user_id',sessionUser.id); if(!error){ expenses=expenses.filter(x=>x.id!==idRow); drawAll(); drawHome(); refreshHeader(); } else alert('Gabim: '+error.message); }

/* ===== Debts ===== */
function drawDebts(){
  const qv=(id('dq').value||'').trim().toLowerCase(); const k=segValue('dSegFilter');
  let arr=[...debts]; if(qv) arr=arr.filter(x=>(x.party||'').toLowerCase().includes(qv)||(x.name||'').toLowerCase().includes(qv)); if(k) arr=arr.filter(x=>x.kind===k);
  const box=id('debtList'); box.innerHTML=''; id('emptyDebts').style.display=arr.length?'none':'block';
  arr.forEach(x=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ic'; ic.textContent=(x.status==='paid')?'âœ…':'ğŸ’³';
    const meta=document.createElement('div'); meta.className='meta';
    meta.innerHTML=`<div class="t">${x.party||'(pa emÃ«r)'}</div><div class="s">${x.kind==='borrow'?'Mora hua':'Dhash hua'}${x.name?(' â€¢ '+x.name):''}${x.due?(' â€¢ Afati: '+fmtDate(x.due)):''}</div>`;
    const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
    const amt=document.createElement('div'); amt.className='amt'; amt.textContent=fmtNum(x.amount)+' '+currSymbol; right.appendChild(amt);
    if(x.status==='open'){ const pay=document.createElement('button'); pay.className='btnMini'; pay.textContent=(x.kind==='borrow')?'Paguaj':'U kthye'; pay.onclick=()=>payDebt(x.id); right.appendChild(pay); }
    else { const badge=document.createElement('span'); badge.className='chip'; badge.textContent='Paguar'; right.appendChild(badge); }
    const del=document.createElement('button'); del.className='del'; del.textContent='ğŸ—‘ï¸'; del.onclick=()=>delDebt(x.id);
    el.append(ic,meta,right,del); box.appendChild(el);
  });
}
async function payDebt(idRow){ if(!confirm('Borxhi u pagua. Je i sigurt?')) return; const {data,error}=await supabase.from('debts').update({status:'paid'}).eq('id',idRow).eq('user_id',sessionUser.id).select().single(); if(!error){ debts=debts.map(x=>x.id===idRow?data:x); drawDebts(); } else alert('Gabim: '+error.message); }
async function delDebt(idRow){ if(!confirm('Fshini kÃ«tÃ« borxh?')) return; const {error}=await supabase.from('debts').delete().eq('id',idRow).eq('user_id',sessionUser.id); if(!error){ debts=debts.filter(x=>x.id!==idRow); drawDebts(); } else alert('Gabim: '+error.message); }

/* ===== Emoji yardÄ±mcÄ±larÄ± ===== */
function emojiFor(catName){
  const hit=cats.find(c=>c.name===catName);
  if(hit) return hit.emoji||'â€¢';
  const m={'Ushqime':'ğŸ”','Transport':'â›½','ShtÃ«pia':'ğŸ ','ArgÃ«tim':'ğŸŸï¸','Fatura':'ğŸ’¡','TÃ« tjera':'ğŸ§¾'};
  return m[catName]||'ğŸ’¸';
}
function openEmojiPicker(){openModal('Emoji')}

/* ===== Reminders (in-app ticker) ===== */
function renderReminders(){
  const box=id('remList'); box.innerHTML='';
  reminders.forEach(r=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div class="ic">â°</div><div class="meta"><div class="t">${r.text}</div><div class="s">${new Date(r.at).toLocaleString(profile.locale||'sq-AL')}</div></div>`;
    const btn=document.createElement('button'); btn.className='btnMini'; btn.textContent=r.is_done?'âœ”ï¸':'Done'; btn.onclick=()=>toggleRem(r.id,!r.is_done);
    el.appendChild(btn); box.appendChild(el);
  });
}
async function addReminder(){
  const text=(id('remText').value||'').trim(); const at=id('remAt').value;
  if(!text||!at){alert('PlotÃ«so tekstin & kohÃ«n');return;}
  const {data,error}=await supabase.from('reminders').insert({user_id:sessionUser.id,text,at}).select().single();
  if(!error){reminders.push(data); renderReminders(); id('remText').value='';}
}
async function toggleRem(idr,val){
  const {data,error}=await supabase.from('reminders').update({is_done:val}).eq('id',idr).eq('user_id',sessionUser.id).select().single();
  if(!error){reminders=reminders.map(r=>r.id===idr?data:r); renderReminders();}
}
function startReminderTicker(){ setInterval(()=>{ const now=Date.now(); reminders.filter(r=>!r.is_done && new Date(r.at).getTime()<=now).forEach(r=>{ alert('â° '+r.text); toggleRem(r.id,true); }); }, 30000); }

/* ===== Backup ===== */
async function exportData(){
  const blob=new Blob([JSON.stringify({profile,expenses,incomes,debts,categories:cats,reminders},null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup.json'; a.click(); URL.revokeObjectURL(a.href);
}
async function importData(e){
  const file=e.target.files[0]; if(!file) return;
  const txt=await file.text(); let data={}; try{data=JSON.parse(txt)}catch{ id('backupMsg').textContent='JSON i pavlefshÃ«m.'; return; }
  // Ã§ok basit: sadece insert (mevcutlarÄ± silmeden). Ä°stersen Ã¶nce temizleyebilirsin.
  if(data.categories) await supabase.from('categories').insert(data.categories.map(x=>({user_id:sessionUser.id,name:x.name,emoji:x.emoji,kind:x.kind||'expense'}))).then(()=>loadCategories());
  if(data.expenses)   await supabase.from('expenses').insert(data.expenses.map(x=>({user_id:sessionUser.id,name:x.name,amount:x.amount,category:x.category,d:x.d}))).then(()=>loadAllData());
  if(data.incomes)    await supabase.from('incomes').insert(data.incomes.map(x=>({user_id:sessionUser.id,name:x.name,amount:x.amount,category:x.category,d:x.d}))).then(()=>loadAllData());
  if(data.debts)      await supabase.from('debts').insert(data.debts.map(x=>({user_id:sessionUser.id,party:x.party,name:x.name,amount:x.amount,kind:x.kind,status:x.status,due:x.due}))).then(()=>loadAllData());
  if(data.profile){ await supabase.from('profiles').upsert({user_id:sessionUser.id,...data.profile}); await loadProfile(); }
  if(data.reminders)  await supabase.from('reminders').insert(data.reminders.map(x=>({user_id:sessionUser.id,text:x.text,at:x.at,is_done:!!x.is_done}))).then(()=>loadAllData());
  id('backupMsg').textContent='Import u krye.';
}

/* ===== Misc ===== */
function switchTab(t){
  activeTab=t;
  qAll('.tab').forEach(x=>x.classList.remove('active'));
  id('tab-'+t).classList.add('active');
  qAll('.btn').forEach(x=>x.classList.remove('active'));
  q(`.btn[data-tab="${t}"]`)?.classList.add('active');
  // Ayarlar ekranÄ±nda Ã¼stteki kartlarÄ± sakla
  q('.stats').style.display = (t==='settings') ? 'none' : 'flex';
  refreshHeader();
}

/* ===== Data helpers ===== */
function sum(a){return a.reduce((s,n)=>s+Number(n||0),0)}
</script>
</body>
</html>
