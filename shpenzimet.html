<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Shpenzimet ‚Ä¢ Normal Holding</title>
  <meta name="theme-color" content="#6a5ae0">
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--text:#1f2340;--muted:#7c82a1;
      --primary:#6a5ae0;--primary2:#7f6ff0;--danger:#ff5959;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --safe-top:env(safe-area-inset-top,0px);
      --safe-bottom:env(safe-area-inset-bottom,0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
      -webkit-text-size-adjust:100%;
    }

    /* App shell */
    .wrap{display:flex;flex-direction:column;min-height:100vh;padding-bottom:calc(120px + var(--safe-bottom))}
    header{
      background:linear-gradient(135deg,var(--primary),var(--primary2));
      color:#fff;border-bottom-left-radius:28px;border-bottom-right-radius:28px;
      padding:calc(16px + var(--safe-top)) 18px 16px;box-shadow:0 10px 26px rgba(106,90,224,.28)
    }
    header .top{display:flex;justify-content:space-between;align-items:center}
    header .title{font-size:24px;font-weight:900;display:flex;gap:10px;margin-top:8px}
    header .big{font-size:38px;font-weight:900;margin-top:10px}
    .stats{display:flex;gap:12px;padding:12px 14px;transform:translateY(-18px)}
    .card{flex:1;background:var(--card);border-radius:16px;padding:12px;box-shadow:var(--shadow)}
    .muted{color:var(--muted)}
    main{padding:0 14px 24px}

    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .item{display:flex;gap:12px;align-items:center;background:#fff;border-radius:14px;box-shadow:var(--shadow);padding:12px}
    .ic{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:var(--primary);color:#fff}
    .meta{flex:1}.meta .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.meta .s{font-size:12px;color:var(--muted)}
    .amt{font-weight:800}
    .del{border:none;background:transparent;color:var(--danger);font-size:20px;cursor:pointer}

    .row{display:flex;gap:10px}
    label{font-size:13px;color:var(--muted)}
    input,select{
      width:100%;padding:12px;border:1px solid #e6e7ee;border-radius:12px;
      font-size:16px;background:#fff;-webkit-appearance:none
    }
    .actions{display:flex;gap:10px;margin-top:10px}
    .btnP,.btnS,.btnMini,.btn,button{
      font-size:16px; /* iOS zoom‚Äôu engeller */
      touch-action:manipulation; -webkit-tap-highlight-color:transparent;
      -webkit-user-select:none; user-select:none;
    }
    .btnP{flex:1;background:var(--primary);color:#fff;border:none;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    .btnS{flex:1;background:#f0f1f8;color:#1f2340;border:none;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    .btnMini{background:#eef0fb;border:none;padding:8px 10px;border-radius:10px;font-weight:800;cursor:pointer}
    .chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#eef0fb;color:#3c3f68}
    .chip.ok{background:#e9f8ef;color:#137a3a}
    h3.sec{margin:0 0 8px}

    /* Bottom nav (grid) + FAB docked */
    nav.nav{
      position:fixed;left:0;right:0;bottom:0;
      height:calc(70px + var(--safe-bottom));
      padding:0 10px var(--safe-bottom);background:#fff;display:grid;
      grid-template-columns:1fr 1fr 1fr 1fr;align-items:center;
      box-shadow:0 -8px 28px rgba(0,0,0,.06);border-top-left-radius:16px;border-top-right-radius:16px;
      z-index:2000;
    }
    .btn{justify-self:center;display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted);text-decoration:none}
    .btn.active{color:var(--primary);font-weight:800}

    /* FAB ≈üimdi nav‚Äôƒ±n ƒ∞√áƒ∞NDE ve tam ortada */
    .nav .fab{
      position:absolute;left:50%;transform:translateX(-50%);
      top:-22px; /* nav ile birle≈üik g√∂r√ºn√ºm */
      width:56px;height:56px;background:var(--primary);border:none;border-radius:999px;color:#fff;
      display:grid;place-items:center;box-shadow:0 14px 32px rgba(106,90,224,.45);
      cursor:pointer;z-index:2100;pointer-events:auto;
    }
    .nav .fab::after{content:"";position:absolute;inset:-14px;border-radius:999px;} /* geni≈ü hit-area */
    @supports (-webkit-touch-callout: none) { .nav .fab{ top:-28px; } } /* iOS ufak ofset */

    .tab{display:none}.tab.active{display:block}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;place-items:end;padding:14px;z-index:3000}
    .modal.on{display:grid}
    .sheet{background:#fff;border-radius:22px;padding:14px 14px 18px;width:100%;box-shadow:0 -10px 26px rgba(0,0,0,.14)}

    /* Auth gate */
    .gate{position:fixed;inset:0;display:none;place-items:center;background:var(--bg);padding:18px;z-index:4000}
    .panel{background:#fff;width:min(520px,92vw);border-radius:20px;padding:18px;box-shadow:var(--shadow)}
    .tabs{display:flex;gap:6px;margin-bottom:10px}
    .tabs button{flex:1;border:none;padding:10px;border-radius:10px;background:#f1f2fa;cursor:pointer}
    .tabs button.active{background:var(--primary);color:#fff;font-weight:700}

    .seg{background:#f0f1f8;border-radius:12px;padding:4px;display:grid;gap:4px}
    .seg.two{grid-template-columns:1fr 1fr}
    .seg.three{grid-template-columns:1fr 1fr 1fr}
    .seg button{border:none;padding:10px;border-radius:10px;background:transparent;cursor:pointer;font-weight:700;color:#555}
    .seg button.active{background:var(--primary);color:#fff}

    @media(min-width:720px){.wrap{max-width:520px;margin:0 auto}}
  </style>
</head>
<body>
<!-- ===== HYRJE / REGJISTRIM ===== -->
<div id="gate" class="gate">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900;font-size:20px">Normal Holding</div>
      <div class="muted">Shpenzimet ‚Ä¢ Cloud</div>
    </div>
    <div class="tabs">
      <button id="tabLoginBtn" class="active" onclick="swapAuth('login')">Hyrje</button>
      <button id="tabRegBtn" onclick="swapAuth('reg')">Regjistrohu</button>
    </div>
    <div id="authLogin">
      <label>Email</label>
      <input id="loginEmail" placeholder="darti@example.com" autocomplete="username">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>Fjal√´kalimi</label><input id="loginPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      </div>
      <div class="actions"><button class="btnP" onclick="login()">Hyr</button></div>
      <div id="authMsg" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="authReg" style="display:none">
      <label>Email</label>
      <input id="regEmail" placeholder="darti@example.com" autocomplete="username">
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>Fjal√´kalimi</label><input id="regPass" type="password" autocomplete="new-password" placeholder="min. 6"></div>
      </div>
      <div class="actions"><button class="btnS" onclick="swapAuth('login')">Kthehu</button><button class="btnP" onclick="registerUser()">Krijo llogari</button></div>
      <div id="regMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- ===== APLIKACIONI ===== -->
<div class="wrap" id="app" style="display:none">
  <header>
    <div class="top">
      <div style="font-weight:800">Normal Holding</div>
      <div class="muted" id="who">@p√´rdoruesi</div>
    </div>
    <div class="title"><span id="hdrIcon">üí∞</span><span id="hdrText">Bilanci</span></div>
    <div class="big"><span id="hdrTotal">0</span> L</div>
    <div class="muted" id="hdrSub">Gjendja ‚àí Shpenzimet (totale)</div>
  </header>

  <div class="stats">
    <div class="card"><div class="muted" id="s1name">üìä Totale</div><div style="font-weight:800;font-size:20px"><span id="stat1">0</span> L</div></div>
    <div class="card"><div class="muted" id="s2name">üìÖ Sot</div><div style="font-weight:800;font-size:20px"><span id="stat2">0</span> L</div></div>
    <div class="card"><div class="muted" id="s3name">üóìÔ∏è Muaj</div><div style="font-weight:800;font-size:20px"><span id="stat3">0</span> L</div></div>
  </div>

  <main>
    <section id="tab-home" class="tab active">
      <h3 class="sec">üïí T√´ fundit</h3>
      <div id="recentList" class="list"></div>
      <div id="emptyHome" class="muted" style="text-align:center;margin-top:16px">Asnj√´ shpenzim deri tani.</div>
    </section>

    <section id="tab-list" class="tab">
      <h3 class="sec">üìö Lista</h3>
      <div class="row" style="margin:8px 0 10px">
        <input id="q" placeholder="K√´rko..." oninput="drawAll()">
        <select id="fCat" onchange="drawAll()"><option value="">T√´ gjitha</option></select>
      </div>
      <div id="allList" class="list"></div>
    </section>

    <section id="tab-debts" class="tab">
      <h3 class="sec">üí≥ Borxhet</h3>
      <div class="row" style="margin:8px 0 10px">
        <input id="dq" placeholder="K√´rko borxhe..." oninput="drawDebts()">
      </div>
      <div class="seg three" id="dSegFilter" style="margin-bottom:8px">
        <button type="button" class="active" data-val="">T√´ gjitha</button>
        <button type="button" data-val="borrow">Mora hua</button>
        <button type="button" data-val="lend">Dhash hua</button>
      </div>
      <div id="debtList" class="list"></div>
      <div id="emptyDebts" class="muted" style="text-align:center;margin-top:16px">Asnj√´ borxh deri tani.</div>
    </section>

    <section id="tab-settings" class="tab">
      <h3 class="sec">‚öôÔ∏è Cil√´sime</h3>
      <div class="item">
        <div class="ic">üë§</div>
        <div class="meta"><div class="t">P√´rdoruesi</div><div class="s muted" id="userInfo">‚Äî</div></div>
        <button class="del" style="color:#555" onclick="logout()">üö™</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">üíº Gjendja (L)</h4>
        <div class="row"><input id="balInput" type="number" step="0.01" inputmode="decimal" placeholder="p.sh. 50000"></div>
        <div class="actions"><button class="btnP" onclick="saveBalance()">Ruaj gjendjen</button></div>
        <div class="muted" id="balMsg" style="margin-top:6px;font-size:12px">N√´se nuk vendos√´sh, merret 0 dhe bilanci del negativ kur shpenzon.</div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">üìß Ndrysho email</h4>
        <div class="row"><input id="newEmail" placeholder="email i ri p.sh. user@domain.com"></div>
        <div class="actions"><button class="btnP" onclick="changeEmail()">Ruaj email</button></div>
        <div id="emailMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">üîê Ndrysho fjal√´kalimin</h4>
        <div class="row">
          <input id="newPass" type="password" placeholder="Fjal√´kalimi i ri (min. 6)">
          <input id="newPass2" type="password" placeholder="P√´rs√´rit fjal√´kalimin">
        </div>
        <div class="actions"><button class="btnP" onclick="changePassword()">Ruaj fjal√´kalimin</button></div>
        <div id="passMsg" class="muted" style="margin-top:6px;font-size:12px"></div>
      </div>
    </section>
  </main>
</div>

<!-- Alt men√º + FAB (birle≈üik) -->
<nav class="nav" id="navbar" style="display:none">
  <a class="btn active" data-tab="home" onclick="switchTab('home')">üè†<span>Kreu</span></a>
  <a class="btn" data-tab="list" onclick="switchTab('list')">üìã<span>Lista</span></a>
  <a class="btn" data-tab="debts" onclick="switchTab('debts')">üí≥<span>Borxhet</span></a>
  <a class="btn" data-tab="settings" onclick="switchTab('settings')">‚öôÔ∏è<span>Cil√´sime</span></a>

  <!-- FAB artƒ±k nav'ƒ±n i√ßinde -->
  <button class="fab" id="openAdd" aria-label="Shto">Ôºã</button>
</nav>

<!-- Modalet -->
<div class="modal" id="modalExp"><div class="sheet">
  <h3 style="margin:4px 0 10px">‚ûï Shto shpenzim</h3>
  <div class="row"><div style="flex:2"><label>Emri</label><input id="mName" placeholder="p.sh. Karburant"></div><div style="flex:1"><label>Shuma (L)</label><input id="mAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label>Kategoria</label><select id="mCat"></select></div><div style="flex:1"><label>Data</label><input id="mDate" type="date"></div></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Exp')">Mbyll</button><button class="btnP" onclick="saveExpense()">Ruaj</button></div>
</div></div>

<div class="modal" id="modalDebt"><div class="sheet">
  <h3 style="margin:4px 0 10px">‚ûï Shto borxh</h3>
  <div class="row"><div style="flex:2"><label>Emri</label><input id="dName" placeholder="p.sh. Telefon i ri"></div><div style="flex:1"><label>Shuma (L)</label><input id="dAmt" type="number" step="0.01" inputmode="decimal" placeholder="0"></div></div>
  <div class="row" style="margin-top:8px"><div style="flex:1"><label>Lloji</label><div id="segType" class="seg two"><button type="button" class="active" data-val="borrow">Mora hua</button><button type="button" data-val="lend">Dhash hua</button></div></div><div style="flex:1"><label>Afati (opsionale)</label><input id="dDate" type="date"></div></div>
  <div class="actions"><button class="btnS" onclick="closeModal('Debt')">Mbyll</button><button class="btnP" onclick="saveDebt()">Ruaj</button></div>
</div></div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL='https://nvpjqvggaiipwziolend.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52cGpxdmdnYWlpcHd6aW9sZW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4OTExNzcsImV4cCI6MjA3NDQ2NzE3N30.PnJh09kx-kK8iChgQl2M1eTw5P2qRZUEO31wVY7_iP4';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

async function withRetry(task){let err;for(let i=0;i<3;i++){try{return await task()}catch(e){err=e;await new Promise(r=>setTimeout(r,600*(i+1)))}}throw err}
const DEFAULT_CATS=['Ushqime','Transport','Sht√´pia','Arg√´tim','Fatura','T√´ tjera'];

let sessionUser=null, items=[], debts=[], profile={balance:0}, activeTab='home';

document.addEventListener('DOMContentLoaded', async () => {
  // Kategoriler
  const mCat=document.getElementById('mCat'), fCat=document.getElementById('fCat');
  DEFAULT_CATS.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;mCat.appendChild(o.cloneNode(true));fCat.appendChild(o);});
  document.getElementById('mDate').value=new Date().toISOString().slice(0,10);
  document.getElementById('dDate').value=new Date().toISOString().slice(0,10);

  // Seg butonlarƒ±
  document.querySelectorAll('#segType button').forEach(b=>b.onclick=()=>toggleSeg('segType',b));
  document.querySelectorAll('#dSegFilter button').forEach(b=>b.onclick=()=>{toggleSeg('dSegFilter',b); drawDebts();});

  // FAB: pointerup/touchend/click (nav i√ßi)
  const fab=document.getElementById('openAdd');
  const fabOpen=()=>{ if(activeTab==='debts') openModal('Debt'); else openModal('Exp'); };
  fab.addEventListener('pointerup', fabOpen, {passive:true});
  fab.addEventListener('touchend', fabOpen, {passive:true});
  fab.addEventListener('click', fabOpen);

  // Oturum
  const {data:{session}}=await supabase.auth.getSession();
  if(session?.user){sessionUser=session.user; showApp(); await Promise.all([ensureProfile(), loadExpenses(), loadDebts()]);}
  else showGate();

  supabase.auth.onAuthStateChange(async (_e,session)=>{
    if(session?.user){sessionUser=session.user; showApp(); await Promise.all([ensureProfile(), loadExpenses(), loadDebts()]);}
    else{sessionUser=null; showGate();}
  });
});

/* ===== UI helpers ===== */
function emailShort(e){return e?e.split('@')[0]:'@p√´rdoruesi'}
function showGate(){document.getElementById('gate').style.display='grid';document.getElementById('app').style.display='none';document.getElementById('navbar').style.display='none'}
function showApp(){document.getElementById('gate').style.display='none';document.getElementById('app').style.display='block';document.getElementById('navbar').style.display='grid';document.getElementById('who').textContent=emailShort(sessionUser?.email);document.getElementById('userInfo').textContent=emailShort(sessionUser?.email);refreshHeader();drawHome();drawDebts()}
function swapAuth(w){document.getElementById('tabLoginBtn').classList.toggle('active',w==='login');document.getElementById('tabRegBtn').classList.toggle('active',w==='reg');document.getElementById('authLogin').style.display=(w==='login')?'block':'none';document.getElementById('authReg').style.display=(w==='reg')?'block':'none'}
async function registerUser(){const email=document.getElementById('regEmail').value.trim();const pass=document.getElementById('regPass').value;const box=document.getElementById('regMsg');box.textContent='';if(!email||pass.length<6){box.textContent='Email dhe fjal√´kalim ‚â• 6.';return;}const {error}=await supabase.auth.signUp({email,password:pass});box.textContent=error?('Gabim: '+error.message):'Llogaria u krijua. Kontrollo email-in (n√´se k√´rkohet verifikim).'}
async function login(){const email=document.getElementById('loginEmail').value.trim();const pass=document.getElementById('loginPass').value;const box=document.getElementById('authMsg');box.textContent='';const {error}=await supabase.auth.signInWithPassword({email,password:pass});if(error) box.textContent='Gabim: '+error.message}
async function logout(){await supabase.auth.signOut()}
function switchTab(t){activeTab=t;document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.getElementById('tab-'+t).classList.add('active');document.querySelectorAll('.btn').forEach(x=>x.classList.remove('active'));document.querySelector(`.btn[data-tab="${t}"]`)?.classList.add('active');refreshHeader();if(t==='list')drawAll();if(t==='debts')drawDebts();}

/* ===== Profile (balance) ===== */
async function ensureProfile(){
  try{
    const { data } = await withRetry(()=>supabase.from('profiles').select('*').eq('user_id', sessionUser.id).single());
    profile = data || { balance:0 };
  }catch(_){
    try{
      const { data } = await supabase.from('profiles').upsert({user_id:sessionUser.id,balance:0}).select().single();
      profile = data || { balance:0 };
    }catch(e2){ console.warn('profiles upsert error', e2); }
  }
  document.getElementById('balInput').value=profile.balance ?? 0;
  refreshHeader();
}
async function saveBalance(){
  const val=parseFloat(document.getElementById('balInput').value); const b=isNaN(val)?0:val;
  const {data,error}=await supabase.from('profiles').upsert({user_id:sessionUser.id,balance:b}).select().single();
  const box=document.getElementById('balMsg'); box.textContent= error?('Gabim: '+error.message):'U ruajt.';
  if(!error){profile=data; refreshHeader();}
}
async function changeEmail(){const el=document.getElementById('newEmail');const msg=document.getElementById('emailMsg');msg.textContent='';const e=(el.value||'').trim();if(!e||!e.includes('@')){msg.textcontent='Shkruaj nj√´ email t√´ vlefsh√´m.';return;}const {error}=await supabase.auth.updateUser({email:e});msg.textContent=error?('Gabim: '+error.message):'U d√´rgua linku i konfirmimit te email-i i ri.';if(!error)el.value=''}
async function changePassword(){const p1=document.getElementById('newPass').value,p2=document.getElementById('newPass2').value,msg=document.getElementById('passMsg');msg.textContent='';if(!p1||p1.length<6){msg.textContent='Fjal√´kalimi ‚â• 6.';return;}if(p1!==p2){msg.textContent='Fjal√´kalimet nuk p√´rputhen.';return;}const {error}=await supabase.auth.updateUser({password:p1});msg.textContent=error?('Gabim: '+error.message):'Fjal√´kalimi u p√´rdit√´sua.';if(!error){document.getElementById('newPass').value='';document.getElementById('newPass2').value='';}}

/* ===== Header ===== */
function refreshHeader(){
  const icon=document.getElementById('hdrIcon'), text=document.getElementById('hdrText'), sub=document.getElementById('hdrSub');
  const s1=document.getElementById('s1name'), s2=document.getElementById('s2name'), s3=document.getElementById('s3name');

  if(activeTab==='debts'){
    icon.textContent='üí≥'; text.textContent='Borxhet'; sub.textContent='Detyrimet & M√´ detyrohen';
    const borrowOpen=sum(debts.filter(x=>x.kind==='borrow' && x.status!=='paid').map(n=>Number(n.amount||0)));
    const lendOpen=sum(debts.filter(x=>x.kind==='lend' && x.status!=='paid').map(n=>Number(n.amount||0)));
    setText('hdrTotal',fmt(borrowOpen));
    s1.textContent='Gjithsej'; s2.textContent='Detyrime'; s3.textContent='M√´ detyrohen';
    const total=sum(debts.map(n=>Number(n.amount||0)));
    setText('stat1',fmt(total)); setText('stat2',fmt(borrowOpen)); setText('stat3',fmt(lendOpen));
  }else{
    icon.textContent='üí∞'; text.textContent='Bilanci'; sub.textContent='Gjendja ‚àí Shpenzimet (totale)';
    const total=sum(items.map(x=>Number(x.amount||0)));
    const today=sum(items.filter(isToday).map(x=>Number(x.amount||0)));
    const month=sum(items.filter(isThisMonth).map(x=>Number(x.amount||0)));
    const remain=Number(profile?.balance||0) - total;
    setText('hdrTotal',fmt(remain));
    s1.textContent='Totale'; s2.textContent='Sot'; s3.textContent='Muaj';
    setText('stat1',fmt(total)); setText('stat2',fmt(today)); setText('stat3',fmt(month));
  }
}

/* ===== Shpenzimet ===== */
async function loadExpenses(){try{const { data }=await withRetry(()=>supabase.from('expenses').select('*').eq('user_id', sessionUser.id).order('d',{ascending:false}).limit(2000));items=data||[];drawHome();drawAll();refreshHeader();}catch(e){alert('Gabim ngarkimi (shpenzime): '+(e?.message||e));}}
async function saveExpense(){const name=document.getElementById('mName').value.trim();const amt=parseFloat(document.getElementById('mAmt').value);const cat=document.getElementById('mCat').value;const d=document.getElementById('mDate').value;if(!name||!amt||!d||isNaN(amt)){alert('Plot√´soni emrin, shum√´n dhe dat√´n.');return;}const {data,error}=await supabase.from('expenses').insert({user_id:sessionUser.id,name,amount:amt,category:cat,d}).select().single();if(error){alert('Gabim: '+error.message);return;}items.unshift(data);document.getElementById('mName').value='';document.getElementById('mAmt').value='';closeModal('Exp');drawHome();drawAll();refreshHeader();}
async function delExpense(id){if(!confirm('Fshini k√´t√´ shpenzim?'))return;const {error}=await supabase.from('expenses').delete().eq('id',id).eq('user_id',sessionUser.id);if(error){alert('Gabim: '+error.message);return;}items=items.filter(x=>x.id!==id);drawHome();drawAll();refreshHeader();}
function drawHome(){const recent=[...items].sort((a,b)=>b.d.localeCompare(a.d)).slice(0,8);const list=document.getElementById('recentList');list.innerHTML='';document.getElementById('emptyHome').style.display=recent.length?'none':'block';recent.forEach(x=>list.appendChild(rowExpense(x)))}
function drawAll(){const q=(document.getElementById('q').value||'').trim().toLowerCase();const cat=document.getElementById('fCat').value;let arr=[...items].sort((a,b)=>b.d.localeCompare(a.d));if(q)arr=arr.filter(x=>x.name.toLowerCase().includes(q)||(x.category||'').toLowerCase().includes(q));if(cat)arr=arr.filter(x=>x.category===cat);const box=document.getElementById('allList');box.innerHTML='';arr.forEach(x=>box.appendChild(rowExpense(x)))}
function rowExpense(x){const el=document.createElement('div');el.className='item';const ic=document.createElement('div');ic.className='ic';ic.textContent=emojiCat(x.category);const meta=document.createElement('div');meta.className='meta';const t=document.createElement('div');t.className='t';t.textContent=x.name;const s=document.createElement('div');s.className='s';s.textContent=[x.category,fmtDate(x.d)].filter(Boolean).join(' ‚Ä¢ ');meta.appendChild(t);meta.appendChild(s);const amt=document.createElement('div');amt.className='amt';amt.textContent=fmt(x.amount)+' L';const del=document.createElement('button');del.className='del';del.textContent='üóëÔ∏è';del.onclick=()=>delExpense(x.id);el.append(ic,meta,amt,del);return el}
function emojiCat(c){const m={'Ushqime':'üçî','Transport':'‚õΩ','Sht√´pia':'üè†','Arg√´tim':'üéüÔ∏è','Fatura':'üí°','T√´ tjera':'üßæ'};return m[c]||'üí∏'}

/* ===== Borxhet ===== */
async function loadDebts(){try{const { data }=await withRetry(()=>supabase.from('debts').select('*').eq('user_id', sessionUser.id).order('created_at',{ascending:false}).limit(2000));debts=data||[];drawDebts();refreshHeader();}catch(e){alert('Gabim ngarkimi (borxhe): '+(e?.message||e));}}
async function saveDebt(){const name=document.getElementById('dName').value.trim();const amt=parseFloat(document.getElementById('dAmt').value);const kind=segValue('segType');const due=document.getElementById('dDate').value||null;if(!name||!amt||isNaN(amt)){alert('Plot√´so emrin dhe shum√´n.');return;}const payload={user_id:sessionUser.id,name,amount:amt,kind,due,status:'open'};const {data,error}=await supabase.from('debts').insert(payload).select().single();if(error){alert('Gabim: '+error.message);return;}debts.unshift(data);document.getElementById('dName').value='';document.getElementById('dAmt').value='';resetSeg('segType','borrow');closeModal('Debt');drawDebts();refreshHeader();}
async function delDebt(id){if(!confirm('Fshini k√´t√´ borxh?'))return;const {error}=await supabase.from('debts').delete().eq('id',id).eq('user_id',sessionUser.id);if(error){alert('Gabim: '+error.message);return;}debts=debts.filter(x=>x.id!==id);drawDebts();refreshHeader();}
async function payDebt(id){const {data,error}=await supabase.from('debts').update({status:'paid'}).eq('id',id).eq('user_id',sessionUser.id).select().single();if(error){alert('Gabim: '+error.message);return;}debts=debts.map(x=>x.id===id?data:x);drawDebts();refreshHeader();}
function drawDebts(){
  const q=(document.getElementById('dq').value||'').trim().toLowerCase();
  const kindFilter=segValue('dSegFilter');
  let arr=[...debts];
  if(q)arr=arr.filter(x=>x.name.toLowerCase().includes(q));
  if(kindFilter)arr=arr.filter(x=>x.kind===kindFilter);

  const box=document.getElementById('debtList'); box.innerHTML='';
  document.getElementById('emptyDebts').style.display=arr.length?'none':'block';

  arr.forEach(x=>{
    const el=document.createElement('div'); el.className='item';
    const ic=document.createElement('div'); ic.className='ic'; ic.textContent=(x.status==='paid')?'‚úÖ':'üí≥';
    const meta=document.createElement('div'); meta.className='meta';
    const t=document.createElement('div'); t.className='t'; t.textContent=x.name;
    const bits=[x.kind==='borrow'?'Mora hua':'Dhash hua']; if(x.due) bits.push('Afati: '+fmtDate(x.due));
    const s=document.createElement('div'); s.className='s'; s.textContent=bits.join(' ‚Ä¢ ');
    meta.appendChild(t); meta.appendChild(s);
    const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
    const amt=document.createElement('div'); amt.className='amt'; amt.textContent=fmt(x.amount)+' L';
    right.appendChild(amt);
    if(x.status==='open'){
      const pay=document.createElement('button'); pay.className='btnMini'; pay.textContent=(x.kind==='borrow')?'Paguaj':'U kthye';
      pay.onclick=()=>payDebt(x.id); right.appendChild(pay);
    }else{
      const badge=document.createElement('span'); badge.className='chip ok'; badge.textContent='Paguar'; right.appendChild(badge);
    }
    const del=document.createElement('button'); del.className='del'; del.textContent='üóëÔ∏è'; del.onclick=()=>delDebt(x.id);
    el.append(ic,meta,right,del); box.appendChild(el);
  });
}

/* ===== Segments & helpers ===== */
function toggleSeg(id,btn){const p=document.getElementById(id);p.querySelectorAll('button').forEach(x=>x.classList.remove('active'));btn.classList.add('active')}
function segValue(id){return document.querySelector('#'+id+' .active')?.dataset.val||''}
function resetSeg(id,val){const p=document.getElementById(id);p.querySelectorAll('button').forEach(x=>x.classList.toggle('active',x.dataset.val===val))}
function openModal(which){document.getElementById('modal'+which).classList.add('on')}
function closeModal(which){document.getElementById('modal'+which).classList.remove('on')}
function setText(id,v){const e=document.getElementById(id);if(e)e.textContent=v}
function sum(a){return a.reduce((s,n)=>s+Number(n||0),0)}
function fmt(n){return (Math.round(n*100)/100).toLocaleString('sq-AL')}
function isToday(x){const d=new Date(x.d),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()&&d.getDate()==t.getDate()}
function isThisMonth(x){const d=new Date(x.d),t=new Date();return d.getFullYear()==t.getFullYear()&&d.getMonth()==t.getMonth()}
function fmtDate(iso){const d=new Date(iso+'T00:00:00');return d.toLocaleDateString('sq-AL',{day:'2-digit',month:'short',year:'numeric'})}
</script>
</body>
</html>
