<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cüzdanlar (ALL/EUR/USD/TRY)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body{background:#0b0e13;color:#e8f0ff}
  .card{background:#121826;border-color:#1f2a44}
  .nav-pills .nav-link.active{background:#2b3a67}
  .sticky-top-blur{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(11,14,19,.85)}
  .small-muted{opacity:.8;font-size:.9rem}
  .table td,.table th{color:#e8f0ff;border-color:#223}
</style>
</head>
<body>
<div class="container py-3">
  <div class="sticky-top-blur">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h1 class="h5 my-2">💼 Cüzdanlar</h1>
      <div>
        <select id="langSel" class="form-select form-select-sm d-inline-block" style="width:auto;">
          <option value="sq">Shqip</option><option value="tr">Türkçe</option><option value="en">English</option><option value="it">Italiano</option>
        </select>
        <button id="btnLogout" class="btn btn-sm btn-outline-light ms-2" style="display:none">Çıkış</button>
      </div>
    </div>

    <div class="card mb-2">
      <div class="card-body py-2 d-flex flex-wrap align-items-center justify-content-between">
        <div>
          <span class="small-muted">Varsayılan Kur:</span>
          <span id="baseCur" class="badge bg-primary ms-1">ALL</span>
          <span class="ms-3 small-muted">Kurlar:</span>
          <span id="fxSpan">—</span>
        </div>
        <div class="fw-bold">
          Toplam: <span id="grandTotal">—</span>
        </div>
      </div>
    </div>

    <ul class="nav nav-pills gap-2 mb-3" id="quickWallets"></ul>
  </div>

  <!-- AUTH -->
  <div id="authView" class="my-4">
    <div class="row">
      <div class="col-md-6">
        <div class="card"><div class="card-header"><b>Giriş</b></div>
          <div class="card-body">
            <input id="loginEmail" class="form-control mb-2" type="email" placeholder="email@example.com">
            <input id="loginPass" class="form-control mb-3" type="password" placeholder="••••••••">
            <button id="btnLogin" class="btn btn-primary w-100">Giriş</button>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card"><div class="card-header"><b>Kayıt Ol</b></div>
          <div class="card-body">
            <input id="regEmail" class="form-control mb-2" type="email" placeholder="email@example.com">
            <input id="regPass" class="form-control mb-3" type="password" placeholder="••••••••">
            <button id="btnRegister" class="btn btn-success w-100">Kayıt Ol</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appView" style="display:none;">
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabDash">Özet</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabTx">Hareketler</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabDebt">Borç</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabCats">Kategoriler</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabSettings">Ayarlar</a></li>
    </ul>

    <div class="tab-content">
      <!-- DASH -->
      <div id="tabDash" class="tab-pane fade show active">
        <div class="row g-3">
          <div class="col-md-3"><div class="card"><div class="card-body"><div class="small-muted">ALL</div><div id="balALL" class="h5">—</div></div></div></div>
          <div class="col-md-3"><div class="card"><div class="card-body"><div class="small-muted">EUR</div><div id="balEUR" class="h5">—</div></div></div></div>
          <div class="col-md-3"><div class="card"><div class="card-body"><div class="small-muted">USD</div><div id="balUSD" class="h5">—</div></div></div></div>
          <div class="col-md-3"><div class="card"><div class="card-body"><div class="small-muted">TRY</div><div id="balTRY" class="h5">—</div></div></div></div>
        </div>
      </div>

      <!-- TRANSACTIONS (expenses) -->
      <div id="tabTx" class="tab-pane fade">
        <div class="card mb-3"><div class="card-body">
          <div class="row g-2">
            <div class="col-md-3">
              <select id="txType" class="form-select">
                <option value="expense" selected>Gider</option>
                <option value="income">Gelir</option>
              </select>
            </div>
            <div class="col-md-3"><input id="txAmount" class="form-control" type="number" step="0.01" placeholder="0.00"></div>
            <div class="col-md-2">
              <select id="txCur" class="form-select"><option>ALL</option><option>EUR</option><option>USD</option><option>TRY</option></select>
            </div>
            <div class="col-md-4"><input id="txName" class="form-control" placeholder="Açıklama"></div>
            <div class="col-md-3"><input id="txDate" class="form-control" type="date"></div>
            <div class="col-md-3"><button id="btnAddTx" class="btn btn-primary w-100">Ekle</button></div>
          </div>
        </div></div>

        <div class="card"><div class="card-body">
          <table class="table table-sm align-middle">
            <thead><tr><th>Tarih</th><th>Açıklama</th><th>Tutar</th><th></th></tr></thead>
            <tbody id="txTable"></tbody>
          </table>
        </div></div>
      </div>

      <!-- DEBTS -->
      <div id="tabDebt" class="tab-pane fade">
        <div class="card mb-3"><div class="card-body">
          <div class="row g-2">
            <div class="col-md-3">
              <select id="debtDir" class="form-select"><option value="lend">Borç verdim</option><option value="borrow">Borç aldım</option></select>
            </div>
            <div class="col-md-3"><input id="debtPerson" class="form-control" placeholder="Ad Soyad"></div>
            <div class="col-md-2"><input id="debtAmt" class="form-control" type="number" step="0.01" placeholder="0.00"></div>
            <div class="col-md-2">
              <select id="debtCur" class="form-select"><option>ALL</option><option>EUR</option><option>USD</option><option>TRY</option></select>
            </div>
            <div class="col-md-2"><button id="btnAddDebt" class="btn btn-warning w-100">Ekle</button></div>
            <div class="col-12"><input id="debtNote" class="form-control" placeholder="Not"></div>
          </div>
        </div></div>

        <div class="row g-3">
          <div class="col-md-6"><div class="card"><div class="card-header"><b>Açık Borçlar</b></div><div class="card-body"><div id="openDebts"></div></div></div></div>
          <div class="col-md-6"><div class="card"><div class="card-header"><b>Kapanan Borçlar</b></div><div class="card-body"><div id="closedDebts"></div></div></div></div>
        </div>
      </div>

      <!-- CATEGORIES -->
      <div id="tabCats" class="tab-pane fade">
        <div class="card mb-3"><div class="card-body row g-2">
          <div class="col-md-6"><input id="catName" class="form-control" placeholder="Kategori adı"></div>
          <div class="col-md-3">
            <select id="catKind" class="form-select"><option value="expense">Gider</option><option value="income">Gelir</option></select>
          </div>
          <div class="col-md-3"><button id="btnAddCat" class="btn btn-primary w-100">Ekle</button></div>
          <div class="col-md-3 mt-2"><button id="btnSeedCats" class="btn btn-outline-info w-100">156 Yükle</button></div>
        </div></div>
        <div class="card"><div class="card-body">
          <table class="table table-sm"><thead><tr><th>Ad</th><th>Tür</th><th></th></tr></thead><tbody id="catsTable"></tbody></table>
        </div></div>
      </div>

      <!-- SETTINGS -->
      <div id="tabSettings" class="tab-pane fade">
        <div class="card"><div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Varsayılan Dil</label>
              <select id="setLang" class="form-select">
                <option value="sq">Shqip</option><option value="tr">Türkçe</option><option value="en">English</option><option value="it">Italiano</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Varsayılan Para Birimi</label>
              <select id="setCur" class="form-select">
                <option value="ALL">ALL</option><option value="EUR">EUR</option><option value="USD">USD</option><option value="TRY">TRY</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Sayı Biçimi</label>
              <select id="setNumFmt" class="form-select">
                <option value="eu">1.234,56</option><option value="us">1,234.56</option>
              </select>
            </div>
            <div class="col-12 d-grid"><button id="btnSaveSettings" class="btn btn-success">Kaydet</button></div>
          </div>
          <div class="mt-2 small-muted">Üstteki hızlı cüzdan sekmeleri kalıcı değil; kalıcı olan burada seçtiklerin.</div>
        </div></div>
      </div>

    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = 'https://<senin-projen>.supabase.co';
const SUPABASE_ANON_KEY = '<senin-anon-key>';
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const CURS = ["ALL","EUR","USD","TRY"];
let session=null, profile=null; // profile = public.profiles row
let expenses=[], cats=[], debtsOpen=[], debtsClosed=[];
let settings = { default_currency:"ALL", lang:"sq", num_format:"eu" };
let fx = { base:"ALL", rates:{ALL:1,EUR:1,USD:1,TRY:1}, t:0 };

/* ================= HELPERS ================= */
const nf = (n, c, fmt) => new Intl.NumberFormat(undefined, { style:'currency', currency:c }).format(Number(n||0));
const asDate = d => (d||new Date().toISOString().slice(0,10));

function toBase(amt, cur, base){
  if(cur===base) return amt;
  const rate = fx.rates[cur]; // 1 base = rate cur
  return amt / (rate || 1);   // cur → base
}

async function ensureProfile(){
  // profiles satırın yoksa oluştur
  const { data:prof } = await supa.from('profiles').select('*').eq('user_id', session.user.id).maybeSingle();
  if(!prof){
    await supa.from('profiles').insert({
      user_id: session.user.id, default_currency:'ALL', lang:'sq', num_format:'eu', balances: {}
    });
    settings = { default_currency:'ALL', lang:'sq', num_format:'eu' };
  } else {
    settings = {
      default_currency: prof.default_currency || 'ALL',
      lang: prof.lang || 'sq',
      num_format: prof.num_format || 'eu'
    };
  }
  profile = prof || { user_id: session.user.id, ...settings };
}

async function loadAll(){
  // expenses
  const { data:ex } = await supa.from('expenses').select('*').eq('user_id', session.user.id).order('d',{ascending:false}).limit(1000);
  expenses = ex || [];
  // categories (opsiyonel)
  const { data:cs } = await supa.from('categories').select('*').eq('user_id', session.user.id).order('name');
  cats = cs || [];
  // debts (opsiyonel)
  const { data:d1 } = await supa.from('debts').select('*').eq('user_id', session.user.id).eq('status','open').order('created_at',{ascending:false});
  const { data:d2 } = await supa.from('debts').select('*').eq('user_id', session.user.id).eq('status','settled').order('settled_at',{ascending:false});
  debtsOpen = d1 || []; debtsClosed = d2 || [];
}

async function fetchFX(base){
  const now = Date.now();
  if(fx.base===base && (now - fx.t) < 3600_000) return fx; // saatlik
  const symbols = CURS.filter(c=>c!==base).join(',');
  const url = `https://api.frankfurter.app/latest?from=${base}&to=${symbols}`;
  const res = await fetch(url);
  if(!res.ok){ console.warn('FX fetch failed'); return fx; }
  const data = await res.json();
  fx = { base, rates: { ...data.rates, [base]:1 }, t: now };
  // cachele
  await supa.from('fx_rates').upsert({
    user_id: session.user.id,
    base_currency: base,
    rates: fx.rates,
    fetched_at: new Date().toISOString()
  });
  renderFX();
  return fx;
}

/* ================= RENDER ================= */
function renderFX(){
  document.getElementById('baseCur').textContent = settings.default_currency;
  const other = CURS.filter(c=>c!==settings.default_currency);
  document.getElementById('fxSpan').textContent =
    other.map(t=>`1 ${settings.default_currency} → ${fx.rates[t]?.toFixed(4)} ${t}`).join(' | ');
}

function renderQuickPills(){
  const ul = document.getElementById('quickWallets');
  ul.innerHTML='';
  CURS.forEach(cur=>{
    const a=document.createElement('a');
    a.className='nav-link'; a.href='#'; a.textContent=cur;
    a.onclick=(e)=>{ e.preventDefault(); ul.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active')); a.classList.add('active'); };
    ul.appendChild(a);
  });
}

function renderBalances(){
  const sums={ALL:0,EUR:0,USD:0,TRY:0};
  for(const ex of expenses){
    const sign = (ex.name?.startsWith('+') || ex.amount>=0) ? 1 : 1; // gelir/gideri txType ile ayırmadığımız için işaret: negatif girersen gider kabul.
    sums[ex.curr] += Number(ex.amount)*sign;
  }
  document.getElementById('balALL').textContent=nf(sums.ALL,'ALL');
  document.getElementById('balEUR').textContent=nf(sums.EUR,'EUR');
  document.getElementById('balUSD').textContent=nf(sums.USD,'USD');
  document.getElementById('balTRY').textContent=nf(sums.TRY,'TRY');

  const b=settings.default_currency;
  const grand = toBase(sums.ALL,'ALL',b)+toBase(sums.EUR,'EUR',b)+toBase(sums.USD,'USD',b)+toBase(sums.TRY,'TRY',b);
  document.getElementById('grandTotal').textContent = nf(grand, b);
}

function renderTx(){
  const tb=document.getElementById('txTable'); tb.innerHTML='';
  expenses.forEach(ex=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${ex.d}</td>
      <td>${ex.name||''}</td>
      <td>${nf(ex.amount, ex.curr)}</td>
      <td><button class="btn btn-sm btn-outline-danger">×</button></td>
    `;
    tr.querySelector('button').onclick=async ()=>{
      await supa.from('expenses').delete().eq('id', ex.id);
      await reload();
    };
    tb.appendChild(tr);
  });
}

function renderCats(){
  const tb=document.getElementById('catsTable'); tb.innerHTML='';
  cats.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.name}</td><td>${c.kind}</td><td><button class="btn btn-sm btn-outline-danger">×</button></td>`;
    tr.querySelector('button').onclick=async ()=>{
      await supa.from('categories').delete().eq('id', c.id);
      await reload();
    };
    tb.appendChild(tr);
  });
}

function debtCard(d){
  const wrap=document.createElement('div'); wrap.className='card mb-2';
  wrap.innerHTML=`
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <div><b>${d.person}</b> • ${d.direction==='lend'?'Borç verdim':'Borç aldım'}</div>
        <div>${nf(d.principal, d.currency)}</div>
        ${d.note?`<div class="small-muted">${d.note}</div>`:''}
      </div>
      <div>
        ${d.status==='open'?`<button class="btn btn-sm btn-success me-2" data-act="settle">Kapat</button>`:''}
        <button class="btn btn-sm btn-outline-danger" data-act="del">×</button>
      </div>
    </div>
  `;
  wrap.querySelectorAll('button').forEach(btn=>{
    const act=btn.getAttribute('data-act');
    btn.onclick=async ()=>{
      if(act==='settle'){
        if(!confirm('Bu borcu kapattığına emin misin?')) return;
        await supa.from('debts').update({ status:'settled', settled_at:new Date().toISOString() }).eq('id', d.id);
        await supa.from('debt_events').insert({ debt_id:d.id, user_id:session.user.id, event:'settled' });
      } else if(act==='del'){
        await supa.from('debts').delete().eq('id', d.id);
      }
      await reload();
    };
  });
  return wrap;
}

function renderDebts(){
  const o=document.getElementById('openDebts'); o.innerHTML='';
  debtsOpen.forEach(d=>o.appendChild(debtCard(d)));
  const c=document.getElementById('closedDebts'); c.innerHTML='';
  debtsClosed.forEach(d=>c.appendChild(debtCard(d)));
}

/* ================= EVENTS ================= */
document.getElementById('btnRegister').onclick=async ()=>{
  const email=document.getElementById('regEmail').value.trim();
  const pass=document.getElementById('regPass').value.trim();
  const { error } = await supa.auth.signUp({ email, password: pass });
  if(error) return alert(error.message);
  alert('E-posta doğrulamasını kontrol et.');
};

document.getElementById('btnLogin').onclick=async ()=>{
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value.trim();
  const { data, error } = await supa.auth.signInWithPassword({ email, password: pass });
  if(error) return alert(error.message);
  session=data.session; await afterLogin();
};

document.getElementById('btnLogout').onclick=async ()=>{
  await supa.auth.signOut(); session=null; profile=null;
  document.getElementById('authView').style.display='';
  document.getElementById('appView').style.display='none';
  document.getElementById('btnLogout').style.display='none';
};

document.getElementById('btnAddTx').onclick=async ()=>{
  const name=document.getElementById('txName').value||'-';
  const amount=Number(document.getElementById('txAmount').value||0);
  const curr=document.getElementById('txCur').value;
  const type=document.getElementById('txType').value; // sadece işaret için
  const d=document.getElementById('txDate').value || new Date().toISOString().slice(0,10);
  if(!amount) return alert('Tutar?');

  // type = expense ise negatife çevirmek istiyorsan: (şu an pozitif girsen bile hesap “pozitif” toplar)
  // Amount'ı aynen saklıyoruz; istersen burada (type==='expense' ? -Math.abs(amount) : Math.abs(amount)) yapabilirsin.
  await supa.from('expenses').insert({ user_id: session.user.id, name, amount, curr, d });
  document.getElementById('txAmount').value=''; document.getElementById('txName').value='';
  await reload();
};

document.getElementById('btnAddDebt').onclick=async ()=>{
  const direction=document.getElementById('debtDir').value;
  const person=document.getElementById('debtPerson').value.trim();
  const principal=Number(document.getElementById('debtAmt').value||0);
  const currency=document.getElementById('debtCur').value;
  const note=document.getElementById('debtNote').value||null;
  if(!person||!principal) return alert('Eksik!');
  await supa.from('debts').insert({ user_id: session.user.id, direction, person, principal, currency, note });
  document.getElementById('debtPerson').value=''; document.getElementById('debtAmt').value=''; document.getElementById('debtNote').value='';
  await reload();
};

document.getElementById('btnAddCat').onclick=async ()=>{
  const name=document.getElementById('catName').value.trim();
  const kind=document.getElementById('catKind').value;
  if(!name) return;
  await supa.from('categories').insert({ user_id: session.user.id, name, kind });
  document.getElementById('catName').value='';
  await reload();
};

document.getElementById('btnSeedCats').onclick=async ()=>{
  const names=[
    'Qira','Ujë','Drita','Internet','Telefon','Karburant','Parkim','Servis','Sigurim','Market',
    'Restorant','Kafe','Rroba','Këpucë','Kozmetikë','Shëndet','Barnatore','Dhëmbë','Gym',
    'Argëtim','Filma/Muzikë','Udhëtim','Hotel','Bileta','Taksi','Transport Publik','Arsim',
    'Libra','Zyra','Printer','Letra','Dhërata','Bamirësi','Tjetër-Gider','Rrogë','Shitje','Komision',
    'Interes','Qira e Marrë','Tjetër-Gelir'
  ];
  const rows=names.map(n=>({ user_id: session.user.id, name:n, kind: ['Rrogë','Shitje','Komision','Interes','Qira e Marrë','Tjetër-Gelir'].includes(n)?'income':'expense' }));
  await supa.from('categories').insert(rows);
  await reload();
};

document.getElementById('btnSaveSettings').onclick=async ()=>{
  const lang=document.getElementById('setLang').value;
  const default_currency=document.getElementById('setCur').value;
  const num_format=document.getElementById('setNumFmt').value;
  await supa.from('profiles').upsert({ user_id: session.user.id, lang, default_currency, num_format });
  settings={ lang, default_currency, num_format };
  document.getElementById('langSel').value=lang;
  await fetchFX(settings.default_currency);
  await reload(false);
};

document.getElementById('langSel').onchange=()=>{
  // Şimdilik sadece görüntüde tutuyoruz; kalıcı olan Ayarlar’daki seçim
};

/* ================= FLOW ================= */
async function afterLogin(){
  document.getElementById('authView').style.display='none';
  document.getElementById('appView').style.display='';
  document.getElementById('btnLogout').style.display='';

  await ensureProfile();
  document.getElementById('langSel').value=settings.lang;
  document.getElementById('setLang').value=settings.lang;
  document.getElementById('setCur').value=settings.default_currency;
  document.getElementById('setNumFmt').value=settings.num_format;
  renderQuickPills();

  // önbellekte varsa oku
  const { data:fxRow } = await supa.from('fx_rates').select('*')
    .eq('user_id', session.user.id).eq('base_currency', settings.default_currency).maybeSingle();
  if(fxRow){ fx={ base: settings.default_currency, rates: fxRow.rates, t: Date.parse(fxRow.fetched_at)||0 }; }

  await fetchFX(settings.default_currency);
  await reload();
}

async function reload(refetchFX=true){
  await loadAll();
  if(refetchFX) await fetchFX(settings.default_currency);
  renderFX();
  renderBalances();
  renderTx();
  renderCats();
  renderDebts();
}

supa.auth.getSession().then(async ({data})=>{
  if(data.session){ session=data.session; await afterLogin(); }
  else{
    document.getElementById('authView').style.display='';
    document.getElementById('appView').style.display='none';
  }
});
supa.auth.onAuthStateChange((_e,s)=>{ session=s; });

document.getElementById('txDate').value = new Date().toISOString().slice(0,10);
</script>
</body>
</html>
