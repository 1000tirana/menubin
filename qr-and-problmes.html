<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
<title>QR App · Lista & Probleme</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{
  --bg:#0d0f14; --muted:#a8b0c2; --text:#eef2ff; --primary:#2ccf7c; --warning:#ffc857;
  --card:#121724; --line:#232a3b; --shadow:0 10px 20px rgba(0,0,0,.35); --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;color:var(--text);
  background: radial-gradient(1200px 600px at 10% -10%, #18233c 0%, transparent 60%), radial-gradient(800px 500px at 110% 10%, #1b2c2a 0%, transparent 50%), var(--bg);}
a{color:inherit}button{font:inherit}
.safe{padding-left:max(16px,env(safe-area-inset-left));padding-right:max(16px,env(safe-area-inset-right));}
.safe-top{padding-top:max(14px,env(safe-area-inset-top));}.safe-bottom{padding-bottom:max(14px,env(safe-area-inset-bottom));}
.appbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(5,8,15,.9),rgba(5,8,15,.55) 40%,rgba(5,8,15,0));backdrop-filter:blur(10px);}
.appbar .row{display:flex;align-items:center;gap:10px}.h1{font-size:22px;font-weight:800;letter-spacing:.3px}
.badge{font-size:12px;padding:4px 10px;border-radius:999px;background:#1f2433;color:#c7cee1;border:1px solid #2a3145}
.camera-pill{background:#173022;color:#b7f1cf;border:1px solid #25553c}
.appbar .bar{display:flex;align-items:center;justify-content:space-between;padding:10px 0}
.screen{display:none;min-height:calc(100dvh - 90px)}.screen.active{display:block}.section{padding:10px 0}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}.card.pad{padding:12px}
.video-wrap{position:relative;border-radius:12px;overflow:hidden;background:#0a0d14;aspect-ratio:3/4}
video{width:100%;height:100%;object-fit:cover;display:block}
.scan-frame{position:absolute;inset:10%;border:2px solid rgba(255,255,255,.55);border-radius:14px;pointer-events:none;transition:box-shadow .12s,border-color .12s}
.glow-green{box-shadow:0 0 0 9999px rgba(0,128,0,.14) inset,0 0 22px rgba(0,255,144,.75) inset;border-color:rgba(0,255,144,.95)}
.glow-red{box-shadow:0 0 0 9999px rgba(255,0,0,.14) inset,0 0 22px rgba(255,80,80,.9) inset;border-color:rgba(255,90,90,.95)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.btn{appearance:none;border:none;border-radius:14px;background:#232a3b;color:var(--text);padding:12px 14px;font-size:15px;font-weight:700;cursor:pointer}
.btn:disabled{opacity:.5;cursor:not-allowed}.btn.primary{background:var(--primary);color:#06130d;font-weight:900}
.btn.warn{background:var(--warning);color:#1c1500}
.select{appearance:none;border:1px solid #2b3349;border-radius:12px;background:#101625;color:#d7e0ff;padding:10px 12px;font-size:14px}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:999px;border:1px solid #2a3145;background:#182032;color:#b9c2da;font-size:12px;font-weight:700;cursor:pointer}
.tab.active{background:#1a2a22;border-color:#2c5c46;color:#c9f4dd}
.list{list-style:none;margin:8px 0 0;padding:0}
.item{display:flex;align-items:center;gap:10px;border-bottom:1px dashed #263049;padding:12px 6px}.item:last-child{border-bottom:none}
.k{width:30px;height:30px;border-radius:10px;background:#1b2131;display:flex;align-items:center;justify-content:center;font-weight:800;color:#cbd6f0;flex:0 0 auto}
.v{flex:1;font-weight:800;font-size:18px;letter-spacing:.5px}.meta{color:#9ca7c2;font-size:12px}
.actions{display:flex;gap:6px}
.iconbtn{width:38px;height:38px;border-radius:12px;background:#1a2030;border:1px solid #2b3349;display:flex;align-items:center;justify-content:center}
.iconbtn svg{width:18px;height:18px;opacity:.9}.iconbtn.del{background:#281a1a;border-color:#3d2626}.iconbtn.copy{background:#17241d;border-color:#254e3a}.iconbtn.share{background:#1a1e2e}
.nav{position:sticky;bottom:0;left:0;right:0;z-index:60;border-top:1px solid var(--line);background:linear-gradient(180deg,rgba(10,12,18,.2),rgba(10,12,18,.75) 40%,rgba(10,12,18,.95) 100%);backdrop-filter:blur(10px)}
.nav .bar{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:10px 0}.nav .btnnav{display:flex;flex-direction:column;align-items:center;gap:6px;font-size:11px;color:#c7cfe3;opacity:.9}
.nav .btnnav.active{color:#caffea}.nav .btnnav svg{width:20px;height:20px}
.fab{position:fixed;right:max(16px,env(safe-area-inset-right));bottom:calc(76px + env(safe-area-inset-bottom));width:64px;height:64px;border-radius:22px;background:var(--primary);color:#04100b;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:900;box-shadow:0 15px 30px rgba(44,207,124,.35)}
.fab:active{transform:translateY(1px) scale(.995)}
.toast{position:fixed;left:50%;bottom:calc(110px + env(safe-area-inset-bottom));transform:translateX(-50%);background:#0f1626;color:#e8f1ff;border:1px solid #223156;border-radius:12px;padding:10px 14px;display:none;z-index:100}
.sheet-back{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:90}
.sheet{position:absolute;left:0;right:0;bottom:0;background:#0e141f;border-top-left-radius:18px;border-top-right-radius:18px;border:1px solid #223156;box-shadow:var(--shadow);padding:12px 14px 20px;transform:translateY(100%);transition:transform .2s ease-out}
.sheet.show{transform:translateY(0)}.sheet .title{font-size:14px;letter-spacing:.3px;color:#b9c2d9;margin-bottom:10px}
.chips{display:flex;flex-wrap:wrap;gap:8px}.chip{padding:8px 12px;border-radius:999px;background:#172033;border:1px solid #243052;color:#cfd6ea;font-size:12px;font-weight:700;cursor:pointer}
.chip.sel{background:#1a2a22;border-color:#2e5e48;color:#dff8ea}.row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.row input,.row textarea,.row select{flex:1;background:#11192a;border:1px solid #253150;color:#e6eeff;padding:10px 12px;border-radius:12px;font-size:14px}
.sheet .actions{display:flex;gap:8px;margin-top:10px}.sheet .actions .btn{flex:1}
.hidden{display:none !important}
</style>
</head>
<body>
<div class="appbar safe safe-top">
  <div class="bar row">
    <div class="row">
      <div class="h1">QR App</div>
      <div id="camStatus" class="badge camera-pill">Kamera: Mbyllur</div>
    </div>
    <select id="cameraSelect" class="select" title="Kamera seç" style="min-width:180px"></select>
  </div>
</div>

<main class="safe">
  <section id="screen-scan" class="screen active">
    <div class="section">
      <div class="card pad">
        <div class="video-wrap">
          <video id="video" autoplay playsinline muted></video>
          <div id="scanFrame" class="scan-frame"></div>
        </div>
        <div class="controls">
          <button id="startBtn" class="btn primary">Başlat</button>
          <button id="stopBtn" class="btn">Durdur</button>
          <button id="torchBtn" class="btn">Dritë</button>
          <button id="fixCamBtn" class="btn warn">Kamera Fix</button>
        </div>
        <div class="controls">
          <input id="manualInput" class="select" type="text" maxlength="64" placeholder="Kod yaz...">
          <button id="manualAddBtn" class="btn">Ekle</button>
        </div>
        <div class="controls">
          <div id="detectorInfo" class="badge">Tarayıcı: —</div>
        </div>
      </div>
    </div>
  </section>

  <section id="screen-list" class="screen">
    <div class="section">
      <div class="card pad">
        <div class="tabs">
          <div id="tabList" class="tab active">Lista <span id="count" class="badge" style="margin-left:6px">0</span></div>
          <div id="tabIssues" class="tab">Problemet <span id="issuesCount" class="badge" style="margin-left:6px">0</span></div>
        </div>
        <ul id="list" class="list"></ul>
        <ul id="issuesList" class="list hidden"></ul>
      </div>
    </div>
  </section>

  <section id="screen-export" class="screen">
    <div class="section">
      <div class="card pad">
        <div class="h1" style="font-size:18px">Eksport / Import</div>
        <div class="controls">
          <button id="copyBtn" class="btn">Kopjo (Aktif Tab)</button>
          <button id="shareBtn" class="btn">Ndaj / Share</button>
          <button id="waBtn" class="btn">WhatsApp</button>
        </div>
        <div class="controls">
          <button id="exportListBtn" class="btn">İndir · lista.csv</button>
          <button id="exportIssuesBtn" class="btn">İndir · problemet.csv</button>
        </div>
        <div class="controls">
          <button id="importListBtn" class="btn">Yükle · lista.csv</button>
          <input id="fileList" type="file" accept=".csv,text/csv" class="hidden">
          <button id="importIssuesBtn" class="btn">Yükle · problemet.csv</button>
          <input id="fileIssues" type="file" accept=".csv,text/csv" class="hidden">
        </div>
      </div>
    </div>
  </section>

  <section id="screen-settings" class="screen">
    <div class="section">
      <div class="card pad">
        <div class="h1" style="font-size:18px">Ayarlar</div>
        <p class="meta">Kamera için HTTPS veya <b>http://localhost</b> kullan. iPhone için Safari → Ayarlar → Kamera izni açık olmalı.</p>
      </div>
    </div>
  </section>
</main>

<nav class="nav safe safe-bottom">
  <div class="bar">
    <a data-nav="scan" class="btnnav active" href="javascript:void(0)">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 7V5a2 2 0 0 1 2-2h2v2H6v2H4Zm0 10h2v2h2v2H6a2 2 0 0 1-2-2v-2Zm12-14h2a2 2 0 0 1 2 2v2h-2V5h-2V3Zm2 14h2v2a2 2 0 0 1-2 2h-2v-2h2v-2ZM7 11h10v2H7v-2Z"/></svg>
      Tara
    </a>
    <a data-nav="list" class="btnnav" href="javascript:void(0)">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 5h14v2H7V5Zm0 6h14v2H7v-2Zm0 6h14v2H7v-2ZM3 5h2v2H3V5Zm0 6h2v2H3v-2Zm0 6h2v2H3v-2Z"/></svg>
      Liste
    </a>
    <a data-nav="export" class="btnnav" href="javascript:void(0)">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2Zm7-18 5 5h-3v6h-4V7H7l5-5Z"/></svg>
      Dışa Aktar
    </a>
    <a data-nav="settings" class="btnnav" href="javascript:void(0)">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.07-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7 7 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 13.9 1h-3.8a.5.5 0 0 0-.49.41l-.36 2.54c-.58.23-1.12.53-1.62.9l-2.4-.96a.5.5 0 0 0-.6.22L.7 7.93a.5.5 0 0 0 .12.64l2.03 1.58c-.05.31-.08.63-.08.96 0 .32.03.64.08.95L.82 13.64a.5.5 0 0 0-.12.64l1.92 3.32c.13.22.39.31.62.22l2.39-.96c.5.38 1.05.69 1.63.94l.36 2.54c.05.24.25.41.49.41h3.8c.24 0 .45-.17.49-.41l.36-2.54c.58-.23 1.12-.53 1.62-.9l2.4.96c.23.09.49 0 .6-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58ZM12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7Z"/></svg>
      Ayarlar
    </a>
  </div>
</nav>

<button id="fab" class="fab" title="Hızlı ekle">+</button>

<div id="sheet" class="sheet-back">
  <div class="sheet">
    <div class="title">Bu koda problem ekle (çoklu seçim)</div>
    <div id="chips" class="chips"></div>
    <div class="row"><input id="who" type="text" placeholder="Kush ta bëjë? (ops.) p.sh. Arbri"></div>
    <div class="row"><textarea id="note" rows="3" placeholder="Shënim (ops.)"></textarea></div>
    <div class="actions">
      <button id="sheetCancel" class="btn">Vazgeç</button>
      <button id="sheetSave" class="btn primary">Kaydet</button>
    </div>
  </div>
</div>

<canvas id="capture" class="hidden"></canvas>
<div id="toast" class="toast"></div>

<script>
/* ===== Abbrevs ===== */
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
function toast(m){const t=$('#toast'); t.textContent=m; t.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>t.style.display='none',1600);}
function last4(s){const only=String(s).replace(/[^0-9A-Za-z]/g,'');return only.slice(-4).toUpperCase();}
function fmtTime(d){return new Date(d).toLocaleString();}

/* ===== Elements ===== */
const screens={ scan:$('#screen-scan'), list:$('#screen-list'), export:$('#screen-export'), settings:$('#screen-settings') };
$$('.btnnav').forEach(b=>b.onclick=()=>navTo(b.dataset.nav));
function navTo(id){ Object.values(screens).forEach(x=>x.classList.remove('active')); $$('.btnnav').forEach(x=>x.classList.remove('active')); screens[id].classList.add('active'); document.querySelector(`.btnnav[data-nav="${id}"]`).classList.add('active'); }

const video=$('#video'),canvas=$('#capture'),ctx=canvas.getContext('2d',{willReadFrequently:true});
const startBtn=$('#startBtn'),stopBtn=$('#stopBtn'),torchBtn=$('#torchBtn'),fixCamBtn=$('#fixCamBtn'),camStatus=$('#camStatus'),cameraSelect=$('#cameraSelect');
const manualInput=$('#manualInput'),manualAddBtn=$('#manualAddBtn'),fab=$('#fab');
const listEl=$('#list'),issuesEl=$('#issuesList'),countEl=$('#count'),issuesCountEl=$('#issuesCount'),detectorInfo=$('#detectorInfo');
const scanFrame=$('#scanFrame');
const copyBtn=$('#copyBtn'),shareBtn=$('#shareBtn'),waBtn=$('#waBtn'),exportListBtn=$('#exportListBtn'),exportIssuesBtn=$('#exportIssuesBtn'),importListBtn=$('#importListBtn'),importIssuesBtn=$('#importIssuesBtn');
const fileList=$('#fileList'),fileIssues=$('#fileIssues');

/* ===== State ===== */
let stream=null,track=null,scanning=false,lastFrameAt=0,torchOn=false;
let items=[], issues=[], seen=new Map();
let pendingValue=null;
let scanCooldownUntil=0;

/* ===== Problems ===== */
const PROBLEMS=[
  "Iot nuk ka","Iot dhe bravë nuk ka","Bravë nuk ka","Rrota do të ndërrohet","Frena nuk punon",
  "Frena kampana do të ndërrohet","Shtylla e përparme lëkundet (tundet timonin)","Etiketat mungojnë",
  "Rrota do të ndërrohet (përsëritje)","Parafango do të ndërrohet (përpara ose mbrapa)"
];

/* ===== Detector Setup (BarcodeDetector → jsQR → yok) ===== */
let USE_DETECTOR = "none";
let BD=null; // BarcodeDetector instance
function updateDetectorInfo(){ detectorInfo.textContent = "Tarayıcı: " + (USE_DETECTOR==="bd"?"BarcodeDetector":"jsQR"===USE_DETECTOR?"jsQR":"— (manuel)"); }

async function setupDetector(){
  // 1) BarcodeDetector (yerleşik ve hızlı)
  if('BarcodeDetector' in window){
    try{
      const fmts = (await window.BarcodeDetector.getSupportedFormats?.()) || [];
      if(fmts.includes('qr_code') || fmts.includes('qr')){
        BD = new window.BarcodeDetector({formats:['qr_code']});
        USE_DETECTOR = "bd";
        updateDetectorInfo();
        return;
      }
    }catch{}
  }
  // 2) jsQR (eğer globalde varsa)
  if(window.jsQR){
    USE_DETECTOR = "jsQR";
    updateDetectorInfo();
    return;
  }
  // 3) yok → manuel mod
  USE_DETECTOR = "none";
  updateDetectorInfo();
}

/* ===== Camera ===== */
async function listCameras(selectedId){
  cameraSelect.innerHTML='';
  try{
    const devices=await navigator.mediaDevices.enumerateDevices();
    const vids=devices.filter(d=>d.kind==='videoinput');
    vids.forEach((d,i)=>{
      const opt=document.createElement('option');
      opt.value=d.deviceId; opt.textContent=d.label || `Kamera ${i+1}`;
      if(selectedId && d.deviceId===selectedId) opt.selected=true;
      cameraSelect.appendChild(opt);
    });
    if(vids.length===0){ const opt=document.createElement('option'); opt.textContent='(kamera yok)'; opt.value=''; cameraSelect.appendChild(opt); }
  }catch{
    const opt=document.createElement('option'); opt.textContent='(liste yok)'; opt.value=''; cameraSelect.appendChild(opt);
  }
}
async function startCam(deviceId=null){
  stopCam();
  try{
    const base={audio:false, video:{facingMode: deviceId? undefined : {ideal:'environment'}, deviceId: deviceId? {exact:deviceId}:undefined, width:{ideal:1280}, height:{ideal:720}}};
    let s=null; try{ s=await navigator.mediaDevices.getUserMedia(base); } catch{ s=await navigator.mediaDevices.getUserMedia({audio:false, video:true}); }
    stream=s; video.srcObject=stream; video.setAttribute('playsinline',''); video.muted=true; await video.play();
    scanning=true; track=stream.getVideoTracks()[0]||null; torchOn=false;
    const caps=track && track.getCapabilities ? track.getCapabilities() : {}; torchBtn.disabled=!(caps && 'torch' in caps);
    camStatus.textContent="Kamera: Hap"; await listCameras(track?.getSettings?.().deviceId);
    await setupDetector();
    scanLoop();
  }catch(e){ camStatus.textContent="Kamera: Mbyllur"; alert("Kamera nuk u hap: "+(e.message||e)); }
}
function stopCam(){ scanning=false; if(stream){ stream.getTracks().forEach(t=>t.stop()); } video.srcObject=null; track=null; torchOn=false; torchBtn.disabled=true; camStatus.textContent="Kamera: Mbyllur"; }
async function toggleTorch(){
  if(!track || !track.applyConstraints){ toast('Pa dritë'); return; }
  const caps=track.getCapabilities ? track.getCapabilities() : {}; if(!caps.torch){ toast('Drita nuk suportohet'); return; }
  try{ torchOn=!torchOn; await track.applyConstraints({advanced:[{torch:torchOn}]}); toast(torchOn?'Drita: On':'Drita: Off'); }catch{ torchOn=false; toast('Gabim drita'); }
}

/* ===== Scan Loop (async) ===== */
async function scanLoop(){
  if(!scanning) return;
  const now=performance.now();
  if(now-lastFrameAt<120){ return requestAnimationFrame(()=>scanLoop()); }
  lastFrameAt=now;

  if(video.readyState>=2){
    try{
      if(USE_DETECTOR==="bd" && BD){
        const codes = await BD.detect(video);
        if(codes && codes.length){
          const raw = codes[0].rawValue || codes[0].rawValue || codes[0].data || "";
          handlePossibleHit(raw);
        }
      }else if(USE_DETECTOR==="jsQR" && window.jsQR){
        canvas.width=video.videoWidth; canvas.height=video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const img=ctx.getImageData(0,0,canvas.width,canvas.height);
        const qr=jsQR(img.data,canvas.width,canvas.height,{inversionAttempts:'dontInvert'});
        if(qr && qr.data){ handlePossibleHit(qr.data); }
      }
    }catch(e){ /* swallow */ }
  }
  requestAnimationFrame(()=>scanLoop());
}

function handlePossibleHit(str){
  const now=performance.now();
  if(now < scanCooldownUntil) return; // debounce
  const v = last4(str||"");
  if(!v) return;
  scanCooldownUntil = now + 900; // 0.9s
  onScan(v);
}

/* ===== Data & Render ===== */
function updateSeen(){
  seen.clear();
  items.forEach((it,idx)=>seen.set(it.value,{where:'list',index:idx,time:it.time}));
  issues.forEach((it,idx)=>{ if(!seen.has(it.value)) seen.set(it.value,{where:'issue',index:idx,time:it.time,problems:it.problems}); });
}
function renderList(){
  listEl.innerHTML='';
  items.forEach((it,idx)=>{
    const li=document.createElement('li'); li.className='item';
    li.innerHTML=`
      <div class="k">${idx+1}</div>
      <div class="v">${it.value}</div>
      <div class="meta">${new Date(it.time).toLocaleTimeString()}</div>
      <div class="actions">
        <button class="iconbtn copy" data-act="copy" data-type="list" data-idx="${idx}" title="Kopyala">
          <svg viewBox="0 0 24 24"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1Zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H8V7h11v14Z"/></svg>
        </button>
        <button class="iconbtn share" data-act="share" data-type="list" data-idx="${idx}" title="Paylaş">
          <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.02-4.05A2.98 2.98 0 1 0 15 5c0 .24.04.47.09.7L8.06 9.76a3 3 0 1 0 0 4.48l7.03 4.06c-.05.22-.09.46-.09.7a3 3 0 1 0 3-3Z"/></svg>
        </button>
        <button class="iconbtn del" data-act="del" data-type="list" data-idx="${idx}" title="Sil">
          <svg viewBox="0 0 24 24"><path d="M9 3v1H4v2h16V4h-5V3H9Zm1 6v9H8V9h2Zm6 0v9h-2V9h2Z"/></svg>
        </button>
      </div>`;
    listEl.appendChild(li);
  });
  countEl.textContent=items.length;
}
function renderIssues(){
  issuesEl.innerHTML='';
  issues.forEach((it,idx)=>{
    const probs = it.problems && it.problems.length ? it.problems.join(', ') : '-';
    const li=document.createElement('li'); li.className='item';
    li.innerHTML=`
      <div class="k">${idx+1}</div>
      <div class="v">${it.value}</div>
      <div class="meta">${probs}</div>
      <div class="actions">
        <button class="iconbtn copy" data-act="copy" data-type="issue" data-idx="${idx}" title="Kopyala">
          <svg viewBox="0 0 24 24"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1Zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H8V7h11v14Z"/></svg>
        </button>
        <button class="iconbtn share" data-act="share" data-type="issue" data-idx="${idx}" title="Paylaş">
          <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.02-4.05A2.98 2.98 0 1 0 15 5c0 .24.04.47.09.7L8.06 9.76a3 3 0 1 0 0 4.48l7.03 4.06c-.05.22-.09.46-.09.7a3 3 0 1 0 3-3Z"/></svg>
        </button>
        <button class="iconbtn del" data-act="del" data-type="issue" data-idx="${idx}" title="Sil">
          <svg viewBox="0 0 24 24"><path d="M9 3v1H4v2h16V4h-5V3H9Zm1 6v9H8V9h2Zm6 0v9h-2V9h2Z"/></svg>
        </button>
      </div>`;
    issuesEl.appendChild(li);
  });
  issuesCountEl.textContent=issues.length;
}
function draw(){ renderList(); renderIssues(); updateSeen(); }

/* ===== Storage ===== */
function sget(k){try{return localStorage.getItem(k)}catch(e){return null}}
function sset(k,v){try{localStorage.setItem(k,v);return true}catch(e){return false}}
function save(){ sset("qrItems_v3", JSON.stringify(items)); sset("qrIssues_v1", JSON.stringify(issues)); }
function load(){
  try{ items=(JSON.parse(sget("qrItems_v3"))||[]).map(o=>({value:o.value,time:o.time?new Date(o.time):new Date()})); }catch{ items=[]; }
  try{ issues=(JSON.parse(sget("qrIssues_v1"))||[]).map(o=>({value:o.value,time:o.time?new Date(o.time):new Date(),problems:o.problems||[],note:o.note||"",who:o.who||""})); }catch{ issues=[]; }
  draw();
}

/* ===== Compose & Share ===== */
function rowText(type,obj,i){
  if(type==='issue'){
    const probs=(obj.problems||[]).join(', ');
    const who=obj.who?(' - '+obj.who):'';
    const note=obj.note?(' - '+obj.note):'';
    return `${i+1}. ${obj.value} -  - ${probs}${who}${note}`;
  }else{
    return `${i+1}. ${obj.value}`;
  }
}
function activeArray(){
  return tabIssues.classList.contains('active')
    ? issues.map((x,i)=>rowText('issue',x,i))
    : items.map((x,i)=>rowText('list',x,i));
}
function copyText(text){
  if(navigator.clipboard?.writeText) navigator.clipboard.writeText(text).then(()=>toast("Kopjuar!")).catch(()=>legacyCopy(text));
  else legacyCopy(text);
}
function legacyCopy(text){
  const ta=document.createElement('textarea');
  ta.value=text; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.focus(); ta.select();
  try{ document.execCommand('copy'); toast("Kopjuar!"); }catch{ alert("Kopjimi dështoi"); }
  document.body.removeChild(ta);
}
function shareText(text){ if(navigator.share){ navigator.share({text}).catch(()=>{});} else { window.open('https://wa.me/?text='+encodeURIComponent(text),'_blank'); } }

/* ===== CSV ===== */
function downloadCSV(filename, rows){
  const bom = "\ufeff";
  const csv = rows.map(r=>r.map(v=>{
    const s=(v===null||v===undefined)?'':String(v);
    return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
  }).join(",")).join("\n");
  const blob = new Blob([bom + csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0);
}
function exportListCSV(){
  const rows=[["index","value","time"]];
  items.forEach((it,i)=>rows.push([i+1,it.value,new Date(it.time).toISOString()]));
  downloadCSV("lista.csv", rows);
}
function exportIssuesCSV(){
  const rows=[["index","value","time","problems","note","who"]];
  issues.forEach((it,i)=>rows.push([i+1,it.value,new Date(it.time).toISOString(),(it.problems||[]).join("; "),it.note||"",it.who||""]));
  downloadCSV("problemet.csv", rows);
}
function parseCSV(text){
  const lines=text.replace(/\r/g,'').split('\n'), out=[];
  for(const line of lines){ if(line.trim()==="") continue; const row=[]; let cur='',inq=false;
    for(let i=0;i<line.length;i++){ const c=line[i];
      if(inq){ if(c==='\"'){ if(line[i+1]==='\"'){cur+='\"';i++;} else inq=false; } else cur+=c; }
      else{ if(c===','){ row.push(cur); cur=''; } else if(c==='\"'){ inq=true; } else cur+=c; }
    } row.push(cur); out.push(row);
  } return out;
}

/* ===== Tabs ===== */
const tabList=$('#tabList'), tabIssues=$('#tabIssues');
tabList.onclick=()=>{ tabList.classList.add('active'); tabIssues.classList.remove('active'); listEl.classList.remove('hidden'); issuesEl.classList.add('hidden'); };
tabIssues.onclick=()=>{ tabIssues.classList.add('active'); tabList.classList.remove('active'); issuesEl.classList.remove('hidden'); listEl.classList.add('hidden'); };

/* ===== Row actions ===== */
document.addEventListener('click',(e)=>{
  const btn=e.target.closest('.iconbtn'); if(!btn) return;
  const act=btn.dataset.act, typ=btn.dataset.type, idx=+btn.dataset.idx;
  if(Number.isNaN(idx)) return;
  if(typ==='list'){
    if(act==='del'){ if(confirm("Të fshihet ky rresht?")){ items.splice(idx,1); save(); draw(); } }
    if(act==='copy'){ copyText(rowText('list', items[idx], idx)); }
    if(act==='share'){ shareText(rowText('list', items[idx], idx)); }
  }else{
    if(act==='del'){ if(confirm("Të fshihet ky problem?")){ issues.splice(idx,1); save(); draw(); } }
    if(act==='copy'){ copyText(rowText('issue', issues[idx], idx)); }
    if(act==='share'){ shareText(rowText('issue', issues[idx], idx)); }
  }
});

/* ===== Add Flow ===== */
function onScan(v){
  // visual feedback
  scanFrame.classList.remove('glow-green','glow-red'); scanFrame.offsetWidth; scanFrame.classList.add('glow-green');
  setTimeout(()=>scanFrame.classList.remove('glow-green'),350);
  pendingValue=v; openSheet();
}
manualAddBtn.onclick=()=>{
  const v=last4(manualInput.value.trim()); if(!v){ toast('—'); return; }
  pendingValue=v; manualInput.value=''; openSheet();
};
fab.onclick=()=>{
  const v=prompt("Kod yaz (son 4):"); if(!v) return;
  const x=last4(v); if(!x) return; pendingValue=x; openSheet();
};

/* ===== Bottom Sheet ===== */
const sheetBack=$('#sheet'), sheetEl=$('#sheet .sheet'), chipsWrap=$('#chips'), whoEl=$('#who'), noteEl=$('#note'), sheetCancel=$('#sheetCancel'), sheetSave=$('#sheetSave');
function openSheet(){
  chipsWrap.innerHTML=''; PROBLEMS.forEach(txt=>{ const c=document.createElement('div'); c.className='chip'; c.textContent=txt; c.onclick=()=>c.classList.toggle('sel'); chipsWrap.appendChild(c); });
  whoEl.value=''; noteEl.value=''; sheetBack.style.display='block'; requestAnimationFrame(()=>sheetEl.classList.add('show'));
}
function closeSheet(){ sheetEl.classList.remove('show'); setTimeout(()=>sheetBack.style.display='none',150); }
sheetBack.addEventListener('click', (e)=>{ if(e.target===sheetBack) closeSheet(); });
sheetCancel.onclick=closeSheet;
sheetSave.onclick=()=>{
  if(!pendingValue) return closeSheet();
  const chosen=[...chipsWrap.querySelectorAll('.chip.sel')].map(x=>x.textContent);
  const info=seen.get(pendingValue);
  if(info){
    let msg=`Ky kod është regjistruar më parë.\n\nKod: ${pendingValue}\nKur: ${fmtTime(info.time)}`;
    if(info.where==='issue' && info.problems && info.problems.length) msg+=`\nLloj: PROBLEM\nProblemet: ${info.problems.join(', ')}`;
    else msg+=`\nLloj: LISTË e thjeshtë`;
    msg+=`\n\nTë fshihet regjistrimi i mëparshëm?`;
    const del=confirm(msg);
    if(del){ if(info.where==='list'){ items.splice(info.index,1);} else { issues.splice(info.index,1);} }
    else { toast("U ruajt i mëparshmi"); closeSheet(); return; }
  }
  if(chosen.length===0 && !noteEl.value.trim()){ items.push({value:pendingValue,time:new Date()}); }
  else{ issues.push({value:pendingValue,time:new Date(),problems:[...chosen],note:noteEl.value.trim(),who:whoEl.value.trim()}); }
  save(); draw(); toast("U ruajt"); closeSheet();
};

/* ===== Copy/Share/CSV Page ===== */
copyBtn.onclick=()=>copyText(activeArray().join("\n"));
shareBtn.onclick=()=>shareText(activeArray().join("\n"));
waBtn.onclick=()=>window.open('https://wa.me/?text='+encodeURIComponent(activeArray().join("\n")),'_blank');
exportListBtn.onclick=()=>{
  const rows=[["index","value","time"]]; items.forEach((it,i)=>rows.push([i+1,it.value,new Date(it.time).toISOString()]));
  downloadCSV("lista.csv", rows);
};
exportIssuesBtn.onclick=()=>{
  const rows=[["index","value","time","problems","note","who"]];
  issues.forEach((it,i)=>rows.push([i+1,it.value,new Date(it.time).toISOString(),(it.problems||[]).join("; "),it.note||"",it.who||""]));
  downloadCSV("problemet.csv", rows);
};
importListBtn.onclick=()=>fileList.click();
importIssuesBtn.onclick=()=>fileIssues.click();
fileList?.addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return; const r=new FileReader();
  r.onload=()=>{ try{ const rows=parseCSV(r.result); const header=rows[0].map(h=>h.trim().toLowerCase());
      const vi=header.indexOf("value"), ti=header.indexOf("time"); if(vi===-1) throw new Error();
      for(let i=1;i<rows.length;i++){ const v=last4(rows[i][vi]); if(!v) continue; const t=ti>-1? new Date(rows[i][ti]) : new Date(); items.push({value:v,time:t}); }
      save(); draw(); toast("U ngarkua Lista"); }catch{ alert("Gabim CSV"); } };
  r.readAsText(f); e.target.value='';
});
fileIssues?.addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return; const r=new FileReader();
  r.onload=()=>{ try{ const rows=parseCSV(r.result); const header=rows[0].map(h=>h.trim().toLowerCase());
      const vi=header.indexOf("value"), ti=header.indexOf("time"), pi=header.indexOf("problems"), ni=header.indexOf("note"), wi=header.indexOf("who"); if(vi===-1) throw new Error();
      for(let i=1;i<rows.length;i++){ const v=last4(rows[i][vi]); if(!v) continue; const t=ti>-1? new Date(rows[i][ti]) : new Date(); const probs=pi>-1? String(rows[i][pi]||'').split(/;\s*/).filter(Boolean):[]; const note=ni>-1? rows[i][ni] : ""; const who=wi>-1? rows[i][wi] : ""; issues.push({value:v,time:t,problems:probs,note,who}); }
      save(); draw(); toast("U ngarkuan Problemet"); }catch{ alert("Gabim CSV"); } };
  r.readAsText(f); e.target.value='';
});

/* ===== Nav ===== */
$$('.btnnav').forEach(b=>b.onclick=()=>navTo(b.dataset.nav));

/* ===== Camera buttons ===== */
startBtn.onclick=()=>startCam(cameraSelect.value||null);
stopBtn.onclick=stopCam;
torchBtn.onclick=toggleTorch;
fixCamBtn.onclick=async()=>{ try{ await navigator.mediaDevices.getUserMedia({video:true,audio:false}); }catch{} await listCameras(); startCam(cameraSelect.value||null); };

/* ===== Init ===== */
async function init(){
  if(location.protocol!=='https:' && location.hostname!=='localhost'){ toast("Kujdes: Kamera kërkon HTTPS ose localhost"); }
  load();
  await listCameras();
  // Try to create a detector early (so kullanıcı hangi modda olduğunu görsün)
  await setupDetector();
}
init();
</script>
</body>
</html>
