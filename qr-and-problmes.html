<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>QR Liste + SORUNLAR</title>
<style>
  :root{
    --bg:#0f1115; --card:#171a21; --muted:#a9b1c3; --text:#e7ebf5;
    --accent:#29c06f; --danger:#ff5d5d; --warn:#ffc53d; --blue:#3da3ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:20;background:#0b0d12;padding:10px 14px;display:flex;align-items:center;gap:10px;border-bottom:1px solid #1e2433}
  .title{font-weight:800}
  .pill{background:#1f2430;color:#a9b1c3;border-radius:999px;padding:4px 10px;font-size:12px}
  .container{max-width:980px;margin:0 auto;padding:12px 14px 140px}
  .card{background:var(--card);border:1px solid #242a39;border-radius:14px;padding:12px}
  .video-wrap{position:relative;border-radius:12px;overflow:hidden;background:#0a0c10;aspect-ratio:3/4}
  video{width:100%;height:100%;object-fit:cover;display:block}
  #capture{display:none}
  .frame{position:absolute;inset:10%;border:2px solid rgba(255,255,255,.5);border-radius:12px;pointer-events:none;transition:box-shadow .12s,border-color .12s}
  .glow-green{box-shadow:0 0 0 9999px rgba(0,128,0,.18) inset,0 0 22px rgba(0,255,144,.75) inset;border-color:rgba(0,255,144,.95)}
  .glow-red{box-shadow:0 0 0 9999px rgba(255,0,0,.18) inset,0 0 22px rgba(255,80,80,.9) inset;border-color:rgba(255,90,90,.95)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{appearance:none;border:0;border-radius:12px;background:#222734;color:var(--text);padding:10px 14px;font-weight:700;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  .btn-primary{background:var(--accent);color:#05120c}
  .btn-danger{background:var(--danger);color:#2b0000}
  .btn-warn{background:var(--warn);color:#2b1f00}
  .btn-info{background:var(--blue);color:#001427}
  .grid{display:grid;gap:14px;margin-top:14px}
  @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
  .list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .list{list-style:none;margin:0;padding:0}
  .item{display:flex;gap:10px;padding:10px 6px;border-top:1px dashed #2a3145}
  .item:first-child{border-top:0}
  .idx{flex:0 0 28px;height:28px;border-radius:999px;background:#242a39;display:flex;align-items:center;justify-content:center;color:#c3cbe0;font-weight:800}
  .val{font-size:18px;font-weight:800;letter-spacing:.6px}
  .sub{color:#a9b1c3;font-size:12px;margin-top:2px}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .chip{background:#23293a;border:1px solid #2f3850;border-radius:999px;padding:3px 8px;font-size:12px}
  .note{color:#ffdca8;font-size:12px;margin-top:4px}
  .act{display:flex;gap:6px}
  .toast{position:fixed;left:50%;bottom:92px;transform:translateX(-50%);background:#161d2a;color:#e7f1ff;border:1px solid #27324a;border-radius:10px;padding:8px 12px;display:none;z-index:50}
  .toolbar{position:fixed;left:0;right:0;bottom:0;z-index:40;background:rgba(10,12,16,.85);backdrop-filter:blur(10px);border-top:1px solid #242a39;padding:10px 14px;display:flex;gap:10px}
  .toolbar .btn{flex:1}
  /* Modals */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:60}
  .modal .box{background:#121722;border:1px solid #2a3145;border-radius:14px;padding:14px;max-width:640px;width:92%}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .opt-grid{display:grid;grid-template-columns:1fr;gap:8px;max-height:38vh;overflow:auto;margin:8px 0}
  @media(min-width:520px){.opt-grid{grid-template-columns:1fr 1fr}}
  .opt{display:flex;gap:8px;align-items:flex-start;background:#1a2030;border:1px solid #2a3145;border-radius:10px;padding:8px}
  input[type="text"]{width:100%;background:#1b2030;border:1px solid #2a3246;color:var(--text);padding:10px;border-radius:10px}
  .last{position:sticky;top:46px;z-index:15;margin:6px 12px;background:#122019;color:#bff4d1;border:1px solid #1b3a2b;border-left:4px solid var(--accent);border-radius:10px;padding:8px 12px;display:none}
  .last.dup{background:#2b1515;color:#f8c6c6;border-color:var(--danger)}
</style>
</head>
<body>
<header>
  <div class="title">QR Liste</div>
  <div id="camStatus" class="pill">Kamera: Kapalı</div>
</header>

<div id="lastBanner" class="last">Son: <strong id="lastVal">—</strong></div>

<div class="container">
  <div class="card">
    <div class="video-wrap">
      <video id="video" playsinline muted></video>
      <div id="frame" class="frame"></div>
    </div>
    <div class="controls">
      <button id="startBtn" class="btn-primary">Start</button>
      <button id="stopBtn">Stop</button>
      <button id="torchBtn">Flaş</button>
      <button id="clearBtn" class="btn-danger">Temizle</button>
      <button id="addIssueBtn" class="btn-info" title="Son koda sorun ekle">+ Sorun</button>
    </div>
    <div class="controls">
      <input id="manual" type="text" placeholder="Kod gir (yapıştır)..." style="flex:1;min-width:160px">
      <button id="manualBtn" class="btn-warn">Manuel Ekle</button>
    </div>
  </div>

  <div class="grid">
    <!-- Normal Liste -->
    <div class="card">
      <div class="list-header">
        <div><strong>Normal Liste</strong> · <span id="count">0</span></div>
        <div class="act">
          <button id="copyList">Kopyala</button>
          <button id="waList">WhatsApp</button>
        </div>
      </div>
      <ul id="list" class="list"></ul>
    </div>

    <!-- SORUNLAR -->
    <div class="card">
      <div class="list-header">
        <div><strong>SORUNLAR</strong> · <span id="countIssues">0</span></div>
        <div class="act">
          <select id="issueFilter">
            <option value="_all_">Tümü</option>
          </select>
          <button id="copyIssues">Kopyala</button>
          <button id="waIssues">WhatsApp</button>
          <button id="clearIssues" class="btn-danger">Temizle</button>
        </div>
      </div>
      <ul id="issues" class="list"></ul>
    </div>
  </div>
</div>

<div class="toolbar">
  <button id="copyAll" class="btn">Normal Listeyi Kopyala</button>
  <button id="waAll" class="btn">Normal Listeyi WhatsApp</button>
</div>

<canvas id="capture"></canvas>
<div id="toast" class="toast"></div>

<!-- Modal: Sorun var mı? -->
<div id="askModal" class="modal" role="dialog" aria-modal="true">
  <div class="box">
    <h3>Bu scooter'ın sorunu var mı?</h3>
    <p>Okunan kod: <strong id="askCode">—</strong></p>
    <div class="row" style="margin-top:6px">
      <button id="askYes" class="btn-primary">Evet</button>
      <button id="askNo">Hayır</button>
    </div>
  </div>
</div>

<!-- Modal: Sorun seç -->
<div id="pickModal" class="modal" role="dialog" aria-modal="true">
  <div class="box">
    <h3>Sorunları seç</h3>
    <p>Kod: <strong id="pickCode">—</strong></p>
    <div id="optGrid" class="opt-grid"></div>
    <input id="note" type="text" placeholder="Not / açıklama (opsiyonel)">
    <div class="row" style="margin-top:6px">
      <button id="pickSave" class="btn-primary">Kaydet</button>
      <button id="pickCancel">İptal</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
/* ====== Kısa yardımcılar ====== */
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);
const toast = msg => { const el=byId('toast'); el.textContent=msg; el.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>el.style.display='none',1400); };
const last4 = s => String(s).replace(/[^0-9a-z]/gi,'').slice(-4).toUpperCase();
const beep = (f=880)=>{ try{const ac=new (window.AudioContext||window.webkitAudioContext)(); const o=ac.createOscillator(); const g=ac.createGain(); o.type='triangle'; o.frequency.value=f; o.connect(g); g.connect(ac.destination); g.gain.setValueAtTime(0.001,ac.currentTime); g.gain.exponentialRampToValueAtTime(0.2,ac.currentTime+0.02); g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+0.15); o.start(); o.stop(ac.currentTime+0.16); setTimeout(()=>ac.close(),300);}catch{} };
const showBanner=(v,dup)=>{ const b=byId('lastBanner'); byId('lastVal').textContent=v||'—'; b.style.display='block'; b.classList.toggle('dup',!!dup); };
const glow=(ok)=>{ const f=byId('frame'); f.classList.remove('glow-green','glow-red'); void f.offsetWidth; f.classList.add(ok?'glow-green':'glow-red'); clearTimeout(f._t); f._t=setTimeout(()=>f.classList.remove('glow-green','glow-red'),350); };

/* ====== Problem seçenekleri ====== */
const PROBLEMS = [
  "IoT yok",
  "IoT ve kilit yok",
  "Kilit yok",
  "Ön tekerlek değişecek",
  "Arka tekerlek değişecek",
  "Fren yok",
  "Fren kampana değişecek",
  "Ön dikme sallanıyor (tundet timoni)",
  "Etiketler yok",
  "Çamurluk değişecek (ön)",
  "Çamurluk değişecek (arka)"
];

/* ====== Durum ====== */
let items = [];       // {code, time}
let issues = [];      // {code, problems:[...], note, time}
let seen = new Set(); // hızlı kontrol
let scanning=false, stream=null, track=null, torch=false, lastScanAt=0, pendingCode=null;

/* ====== DOM ====== */
const video=byId('video'), canvas=byId('capture'), ctx=canvas.getContext('2d',{willReadFrequently:true});
const camStatus=byId('camStatus'), frame=byId('frame');
const listEl=byId('list'), countEl=byId('count');
const issuesEl=byId('issues'), countIssuesEl=byId('countIssues'), filterEl=byId('issueFilter');

function saveAll(){
  localStorage.setItem('qr_items_v1', JSON.stringify(items));
  localStorage.setItem('qr_issues_v1', JSON.stringify(issues));
}
function loadAll(){
  try{
    items = JSON.parse(localStorage.getItem('qr_items_v1')||'[]');
    issues = JSON.parse(localStorage.getItem('qr_issues_v1')||'[]');
    seen.clear(); items.forEach(x=>seen.add(x.code));
  }catch{}
  renderLists();
}

/* ====== Render ====== */
function renderLists(){
  // normal liste
  listEl.innerHTML = items.map((x,i)=>`
    <li class="item">
      <div class="idx">${i+1}</div>
      <div style="flex:1">
        <div class="val">${x.code}</div>
        <div class="sub">${new Date(x.time).toLocaleTimeString()}</div>
      </div>
      <div class="act">
        <button title="Sorun ekle" onclick="openPickModal('${x.code}')">+</button>
        <button title="Sil" onclick="delItem(${i})">×</button>
      </div>
    </li>`).join('');
  countEl.textContent = items.length;

  // filtre doldur (bir kez + eksik olanı ekle)
  const have = new Set([...filterEl.options].map(o=>o.value));
  PROBLEMS.forEach(p=>{ if(!have.has(p)){ const o=document.createElement('option'); o.value=p; o.textContent=p; filterEl.appendChild(o);} });

  // sorunlar
  const f = filterEl.value || '_all_';
  const arr = f==='_all_' ? issues : issues.filter(it => (it.problems||[]).includes(f));
  issuesEl.innerHTML = arr.map((x,i)=>`
    <li class="item">
      <div class="idx">${i+1}</div>
      <div style="flex:1">
        <div class="val">${x.code}</div>
        <div class="chips">${(x.problems||[]).map(p=><span class="chip">${p}</span>).join('') || '<span class="chip">—</span>'}</div>
        ${x.note ? <div class="note">Not: ${escapeHtml(x.note)}</div>:''}
        <div class="sub">${new Date(x.time).toLocaleTimeString()}</div>
      </div>
      <div class="act">
        <button title="Düzenle" onclick="openPickModal('${x.code}')">✎</button>
        <button title="Sil" onclick="delIssue('${x.code}')">×</button>
      </div>
    </li>`).join('');
  countIssuesEl.textContent = issues.length;
}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

/* ====== Liste işlemleri ====== */
function delItem(i){
  const code = items[i].code;
  items.splice(i,1);
  if(!items.some(x=>x.code===code)) seen.delete(code);
  saveAll(); renderLists();
}
function delIssue(code){
  const i = issues.findIndex(x=>x.code===code);
  if(i>-1){ issues.splice(i,1); saveAll(); renderLists(); }
}

/* ====== Ekleme akışı ====== */
function pushCode(code){
  const dup = seen.has(code);
  if(!dup){
    items.push({code, time:Date.now()});
    seen.add(code);
    saveAll();
    beep(880);
  }else{
    beep(440);
  }
  showBanner(code, dup);
  glow(!dup);
  renderLists();
  openAskModal(code); // her eklemeden sonra sor
}

/* ====== Kamera ====== */
async function startCam(){
  try{
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      alert('Tarayıcı kamera API desteklemiyor.');return;
    }
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}}});
    video.srcObject = stream; await video.play();
    scanning=true; camStatus.textContent='Kamera: Açık';
    track = stream.getVideoTracks()[0]||null;
    // torch buton durumu
    const caps = track && track.getCapabilities ? track.getCapabilities() : {};
    byId('torchBtn').disabled = !(caps && 'torch' in caps);
    scanLoop();
  }catch(e){
    alert('Kamera açılamadı: '+(e.message||e.name)+'\n\n• HTTPS altında açın\n• Site için Kamera izni verin');
  }
}
function stopCam(){
  scanning=false;
  if(stream){ stream.getTracks().forEach(t=>t.stop()); }
  video.srcObject=null; track=null; torch=false;
  byId('torchBtn').disabled=true;
  camStatus.textContent='Kamera: Kapalı';
}
async function toggleTorch(){
  if(!track || !track.applyConstraints){ toast('Flaş desteklenmiyor'); return; }
  const caps = track.getCapabilities ? track.getCapabilities() : {};
  if(!caps.torch){ toast('Flaş desteklenmiyor'); return; }
  try{
    torch=!torch; await track.applyConstraints({advanced:[{torch}]});
    toast(torch?'Flaş: Açık':'Flaş: Kapalı');
  }catch(e){ torch=false; toast('Flaş hatası'); }
}
async function scanLoop(){
  if(!scanning) return;
  const now = performance.now();
  if(now - lastScanAt < 140){ return requestAnimationFrame(scanLoop); }
  lastScanAt = now;
  if(video.readyState >= 2){
    if(typeof jsQR !== 'function'){ toast('jsQR yüklenemedi'); return; }
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
    const qr = jsQR(img.data, canvas.width, canvas.height, {inversionAttempts:'dontInvert'});
    if(qr && qr.data){
      const code = last4(qr.data);
      if(code){ pushCode(code); }
    }
  }
  requestAnimationFrame(scanLoop);
}

/* ====== Modallar: Sor ve Seç ====== */
function openAskModal(code){ pendingCode=code; byId('askCode').textContent=code; byId('askModal').style.display='flex'; }
function closeAskModal(){ byId('askModal').style.display='none'; }
function openPickModal(code){
  pendingCode=code; byId('pickCode').textContent=code;
  const g = byId('optGrid'); g.innerHTML='';
  PROBLEMS.forEach((p,i)=>{
    const lab=document.createElement('label'); lab.className='opt';
    lab.innerHTML=<input type="checkbox" value="${p}"> <div>${p}</div>;
    g.appendChild(lab);
  });
  byId('note').value='';
  byId('pickModal').style.display='flex';
}
function closePickModal(){ byId('pickModal').style.display='none'; }

byId('askYes').onclick=()=>{ closeAskModal(); openPickModal(pendingCode); };
byId('askNo').onclick =()=>{ closeAskModal(); };

byId('pickSave').onclick=()=>{
  const sel=[...byId('optGrid').querySelectorAll('input[type="checkbox"]:checked')].map(x=>x.value);
  const note=byId('note').value.trim();
  // merge
  const i = issues.findIndex(x=>x.code===pendingCode);
  if(i>-1){
    const s=new Set(issues[i].problems||[]); sel.forEach(v=>s.add(v));
    issues[i].problems=[...s];
    if(note) issues[i].note = issues[i].note ? (issues[i].note+' | '+note) : note;
    issues[i].time = Date.now();
  }else{
    issues.push({code:pendingCode, problems:[...sel], note, time:Date.now()});
  }
  saveAll(); renderLists(); closePickModal(); beep(920);
};
byId('pickCancel').onclick=closePickModal;

/* ====== Paylaşım / Kopya ====== */
function buildListText(){ return items.map((x,i)=>${i+1}. ${x.code}).join('\n'); }
function buildIssuesText(){
  return issues.map((x,i)=>${i+1}. ${x.code} — ${(x.problems||[]).join(', ')}${x.note? (not: ${x.note}):''}).join('\n');
}
byId('copyList').onclick =()=>{ const t=buildListText(); if(!t){toast('—');return;} navigator.clipboard.writeText(t).then(()=>toast('Kopyalandı')); };
byId('waList').onclick    =()=>{ const t=buildListText(); if(!t){toast('—');return;} window.open('https://wa.me/?text='+encodeURIComponent(t),'_blank'); };
byId('copyIssues').onclick=()=>{ const t=buildIssuesText(); if(!t){toast('—');return;} navigator.clipboard.writeText(t).then(()=>toast('Kopyalandı')); };
byId('waIssues').onclick  =()=>{ const t=buildIssuesText(); if(!t){toast('—');return;} window.open('https://wa.me/?text='+encodeURIComponent(t),'_blank'); };

byId('copyAll').onclick=byId('copyList').onclick;
byId('waAll').onclick  =byId('waList').onclick;

byId('clearBtn').onclick =()=>{ if(confirm('Normal liste temizlensin mi?')){ items=[]; seen.clear(); saveAll(); renderLists(); } };
byId('clearIssues').onclick=()=>{ if(confirm('SORUNLAR listesi temizlensin mi?')){ issues=[]; saveAll(); renderLists(); } };
filterEl.onchange = renderLists;

/* ====== Manuel ekleme ====== */
byId('manualBtn').onclick=()=>{
  const v = last4(byId('manual').value.trim());
  if(!v){ toast('Kod yok'); return; }
  pushCode(v); byId('manual').value='';
};
byId('manual').addEventListener('keyup',e=>{ if(e.key==='Enter') byId('manualBtn').click(); });

/* ====== Başlat/Durdur/Flaş ====== */
byId('startBtn').onclick=startCam;
byId('stopBtn').onclick =stopCam;
byId('torchBtn').onclick=toggleTorch;

/* ====== İlk yük ====== */
loadAll();
camStatus.textContent='Kamera: Kapalı';
</script>
</body>
</html>
