<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Lista QR Â· 4 Shifrat e Fundit</title>
<style>
  :root{
    --bg:#0f1115;
    --card:#171a21;
    --muted:#a9b1c3;
    --text:#e7ebf5;
    --accent:#29c06f;
    --danger:#ff5d5d;
    --warn:#ffc53d;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
  }
  header{
    position:sticky; top:0; z-index:30;
    background:linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,0));
    padding:10px 16px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .flags{display:flex; gap:8px;}
  .flags button{background:none;border:none;font-size:20px;cursor:pointer}
  .app-title{font-size:16px;font-weight:700}
  .pill{padding:4px 10px;border-radius:999px;background:#1f2430;color:#a9b1c3;font-size:12px;}
  .last-scan{
    position:sticky; top:46px; z-index:25;
    display:flex; align-items:center; gap:8px;
    background:#122019; color:#bff4d1;
    border:1px solid #1b3a2b; border-left:4px solid var(--accent);
    margin:6px 12px; border-radius:10px; padding:8px 12px;
    font-size:14px;
  }
  .last-scan.duplicate{background:#2b1515;color:#f8c6c6;border-color:var(--danger)}
  .container{padding:10px 16px 120px 16px; max-width:840px; margin:0 auto;}
  .camera-card{background:var(--card);border-radius:14px;padding:12px;}
  .video-wrap{position:relative;border-radius:12px;overflow:hidden;background:#0a0c10;aspect-ratio:3/4;}
  video{width:100%;height:100%;object-fit:cover;display:block;}
  canvas#capture{display:none;}
  .scan-frame{position:absolute;inset:10%;border:2px solid rgba(255,255,255,.55);border-radius:12px;pointer-events:none;transition: box-shadow .12s, border-color .12s;}
  .glow-green{ box-shadow: 0 0 0 9999px rgba(0,128,0,.18) inset, 0 0 22px rgba(0,255,144,.75) inset; border-color: rgba(0,255,144,.95); }
  .glow-red{ box-shadow: 0 0 0 9999px rgba(255,0,0,.18) inset, 0 0 22px rgba(255,80,80,.9) inset; border-color: rgba(255,90,90,.95); }
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
  button,.btn{appearance:none;border:none;border-radius:12px;background:#222734;color:var(--text);padding:10px 14px;font-size:14px;font-weight:600;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .btn-primary{background:var(--accent);color:#07130e}
  .btn-danger{background:var(--danger);color:#260000}
  .btn-warn{background:var(--warn);color:#221a00}
  .tabs{display:flex; gap:8px; margin:14px 0 0 0;}
  .tab{padding:8px 12px; border-radius:999px; background:#1f2430; color:#a9b1c3; font-size:13px; cursor:pointer}
  .tab.active{background:var(--accent); color:#07130e; font-weight:700}
  .list-card{margin-top:12px;background:var(--card);border-radius:14px;padding:8px 0;}
  .list-header{display:flex;justify-content:space-between;align-items:center;padding:8px 14px;border-bottom:1px solid #242a39;gap:8px;flex-wrap:wrap}
  .list-actions{display:flex; gap:6px; flex-wrap:wrap}
  .list{list-style:none;padding:0;margin:0;}
  .item{display:flex;gap:10px;align-items:flex-start;padding:12px 14px;border-bottom:1px dashed #23293a;}
  .item:last-child{border-bottom:none}
  .index{width:28px;height:28px;border-radius:999px;background:#242a39;display:flex;align-items:center;justify-content:center;font-weight:700;color:#c0c7d9;flex:0 0 auto;}
  .value{flex:1;font-size:18px;font-weight:700;letter-spacing:.5px}
  .meta{flex:2;color:#a9b1c3;font-size:13px}
  .time{color:#a9b1c3;font-size:12px;margin-top:4px}
  .del-btn{background:#23293a;color:#ff9b9b;border-radius:10px;padding:4px 8px}
  .toolbar{position:fixed;left:0;right:0;bottom:0;z-index:20;backdrop-filter:blur(10px);background:rgba(10,12,16,.8);border-top:1px solid #242a39;padding:10px 16px;display:flex;gap:10px;}
  .toolbar .btn{flex:1;justify-content:center}
  .toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#161d2a;color:#e7f1ff;padding:8px 12px;border-radius:10px;border:1px solid #27324a;display:none;}
  .manual{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;}
  .manual input{flex:1; min-width:160px; background:#1b2030; border:1px solid #2a3246; color:var(--text); padding:10px 12px; border-radius:10px; font-size:14px;}
  /* Modal */
  .modal-back{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:flex-end; justify-content:center; z-index:40}
  .modal{background:var(--card); width:100%; max-width:720px; border-radius:16px 16px 0 0; padding:14px;}
  .modal h3{margin:6px 0 10px 0; font-size:16px}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin:10px 0}
  .chk{display:flex; gap:8px; align-items:center; background:#1b2030; border:1px solid #2a3246; padding:8px 10px; border-radius:10px; font-size:13px;}
  .modal textarea{width:100%; min-height:70px; background:#121828; border:1px solid #2a3246; color:var(--text); border-radius:10px; padding:8px 10px; font-size:13px}
  .modal .row{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
  .hidden{display:none !important}
</style>
</head>
<body>
<header>
  <div><span class="app-title" id="t-title">Lista QR</span> <span id="camStatus" class="pill">Kamera: Mbyllur</span></div>
  <div class="flags">
    <button onclick="setLang('sq')" title="Shqip">ðŸ‡¦ðŸ‡±</button>
    <button onclick="setLang('en')" title="English">ðŸ‡¬ðŸ‡§</button>
    <button onclick="setLang('tr')" title="TÃ¼rkÃ§e">ðŸ‡¹ðŸ‡·</button>
  </div>
</header>

<div id="lastBanner" class="last-scan" style="display:none;">
  <strong id="t-last">I fundit:</strong> <span id="lastValue">â€”</span>
</div>

<div class="container">
  <div class="camera-card">
    <div class="video-wrap">
      <video id="video" playsinline muted></video>
      <div id="scanFrame" class="scan-frame"></div>
    </div>
    <div class="controls">
      <button id="startBtn" class="btn-primary">Start</button>
      <button id="stopBtn" class="btn">Stop</button>
      <button id="torchBtn" class="btn">FlaÅŸ</button>
      <button id="resetBtn" class="btn-danger">Pastro</button>
    </div>
    <div class="manual">
      <input id="manualInput" type="text" maxlength="64" placeholder="Shkruaj kodin...">
      <button id="manualAddBtn" class="btn-warn">Shto</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button id="tabNormal" class="tab active">Normal</button>
    <button id="tabIssues" class="tab">SORUNLAR</button>
  </div>

  <!-- Normal list -->
  <div id="cardNormal" class="list-card">
    <div class="list-header">
      <div><strong id="t-list">Lista</strong> Â· <span id="count">0</span></div>
      <div class="list-actions">
        <button id="copyBtn" class="btn">Kopjo</button>
        <button id="waBtn" class="btn">WhatsApp</button>
      </div>
    </div>
    <ul id="list" class="list"></ul>
  </div>

  <!-- Issues list -->
  <div id="cardIssues" class="list-card hidden">
    <div class="list-header">
      <div><strong id="t-issues">SORUNLAR</strong> Â· <span id="issuesCount">0</span></div>
      <div class="list-actions">
        <button id="copyIssuesBtn" class="btn">Kopjo</button>
        <button id="waIssuesBtn" class="btn">WhatsApp</button>
      </div>
    </div>
    <ul id="issuesList" class="list"></ul>
  </div>
</div>

<div class="toolbar">
  <button id="copyBtnBottom" class="btn">Kopjo</button>
  <button id="waBtnBottom" class="btn">WhatsApp</button>
</div>

<!-- Modal -->
<div id="modalBack" class="modal-back">
  <div class="modal">
    <h3 id="m-title">Scooter: Sorun var mÄ±?</h3>
    <div id="m-step1">
      <div class="row">
        <button id="m-noIssue" class="btn">Sorun yok (Sadece ekle)</button>
        <button id="m-hasIssue" class="btn-warn">Evet, sorun ekle</button>
        <button id="m-cancel" class="btn-danger">VazgeÃ§</button>
      </div>
    </div>
    <div id="m-step2" class="hidden">
      <div id="m-help" style="font-size:13px;color:#a9b1c3;margin-bottom:6px">Birden fazla sorun seÃ§ebilirsin, istersen not yaz.</div>
      <div id="m-grid" class="grid"></div>
      <textarea id="m-note" placeholder="Not / aÃ§Ä±klama (opsiyonel)"></textarea>
      <div class="row">
        <button id="m-back" class="btn">Geri</button>
        <button id="m-saveIssue" class="btn-primary">Kaydet (Sorunlu)</button>
      </div>
    </div>
  </div>
</div>

<canvas id="capture"></canvas>
<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
const $=sel=>document.querySelector(sel);
const video=$('#video'),canvas=$('#capture'),ctx=canvas.getContext('2d',{willReadFrequently:true});
const startBtn=$('#startBtn'),stopBtn=$('#stopBtn'),torchBtn=$('#torchBtn'),resetBtn=$('#resetBtn');
const manualInput=$('#manualInput'),manualAddBtn=$('#manualAddBtn');
const listEl=$('#list'),countEl=$('#count'),lastBanner=$('#lastBanner'),lastValue=$('#lastValue'),scanFrame=$('#scanFrame');
const copyBtn=$('#copyBtn'),waBtn=$('#waBtn'),camStatus=$('#camStatus'),toastEl=$('#toast');
const copyBtnBottom=$('#copyBtnBottom'),waBtnBottom=$('#waBtnBottom');
const tabNormal=$('#tabNormal'),tabIssues=$('#tabIssues'),cardNormal=$('#cardNormal'),cardIssues=$('#cardIssues');
const issuesListEl=$('#issuesList'),issuesCountEl=$('#issuesCount');
const copyIssuesBtn=$('#copyIssuesBtn'),waIssuesBtn=$('#waIssuesBtn');

let stream=null,track=null,scanning=false,lastScanAt=0,items=[],torchOn=false;
let seen=new Set(); // track by displayed last4

// NEW: issues store
let issues=[]; // {value, time, problems:[...], note:''}
let pendingValue=null; // holds last code while modal flow

const langs={
 sq:{title:"Lista QR",camOn:"Kamera: Hap",camOff:"Kamera: Mbyllur",list:"Lista",last:"I fundit:",copied:"Kopjuar!",start:"Start",stop:"Stop",clear:"Pastro",copy:"Kopjo",flash:"DritÃ«",placeholder:"Shkruaj kodin...",add:"Shto",confirmDel:"A jeni i sigurt pÃ«r fshirjen?", confirmClear:"TÃ« pastrohet lista?",
     issues:"SORUNLAR", m_title:"Skuter: A ka problem?", m_noIssue:"Pa problem (Shto)", m_hasIssue:"Po, zgjidh problem", m_cancel:"Anulo", m_help:"Mund tÃ« zgjedhÃ«sh disa probleme; shkruaj edhe shÃ«nim nÃ«se do", m_back:"Kthehu", m_save:"Ruaj (Me problem)"},
 en:{title:"QR List",camOn:"Camera: On",camOff:"Camera: Off",list:"List",last:"Last:",copied:"Copied!",start:"Start",stop:"Stop",clear:"Clear",copy:"Copy",flash:"Flash",placeholder:"Type a code...",add:"Add",confirmDel:"Are you sure to delete?", confirmClear:"Clear the whole list?",
     issues:"ISSUES", m_title:"Scooter: Any issues?", m_noIssue:"No issue (Just add)", m_hasIssue:"Yes, add issues", m_cancel:"Cancel", m_help:"You can pick multiple issues and add a note", m_back:"Back", m_save:"Save (With issues)"},
 tr:{title:"QR Liste",camOn:"Kamera: AÃ§Ä±k",camOff:"Kamera: KapalÄ±",list:"Liste",last:"Son:",copied:"KopyalandÄ±!",start:"BaÅŸlat",stop:"Durdur",clear:"Temizle",copy:"Kopyala",flash:"FlaÅŸ",placeholder:"Kod yaz...",add:"Ekle",confirmDel:"Silmek istediÄŸine emin misin?", confirmClear:"Liste tamamen temizlensin mi?",
     issues:"SORUNLAR", m_title:"Scooter: Sorun var mÄ±?", m_noIssue:"Sorun yok (Sadece ekle)", m_hasIssue:"Evet, sorun ekle", m_cancel:"VazgeÃ§", m_help:"Birden fazla sorun seÃ§ebilirsin; istersen not yaz", m_back:"Geri", m_save:"Kaydet (Sorunlu)"}
};
let curLang="sq";

// PRESET problem options (tam listedeki metinlerle)
const PROBLEM_OPTIONS=[
  "Iot yok",
  "Iot ve kilit yok",
  "Kilit yok",
  "Tekerlek deÄŸiÅŸecek",
  "Fren yok",
  "Fren kampana deÄŸiÅŸecek",
  "Ã–n Dikme sallanÄ±yor (tundet timoni)",
  "Etiketler yok",
  "Ã‡amurluk deÄŸiÅŸecek Ã¶n veya arka"
];

function setLang(l){
  curLang=l;
  $('#t-title').textContent=langs[l].title;
  $('#t-list').textContent=langs[l].list;
  $('#t-last').textContent=langs[l].last;
  $('#t-issues').textContent=langs[l].issues;
  camStatus.textContent=scanning?langs[l].camOn:langs[l].camOff;
  startBtn.textContent=langs[l].start;
  stopBtn.textContent=langs[l].stop;
  resetBtn.textContent=langs[l].clear;
  copyBtn.textContent=langs[l].copy;
  copyBtnBottom.textContent=langs[l].copy;
  torchBtn.textContent=langs[l].flash;
  manualInput.placeholder=langs[l].placeholder;
  manualAddBtn.textContent=langs[l].add;
  waBtn.textContent="WhatsApp";
  waBtnBottom.textContent="WhatsApp";
  copyIssuesBtn.textContent=langs[l].copy;
  waIssuesBtn.textContent="WhatsApp";
  // Modal texts
  $('#m-title').textContent=langs[l].m_title;
  $('#m-noIssue').textContent=langs[l].m_noIssue;
  $('#m-hasIssue').textContent=langs[l].m_hasIssue;
  $('#m-cancel').textContent=langs[l].m_cancel;
  $('#m-help').textContent=langs[l].m_help;
  $('#m-back').textContent=langs[l].m_back;
  $('#m-saveIssue').textContent=langs[l].m_save;
}
window.setLang=setLang;

function last4(s){const only=String(s).replace(/[^0-9A-Za-z]/g,'');return only.slice(-4).toUpperCase();}
function beep(freq=880){try{const ac=new (window.AudioContext||window.webkitAudioContext)();const o=ac.createOscillator();const g=ac.createGain();o.type='triangle';o.frequency.value=freq;o.connect(g);g.connect(ac.destination);g.gain.setValueAtTime(0.001,ac.currentTime);g.gain.exponentialRampToValueAtTime(0.2,ac.currentTime+0.02);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+0.15);o.start();o.stop(ac.currentTime+0.16);setTimeout(()=>ac.close(),250);}catch{}}
function showBanner(val,isDup){lastValue.textContent=val||'â€”';lastBanner.style.display='flex';lastBanner.classList.toggle('duplicate', !!isDup);}
function flashOverlay(isDup){scanFrame.classList.remove('glow-green','glow-red');scanFrame.offsetWidth;scanFrame.classList.add(isDup?'glow-red':'glow-green');clearTimeout(scanFrame._t);scanFrame._t=setTimeout(()=>scanFrame.classList.remove('glow-green','glow-red'), 350);}

function pushNormal(value){ // adds to main list only
  const isDup = seen.has(value);
  if(!isDup){
    seen.add(value);
    items.push({value, time:new Date()});
    renderList(); save(); beep(880);
  }else{
    beep(440);
  }
  showBanner(value, isDup);
  flashOverlay(isDup);
}

// === NEW: modal flow ===
const modalBack=$('#modalBack');
const mStep1=$('#m-step1'),mStep2=$('#m-step2');
const mNoIssue=$('#m-noIssue'),mHasIssue=$('#m-hasIssue'),mCancel=$('#m-cancel'),mBack=$('#m-back'),mSaveIssue=$('#m-saveIssue');
const mGrid=$('#m-grid'),mNote=$('#m-note');

function openModalFor(value){
  pendingValue=value;
  // build checkboxes each time to reflect default unchecked
  mGrid.innerHTML='';
  PROBLEM_OPTIONS.forEach((txt,i)=>{
    const id='opt_'+i;
    const div=document.createElement('label');
    div.className='chk';
    div.innerHTML=<input id="${id}" type="checkbox"> <span>${txt}</span>;
    mGrid.appendChild(div);
  });
  mNote.value='';
  mStep1.classList.remove('hidden');
  mStep2.classList.add('hidden');
  modalBack.style.display='flex';
}
function closeModal(){ modalBack.style.display='none'; pendingValue=null; }

mNoIssue.onclick=()=>{ if(pendingValue){ pushNormal(pendingValue); } closeModal(); }
mHasIssue.onclick=()=>{ mStep1.classList.add('hidden'); mStep2.classList.remove('hidden'); }
mBack.onclick=()=>{ mStep2.classList.add('hidden'); mStep1.classList.remove('hidden'); }
mCancel.onclick=()=> closeModal();
mSaveIssue.onclick=()=>{
  if(!pendingValue){ return; }
  const chosen=[...mGrid.querySelectorAll('input[type="checkbox"]:checked')].map((inp,i)=>inp.parentElement.querySelector('span').textContent);
  const note=mNote.value.trim();
  // even if empty chosen, treat as issue record (user manuel not yazabilir)
  issues.push({value:pendingValue, time:new Date(), problems:chosen, note});
  // her iki durumda da Normal listeye de sayÄ±m olarak ekleyelim:
  pushNormal(pendingValue);
  renderIssues(); save();
  closeModal();
}

// === integration points: when a code comes ===
function addFromScan(raw){ const val=last4(raw); if(!val){return;} openModalFor(val); }
function addFromManual(){ const raw=manualInput.value.trim(); const val=last4(raw); if(!val){ showToast('â€”'); return; } openModalFor(val); manualInput.value=''; }

// === renderers ===
function renderList(){
  listEl.innerHTML='';
  items.forEach((it,idx)=>{
    const li=document.createElement('li');
    li.className='item';
    li.innerHTML=`
      <div class="index">${idx+1}</div>
      <div class="value">${it.value}</div>
      <div class="time">${new Date(it.time).toLocaleTimeString()}</div>
      <button class="del-btn">Ã—</button>`;
    li.querySelector('.del-btn').onclick=()=>{
      if(confirm(langs[curLang].confirmDel)){
        const val=items[idx].value;
        items.splice(idx,1);
        if(!items.some(x=>x.value===val)) seen.delete(val);
        renderList(); save();
      }
    };
    listEl.appendChild(li);
  });
  countEl.textContent=items.length;
}

function renderIssues(){
  issuesListEl.innerHTML='';
  issues.forEach((it,idx)=>{
    const li=document.createElement('li');
    li.className='item';
    const problemsText = (it.problems && it.problems.length) ? it.problems.join(', ') : 'â€”';
    const noteText = it.note ? ` (${it.note})` : '';
    li.innerHTML=`
      <div class="index">${idx+1}</div>
      <div class="value">${it.value}</div>
      <div class="meta">${problemsText}${noteText}</div>
      <div class="time">${new Date(it.time).toLocaleTimeString()}</div>
      <button class="del-btn">Ã—</button>`;
    li.querySelector('.del-btn').onclick=()=>{
      if(confirm(langs[curLang].confirmDel)){
        issues.splice(idx,1);
        renderIssues(); save();
      }
    };
    issuesListEl.appendChild(li);
  });
  issuesCountEl.textContent=issues.length;
}

// === camera & scan loop (aynÄ±) ===
async function startCam(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject=stream;
    await video.play();
    scanning=true;
    camStatus.textContent=langs[curLang].camOn;
    track=stream.getVideoTracks()[0]||null;
    torchOn=false;
    const caps=track && track.getCapabilities ? track.getCapabilities() : {};
    torchBtn.disabled = !(caps && 'torch' in caps);
    scanLoop();
  }catch(e){ alert(e.message||e.name); }
}
function stopCam(){
  scanning=false;
  if(stream){ stream.getTracks().forEach(t=>t.stop()); }
  video.srcObject=null;
  track=null; torchOn=false;
  torchBtn.disabled=true;
  camStatus.textContent=langs[curLang].camOff;
}

async function toggleTorch(){
  if(!track || !track.applyConstraints){ showToast('No torch'); return; }
  const caps=track.getCapabilities ? track.getCapabilities() : {};
  if(!caps.torch){ showToast('Torch not supported'); return; }
  try{
    torchOn=!torchOn;
    await track.applyConstraints({ advanced:[{ torch: torchOn }] });
    showToast(torchOn ? (curLang==='tr'?'FlaÅŸ: AÃ§Ä±k':curLang==='en'?'Flash: On':'Drita: On') : (curLang==='tr'?'FlaÅŸ: KapalÄ±':curLang==='en'?'Flash: Off':'Drita: Off'));
  }catch(e){
    torchOn=false;
    showToast('Torch error');
  }
}

async function scanLoop(){
  if(!scanning) return;
  const now=performance.now();
  if(now-lastScanAt<140){ return requestAnimationFrame(scanLoop); }
  lastScanAt=now;
  if(video.readyState>=2){
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const img=ctx.getImageData(0,0,canvas.width,canvas.height);
    const qr=jsQR(img.data,canvas.width,canvas.height,{inversionAttempts:'dontInvert'});
    if(qr && qr.data){ addFromScan(qr.data.trim()); }
  }
  requestAnimationFrame(scanLoop);
}

// === copy/share ===
function copyAll(){const t=items.map((x,i)=>${i+1}. ${x.value}).join("\n");if(!t){ showToast('â€”'); return; }navigator.clipboard.writeText(t).then(()=>showToast(langs[curLang].copied));}
function whatsapp(){const t=items.map((x,i)=>${i+1}. ${x.value}).join("\n");if(!t){ showToast('â€”'); return; }window.open("https://wa.me/?text="+encodeURIComponent(t),'_blank');}

function copyIssues(){const t=issues.map((x,i)=>${i+1}. ${x.value} - ${(x.problems&&x.problems.length)?x.problems.join(', '):'â€”'}${x.note?(' ('+x.note+')'):''}).join("\n");if(!t){ showToast('â€”'); return; }navigator.clipboard.writeText(t).then(()=>showToast(langs[curLang].copied));}
function whatsappIssues(){const t=issues.map((x,i)=>${i+1}. ${x.value} - ${(x.problems&&x.problems.length)?x.problems.join(', '):'â€”'}${x.note?(' ('+x.note+')'):''}).join("\n");if(!t){ showToast('â€”'); return; }window.open("https://wa.me/?text="+encodeURIComponent(t),'_blank');}

// === storage ===
function save(){
  localStorage.setItem("qrItems_v3", JSON.stringify(items.map(o=>({value:o.value,time:o.time||new Date()}))));
  localStorage.setItem("qrIssues_v1", JSON.stringify(issues.map(o=>({value:o.value,time:o.time||new Date(),problems:o.problems||[],note:o.note||''}))));
}
function load(){
  const raw=localStorage.getItem("qrItems_v3");
  if(raw){try{const arr=JSON.parse(raw)||[];items=arr.map(o=>({value:o.value,time:new Date(o.time)}));items.forEach(x=>seen.add(x.value));renderList();}catch{}}
  const rawI=localStorage.getItem("qrIssues_v1");
  if(rawI){try{const arr=JSON.parse(rawI)||[];issues=arr.map(o=>({value:o.value,time:new Date(o.time),problems:o.problems||[],note:o.note||''}));renderIssues();}catch{}}
}
function showToast(m){toastEl.textContent=m;toastEl.style.display='block';setTimeout(()=>toastEl.style.display='none',1400);}

// events
startBtn.onclick=startCam;
stopBtn.onclick=stopCam;
torchBtn.onclick=toggleTorch;
resetBtn.onclick=()=>{
  if(confirm(langs[curLang].confirmClear)){
    items=[]; issues=[]; seen.clear(); renderList(); renderIssues(); save();
  }
};
manualAddBtn.onclick=addFromManual;
manualInput.addEventListener('keyup',e=>{ if(e.key==='Enter') addFromManual(); });

copyBtn.onclick=copyAll; waBtn.onclick=whatsapp;
copyBtnBottom.onclick=()=>{ // alt Ã§ubuk: aktif sekmeye gÃ¶re kopyala
  if(!cardIssues.classList.contains('hidden')) copyIssues(); else copyAll();
};
waBtnBottom.onclick=()=>{ if(!cardIssues.classList.contains('hidden')) whatsappIssues(); else whatsapp(); }

copyIssuesBtn.onclick=copyIssues; waIssuesBtn.onclick=whatsappIssues;

// tabs
tabNormal.onclick=()=>{ tabNormal.classList.add('active'); tabIssues.classList.remove('active'); cardNormal.classList.remove('hidden'); cardIssues.classList.add('hidden'); }
tabIssues.onclick=()=>{ tabIssues.classList.add('active'); tabNormal.classList.remove('active'); cardIssues.classList.remove('hidden'); cardNormal.classList.add('hidden'); }

// init
load();
setLang('sq');
if (navigator.permissions && navigator.permissions.query){
  navigator.permissions.query({name:'camera'}).then(p=>{ if(p.state==='granted'){ startCam(); } }).catch(()=>{});
}
</script>
</body>
</html>
