<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Regjistri i Biçikletave · Single File (BarcodeDetector/jsQR)</title>
<style>
  :root{ --bg:#0f1115; --card:#171a21; --muted:#a9b1c3; --text:#e7ebf5;
         --accent:#2dd4bf; --danger:#ff6363; --ring:rgba(45,212,191,.25);
         --chip:#0d1420; --chip2:#101826; --border:#212a3a; }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
  html,body{height:100%}
  body{ margin:0; background:var(--bg); color:var(--text);
        font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; }
  header{ position:sticky; top:0; z-index:50; background:linear-gradient(180deg,rgba(15,17,21,.96),rgba(15,17,21,.7)); border-bottom:1px solid var(--border); }
  .wrap{max-width:940px; margin:0 auto; padding:14px 16px}
  h1{font-size:22px; margin:0 0 6px}
  p{margin:0; color:var(--muted); font-size:14px}
  .grid{display:grid; gap:12px}
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
  .issues{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px}
  @media (min-width:520px){ .issues{grid-template-columns: repeat(3, minmax(0,1fr));} }
  @media (min-width:760px){ .issues{grid-template-columns: repeat(4, minmax(0,1fr));} }
  .issue{ display:flex; align-items:center; gap:10px; padding:16px; border-radius:12px; background: linear-gradient(180deg, var(--chip), var(--chip2)); border:1px solid var(--border); font-size:16px; font-weight:600; cursor:pointer; }
  .issue.selected{ outline:2px solid var(--accent); box-shadow:0 0 0 6px var(--ring); }
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:14px 16px; border-radius:12px; border:1px solid var(--border); background: linear-gradient(180deg,#121826,#0e1522); color:var(--text); font-weight:700; font-size:16px; cursor:pointer; }
  .btn[disabled]{opacity:.5; pointer-events:none}
  .btn.primary{ background: linear-gradient(180deg,#093a36,#0b2e2b); border-color:#12413b }
  .btn.green{ background: linear-gradient(180deg,#0b3822,#0a2e1c); border-color:#174a32 }
  .btn.red{ background: linear-gradient(180deg,#0f0b0b,#2a0b0b); border-color:#552121 }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  input[type="text"]{ width:100%; padding:14px; border-radius:12px; border:1px solid var(--border); background:#0e1421; color:var(--text); font-size:16px; }
  .split{display:grid; gap:12px}
  @media(min-width:880px){ .split{grid-template-columns: 1.5fr 1fr} }
  .summary{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px }
  @media(min-width:520px){ .summary{ grid-template-columns:repeat(3, minmax(0,1fr));} }
  .chip{ border:1px solid var(--border); background:linear-gradient(180deg,#0f1626,#0c1220); padding:12px; border-radius:12px; display:flex; align-items:center; gap:10px; justify-content:space-between; cursor:pointer; }
  .list{ display:grid; gap:8px; max-height:420px; overflow:auto; padding-right:4px }
  .item{ display:flex; gap:8px; align-items:center; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:linear-gradient(180deg,#0e1522,#0b111c); }
  .badge{ font-size:12px; padding:4px 8px; border-radius:999px; background:#0f2030; border:1px solid var(--border); color:#a9b1c3 }
  .ts{ margin-left:auto; font-size:12px; color:#a9b1c3; white-space:nowrap }
  .tabs{ display:flex; gap:8px; border-bottom:1px solid var(--border); margin-bottom:12px }
  .tab{ padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700 }
  .tab.active{ background:#10192a; border:1px solid var(--border) }
  .video-wrap{position:relative;border-radius:12px;overflow:hidden;background:#0a0c10;aspect-ratio:3/4;max-width:560px;margin:0 auto}
  video{width:100%;height:100%;object-fit:cover;display:block}
  .scan-frame{position:absolute;inset:10%;border:2px solid rgba(255,255,255,.55);border-radius:12px;pointer-events:none;transition: box-shadow .12s, border-color .12s;}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Regjistri i Biçikletave me Defekt</h1>
    <p>Skano QR (ose shkruaj manualisht), zgjidh defektin dhe shto në listë. Fundi: Eksporto në Excel/Word.</p>
  </div>
</header>

<main class="wrap grid" style="padding-top:10px">
  <section class="card">
    <div class="row" style="justify-content:space-between; gap:10px 16px">
      <div>
        <b>1) Zgjidh defektin</b><br>
        <span class="hint">Prek një nga butonat më poshtë (butona të mëdhenj për përdorim me një dorë).</span>
      </div>
      <button class="btn" id="clearSel">Hiqe përzgjedhjen</button>
    </div>
    <div id="issueGrid" class="issues" style="margin-top:10px"></div>
  </section>

  <section class="card">
    <div class="grid">
      <b>2) Skano ose shkruaj barkodin</b>
      <div class="toolbar">
        <button class="btn primary" id="btnStartScan">📷 Fillo skanimin</button>
        <button class="btn" id="btnStopScan" disabled>✖︎ Ndalo</button>
        <button class="btn" id="btnSwitchCam" disabled>🔄 Ndërro kamerën</button>
        <button class="btn" id="btnTorch" disabled>💡 Flaş</button>
        <button class="btn" id="btnClipboard">📋 Ngjit nga kujtesa</button>
      </div>
      <div id="scanBox" class="card" style="padding:0; display:none">
        <div class="video-wrap">
          <video id="qrVideo" playsinline muted></video>
          <div id="qrFrame" class="scan-frame"></div>
        </div>
      </div>
      <canvas id="qrCanvas" style="display:none"></canvas>
      <div class="grid">
        <label for="manual" class="hint">Ngjit linkun e QR-it ose shkruaj kodin (4 shkronja/shifra):</label>
        <div class="row" style="gap:8px">
          <input id="manual" type="text" placeholder="p.sh. https://.../L8KQ OSE L8KQ" inputmode="text" autocomplete="off" autocapitalize="characters" maxlength="64">
          <button class="btn green" id="btnAddManual">➕ Shto në listë</button>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="btnUndo">↶ Kthe veprimin e fundit</button>
        <button class="btn red" id="btnClearAll">🗑️ Pastro gjithçka</button>
      </div>
      <p class="hint">Nëse kamera nuk hapet: faqja duhet të jetë HTTPS. Në iOS, Safari → Camera → *Allow*.</p>
    </div>
  </section>

  <section class="card split">
    <div>
      <div class="tabs">
        <div class="tab active" data-tab="by-barcode">Lista sipas barkodit</div>
        <div class="tab" data-tab="by-summary">Përmbledhje sipas defekteve</div>
      </div>
      <div id="pane-by-barcode" class="list"></div>
      <div id="pane-by-summary" class="list" style="display:none"></div>
    </div>
    <aside>
      <b>Eksporto</b>
      <div class="grid" style="margin-top:10px">
        <button class="btn" id="btnExportCSV">⬇️ Detaje – CSV</button>
        <button class="btn" id="btnExportSummaryCSV">⬇️ Përmbledhje – CSV</button>
        <button class="btn" id="btnExportDOC">⬇️ Word (.doc)</button>
      </div>
      <div class="card" style="margin-top:12px">
        <b>Statistika e shpejtë</b>
        <div id="quick" class="summary" style="margin-top:8px"></div>
      </div>
    </aside>
  </section>
</main>

<div class="modal" id="modal">
  <div class="sheet">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h3 id="modalTitle">Detajet</h3>
      <button class="close" id="closeModal">Mbyll</button>
    </div>
    <div id="modalBody" class="list" style="margin-top:10px"></div>
  </div>
</div>

<div class="flash" id="flash"></div>

<footer class="wrap" style="text-align:center; color:#a9b1c3; font-size:12px; padding:20px 0 60px">Punon offline · LocalStorage</footer>

<script>
  // ---- Helper UI ----
  const $=q=>document.querySelector(q);
  function fmtTS(ts){return new Date(ts).toLocaleString('sq-AL',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});}
  function beep(ok=true){try{const ctx=new (window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type=ok?'triangle':'sawtooth';o.frequency.value=ok?880:320;g.gain.setValueAtTime(.0001,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.05,ctx.currentTime+.02);g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+.22);o.start();o.stop(ctx.currentTime+.24);}catch{}}
  function flash(ok){const el=$('#flash');el.className='flash '+(ok?'ok':'err');el.style.opacity='1';setTimeout(()=>el.style.opacity='0',220);}
  function extract4(s){return String(s||'').trim().replace(/[^0-9A-Za-z]/g,'').slice(-4).toUpperCase();}
</script>
<script>
  // ---- Data & Issues ----
  const ISSUES=[
    {id:'chg-no',name:'Nuk merr karikim'},
    {id:'lock',name:'Bllokimi i baterisë nuk hapet'},
    {id:'lcd',name:'Ekrani nuk ndizet'},
    {id:'bat0',name:'Bateria ngelet në 0%'},
    {id:'ctrl',name:'Kontrolleri problematik'},
    {id:'timeout',name:'Koha skadoi (Timeout)'},
    {id:'port-miss',name:'Mungon priza e karikimit'},
    {id:'brake',name:'Rrota e bllokuar nga frena'},
    {id:'mech',name:'Probleme mekanike'},
    {id:'no-cmd',name:'Nuk merr komandë'},
  ];
  const LS_KEY='bikeq_v4';
  let selectedIssue=null; let records=load();
  function load(){try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]');}catch{return []}}
  function save(){localStorage.setItem(LS_KEY,JSON.stringify(records));}
  function addRecordFrom(raw){const code=extract4(raw); if(!code){alert('Kodi i pavlefshëm.');flash(false);beep(false);return;} if(!selectedIssue){alert('Zgjidh defektin fillimisht.');flash(false);beep(false);return;} if(records.some(r=>r.code===code && r.issue===selectedIssue)){flash(false);beep(false);return;} records.push({code,issue:selectedIssue,ts:Date.now()}); save(); render(); flash(true);beep(true);}
  function undo(){if(records.length){records.pop();save();render();}}
  function clearAll(){if(confirm('Je i sigurt?')){records=[];save();render();}}
  function byBarcode(){const m=new Map();for(const r of records){if(!m.has(r.code))m.set(r.code,[]);m.get(r.code).push(r);}for(const v of m.values())v.sort((a,b)=>b.ts-a.ts);return [...m.entries()].sort((a,b)=>a[0].localeCompare(b[0]));}
  function byIssue(){const m=new Map();for(const r of records){if(!m.has(r.issue))m.set(r.issue,[]);m.get(r.issue).push(r);}return ISSUES.map(it=>({id:it.id,name:it.name,count:(m.get(it.id)||[]).length,rows:(m.get(it.id)||[])}));}
</script>
<script>
  // ---- Render ----
  function renderIssues(){const grid=$('#issueGrid');grid.innerHTML='';ISSUES.forEach(it=>{const b=document.createElement('button');b.className='issue';b.textContent=it.name; b.onclick=()=>{selectedIssue=it.id;[...grid.children].forEach(c=>c.classList.remove('selected'));b.classList.add('selected');};grid.appendChild(b);});}
  function render(){ // barcode list
    const pane=$('#pane-by-barcode'); pane.innerHTML=''; const g=byBarcode(); if(!g.length){pane.innerHTML='<div class="hint">S’ka të dhëna ende.</div>'} else { for(const [code,arr] of g){ const el=document.createElement('div'); el.className='item'; el.innerHTML='<b>'+code+'</b> '+arr.map(x=>'<span class="badge">'+(ISSUES.find(i=>i.id===x.issue)?.name||x.issue)+'</span>').join(' ')+' <span class="ts">'+fmtTS(arr[0].ts)+'</span>'; pane.appendChild(el);} }
    // summary
    const sp=$('#pane-by-summary'); sp.innerHTML=''; const quick=$('#quick'); quick.innerHTML=''; for(const row of byIssue()){ const chip=document.createElement('div'); chip.className='chip'; chip.innerHTML='<div>'+row.name+'</div><b>'+row.count+'</b>'; chip.onclick=()=>openDetails(row.id); sp.appendChild(chip); const q=chip.cloneNode(true); q.onclick=()=>openDetails(row.id); quick.appendChild(q);} }
  function openDetails(issueId){ const issue=ISSUES.find(i=>i.id===issueId); const rows=records.filter(r=>r.issue===issueId).sort((a,b)=>b.ts-a.ts); $('#modalTitle').textContent=issue?.name||issueId; const body=$('#modalBody'); body.innerHTML=''; if(!rows.length){body.innerHTML='<div class="hint">S’ka hyrje.</div>'; showModal(true); return;} for(const r of rows){ const el=document.createElement('div'); el.className='item'; el.innerHTML='<b>'+r.code+'</b> <span class="badge">'+(issue?.name||r.issue)+'</span> <span class="ts">'+fmtTS(r.ts)+'</span>'; body.appendChild(el);} showModal(true); }
  function showModal(open){ $('#modal').classList.toggle('open',!!open); }
  function initTabs(){ const tabs=document.querySelectorAll('.tab'); tabs.forEach(t=>t.addEventListener('click',()=>{tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); const n=t.getAttribute('data-tab'); $('#pane-by-barcode').style.display=(n==='by-barcode')? '' : 'none'; $('#pane-by-summary').style.display=(n==='by-summary')? '' : 'none'; })); }
</script>
<script>
  // ---- Exports ----
  function toCSV(rows){return rows.map(r=>r.map(x=>('"' + String(x??'').replace(/"/g,'""') + '"')).join(',')).join('\r\n');}
  function dl(name,mime,content){const blob=new Blob([content],{type:mime});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=name;a.click();setTimeout(()=>URL.revokeObjectURL(url),1500);}
  function exportDetails(){const rows=[["Kodi (4-sh)","Defekti","Data/Ora"]]; for(const r of records){rows.push([r.code, ISSUES.find(i=>i.id===r.issue)?.name||r.issue, fmtTS(r.ts)])} dl('detaje.csv','text/csv;charset=utf-8', toCSV(rows));}
  function exportSummary(){const rows=[["Defekti","Sasia"]]; for(const s of byIssue()){rows.push([s.name,s.count])} dl('permbledhje.csv','text/csv;charset=utf-8', toCSV(rows));}
  function exportDoc(){ const sum=byIssue(); const html=<html><head><meta charset="utf-8"></head><body style="font-family:Arial"><h2>Raport – Biçikleta</h2><p>${fmtTS(Date.now())}</p><h3>Përmbledhje</h3><table border=1 cellpadding=6 cellspacing=0><tr><th>Defekti</th><th>Sasia</th></tr>${sum.map(s=><tr><td>${s.name}</td><td>${s.count}</td></tr>).join('')}</table><h3>Detaje</h3><table border=1 cellpadding=6 cellspacing=0><tr><th>#</th><th>Kodi</th><th>Defekti</th><th>Data/Ora</th></tr>${records.map((r,i)=><tr><td>${i+1}</td><td>${r.code}</td><td>${ISSUES.find(x=>x.id===r.issue)?.name||r.issue}</td><td>${fmtTS(r.ts)}</td></tr>).join('')}</table></body></html>; dl('raport.doc','application/msword',html); }
</script>
<script>
  // ---- Scanner (BarcodeDetector preferred, jsQR fallback) ----
  let stream=null, track=null, scanning=false, lastTick=0, detector=null, useBD=('BarcodeDetector' in window);

  async function ensureScanner(){
    if(useBD){
      try{detector=new BarcodeDetector({formats:['qr_code','code_128','code_39']}); return true;}
      catch(e){ useBD=false; }
    }
    // jsQR fallback loader (multi-CDN)
    if(window.jsQR) return true;
    const cdns=[
      'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js',
      'https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js',
      'https://unpkg.com/jsqr@1.4.0/dist/jsQR.js'
    ];
    for(const url of cdns){
      try{
        await new Promise((res,rej)=>{const s=document.createElement('script'); s.src=url; s.onload=res; s.onerror=rej; document.head.appendChild(s);});
        if(window.jsQR) return true;
      }catch(e){}
    }
    return !!window.jsQR;
  }
  async function listCameras(){ try{ const dev=await navigator.mediaDevices.enumerateDevices(); return dev.filter(d=>d.kind==='videoinput'); }catch{return []} }
  async function startScan(){
    const ok=await ensureScanner();
    if(!ok){ alert('Skaneri nuk u ngarkua. Përdorni “Ngjit nga kujtesa” ose shkrimin manual.'); return; }
    $('#scanBox').style.display='block';
    $('#btnStopScan').disabled=false;
    const cams=await listCameras(); $('#btnSwitchCam').disabled=(cams.length<=1);
    const cons = window._lastCam ? {video:{deviceId:{exact:window._lastCam}}} : {video:{facingMode:'environment'}};
    stream=await navigator.mediaDevices.getUserMedia(cons);
    const v=$('#qrVideo'); v.srcObject=stream; await v.play();
    track=stream.getVideoTracks()[0]||null;
    $('#btnTorch').disabled=!(track && track.getCapabilities && track.getCapabilities().torch);
    scanning=true; lastTick=0; requestAnimationFrame(loop);
  }
  function stopScan(){ scanning=false; if(stream){ stream.getTracks().forEach(t=>t.stop()); } $('#qrVideo').srcObject=null; track=null; }
  async function switchCam(){ const cams=await listCameras(); if(cams.length<=1) return; const ids=cams.map(c=>c.deviceId); const idx=Math.max(0, ids.indexOf(window._lastCam)); window._lastCam = ids[(idx+1)%ids.length]; stopScan(); startScan(); }
  async function toggleTorch(){ if(!track||!track.applyConstraints) return; const caps=track.getCapabilities?track.getCapabilities():{}; if(!caps.torch) return; toggleTorch._on=!toggleTorch._on; try{ await track.applyConstraints({advanced:[{torch:toggleTorch._on}]}); }catch{ toggleTorch._on=false; } }
  function glow(ok){ const f=$('#qrFrame'); if(!f) return; f.style.boxShadow = ok? '0 0 0 9999px rgba(0,255,144,.18) inset, 0 0 22px rgba(0,255,144,.75) inset' : '0 0 0 9999px rgba(255,0,0,.18) inset, 0 0 22px rgba(255,80,80,.9) inset'; f.style.borderColor = ok? 'rgba(0,255,144,.95)' : 'rgba(255,90,90,.95)'; clearTimeout(f._t); f._t=setTimeout(()=>{ f.style.boxShadow=''; f.style.borderColor='rgba(255,255,255,.55)'; }, 350); }
  function drawFrame(){ const v=$('#qrVideo'), c=$('#qrCanvas'), ctx=c.getContext('2d',{willReadFrequently:true}); c.width=v.videoWidth; c.height=v.videoHeight; ctx.drawImage(v,0,0,c.width,c.height); return ctx.getImageData(0,0,c.width,c.height); }

  async function loop(ts){
    if(!scanning) return;
    if(ts-lastTick<120) return requestAnimationFrame(loop);
    lastTick=ts; const v=$('#qrVideo');

    if(useBD && detector){
      try{
        const codes=await detector.detect(v);
        if(codes && codes[0]){
          const code=extract4(codes[0].rawValue);
          if(code){ addRecordFrom(code); glow(true); beep(true); } else { glow(false); beep(false); }
        }
      }catch(e){}
    } else if(window.jsQR && v.readyState>=2){
      const frame=drawFrame();
      const qr=jsQR(frame.data, frame.width, frame.height, {inversionAttempts:'dontInvert'});
      if(qr && qr.data){
        const code=extract4(qr.data);
        if(code){ addRecordFrom(code); glow(true); beep(true);} else { glow(false); beep(false);}
      }
    }
    requestAnimationFrame(loop);
  }
</script>
<script>
  // ---- Wire UI ----
  function exportButtons(){ $('#btnExportCSV').onclick=exportDetails; $('#btnExportSummaryCSV').onclick=exportSummary; $('#btnExportDOC').onclick=exportDoc; }
  window.addEventListener('load',()=>{
    renderIssues(); initTabs(); render(); exportButtons();
    $('#btnAddManual').onclick=()=>addRecordFrom($('#manual').value);
    $('#btnUndo').onclick=undo; $('#btnClearAll').onclick=clearAll;
    $('#btnStartScan').onclick=startScan; $('#btnStopScan').onclick=stopScan;
    $('#btnSwitchCam').onclick=switchCam; $('#btnTorch').onclick=toggleTorch;
    $('#btnClipboard').onclick=async()=>{ try{const t=await navigator.clipboard.readText(); if(t) addRecordFrom(t);}catch{alert('Clipboard i bllokuar. Jep leje.');} };
    $('#manual').addEventListener('keydown',e=>{ if(e.key==='Enter') addRecordFrom($('#manual').value); });
    if(navigator.permissions&&navigator.permissions.query){
      navigator.permissions.query({name:'camera'}).then(p=>{ if(p.state==='granted') startScan(); }).catch(()=>{});
    }
  });
</script>
</body>
</html>
