<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>Regjistër Biçikletash • SAFE v2.1</title>
<style>
  :root{
    --bg:#0f1115; --card:#171a21; --ink:#e8edf7; --muted:#a9b1c3;
    --accent:#29c06f; --accent2:#3db1ff; --danger:#ff5d5d; --ring:rgba(61,177,255,.25);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#eaf1fb; --card:#ffffff; --ink:#0f2230; --muted:#4d6477; --accent:#1ca763; --accent2:#1678ff; --danger:#e34b4b; --ring:rgba(22,120,255,.18); }
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
  header{position:sticky;top:0;z-index:20;backdrop-filter:saturate(1.2) blur(6px);background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0)),var(--bg);padding:14px 16px 10px;border-bottom:1px solid rgba(255,255,255,.06)}
  h1{margin:0;font-size:20px;font-weight:800;letter-spacing:.2px}
  .sub{margin-top:6px;font-size:13px;color:var(--muted)}
  .bar{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;color:#fff;background:var(--accent2);box-shadow:0 6px 14px -6px var(--ring)}
  .btn.alt{background:var(--accent)}
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid rgba(255,255,255,.15)}
  .btn.danger{background:var(--danger)}
  input[type="text"]{padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:var(--card);color:var(--ink);outline:none;min-width:180px}
  main{padding:12px;max-width:1100px;margin:0 auto 120px}
  .panel{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;margin-bottom:12px}
  .title{font-weight:800}
  .muted{color:var(--muted);font-size:12px;margin-top:4px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;display:flex;gap:10px;align-items:center;position:relative}
  .count{min-width:54px;height:54px;border-radius:12px;background:rgba(61,177,255,.1);display:grid;place-items:center;font-weight:800;font-size:18px;border:1px dashed rgba(61,177,255,.35);color:var(--accent2)}
  .badge{display:inline-block;margin:4px 6px 0 0;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);font-size:12px}
  .x{border:1px solid rgba(255,0,0,.35);color:#ffb3b3;background:transparent;border-radius:10px;padding:6px 10px;cursor:pointer}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  /* Kamera kutusu */
  #camBox{display:none;gap:10px;align-items:center}
  video{width:100%;max-height:42vh;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#000}
  /* Modal (dialog yerine) */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(760px,96vw);background:var(--card);border:1px solid rgba(255,255,255,.12);border-radius:16px;overflow:hidden}
  .modal-head{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center}
  .modal-body{padding:12px 16px;max-height:62vh;overflow:auto}
  .issue-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .issue-btn{padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(61,177,255,.08);font-weight:800;cursor:pointer}
  .list{list-style:none;margin:0;padding:0}
  .list li{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px 8px;border-bottom:1px dashed rgba(255,255,255,.08);font-size:14px}
  .small{font-size:12px;color:var(--muted)}
  .footer{position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid rgba(255,255,255,.1);padding:10px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;z-index:30}
</style>
</head>
<body>
<header>
  <h1>Regjistër Biçikletash (Barkod + Probleme) • SAFE</h1>
  <div class="sub">Së pari “Elle Barkod Ekle” ile dene. Sonra kamerayı açmayı denersin.</div>
  <div class="bar">
    <button class="btn" type="button" id="openCam">Hap kamerën</button>
    <button class="btn ghost" type="button" id="closeCam" style="display:none">Mbyll kamerën</button>
    <input id="manualCode" type="text" placeholder="Shkruaj barkodin me dorë">
    <button class="btn alt" type="button" id="addManual">Shto me dorë</button>
    <button class="btn danger" type="button" id="resetAll">Rivendos gjithçka</button>
  </div>
  <div id="camBox" class="panel">
    <div class="row">
      <b>Kamera:</b> <span id="camHint" class="muted">Duke u hapur…</span>
    </div>
    <video id="video" playsinline muted></video>
  </div>
</header>

<main>
  <!-- Përmbledhje -->
  <section class="panel">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <div class="title">Përmbledhje</div>
        <div class="muted">Numërimet rifreskohen automatikisht</div>
      </div>
      <div class="row">
        <button class="btn ghost" type="button" id="expSummary">Shkarko CSV (Përmbledhje)</button>
        <button class="btn" type="button" id="expDetails">Shkarko CSV (Detaje)</button>
        <button class="btn alt" type="button" id="expDoc">Shkarko Word (DOC)</button>
      </div>
    </div>
    <div class="grid" id="summaryGrid" style="margin-top:10px"></div>
  </section>

  <!-- Lista sipas barkodit -->
  <section class="panel">
    <div class="title">Barkodet & problemet</div>
    <div class="muted">Prek “Fshi” për të hequr një hyrje.</div>
    <ul class="list" id="byCodeList"></ul>
  </section>
</main>

<!-- MODAL (dialog yerine) -->
<div class="modal-back" id="modalBack" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="modal-head">
      <div>
        <div id="mTitle" style="font-weight:800">Zgjidh problemin</div>
        <div id="mCode" class="small"></div>
      </div>
      <button class="btn ghost" type="button" id="mClose">Mbyll</button>
    </div>
    <div class="modal-body">
      <div class="issue-grid" id="issueGrid"></div>
    </div>
  </div>
</div>

<div class="footer">
  <span class="muted">Të dhënat ruhen në këtë pajisje (localStorage).</span>
</div>

<script>
(function(){
  // ====== PROBLEMET (SQ) ======
  const ISSUES = [
    { id:'nuk-karikon',        name:'Nuk karikon' },
    { id:'kyci-baterise',      name:'Kyçi i baterisë nuk hapet' },
    { id:'ekrani-nuk-ndizet',  name:'Ekrani nuk ndizet' },
    { id:'bateria-zero',       name:'Bateria mbetet në 0%' },
    { id:'shofer-problem',     name:'Shoferi / kontrollori problematik' },
    { id:'timeout',            name:'Timeout' },
    { id:'mungon-priza',       name:'Mungon priza e karikimit' },
    { id:'rrota-ne-frene',     name:'Rrota bllokohet në frenë' },
    { id:'probleme-mekanike',  name:'Probleme mekanike' },
    { id:'s’merre-komande',    name:'Nuk merr komandë' },
  ];
  const ISSUE_BY_ID = Object.fromEntries(ISSUES.map(i=>[i.id,i]));

  // ====== DATA ======
  const LS_KEY = 'bike-reg-safe-v21';
  let state = loadState();
  function loadState(){ try{ const raw=localStorage.getItem(LS_KEY); if(raw) return JSON.parse(raw);}catch(_){ } return {entries:[]} }
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); renderAll(); }
  function nowStr(){ try{ return new Date().toLocaleString('sq-AL',{timeZone:'Europe/Tirane',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});}catch(_){ return new Date().toLocaleString(); } }

  // ====== EL’ler ======
  const openCamBtn = document.getElementById('openCam');
  const closeCamBtn = document.getElementById('closeCam');
  const camBox = document.getElementById('camBox');
  const camHint = document.getElementById('camHint');
  const video = document.getElementById('video');
  const manualCode = document.getElementById('manualCode');
  const addManual = document.getElementById('addManual');
  const resetAll = document.getElementById('resetAll');
  const summaryGrid = document.getElementById('summaryGrid');
  const byCodeList = document.getElementById('byCodeList');
  const expSummary = document.getElementById('expSummary');
  const expDetails  = document.getElementById('expDetails');
  const expDoc = document.getElementById('expDoc');

  // Modal
  const modalBack = document.getElementById('modalBack');
  const mCode = document.getElementById('mCode');
  const mClose = document.getElementById('mClose');
  const issueGrid = document.getElementById('issueGrid');

  // Issue butonları
  ISSUES.forEach(i=>{
    const b=document.createElement('button');
    b.className='issue-btn'; b.type='button'; b.textContent=i.name;
    b.addEventListener('click', ()=> chooseIssue(i.id));
    issueGrid.appendChild(b);
  });

  let pendingCode = null;
  function openIssueChooser(code){
    pendingCode = code;
    mCode.textContent = 'Barkod: ' + code;
    modalBack.style.display = 'flex';
    modalBack.setAttribute('aria-hidden','false');
    document.body.style.overflow='hidden';
  }
  function closeIssueChooser(){
    modalBack.style.display = 'none';
    modalBack.setAttribute('aria-hidden','true');
    document.body.style.overflow='';
  }
  mClose.addEventListener('click', closeIssueChooser);
  modalBack.addEventListener('click', (e)=>{ if(e.target===modalBack) closeIssueChooser(); });

  function chooseIssue(issueId){
    if(!pendingCode) return;
    const exists = state.entries.some(e=> e.code===pendingCode && e.issueId===issueId);
    if(exists){
      if(!confirm('Ky barkod është regjistruar tashmë me këtë problem. Shto përsëri?')) return;
    }
    state.entries.push({ code: pendingCode, issueId, ts: nowStr() });
    saveState();
    closeIssueChooser();
    vibrate(20);
  }

  // ====== Render ======
  function renderAll(){ renderSummary(); renderByCode(); }
  function renderSummary(){
    const byIssue = new Map(ISSUES.map(i=>[i.id,0]));
    const uniq = new Set();
    state.entries.forEach(e=>{ uniq.add(e.code); byIssue.set(e.issueId,(byIssue.get(e.issueId)||0)+1); });
    summaryGrid.innerHTML='';
    summaryGrid.appendChild(stat('Gjithsej regjistrime', String(state.entries.length)));
    summaryGrid.appendChild(stat('Barkode unike', String(uniq.size)));
    ISSUES.forEach(i=> summaryGrid.appendChild(stat(i.name, String(byIssue.get(i.id)||0))));
  }
  function stat(title, value){
    const d=document.createElement('div'); d.className='card';
    const c=document.createElement('div'); c.className='count'; c.textContent=value;
    const t=document.createElement('div'); t.innerHTML='<div class="title">'+title+'</div><div class="muted">—</div>';
    d.appendChild(c); d.appendChild(t); return d;
  }
  function renderByCode(){
    const map=new Map();
    state.entries.forEach(e=>{ if(!map.has(e.code)) map.set(e.code,[]); map.get(e.code).push(e); });
    const rows=Array.from(map.entries()).sort((a,b)=> (a[1][a[1].length-1]?.ts||'') < (b[1][b[1].length-1]?.ts||'') ? 1 : -1);
    byCodeList.innerHTML='';
    if(!rows.length){
      const li=document.createElement('li'); li.innerHTML='<span class="small">S’ka të dhëna ende. Skano ose shto me dorë.</span>'; byCodeList.appendChild(li); return;
    }
    rows.forEach(([code, arr])=>{
      const li=document.createElement('li');
      const left=document.createElement('div'), right=document.createElement('div');
      const head=document.createElement('div'); head.innerHTML='<b>'+code+'</b> · <span class="small">'+arr.length+' regj.</span>';
      left.appendChild(head);
      const probs=document.createElement('div');
      arr.forEach((e,i)=>{
        const sp=document.createElement('span'); sp.className='badge'; sp.textContent=ISSUE_BY_ID[e.issueId]?.name||e.issueId; sp.title=e.ts;
        const del=document.createElement('button'); del.className='x'; del.type='button'; del.textContent='Fshi';
        del.addEventListener('click', ()=>{
          const idx=state.entries.findIndex(x=> x.code===e.code && x.issueId===e.issueId && x.ts===e.ts);
          if(idx>=0){ state.entries.splice(idx,1); saveState(); }
        });
        probs.appendChild(sp); probs.appendChild(del);
        if(i<arr.length-1){ const sep=document.createElement('span'); sep.className='small'; sep.style.margin='0 4px'; sep.textContent='·'; probs.appendChild(sep); }
      });
      left.appendChild(probs);
      const addBtn=document.createElement('button'); addBtn.className='btn ghost'; addBtn.type='button'; addBtn.textContent='Shto problem'; addBtn.addEventListener('click', ()=> openIssueChooser(code));
      right.appendChild(addBtn);
      li.appendChild(left); li.appendChild(right);
      byCodeList.appendChild(li);
    });
  }

  // ====== Manual ======
  document.getElementById('addManual').addEventListener('click', ()=>{
    const code=sanitize(manualCode.value);
    if(!code){ alert('Shkruaj një barkod.'); return; }
    manualCode.value=''; openIssueChooser(code);
  });

  // ====== Export ======
  function csvEscape(v){ if(v==null) return ''; v=String(v); return /[",\n,;]/.test(v) ? '"'+v.replace(/"/g,'""')+'"' : v; }
  function downloadText(text, name, mime){ const blob=new Blob([text],{type:mime||'text/plain;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500); }
  expDetails.addEventListener('click', ()=>{
    const rows=[['Barkod','Kategori','Data & Ora']];
    state.entries.forEach(e=> rows.push([e.code, ISSUE_BY_ID[e.issueId]?.name||e.issueId, e.ts]));
    downloadText(rows.map(r=>r.map(csvEscape).join(',')).join('\n'),'detaje_bicikleta.csv','text/csv;charset=utf-8;');
  });
  expSummary.addEventListener('click', ()=>{
    const byIssue=new Map(ISSUES.map(i=>[i.id,0])); state.entries.forEach(e=> byIssue.set(e.issueId,(byIssue.get(e.issueId)||0)+1));
    const rows=[['Kategori','Sasia']]; ISSUES.forEach(i=> rows.push([i.name, byIssue.get(i.id)||0]));
    downloadText(rows.map(r=>r.map(csvEscape).join(',')).join('\n'),'permbledhje_bicikleta.csv','text/csv;charset=utf-8;');
  });
  expDoc.addEventListener('click', ()=>{
    const stamp=nowStr();
    const map=new Map(); state.entries.forEach(e=>{ if(!map.has(e.code)) map.set(e.code,[]); map.get(e.code).push(e); });
    const byIssue=new Map(ISSUES.map(i=>[i.id,0])); state.entries.forEach(e=> byIssue.set(e.issueId,(byIssue.get(e.issueId)||0)+1));
    let html=`<html><head><meta charset="utf-8"></head><body>
    <h2>Raport Biçikletash (Barkod + Probleme)</h2><p><b>Gjeneruar:</b> ${stamp}</p>
    <h3>Përmbledhje</h3><table border="1" cellspacing="0" cellpadding="6"><tr><th>Kategori</th><th>Sasia</th></tr>
    ${ISSUES.map(i=> <tr><td>${i.name}</td><td>${byIssue.get(i.id)||0}</td></tr>).join('')}</table>
    <h3>Detaje sipas barkodit</h3>
    ${Array.from(map.entries()).map(([code,arr])=> `<h4>${code} (${arr.length})</h4>
      <table border="1" cellspacing="0" cellpadding="6"><tr><th>#</th><th>Kategoria</th><th>Data & Ora</th></tr>
      ${arr.map((e,i)=> <tr><td>${i+1}</td><td>${ISSUE_BY_ID[e.issueId]?.name||e.issueId}</td><td>${e.ts}</td></tr>).join('')}
      </table>`).join('')}
    </body></html>`;
    downloadText(html,'raport_bicikleta.doc','application/msword;charset=utf-8;');
  });

  // ====== Kamera (opsiyonel) ======
  let stream=null, detector=null, rafId=0; const coolSet=new Set();
  async function startCam(){
    camBox.style.display='block'; camHint.textContent='Duke u hapur…';
    openCamBtn.style.display='none'; closeCamBtn.style.display='inline-block';
    try{
      if('BarcodeDetector' in window){ const formats=['qr_code','code_128','code_39','ean_13','ean_8','upc_a','upc_e','itf','codabar','data_matrix','pdf417','aztec']; detector=new window.BarcodeDetector({formats}); } else { detector=null; }
      stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }, audio:false });
      video.srcObject=stream; await video.play();
      camHint.textContent = detector ? 'Gati për skanim. Drejto barkodin te kamera.' : 'Skanim automatik jo i mbështetur. Përdor “Shto me dorë”.';
      if(detector) loopDetect();
    }catch(err){ camHint.textContent='S’ u hap kamera: ' + (err && err.message ? err.message : err); openCamBtn.style.display='inline-block'; closeCamBtn.style.display='none'; }
  }
  function stopCam(){ try{ if(rafId) cancelAnimationFrame(rafId);}catch(_){} rafId=0; if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } video.srcObject=null; camBox.style.display='none'; openCamBtn.style.display='inline-block'; closeCamBtn.style.display='none'; }
  async function loopDetect(){
    if(!detector || !video || video.readyState<2){ rafId=requestAnimationFrame(loopDetect); return; }
    try{
      const codes=await detector.detect(video);
      if(codes && codes.length){
        const raw=codes[0].rawValue||''; const code=sanitize(raw);
        if(code && !coolSet.has(code)){ coolSet.add(code); setTimeout(()=>coolSet.delete(code),2000); vibrate(20); openIssueChooser(code); }
      }
    }catch(_){}
    rafId=requestAnimationFrame(loopDetect);
  }

  // ====== Helpers ======
  function sanitize(s){ if(s==null) return ''; return String(s).trim(); }
  function vibrate(ms){ if(navigator.vibrate) try{ navigator.vibrate(ms); }catch(_){ } }

  // ====== Events ======
  openCamBtn.addEventListener('click', startCam);
  closeCamBtn.addEventListener('click', stopCam);
  addManual.addEventListener('click', ()=> document.getElementById('addManual').blur());
  resetAll.addEventListener('click', ()=>{ if(!confirm('Je i sigurt? Kjo do t’i fshijë të gjitha regjistrimet.')) return; state={entries:[]}; saveState(); });

  // İlk render
  renderAll();
})();
</script>
</body>
</html>
