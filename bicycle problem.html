<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>Regjistër Biçikletash • Barkod + Probleme</title>
<style>
  :root{
    --bg:#0f1115; --card:#171a21; --ink:#e8edf7; --muted:#a9b1c3;
    --accent:#29c06f; --accent2:#3db1ff; --danger:#ff5d5d; --ring:rgba(61,177,255,.25);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#eaf1fb; --card:#ffffff; --ink:#0f2230; --muted:#4d6477; --accent:#1ca763; --accent2:#1678ff; --danger:#e34b4b; --ring:rgba(22,120,255,.18); }
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
  header{position:sticky;top:0;z-index:20;backdrop-filter:saturate(1.2) blur(6px);background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0)),var(--bg);padding:14px 16px 10px;border-bottom:1px solid rgba(255,255,255,.06)}
  h1{margin:0;font-size:20px;font-weight:800;letter-spacing:.2px}
  .sub{margin-top:6px;font-size:13px;color:var(--muted)}
  .bar{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer;color:#fff;background:var(--accent2);box-shadow:0 6px 14px -6px var(--ring)}
  .btn.alt{background:var(--accent)}
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid rgba(255,255,255,.15)}
  .btn.danger{background:var(--danger)}
  input[type="text"],input[type="number"]{padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:var(--card);color:var(--ink);outline:none;min-width:180px}
  main{padding:12px;max-width:1100px;margin:0 auto 120px}
  .wrap{display:grid;grid-template-columns:1fr;gap:12px}
  .panel{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;display:flex;gap:10px;align-items:center;position:relative}
  .count{min-width:54px;height:54px;border-radius:12px;background:rgba(61,177,255,.1);display:grid;place-items:center;font-weight:800;font-size:18px;border:1px dashed rgba(61,177,255,.35);color:var(--accent2)}
  .title{font-weight:800}
  .muted{color:var(--muted);font-size:12px;margin-top:4px}
  .badge{display:inline-block;margin:4px 6px 0 0;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);font-size:12px}
  .x{border:1px solid rgba(255,0,0,.35);color:#ffb3b3;background:transparent;border-radius:10px;padding:6px 10px;cursor:pointer}
  .footer{position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid rgba(255,255,255,.1);padding:10px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;z-index:30}
  /* Kamera */
  #camBox{display:none;gap:10px;align-items:center}
  video{width:100%;max-height:42vh;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#000}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  /* Dialog */
  dialog{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:0;background:var(--card);color:var(--ink);width:min(760px,96vw)}
  dialog::backdrop{background:rgba(0,0,0,.45);backdrop-filter:blur(2px)}
  .dlg-head{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center}
  .dlg-body{padding:12px 16px;max-height:62vh;overflow:auto}
  .issue-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .issue-btn{padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(61,177,255,.08);font-weight:700;cursor:pointer}
  .list{list-style:none;margin:0;padding:0}
  .list li{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px 8px;border-bottom:1px dashed rgba(255,255,255,.08);font-size:14px}
  .small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>Regjistër Biçikletash (Barkod + Probleme)</h1>
  <div class="sub">Hap kamerën për të skanuar barkodin, ose shkruaje me dorë. Pastaj zgjidh problemin → regjistrohet me datë & orë.</div>
  <div class="bar">
    <button class="btn" id="openCam">Hap kamerën</button>
    <button class="btn ghost" id="closeCam" style="display:none">Mbyll kamerën</button>
    <input id="manualCode" type="text" placeholder="Shkruaj barkodin me dorë">
    <button class="btn alt" id="addManual">Shto me dorë</button>
    <button class="btn ghost" id="resetAll">Rivendos gjithçka</button>
  </div>
  <div id="camBox" class="panel">
    <div class="row">
      <b>Kamera:</b> <span id="camHint" class="muted">Duke u hapur…</span>
    </div>
    <video id="video" playsinline muted></video>
  </div>
</header>

<main class="wrap">
  <!-- Përmbledhje -->
  <section class="panel">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <div class="title">Përmbledhje</div>
        <div class="muted">Numërimet rifreskohen automatikisht</div>
      </div>
      <div class="row">
        <button class="btn ghost" id="expSummary">Shkarko CSV (Përmbledhje)</button>
        <button class="btn" id="expDetails">Shkarko CSV (Detaje)</button>
        <button class="btn alt" id="expDoc">Shkarko Word (DOC)</button>
      </div>
    </div>
    <div class="grid" id="summaryGrid" style="margin-top:10px"></div>
  </section>

  <!-- Lista sipas barkodit -->
  <section class="panel">
    <div class="title">Barkodet & problemet</div>
    <div class="muted">Prek “Fshi” për të hequr një hyrje.</div>
    <ul class="list" id="byCodeList"></ul>
  </section>
</main>

<!-- Dialog për zgjedhje problemi -->
<dialog id="issueDlg">
  <div class="dlg-head">
    <div>
      <div style="font-weight:800">Zgjidh problemin</div>
      <div id="dlgCode" class="small"></div>
    </div>
    <button class="btn ghost" id="closeDlg">Mbyll</button>
  </div>
  <div class="dlg-body">
    <div class="issue-grid" id="issueGrid"></div>
  </div>
</dialog>

<div class="footer">
  <span class="muted">Të dhënat ruhen në këtë pajisje (localStorage).</span>
</div>

<script>
(function(){
  // ====== KONFIGURIMI I PROBLEMEVE (SQ) ======
  const ISSUES = [
    { id:'nuk-karikon',        name:'Nuk karikon' },
    { id:'kyci-baterise',      name:'Kyçi i baterisë nuk hapet' },
    { id:'ekrani-nuk-ndizet',  name:'Ekrani nuk ndizet' },
    { id:'bateria-zero',       name:'Bateria mbetet në 0%' },
    { id:'shofer-problem',     name:'Shoferi / kontrollori problematik' },
    { id:'timeout',            name:'Timeout' },
    { id:'mungon-priza',       name:'Mungon priza e karikimit' },
    { id:'rrota-ne-frene',     name:'Rrota bllokohet në frenë' },
    { id:'probleme-mekanike',  name:'Probleme mekanike' },
    { id:'s’merre-komande',    name:'Nuk merr komandë' },
  ];
  const ISSUE_BY_ID = Object.fromEntries(ISSUES.map(i=>[i.id,i]));

  // ====== MAGAZINIMI ======
  const LS_KEY = 'bike-reg-v2';
  // state: { entries: [ {code, issueId, ts} ] }
  let state = loadState();

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(raw) return JSON.parse(raw);
    }catch(_){}
    return { entries: [] };
  }
  function saveState(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    renderAll();
  }

  function nowStr(){
    try{
      return new Date().toLocaleString('sq-AL', {
        timeZone:'Europe/Tirane',
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      });
    }catch(_){ return new Date().toLocaleString(); }
  }

  // ====== UI ELEMENTE ======
  const openCamBtn = document.getElementById('openCam');
  const closeCamBtn = document.getElementById('closeCam');
  const camBox = document.getElementById('camBox');
  const camHint = document.getElementById('camHint');
  const video = document.getElementById('video');

  const manualCode = document.getElementById('manualCode');
  const addManual = document.getElementById('addManual');
  const resetAll = document.getElementById('resetAll');

  const summaryGrid = document.getElementById('summaryGrid');
  const byCodeList = document.getElementById('byCodeList');

  const issueDlg = document.getElementById('issueDlg');
  const issueGrid = document.getElementById('issueGrid');
  const dlgCode = document.getElementById('dlgCode');
  const closeDlg = document.getElementById('closeDlg');

  const expSummary = document.getElementById('expSummary');
  const expDetails = document.getElementById('expDetails');
  const expDoc = document.getElementById('expDoc');

  // Build issue buttons
  ISSUES.forEach(i=>{
    const b = document.createElement('button');
    b.className = 'issue-btn';
    b.textContent = i.name;
    b.addEventListener('click', ()=> chooseIssue(i.id));
    issueGrid.appendChild(b);
  });

  let pendingCode = null; // barkodi që pret zgjedhje problemi
  function openIssueChooser(code){
    pendingCode = code;
    dlgCode.textContent = 'Barkod: ' + code;
    issueDlg.showModal();
  }
  closeDlg.addEventListener('click', ()=> issueDlg.close());
  function chooseIssue(issueId){
    if(!pendingCode) return;
    // Nëse i njëjti barkod + problem ekziston, konfirmo
    const exists = state.entries.some(e=> e.code===pendingCode && e.issueId===issueId);
    if(exists){
      if(!confirm('Ky barkod është regjistruar tashmë me këtë problem. Shto përsëri?')) return;
    }
    state.entries.push({ code: pendingCode, issueId, ts: nowStr() });
    saveState();
    issueDlg.close();
    vibrate(20);
  }

  // ====== RENDER ======
  function renderAll(){
    renderSummary();
    renderByCode();
  }

  function renderSummary(){
    // Llogarit përmbledhjen
    const byIssue = new Map(ISSUES.map(i=>[i.id,0]));
    const uniqueCodes = new Set();
    state.entries.forEach(e=>{
      uniqueCodes.add(e.code);
      byIssue.set(e.issueId, (byIssue.get(e.issueId)||0)+1);
    });

    summaryGrid.innerHTML = '';
    // total & unique
    const total = state.entries.length;
    const box1 = makeStatCard('Gjithsej regjistrime', String(total));
    const box2 = makeStatCard('Barkode unike', String(uniqueCodes.size));
    summaryGrid.appendChild(box1); summaryGrid.appendChild(box2);
    // për çdo problem
    ISSUES.forEach(i=>{
      const c = byIssue.get(i.id)||0;
      const el = makeStatCard(i.name, String(c));
      summaryGrid.appendChild(el);
    });
  }
  function makeStatCard(title, value){
    const d = document.createElement('div');
    d.className = 'card';
    const cnt = document.createElement('div'); cnt.className='count'; cnt.textContent=value;
    const text = document.createElement('div');
    const t1 = document.createElement('div'); t1.className='title'; t1.textContent=title;
    const t2 = document.createElement('div'); t2.className='muted'; t2.textContent='—';
    text.appendChild(t1); text.appendChild(t2);
    d.appendChild(cnt); d.appendChild(text);
    return d;
  }

  function renderByCode(){
    // Grupim sipas barkodit
    const map = new Map();
    state.entries.forEach(e=>{
      if(!map.has(e.code)) map.set(e.code, []);
      map.get(e.code).push(e);
    });
    // Rendit sipas kohës së fundit (zbritës)
    const rows = Array.from(map.entries()).sort((a,b)=>{
      const ats = a[1][a[1].length-1]?.ts || '';
      const bts = b[1][b[1].length-1]?.ts || '';
      return ats < bts ? 1 : -1;
    });

    byCodeList.innerHTML = '';
    if(rows.length===0){
      const li = document.createElement('li');
      li.innerHTML = '<span class="small">S’ka të dhëna ende. Skano ose shto me dorë.</span>';
      byCodeList.appendChild(li);
      return;
    }

    rows.forEach(([code, arr])=>{
      const li = document.createElement('li');
      const left = document.createElement('div');
      const right = document.createElement('div');

      const head = document.createElement('div');
      head.innerHTML = '<b>'+code+'</b> · <span class="small">'+arr.length+' regj.</span>';
      left.appendChild(head);

      // badges për probleme
      const probs = document.createElement('div');
      arr.forEach((e, idx)=>{
        const sp = document.createElement('span');
        sp.className = 'badge';
        sp.textContent = ISSUE_BY_ID[e.issueId]?.name || e.issueId;
        sp.title = e.ts;
        probs.appendChild(sp);

        // buton fshi për çdo hyrje
        const del = document.createElement('button');
        del.className='x'; del.textContent='Fshi';
        del.style.marginLeft = '6px';
        del.addEventListener('click', ()=>{
          const i = state.entries.findIndex(x=> x.code===e.code && x.issueId===e.issueId && x.ts===e.ts);
          if(i>=0){
            state.entries.splice(i,1);
            saveState();
          }
        });
        probs.appendChild(del);
        if(idx<arr.length-1){
          const sep = document.createElement('span');
          sep.className='small'; sep.style.margin='0 4px'; sep.textContent='·';
          probs.appendChild(sep);
        }
      });
      left.appendChild(probs);

      // buton “shto problem tjetër” për këtë barkod
      const addBtn = document.createElement('button');
      addBtn.className='btn ghost'; addBtn.textContent='Shto problem';
      addBtn.addEventListener('click', ()=> openIssueChooser(code));
      right.appendChild(addBtn);

      li.appendChild(left); li.appendChild(right);
      byCodeList.appendChild(li);
    });
  }

  // ====== MANUAL ======
  addManual.addEventListener('click', ()=>{
    const code = sanitizeCode(manualCode.value);
    if(!code){ alert('Shkruaj një barkod.'); return; }
    manualCode.value = '';
    openIssueChooser(code);
  });

  // ====== RESET ======
  resetAll.addEventListener('click', ()=>{
    if(!confirm('Je i sigurt? Kjo do t’i fshijë të gjitha regjistrimet.')) return;
    state = { entries: [] };
    saveState();
  });

  // ====== EKSPORTET ======
  function csvEscape(v){ if(v==null) return ''; v=String(v); return /[",\n,;]/.test(v) ? '"'+v.replace(/"/g,'""')+'"' : v; }
  function downloadText(text, name, mime){
    const blob = new Blob([text], {type:mime||'text/plain;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    setTimeout(()=> URL.revokeObjectURL(a.href), 1500);
  }
  expDetails.addEventListener('click', ()=>{
    const rows = [['Barkod','Kategori','Data & Ora']];
    state.entries.forEach(e=> rows.push([e.code, ISSUE_BY_ID[e.issueId]?.name||e.issueId, e.ts]));
    const csv = rows.map(r=> r.map(csvEscape).join(',')).join('\n');
    downloadText(csv, 'detaje_bicikleta.csv', 'text/csv;charset=utf-8;');
  });
  expSummary.addEventListener('click', ()=>{
    const byIssue = new Map(ISSUES.map(i=>[i.id,0]));
    state.entries.forEach(e=> byIssue.set(e.issueId,(byIssue.get(e.issueId)||0)+1));
    const rows = [['Kategori','Sasia']];
    ISSUES.forEach(i=> rows.push([i.name, byIssue.get(i.id)||0]));
    const csv = rows.map(r=> r.map(csvEscape).join(',')).join('\n');
    downloadText(csv, 'permbledhje_bicikleta.csv', 'text/csv;charset=utf-8;');
  });
  expDoc.addEventListener('click', ()=>{
    const stamp = nowStr();
    // grupim sipas barkodit
    const map = new Map();
    state.entries.forEach(e=>{
      if(!map.has(e.code)) map.set(e.code, []);
      map.get(e.code).push(e);
    });
    const byIssue = new Map(ISSUES.map(i=>[i.id,0]));
    state.entries.forEach(e=> byIssue.set(e.issueId,(byIssue.get(e.issueId)||0)+1));
    let html = `
      <html><head><meta charset="utf-8"></head><body>
      <h2>Raport Biçikletash (Barkod + Probleme)</h2>
      <p><b>Gjeneruar:</b> ${stamp}</p>
      <h3>Përmbledhje</h3>
      <table border="1" cellspacing="0" cellpadding="6">
        <tr><th>Kategori</th><th>Sasia</th></tr>
        ${ISSUES.map(i=> <tr><td>${i.name}</td><td>${byIssue.get(i.id)||0}</td></tr>).join('')}
      </table>
      <h3>Detaje sipas barkodit</h3>
      ${Array.from(map.entries()).map(([code, arr])=> `
        <h4>${code} (${arr.length})</h4>
        <table border="1" cellspacing="0" cellpadding="6">
          <tr><th>#</th><th>Kategoria</th><th>Data & Ora</th></tr>
          ${arr.map((e,i)=> <tr><td>${i+1}</td><td>${ISSUE_BY_ID[e.issueId]?.name||e.issueId}</td><td>${e.ts}</td></tr>).join('')}
        </table>
      `).join('')}
      </body></html>
    `;
    downloadText(html, 'raport_bicikleta.doc', 'application/msword;charset=utf-8;');
  });

  // ====== KAMERA & SKANIMI ======
  let stream = null;
  let detector = null;
  let rafId = 0;
  let lastSeen = ''; // për debouncing të të njëjtit barkod
  const coolSet = new Set(); // parandalon dublikim brenda 2 sekondave

  async function startCam(){
    camBox.style.display = 'block';
    camHint.textContent = 'Duke u hapur…';
    openCamBtn.style.display='none';
    closeCamBtn.style.display='inline-block';
    try{
      // BarcodeDetector nëse mbështetet
      if('BarcodeDetector' in window){
        const formats = ['qr_code','code_128','code_39','ean_13','ean_8','upc_a','upc_e','itf','codabar','data_matrix','pdf417','aztec'];
        detector = new window.BarcodeDetector({formats});
      }else{
        detector = null;
      }
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment',
          width: {ideal: 1280}, height:{ideal:720}
        },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
      camHint.textContent = detector ? 'Gati për skanim. Drejto barkodin te kamera.' : 'Pajisja nuk mbështet skanimin automatik. Përdor “Shto me dorë”.';
      if(detector) loopDetect();
    }catch(err){
      camHint.textContent = 'S’ u hap kamera: ' + (err && err.message ? err.message : err);
      openCamBtn.style.display='inline-block';
      closeCamBtn.style.display='none';
    }
  }
  function stopCam(){
    try{ if(rafId) cancelAnimationFrame(rafId); }catch(_){}
    rafId = 0;
    if(stream){
      stream.getTracks().forEach(t=> t.stop());
      stream = null;
    }
    video.srcObject = null;
    camBox.style.display = 'none';
    openCamBtn.style.display='inline-block';
    closeCamBtn.style.display='none';
  }

  async function loopDetect(){
    if(!detector || !video || video.readyState < 2){ rafId = requestAnimationFrame(loopDetect); return; }
    try{
      const codes = await detector.detect(video);
      if(codes && codes.length){
        const raw = codes[0].rawValue || '';
        const code = sanitizeCode(raw);
        if(code && !coolSet.has(code)){
          coolSet.add(code);
          setTimeout(()=> coolSet.delete(code), 2000);
          if(code !== lastSeen){
            lastSeen = code;
            vibrate(20);
            openIssueChooser(code);
          }
        }
      }
    }catch(_){}
    rafId = requestAnimationFrame(loopDetect);
  }

  function sanitizeCode(s){
    if(s==null) return '';
    s = String(s).trim();
    // heq presje/hapsira anësore; nuk e kufizojmë gjatësinë — ruajmë të plotë
    return s;
  }
  function vibrate(ms){ if(navigator.vibrate) try{ navigator.vibrate(ms); }catch(_){ } }

  openCamBtn.addEventListener('click', startCam);
  closeCamBtn.addEventListener('click', stopCam);

  // Montim fillestar
  renderAll();

})();
</script>
</body>
</html>